December 2024   RM0490 Rev 5   1/1027 1  RM0490 Reference manual  STM32C0 series advanced Arm ®   -based 32-bit MCUs  Introduction  This reference manual complements the datasheets of the STM32C0 series microcontrollers, providing information required for application and in particular for software development. It pertains to the superset of feature sets available on STM32C0 series microcontrollers. For feature set, ordering information, and mechanical and electrical characteristics of a particular STM32C0 series device, refer to its corresponding datasheet. For information on the Arm   ®   Cortex ®   -M0+ core, refer to the Cortex   ® -M0+ technical reference manual. The STM32C0 series microcontrollers include ST state-of-the-art patented technology.  Related documents  •   “Cortex ® -M0+   Technical Reference Manual” , available from:   http://infocenter.arm.com  •   PM0223 programming manual for Cortex ®   -M0+ core (a)  •   STM32C0 series datasheets   (a)  •   STM32C0 series errata sheets (a)  •   AN2606 application note on booting STM32 MCUs   (a) a.   Available on STMicroelectronics website   www.st.com www.st.com

Contents   RM0490  2/1027   RM0490 Rev 5  Contents 1   Documentation conventions   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 41  1.1   General information   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 41 1.2   List of abbreviations for registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 41 1.3   Register reset value . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 41 1.4   Glossary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 42 1.5   Availability of peripherals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 42  2   Memory and bus architecture   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 43  2.1   System architecture . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 43 2.2   Memory organization   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 45 2.2.1   Introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 45 2.2.2   Memory map and register boundary addresses   . . . . . . . . . . . . . . . . . . 46 2.3   Embedded SRAM . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 51 2.4   FDCAN RAM   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 52 2.5   Flash memory overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 52  3   Boot modes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 53  3.1   Boot configuration   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 53 3.1.1   Physical remap   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 54 3.1.2   Embedded boot loader   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 54 3.1.3   Forcing boot from main flash memory . . . . . . . . . . . . . . . . . . . . . . . . . . 54 3.1.4   Empty check   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 54  4   Embedded flash memory (FLASH)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . 56  4.1   FLASH Introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 56 4.2   FLASH main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 56 4.3   FLASH functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 56 4.3.1   Flash memory organization . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 56 4.3.2   FLASH read access latency   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 59 4.3.3   Flash memory acceleration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 59 4.3.4   FLASH program and erase operations   . . . . . . . . . . . . . . . . . . . . . . . . . 60 4.3.5   FLASH main memory erase sequences   . . . . . . . . . . . . . . . . . . . . . . . . 61  4.3.6   FLASH main memory programming sequences   . . . . . . . . . . . . . . . . . . 62

RM0490 Rev 5   3/1027  RM0490   Contents  29  4.4   FLASH option bytes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 66 4.4.1   FLASH option byte description   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 66 4.4.2   FLASH option byte programming   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 67 4.5   Flash memory protection   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 69 4.5.1   FLASH read protection (RDP) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 69 4.5.2   FLASH proprietary code readout protection (PCROP)   . . . . . . . . . . . . . 72 4.5.3   FLASH write protection (WRP)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 73 4.5.4   Securable memory area   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 74 4.5.5   Disabling core debug access . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 75 4.5.6   Forcing boot from main flash memory . . . . . . . . . . . . . . . . . . . . . . . . . . 75 4.6   FLASH interrupts   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 76 4.7   FLASH registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 77 4.7.1   FLASH access control register (FLASH_ACR)   . . . . . . . . . . . . . . . . . . . 77 4.7.2   FLASH key register (FLASH_KEYR) . . . . . . . . . . . . . . . . . . . . . . . . . . . 78 4.7.3   FLASH option key register (FLASH_OPTKEYR) . . . . . . . . . . . . . . . . . . 78 4.7.4   FLASH status register (FLASH_SR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . 79 4.7.5   FLASH control register (FLASH_CR)   . . . . . . . . . . . . . . . . . . . . . . . . . . 81 4.7.6   FLASH option register (FLASH_OPTR)   . . . . . . . . . . . . . . . . . . . . . . . . 83 4.7.7   FLASH PCROP area A start address register  (FLASH_PCROP1ASR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 85 4.7.8   FLASH PCROP area A end address register  (FLASH_PCROP1AER) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 86 4.7.9   FLASH WRP area A address register (FLASH_WRP1AR) . . . . . . . . . . 86 4.7.10   FLASH WRP area B address register (FLASH_WRP1BR) . . . . . . . . . . 87 4.7.11   FLASH PCROP area B start address register  (FLASH_PCROP1BSR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 88 4.7.12   FLASH PCROP area B end address register  (FLASH_PCROP1BER) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 88 4.7.13   FLASH security register (FLASH_SECR)   . . . . . . . . . . . . . . . . . . . . . . . 89 4.7.14   FLASH register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 90  5   Power control (PWR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 92  5.1   Power supplies and voltage references . . . . . . . . . . . . . . . . . . . . . . . . . . 92 5.1.1   ADC reference voltage   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 92 5.1.2   Voltage regulator . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 93 5.2   Power supply supervisor   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 93 5.2.1   Power-on reset (POR) / power-down reset (PDR) / brown-out reset  (BOR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 93

Contents   RM0490  4/1027   RM0490 Rev 5  5.3   Operating modes   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 95 5.3.1   Power saving in run mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 97 5.3.2   Low-power modes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 98 5.4   PWR registers   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 102 5.4.1   PWR control register 1 (PWR_CR1)   . . . . . . . . . . . . . . . . . . . . . . . . . . 102 5.4.2   PWR control register 1 (PWR_CR2)   . . . . . . . . . . . . . . . . . . . . . . . . . . 103 5.4.3   PWR control register 3 (PWR_CR3)   . . . . . . . . . . . . . . . . . . . . . . . . . . 104 5.4.4   PWR control register 4 (PWR_CR4)   . . . . . . . . . . . . . . . . . . . . . . . . . . 105 5.4.5   PWR status register 1 (PWR_SR1) . . . . . . . . . . . . . . . . . . . . . . . . . . . 106 5.4.6   PWR status register 2 (PWR_SR2) . . . . . . . . . . . . . . . . . . . . . . . . . . . 107 5.4.7   PWR status clear register (PWR_SCR) . . . . . . . . . . . . . . . . . . . . . . . . 108 5.4.8   PWR Port A pull-up control register (PWR_PUCRA) . . . . . . . . . . . . . . 109 5.4.9   PWR Port A pull-down control register (PWR_PDCRA)   . . . . . . . . . . . 109 5.4.10   PWR Port B pull-up control register (PWR_PUCRB)   . . . . . . . . . . . . . 110 5.4.11   PWR Port B pull-down control register (PWR_PDCRB)   . . . . . . . . . . . 110 5.4.12   PWR Port C pull-up control register (PWR_PUCRC)   . . . . . . . . . . . . . 111 5.4.13   PWR Port C pull-down control register (PWR_PDCRC) . . . . . . . . . . . 111 5.4.14   PWR Port D pull-up control register (PWR_PUCRD)   . . . . . . . . . . . . . 112 5.4.15   PWR Port D pull-down control register (PWR_PDCRD) . . . . . . . . . . . 113 5.4.16   PWR Port F pull-up control register (PWR_PUCRF) . . . . . . . . . . . . . . 114 5.4.17   PWR Port F pull-down control register (PWR_PDCRF)   . . . . . . . . . . . 114 5.4.18   PWR backup x register (PWR_BKPxR) . . . . . . . . . . . . . . . . . . . . . . . . 115 5.4.19   PWR register map . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 115  6   Reset and clock control (RCC) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 118  6.1   Reset   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .118 6.1.1   Power reset . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 118 6.1.2   System reset   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 118 6.1.3   RTC domain reset   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 120 6.2   Clocks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 121 6.2.1   HSE clock   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 123 6.2.2   HSI48 clock . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 125 6.2.3   HSIUSB48 clock   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 125 6.2.4   LSE clock . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 126 6.2.5   LSI clock   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 126 6.2.6   System clock (SYSCLK) selection . . . . . . . . . . . . . . . . . . . . . . . . . . . . 127 6.2.7   Clock security system (CSS) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 127

RM0490 Rev 5   5/1027  RM0490   Contents  29  6.2.8   Clock security system for LSE clock (LSECSS)   . . . . . . . . . . . . . . . . . 127 6.2.9   ADC clock   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 128 6.2.10   RTC clock   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 128 6.2.11   Timer clock . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 128 6.2.12   Watchdog clock . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 129 6.2.13   Clock-out capability   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 129 6.2.14   Internal/external clock measurement with TIM14/TIM16/TIM17   . . . . . 129 6.2.15   Peripheral clock enable registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 132 6.3   Low-power modes   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 132 6.4   RCC registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 133 6.4.1   RCC clock control register (RCC_CR) . . . . . . . . . . . . . . . . . . . . . . . . . 133 6.4.2   RCC internal clock source calibration register (RCC_ICSCR)   . . . . . . 135 6.4.3   RCC clock configuration register (RCC_CFGR)   . . . . . . . . . . . . . . . . . 136 6.4.4   RCC clock recovery RC register (RCC_CRRCR)   . . . . . . . . . . . . . . . . 139 6.4.5   RCC clock interrupt enable register (RCC_CIER) . . . . . . . . . . . . . . . . 139 6.4.6   RCC clock interrupt flag register (RCC_CIFR)   . . . . . . . . . . . . . . . . . . 140 6.4.7   RCC clock interrupt clear register (RCC_CICR)   . . . . . . . . . . . . . . . . . 142 6.4.8   RCC I/O port reset register (RCC_IOPRSTR) . . . . . . . . . . . . . . . . . . . 143 6.4.9   RCC AHB peripheral reset register (RCC_AHBRSTR) . . . . . . . . . . . . 144 6.4.10   RCC APB peripheral reset register 1 (RCC_APBRSTR1) . . . . . . . . . . 144 6.4.11   RCC APB peripheral reset register 2 (RCC_APBRSTR2) . . . . . . . . . . 146 6.4.12   RCC I/O port clock enable register (RCC_IOPENR) . . . . . . . . . . . . . . 147 6.4.13   RCC AHB peripheral clock enable register (RCC_AHBENR)   . . . . . . . 148 6.4.14   RCC APB peripheral clock enable register 1 (RCC_APBENR1) . . . . . 149 6.4.15   RCC APB peripheral clock enable register 2(RCC_APBENR2)   . . . . . 151 6.4.16   RCC I/O port in Sleep mode clock enable register  (RCC_IOPSMENR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 153 6.4.17   RCC AHB peripheral clock enable in Sleep/Stop mode register  (RCC_AHBSMENR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 154 6.4.18   RCC APB peripheral clock enable in Sleep/Stop mode register 1  (RCC_APBSMENR1)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 154 6.4.19   RCC APB peripheral clock enable in Sleep/Stop mode register 2  (RCC_APBSMENR2)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 157 6.4.20   RCC peripherals independent clock configuration register 1  (RCC_CCIPR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 158 6.4.21   RCC peripherals independent clock configuration register 2  (RCC_CCIPR2)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 159 6.4.22   RCC control/status register 1 (RCC_CSR1)   . . . . . . . . . . . . . . . . . . . . 159 6.4.23   RCC control/status register 2 (RCC_CSR2)   . . . . . . . . . . . . . . . . . . . . 161

Contents   RM0490  6/1027   RM0490 Rev 5  6.4.24   RCC register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 163  7   Clock recovery system (CRS)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 166  7.1   CRS introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 166 7.2   CRS main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 166 7.3   CRS implementation   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 166 7.4   CRS functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 167 7.4.1   CRS block diagram   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 167 7.4.2   CRS internal signals   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 167 7.4.3   Synchronization input   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 168 7.4.4   Frequency error measurement   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 168 7.4.5   Frequency error evaluation and automatic trimming . . . . . . . . . . . . . . 169 7.4.6   CRS initialization and configuration . . . . . . . . . . . . . . . . . . . . . . . . . . . 170 7.5   CRS in low-power modes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 171 7.6   CRS interrupts   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 171 7.7   CRS registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 171 7.7.1   CRS control register (CRS_CR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 171 7.7.2   CRS configuration register (CRS_CFGR) . . . . . . . . . . . . . . . . . . . . . . 172 7.7.3   CRS interrupt and status register (CRS_ISR) . . . . . . . . . . . . . . . . . . . 173 7.7.4   CRS interrupt flag clear register (CRS_ICR) . . . . . . . . . . . . . . . . . . . . 175 7.7.5   CRS register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 176  8   General-purpose I/Os (GPIO) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 177  8.1   Introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 177 8.2   GPIO main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 177 8.3   GPIO functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 177 8.3.1   General-purpose I/O (GPIO) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 179 8.3.2   I/O pin alternate function multiplexer and mapping . . . . . . . . . . . . . . . 180 8.3.3   I/O port control registers   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 181 8.3.4   I/O port data registers   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 181 8.3.5   I/O data bitwise handling . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 181 8.3.6   GPIO locking mechanism   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 181 8.3.7   I/O alternate function input/output . . . . . . . . . . . . . . . . . . . . . . . . . . . . 182 8.3.8   External interrupt/wake-up lines   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 182 8.3.9   Input configuration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 182 8.3.10   Output configuration   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 183

RM0490 Rev 5   7/1027  RM0490   Contents  29  8.3.11   Alternate function configuration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 184 8.3.12   Analog configuration   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 185 8.3.13   Using the HSE or LSE oscillator pins as GPIOs   . . . . . . . . . . . . . . . . . 186 8.3.14   Low pin count package adjustment . . . . . . . . . . . . . . . . . . . . . . . . . . . 186 8.3.15   Reset pin (PF2-NRST) in GPIO mode . . . . . . . . . . . . . . . . . . . . . . . . . 186 8.4   GPIO in low-power modes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 186 8.5   GPIO registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 187 8.5.1   GPIO port mode register (GPIOx_MODER)  (x =A, B, C, D, F) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 187 8.5.2   GPIO port output type register (GPIOx_OTYPER)  (x = A, B, C, D, F) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 188 8.5.3   GPIO port output speed register (GPIOx_OSPEEDR)  (x = A, B, C, D, F) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 188 8.5.4   GPIO port pull-up/pull-down register (GPIOx_PUPDR)  (x = A, B, C, D, F) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 188 8.5.5   GPIO port input data register (GPIOx_IDR)  (x = A, B, C, D, F) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 189 8.5.6   GPIO port output data register (GPIOx_ODR)  (x = A, B, C, D, F) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 189 8.5.7   GPIO port bit set/reset register (GPIOx_BSRR)  (x = A, B, C, D, F) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 190 8.5.8   GPIO port configuration lock register (GPIOx_LCKR)  (x = A, B, C, D, F) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 190 8.5.9   GPIO alternate function low register (GPIOx_AFRL)  (x = A, B, C, D, F) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 191 8.5.10   GPIO alternate function high register (GPIOx_AFRH)  (x = A, B, C, D, F) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 192 8.5.11   GPIO port bit reset register (GPIOx_BRR) (x = A, B, C, D, F) . . . . . . . 193 8.5.12   GPIO register map . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 194  9   System configuration controller (SYSCFG)   . . . . . . . . . . . . . . . . . . . . 195  9.1   SYSCFG registers   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 195 9.1.1   SYSCFG configuration register 1 (SYSCFG_CFGR1)   . . . . . . . . . . . . 195 9.1.2   SYSCFG configuration register 2 (SYSCFG_CFGR2)   . . . . . . . . . . . . 197 9.1.3   SYSCFG configuration register 3 (SYSCFG_CFGR3)   . . . . . . . . . . . . 198 9.1.4   SYSCFG interrupt line 0 status register (SYSCFG_ITLINE0) . . . . . . . 201 9.1.5   SYSCFG interrupt line 1 status register (SYSCFG_ITLINE1) . . . . . . . 202 9.1.6   SYSCFG interrupt line 2 status register (SYSCFG_ITLINE2) . . . . . . . 202 9.1.7   SYSCFG interrupt line 3 status register (SYSCFG_ITLINE3) . . . . . . . 203 9.1.8   SYSCFG interrupt line 4 status register (SYSCFG_ITLINE4) . . . . . . . 203

Contents   RM0490  8/1027   RM0490 Rev 5  9.1.9   SYSCFG interrupt line 5 status register (SYSCFG_ITLINE5) . . . . . . . 204 9.1.10   SYSCFG interrupt line 6 status register (SYSCFG_ITLINE6) . . . . . . . 204 9.1.11   SYSCFG interrupt line 7 status register (SYSCFG_ITLINE7) . . . . . . . 204 9.1.12   SYSCFG interrupt line 8 status register (SYSCFG_ITLINE8) . . . . . . . 205 9.1.13   SYSCFG interrupt line 9 status register (SYSCFG_ITLINE9) . . . . . . . 205 9.1.14   SYSCFG interrupt line 10 status register (SYSCFG_ITLINE10) . . . . . 206 9.1.15   SYSCFG interrupt line 11 status register (SYSCFG_ITLINE11)   . . . . . 206 9.1.16   SYSCFG interrupt line 12 status register (SYSCFG_ITLINE12) . . . . . 207 9.1.17   SYSCFG interrupt line 13 status register (SYSCFG_ITLINE13) . . . . . 207 9.1.18   SYSCFG interrupt line 14 status register (SYSCFG_ITLINE14) . . . . . 207 9.1.19   SYSCFG interrupt line 15 status register (SYSCFG_ITLINE15) . . . . . 208 9.1.20   SYSCFG interrupt line 16 status register (SYSCFG_ITLINE16) . . . . . 208 9.1.21   SYSCFG interrupt line 19 status register (SYSCFG_ITLINE19) . . . . . 208 9.1.22   SYSCFG interrupt line 20 status register (SYSCFG_ITLINE20) . . . . . 209 9.1.23   SYSCFG interrupt line 21 status register (SYSCFG_ITLINE21) . . . . . 209 9.1.24   SYSCFG interrupt line 22 status register (SYSCFG_ITLINE22) . . . . . 209 9.1.25   SYSCFG interrupt line 23 status register (SYSCFG_ITLINE23) . . . . . 210 9.1.26   SYSCFG interrupt line 24 status register (SYSCFG_ITLINE24) . . . . . 210 9.1.27   SYSCFG interrupt line 25 status register (SYSCFG_ITLINE25) . . . . . 210 9.1.28   SYSCFG interrupt line 26 status register (SYSCFG_ITLINE26) . . . . . 211 9.1.29   SYSCFG interrupt line 27 status register (SYSCFG_ITLINE27) . . . . . 211 9.1.30   SYSCFG interrupt line 28 status register (SYSCFG_ITLINE28) . . . . . 211 9.1.31   SYSCFG interrupt line 29 status register (SYSCFG_ITLINE29) . . . . . 212 9.1.32   SYSCFG interrupt line 30 status register (SYSCFG_ITLINE30) . . . . . 212 9.1.33   SYSCFG interrupt line 31 status register (SYSCFG_ITLINE31) . . . . . 213 9.1.34   SYSCFG register map . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 213  10   Interconnect matrix . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 217  10.1   Introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 217 10.2   Connection summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 217 10.3   Interconnection details . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 218 10.3.1   From TIM1, TIM2, TIM3, TIM14, TIM15, and TIM17, to TIM1, TIM2,  and TIM3   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 218 10.3.2   From TIM1, TIM2, TIM3, TIM15, and EXTI, to ADC . . . . . . . . . . . . . . . 219 10.3.3   From ADC to TIM1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 219 10.3.4   From HSE, LSE, LSI, MCO, MCO2, and RTC, to TIM14,  TIM16, and TIM17 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 219

RM0490 Rev 5   9/1027  RM0490   Contents  29  10.3.5   From internal analog sources to ADC   . . . . . . . . . . . . . . . . . . . . . . . . . 220 10.3.6   From system errors to TIM1, TIM15, TIM16, and TIM17 . . . . . . . . . . . 220 10.3.7   From TIM16, TIM17, USART1, and USART2, to IRTIM   . . . . . . . . . . . 220 10.3.8   From TIM14 and EXTI to DMAMUX   . . . . . . . . . . . . . . . . . . . . . . . . . . 221  11   Direct memory access controller (DMA) . . . . . . . . . . . . . . . . . . . . . . . 222  11.1   Introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 222 11.2   DMA main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 222 11.3   DMA implementation   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 223 11.3.1   DMA1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 223 11.3.2   DMA request mapping . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 223 11.4   DMA functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 223 11.4.1   DMA block diagram   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 223 11.4.2   DMA pins and internal signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 224 11.4.3   DMA transfers   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 224 11.4.4   DMA arbitration   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 225 11.4.5   DMA channels . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 225 11.4.6   DMA data width, alignment, and endianness . . . . . . . . . . . . . . . . . . . . 229 11.4.7   DMA error management   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 230 11.5   DMA interrupts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 231 11.6   DMA registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 231 11.6.1   DMA interrupt status register (DMA_ISR)   . . . . . . . . . . . . . . . . . . . . . . 231 11.6.2   DMA interrupt flag clear register (DMA_IFCR)   . . . . . . . . . . . . . . . . . . 233 11.6.3   DMA channel x configuration register (DMA_CCRx) . . . . . . . . . . . . . . 235 11.6.4   DMA channel x number of data to transfer register (DMA_CNDTRx) . 237 11.6.5   DMA channel x peripheral address register (DMA_CPARx)   . . . . . . . . 238 11.6.6   DMA channel x memory address register (DMA_CMARx)   . . . . . . . . . 239 11.6.7   DMA register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 239  12   DMA request multiplexer (DMAMUX) . . . . . . . . . . . . . . . . . . . . . . . . . 242  12.1   Introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 242 12.2   DMAMUX main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 243 12.3   DMAMUX implementation   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 243 12.3.1   DMAMUX instantiation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 243 12.3.2   DMAMUX mapping   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 243 12.4   DMAMUX functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 246

Contents   RM0490  10/1027   RM0490 Rev 5  12.4.1   DMAMUX block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 246 12.4.2   DMAMUX signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 247 12.4.3   DMAMUX channels . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 247 12.4.4   DMAMUX request line multiplexer . . . . . . . . . . . . . . . . . . . . . . . . . . . . 247 12.4.5   DMAMUX request generator . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 250 12.5   DMAMUX interrupts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 251 12.6   DMAMUX registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 252 12.6.1   DMAMUX request line multiplexer channel x configuration register  (DMAMUX_CxCR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 252 12.6.2   DMAMUX request line multiplexer interrupt channel status register  (DMAMUX_CSR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 253 12.6.3   DMAMUX request line multiplexer interrupt clear flag register  (DMAMUX_CFR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 253 12.6.4   DMAMUX request generator channel x configuration register  (DMAMUX_RGxCR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 254 12.6.5   DMAMUX request generator interrupt status register  (DMAMUX_RGSR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 255 12.6.6   DMAMUX request generator interrupt clear flag register  (DMAMUX_RGCFR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 255 12.6.7   DMAMUX register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 256  13   Nested vectored interrupt controller (NVIC) . . . . . . . . . . . . . . . . . . . . 257  13.1   Main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 257 13.2   SysTick calibration value register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 257 13.3   Interrupt and exception vectors   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 257  14   Extended interrupt and event controller (EXTI) . . . . . . . . . . . . . . . . . 260  14.1   EXTI main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 260 14.2   EXTI block diagram   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 260 14.2.1   EXTI connections between peripherals and CPU . . . . . . . . . . . . . . . . 262 14.3   EXTI functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 262 14.3.1   EXTI configurable event input wake-up . . . . . . . . . . . . . . . . . . . . . . . . 263 14.3.2   EXTI direct event input wake-up   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 263 14.3.3   EXTI multiplexer   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 264 14.4   EXTI functional behavior   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 265 14.5   EXTI registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 266 14.5.1   EXTI rising trigger selection register 1 (EXTI_RTSR1)   . . . . . . . . . . . . 266 14.5.2   EXTI falling trigger selection register 1 (EXTI_FTSR1) . . . . . . . . . . . . 267

RM0490 Rev 5   11/1027  RM0490   Contents  29  14.5.3   EXTI software interrupt event register 1 (EXTI_SWIER1) . . . . . . . . . . 267 14.5.4   EXTI rising edge pending register 1 (EXTI_RPR1) . . . . . . . . . . . . . . . 268 14.5.5   EXTI falling edge pending register 1 (EXTI_FPR1) . . . . . . . . . . . . . . . 268 14.5.6   EXTI rising trigger selection register 2 (EXTI_RTSR2)   . . . . . . . . . . . . 269 14.5.7   EXTI falling trigger selection register 2 (EXTI_FTSR2) . . . . . . . . . . . . 269 14.5.8   EXTI software interrupt event register 2 (EXTI_SWIER2) . . . . . . . . . . 270 14.5.9   EXTI rising edge pending register 2 (EXTI_RPR2) . . . . . . . . . . . . . . . 270 14.5.10   EXTI falling edge pending register 2 (EXTI_FPR2) . . . . . . . . . . . . . . . 271 14.5.11   EXTI external interrupt selection register (EXTI_EXTICRx)   . . . . . . . . 271 14.5.12   EXTI CPU wake-up with interrupt mask register 1 (EXTI_IMR1)   . . . . 273 14.5.13   EXTI CPU wake-up with event mask register (EXTI_EMR1)   . . . . . . . 274 14.5.14   EXTI CPU wake-up with interrupt mask register 2 (EXTI_IMR2)   . . . . 274 14.5.15   EXTI CPU wake-up with event mask register 2 (EXTI_EMR2) . . . . . . 275 14.5.16   EXTI register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 276  15   Cyclic redundancy check calculation unit (CRC) . . . . . . . . . . . . . . . . 278  15.1   Introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 278 15.2   CRC main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 278 15.3   CRC functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 279 15.3.1   CRC block diagram   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 279 15.3.2   CRC internal signals   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 279 15.3.3   CRC operation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 279 15.4   CRC registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 281 15.4.1   CRC data register (CRC_DR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 281 15.4.2   CRC independent data register (CRC_IDR)   . . . . . . . . . . . . . . . . . . . . 281 15.4.3   CRC control register (CRC_CR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 282 15.4.4   CRC initial value (CRC_INIT)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 283 15.4.5   CRC polynomial (CRC_POL)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 283 15.4.6   CRC register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 284  16   Analog-to-digital converter (ADC) . . . . . . . . . . . . . . . . . . . . . . . . . . . . 285  16.1   Introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 285 16.2   ADC main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 286 16.3   ADC implementation   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 287 16.4   ADC functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 288 16.4.1   ADC pins and internal signals   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 289

Contents   RM0490  12/1027   RM0490 Rev 5  16.4.2   ADC voltage regulator (ADVREGEN)   . . . . . . . . . . . . . . . . . . . . . . . . . 290 16.4.3   Calibration (ADCAL)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 290 16.4.4   ADC on-off control (ADEN, ADDIS, ADRDY) . . . . . . . . . . . . . . . . . . . . 292 16.4.5   ADC clock (CKMODE, PRESC[3:0]) . . . . . . . . . . . . . . . . . . . . . . . . . . 294 16.4.6   ADC connectivity . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 296 16.4.7   Configuring the ADC   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 297 16.4.8   Channel selection (CHSEL, SCANDIR, CHSELRMOD) . . . . . . . . . . . 297 16.4.9   Programmable sampling time (SMPx[2:0])   . . . . . . . . . . . . . . . . . . . . . 298 16.4.10   Single conversion mode (CONT = 0) . . . . . . . . . . . . . . . . . . . . . . . . . . 299 16.4.11   Continuous conversion mode (CONT = 1) . . . . . . . . . . . . . . . . . . . . . . 299 16.4.12   Starting conversions (ADSTART)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . 300 16.4.13   Timings   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 301 16.4.14   Stopping an ongoing conversion (ADSTP)   . . . . . . . . . . . . . . . . . . . . . 302 16.5   Conversion on external trigger and trigger polarity (EXTSEL, EXTEN) . 302 16.5.1   Discontinuous mode (DISCEN) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 303 16.5.2   Programmable resolution (RES) - Fast conversion mode . . . . . . . . . . 303 16.5.3   End of conversion, end of sampling phase (EOC, EOSMP flags) . . . . 304 16.5.4   End of conversion sequence (EOS flag) . . . . . . . . . . . . . . . . . . . . . . . 304 16.5.5   Example timing diagrams (single/continuous modes  hardware/software triggers) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 305 16.5.6   Low frequency trigger mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 307 16.6   Data management   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 307 16.6.1   Data register and data alignment (ADC_DR, ALIGN)   . . . . . . . . . . . . . 307 16.6.2   ADC overrun (OVR, OVRMOD) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 307 16.6.3   Managing a sequence of data converted without using the DMA . . . . 309 16.6.4   Managing converted data without using the DMA without overrun   . . . 309 16.6.5   Managing converted data using the DMA . . . . . . . . . . . . . . . . . . . . . . 309 16.7   Low-power features   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 310 16.7.1   Wait mode conversion . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 310 16.7.2   Auto-off mode (AUTOFF) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 311 16.8   Analog window watchdogs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 313 16.8.1   Description of analog watchdog 1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . 313 16.8.2   Description of analog watchdog 2 and 3 . . . . . . . . . . . . . . . . . . . . . . . 314 16.8.3   ADC_AWDx_OUT output signal generation   . . . . . . . . . . . . . . . . . . . . 314 16.8.4   Analog watchdog threshold control . . . . . . . . . . . . . . . . . . . . . . . . . . . 316 16.9   Oversampler . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 317 16.9.1   ADC operating modes supported when oversampling   . . . . . . . . . . . . 318

RM0490 Rev 5   13/1027  RM0490   Contents  29  16.9.2   Analog watchdog . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 319 16.9.3   Triggered mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 319 16.10   Temperature sensor and internal reference voltage . . . . . . . . . . . . . . . . 319 16.11   ADC interrupts   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 322 16.12   ADC registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 324 16.12.1   ADC interrupt and status register (ADC_ISR) . . . . . . . . . . . . . . . . . . . 324 16.12.2   ADC interrupt enable register (ADC_IER) . . . . . . . . . . . . . . . . . . . . . . 325 16.12.3   ADC control register (ADC_CR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 327 16.12.4   ADC configuration register 1 (ADC_CFGR1)   . . . . . . . . . . . . . . . . . . . 329 16.12.5   ADC configuration register 2 (ADC_CFGR2)   . . . . . . . . . . . . . . . . . . . 332 16.12.6   ADC sampling time register (ADC_SMPR)   . . . . . . . . . . . . . . . . . . . . . 334 16.12.7   ADC watchdog threshold register (ADC_AWD1TR)   . . . . . . . . . . . . . . 335 16.12.8   ADC watchdog threshold register (ADC_AWD2TR)   . . . . . . . . . . . . . . 335 16.12.9   ADC channel selection register (ADC_CHSELR)   . . . . . . . . . . . . . . . . 335 16.12.10 ADC channel selection register [alternate] (ADC_CHSELR) . . . . . . . . 336 16.12.11 ADC watchdog threshold register (ADC_AWD3TR)   . . . . . . . . . . . . . . 338 16.12.12 ADC data register (ADC_DR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 339 16.12.13 ADC analog watchdog 2 configuration register (ADC_AWD2CR) . . . . 339 16.12.14 ADC Analog Watchdog 3 Configuration register (ADC_AWD3CR) . . . 340 16.12.15 ADC calibration factor (ADC_CALFACT) . . . . . . . . . . . . . . . . . . . . . . . 340 16.12.16 ADC common configuration register (ADC_CCR) . . . . . . . . . . . . . . . . 341 16.13   ADC register map . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 342  17   Advanced-control timer (TIM1)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 344  17.1   TIM1 introduction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 344 17.2   TIM1 main features   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 345 17.3   TIM1 functional description   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 347 17.3.1   Time-base unit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 347 17.3.2   Counter modes   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 349 17.3.3   Repetition counter . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 360 17.3.4   External trigger input . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 362 17.3.5   Clock selection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 363 17.3.6   Capture/compare channels . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 367 17.3.7   Input capture mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 369 17.3.8   PWM input mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 370 17.3.9   Forced output mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 371

Contents   RM0490  14/1027   RM0490 Rev 5  17.3.10   Output compare mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 372 17.3.11   PWM mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 373 17.3.12   Asymmetric PWM mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 376 17.3.13   Combined PWM mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 377 17.3.14   Combined 3-phase PWM mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 378 17.3.15   Complementary outputs and dead-time insertion   . . . . . . . . . . . . . . . . 379 17.3.16   Using the break function   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 381 17.3.17   Bidirectional break inputs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 387 17.3.18   Clearing the OCxREF signal on an external event   . . . . . . . . . . . . . . . 389 17.3.19   6-step PWM generation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 390 17.3.20   One-pulse mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 391 17.3.21   Retriggerable one pulse mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 392 17.3.22   Encoder interface mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 393 17.3.23   UIF bit remapping   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 395 17.3.24   Timer input XOR function . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 396 17.3.25   Interfacing with Hall sensors   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 396 17.3.26   Timer synchronization   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 399 17.3.27   ADC synchronization . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 403 17.3.28   DMA burst mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 403 17.3.29   Debug mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 404 17.4   TIM1 registers   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 405 17.4.1   TIM1 control register 1 (TIM1_CR1)   . . . . . . . . . . . . . . . . . . . . . . . . . . 405 17.4.2   TIM1 control register 2 (TIM1_CR2)   . . . . . . . . . . . . . . . . . . . . . . . . . . 406 17.4.3   TIM1 slave mode control register  (TIM1_SMCR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 409 17.4.4   TIM1 DMA/interrupt enable register  (TIM1_DIER) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 411 17.4.5   TIM1 status register (TIM1_SR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 413 17.4.6   TIM1 event generation register (TIM1_EGR)   . . . . . . . . . . . . . . . . . . . 415 17.4.7   TIM1 capture/compare mode register 1 (TIM1_CCMR1)   . . . . . . . . . . 416 17.4.8   TIM1 capture/compare mode register 1 [alternate]  (TIM1_CCMR1) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 417 17.4.9   TIM1 capture/compare mode register 2 (TIM1_CCMR2)   . . . . . . . . . . 420 17.4.10   TIM1 capture/compare mode register 2 [alternate]  (TIM1_CCMR2) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 421 17.4.11   TIM1 capture/compare enable register  (TIM1_CCER)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 423 17.4.12   TIM1 counter (TIM1_CNT) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 426

RM0490 Rev 5   15/1027  RM0490   Contents  29  17.4.13   TIM1 prescaler (TIM1_PSC)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 426 17.4.14   TIM1 auto-reload register (TIM1_ARR) . . . . . . . . . . . . . . . . . . . . . . . . 426 17.4.15   TIM1 repetition counter register (TIM1_RCR) . . . . . . . . . . . . . . . . . . . 427 17.4.16   TIM1 capture/compare register 1  (TIM1_CCR1)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 427 17.4.17   TIM1 capture/compare register 2  (TIM1_CCR2)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 428 17.4.18   TIM1 capture/compare register 3  (TIM1_CCR3)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 428 17.4.19   TIM1 capture/compare register 4  (TIM1_CCR4)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 429 17.4.20   TIM1 break and dead-time register  (TIM1_BDTR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 429 17.4.21   TIM1 DMA control register  (TIM1_DCR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 433 17.4.22   TIM1 DMA address for full transfer  (TIM1_DMAR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 434 17.4.23   TIM1 capture/compare mode register 3  (TIM1_CCMR3) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 435 17.4.24   TIM1 capture/compare register 5  (TIM1_CCR5)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 436 17.4.25   TIM1 capture/compare register 6  (TIM1_CCR6)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 437 17.4.26   TIM1 alternate function option register 1 (TIM1_AF1) . . . . . . . . . . . . . 437 17.4.27   TIM1 Alternate function register 2 (TIM1_AF2)   . . . . . . . . . . . . . . . . . . 438 17.4.28   TIM1 timer input selection register (TIM1_TISEL) . . . . . . . . . . . . . . . . 439 17.4.29   TIM1 register map . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 440  18   General-purpose timers (TIM2/TIM3) . . . . . . . . . . . . . . . . . . . . . . . . . . 443  18.1   TIM2/TIM3 introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 443 18.2   TIM2/TIM3 main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 443 18.3   TIM2/TIM3 functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 445 18.3.1   Time-base unit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 445 18.3.2   Counter modes   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 447 18.3.3   Clock selection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 457 18.3.4   Capture/Compare channels . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 461 18.3.5   Input capture mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 463 18.3.6   PWM input mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 464 18.3.7   Forced output mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 465 18.3.8   Output compare mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 465

Contents   RM0490  16/1027   RM0490 Rev 5  18.3.9   PWM mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 466 18.3.10   Asymmetric PWM mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 470 18.3.11   Combined PWM mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 470 18.3.12   Clearing the OCxREF signal on an external event   . . . . . . . . . . . . . . . 471 18.3.13   One-pulse mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 473 18.3.14   Retriggerable one pulse mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 474 18.3.15   Encoder interface mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 475 18.3.16   UIF bit remapping   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 477 18.3.17   Timer input XOR function . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 477 18.3.18   Timers and external trigger synchronization   . . . . . . . . . . . . . . . . . . . . 478 18.3.19   Timer synchronization   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 481 18.3.20   DMA burst mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 486 18.3.21   Debug mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 487 18.4   TIM2/TIM3 registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 488 18.4.1   TIMx control register 1 (TIMx_CR1)(x = 2 to 3) . . . . . . . . . . . . . . . . . . 488 18.4.2   TIMx control register 2 (TIMx_CR2)(x = 2 to 3) . . . . . . . . . . . . . . . . . . 489 18.4.3   TIMx slave mode control register (TIMx_SMCR)(x = 2 to 3) . . . . . . . . 491 18.4.4   TIMx DMA/Interrupt enable register (TIMx_DIER)(x = 2 to 3) . . . . . . . 494 18.4.5   TIMx status register (TIMx_SR)(x = 2 to 3) . . . . . . . . . . . . . . . . . . . . . 496 18.4.6   TIMx event generation register (TIMx_EGR)(x = 2 to 3) . . . . . . . . . . . 497 18.4.7   TIMx capture/compare mode register 1 (TIMx_CCMR1)(x = 2 to 3) . . 498 18.4.8   TIMx capture/compare mode register 1 [alternate] (TIMx_CCMR1)  (x = 2 to 3) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 500 18.4.9   TIMx capture/compare mode register 2 (TIMx_CCMR2)(x = 2 to 3) . . 502 18.4.10   TIMx capture/compare mode register 2 [alternate] (TIMx_CCMR2)  (x = 2 to 3) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 503 18.4.11   TIMx capture/compare enable register  (TIMx_CCER)(x = 2 to 3) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 504 18.4.12   TIMx counter (TIMx_CNT)(x = 2 to 3)   . . . . . . . . . . . . . . . . . . . . . . . . . 505 18.4.13   TIMx counter [alternate] (TIMx_CNT)(x = 2 to 3) . . . . . . . . . . . . . . . . . 506 18.4.14   TIMx prescaler (TIMx_PSC)(x = 2 to 3) . . . . . . . . . . . . . . . . . . . . . . . . 506 18.4.15   TIMx auto-reload register (TIMx_ARR)(x = 2 to 3)   . . . . . . . . . . . . . . . 507 18.4.16   TIMx capture/compare register 1 (TIMx_CCR1)(x = 2 to 3)   . . . . . . . . 507 18.4.17   TIMx capture/compare register 2 (TIMx_CCR2)(x = 2 to 3)   . . . . . . . . 508 18.4.18   TIMx capture/compare register 3 (TIMx_CCR3)(x = 2 to 3)   . . . . . . . . 508 18.4.19   TIMx capture/compare register 4 (TIMx_CCR4)(x = 2 to 3)   . . . . . . . . 509 18.4.20   TIMx DMA control register (TIMx_DCR)(x = 2 to 3) . . . . . . . . . . . . . . . 510 18.4.21   TIMx DMA address for full transfer (TIMx_DMAR)(x = 2 to 3) . . . . . . . 510

RM0490 Rev 5   17/1027  RM0490   Contents  29  18.4.22   TIM2 alternate function option register 1 (TIM2_AF1) . . . . . . . . . . . . . 511 18.4.23   TIM3 alternate function option register 1 (TIM3_AF1) . . . . . . . . . . . . . 511 18.4.24   TIM2 timer input selection register (TIM2_TISEL) . . . . . . . . . . . . . . . . 512 18.4.25   TIM3 timer input selection register (TIM3_TISEL) . . . . . . . . . . . . . . . . 512 18.4.26   TIMx register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 514  19   General-purpose timers (TIM14)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 517  19.1   TIM14 introduction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 517 19.2   TIM14 main features   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 517 19.2.1   TIM14 main features   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 517 19.3   TIM14 functional description   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 519 19.3.1   Time-base unit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 519 19.3.2   Counter modes   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 521 19.3.3   Clock selection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 524 19.3.4   Capture/compare channels . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 525 19.3.5   Input capture mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 526 19.3.6   Forced output mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 527 19.3.7   Output compare mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 528 19.3.8   PWM mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 529 19.3.9   One-pulse mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 530 19.3.10   UIF bit remapping   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 530 19.3.11   Using timer output as trigger for other timers (TIM14) . . . . . . . . . . . . . 531 19.3.12   Debug mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 531 19.4   TIM14 registers   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 532 19.4.1   TIM14 control register 1 (TIM14_CR1)   . . . . . . . . . . . . . . . . . . . . . . . . 532 19.4.2   TIM14 Interrupt enable register (TIM14_DIER) . . . . . . . . . . . . . . . . . . 533 19.4.3   TIM14 status register (TIM14_SR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . 533 19.4.4   TIM14 event generation register (TIM14_EGR)   . . . . . . . . . . . . . . . . . 534 19.4.5   TIM14 capture/compare mode register 1 (TIM14_CCMR1)   . . . . . . . . 535 19.4.6   TIM14 capture/compare mode register 1 [alternate] (TIM14_CCMR1) 536 19.4.7   TIM14 capture/compare enable register (TIM14_CCER)   . . . . . . . . . . 538 19.4.8   TIM14 counter (TIM14_CNT) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 539 19.4.9   TIM14 prescaler (TIM14_PSC)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 540 19.4.10   TIM14 auto-reload register (TIM14_ARR) . . . . . . . . . . . . . . . . . . . . . . 540 19.4.11   TIM14 capture/compare register 1 (TIM14_CCR1) . . . . . . . . . . . . . . . 540 19.4.12   TIM14 timer input selection register (TIM14_TISEL) . . . . . . . . . . . . . . 541 19.4.13   TIM14 register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 541

Contents   RM0490  18/1027   RM0490 Rev 5  20   General-purpose timers (TIM15/TIM16/TIM17)   . . . . . . . . . . . . . . . . . . 543  20.1   TIM15/TIM16/TIM17 introduction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 543 20.2   TIM15 main features   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 543 20.3   TIM16/TIM17 main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 544 20.4   TIM15/TIM16/TIM17 functional description   . . . . . . . . . . . . . . . . . . . . . . 547 20.4.1   Time-base unit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 547 20.4.2   Counter modes   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 549 20.4.3   Repetition counter . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 553 20.4.4   Clock selection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 554 20.4.5   Capture/compare channels . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 556 20.4.6   Input capture mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 558 20.4.7   PWM input mode (only for TIM15) . . . . . . . . . . . . . . . . . . . . . . . . . . . . 559 20.4.8   Forced output mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 560 20.4.9   Output compare mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 561 20.4.10   PWM mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 562 20.4.11   Combined PWM mode (TIM15 only) . . . . . . . . . . . . . . . . . . . . . . . . . . 563 20.4.12   Complementary outputs and dead-time insertion   . . . . . . . . . . . . . . . . 564 20.4.13   Using the break function   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 566 20.4.14   Bidirectional break inputs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 571 20.4.15   6-step PWM generation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 572 20.4.16   One-pulse mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 574 20.4.17   Retriggerable one pulse mode (TIM15 only) . . . . . . . . . . . . . . . . . . . . 575 20.4.18   UIF bit remapping   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 576 20.4.19   Timer input XOR function (TIM15 only) . . . . . . . . . . . . . . . . . . . . . . . . 577 20.4.20   External trigger synchronization (TIM15 only) . . . . . . . . . . . . . . . . . . . 578 20.4.21   Slave mode – combined reset + trigger mode . . . . . . . . . . . . . . . . . . . 580 20.4.22   DMA burst mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 580 20.4.23   Timer synchronization (TIM15)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 582 20.4.24   Using timer output as trigger for other timers (TIM16/TIM17)   . . . . . . . 582 20.4.25   Debug mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 582 20.5   TIM15 registers   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 583 20.5.1   TIM15 control register 1 (TIM15_CR1)   . . . . . . . . . . . . . . . . . . . . . . . . 583 20.5.2   TIM15 control register 2 (TIM15_CR2)   . . . . . . . . . . . . . . . . . . . . . . . . 584 20.5.3   TIM15 slave mode control register (TIM15_SMCR)   . . . . . . . . . . . . . . 586 20.5.4   TIM15 DMA/interrupt enable register (TIM15_DIER)   . . . . . . . . . . . . . 587 20.5.5   TIM15 status register (TIM15_SR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . 588

RM0490 Rev 5   19/1027  RM0490   Contents  29  20.5.6   TIM15 event generation register (TIM15_EGR)   . . . . . . . . . . . . . . . . . 590 20.5.7   TIM15 capture/compare mode register 1 (TIM15_CCMR1)   . . . . . . . . 591 20.5.8   TIM15 capture/compare mode register 1 [alternate]  (TIM15_CCMR1) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 592 20.5.9   TIM15 capture/compare enable register (TIM15_CCER)   . . . . . . . . . . 595 20.5.10   TIM15 counter (TIM15_CNT) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 598 20.5.11   TIM15 prescaler (TIM15_PSC)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 598 20.5.12   TIM15 auto-reload register (TIM15_ARR) . . . . . . . . . . . . . . . . . . . . . . 598 20.5.13   TIM15 repetition counter register (TIM15_RCR) . . . . . . . . . . . . . . . . . 599 20.5.14   TIM15 capture/compare register 1 (TIM15_CCR1) . . . . . . . . . . . . . . . 599 20.5.15   TIM15 capture/compare register 2 (TIM15_CCR2) . . . . . . . . . . . . . . . 600 20.5.16   TIM15 break and dead-time register (TIM15_BDTR)   . . . . . . . . . . . . . 600 20.5.17   TIM15 DMA control register (TIM15_DCR)   . . . . . . . . . . . . . . . . . . . . . 603 20.5.18   TIM15 DMA address for full transfer (TIM15_DMAR)   . . . . . . . . . . . . . 603 20.5.19   TIM15 alternate register 1 (TIM15_AF1) . . . . . . . . . . . . . . . . . . . . . . . 604 20.5.20   TIM15 input selection register (TIM15_TISEL)   . . . . . . . . . . . . . . . . . . 604 20.5.21   TIM15 register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 605 20.6   TIM16/TIM17 registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 608 20.6.1   TIMx control register 1 (TIMx_CR1)(x = 16 to 17) . . . . . . . . . . . . . . . . 608 20.6.2   TIMx control register 2 (TIMx_CR2)(x = 16 to 17) . . . . . . . . . . . . . . . . 609 20.6.3   TIMx DMA/interrupt enable register (TIMx_DIER)(x = 16 to 17) . . . . . 610 20.6.4   TIMx status register (TIMx_SR)(x = 16 to 17) . . . . . . . . . . . . . . . . . . . 611 20.6.5   TIMx event generation register (TIMx_EGR)(x = 16 to 17) . . . . . . . . . 612 20.6.6   TIMx capture/compare mode register 1  (TIMx_CCMR1)(x = 16 to 17)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 613 20.6.7   TIMx capture/compare mode register 1 [alternate]  (TIMx_CCMR1)(x = 16 to 17)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 614 20.6.8   TIMx capture/compare enable register (TIMx_CCER)(x = 16 to 17) . . 616 20.6.9   TIMx counter (TIMx_CNT)(x = 16 to 17)   . . . . . . . . . . . . . . . . . . . . . . . 618 20.6.10   TIMx prescaler (TIMx_PSC)(x = 16 to 17) . . . . . . . . . . . . . . . . . . . . . . 619 20.6.11   TIMx auto-reload register (TIMx_ARR)(x = 16 to 17)   . . . . . . . . . . . . . 619 20.6.12   TIMx repetition counter register (TIMx_RCR)(x = 16 to 17) . . . . . . . . . 620 20.6.13   TIMx capture/compare register 1 (TIMx_CCR1)(x = 16 to 17)   . . . . . . 620 20.6.14   TIMx break and dead-time register (TIMx_BDTR)(x = 16 to 17) . . . . . 621 20.6.15   TIMx DMA control register (TIMx_DCR)(x = 16 to 17) . . . . . . . . . . . . . 624 20.6.16   TIMx DMA address for full transfer (TIMx_DMAR)(x = 16 to 17) . . . . . 624 20.6.17   TIM16 alternate function register 1 (TIM16_AF1)   . . . . . . . . . . . . . . . . 625 20.6.18   TIM16 input selection register (TIM16_TISEL)   . . . . . . . . . . . . . . . . . . 625

Contents   RM0490  20/1027   RM0490 Rev 5  20.6.19   TIM17 alternate function register 1 (TIM17_AF1)   . . . . . . . . . . . . . . . . 626 20.6.20   TIM17 input selection register (TIM17_TISEL)   . . . . . . . . . . . . . . . . . . 626 20.6.21   TIM16/TIM17 register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 628  21   Infrared interface (IRTIM)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 630 22   Independent watchdog (IWDG)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 631  22.1   Introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 631 22.2   IWDG main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 631 22.3   IWDG functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 631 22.3.1   IWDG block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 631 22.3.2   Window option . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 632 22.3.3   Hardware watchdog . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 633 22.3.4   Register access protection   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 633 22.3.5   Debug mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 633 22.4   IWDG registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 634 22.4.1   IWDG key register (IWDG_KR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 634 22.4.2   IWDG prescaler register (IWDG_PR)   . . . . . . . . . . . . . . . . . . . . . . . . . 635 22.4.3   IWDG reload register (IWDG_RLR) . . . . . . . . . . . . . . . . . . . . . . . . . . . 636 22.4.4   IWDG status register (IWDG_SR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . 637 22.4.5   IWDG window register (IWDG_WINR)   . . . . . . . . . . . . . . . . . . . . . . . . 638 22.4.6   IWDG register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 639  23   System window watchdog (WWDG)   . . . . . . . . . . . . . . . . . . . . . . . . . . 640  23.1   Introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 640 23.2   WWDG main features   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 640 23.3   WWDG functional description   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 640 23.3.1   WWDG block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 641 23.3.2   Enabling the watchdog   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 641 23.3.3   Controlling the down-counter . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 641 23.3.4   How to program the watchdog timeout   . . . . . . . . . . . . . . . . . . . . . . . . 641 23.3.5   Debug mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 643 23.4   WWDG interrupts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 643 23.5   WWDG registers   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 643 23.5.1   WWDG control register (WWDG_CR) . . . . . . . . . . . . . . . . . . . . . . . . . 643 23.5.2   WWDG configuration register (WWDG_CFR) . . . . . . . . . . . . . . . . . . . 644

RM0490 Rev 5   21/1027  RM0490   Contents  29  23.5.3   WWDG status register (WWDG_SR)   . . . . . . . . . . . . . . . . . . . . . . . . . 645 23.5.4   WWDG register map . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 645  24   Real-time clock (RTC) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 646  24.1   Introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 646 24.2   RTC main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 646 24.3   RTC functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 647 24.3.1   RTC block diagram   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 647 24.3.2   RTC pins and internal signals   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 648 24.3.3   GPIO controlled by the RTC   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 648 24.3.4   Clock and prescalers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 650 24.3.5   Real-time clock and calendar   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 651 24.3.6   Programmable alarms . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 651 24.3.7   RTC initialization and configuration . . . . . . . . . . . . . . . . . . . . . . . . . . . 652 24.3.8   Reading the calendar . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 653 24.3.9   Resetting the RTC . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 654 24.3.10   RTC synchronization . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 654 24.3.11   RTC reference clock detection   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 655 24.3.12   RTC smooth digital calibration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 656 24.3.13   Timestamp function . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 657 24.3.14   Calibration clock output . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 658 24.3.15   Alarm output   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 658 24.4   RTC low-power modes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 659 24.5   RTC interrupts   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 659 24.6   RTC registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 660 24.6.1   RTC time register (RTC_TR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 660 24.6.2   RTC date register (RTC_DR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 661 24.6.3   RTC sub second register (RTC_SSR) . . . . . . . . . . . . . . . . . . . . . . . . . 662 24.6.4   RTC initialization control and status register (RTC_ICSR)   . . . . . . . . . 662 24.6.5   RTC prescaler register (RTC_PRER)   . . . . . . . . . . . . . . . . . . . . . . . . . 664 24.6.6   RTC control register (RTC_CR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 664 24.6.7   RTC write protection register (RTC_WPR)   . . . . . . . . . . . . . . . . . . . . . 667 24.6.8   RTC calibration register (RTC_CALR) . . . . . . . . . . . . . . . . . . . . . . . . . 667 24.6.9   RTC shift control register (RTC_SHIFTR) . . . . . . . . . . . . . . . . . . . . . . 668 24.6.10   RTC timestamp time register (RTC_TSTR) . . . . . . . . . . . . . . . . . . . . . 669 24.6.11   RTC timestamp date register (RTC_TSDR)   . . . . . . . . . . . . . . . . . . . . 670

Contents   RM0490  22/1027   RM0490 Rev 5  24.6.12   RTC timestamp sub second register (RTC_TSSSR) . . . . . . . . . . . . . . 670 24.6.13   RTC alarm A register (RTC_ALRMAR)   . . . . . . . . . . . . . . . . . . . . . . . . 671 24.6.14   RTC alarm A sub second register (RTC_ALRMASSR) . . . . . . . . . . . . 672 24.6.15   RTC status register (RTC_SR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 672 24.6.16   RTC masked interrupt status register (RTC_MISR)   . . . . . . . . . . . . . . 673 24.6.17   RTC status clear register (RTC_SCR) . . . . . . . . . . . . . . . . . . . . . . . . . 674 24.6.18   RTC register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 675  25   Inter-integrated circuit interface (I2C) . . . . . . . . . . . . . . . . . . . . . . . . . 677  25.1   Introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 677 25.2   I2C main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 677 25.3   I2C implementation   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 678 25.4   I2C functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 678 25.4.1   I2C block diagram   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 679 25.4.2   I2C pins and internal signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 680 25.4.3   I2C clock requirements   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 680 25.4.4   I2C mode selection   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 680 25.4.5   I2C initialization   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 681 25.4.6   I2C reset   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 685 25.4.7   I2C data transfer   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 686 25.4.8   I2C target mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 688 25.4.9   I2C controller mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 697 25.4.10   I2C_TIMINGR register configuration examples . . . . . . . . . . . . . . . . . . 708 25.4.11   SMBus specific features   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 710 25.4.12   SMBus initialization   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 713 25.4.13   SMBus I2C_TIMEOUTR register configuration examples . . . . . . . . . . 715 25.4.14   SMBus target mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 716 25.4.15   SMBus controller mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 719 25.4.16   Wake-up from Stop mode on address match   . . . . . . . . . . . . . . . . . . . 722 25.4.17   Error conditions   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 723 25.5   I2C in low-power modes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 725 25.6   I2C interrupts   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 725 25.7   I2C DMA requests   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 726 25.7.1   Transmission using DMA . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 726 25.7.2   Reception using DMA   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 726 25.8   I2C debug modes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 727

RM0490 Rev 5   23/1027  RM0490   Contents  29  25.9   I2C registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 727 25.9.1   I2C control register 1 (I2C_CR1) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 727 25.9.2   I2C control register 2 (I2C_CR2) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 730 25.9.3   I2C own address 1 register (I2C_OAR1) . . . . . . . . . . . . . . . . . . . . . . . 732 25.9.4   I2C own address 2 register (I2C_OAR2) . . . . . . . . . . . . . . . . . . . . . . . 733 25.9.5   I2C timing register (I2C_TIMINGR) . . . . . . . . . . . . . . . . . . . . . . . . . . . 734 25.9.6   I2C timeout register (I2C_TIMEOUTR)   . . . . . . . . . . . . . . . . . . . . . . . . 735 25.9.7   I2C interrupt and status register (I2C_ISR) . . . . . . . . . . . . . . . . . . . . . 736 25.9.8   I2C interrupt clear register (I2C_ICR)   . . . . . . . . . . . . . . . . . . . . . . . . . 738 25.9.9   I2C PEC register (I2C_PECR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 739 25.9.10   I2C receive data register (I2C_RXDR)   . . . . . . . . . . . . . . . . . . . . . . . . 739 25.9.11   I2C transmit data register (I2C_TXDR) . . . . . . . . . . . . . . . . . . . . . . . . 740 25.9.12   I2C register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 741  26   Universal synchronous receiver transmitter (USART)   . . . . . . . . . . . 742  26.1   USART introduction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 742 26.2   USART main features   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 743 26.3   USART extended features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 744 26.4   USART implementation   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 744 26.5   USART functional description   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 746 26.5.1   USART block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 746 26.5.2   USART signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 747 26.5.3   USART character description   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 748 26.5.4   USART FIFOs and thresholds . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 750 26.5.5   USART transmitter . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 750 26.5.6   USART receiver . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 754 26.5.7   USART baud rate generation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 761 26.5.8   Tolerance of the USART receiver to clock deviation   . . . . . . . . . . . . . . 762 26.5.9   USART auto baud rate detection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 764 26.5.10   USART multiprocessor communication . . . . . . . . . . . . . . . . . . . . . . . . 766 26.5.11   USART Modbus communication   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 768 26.5.12   USART parity control . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 769 26.5.13   USART LIN (local interconnection network) mode   . . . . . . . . . . . . . . . 770 26.5.14   USART synchronous mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 772 26.5.15   USART single-wire half-duplex communication . . . . . . . . . . . . . . . . . . 776 26.5.16   USART receiver timeout   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 776

Contents   RM0490  24/1027   RM0490 Rev 5  26.5.17   USART smartcard mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 777 26.5.18   USART IrDA SIR ENDEC block . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 781 26.5.19   Continuous communication using USART and DMA . . . . . . . . . . . . . . 784 26.5.20   RS232 hardware flow control and RS485 Driver Enable . . . . . . . . . . . 786 26.5.21   USART low-power management . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 789 26.6   USART in low-power modes   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 792 26.7   USART interrupts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 793 26.8   USART registers   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 794 26.8.1   USART control register 1 (USART_CR1)   . . . . . . . . . . . . . . . . . . . . . . 794 26.8.2   USART control register 1 [alternate] (USART_CR1) . . . . . . . . . . . . . . 797 26.8.3   USART control register 2 (USART_CR2)   . . . . . . . . . . . . . . . . . . . . . . 801 26.8.4   USART control register 3 (USART_CR3)   . . . . . . . . . . . . . . . . . . . . . . 805 26.8.5   USART baud rate register (USART_BRR)   . . . . . . . . . . . . . . . . . . . . . 809 26.8.6   USART guard time and prescaler register (USART_GTPR) . . . . . . . . 809 26.8.7   USART receiver timeout register (USART_RTOR) . . . . . . . . . . . . . . . 810 26.8.8   USART request register (USART_RQR) . . . . . . . . . . . . . . . . . . . . . . . 811 26.8.9   USART interrupt and status register (USART_ISR)   . . . . . . . . . . . . . . 812 26.8.10   USART interrupt and status register [alternate] (USART_ISR) . . . . . . 818 26.8.11   USART interrupt flag clear register (USART_ICR)   . . . . . . . . . . . . . . . 823 26.8.12   USART receive data register (USART_RDR)   . . . . . . . . . . . . . . . . . . . 825 26.8.13   USART transmit data register (USART_TDR) . . . . . . . . . . . . . . . . . . . 825 26.8.14   USART prescaler register (USART_PRESC)   . . . . . . . . . . . . . . . . . . . 826 26.8.15   USART register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 827  27   Serial peripheral interface / integrated interchip sound (SPI/I2S)   . . 829  27.1   Introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 829 27.2   SPI main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 829 27.3   I2S main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 830 27.4   SPI/I2S implementation   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 830 27.5   SPI functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 831 27.5.1   General description   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 831 27.5.2   Communications between one master and one slave . . . . . . . . . . . . . 832 27.5.3   Standard multislave communication   . . . . . . . . . . . . . . . . . . . . . . . . . . 834 27.5.4   Multimaster communication . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 835 27.5.5   Slave select (NSS) pin management . . . . . . . . . . . . . . . . . . . . . . . . . . 836 27.5.6   Communication formats . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 837

RM0490 Rev 5   25/1027  RM0490   Contents  29  27.5.7   Configuration of SPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 839 27.5.8   Procedure for enabling SPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 840 27.5.9   Data transmission and reception procedures   . . . . . . . . . . . . . . . . . . . 840 27.5.10   SPI status flags   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 850 27.5.11   SPI error flags   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 851 27.5.12   NSS pulse mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 852 27.5.13   TI mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 852 27.5.14   CRC calculation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 853 27.6   SPI interrupts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 855 27.7   I2S functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 856 27.7.1   I2S general description   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 856 27.7.2   Supported audio protocols . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 857 27.7.3   Start-up description   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 864 27.7.4   Clock generator . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 866 27.7.5   I   2   S master mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 869 27.7.6   I   2   S slave mode   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 870 27.7.7   I2S status flags   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 872 27.7.8   I2S error flags   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 873 27.7.9   DMA features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 874 27.8   I2S interrupts   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 874 27.9   SPI and I2S registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 875 27.9.1   SPI control register 1 (SPIx_CR1) . . . . . . . . . . . . . . . . . . . . . . . . . . . . 875 27.9.2   SPI control register 2 (SPIx_CR2) . . . . . . . . . . . . . . . . . . . . . . . . . . . . 877 27.9.3   SPI status register (SPIx_SR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 879 27.9.4   SPI data register (SPIx_DR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 881 27.9.5   SPI CRC polynomial register (SPIx_CRCPR) . . . . . . . . . . . . . . . . . . . 881 27.9.6   SPI Rx CRC register (SPIx_RXCRCR) . . . . . . . . . . . . . . . . . . . . . . . . 881 27.9.7   SPI Tx CRC register (SPIx_TXCRCR)   . . . . . . . . . . . . . . . . . . . . . . . . 882 27.9.8   SPIx_I2S configuration register (SPIx_I2SCFGR) . . . . . . . . . . . . . . . . 882 27.9.9   SPIx_I2S prescaler register (SPIx_I2SPR)   . . . . . . . . . . . . . . . . . . . . . 884 27.9.10   SPI/I2S register map . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 886  28   FD controller area network (FDCAN) . . . . . . . . . . . . . . . . . . . . . . . . . . 887  28.1   Introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 887 28.2   FDCAN main features   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 889 28.3   FDCAN functional description   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 890

Contents   RM0490  26/1027   RM0490 Rev 5  28.3.1   FDCAN block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 890 28.3.2   FDCAN pins and internal signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 891 28.3.3   Bit timing   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 892 28.3.4   Operating modes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 893 28.3.5   Error management . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 902 28.3.6   Message RAM . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 903 28.3.7   FIFO acknowledge handling   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 912 28.3.8   FDCAN Rx FIFO element   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 912 28.3.9   FDCAN Tx buffer element . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 914 28.3.10   FDCAN Tx event FIFO element . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 916 28.3.11   FDCAN standard message ID filter element . . . . . . . . . . . . . . . . . . . . 917 28.3.12   FDCAN extended message ID filter element . . . . . . . . . . . . . . . . . . . . 918 28.4   FDCAN registers   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 920 28.4.1   FDCAN core release register (FDCAN_CREL) . . . . . . . . . . . . . . . . . . 920 28.4.2   FDCAN endian register (FDCAN_ENDN)   . . . . . . . . . . . . . . . . . . . . . . 920 28.4.3   FDCAN data bit timing and prescaler register (FDCAN_DBTP)   . . . . . 920 28.4.4   FDCAN test register (FDCAN_TEST) . . . . . . . . . . . . . . . . . . . . . . . . . 921 28.4.5   FDCAN RAM watchdog register (FDCAN_RWD)   . . . . . . . . . . . . . . . . 922 28.4.6   FDCAN CC control register (FDCAN_CCCR) . . . . . . . . . . . . . . . . . . . 923 28.4.7   FDCAN nominal bit timing and prescaler register (FDCAN_NBTP)   . . 924 28.4.8   FDCAN timestamp counter configuration register (FDCAN_TSCC)   . . 926 28.4.9   FDCAN timestamp counter value register (FDCAN_TSCV)   . . . . . . . . 926 28.4.10   FDCAN timeout counter configuration register (FDCAN_TOCC)   . . . . 927 28.4.11   FDCAN timeout counter value register (FDCAN_TOCV)   . . . . . . . . . . 928 28.4.12   FDCAN error counter register (FDCAN_ECR)   . . . . . . . . . . . . . . . . . . 928 28.4.13   FDCAN protocol status register (FDCAN_PSR)   . . . . . . . . . . . . . . . . . 929 28.4.14   FDCAN transmitter delay compensation register (FDCAN_TDCR) . . . 931 28.4.15   FDCAN interrupt register (FDCAN_IR)   . . . . . . . . . . . . . . . . . . . . . . . . 931 28.4.16   FDCAN interrupt enable register (FDCAN_IE)   . . . . . . . . . . . . . . . . . . 934 28.4.17   FDCAN interrupt line select register (FDCAN_ILS) . . . . . . . . . . . . . . . 936 28.4.18   FDCAN interrupt line enable register (FDCAN_ILE)   . . . . . . . . . . . . . . 937 28.4.19   FDCAN global filter configuration register (FDCAN_RXGFC) . . . . . . . 937 28.4.20   FDCAN extended ID and mask register (FDCAN_XIDAM) . . . . . . . . . 939 28.4.21   FDCAN high-priority message status register (FDCAN_HPMS) . . . . . 939 28.4.22   FDCAN Rx FIFO 0 status register (FDCAN_RXF0S)   . . . . . . . . . . . . . 940 28.4.23   CAN Rx FIFO 0 acknowledge register (FDCAN_RXF0A) . . . . . . . . . . 941 28.4.24   FDCAN Rx FIFO 1 status register (FDCAN_RXF1S)   . . . . . . . . . . . . . 941

RM0490 Rev 5   27/1027  RM0490   Contents  29  28.4.25   FDCAN Rx FIFO 1 acknowledge register (FDCAN_RXF1A)   . . . . . . . 942 28.4.26   FDCAN Tx buffer configuration register (FDCAN_TXBC) . . . . . . . . . . 942 28.4.27   FDCAN Tx FIFO/queue status register (FDCAN_TXFQS)   . . . . . . . . . 943 28.4.28   FDCAN Tx buffer request pending register (FDCAN_TXBRP)   . . . . . . 943 28.4.29   FDCAN Tx buffer add request register (FDCAN_TXBAR) . . . . . . . . . . 944 28.4.30   FDCAN Tx buffer cancellation request register (FDCAN_TXBCR) . . . 945 28.4.31   FDCAN Tx buffer transmission occurred register (FDCAN_TXBTO)   . 945 28.4.32   FDCAN Tx buffer cancellation finished register (FDCAN_TXBCF) . . . 946 28.4.33   FDCAN Tx buffer transmission interrupt enable register  (FDCAN_TXBTIE) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 946 28.4.34   FDCAN Tx buffer cancellation finished interrupt enable register  (FDCAN_TXBCIE) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 947 28.4.35   FDCAN Tx event FIFO status register (FDCAN_TXEFS) . . . . . . . . . . 947 28.4.36   FDCAN Tx event FIFO acknowledge register (FDCAN_TXEFA)   . . . . 948 28.4.37   FDCAN CFG clock divider register (FDCAN_CKDIV) . . . . . . . . . . . . . 948 28.4.38   FDCAN register map . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 949  29   Universal serial bus full-speed host/device interface (USB) . . . . . . . 953  29.1   Introduction   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 953 29.2   USB main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 953 29.3   USB implementation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 953 29.4   USB functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 954 29.4.1   USB block diagram   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 954 29.4.2   USB pins and internal signals   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 955 29.4.3   USB reset and clocks   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 955 29.4.4   General description and Device mode functionality . . . . . . . . . . . . . . . 955 29.4.5   Description of USB blocks used in both Device and Host modes . . . . 956 29.4.6   Description of host frame scheduler (HFS) specific to Host mode   . . . 957 29.5   Programming considerations for Device and Host modes . . . . . . . . . . . 958 29.5.1   Generic USB Device programming   . . . . . . . . . . . . . . . . . . . . . . . . . . . 958 29.5.2   System and power-on reset . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 959 29.5.3   Double-buffered endpoints and usage in Device mode . . . . . . . . . . . . 966 29.5.4   Double buffered channels: usage in Host mode   . . . . . . . . . . . . . . . . . 968 29.5.5   Isochronous transfers in Device mode   . . . . . . . . . . . . . . . . . . . . . . . . 969 29.5.6   Isochronous transfers in Host mode   . . . . . . . . . . . . . . . . . . . . . . . . . . 970 29.5.7   Suspend/resume events   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 971 29.6   USB registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 975

Contents   RM0490  28/1027   RM0490 Rev 5  29.6.1   USB control register (USB_CNTR)   . . . . . . . . . . . . . . . . . . . . . . . . . . . 975 29.6.2   USB interrupt status register (USB_ISTR) . . . . . . . . . . . . . . . . . . . . . . 978 29.6.3   USB frame number register (USB_FNR) . . . . . . . . . . . . . . . . . . . . . . . 982 29.6.4   USB Device address (USB_DADDR)   . . . . . . . . . . . . . . . . . . . . . . . . . 982 29.6.5   USB LPM control and status register (USB_LPMCSR) . . . . . . . . . . . . 983 29.6.6   USB battery charging detector (USB_BCDR) . . . . . . . . . . . . . . . . . . . 984 29.6.7   USB endpoint/channel n register (USB_CHEPnR)   . . . . . . . . . . . . . . . 985 29.6.8   USB register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 994 29.7   USBSRAM registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 995 29.7.1   Channel/endpoint transmit buffer descriptor n  (USB_CHEP_TXRXBD_n)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 996 29.7.2   Channel/endpoint receive buffer descriptor n [alternate]  (USB_CHEP_TXRXBD_n)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 996 29.7.3   Channel/endpoint receive buffer descriptor n  (USB_CHEP_RXTXBD_n)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 998 29.7.4   Channel/endpoint transmit buffer descriptor n [alternate]  (USB_CHEP_RXTXBD_n)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 999 29.7.5   USBSRAM register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1000  30   Debug support (DBG) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1001  30.1   Overview   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1001 30.2   Reference Arm documentation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1002 30.3   Pinout and debug port pins   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1002 30.3.1   SWD port pins . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1002 30.3.2   SW-DP pin assignment   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1002 30.3.3   Internal pull-up & pull-down on SWD pins . . . . . . . . . . . . . . . . . . . . . 1003 30.4   ID codes and locking mechanism . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1003 30.5   SWD port   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1003 30.5.1   SWD protocol introduction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1003 30.5.2   SWD protocol sequence   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1003 30.5.3   SW-DP state machine (reset, idle states, ID code) . . . . . . . . . . . . . . 1004 30.5.4   DP and AP read/write accesses . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1005 30.5.5   SW-DP registers   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1005 30.5.6   SW-AP registers   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1006 30.6   Core debug   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1007 30.7   BPU (break point unit)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1007 30.7.1   BPU functionality . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1008

RM0490 Rev 5   29/1027  RM0490   Contents  29  30.8   DWT (data watchpoint) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1008 30.8.1   DWT functionality . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1008 30.8.2   DWT Program counter sample register . . . . . . . . . . . . . . . . . . . . . . . 1008 30.9   MCU debug component (DBG)   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1008 30.9.1   Debug support for low-power modes . . . . . . . . . . . . . . . . . . . . . . . . . 1008 30.9.2   Debug support for timers, watchdog, and I2C . . . . . . . . . . . . . . . . . . 1009 30.10   DBG registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1009 30.10.1   DBG device ID code register (DBG_IDCODE)   . . . . . . . . . . . . . . . . . 1009 30.10.2   DBG configuration register (DBG_CR)   . . . . . . . . . . . . . . . . . . . . . . . 1010 30.10.3   DBG APB freeze register 1 (DBG_APB_FZ1) . . . . . . . . . . . . . . . . . . 1010 30.10.4   DBG APB freeze register 2 (DBG_APB_FZ2) . . . . . . . . . . . . . . . . . . 1012 30.10.5   DBG register map   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1014  31   Device electronic signature . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1015  31.1   Unique device ID register (96 bits) (UID) . . . . . . . . . . . . . . . . . . . . . . . 1015 31.2   Flash memory size data register (FSIZER)   . . . . . . . . . . . . . . . . . . . . . 1016 31.3   Package data register (PCKR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1016  32   Important security notice . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1018 33   Revision history   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1019

List of tables   RM0490  30/1027   RM0490 Rev 5  List of tables  Table 1.   Peripherals or functions versus products . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 42 Table 2.   STM32C011xx and STM32C031xx boundary addresses. . . . . . . . . . . . . . . . . . . . . . . . . . 47 Table 3.   STM32C051xx boundary addresses . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 47 Table 4.   STM32C071xx boundary addresses . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 48 Table 5.   STM32C091xx boundary addresses . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 48 Table 6.   STM32C092xx boundary addresses . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 49 Table 7.   STM32C0 series peripheral register boundary addresses . . . . . . . . . . . . . . . . . . . . . . . . . 49 Table 8.   SRAM size . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 51 Table 9.   Boot modes. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 53 Table 10.   Flash memory organization for STM32C011xx and STM32C031xx. . . . . . . . . . . . . . . . . . 57 Table 11.   Flash memory organization for STM32C051xx. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 57 Table 12.   Flash memory organization for STM32C071xx. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 58 Table 13.   Flash memory organization for STM32C091xx/92xx . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 58 Table 14.   LATENCY[2:0] setting as function of HCLK frequency . . . . . . . . . . . . . . . . . . . . . . . . . . . . 59 Table 15.   Page erase overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 61 Table 16.   Mass erase overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 62 Table 17.   Option byte format . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 66 Table 18.   Organization of option bytes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 66 Table 19.   Flash memory read protection status . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 69 Table 21.   Access status versus protection level and execution modes . . . . . . . . . . . . . . . . . . . . . . . 71 Table 22.   PCROP protection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 73 Table 24.   Securable memory erase at RDP level 1 to level 0 change . . . . . . . . . . . . . . . . . . . . . . . . 75 Table 25.   FLASH interrupt requests . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 76 Table 26.   FLASH register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 90 Table 27.   Device resources enabled in different operating modes. . . . . . . . . . . . . . . . . . . . . . . . . . . 96 Table 28.   Low-power mode entry overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 99 Table 29.   Low-power mode exit overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 101 Table 30.   PWR register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 115 Table 31.   RCC register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 163 Table 32.   CRS features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 166 Table 33.   CRS internal input/output signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 167 Table 34.   CRS interconnection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 168 Table 35.   Effect of low-power modes on CRS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 171 Table 36.   Interrupt control bits . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 171 Table 37.   CRS register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 176 Table 38.   Port bit configuration table . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 178 Table 39.   Effect of low-power modes on the GPIO . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 186 Table 40.   GPIO register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 194 Table 41.   SYSCFG register map and reset values. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 213 Table 42.   Interconnect matrix . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 217 Table 43.   DMA implementation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 223 Table 44.   DMA internal input/output signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 224 Table 45.   Programmable data width and endian behavior (when PINC = MINC = 1) . . . . . . . . . . . 229 Table 46.   DMA interrupt requests . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 231 Table 47.   DMA register map and reset values   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 239 Table 48.   DMAMUX instantiation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 243 Table 49.   DMAMUX: assignment of multiplexer inputs to resources . . . . . . . . . . . . . . . . . . . . . . . . 244 Table 50.   DMAMUX: assignment of trigger inputs to resources . . . . . . . . . . . . . . . . . . . . . . . . . . . . 244

RM0490 Rev 5   31/1027  RM0490   List of tables  33  Table 51.   DMAMUX: assignment of synchronization inputs to resources . . . . . . . . . . . . . . . . . . . . 245 Table 52.   DMAMUX signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 247 Table 53.   DMAMUX interrupts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 251 Table 54.   DMAMUX register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 256 Table 55.   Vector table. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 257 Table 56.   EXTI signal overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 261 Table 57.   EVG pin overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 261 Table 58.   EXTI event input configurations and register control . . . . . . . . . . . . . . . . . . . . . . . . . . . . 262 Table 59.   EXTI line connections . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 265 Table 60.   Masking functionality . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 265 Table 61.   EXTI register map sections. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 266 Table 62.   EXTI controller register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 276 Table 63.   CRC internal input/output signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 279 Table 64.   CRC register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 284 Table 65.   ADC main features   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 287 Table 66.   ADC input/output pins . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 289 Table 67.   ADC internal input/output signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 289 Table 68.   External triggers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 289 Table 69.   Latency between trigger and start of conversion . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 295 Table 70.   Configuring the trigger polarity . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 302 Table 71.   tSAR timings depending on resolution . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 304 Table 72.   Analog watchdog comparison. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 313 Table 73.   Analog watchdog 1 channel selection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 314 Table 74.   Maximum output results vs N and M. Grayed values indicates truncation . . . . . . . . . . . . 318 Table 75.   ADC interrupts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 322 Table 76.   ADC register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 342 Table 77.   Behavior of timer outputs versus BRK/BRK2 inputs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 386 Table 78.   Break protection disarming conditions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 388 Table 79.   Counting direction versus encoder signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 394 Table 80.   TIM1 internal trigger connection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 411 Table 81.   Output control bits for complementary OCx and OCxN channels with break feature . . . . 425 Table 82.   TIM1 register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 440 Table 83.   Counting direction versus encoder signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 476 Table 84.   TIM2/TIM3 internal trigger connection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 494 Table 85.   Output control bit for standard OCx channels. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 505 Table 86.   TIM2/TIM3 register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 514 Table 87.   Output control bit for standard OCx channels. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 539 Table 88.   TIM14 register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 541 Table 89.   Break protection disarming conditions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 571 Table 90.   TIMx Internal trigger connection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 587 Table 91.   Output control bits for complementary OCx and OCxN channels with break feature  (TIM15) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 597 Table 92.   TIM15 register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 605 Table 93.   Output control bits for complementary OCx and OCxN channels with break feature  (TIM16/17) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 618 Table 94.   TIM16/TIM17 register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 628 Table 95.   IWDG register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 639 Table 96.   WWDG register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 645 Table 97.   RTC input/output pins . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 648 Table 98.   RTC internal input/output signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 648 Table 99.   Pin configuration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 649 Table 100.   RTC_OUT mapping . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 650

List of tables   RM0490  32/1027   RM0490 Rev 5  Table 101.   Effect of low-power modes on RTC . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 659 Table 102.   RTC pins functionality over modes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 659 Table 103.   Interrupt requests . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 659 Table 104.   RTC register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 675 Table 105.   I2C implementation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 678 Table 106.   I2C input/output pins . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 680 Table 107.   I2C internal input/output signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 680 Table 108.   Comparison of analog and digital filters . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 682 Table 109.   I²C-bus and SMBus specification data setup and hold times . . . . . . . . . . . . . . . . . . . . . . 684 Table 110.   I2C configuration. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 688 Table 111.   I²C-bus and SMBus specification clock timings . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 699 Table 112.   Timing settings for f   I2CCLK   of 8 MHz . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 709 Table 113.   Timing settings for f   I2CCLK   of 16 MHz . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 709 Table 114.   Timing settings for f   I2CCLK   of 48 MHz . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 710 Table 115.   SMBus timeout specifications . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 712 Table 116.   SMBus with PEC configuration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 714 Table 117.   TIMEOUTA[11:0] for maximum t TIMEOUT   of 25 ms. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 715 Table 118.   TIMEOUTB[11:0] for maximum t LOW:SEXT   and t LOW:MEXT   of 8 ms . . . . . . . . . . . . . . . . . 715 Table 119.   TIMEOUTA[11:0] for maximum t IDLE   of 50 μs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 715 Table 120.   Effect of low-power modes to I2C . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 725 Table 121.   I2C interrupt requests . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 725 Table 122.   I2C register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 741 Table 123.   Instance implementation on STM32C0 series . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 744 Table 124.   USART features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 745 Table 125.   USART input/output pins . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 748 Table 126.   USART internal input/output signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 748 Table 127.   Noise detection from sampled data . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 760 Table 128.   Tolerance of the USART receiver when BRR [3:0] = 0000. . . . . . . . . . . . . . . . . . . . . . . . 763 Table 129.   Tolerance of the USART receiver when BRR[3:0] is different from 0000 . . . . . . . . . . . . . 764 Table 130.   USART frame formats . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 769 Table 131.   Effect of low-power modes on the USART . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 792 Table 132.   USART interrupt requests. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 793 Table 133.   USART register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 827 Table 134.   STM32C0 series SPI/I2S implementation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 830 Table 135.   SPI interrupt requests . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 855 Table 136.   Audio-frequency precision using 48 MHz clock derived from HSE. . . . . . . . . . . . . . . . . . 868 Table 137.   I2S interrupt requests . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 874 Table 138.   SPI/I2S register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 886 Table 139.   CAN subsystem I/O signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 891 Table 140.   CAN subsystem I/O pins. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 891 Table 141.   DLC coding in FDCAN . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 895 Table 142.   Possible configurations for frame transmission . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 909 Table 143.   Rx FIFO element . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 912 Table 144.   Rx FIFO element description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 912 Table 145.   Tx buffer and FIFO element . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 914 Table 146.   Tx buffer element description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 914 Table 147.   Tx event FIFO element . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 916 Table 148.   Tx event FIFO element description. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 916 Table 149.   Standard message ID filter element . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 917 Table 150.   Standard message ID filter element field description . . . . . . . . . . . . . . . . . . . . . . . . . . . . 918 Table 151.   Extended message ID filter element . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 918 Table 152.   Extended message ID filter element field description . . . . . . . . . . . . . . . . . . . . . . . . . . . . 919

RM0490 Rev 5   33/1027  RM0490   List of tables  33  Table 153.   FDCAN register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 949 Table 154.   STM32C0 series USB implementation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 953 Table 155.   USB input/output pins . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 955 Table 156.   Double-buffering buffer flag definition . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 967 Table 157.   Bulk double-buffering memory buffers usage (Device mode). . . . . . . . . . . . . . . . . . . . . . 967 Table 158.   Bulk double-buffering memory buffers usage (Host mode) . . . . . . . . . . . . . . . . . . . . . . . 969 Table 159.   Isochronous memory buffers usage . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 970 Table 160.   Isochronous memory buffers usage . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 971 Table 161.   Resume event detection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 973 Table 162.   Resume event detection for host . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 974 Table 163.   Reception status encoding . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 992 Table 164.   Endpoint/channel type encoding. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 992 Table 165.   Endpoint/channel kind meaning . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 992 Table 166.   Transmission status encoding . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 992 Table 167.   USB register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 994 Table 168.   Definition of allocated buffer memory . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 997 Table 169.   USBSRAM register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1000 Table 170.   SW debug port pins . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1002 Table 171.   Packet request (8-bits) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1004 Table 172.   ACK response (3 bits). . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1004 Table 173.   DATA transfer (33 bits) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1004 Table 174.   SW-DP registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1005 Table 175.   32-bit debug port registers addressed through the shifted value A[3:2] . . . . . . . . . . . . . 1006 Table 176.   Core debug registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1007 Table 177.   DEV_ID bitfield values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1009 Table 178.   DBG register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1014 Table 179.   Document revision history . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1019

List of figures   RM0490  34/1027   RM0490 Rev 5  List of figures  Figure 1.   System architecture . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 43 Figure 2.   Memory map . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 46 Figure 3.   Changing read protection (RDP) level . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 71 Figure 4.   Example of disabling core debug access . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 75 Figure 5.   Power supply overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 92 Figure 6.   POR, PDR, and BOR thresholds . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 94 Figure 7.   Low-power mode transit diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 95 Figure 8.   Simplified diagram of the reset circuit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 119 Figure 9.   Clock tree . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 123 Figure 10.   HSE/ LSE clock sources . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 124 Figure 11.   Frequency measurement with TIM14 in capture mode. . . . . . . . . . . . . . . . . . . . . . . . . . . 130 Figure 12.   Frequency measurement with TIM16 in capture mode. . . . . . . . . . . . . . . . . . . . . . . . . . . 130 Figure 13.   Frequency measurement with TIM17 in capture mode. . . . . . . . . . . . . . . . . . . . . . . . . . . 131 Figure 14.   CRS block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 167 Figure 15.   CRS counter behavior . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 169 Figure 16.   Basic structure of an I/O port bit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 178 Figure 17.   Input floating/pull up/pull down configurations . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 183 Figure 18.   Output configuration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 184 Figure 19.   Alternate function configuration- . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 185 Figure 20.   High impedance-analog configuration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 185 Figure 21.   DMA block diagram   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 223 Figure 22.   DMAMUX block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 246 Figure 23.   Synchronization mode of the DMAMUX request line multiplexer channel . . . . . . . . . . . . 249 Figure 24.   Event generation of the DMA request line multiplexer channel . . . . . . . . . . . . . . . . . . . . 249 Figure 25.   EXTI block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 261 Figure 26.   Configurable event trigger logic CPU wake-up   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 263 Figure 27.   Direct event trigger logic CPU wake-up . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 264 Figure 28.   EXTI GPIO multiplexer . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 264 Figure 29.   CRC calculation unit block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 279 Figure 30.   ADC block diagram   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 288 Figure 31.   ADC calibration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 292 Figure 32.   Calibration factor forcing   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 292 Figure 33.   Enabling/disabling the ADC . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 293 Figure 34.   ADC clock scheme . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 294 Figure 35.   ADC connectivity . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 296 Figure 36.   Analog-to-digital conversion time . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 301 Figure 37.   ADC conversion timings . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 301 Figure 38.   Stopping an ongoing conversion . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 302 Figure 39.   Single conversions of a sequence, software trigger . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 305 Figure 40.   Continuous conversion of a sequence, software trigger . . . . . . . . . . . . . . . . . . . . . . . . . . 305 Figure 41.   Single conversions of a sequence, hardware trigger . . . . . . . . . . . . . . . . . . . . . . . . . . . . 306 Figure 42.   Continuous conversions of a sequence, hardware trigger . . . . . . . . . . . . . . . . . . . . . . . . 306 Figure 43.   Data alignment and resolution (oversampling disabled: OVSE = 0). . . . . . . . . . . . . . . . . 307 Figure 44.   Example of overrun (OVR) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 308 Figure 45.   Wait mode conversion (continuous mode, software trigger). . . . . . . . . . . . . . . . . . . . . . . 311 Figure 46.   Behavior with WAIT = 0, AUTOFF = 1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 312 Figure 47.   Behavior with WAIT = 1, AUTOFF = 1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 312 Figure 48.   Analog watchdog guarded area . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 313

RM0490 Rev 5   35/1027  RM0490   List of figures  40  Figure 49.   ADC_AWDx_OUT signal generation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 315 Figure 50.   ADC_AWDx_OUT signal generation (AWDx flag not cleared by software) . . . . . . . . . . . 315 Figure 51.   ADC_AWDx_OUT signal generation (on a single channel) . . . . . . . . . . . . . . . . . . . . . . . 316 Figure 52.   Analog watchdog threshold update . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 316 Figure 53.   20-bit to 16-bit result truncation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 317 Figure 54.   Numerical example with 5-bit shift and rounding . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 317 Figure 55.   Triggered oversampling mode (TOVS bit = 1) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 319 Figure 56.   Temperature sensor and VREFINT channel block diagram   . . . . . . . . . . . . . . . . . . . . . . 320 Figure 57.   Advanced-control timer block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 346 Figure 58.   Counter timing diagram with prescaler division change from 1 to 2 . . . . . . . . . . . . . . . . . 348 Figure 59.   Counter timing diagram with prescaler division change from 1 to 4 . . . . . . . . . . . . . . . . . 348 Figure 60.   Counter timing diagram, internal clock divided by 1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 350 Figure 61.   Counter timing diagram, internal clock divided by 2 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 350 Figure 62.   Counter timing diagram, internal clock divided by 4 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 351 Figure 63.   Counter timing diagram, internal clock divided by N. . . . . . . . . . . . . . . . . . . . . . . . . . . . . 351 Figure 64.   Counter timing diagram, update event when ARPE=0 (TIMx_ARR not preloaded) . . . . . 352 Figure 65.   Counter timing diagram, update event when ARPE=1 (TIMx_ARR preloaded) . . . . . . . . 352 Figure 66.   Counter timing diagram, internal clock divided by 1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 354 Figure 67.   Counter timing diagram, internal clock divided by 2 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 354 Figure 68.   Counter timing diagram, internal clock divided by 4 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 355 Figure 69.   Counter timing diagram, internal clock divided by N. . . . . . . . . . . . . . . . . . . . . . . . . . . . . 355 Figure 70.   Counter timing diagram, update event when repetition counter is not used . . . . . . . . . . . 356 Figure 71.   Counter timing diagram, internal clock divided by 1, TIMx_ARR = 0x6 . . . . . . . . . . . . . . 357 Figure 72.   Counter timing diagram, internal clock divided by 2 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 358 Figure 73.   Counter timing diagram, internal clock divided by 4, TIMx_ARR=0x36 . . . . . . . . . . . . . . 358 Figure 74.   Counter timing diagram, internal clock divided by N. . . . . . . . . . . . . . . . . . . . . . . . . . . . . 359 Figure 75.   Counter timing diagram, update event with ARPE=1 (counter underflow) . . . . . . . . . . . . 359 Figure 76.   Counter timing diagram, Update event with ARPE=1 (counter overflow) . . . . . . . . . . . . . 360 Figure 77.   Update rate examples depending on mode and TIMx_RCR register settings . . . . . . . . . 361 Figure 78.   External trigger input block . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 362 Figure 79.   TIM1 ETR input circuitry . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 362 Figure 80.   Control circuit in normal mode, internal clock divided by 1 . . . . . . . . . . . . . . . . . . . . . . . . 363 Figure 81.   TI2 external clock connection example. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 364 Figure 82.   Control circuit in external clock mode 1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 365 Figure 83.   External trigger input block . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 365 Figure 84.   Control circuit in external clock mode 2 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 366 Figure 85.   Capture/compare channel (example: channel 1 input stage) . . . . . . . . . . . . . . . . . . . . . . 367 Figure 86.   Capture/compare channel 1 main circuit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 367 Figure 87.   Output stage of capture/compare channel (channel 1, idem ch. 2 and 3) . . . . . . . . . . . . 368 Figure 88.   Output stage of capture/compare channel (channel 4). . . . . . . . . . . . . . . . . . . . . . . . . . . 368 Figure 89.   Output stage of capture/compare channel (channel 5, idem ch. 6) . . . . . . . . . . . . . . . . . 369 Figure 90.   PWM input mode timing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 371 Figure 91.   Output compare mode, toggle on OC1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 373 Figure 92.   Edge-aligned PWM waveforms (ARR=8) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 374 Figure 93.   Center-aligned PWM waveforms (ARR=8) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 375 Figure 94.   Generation of 2 phase-shifted PWM signals with 50% duty cycle . . . . . . . . . . . . . . . . . . 377 Figure 95.   Combined PWM mode on channel 1 and 3 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 378 Figure 96.   3-phase combined PWM signals with multiple trigger pulses per period . . . . . . . . . . . . . 379 Figure 97.   Complementary output with dead-time insertion . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 380 Figure 98.   Dead-time waveforms with delay greater than the negative pulse . . . . . . . . . . . . . . . . . . 380 Figure 99.   Dead-time waveforms with delay greater than the positive pulse. . . . . . . . . . . . . . . . . . . 381 Figure 100.   Break and Break2 circuitry overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 383

List of figures   RM0490  36/1027   RM0490 Rev 5  Figure 101.   Various output behavior in response to a break event on BRK (OSSI = 1) . . . . . . . . . . . 385 Figure 102.   PWM output state following BRK and BRK2 pins assertion (OSSI=1) . . . . . . . . . . . . . . . 386 Figure 103.   PWM output state following BRK assertion (OSSI=0) . . . . . . . . . . . . . . . . . . . . . . . . . . . 387 Figure 104.   Output redirection (BRK2 request not represented) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 388 Figure 105.   Clearing TIMx OCxREF . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 389 Figure 106.   6-step generation, COM example (OSSR=1) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 390 Figure 107.   Example of one pulse mode. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 391 Figure 108.   Retriggerable one pulse mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 393 Figure 109.   Example of counter operation in encoder interface mode. . . . . . . . . . . . . . . . . . . . . . . . . 394 Figure 110.   Example of encoder interface mode with TI1FP1 polarity inverted. . . . . . . . . . . . . . . . . . 395 Figure 111.   Measuring time interval between edges on 3 signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . 396 Figure 112.   Example of Hall sensor interface . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 398 Figure 113.   Control circuit in reset mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 399 Figure 114.   Control circuit in Gated mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 400 Figure 115.   Control circuit in trigger mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 401 Figure 116.   Control circuit in external clock mode 2 + trigger mode . . . . . . . . . . . . . . . . . . . . . . . . . . 402 Figure 117.   General-purpose timer block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 444 Figure 118.   Counter timing diagram with prescaler division change from 1 to 2 . . . . . . . . . . . . . . . . . 446 Figure 119.   Counter timing diagram with prescaler division change from 1 to 4 . . . . . . . . . . . . . . . . . 446 Figure 120.   Counter timing diagram, internal clock divided by 1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 447 Figure 121.   Counter timing diagram, internal clock divided by 2 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 448 Figure 122.   Counter timing diagram, internal clock divided by 4 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 448 Figure 123.   Counter timing diagram, internal clock divided by N. . . . . . . . . . . . . . . . . . . . . . . . . . . . . 449 Figure 124.   Counter timing diagram, Update event when ARPE=0 (TIMx_ARR not preloaded). . . . . 449 Figure 125.   Counter timing diagram, Update event when ARPE=1 (TIMx_ARR preloaded). . . . . . . . 450 Figure 126.   Counter timing diagram, internal clock divided by 1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 451 Figure 127.   Counter timing diagram, internal clock divided by 2 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 451 Figure 128.   Counter timing diagram, internal clock divided by 4 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 452 Figure 129.   Counter timing diagram, internal clock divided by N. . . . . . . . . . . . . . . . . . . . . . . . . . . . . 452 Figure 130.   Counter timing diagram, Update event . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 453 Figure 131.   Counter timing diagram, internal clock divided by 1, TIMx_ARR=0x6 . . . . . . . . . . . . . . . 454 Figure 132.   Counter timing diagram, internal clock divided by 2 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 455 Figure 133.   Counter timing diagram, internal clock divided by 4, TIMx_ARR=0x36 . . . . . . . . . . . . . . 455 Figure 134.   Counter timing diagram, internal clock divided by N. . . . . . . . . . . . . . . . . . . . . . . . . . . . . 456 Figure 135.   Counter timing diagram, Update event with ARPE=1 (counter underflow). . . . . . . . . . . . 456 Figure 136.   Counter timing diagram, Update event with ARPE=1 (counter overflow) . . . . . . . . . . . . . 457 Figure 137.   Control circuit in normal mode, internal clock divided by 1 . . . . . . . . . . . . . . . . . . . . . . . . 458 Figure 138.   TI2 external clock connection example. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 458 Figure 139.   Control circuit in external clock mode 1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 459 Figure 140.   External trigger input block . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 460 Figure 141.   Control circuit in external clock mode 2 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 461 Figure 142.   Capture/Compare channel (example: channel 1 input stage) . . . . . . . . . . . . . . . . . . . . . 461 Figure 143.   Capture/Compare channel 1 main circuit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 462 Figure 144.   Output stage of Capture/Compare channel (channel 1) . . . . . . . . . . . . . . . . . . . . . . . . . . 462 Figure 145.   PWM input mode timing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 464 Figure 146.   Output compare mode, toggle on OC1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 466 Figure 147.   Edge-aligned PWM waveforms (ARR=8) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 467 Figure 148.   Center-aligned PWM waveforms (ARR=8) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 469 Figure 149.   Generation of 2 phase-shifted PWM signals with 50% duty cycle . . . . . . . . . . . . . . . . . . 470 Figure 150.   Combined PWM mode on channels 1 and 3 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 471 Figure 151.   Clearing TIMx OCxREF . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 472 Figure 152.   Example of one-pulse mode. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 473

RM0490 Rev 5   37/1027  RM0490   List of figures  40  Figure 153.   Retriggerable one-pulse mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 475 Figure 154.   Example of counter operation in encoder interface mode . . . . . . . . . . . . . . . . . . . . . . . . 476 Figure 155.   Example of encoder interface mode with TI1FP1 polarity inverted . . . . . . . . . . . . . . . . . 477 Figure 156.   Control circuit in reset mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 478 Figure 157.   Control circuit in gated mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 479 Figure 158.   Control circuit in trigger mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 480 Figure 159.   Control circuit in external clock mode 2 + trigger mode . . . . . . . . . . . . . . . . . . . . . . . . . . 481 Figure 160.   Master/Slave timer example . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 482 Figure 161.   Master/slave connection example with 1 channel only timers . . . . . . . . . . . . . . . . . . . . . 482 Figure 162.   Gating TIMz with OC1REF of TIMy . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 483 Figure 163.   Gating TIMz with Enable of TIMy . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 484 Figure 164.   Triggering TIMz with update of TIMy . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 485 Figure 165.   Triggering TIMz with Enable of TIMy . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 485 Figure 166.   Triggering TIMy and TIMz with TIMy TI1 input . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 486 Figure 167.   General-purpose timer block diagram (TIM14) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 518 Figure 168.   Counter timing diagram with prescaler division change from 1 to 2 . . . . . . . . . . . . . . . . . 520 Figure 169.   Counter timing diagram with prescaler division change from 1 to 4 . . . . . . . . . . . . . . . . . 520 Figure 170.   Counter timing diagram, internal clock divided by 1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 521 Figure 171.   Counter timing diagram, internal clock divided by 2 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 522 Figure 172.   Counter timing diagram, internal clock divided by 4 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 522 Figure 173.   Counter timing diagram, internal clock divided by N. . . . . . . . . . . . . . . . . . . . . . . . . . . . . 523 Figure 174.   Counter timing diagram, update event when ARPE=0 (TIMx_ARR not  preloaded). . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 523 Figure 175.   Counter timing diagram, update event when ARPE=1 (TIMx_ARR  preloaded). . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 524 Figure 176.   Control circuit in normal mode, internal clock divided by 1 . . . . . . . . . . . . . . . . . . . . . . . . 525 Figure 177.   Capture/compare channel (example: channel 1 input stage) . . . . . . . . . . . . . . . . . . . . . . 525 Figure 178.   Capture/compare channel 1 main circuit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 526 Figure 179.   Output stage of capture/compare channel (channel 1). . . . . . . . . . . . . . . . . . . . . . . . . . . 526 Figure 180.   Output compare mode, toggle on OC1. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 529 Figure 181.   Edge-aligned PWM waveforms (ARR=8) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 530 Figure 182.   TIM15 block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 545 Figure 183.   TIM16/TIM17 block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 546 Figure 184.   Counter timing diagram with prescaler division change from 1 to 2 . . . . . . . . . . . . . . . . . 548 Figure 185.   Counter timing diagram with prescaler division change from 1 to 4 . . . . . . . . . . . . . . . . . 548 Figure 186.   Counter timing diagram, internal clock divided by 1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 550 Figure 187.   Counter timing diagram, internal clock divided by 2 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 550 Figure 188.   Counter timing diagram, internal clock divided by 4 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 551 Figure 189.   Counter timing diagram, internal clock divided by N. . . . . . . . . . . . . . . . . . . . . . . . . . . . . 551 Figure 190.   Counter timing diagram, update event when ARPE=0 (TIMx_ARR not  preloaded). . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 552 Figure 191.   Counter timing diagram, update event when ARPE=1 (TIMx_ARR  preloaded). . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 552 Figure 192.   Update rate examples depending on mode and TIMx_RCR register settings . . . . . . . . . 554 Figure 193.   Control circuit in normal mode, internal clock divided by 1 . . . . . . . . . . . . . . . . . . . . . . . . 555 Figure 194.   TI2 external clock connection example. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 555 Figure 195.   Control circuit in external clock mode 1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 556 Figure 196.   Capture/compare channel (example: channel 1 input stage) . . . . . . . . . . . . . . . . . . . . . . 557 Figure 197.   Capture/compare channel 1 main circuit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 557 Figure 198.   Output stage of capture/compare channel (channel 1). . . . . . . . . . . . . . . . . . . . . . . . . . . 558 Figure 199.   Output stage of capture/compare channel (channel 2 for TIM15) . . . . . . . . . . . . . . . . . . 558 Figure 200.   PWM input mode timing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 560

List of figures   RM0490  38/1027   RM0490 Rev 5  Figure 201.   Output compare mode, toggle on OC1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 562 Figure 202.   Edge-aligned PWM waveforms (ARR=8) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 563 Figure 203.   Combined PWM mode on channel 1 and 2 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 564 Figure 204.   Complementary output with dead-time insertion. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 565 Figure 205.   Dead-time waveforms with delay greater than the negative pulse. . . . . . . . . . . . . . . . . . 565 Figure 206.   Dead-time waveforms with delay greater than the positive pulse. . . . . . . . . . . . . . . . . . . 566 Figure 207.   Break circuitry overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 568 Figure 208.   Output behavior in response to a break . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 570 Figure 209.   Output redirection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 572 Figure 210.   6-step generation, COM example (OSSR=1) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 573 Figure 211.   Example of one pulse mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 574 Figure 212.   Retriggerable one pulse mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 576 Figure 213.   Measuring time interval between edges on 2 signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . 577 Figure 214.   Control circuit in reset mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 578 Figure 215.   Control circuit in gated mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 579 Figure 216.   Control circuit in trigger mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 580 Figure 217.   IRTIM internal hardware connections with TIM16 and TIM17   . . . . . . . . . . . . . . . . . . . . 630 Figure 218.   Independent watchdog block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 631 Figure 219.   Watchdog block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 641 Figure 220.   Window watchdog timing diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 642 Figure 221.   RTC block diagram   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 647 Figure 222.   Block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 679 Figure 223.   I²C-bus protocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 681 Figure 224.   Setup and hold timings . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 683 Figure 225.   I2C initialization flow   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 685 Figure 226.   Data reception . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 686 Figure 227.   Data transmission . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 687 Figure 228.   Target initialization flow   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 690 Figure 229.   Transfer sequence flow for I2C target transmitter, NOSTRETCH = 0 . . . . . . . . . . . . . . . 692 Figure 230.   Transfer sequence flow for I2C target transmitter, NOSTRETCH = 1 . . . . . . . . . . . . . . . 693 Figure 231.   Transfer bus diagrams for I2C target transmitter (mandatory events only) . . . . . . . . . . . 694 Figure 232.   Transfer sequence flow for I2C target receiver, NOSTRETCH = 0 . . . . . . . . . . . . . . . . . 695 Figure 233.   Transfer sequence flow for I2C target receiver, NOSTRETCH = 1 . . . . . . . . . . . . . . . . . 696 Figure 234.   Transfer bus diagrams for I2C target receiver  (mandatory events only) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 696 Figure 235.   Controller clock generation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 698 Figure 236.   Controller initialization flow   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 700 Figure 237.   10-bit address read access with HEAD10R = 0 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 700 Figure 238.   10-bit address read access with HEAD10R = 1 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 701 Figure 239.   Transfer sequence flow for I2C controller transmitter, N   ≤   255 bytes. . . . . . . . . . . . . . . . 702 Figure 240.   Transfer sequence flow for I2C controller transmitter, N > 255 bytes. . . . . . . . . . . . . . . . 703 Figure 241.   Transfer bus diagrams for I2C controller transmitter  (mandatory events only) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 704 Figure 242.   Transfer sequence flow for I2C controller receiver, N   ≤   255 bytes   . . . . . . . . . . . . . . . . . 706 Figure 243.   Transfer sequence flow for I2C controller receiver, N > 255 bytes. . . . . . . . . . . . . . . . . . 707 Figure 244.   Transfer bus diagrams for I2C controller receiver  (mandatory events only) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 708 Figure 245.   Timeout intervals for t   LOW:SEXT , t LOW:MEXT   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 713 Figure 246.   Transfer sequence flow for SMBus target transmitter N bytes + PEC . . . . . . . . . . . . . . . 716 Figure 247.   Transfer bus diagram for SMBus target transmitter (SBC = 1). . . . . . . . . . . . . . . . . . . . . 717 Figure 248.   Transfer sequence flow for SMBus target receiver N bytes + PEC . . . . . . . . . . . . . . . . . 718 Figure 249.   Bus transfer diagrams for SMBus target receiver (SBC = 1) . . . . . . . . . . . . . . . . . . . . . . 719

RM0490 Rev 5   39/1027  RM0490   List of figures  40  Figure 250.   Bus transfer diagrams for SMBus controller transmitter . . . . . . . . . . . . . . . . . . . . . . . . . . 720 Figure 251.   Bus transfer diagrams for SMBus controller receiver . . . . . . . . . . . . . . . . . . . . . . . . . . . . 722 Figure 252.   USART block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 746 Figure 253.   Word length programming . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 749 Figure 254.   Configurable stop bits . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 751 Figure 255.   TC/TXE behavior when transmitting . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 754 Figure 256.   Start bit detection when oversampling by 16 or 8 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 755 Figure 257.   usart_ker_ck clock divider block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 758 Figure 258.   Data sampling when oversampling by 16 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 759 Figure 259.   Data sampling when oversampling by 8 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 760 Figure 260.   Mute mode using Idle line detection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 767 Figure 261.   Mute mode using address mark detection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 768 Figure 262.   Break detection in LIN mode (11-bit break length - LBDL bit is set) . . . . . . . . . . . . . . . . . 771 Figure 263.   Break detection in LIN mode vs. Framing error detection. . . . . . . . . . . . . . . . . . . . . . . . . 772 Figure 264.   USART example of synchronous master transmission. . . . . . . . . . . . . . . . . . . . . . . . . . . 773 Figure 265.   USART data clock timing diagram in synchronous master mode  (M bits = 00) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 773 Figure 266.   USART data clock timing diagram in synchronous master mode  (M bits = 01) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 774 Figure 267.   USART data clock timing diagram in synchronous slave mode  (M bits = 00) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 775 Figure 268.   ISO 7816-3 asynchronous protocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 777 Figure 269.   Parity error detection using the 1.5 stop bits . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 779 Figure 270.   IrDA SIR ENDEC block diagram. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 783 Figure 271.   IrDA data modulation (3/16) - normal mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 783 Figure 272.   Transmission using DMA . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 785 Figure 273.   Reception using DMA . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 786 Figure 274.   Hardware flow control between 2 USARTs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 786 Figure 275.   RS232 RTS flow control . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 787 Figure 276.   RS232 CTS flow control . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 788 Figure 277.   Wake-up event verified (wake-up event = address match, FIFO disabled) . . . . . . . . . . . 791 Figure 278.   Wake-up event not verified (wake-up event = address match,  FIFO disabled) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 791 Figure 279.   SPI block diagram. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 831 Figure 280.   Full-duplex single master/ single slave application . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 832 Figure 281.   Half-duplex single master/ single slave application . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 833 Figure 282.   Simplex single master/single slave application (master in transmit-only/  slave in receive-only mode) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 834 Figure 283.   Master and three independent slaves. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 835 Figure 284.   Multimaster application . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 836 Figure 285.   Hardware/software slave select management . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 837 Figure 286.   Data clock timing diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 838 Figure 287.   Data alignment when data length is not equal to 8-bit or 16-bit . . . . . . . . . . . . . . . . . . . . 839 Figure 288.   Packing data in FIFO for transmission and reception . . . . . . . . . . . . . . . . . . . . . . . . . . . . 843 Figure 289.   Master full-duplex communication . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 846 Figure 290.   Slave full-duplex communication . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 847 Figure 291.   Master full-duplex communication with CRC . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 848 Figure 292.   Master full-duplex communication in packed mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 849 Figure 293.   NSSP pulse generation in Motorola SPI master mode . . . . . . . . . . . . . . . . . . . . . . . . . . . 852 Figure 294.   TI mode transfer . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 853 Figure 295.   I2S block diagram   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 856 Figure 296.   I   2   S Philips protocol waveforms (16/32-bit full accuracy). . . . . . . . . . . . . . . . . . . . . . . . . . 858

List of figures   RM0490  40/1027   RM0490 Rev 5  Figure 297.   I   2   S Philips standard waveforms (24-bit frame) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 858 Figure 298.   Transmitting 0x8EAA33 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 859 Figure 299.   Receiving 0x8EAA33 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 859 Figure 300.   I   2   S Philips standard (16-bit extended to 32-bit packet frame) . . . . . . . . . . . . . . . . . . . . . 859 Figure 301.   Example of 16-bit data frame extended to 32-bit channel frame . . . . . . . . . . . . . . . . . . . 859 Figure 302.   MSB Justified 16-bit or 32-bit full-accuracy length . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 860 Figure 303.   MSB justified 24-bit frame length . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 860 Figure 304.   MSB justified 16-bit extended to 32-bit packet frame . . . . . . . . . . . . . . . . . . . . . . . . . . . . 861 Figure 305.   LSB justified 16-bit or 32-bit full-accuracy . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 861 Figure 306.   LSB justified 24-bit frame length . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 861 Figure 307.   Operations required to transmit 0x3478AE. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 862 Figure 308.   Operations required to receive 0x3478AE . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 862 Figure 309.   LSB justified 16-bit extended to 32-bit packet frame . . . . . . . . . . . . . . . . . . . . . . . . . . . . 862 Figure 310.   Example of 16-bit data frame extended to 32-bit channel frame . . . . . . . . . . . . . . . . . . . 863 Figure 311.   PCM standard waveforms (16-bit) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 863 Figure 312.   PCM standard waveforms (16-bit extended to 32-bit packet frame). . . . . . . . . . . . . . . . . 864 Figure 313.   Start sequence in master mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 865 Figure 314.   Audio sampling frequency definition . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 866 Figure 315.   I   2   S clock generator architecture . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 866 Figure 316.   CAN subsystem. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 888 Figure 317.   FDCAN block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 890 Figure 318.   Bit timing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 892 Figure 319.   Transceiver delay measurement . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 897 Figure 320.   Pin control in bus monitoring mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 898 Figure 321.   Pin control in loop-back mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 901 Figure 322.   CAN error state diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 902 Figure 323.   Message RAM configuration. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 903 Figure 324.   Standard message ID filter path . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 906 Figure 325.   Extended message ID filter path. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 907 Figure 326.   USB peripheral block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 954 Figure 327.   Packet buffer areas with examples of buffer description table locations . . . . . . . . . . . . . 961 Figure 328.   Block diagram of STM32C0 series MCU and Cortex   ® -M0+-level debug support . . . . . 1001

RM0490 Rev 5   41/1027  RM0490   Documentation conventions  42  1   Documentation conventions 1.1   General information  The STM32C0 series devices have an Arm   ®(a)   Cortex   ® -M0+ core.  1.2   List of abbreviations for registers  The following abbreviations (b)   are used in register descriptions:  1.3   Register reset value  Bits (binary notation) or bits nibbles (hexadecimal notation) of which the reset value is undefined are marked as X. a.   Arm is a registered trademark of Arm Limited (or its subsidiaries) in the US and/or elsewhere.  b.   This is an exhaustive list of all abbreviations applicable to STMicroelectronics microcontrollers, some of them may not be used in the current document. read/write (rw)   Software can read and write to this bit. read-only (r)   Software can only read this bit. write-only (w)   Software can only write to this bit. Reading this bit returns the reset value. read/clear write0 (rc_w0)   Software can read as well as clear this bit by writing 0. Writing 1 has no effect on the bit value. read/clear write1 (rc_w1)   Software can read as well as clear this bit by writing 1. Writing 0 has no effect on the bit value. read/clear write (rc_w)   Software can read as well as clear this bit by writing to the register. The value written to this bit is not important. read/clear by read (rc_r)   Software can read this bit. Reading this bit automatically clears it to 0. Writing this bit has no effect on the bit value. read/set by read (rs_r)   Software can read this bit. Reading this bit automatically sets it to 1. Writing this bit has no effect on the bit value. read/set (rs)   Software can read as well as set this bit. Writing 0 has no effect on the bit value. read/write once (rwo)   Software can only write once to this bit and can also read it at any time. Only a reset can return the bit to its reset value. toggle (t)   The software can toggle this bit by writing 1. Writing 0 has no effect. read-only write trigger (rt_w1) Software can read this bit. Writing 1 triggers an event but has no effect on the bit value. Reserved (Res.)   Reserved bit, must be kept at reset value.

Documentation conventions   RM0490  42/1027   RM0490 Rev 5  Bits (binary notation) or bits nibbles (hexadecimal notation) of which the reset value is unmodified are marked as U.  1.4   Glossary  This section gives a brief definition of acronyms and abbreviations used in this document:  •   Word : data of 32-bit length.  •   Half-word : data of 16-bit length.  •   Byte : data of 8-bit length.  •   AHB : advanced high-performance bus.  1.5   Availability of peripherals  The following table lists product differentiating peripherals or functions available (X) or absent (-) on different products.  Table 1. Peripherals or functions versus products Peripheral or function STM32C011xx STM32C031xx STM32C051xx STM32C071xx STM32C091xx STM32C092xx  CRS   -   -   -   X   -   - USB   -   -   -   X   -   - HSIUSB48 oscillator   -   -   -   X   -   - USART3/4   -   -   -   -   X   X SPI2   -   -   X   X   X   X I2C2   -   -   X   X   X   X FDCAN1   -   -   -   -   -   X TIM2   -   -   X   X   X   X TIM15   -   -   -   -   X   X VDDIO2 pin   -   -   -   X (1) 1.   Not on all packages. Refer to the product datasheet. -   -

RM0490 Rev 5   43/1027  RM0490   Memory and bus architecture  44  2   Memory and bus architecture 2.1   System architecture  The main system consists of:  •   Two masters: –   Cortex ®   -M0+ core –   General-purpose DMA  •   Three slaves: –   Internal SRAM –   Internal flash memory –   AHB with AHB-to-APB bridge that connects all the APB peripherals These are interconnected using a multilayer AHB bus architecture as shown in   Figure 1 .  Figure 1. System architecture System bus (S-bus)  This bus connects the system bus of the Cortex   ® -M0+ core (peripheral bus) to a bus matrix that manages the arbitration between the core and the DMA.  DMA bus  This bus connects the AHB master interface of the DMA to the bus matrix that manages the access of CPU and DMA to SRAM, flash memory and AHB/APB peripherals.  MSv66119V2 Bus matrix Flash memory interface SRAM GPIO Ports A,B,C,D,F AHB-to-APB bridge Arm   ® Cortex   ® -M0+ core DMA1/DMAMUX channels 1..7 System bus RCC CRC DMA requests Flash memory AHB   APB SYSCFG, ADC, TIM1, TIM2, TIM3 TIM14, TIM15, TIM16, TIM17, IWDG, WWDG, RTC, PWR, I2C1, I2C2, USART1-4, SPI1, SPI2, USB, CRS, DBGMCU, FDCAN1 DMA bus EXTI IOPORT

Memory and bus architecture   RM0490  44/1027   RM0490 Rev 5  Bus matrix  The bus matrix arbitrates the access between the core system bus and the DMA master bus. The arbitration uses a Round Robin algorithm. The bus matrix is composed of masters (CPU, DMA) and slaves (flash memory interface, SRAM and AHB-to-APB bridge). AHB peripherals are connected to the system bus through the bus matrix to allow DMA access.  AHB-to-APB bridge (APB)  The AHB-to-APB bridge provides full synchronous connections between the AHB and the APB bus. Refer to   Section 2.2: Memory organization   for the address mapping of the peripherals connected to this bridge. After each device reset, all peripheral clocks are disabled (except for the SRAM and flash memory). Before using a peripheral, its clock must first be enabled through the RCC_AHBENR, RCC_APBENRx, or RCC_IOPENR register.  Note:   Unless otherwise specified, when a 16- or 8-bit access is performed on an APB register, the access is transformed into a 32-bit access: the bridge duplicates the 16- or 8-bit data to feed the 32-bit vector.

RM0490 Rev 5   45/1027  RM0490  45  2.2   Memory organization 2.2.1   Introduction  Program memory, data memory, registers and I/O ports are organized within the same linear address space. The bytes are coded in memory in Little Endian format. The lowest numbered byte in a word is considered the word’s least significant byte and the highest numbered byte the most significant.

RM0490  46/1027   RM0490 Rev 5  2.2.2   Memory map and register boundary addresses Figure 2. Memory map  1.   0x0000 7FFF for STM32C011xx and STM32C031xx; 0x0800 FFFF for STM32C051xx; 0x0001 FFFF for STM32C071xx; 0x0003 FFFF for STM32C091xx/92xx 2.   0x0800 7FFF for STM32C011xx and STM32C031xx; 0x0000 FFFF for STM32C051xx; 0x0801 FFFF for STM32C071xx; 0x0803 FFFF for STM32C091xx/92xx 3.   Depends on boot configuration All the memory map areas that are not allocated to on-chip memories and peripherals are considered as reserved. For the detailed mapping of available memory and register areas, refer to the following tables.  Addressable space block 0 block 1 block 2 block 3 block 4 block 5 block 6 block 7 0xFFFF FFFF 0xE000 0000 0xC000 0000 0xA000 0000 0 x 8 0 0 0 0 0 0 0 0 x 6 0 0 0 0 0 0 0 0 x 4 0 0 0 0 0 0 0 0 x 2 0 0 0 0 0 0 0 0 x 0 0 0 0 0 0 0 0 Code RAM Peripherals Arm Cortex M0+ internal peripherals Reserved space Used space Main flash memory / System memory / RAM   (3) Main flash memory System memory Option bytes APB AHB IOPORT 0 x 0 0 0 0 0 0 0 0 0 x 0 8 0 0 0 0 0 0 0x1FFF 0000 0x1FFF 7800 0x1FFF 787F 0 x 4 0 0 0 0 0 0 0 0 x 4 0 0 1 F F F F 0 x 4 0 0 2 0 0 0 0 0 x 4 F F F F F F F 0 x 5 0 0 0 0 0 0 0 0 x 5 F F F F FFF Engineering bytes   0x1FFF 7500 OTP   0x1FFF 7000 0x1FFF 73FF ( 1 ) ( 2 )

RM0490 Rev 5   47/1027  RM0490  55  Table 2. STM32C011xx and STM32C031xx boundary addresses Type   Boundary address   Size   Memory Area   Register description  SRAM   0x2000 3000 - 0x3FFF FFFF   ~512 MB   Reserved   - 0x2000 0000 - 0x2000 2FFF   12 KB   SRAM   - FLASH 0x1FFF 7880- 0x1FFF FFFF   ~34 KB   Reserved   - 0x1FFF 7800 - 0x1FFF 787F   128 B   Option bytes   Section 4.4 on page 66  0x1FFF 7500 - 0x1FFF 77FF   768 B   Engineering bytes   - 0x1FFF 7400- 0x1FFF 74FF   256 B   Reserved   - 0x1FFF 7000 - 0x1FFF 73FF   1 KB   OTP   - 0x1FFF 1800- 0x1FFF 6FFF   ~22 KB   Reserved   - 0x1FFF 0000 - 0x1FFF 17FF   6 KB   System memory   - 0x0800 8000 - 0x1FFE FFFF   ~384 MB   Reserved   - 0x0800 0000 - 0x0800 7FFF   32 KB   Main flash memory   Section 4.3.1 on page 56  FLASH or SRAM 0x0000 8000 - 0x07FF FFFF   ~127 MB   Reserved   - 0x0000 0000 - 0x000 7FFF   32 KB Main flash memory, system memory, or SRAM, depending on boot configuration -  Table 3. STM32C051xx boundary addresses Type   Boundary address   Size   Memory Area   Register description  SRAM   0x2000 3000 - 0x3FFF FFFF   ~512 MB   Reserved   - 0x2000 0000 - 0x2000 2FFF   12 KB   SRAM   - FLASH 0x1FFF 8000- 0x1FFF FFFF   32 KB   Reserved   - 0x1FFF 7800 - 0x1FFF 7FFF   2 KB   Option bytes   Section 4.4 on page 66  0x1FFF 7500 - 0x1FFF 77FF   768 B   Engineering bytes   - 0x1FFF 7400- 0x1FFF 74FF   256 B   Reserved   - 0x1FFF 7000 - 0x1FFF 73FF   1 KB   OTP   - 0x1FFF 3000 - 0x1FFF 6FFF   16 KB   Reserved   - 0x1FFF 0000 - 0x1FFF 2FFF   12 KB   System memory   - 0x0801 0000 - 0x1FFE FFFF   ~384 MB   Reserved   - 0x0800 0000 - 0x0800 FFFF   64 KB   Main flash memory   Section 4.3.1 on page 56  FLASH or SRAM 0x0000 8000 - 0x07FF FFFF   ~127 MB   Reserved   - 0x0000 0000 - 0x000 FFFF   64 KB Main flash memory, system memory, or SRAM, depending on boot configuration -

RM0490  48/1027   RM0490 Rev 5  Table 4. STM32C071xx boundary addresses Type   Boundary address   Size   Memory Area   Register description  SRAM   0x2000 6000 - 0x3FFF FFFF   ~512 MB   Reserved   - 0x2000 0000 - 0x2000 5FFF   24 KB   SRAM   - FLASH 0x1FFF 8000- 0x1FFF FFFF   32 KB   Reserved   - 0x1FFF 7800 - 0x1FFF 7FFF   2 KB   Option bytes   Section 4.4 on page 66  0x1FFF 7500 - 0x1FFF 77FF   768 B   Engineering bytes   - 0x1FFF 7400 - 0x1FFF 74FF   256 B   Reserved   - 0x1FFF 7000 - 0x1FFF 73FF   1 KB   OTP   - 0x1FFF 0000 - 0x1FFF 6FFF   28 KB   System memory   - 0x0802 0000 - 0x1FFE FFFF   ~384 MB   Reserved   - 0x0800 0000 - 0x0801 FFFF   128 KB   Main flash memory   Section 4.3.1 on page 56  FLASH or SRAM 0x0002 0000 - 0x07FF FFFF   ~128 MB   Reserved   - 0x0000 0000 - 0x001 FFFF   128 KB Main flash memory, system memory, or SRAM, depending on boot configuration -  Table 5. STM32C091xx boundary addresses Type   Boundary address   Size   Memory Area   Register description  SRAM   0x2000 9000 - 0x3FFF FFFF   ~512 MB   Reserved   - 0x2000 0000 - 0x2000 8FFF   36 KB   SRAM   - FLASH 0x1FFF 8000- 0x1FFF FFFF   32 KB   Reserved   - 0x1FFF 7800 - 0x1FFF 7FFF   2 KB   Option bytes   Section 4.4 on page 66  0x1FFF 7500 - 0x1FFF 77FF   768 B   Engineering bytes   - 0x1FFF 7400- 0x1FFF 74FF   256 B   Reserved   - 0x1FFF 7000 - 0x1FFF 73FF   1 KB   OTP   - 0x1FFF 4000 - 0x1FFF 6FFF   12 KB   Reserved   - 0x1FFF 0000 - 0x1FFF 3FFF   16 KB   System memory   - 0x0804 0000 - 0x1FFE FFFF   ~384 MB   Reserved   - 0x0800 0000 - 0x0803 FFFF   256 KB   Main flash memory   Section 4.3.1 on page 56  FLASH or SRAM 0x0004 0000 - 0x07FF FFFF   ~128 MB   Reserved   - 0x0000 0000 - 0x0003 FFFF   256 KB Main flash memory, system memory, or SRAM, depending on boot configuration -

RM0490 Rev 5   49/1027  RM0490  55  Table 6. STM32C092xx boundary addresses Type   Boundary address   Size   Memory Area   Register description  SRAM   0x2000 7800 - 0x3FFF FFFF   ~512 MB   Reserved   - 0x2000 0000 - 0x2000 77FF   30 KB   SRAM   - FLASH 0x1FFF 8000- 0x1FFF FFFF   32 KB   Reserved   - 0x1FFF 7800 - 0x1FFF 7FFF   2 KB   Option bytes   Section 4.4 on page 66  0x1FFF 7500 - 0x1FFF 77FF   768 B   Engineering bytes   - 0x1FFF 7400- 0x1FFF 74FF   256 B   Reserved   - 0x1FFF 7000 - 0x1FFF 73FF   1 KB   OTP   - 0x1FFF 4000 - 0x1FFF 6FFF   12 KB   Reserved   - 0x1FFF 0000 - 0x1FFF 3FFF   16 KB   System memory   - 0x0804 0000 - 0x1FFE FFFF   ~384 MB   Reserved   - 0x0800 0000 - 0x0803 FFFF   256 KB   Main flash memory   Section 4.3.1 on page 56  FLASH or SRAM 0x0004 0000 - 0x07FF FFFF   ~128 MB   Reserved   - 0x0000 0000 - 0x0003 FFFF   256 KB Main flash memory, system memory, or SRAM, depending on boot configuration -  Table 7. STM32C0 series peripheral register boundary addresses Bus   Boundary address   Size   Peripheral   Peripheral register map  -   0xE000 0000 - 0xE00F FFFF   1MB   Cortex   ® -M0+ internal peripherals   - IOPORT 0x5000 1800 - 0x5FFF 17FF   ~256 MB   Reserved   - 0x5000 1400 - 0x5000 17FF   1 KB   GPIOF   Section 8.5.12 on page 194  0x5000 1000 - 0x5000 13FF   1 KB   Reserved   - 0x5000 0C00 - 0x5000 0FFF   1 KB   GPIOD   Section 8.5.12 on page 194  0x5000 0800 - 0x5000 0BFF   1 KB   GPIOC   Section 8.5.12 on page 194  0x5000 0400 - 0x5000 07FF   1 KB   GPIOB   Section 8.5.12 on page 194  0x5000 0000 - 0x5000 03FF   1 KB   GPIOA   Section 8.5.12 on page 194

RM0490  50/1027   RM0490 Rev 5  AHB 0x4002 3400 - 0x4FFF FFFF   ~256 MB   Reserved   - 0x4002 3000 - 0x4002 33FF   1 KB   CRC   Section 15.4.6 on page 284  0x4002 2400 - 0x4002 2FFF   3 KB   Reserved   - 0x4002 2000 - 0x4002 23FF   1 KB   FLASH   Section 4.7.14 on page 90  0x4002 1C00 - 0x4002 1FFF   3 KB   Reserved   - 0x4002 1800 - 0x4002 1BFF   1 KB   EXTI   Section 14.5.16 on page 276  0x4002 1400 - 0x4002 17FF   1 KB   Reserved   - 0x4002 1000 - 0x4002 13FF   1 KB   RCC   Section 6.4.24 on page 163  0x4002 0C00 - 0x4002 0FFF   1 KB   Reserved   - 0x4002 0800 - 0x4002 0BFF   1 KB   DMAMUX   Section 12.6.7 on page 256  0x4002 0400 - 0x4002 07FF   1 KB   Reserved   - 0x4002 0000 - 0x4002 03FF   1 KB   DMA1   Section 11.6.7 on page 239  APB 0x4001 5C00 - 0x4001 FFFF   32 KB   Reserved   - 0x4001 5800 - 0x4001 5BFF   1 KB   DBG   Section 30.10.5 on page 1014  0x4001 4C00 - 0x4001 57FF   3 KB   Reserved   - 0x4001 4800 - 0x4001 4BFF   1 KB   TIM17   Section 20.6.21 on page 628  0x4001 4400 - 0x4001 47FF   1 KB   TIM16   Section 20.6.21 on page 628  0x4001 4000 - 0x4001 43FF   1 KB   TIM15   Section 20.6.21 on page 628  0x4001 3C00 - 0x4001 3FFF   1 KB   Reserved   - 0x4001 3800 - 0x4001 3BFF   1 KB   USART1   Section 26.8.15 on page 827  0x4001 3400 - 0x4001 37FF   1 KB   Reserved   - 0x4001 3000 - 0x4001 33FF   1 KB   SPI1   Section 27.9.10 on page 886  0x4001 2C00 - 0x4001 2FFF   1 KB   TIM1   Section 17.4.29 on page 440  0x4001 2800 - 0x4001 2BFF   1 KB   Reserved   - 0x4001 2400 - 0x4001 27FF   1 KB   ADC   Section 16.13 on page 342  0x4001 0400 - 0x4001 23FF   8 KB   Reserved   - 0x4001 0080 - 0x4001 03FF 1 KB SYSCFG(ITLINE) (1)   Section 9.1.34 on page 213  0x4001 001D - 0x4001 007F   Reserved   - 0x4001 0000 - 0x4001 001C   SYSCFG   Section 9.1.34 on page 213  0x4000 CC00- 0x4000 FFFF   19 KB   Reserved   - 0x4000 B800- 0x4000 CBFF   5 KB   FDCAN scratch RAM   - 0x4000 B400- 0x4000 B7FF   1 KB   FDCAN message RAM   - 0x4000 A000 - 0x4000 B3FF   5 KB   Reserved   - 0x4000 9800 - 0x4000 9FFF   2 KB   USBRAM   - 0x4000 8800 - 0x4000 97FF   4 KB   Reserved   - 0x4000 7400 - 0x4000 87FF   5 KB   Reserved   - 0x4000 7000 - 0x4000 73FF   1 KB   PWR   Section 5.4.19 on page 115  0x4000 6C00 - 0x4000 6FFF   1 KB   CRS   Section 7.7.5 on page 176  Table 7. STM32C0 series peripheral register boundary addresses (continued) Bus   Boundary address   Size   Peripheral   Peripheral register map

RM0490 Rev 5   51/1027  RM0490  55  2.3   Embedded SRAM  The following table summarizes the SRAM resources on the devices, with parity check enabled and disabled. . APB 0x4000 6800 - 0x4000 6BFF   1 KB   Reserved   - 0x4000 6400 - 0x4000 67FF   1 KB   FDCAN1   Section 28.4.38 on page 949  0x4000 6000 - 0x4000 63FF   1 KB   Reserved   - 0x4000 5C00 - 0x4000 5FFF   1 KB   USB   Section 29.6.8 on page 994  0x4000 5800 - 0x4000 5BFF   1 KB   I2C2   Section 25.9.12 on page 741  0x4000 5400 - 0x4000 57FF   1 KB   I2C1   Section 25.9.12 on page 741  0x4000 5000 - 0x4000 53FF   1 KB   Reserved   - 0x4000 4C00 - 0x4000 4FFF   1 KB   USART4   Section 26.8.15 on page 827  0x4000 4800 - 0x4000 4BFF   1 KB   USART3   Section 26.8.15 on page 827  0x4000 4400 - 0x4000 47FF   1 KB   USART2   Section 26.8.15 on page 827  0x4000 4000 - 0x4000 43FF   1 KB   Reserved   - 0x4000 3C00 - 0x4000 3FFF   1 KB   Reserved   - 0x4000 3800 - 0x4000 3BFF   1 KB   SPI2   Section 27.9.10 on page 886  0x4000 3400 - 0x4000 37FF   1 KB   Reserved   - 0x4000 3000 - 0x4000 33FF   1 KB   IWDG   Section 22.4.6 on page 639  0x4000 2C00 - 0x4000 2FFF   1 KB   WWDG   Section 23.5.4 on page 645  0x4000 2800 - 0x4000 2BFF   1 KB   RTC   Section 24.6.18 on page 675  0x4000 2400 - 0x4000 27FF   1 KB   Reserved   - 0x4000 2000 - 0x4000 23FF   1 KB   TIM14   Section 19.4.13 on page 541  0x4000 1800 - 0x4000 1FFF   2 KB   Reserved   - 0x4000 1400 - 0x4000 17FF   1 KB   Reserved   - 0x4000 1000 - 0x4000 13FF   1 KB   Reserved   - 0x4000 0C00 - 0x4000 0FFF   1 KB   Reserved   - 0x4000 0800 - 0x4000 0BFF   1 KB   Reserved   - 0x4000 0400 - 0x4000 07FF   1 KB   TIM3   Section 18.4.26 on page 514  0x4000 0000 - 0x4000 03FF   1 KB   TIM2   Section 18.4.26 on page 514  1.   SYSCFG (ITLINE) registers use 0x4001 0000 as reference peripheral base address.  Table 7. STM32C0 series peripheral register boundary addresses (continued) Bus   Boundary address   Size   Peripheral   Peripheral register map  Table 8. SRAM size Device   SRAM with parity (Kbyte)  STM32C011xx   6 STM32C031xx, STM32C051xx   12 STM32C071xx   24

RM0490  52/1027   RM0490 Rev 5  The SRAM can be accessed by bytes, half-words (16 bits) or full words (32 bits), at maximum system clock frequency without wait state and thus by both CPU and DMA.  Parity check  The user can enable the parity check using the option bit RAM_PARITY_CHECK in the user option byte (refer to   Section 4.4: FLASH option bytes ). The data bus width is 36 bits because 4 bits are available for parity check (1 bit per byte) in order to increase memory robustness, as required for instance by Class B or SIL norms. The parity bits are computed and stored when writing into the SRAM. Then, they are automatically checked when reading. If one bit fails, an NMI is generated.  Note:   When enabling the SRAM parity check, it is advised to initialize by software the whole SRAM at the beginning of the code, to avoid getting parity errors when reading non- initialized locations.  2.4   FDCAN RAM  FDCAN RAM is only present on the STM32C092xx devices. The FDCAN peripheral uses the first 1 KB of FDCAN RAM as a message RAM. The next 5 KB (FDCAN scratch RAM) can be accessed by the user. As the memory is accessible only from APB bus, it can only be accessed by words. See section   AHB-to-APB bridge (APB) .  Note:   Before accessing the FDCAN RAM, enable the FDCAN1 clock.  2.5   Flash memory overview  The flash memory is composed of two distinct physical areas:  •   The main flash memory block. It contains the application program and user data if necessary.  •   The information block. It is composed of three parts: –   Option bytes for hardware and memory protection user configuration. –   System memory which contains the proprietary boot loader code. –   OTP (one-time programmable) area  Refer to   Section 4: Embedded flash memory (FLASH)   for more details. The flash memory interface implements instruction access and data access based on the AHB protocol. It implements the prefetch buffer that speeds up CPU code execution. It also implements the logic necessary to carry out the flash memory operations (Program/Erase) controlled through the flash memory registers. STM32C092xx   30 STM32C091xx   36  Table 8. SRAM size (continued) Device   SRAM with parity (Kbyte)

RM0490 Rev 5   53/1027  RM0490   Boot modes  55  3   Boot modes 3.1   Boot configuration  The user can select the boot area through the boot configuration pin BOOT0 and bits nBOOT1, nBOOT_SEL, and nBOOT0 of the User option byte, as shown in the following table. The boot mode configuration is latched after a reset. It is up to the user to set boot mode configuration related to the required boot mode. The boot mode configuration is also re- sampled when exiting Standby mode. Consequently, they must be kept in the required boot mode configuration in Standby mode. After this startup delay has elapsed, the CPU fetches the top-of-stack value from the address 0x0000 0000, then starts executing code from the address stored in the boot memory at 0x0000 0004. Depending on the selected boot mode, main flash memory, system memory, or SRAM is accessible as follows:  •   Boot from main flash memory: the main flash memory is aliased in the boot memory space (0x0000 0000), but still accessible from its original memory space (0x0800 0000). In other words, the flash memory contents can be accessed starting from address 0x0000 0000 or 0x0800 0000.  •   Boot from system memory: the system memory is aliased in the boot memory space (0x0000 0000), but still accessible from its original memory space 0x1FFF0000.  •   Boot from the embedded SRAM: the SRAM is aliased in the boot memory space (0x0000 0000), but it is still accessible from its original memory space (0x2000 0000).  Caution:   BOOT0 pin shares the same GPIO with serial wire clock (SWCLK) that is used by the debugger to connect with the device, based on the fact that these functionalities can be considered almost completely disjoint. Nevertheless, to ensure system robustness, the STM32C0 series devices provide a hardware mechanism to force BOOT0 low (boot from user flash memory) if a debugger access is detected (and BOOT0 information is taken from the pin), in order to use SWCLK clock for debugger serial communications and at the same  Table 9. Boot modes Boot mode configuration Selected boot area BOOT_ LOCK   nBOOT1 bit   BOOT0 pin   nBOOT_SEL bit   nBOOT0 bit  0   x   0   0   x   Main flash memory   (1) 1.   Boot forced to system memory when EMPTY flag in the FLASH access control register (FLASH_ACR) is set. See   Section 3.1.4: Empty check . 0   1   1   0   x   System memory 0   0   1   0   x   Embedded SRAM 0   x   x   1   1   Main flash memory   (1) 0   1   x   1   0   System memory 0   0   x   1   0   Embedded SRAM 1   x   x   x   x   Main flash memory

Boot modes   RM0490  54/1027   RM0490 Rev 5  time have a safe boot configuration for the device itself. This configuration is kept until the earliest power-on following the debugger access.  Caution:   BOOT0 pin sampling is done on NRST (external reset) rising edge. Refer to NRST (external reset) description in   Section 6.1.2: System reset   for further details on how the PF2-NRST pin mode impacts the BOOT0 sampling.  3.1.1   Physical remap  Once the boot mode is selected, the application software can modify the memory accessible in the code area. This modification is performed by programming the MEM_MODE bits in the   SYSCFG configuration register 1 (SYSCFG_CFGR1) .  3.1.2   Embedded boot loader  The embedded bootloader is located in the system memory, programmed by ST during production. It is used to reprogram the flash memory using one of the following serial interfaces:  •   USART  •   I2C  •   SPI (only on STM32C051xx, STM32C071xx, and STM32C091xx/92xx devices)  •   USB DFU (only on STM32C071xx)  •   FDCAN (only on STM32C092xx devices) For further details, refer to the device data sheets and the application note AN2606.  Note:   Some of the GPIOs are reconfigured from their high-Z state. On STM32C092xx, the FDCAN_BL_CK[1:0] bitfield of the FLASH_OPTR register allows selecting FDCAN clock source.  3.1.3   Forcing boot from main flash memory  Setting the BOOT_LOCK bit forces the boot from a unique entry point in the main flash memory, regardless of the boot mode configuration pin, bits, and the EMPTY flag. See  Section 4.5.6: Forcing boot from main flash memory .  3.1.4   Empty check  Internal empty check flag (the EMPTY bit of the FLASH access control register FLASH_ACR) is implemented to allow easy programming of virgin devices by the boot loader. This flag is checked when the boot configuration defines the main flash memory as the target boot area and the BOOT_LOCK bit is not set. When the EMPTY flag is set, the device is considered empty and the system memory (bootloader) is selected instead of the main flash memory as a boot area, to allow the user to program the device. Refer to AN2606 for more details concerning the bootloader and GPIO configuration in the system memory boot mode (some of the GPIOs are reconfigured from the High-Z state). The EMPTY flag is updated by hardware only during the loading of option bytes: it is set when the 64-bit content of the address 0x0800 0000 is read as 0xFFFF FFFF FFFF FFFF, otherwise it is cleared. It means that, after programming of a virgin device, a power-on reset or setting of the OBL_LAUNCH bit of the FLASH_CR register is required to clear the EMPTY flag (the system reset has no impact on this flag). The software can also modify the EMPTY flag directly in the FLASH_ACR register.

RM0490 Rev 5   55/1027  RM0490   Boot modes  55  Note:   If the device is programmed for the first time but the EMPTY flag is not updated, the device still selects system memory as a boot area after a system reset.

Embedded flash memory (FLASH)   RM0490  56/1027   RM0490 Rev 5  4   Embedded flash memory (FLASH) 4.1   FLASH Introduction  The flash memory interface manages CPU (Cortex   ® -M0+) AHB accesses to the flash memory. It implements erase and program flash memory operations, read and write protection, and security mechanisms. The flash memory interface accelerates code execution with a system of instruction prefetch and cache lines.  4.2   FLASH main features  •   up to 256 Kbytes of flash memory (main memory) –   up to 32 Kbytes for STM32C011xx and STM32C031xx –   up to 64 Kbytes for STM32C051xx –   up to 128 Kbytes for STM32C071xx –   up to 256 Kbytes for STM32C091xx and STM32C092xx  •   Memory organization: –   One bank –   Page size: 2 Kbytes –   Subpage size: 512 bytes  •   64-bit wide data read (no ECC)  •   Page erase (2 Kbytes) and mass erase Flash memory interface features:  •   Flash memory read operations  •   Flash memory program/erase operations  •   Read protection activated by option (RDP)  •   Two write protection areas, selected by option (WRP)  •   Two proprietary code read protection areas, selected by option (PCROP)  •   Securable memory area  •   Flash memory empty check  •   Prefetch buffer  •   CPU instruction cache: two cache lines of 64 bits (16-byte RAM)  •   Option byte loader  4.3   FLASH functional description 4.3.1   Flash memory organization  The flash memory is organized as 64-bit-wide memory cells that can be used for storing both code and data constants.

RM0490 Rev 5   57/1027  RM0490   Embedded flash memory (FLASH)  91  The flash memory is organized as follows:  •   Main flash memory block containing up to 128 pages of 2 Kbytes, each page with 8 rows of 256 bytes  •   Information block containing: –   System memory from which the CPU boots in system memory boot mode. The area is reserved and contains the boot loader used to reprogram the flash memory through one of the interfaces listed in   Section 3.1.2: Embedded boot loader . On the manufacturing line, the devices are programmed and protected against spurious write/erase operations. For further details, refer to the AN2606 available from   www.st.com . –   1 Kbyte (128 double words) OTP (one-time programmable) for user data. The OTP data cannot be erased and can be written only once. If only one bit is at 0, the entire double word (64 bits) cannot be written anymore, even with the value 0x0000 0000 0000 0000. –   Option bytes for user configuration. The following table shows the mapping of the flash memory into information block and main memory area.  Table 10. Flash memory organization for STM32C011xx and STM32C031xx Area   Addresses   Size (bytes)   Memory type  Information block 0x1FFF 7800 - 0x1FFF 7FFF 2 K (only first 128 bytes used) Option bytes 0x1FFF 7500 - 0x1FFF 77FF   768   Engineering bytes 0x1FFF 7000 - 0x1FFF 73FF   1 K   OTP 0x1FFF 0000 - 0x1FFF 17FF   6 K   System memory Main flash memory 0x0800 7800 - 0x0800 7FFF   2 K   Page 15 ...   ...   ... 0x0800 1000 - 0x0800 17FF   2 K   Page 2 0x0800 0800 - 0x0800 0FFF   2 K   Page 1 0x0800 0000 - 0x0800 07FF   2 K   Page 0  Table 11. Flash memory organization for STM32C051xx Area   Addresses   Size (bytes)   Memory type  Information block 0x1FFF 7800 - 0x1FFF 7FFF   2 K   Option bytes 0x1FFF 7500 - 0x1FFF 77FF   768   Engineering bytes 0x1FFF 7000 - 0x1FFF 73FF   1 K   OTP 0x1FFF 0000 - 0x1FFF 2FFF   12 K   System memory

Embedded flash memory (FLASH)   RM0490  58/1027   RM0490 Rev 5  Main flash memory 0x0800 F800 - 0x0800 FFFF   2 K   Page 31 ...   ...   ... 0x0800 1000 - 0x0800 17FF   2 K   Page 2 0x0800 0800 - 0x0800 0FFF   2 K   Page 1 0x0800 0000 - 0x0800 07FF   2 K   Page 0  Table 12. Flash memory organization for STM32C071xx Area   Addresses   Size (bytes)   Memory type  Information block 0x1FFF 7800 - 0x1FFF 7FFF   2 K   Option bytes 0x1FFF 7500 - 0x1FFF 77FF   768   Engineering bytes 0x1FFF 7000 - 0x1FFF 73FF   1 K   OTP 0x1FFF 0000 - 0x1FFF 6FFF   28 K   System memory Main flash memory 0x0801 F800 - 0x0801 FFFF   2 K   Page 63 ...   ...   ... 0x0800 1000 - 0x0800 17FF   2 K   Page 2 0x0800 0800 - 0x0800 0FFF   2 K   Page 1 0x0800 0000 - 0x0800 07FF   2 K   Page 0  Table 13. Flash memory organization for STM32C091xx/92xx Area   Addresses   Size (bytes)   Memory type  Information block 0x1FFF 7800 - 0x1FFF 7FFF   2 K   Option bytes 0x1FFF 7500 - 0x1FFF 77FF   768   Engineering bytes 0x1FFF 7000 - 0x1FFF 73FF   1 K   OTP 0x1FFF 0000 - 0x1FFF 3FFF   16 K   System memory Main flash memory 0x0803 F800 - 0x0803 FFFF   2 K   Page 127 ...   ...   ... 0x0800 1000 - 0x0800 17FF   2 K   Page 2 0x0800 0800 - 0x0800 0FFF   2 K   Page 1 0x0800 0000 - 0x0800 07FF   2 K   Page 0  Table 11. Flash memory organization for STM32C051xx (continued) Area   Addresses   Size (bytes)   Memory type

RM0490 Rev 5   59/1027  RM0490   Embedded flash memory (FLASH)  91  4.3.2   FLASH read access latency  To correctly read data from the flash memory, set the LATENCY[2:0] bitfield of the   FLASH access control register (FLASH_ACR)   register as per the following table. Upon power-on reset or upon wake-up from Standby, the HCLK clock frequency is automatically set to 12 MHz and the LATENCY[2:0] bitfield to 000. See   Section 6.2: Clocks . To change HCLK frequency, respect the following sequence:  Increasing HCLK frequency  1.   Set the LATENCY[2:0] bitfield to correspond to the target HCLK frequency, as per  Table 14 . 2.   Read the LATENCY[2:0] bitfield until it returns the value written in the previous step. 3.   Select the system clock source as required, through the SW[2:0] bitfield of the RCC_CFGR register. 4.   Set the HCLK clock prescaler as required, through the HPRE[3:0] bitfield of the RCC_CFGR register. The clock source effectively selected for the system can be checked by reading the clock source status bitfield SWS[2:0] of the RCC_CFGR register. The HPRE[3:0] bitfield of the RCC_CFGR register can also be read to check its content.  Decreasing HCLK frequency  1.   Select the system clock source as required, through the SW[2:0] bitfield of the RCC_CFGR register. 2.   Set the HCLK clock prescaler as required, through the HPRE[3:0] bitfield of the RCC_CFGR register. 3.   Read the SWS[2:0] bitfield of the RCC_CFGR register until it returns the value set into SW[2:0] in step 1. The HPRE[3:0] bitfield of the RCC_CFGR register can also be read to check its content. 4.   Set the LATENCY[2:0] bitfield to correspond to the target HCLK frequency, as per  Table 14 .  4.3.3   Flash memory acceleration Instruction prefetch  Each flash memory read operation provides 64 bits from either two instructions of 32 bits or four instructions of 16 bits according to the program launched. This 64-bits current instruction line is saved in a current buffer. So, in case of sequential code, at least two CPU cycles are needed to execute the previous read instruction line. Prefetch on the CPU S-bus can be used to read the next sequential instruction line from the flash memory while the current instruction line is being requested by the CPU.  Table 14. LATENCY[2:0] setting as function of HCLK frequency HCLK (MHz)   LATENCY[2:0]  ≤   24   000 (1 HCLK cycle)  ≤   48   001 (2 HCLK cycles)

Embedded flash memory (FLASH)   RM0490  60/1027   RM0490 Rev 5  Prefetch is enabled by setting the PRFTEN bit of the   FLASH access control register (FLASH_ACR) . This feature is useful if at least one wait state is needed to access the flash memory. When the code is not sequential (branch), the instruction may not be present in the currently used instruction line or in the prefetched instruction line. In this case (miss), the penalty in terms of number of cycles is at least equal to the number of wait states. If a loop is present in the current buffer, no new access is performed.  Cache memory  To limit the time lost due to jumps, it is possible to retain two cache lines of 64 bits (16 bytes) in the instruction cache memory. This feature can be enabled by setting the instruction cache enable (ICEN) bit of the   FLASH access control register (FLASH_ACR) . Each time a miss occurs (requested data not present in the currently used instruction line, in the prefetched instruction line or in the instruction cache memory), the line read is copied into the instruction cache memory. If some data contained in the instruction cache memory are requested by the CPU, they are provided without inserting any delay. Once all the instruction cache memory lines are filled, the LRU (least recently used) policy is used to determine the line to replace in the instruction memory cache. This feature is particularly useful in case of code containing loops. The Instruction cache memory is enabled after system reset. No data cache is available on Cortex   ® -M0+.  4.3.4   FLASH program and erase operations  The device-embedded flash memory can be programmed using in-circuit programming or in-application programming. The   in-circuit programming (ICP)   method is used to update the entire contents of the flash memory, using SWD protocol or the supported interfaces by the system boot loader, to load the user application for the CPU, into the microcontroller. ICP offers quick and efficient design iterations and eliminates unnecessary package handling or socketing of devices. In contrast to the ICP method,   in-application programming (IAP)   can use any communication interface supported by the microcontroller (I/Os, UART, I 2   C, SPI, etc.) to download programming data into memory. IAP allows the user to re-program the flash memory while the application is running. Nevertheless, part of the application has to have been previously programmed in the flash memory using ICP. The success of a data word programming operation and a page/bank erase operation is not guaranteed if aborted due to device reset or power loss. During a program/erase operation to the flash memory, any attempt to read the flash memory stalls the bus. The read operation proceeds correctly once the program/erase operation has completed.  Unlocking the flash memory  After reset, write into the   FLASH control register (FLASH_CR)   is not allowed so as to protect the flash memory against possible unwanted operations due, for example, to electric disturbances. The following sequence unlocks these registers: 1.   Write KEY1 = 0x4567 0123 in the   FLASH key register (FLASH_KEYR)  2.   Write KEY2 = 0xCDEF 89AB in the   FLASH key register (FLASH_KEYR) .

RM0490 Rev 5   61/1027  RM0490   Embedded flash memory (FLASH)  91  Any wrong sequence locks the FLASH_CR registers until the next system reset. In the case of a wrong key sequence, a bus error is detected and a Hard Fault interrupt is generated. The FLASH_CR registers can be locked again by software by setting the LOCK bit in one of these registers.  Note:   The FLASH_CR register cannot be written when the BSY1 bit of the FLASH status register (FLASH_SR) is set. Any attempt to write to this register with the BSY1 bit set causes the AHB bus to stall until the BSY1 bit is cleared.  4.3.5   FLASH main memory erase sequences  The flash memory erase operation can be performed at page level (page erase), or on the whole memory (mass erase). Mass erase does not affect the information block (system flash memory, OTP and option bytes).  Flash memory page erase  When a page is protected by PCROP or WRP, it is not erased and the WRPERR bit is set. To erase a page (2 Kbytes), follow the procedure below: 1.   Check that no flash memory operation is ongoing by checking the BSY1 bit of the  FLASH status register (FLASH_SR) . 2.   Check and clear all error programming flags due to a previous programming. If not, PGSERR is set. 3.   Check that the CFGBSY bit of the   FLASH status register (FLASH_SR)   is cleared. 4.   Set the PER bit and select the page to erase (PNB) in the   FLASH control register (FLASH_CR) . 5.   Set the STRT bit of the   FLASH control register (FLASH_CR) . 6.   Wait until the CFGBSY bit of the   FLASH status register (FLASH_SR)   is cleared.  Note:   The HSI48 internal oscillator (with a divide by three to provide 16 MHz) is automatically enabled when the STRT bit is set. It is automatically disabled when the STRT bit is cleared, except if previously enabled with the HSION bit of the RCC_CR register.  Flash memory bank or mass erase  When PCROP or WRP is enabled, the flash memory mass erase is aborted, no erase starts, and the WRPERR bit is set.  Table 15. Page erase overview SEC_PROT   PCROP   WRP   PCROP_RDP   Comment   WRPERR   CPU bus error  0 No   No x Page is erased   No No No   Yes Page erase aborted  (no page erase started)   Yes Yes   No Yes   Yes 1   x   Protected pages only   No   Yes

Embedded flash memory (FLASH)   RM0490  62/1027   RM0490 Rev 5  To perform a mass erase, respect the following procedure: 1.   Check that no flash memory operation is ongoing by checking the BSY1 bit of the  FLASH status register (FLASH_SR) . 2.   Check and clear all error programming flags due to a previous programming. If not, PGSERR is set. 3.   Check that the CFGBSY bit of the   FLASH status register (FLASH_SR)   is cleared. 4.   Set the MER1 bit of the   FLASH control register (FLASH_CR) . 5.   Set the STRT bit of the   FLASH control register (FLASH_CR) . 6.   Wait until the CFGBSY bit of the   FLASH status register (FLASH_SR)   is cleared.  Note:   The HSI48 internal oscillator (with a divide by three to provide 16 MHz) is automatically enabled when the STRT bit is set. It is automatically disabled when the STRT bit is cleared, except if previously enabled with the HSION bit of the RCC_CR register.  4.3.6   FLASH main memory programming sequences  The flash memory is programmed 64 bits at a time. Programming a previously programmed address with a non-zero data is not allowed. Any such attempt sets PROGERR flag of the   FLASH status register (FLASH_SR).  It is only possible to program a double word (2 x 32-bit data).  •   Any attempt to write byte (8 bits) or half-word (16 bits) sets SIZERR flag of the   FLASH status register (FLASH_SR).  •   Any attempt to write a double word that is not aligned with a double word address sets PGAERR flag of the   FLASH status register (FLASH_SR).  Standard programming  The flash memory programming sequence in standard mode is as follows:  Table 16. Mass erase overview SEC_PROT   PCROP   WRP   PCROP_RDP   Comment   WRPERR   CPU bus error  0 No   No x Memory is erased   No No No   Yes Erase aborted (no erase started)   Yes Yes   No Yes   Yes 1   x   Erase aborted (no erase started)   No   Yes

RM0490 Rev 5   63/1027  RM0490   Embedded flash memory (FLASH)  91  1.   Check that no main flash memory operation is ongoing by checking the BSY1 bit of the  FLASH status register (FLASH_SR) .. 2.   Check and clear all error programming flags due to a previous programming. If not, PGSERR is set. 3.   Check that the CFGBSY bit of the   FLASH status register (FLASH_SR)   is cleared. 4.   Set the PG bit of the   FLASH control register (FLASH_CR) . 5.   Perform the data write operation at the desired memory address, inside main flash memory block or OTP area. Only double word (64 bits) can be programmed. a)   Write a first word in an address aligned with double word b)   Write the second word. 6.   Wait until the CFGBSY bit of the   FLASH status register (FLASH_SR)   is cleared. 7.   Check that the EOP flag in the   FLASH status register (FLASH_SR)   is set (programming operation succeeded), and clear it by software. 8.   Clear the PG bit of the   FLASH control register (FLASH_CR)   if there no more programming request anymore.  Note:   When the flash memory interface has received a good sequence (a double word), programming is automatically launched and the BSY1 bit set.  The HSI48 internal oscillator (with a divide by three to provide 16 MHz) is automatically enabled when the PG bit is set. It is automatically disabled when the PG bit is cleared, except if previously enabled with the HSION bit of the RCC_CR register.  Fast programming  The main purpose of this mode is to reduce the page programming time. It is achieved by eliminating the need for verifying the flash memory locations before they are programmed, thus saving the time of high voltage ramping and falling for each double word. This mode allows programming a row (32 double words = 256 bytes). During fast programming, the flash memory clock (HCLK) frequency must be at least 8 MHz. Only the main flash memory can be programmed in Fast programming mode. The main flash memory programming sequence in fast mode is described below: 1.   Perform a mass or page erase. If not, PGSERR is set. 2.   Check that no main flash memory operation is ongoing by checking the BSY1 bit of the  FLASH status register (FLASH_SR) .. 3.   Check and clear all error programming flag due to a previous programming. 4.   Check that the CFGBSY bit of the   FLASH status register (FLASH_SR)   is cleared. 5.   Set the FSTPG bit in   FLASH control register (FLASH_CR) . 6.   Write 32 double-words to program a row (256 bytes). 7.   Wait until the CFGBSY bit of the   FLASH status register (FLASH_SR)   is cleared. 8.   Check that the EOP flag in the   FLASH status register (FLASH_SR)   is set (programming operation succeeded), and clear it by software. 9.   Clear the FSTPG bit of the   FLASH status register (FLASH_SR)   if there are no more programming requests anymore.

Embedded flash memory (FLASH)   RM0490  64/1027   RM0490 Rev 5  Note:   When attempting to write in Fast programming mode while a read operation is ongoing, the programming is aborted without any system notification (no error flag is set). When the flash memory interface has received the first double word, programming is automatically launched. The BSY1 bit is set when the high voltage is applied for the first double word, and it is cleared when the last double word has been programmed or in case of error.  The HSI48 internal oscillator (with a divide by three to provide 16 MHz) is automatically enabled when the FSTPG bit is set. It is automatically disabled when the FSTPG bit is cleared, except if previously enabled with the HSION bit of the RCC_CR register. The 32 double words must be written successively. The high voltage is kept on the flash memory for all the programming. Maximum time between two double words write requests is the time programming (around 20 μs). If a second double word arrives after this time programming, fast programming is interrupted and MISSERR is set. High voltage must not exceed 8 ms for a full row between two erases. This is guaranteed by the sequence of 32 double words successively written with a clock system greater or equal to 8 MHz. An internal time-out counter counts 7 ms when Fast programming is set and stops the programming when time-out is over. In this case the FASTERR bit is set. If an error occurs, high voltage is stopped and next double word to programmed is not programmed. Anyway, all previous double words have been properly programmed.  Programming errors  Several kind of errors can be detected. In case of error, the flash memory operation (programming or erasing) is aborted.  •   PROGERR : Programming error In standard programming: PROGERR is set if the word to write is not previously erased (except if the value to program is full zero and the target address is in the main flash memory).  •   SIZERR : Size programming error In standard programming or in fast programming: only double word can be programmed, and only 32-bit data can be written. SIZERR is set if a byte or an  half-word is written.  •   PGAERR : Alignment programming error PGAERR is set if one of the following conditions occurs: –   In standard programming: the first word to be programmed is not aligned with a double word address, or the second word doesn’t belong to the same double word address. –   In fast programming: the data to program doesn’t belong to the same row than the previous programmed double words, or the address to program is not greater than the previous one.  •   PGSERR : Programming sequence error PGSERR is set if one of the following conditions occurs: –   In the standard programming sequence or the fast programming sequence: a data is written when PG and FSTPG are cleared. –   In the standard programming sequence or the fast programming sequence: MER1 and PER are not cleared when PG or FSTPG is set. –   In the fast programming sequence: the Mass erase is not performed before setting the FSTPG bit.

RM0490 Rev 5   65/1027  RM0490   Embedded flash memory (FLASH)  91  –   In the mass erase sequence: PG, FSTPG, and PER are not cleared when MER1 is set. –   In the page erase sequence: PG, FSTPG and MER1 are not cleared when PER is set. –   PGSERR is set also if PROGERR, SIZERR, PGAERR, WRPERR, MISSERR, FASTERR or PGSERR is set due to a previous programming error.  •   WRPERR : Write protection error WRPERR is set if one of the following conditions occurs: –   Attempt to program or erase in a write protected area (WRP) or in a PCROP area. –   Attempt to perform a mass erase when one page or more is protected by WRP or PCROP. –   The debug features are connected or the boot is executed from SRAM or from system flash memory when the read protection (RDP) is set to level 1. –   Attempt to modify the option bytes when the read protection (RDP) is set to  level 2.  •   MISSERR : Fast programming data miss error In fast programming: all the data must be written successively. MISSERR is set if the previous data programmation is finished and the next data to program is not written yet.  •   FASTERR : Fast programming error In fast programming: FASTERR is set if one of the following conditions occurs: –   when FSTPG bit is set for more than 8 ms, which generates a time-out detection –   when the row fast programming has been interrupted by a MISSERR, PGAERR, WRPERR or SIZERR If an error occurs during a program or erase operation, one of the following error flags of the  FLASH status register (FLASH_SR)   is set:  •   PROGERR, SIZERR, PGAERR, PGSERR, MISSERR (program error flags)  •   WRPERR (protection error flag) In this case, if the error interrupt enable bit ERRIE of the   FLASH control register (FLASH_CR)   is set, an interrupt is generated and the operation error flag OPERR of the  FLASH status register (FLASH_SR)   is set.  Note:   If several successive errors are detected (for example, in case of DMA transfer to the flash memory), the error flags cannot be cleared until the end of the successive write request.  Programming and cache  If an erase operation in flash memory also concerns data in the instruction cache, the user has to ensure that these data are rewritten before they are accessed during code execution.  Note:   The cache should be flushed only when it is disabled (ICEN = 0).

Embedded flash memory (FLASH)   RM0490  66/1027   RM0490 Rev 5  4.4   FLASH option bytes 4.4.1   FLASH option byte description  The option bytes are configured by the end user depending on the application requirements. As a configuration example, the watchdog may be selected in hardware or software mode (refer to   Section 4.4.2: FLASH option byte programming ). A double word is split up in option bytes as indicated in   Table 17 .  Table 18   shows the organization of the option bytes (the lower word only) in the flash memory information block. The software can read the option bytes from these flash memory locations or from their corresponding option registers referenced in the table. Refer to sections   4.7.6   to   4.7.13   for the description of the option register bitfields, also applicable to the option byte bitfields.  Table 17. Option byte format 63-56   55-48   47-40   39-32   31-24   23-16   15 -8   7-0  Complemented option byte 3 Complemented option byte 2 Complemented option byte 1 Complemented option byte 0 Option byte 3 Option byte 2 Option byte 1 Option byte 0  Table 18. Organization of option bytes Address (1)  Corresponding option register (section) 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0 Option byte 3   Option byte 2   Option byte 1   Option byte 0  0x1FFF7800 FLASH_OPTR  (4.7.6)  FDCAN_BL_CK[1:0] IRHEN NRST_MODE[1:0] NBOOT0 NBOOT1 NBOOT_SEL SECURE_MUXING_EN RAM_PARITY_CHECK HSE_NOT_REMAPPED   (2) Reserved WWDG_SW IWDG_STBY IWDG_STOP IWDG_SW NRST_SHDW NRST_STDBY NRST_STOP BORF_LEV BORR_LEV BOR_EN RDP Factory value   0   0   1   1   1   1   1   1   1   1   1   X   1   1   1   1   1   1   1   1   1   1   1   0   1   0   1   0   1   0   1   0 0x1FFF7808 FLASH_PCROP1ASR  (4.7.7)   Reserved   PCROP1A_STRT Factory value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   1   1   1   1   1   1   1   1   1 0x1FFF7810 FLASH_PCROP1AER  (4.7.8)  PCROP_RDP Reserved   PCROP1A_END Factory value   0   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   0   0   0   0   0   0   0   0   0 0x1FFF7818 FLASH_WRP1AR  (4.7.9)   Reserved   WRP1A_END   Reserved   WRP1A_STRT Factory value   X   X   X   X   X   X   X   X   X   0   0   0   0   0   0   0   X   X   X   X   X   X   X   X   X   1   1   1   1   1   1   1 0x1FFF7820 FLASH_WRP1BR  (4.7.10)   Reserved   WRP1B_END   Reserved   WRP1B_STRT Factory value   X   X   X   X   X   X   X   X   X   0   0   0   0   0   0   0   X   X   X   X   X   X   X   X   X   1   1   1   1   1   1   1 0x1FFF7828 FLASH_PCROP1BSR  (4.7.11)   Reserved   PCROP1B_STRT Factory value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   1   1   1   1   1   1   1   1   1

RM0490 Rev 5   67/1027  RM0490   Embedded flash memory (FLASH)  91  4.4.2   FLASH option byte programming  After reset, the option related bits of the   FLASH control register (FLASH_CR)   are write- protected. To run any operation on the option byte page, the option lock bit OPTLOCK of the  FLASH control register (FLASH_CR)   must be cleared. The following sequence is used to unlock this register: 1.   Unlock the FLASH_CR with the LOCK clearing sequence (refer to   Unlocking the flash memory ) 2.   Write OPTKEY1 = 0x0819 2A3B of the   FLASH option key register (FLASH_OPTKEYR)  3.   Write OPTKEY2 = 0x4C5D 6E7F of the   FLASH option key register (FLASH_OPTKEYR)  Any wrong sequence locks up the flash memory option registers until the next system reset. In the case of a wrong key sequence, a bus error is detected and a Hard Fault interrupt is generated. The user options can be protected against unwanted erase/program operations by setting the OPTLOCK bit by software.  Note:   If LOCK is set by software, OPTLOCK is automatically set as well.  Modifying user options  The option bytes are programmed differently from a main flash memory user address. To modify the value of user options, follow the procedure below: 1.   Clear OPTLOCK option lock bit with the clearing sequence described above 2.   Write the desired values in the FLASH option registers. 3.   Check that no flash memory operation is ongoing, by checking the BSY1 bit of the  FLASH status register (FLASH_SR) . 4.   Set the Options Start bit OPTSTRT of the   FLASH control register (FLASH_CR) . 5.   Wait for the BSY1 bit to be cleared. 0x1FFF7830 FLASH_ PCROP1BER  (4.7.12)   Reserved   PCROP1B_END Factory value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   0   0   0   0   0   0   0   0   0 0x1FFF7870 FLASH_SECR  (4.7.13)   Reserved BOOT_LOCK Reserved   SEC_SIZE Factory value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   0   X   X   X   X   X   X   X   X   X   0   0   0   0   0   0   0 1.   The upper 32 bits of the double-word address contain the inverted data from the lower 32 bits. 2.   Only relevant to products in packages with 48 to 64 pins.  Table 18. Organization of option bytes (continued) Address (1)  Corresponding option register (section) 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0 Option byte 3   Option byte 2   Option byte 1   Option byte 0

Embedded flash memory (FLASH)   RM0490  68/1027   RM0490 Rev 5  Note:   Any modification of the value of one option is automatically performed by erasing user option byte pages first, and then programming all the option bytes with the values contained in the flash memory option registers. The complementary values are automatically computed and written into the complemented option bytes upon setting the OPTSTRT bit.  Caution:   Upon an option byte programming failure (for any reason, such as loss of power or a reset during the option byte change sequence), the mismatch values of the option bytes are loaded after reset. Those mismatch values force a secure configuration that might block the code execution. To prevent this, only program option bytes in a safe environment – safe supply, no pending watchdog, and clean reset line.  Option byte loading  After the BSY1 bit is cleared, all new options are updated into the flash memory, but not applied to the system. A read from the option registers still returns the last loaded option byte values, the new options has effect on the system only after they are loaded. Option byte loading is performed in two cases: –   when OBL_LAUNCH bit of the   FLASH control register (FLASH_CR)   is set –   after a power reset (BOR reset or exit from Standby/Shutdown modes) Option byte loader performs a read of the options block and stores the data into internal option registers. These internal registers configure the system and can be read by software. Setting OBL_LAUNCH generates a reset so the option byte loading is performed under system reset. Each option bit has also its complement in the same double word. During option loading, a verification of the option bit and its complement allows to check the loading has correctly taken place. During option byte loading, the options are read by double word. If the word and its complement are matching, the option word/byte is copied into the option register. If the comparison between the word and its complement fails, a status bit OPTVERR is set. Mismatch values are forced into the option registers: –   For USR OPT option, the value of mismatch is 1 for all option bits, except the BOR_EN bit that is 0 (BOR disabled). –   For WRP option, the value of mismatch is the default value “No protection”. –   For RDP option, the value of mismatch is the default value “level 1”. –   For PCROP, the value of mismatch is “all memory protected”. –   For BOOT_LOCK, the value of mismatch is “boot forced from main flash memory”.  Note:   In this situation (mismatch of option bytes), setting both BOOT_LOCK and RDP level 1 does not disable the debug capabilities, to allow the part reprogramming.

RM0490 Rev 5   69/1027  RM0490   Embedded flash memory (FLASH)  91  Upon system reset, the option bytes are copied into the following option registers that can be read and written by software:  •   FLASH_OPTR  •   FLASH_PCROP1xSR (x = A or B)  •   FLASH_PCROP1xER (x = A or B)  •   FLASH_WRP1xR (x = A or B)  •   FLASH_SECR These registers are also used to modify options. If these registers are not modified by user, they reflect the options states of the system. See   Modifying user options   for more details.  4.5   Flash memory protection  The main flash memory can be protected against external accesses with the read protection (RDP). The pages can also be protected against unwanted write (WRP) due to loss of program counter context. The write-protection WRP granularity is 2 Kbytes. Apart from the RDP and WRP, the flash memory can also be protected against read and write by third party (PCROP). The PCROP granularity (subpage size) is 512 bytes.  4.5.1   FLASH read protection (RDP)  The read protection is activated by setting the RDP option byte and then, by applying a system reset to reload the new RDP option byte. The read protection protects the main flash memory, the option bytes. There are three levels of read protection from no protection (level 0) to maximum protection or no debug (level 2). The flash memory is protected when the RDP option byte and its complement contain the pair of values shown in   Table 19 . The system memory area is read-accessible whatever the protection level. It is never accessible for program/erase operation.  Level 0: no protection  Read, program and erase operations within the main flash memory area are possible. The option bytes are also accessible by all operations.  Table 19. Flash memory read protection status RDP byte value   RDP complement byte value   Read protection level  0xAA   0x55   Level 0 Any values except the combinations [0xAA, 0x55] and [0xCC, 0x33]   Level 1 (default) 0xCC   0x33   Level 2

Embedded flash memory (FLASH)   RM0490  70/1027   RM0490 Rev 5  Level 1: Read protection  Level 1 read protection is set when the RDP byte and the RDP complemented byte contain any value combinations other than [0xAA, 0x55] and [0xCC, 0x33]. Level 1 is the default protection level when RDP option byte is erased.  •   User mode:   Code executing in user mode (boot from user flash memory) can access main flash memory and option bytes with all operations.  •   Debug, boot from SRAM, and boot from system memory modes:   In debug mode or when code boots from SRAM or system memory, the main flash memory is totally inaccessible. In these modes, a read or write access to the flash memory generates a bus error and a Hard Fault interrupt.  Caution:   In level 1 with a PCROP area defined, user code to protect by RDP but not by PCROP must be placed outside pages containing a PCROP-protected subpage.  Level 2: No debug  In this level, the protection level 1 is guaranteed. In addition, the CPU debug port, the boot from RAM (boot RAM mode) and the boot from system memory (boot loader mode) are no more available. In user execution mode (boot FLASH mode), all operations are allowed on the main flash memory.  Note:   The CPU debug port is also disabled under reset. Note:   STMicroelectronics is not able to perform analysis on defective parts on which the level 2 protection has been set.  Changing the read protection level  The read protection level can change:  •   from level 0 to level 1, upon changing the value of the RDP byte to any value except 0xCC  •   from level 0 or level 1 to level 2, upon changing the value of the RDP byte to 0xCC  •   from level 1 to level 0, upon changing the value of the RDP byte to 0xAA Once in level 2, it is no more possible to modify the read protection level. When the read protection is changed from level 0 during or after (since last power on) the debugger is connected or the MCU boot from system memory / SRAM, to reload the option byte, apply a POR (power-on reset) instead of a system reset / OBL_LAUNCH. Otherwise, the internal read out protection is activated and any data read triggers a hard fault. If the read protection is programmed through the software, the POR can be done by a transition to Standby (or Shutdown) mode followed by a wake-up. With the PCROP_RDP bit of the   FLASH PCROP area A end address register (FLASH_PCROP1AER)   set, the change from level 1 to level 0 triggers full mass erase of the main flash memory. The user options except PCROP protection are set to their previous values copied from FLASH_OPTR and FLASH_WRP1xR (x = A or B). PCROP is disabled. The OTP area is not affected by mass erase and remains unchanged. With the PCROP_RDP bit cleared, a partial mass erase occurs, only erasing flash memory pages that do not overlap with PCROP area (do not contain any PCROP-protected subpage). The option bytes are re-programmed with their previous values. This is also true for FLASH_PCROP1xSR and FLASH_PCROP1xER registers (x = A or B).

RM0490 Rev 5   71/1027  RM0490   Embedded flash memory (FLASH)  91  Note:   Mass erase (full or partial) is only triggered by the RDP regression from level 1 to level 0. RDP level increase (level 0 to level 1, 1 to 2, or 0 to 2) does not cause any mass erase. To validate the protection level change, the option bytes must be reloaded by setting the OBL_LAUNCH bit of the FLASH control register (FLASH_CR).  Figure 3. Changing read protection (RDP) level  Table 20: Mass erase upon RDP regression from level 1 to level 0 PCROP area   PCROP_RDP   Mass erase  None   x   Full Part of flash memory 1 0 Partial (flash memory pages not overlapping with PCROP area) Full flash memory   None  MSv33468V3 Read-protection level increase RDP = 0xAA RDP = 0xCC   5'3[&&[$$  Level 1  5'3 0xAA    0xCC  Level 2  RDP = 0xCC  Level 0  RDP = 0xAA RDP = 0xCC Read-protection level decrease (with full or partial mass erase) Erase/program option bytes without changing read-protection level (RDP kept unchanged)  Table 21. Access status versus protection level and execution modes Area   Protection level User execution (BootFromFlash)   Debug/ BootFromRam/ BootFromLoader Read   Write   Erase   Read   Write   Erase  Main flash memory 1   Yes   Yes   Yes   No   No   No (3) 2   Yes   Yes   Yes   N/A (1)   N/A (1)   N/A (1) System memory   (2) 1   Yes   No   No   Yes   No   No 2   Yes   No   No   N/A (1)   N/A (1)   N/A (1)

Embedded flash memory (FLASH)   RM0490  72/1027   RM0490 Rev 5  4.5.2   FLASH proprietary code readout protection (PCROP)  Two areas of the flash memory can be protected against unwanted read and/or write by a third party. The protected area is execute-only: it can only be reached by the STM32 CPU, with an instruction code, while all other accesses (DMA, debug and CPU data read, write and erase) are strictly prohibited. The PCROP areas have subpage (512-byte) granularity. An additional option bit (PCROP_RDP) allows to select if the PCROP area is erased or not when the RDP protection is changed from level 1 to level 0 (refer to   Changing the read protection level ). Each PCROP area is defined by a start subpage offset and an end subpage offset into the flash memory. These offsets are defined with the corresponding bitfields of the PCROP address registers   FLASH PCROP area A start address register (FLASH_PCROP1ASR) ,  FLASH PCROP area A end address register (FLASH_PCROP1AER) ,   FLASH PCROP area B start address register (FLASH_PCROP1BSR) , and   FLASH PCROP area B end address register (FLASH_PCROP1BER) . A PCROP area   x   (A or B) is defined from the address:  flash memory base address + [PCROP1x_STRT x 0x200]   (included) to the address:  flash memory base address + [(PCROP1x_END + 1) x 0x200]   (excluded). The minimum PCROP area size is two PCROP subpages (2 x 512 bytes):  PCROP1x_END = PCROP1x_STRT + 1.  When  PCROP1x_END = PCROP1x_STRT , the full flash memory is PCROP-protected. For example, to PCROP-protect the address area from 0x0800 0800 to 0x0800 13FF, set the PCROP start subpage bitfield of the FLASH_PCROP1xSR register and the PCROP end subpage bitfield of the FLASH_PCROP1xER register (x = A or B) as follows: –   PCROP1x_STRT = 0x04 (PCROP area start address 0x0800 0800) –   PCROP1x_END = 0x09 (PCROP area end address 0x0800 13FF) Data read access to a PCROP-protected address raises the RDERR flag. Option bytes   1   Yes   Yes   (3)   Yes   Yes   Yes (3)   Yes 2   Yes   No   No   N/A (1)   N/A (1)   N/A (1) OTP   1   Yes   Yes   N/A   Yes   No   N/A 2   Yes   Yes   N/A   N/A (1)   N/A (1)   N/A (1) 1.   When the protection level 2 is active, the Debug port, the boot from RAM and the boot from system memory are disabled. 2.   The system memory is only read-accessible, whatever the protection level (0, 1 or 2) and execution mode. 3.   The main flash memory is erased when the RDP option byte is programmed with all level of protections disabled (0xAA).  Table 21. Access status versus protection level and execution modes (continued) Area   Protection level User execution (BootFromFlash)   Debug/ BootFromRam/ BootFromLoader Read   Write   Erase   Read   Write   Erase

RM0490 Rev 5   73/1027  RM0490   Embedded flash memory (FLASH)  91  PCROP-protected addresses are also write protected. Write access to a PCROP-protected address raises the WRPERR flag. PCROP-protected areas are also erase protected. Attempts to erase a page including at least one PCROP-protected subpage fails. Moreover, software mass erase cannot be performed if a PCROP-protected area is defined. Deactivation of PCROP can only occur upon the RDP change from level 1 to level 0. Modification of user options to clear PCROP or to decrease the size of a PCROP-protected area do not have any effect to the PCROP areas. On the contrary, it is possible to increase the size of the PCROP-protected areas. With the option bit PCROP_RDP cleared, the change of RDP from level 1 to level 0 triggers a partial mass erase that preserves the contents of the flash memory pages overlapping with PCROP-protected areas. Refer to section   Changing the read protection level   for details.  Note:   With PCROP_RDP cleared, it is recommended to either define the PCROP area start and end onto flash memory page boundaries (2-Kbyte granularity), or to keep reserved and empty the PCROP-unprotected memory space of the PCROP area boundary pages (pages inside which the PCROP area starts and ends).  4.5.3   FLASH write protection (WRP)  The user area in flash memory can be protected against unwanted write operations. Two write-protected (WRP) areas can be defined, with page (2-Kbyte) granularity. Each area is defined by a start page offset and an end page offset related to the physical flash memory base address. These offsets are defined in the WRP address registers   FLASH WRP area A address register (FLASH_WRP1AR)   and   FLASH WRP area B address register (FLASH_WRP1BR) . The WRP   x   area (x = A, B) is defined from the address  flash memory Base address + [WRP1x_STRT x 0x0800]   (included) to the address  flash memory Base address + [(WRP1x_END+1) x 0x0800]   (excluded). The minimum WRP area size is one WRP page (2 Kbytes):  WRP1x_END = WRP1x_STRT .  Table 22. PCROP protection PCROP register values (x = A or B)   PCROP-protected area  PCROP1x_STRT = PCROP1x_END   Full flash memory PCROP1x_STRT > PCROP1x_END (1)   None (unprotected) PCROP1x_STRT < PCROP1x_END Subpages from PCROP1x_STRT   to PCROP1x_END (read-, write-, and erase-protected); PCROP area boundary pages (erase-protected). 1.   The PCROPx_STRT and PCROPx_END addresses cannot be pointing to the same flash page, for this comparison to work properly.

Embedded flash memory (FLASH)   RM0490  74/1027   RM0490 Rev 5  For example, to protect the flash memory by WRP from the address 0x0800 1000 (included) to the address 0x0800 3FFF (included): If boot in flash memory is selected, FLASH_WRP1AR register must be programmed with: –   WRP1A_STRT = 0x02. –   WRP1A_END = 0x07. WRP1B_STRT and WRP1B_END in FLASH_WRP1BR can be used instead (area B in the flash memory). When WRP is active, it cannot be erased or programmed. Consequently, a software mass erase cannot be performed if one area is write-protected. If an erase/program operation to a write-protected part of the flash memory is attempted, the write protection error flag (WRPERR) of the FLASH_SR register is set. This flag is also set for any write access to: –   OTP area –   part of the flash memory that can never be written like the ICP –   PCROP area  Note:   When the flash memory read protection level is selected (RDP level = 1), it is not possible to program or erase the memory if the CPU debug features are connected (single wire) or boot code is being executed from SRAM or system flash memory, even if WRP is not activated. Any attempt generates a hard fault (BusFault).  Note:   To validate the WRP options, the option bytes must be reloaded by setting the OBL_LAUNCH bit in flash memory control register.  4.5.4   Securable memory area  The main purpose of the securable memory area is to protect a specific part of flash memory against undesired access. After system reset, the code in the securable memory area can only be executed until the securable area becomes secured and never again until the next system reset. This allows implementing software security services such as secure key storage or safe boot. Securable memory area is located in the main flash memory. It is dedicated to executing trusted code. When not secured, the securable memory behaves like the rest of main flash memory. When secured (the SEC_PROT bit of the FLASH_CR register set), any access (fetch, read, programming, erase) to securable memory area is rejected, generating a bus error. The securable area can only be unsecured by a system reset. The size of the securable memory area is defined by the SEC_SIZE[5:0] bitfield of the FLASH_SECR register. It can be only modified in RDP level 0 or in RDP level 1 when  Table 23: WRP protection WRP registers values (x = A or B)   WRP-protected area  WRP1x_STRT = WRP1x_END   Page WRP1x WRP1x_STRT > WRP1x_END   None (unprotected) WRP1x_STRT < WRP1x_END   Pages from WRP1x_STRT   to WRP1x_END

RM0490 Rev 5   75/1027  RM0490   Embedded flash memory (FLASH)  91  SEC_PROT = 0. Its content is erased upon changing from RDP level 1 to level 0, even if it overlaps with PCROP subpages.  Note:   The securable memory area start address is 0x0800 0000. Before activating the securable memory area, move the vector table outside the page 0 if necessary. Note:   Upon change from RDP level 1 to level 0 while the PCROP_RDP bit is cleared, the securable memory area is erased even if it overlaps with the PCROP subpages. The PCROP subpages not overlapping with the securable memory area are not erased. See Table 24.  4.5.5   Disabling core debug access  For executing sensitive code or manipulating sensitive data in securable memory area, the debug access to the core can temporarily be disabled.  Figure 4   gives an example of managing DBG_SWEN and SEC_PROT bits.  Figure 4. Example of disabling core debug access 4.5.6   Forcing boot from main flash memory  To increase the security and establish a chain of trust, the BOOT_LOCK option bit of the FLASH_SECR register allows forcing the system to boot from the main flash memory  Table 24. Securable memory erase at RDP level 1 to level 0 change Securable memory size (SEC_SIZE[4:0])   PCROP_RDP   Erased pages  0   1   All (mass erase) 0   0   All but PCROP > 0   1   All (mass erase) > 0   0   All but PCROP outside the securable memory area  MSv42192V1 timeline  Debug enabled Debug enabled Debug disabled  DBG_SWEN = 0   DBG_SWEN = 1   SEC_PROT = 1 Option byte loading Execution of code within securable memory Execution of code outside securable memory Power up SEC_PROT = 1 Securable memory secured SEC_PROT = 0 Securable memory not secured Software management

Embedded flash memory (FLASH)   RM0490  76/1027   RM0490 Rev 5  regardless of the other boot options. It is always possible to set the BOOT_LOCK bit. However, it is possible to reset it only when:  •   RDP is set to level 0, or  •   RDP is set to level 1, while level 0 is requested and a full mass-erase is performed.  Caution:   If BOOT_LOCK is set in association with RDP level 1, the debug capabilities of the device are disabled and the reset value of the DBG_SWEN bit of the FLASH_ACR register becomes zero. If DBG_SWEN bit is not set by the application code after reset, there is no way to recover from this situation.  4.6   FLASH interrupts  Table 25. FLASH interrupt requests Interrupt event   Event flag   Event flag/interrupt clearing method Interrupt enable control bit  End of operation   EOP (1)   Write EOP=1   EOPIE Operation error   OPERR (2)   Write OPERR=1   ERRIE Read protection error   RDERR   Write RDERR=1   RDERRIE Write protection error   WRPERR   Write WRPERR=1   N/A Size error   SIZERR   Write SIZERR=1   N/A Programming sequential error   PROGERR   Write PROGERR=1   N/A Programming alignment error   PGAERR   Write PGAERR=1   N/A Programming sequence error   PGSERR   Write PGSERR=1   N/A Data miss during fast programming error   MISSERR   Write MISSERR=1   N/A Fast programming error   FASTERR   Write FASTERR=1   N/A 1.   EOP is set only if EOPIE is set. 2.   OPERR is set only if ERRIE is set.

RM0490 Rev 5   77/1027  RM0490   Embedded flash memory (FLASH)  91  4.7   FLASH registers 4.7.1   FLASH access control register (FLASH_ACR)  Address offset: 0x000 Reset value: 0b0000 0000 0000 010X 0000 0110 0000 0000 (the EMPTY bit is updated only by OBL. It is not affected by the system reset.) s  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   DBG _SWEN   Res.   EMPTY rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   ICRST   Res.   ICEN   PRFTEN   Res.   Res.   Res.   Res.   Res.   LATENCY[2:0] rw   rw   rw   rw   rw   rw Bits 31:19   Reserved, must be kept at reset value. Bit 18   DBG_SWEN : Debug access software enable Software may use this bit to enable/disable the debugger read access. 0: Debugger disabled 1: Debugger enabled Bit 17   Reserved, must be kept at reset value. Bit 16   EMPTY : Main flash memory area empty This bit indicates whether the first location of the main flash memory area was read as erased or as programmed during OBL. It is not affected by the system reset. Software may need to change this bit value after a flash memory program or erase operation. 0: Main flash memory area programmed 1: Main flash memory area empty The bit can be set and reset by software. Bits 15:12   Reserved, must be kept at reset value. Bit 11   ICRST : CPU Instruction cache reset 0: CPU Instruction cache is not reset 1: CPU Instruction cache is reset This bit can be written only when the instruction cache is disabled. Bit 10   Reserved, must be kept at reset value. Bit 9   ICEN : CPU Instruction cache enable 0: CPU Instruction cache is disabled 1: CPU Instruction cache is enabled

Embedded flash memory (FLASH)   RM0490  78/1027   RM0490 Rev 5  4.7.2   FLASH key register (FLASH_KEYR)  Address offset: 0x008 Reset value: 0x0000 0000 s  4.7.3   FLASH option key register (FLASH_OPTKEYR)  Address offset: 0x00C Reset value: 0x0000 0000 s  Bit 8   PRFTEN:   CPU Prefetch enable 0: CPU Prefetch disabled 1: CPU Prefetch enabled Bits 7:3   Reserved, must be kept at reset value. Bits 2:0   LATENCY[2:0] : Flash memory access latency The value in this bitfield represents the number of CPU wait states when accessing the flash memory. 000: Zero wait states 001: One wait state Other: Reserved A new write into the bitfield becomes effective when it returns the same value upon read. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 KEY[31:16] w   w   w   w   w   w   w   w   w   w   w   w   w   w   w   w 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 KEY[15:0] w   w   w   w   w   w   w   w   w   w   w   w   w   w   w   w  Bits 31:0   KEY[31:0] : FLASH key The following values must be written consecutively to unlock the   FLASH control register (FLASH_CR) , thus enabling programming/erasing operations: KEY1: 0x4567 0123 KEY2: 0xCDEF 89AB 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 OPTKEY[31:16] w   w   w   w   w   w   w   w   w   w   w   w   w   w   w   w 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 OPTKEY[15:0] w   w   w   w   w   w   w   w   w   w   w   w   w   w   w   w  Bits 31:0   OPTKEY[31:0] : Option byte key The following values must be written consecutively to unlock the flash memory option registers, enabling option byte programming/erasing operations: KEY1: 0x0819 2A3B KEY2: 0x4C5D 6E7F

RM0490 Rev 5   79/1027  RM0490   Embedded flash memory (FLASH)  91  4.7.4   FLASH status register (FLASH_SR)  Address offset: 0x010 Reset value: 0x000X 0000 es  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CFGBSY   Res.   BSY1 r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 OPTV ERR RD ERR   Res.   Res.   Res.   Res.   FAST ERR MISS ERR PGS ERR SIZ ERR PGA ERR WRP ERR PROG ERR   Res.   OP ERR   EOP rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1 Bits 31:19   Reserved, must be kept at reset value. Bit 18   CFGBSY : Programming or erase configuration busy. This flag is set and reset by hardware. For flash program operation, it is set when the first word is sent, and cleared after the second word is sent when the operation completes or ends with an error. For flash erase operation, it is set when setting the STRT bit of the FLASH_CR register and cleared when the operation completes or ends with an error. When set, a programming or erase operation is ongoing and the corresponding settings in the   FLASH control register (FLASH_CR)   are used (busy) and cannot be changed. Any other flash operation launch must be postponed. When cleared, the programming and erase settings in the   FLASH control register (FLASH_CR)   can be modified.  Note:   The CFGBSY bit is also set when attempting to write locked flash memory (with the first byte sent). When the CFGBSY bit is set, writing into the FLASH_CR register causes HardFault.To clear the CFGBSY bit, send a double word to the flash memory and wait until the access is finished (otherwise the CFGBSY bit remains set).  Bit 17   Reserved, must be kept at reset value. Bit 16   BSY1 : Busy This flag indicates that a flash memory operation requested by   FLASH control register (FLASH_CR)   is in progress. This bit is set at the beginning of the flash memory operation, and cleared when the operation finishes or when an error occurs. Bit 15   OPTVERR : Option and Engineering bits loading validity error Set by hardware when the options and engineering bits read may not be the one configured by the user or production. If options and engineering bits haven’t been properly loaded, OPTVERR is set again after each system reset. Option bytes that fail loading are forced to a safe value, see   Section 4.4.2: FLASH option byte programming . Cleared by writing 1. Bit 14   RDERR : PCROP read error Set by hardware when an address to be read belongs to a read protected area of the flash memory (PCROP protection). An interrupt is generated if RDERRIE is set in FLASH_CR. Cleared by writing 1. Bits 13:10   Reserved, must be kept at reset value.

Embedded flash memory (FLASH)   RM0490  80/1027   RM0490 Rev 5  Bit 9   FASTERR : Fast programming error Set by hardware when a fast programming sequence (activated by FSTPG) is interrupted due to an error (alignment, size, write protection or data miss). The corresponding status bit (PGAERR, SIZERR, WRPERR or MISSERR) is set at the same time. Cleared by writing 1. Bit 8   MISSERR : Fast programming data miss error In Fast programming mode, 32 double words (256 bytes) must be sent to flash memory successively, and the new data must be sent to the logic control before the current data is fully programmed. MISSERR is set by hardware when the new data is not present in time. Cleared by writing 1. Bit 7   PGSERR : Programming sequence error Set by hardware when a write access to the flash memory is performed by the code while PG or FSTPG have not been set previously. Set also by hardware when PROGERR, SIZERR, PGAERR, WRPERR, MISSERR or FASTERR is set due to a previous programming error. Cleared by writing 1. Bit 6   SIZERR : Size error Set by hardware when the size of the access is a byte or half-word during a program or a fast program sequence. Only double word programming is allowed (consequently: word access). Cleared by writing 1. Bit 5   PGAERR : Programming alignment error Set by hardware when the data to program cannot be contained in the same double word (64-bit) flash memory in case of standard programming, or if there is a change of page during fast programming. Cleared by writing 1. Bit 4   WRPERR : Write protection error Set by hardware when an address to be erased/programmed belongs to a write-protected part (by WRP, PCROP or RDP level 1) of the flash memory. Cleared by writing 1. Bit 3   PROGERR : Programming error Set by hardware when a double-word address to be programmed contains a value different from '0xFFFF FFFF' before programming, except if the data to write is '0x0000 0000'. Cleared by writing 1. Bit 2   Reserved, must be kept at reset value. Bit 1   OPERR : Operation error Set by hardware when a flash memory operation (program / erase) completes unsuccessfully. This bit is set only if error interrupts are enabled (ERRIE=1). Cleared by writing ‘1’. Bit 0   EOP : End of operation Set by hardware when one or more flash memory operation (programming / erase) has been completed successfully. This bit is set only if the end of operation interrupts are enabled (EOPIE=1). Cleared by writing 1.

RM0490 Rev 5   81/1027  RM0490   Embedded flash memory (FLASH)  91  4.7.5   FLASH control register (FLASH_CR)  Address offset: 0x014 Reset value: 0xC000 0000 Access: no wait state when no flash memory operation is on going, word, half-word and byte access This register must not be modified when CFGBSY in   FLASH status register (FLASH_SR)   is set. This would result in a HardFault exception. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 LOCK   OPT LOCK   Res.   SEC_ PROT OBL_ LAUNCH RD ERRIE   ERRIE   EOPIE   Res.   Res.   Res.   Res.   Res.   FSTPG   OPT STRT   STRT rs   rs   rw   rc_w1   rw   rw   rw   rw   rs   rs 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   PNB[6:0]   MER1   PER   PG rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 31   LOCK:   FLASH_CR Lock This bit is set only. When set, the FLASH_CR register is locked. It is cleared by hardware after detecting the unlock sequence. In case of an unsuccessful unlock operation, this bit remains set until the next system reset. Bit 30   OPTLOCK:   Options Lock This bit is set only. When set, all bits concerning user option in FLASH_CR register and so option page are locked. This bit is cleared by hardware after detecting the unlock sequence. The LOCK bit must be cleared before doing the unlock sequence for OPTLOCK bit. In case of an unsuccessful unlock operation, this bit remains set until the next reset. Bit 29   Reserved, must be kept at reset value. Bit 28   SEC_PROT : Securable memory area protection enable This bit enables the protection on securable area, provided that a non-null securable memory area size (SEC_SIZE[4:0]) is defined in option bytes. 0: Disable (securable area accessible) 1: Enable (securable area not accessible) This bit is possible to set only by software and to clear only through a system reset. Bit 27   OBL_LAUNCH : Option byte load launch When set, this bit triggers the load of option bytes into option registers. It is automatically cleared upon the completion of the load. The high state of the bit indicates pending option byte load. The bit cannot be cleared by software. It cannot be written as long as OPTLOCK is set. Bit 26   RDERRIE : PCROP read error interrupt enable This bit enables the interrupt generation upon setting the RDERR flag in the FLASH_SR register. 0: Disable  1: Enable Bit 25   ERRIE : Error interrupt enable This bit enables the interrupt generation upon setting the OPERR flag in the FLASH_SR register. 0: Disable  1: Enable

Embedded flash memory (FLASH)   RM0490  82/1027   RM0490 Rev 5  Bit 24   EOPIE : End-of-operation interrupt enable This bit enables the interrupt generation upon setting the EOP flag in the FLASH_SR register. 0: Disable 1: Enable Bits 23:19   Reserved, must be kept at reset value. Bit 18   FSTPG : Fast programming enable 0: Disable 1: Enable Bit 17   OPTSTRT : Start of modification of option bytes This bit triggers an options operation when set. This bit is set only by software, and is cleared when the BSY1 bit is cleared in FLASH_SR. Bit 16   STRT : Start erase operation This bit triggers an erase operation when set. This bit is possible to set only by software and to clear only by hardware. The hardware clears it when one of BSY1 and BSY2 flags in the FLASH_SR register transits to zero. Bits 15:10   Reserved, must be kept at reset value. Bits 9:3   PNB[6:0] : Page number selection These bits select the page to erase: 0x00:   page 0 0x01:   page 1 ... 0x7F:   page 127  Note:   Values corresponding to addresses outside the main flash memory are not allowed. See Table 9 and Table 10.  Bit 2   MER1 : Mass erase When set, this bit triggers the mass erase, that is, all user pages. Bit 1   PER : Page erase enable 0: Disable 1: Enable Bit 0   PG : Flash memory programming enable 0: Disable 1: Enable

RM0490 Rev 5   83/1027  RM0490   Embedded flash memory (FLASH)  91  4.7.6   FLASH option register (FLASH_OPTR)  Address offset: 0x020 Reset value: 0xXXXX XXXX (The option bits are loaded with values from flash memory at power-on reset release.) Access: no wait state when no flash memory operation is on going, word, half-word and byte access 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 FDCAN_ BL_CK[1:0]   IRHEN   NRST_MODE [1:0] N BOOT0 N BOOT1 NBOO T _SEL SECUR E_MUX ING_E N RAM_P ARITY_ CHECK HSE_N OT_RE MAPPE D Res.   WWDG _SW IWDG _ STDBY IWDG _STOP IWDG _SW rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 NRST_ SHDW NRST_ STDBY NRST_ STOP   BORF_LEV[1:0]   BORR_LEV[1:0]   BOR_ EN   RDP[7:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bits 31:30   FDCAN_BL_CK[1:0] : FDCAN bootloader clock source 00: HSI48 01: HSE crystal - 12 MHz 10: HSE crystal - 24 MHz 11: HSE crystal - 48 MHz  Note:   Only available on STM32C092xx devices, reserved on the other products.  Bit 29   IRHEN : Internal reset holder enable bit 0: Internal resets are propagated as simple pulse on NRST pin 1: Internal resets drives NRST pin low until it is seen as low level Bits 28:27   NRST_MODE[1:0] : PF2-NRST pin configuration 00: Reserved 01: Reset input only: a low level on the NRST pin generates system reset; internal RESET is not propagated to the NRST pin. 10: PF2 GPIO: only internal RESET is possible 11: Bidirectional reset: the NRST pin is configured in reset input/output (legacy) mode Bit 26   NBOOT0:   NBOOT0 option bit 0: NBOOT0 = 0 1: NBOOT0 = 1 Bit 25   NBOOT1:   NBOOT1 boot configuration Together with the BOOT0 pin or NBOOT0 option bit (depending on NBOOT_SEL option bit configuration), this bit selects boot mode from the main flash memory, SRAM, or the system memory. Refer to   Section 3: Boot modes . Bit 24   NBOOT_SEL:   BOOT0 signal source selection This bit defines the source of the BOOT0 signal. 0: BOOT0 pin (legacy mode) 1: NBOOT0 option bit

Embedded flash memory (FLASH)   RM0490  84/1027   RM0490 Rev 5  Bit 23   SECURE_MUXING_EN : Multiple-bonding security The bit allows enabling automatic I/O configuration to prevent conflicts on I/Os connected (bonded) onto the same pin. 0: Disable 1: Enable If the software sets one of the I/Os connected to the same pin as active by configuring the SYSCFG_CFGR3 register, enabling this bit automatically forces the other I/Os in digital input mode, regardless of their software configuration. When the bit is disabled, the SYSCFG_CFGR3 register setting is ignored, all GPIOs linked to a given pin are active and can be set in the mode specified by the corresponding GPIOx_MODER register. The user software must ensure that there is no conflict between GPIOs. Bit 22   RAM_PARITY_CHECK:   SRAM parity check control enable/disable 0: Enable 1: Disable Bit 21   HSE_NOT_REMAPPED:   HSE remapping enable/disable When cleared, the bit remaps the HSE clock source from PF0-OSC_IN/PF1-OSC_OUT pins to PC14-OSCX_IN/PC15-OSCX_OUT. Thus PC14-OSCX_IN/PC15-OSCX_OUT are shared by both LSE and HSE and the two clock sources cannot be use simultaneously. 0: Enable 1: Disable On packages with less than 48 pins, the remapping is always enabled (PF0-OSC_IN/PF1- OSC_OUT are not available), regardless of this bit. As all STM32C011xx packages have less than 48 pins, this bit is only applicable to STM32C031xx.  Note:   On 48 pins packages, when HSE_NOT_REMAPPED is reset, HSE cannot be used in bypass mode. Refer to product errata sheet for more details.  Bit 20   Reserved, must be kept at reset value. Bit 19   WWDG_SW:   Window watchdog selection 0: Hardware window watchdog  1: Software window watchdog Bit 18   IWDG_STDBY:   Independent watchdog counter freeze in Standby mode 0: Independent watchdog counter is frozen in Standby mode  1: Independent watchdog counter is running in Standby mode Bit 17   IWDG_STOP:   Independent watchdog counter freeze in Stop mode 0: Independent watchdog counter is frozen in Stop mode  1: Independent watchdog counter is running in Stop mode Bit 16   IWDG_SW:   Independent watchdog selection 0: Hardware independent watchdog  1: Software independent watchdog Bit 15   NRST_SHDW:   Reset generation upon entering Shutdown mode 0: Reset generated  1: Reset not generated Bit 14   NRST_STDBY:   Reset generation upon entering Standby mode 0: Reset generated  1: Reset not generated Bit 13   NRST_STOP:   Reset generation upon entering Stop mode 0: Reset generated  1: Reset not generated

RM0490 Rev 5   85/1027  RM0490   Embedded flash memory (FLASH)  91  4.7.7   FLASH PCROP area A start address register  (FLASH_PCROP1ASR)  Address offset: 0x024 Reset value: 0b0000 0000 0000 0000 0000 000X XXXX XXXX (The option bits are loaded with values from flash memory at power-on reset release.) Access: no wait state when no flash memory operation is on going, word, half-word access  Bits 12:11   BORF_LEV[1:0] : BOR threshold at falling V DD   supply Falling V   DD   crossings this threshold activates the reset signal. 00: BOR falling level 1 with threshold around 2.0 V 01: BOR falling level 2 with threshold around 2.2 V 10: BOR falling level 3 with threshold around 2.5 V 11: BOR falling level 4 with threshold around 2.8 V Bits 10:9   BORR_LEV[1:0] : BOR threshold at rising V   DD   supply Rising V   DD   crossings this threshold releases the reset signal. 00: BOR rising level 1 with threshold around 2.1 V 01: BOR rising level 2 with threshold around 2.3 V 10: BOR rising level 3 with threshold around 2.6 V 11: BOR rising level 4 with threshold around 2.9 V Bit 8   BOR_EN : Brown out reset enable 0: Configurable brown out reset disabled, power-on reset defined by POR/PDR levels 1: Configurable brown out reset enabled, values of BORR_LEV and BORF_LEV taken into account Bits 7:0   RDP[7:0]:   Read protection level 0xAA: Level 0, read protection not active  0xCC: Level 2, chip read protection active  Other: Level 1, memories read protection active 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   PCROP1A_STRT[8:0] rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:9   Reserved, must be kept at reset value. Bits 8:0   PCROP1A_STRT[8:0]:   PCROP1A area start offset Contains the offset of the first subpage of the PCROP1A area.  Note:   The number of effective bits depends on the size of the flash memory in the device.

Embedded flash memory (FLASH)   RM0490  86/1027   RM0490 Rev 5  4.7.8   FLASH PCROP area A end address register  (FLASH_PCROP1AER)  Address offset: 0x028 Reset value: 0bX000 0000 0000 0000 0000 000X XXXX XXXX (The option bits are loaded with values from flash memory at power-on reset release.) Access: no wait state when no flash memory operation is on going, word, half-word access. PCROP_RDP bit can be accessed with byte access  4.7.9   FLASH WRP area A address register (FLASH_WRP1AR)  Address offset: 0x02C Reset value: 0b0000 0000 0XXX XXXX 0000 0000 0XXX XXXX (The option bits are loaded with values from flash memory at power-on reset release.) Access: no wait state when no flash memory operation is on going, word, half-word and byte access. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 PCROP_RDP   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. rs 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   PCROP1A_END[8:0] rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 31   PCROP_RDP:   PCROP area erase upon RDP level regression This bit determines whether the PCROP area (and the totality of the PCROP area boundary pages) is erased by the mass erase triggered by the RDP level regression from level 1 to level 0: 0: Not erased 1: Erased The software can only set this bit. It is automatically reset upon mass erase following the RDP regression from level 1 to level 0. Bits 30:9   Reserved, must be kept at reset value. Bits 8:0   PCROP1A_END[8:0]:   PCROP1A area end offset Contains the offset of the last subpage of the PCROP1A area.  Note:   The number of effective bits depends on the size of the flash memory in the device.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   WRP1A_END[6:0] rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   WRP1A_STRT[6:0] rw   rw   rw   rw   rw   rw   rw

RM0490 Rev 5   87/1027  RM0490   Embedded flash memory (FLASH)  91  4.7.10   FLASH WRP area B address register (FLASH_WRP1BR)  Address offset: 0x030 Reset value: 0b0000 0000 0XXX XXXX 0000 0000 0XXX XXXX (The option bits are loaded with values from flash memory at power-on reset release.) Access: no wait state when no flash memory operation is on going, word, half-word and byte access. Bits 31:23   Reserved, must be kept at reset value. Bits 22:16   WRP1A_END[6:0]:   WRP area A end offset This bitfield contains the offset of the last page of the WRP area A.  Note:   The number of effective bits depends on the size of the flash memory in the device.  Bits 15:7   Reserved, must be kept at reset value. Bits 6:0   WRP1A_STRT[6:0]:   WRP area A start offset This bitfield contains the offset of the first page of the WRP area A.  Note:   The number of effective bits depends on the size of the flash memory in the device.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   WRP1B_END[6:0] rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   WRP1B_STRT[6:0] rw   rw   rw   rw   rw   rw   rw  Bits 31:23   Reserved, must be kept at reset value. Bits 22:16   WRP1B_END[6:0]:   WRP area B end offset This bitfield contains the offset of the last page of the WRP area B.  Note:   The number of effective bits depends on the size of the flash memory in the device.  Bits 15:7   Reserved, must be kept at reset value. Bits 6:0   WRP1B_STRT[6:0]:   WRP area B start offset This bitfield contains the offset of the first page of the WRP area B.  Note:   The number of effective bits depends on the size of the flash memory in the device.

Embedded flash memory (FLASH)   RM0490  88/1027   RM0490 Rev 5  4.7.11   FLASH PCROP area B start address register  (FLASH_PCROP1BSR)  Address offset: 0x034 Reset value: 0b0000 0000 0000 0000 0000 000X XXXX XXXX (The option bits are loaded with values from flash memory at power-on reset release.) Access: no wait state when no flash memory operation is on going, word, half-word access  4.7.12   FLASH PCROP area B end address register  (FLASH_PCROP1BER)  Address offset: 0x038 Reset value: 0b0000 0000 0000 0000 0000 000X XXXX XXXX (The option bits are loaded with values from flash memory at power-on reset release.) Access: no wait state when no flash memory operation is on going, word, half-word access  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   PCROP1B_STRT[8:0] rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:9   Reserved, must be kept at reset value. Bits 8:0   PCROP1B_STRT[8:0]:   PCROP1B area start offset Contains the offset of the first subpage of the PCROP1B area.  Note:   The number of effective bits depends on the size of the flash memory in the device.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   PCROP1B_END[8:0] rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:9   Reserved, must be kept at reset value. Bits 8:0   PCROP1B_END[8:0]:   PCROP1B area end offset Contains the offset of the last subpage of the PCROP1B area.  Note:   The number of effective bits depends on the size of the flash memory in the device.

RM0490 Rev 5   89/1027  RM0490   Embedded flash memory (FLASH)  91  4.7.13   FLASH security register (FLASH_SECR)  Address offset: 0x080 Reset value: 0b0000 0000 0000 000X 0000 0000 0XXX XXXX (The option bits are loaded with values from flash memory at power-on reset release.) Access: no wait state when no flash memory operation is on going, word, half-word access  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   BOOT_LOCK rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   SEC_SIZE[6:0] rw   rw   rw   rw   rw   rw   rw  Bits 31:17   Reserved, must be kept at reset value. Bit 16   BOOT_LOCK : used to force boot from user area 0: Boot based on the pad/option bit configuration 1: Boot forced from main flash memory  Caution:   If the bit is set in association with RDP level 1, the debug capabilities of the device are disabled and the reset value of the DBG_SWEN bit of the FLASH_ACR register becomes zero. In this case, re-enabling of debug capabilities is possible only by setting the DBG_SWEN bit by the application code. Bits 15:7   Reserved, must be kept at reset value. Bits 6:0   SEC_SIZE[6:0] : Securable memory area size Contains the number of securable flash memory pages.  Note:   The number of effective bits depends on the size of the flash memory in the device.

Embedded flash memory (FLASH)   RM0490  90/1027   RM0490 Rev 5  4.7.14   FLASH register map Table 26. FLASH register map and reset values Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x000   FLASH_ACR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DBG_SWEN Res. EMPTY Res. Res. Res. Res. ICRST Res. ICEN PRFTEN Res. Res. Res. Res. Res.   LATENCY [2:0] Reset value   1   X   0   1   0   0   0   0 0x004   Reserved Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. 0x008   FLASH_KEYR   KEYR[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x00C FLASH_OPT KEYR   OPTKEY[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x010   FLASH_SR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CFGBSY Res. BSY1 OPTVERR RDERR Res. Res. Res. Res. FASTERR MISERR PGSERR SIZERR PGAERR WRPERR PROGERR Res. OPERR EOP Reset value   0   0   X   0   0   0   0   0   0   0   0   0   0 0x014   FLASH_CR LOCK OPTLOCK Res. SEC_PROT OBL_LAUNCH RDERRIE ERRIE EOPIE Res. Res. Res. Res. Res. FSTPG OPTSTRT STRT Res. Res. Res. Res. Res. Res. PNB[6:0] MER1 PER PG Reset value   1   1   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x018   Reserved Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. 0x020   FLASH_OPTR FDCAN_BL_CK[1:0] IRHEN NRST_MODE[1:0] .NBOOT0 NBOOT1 NBOOT_SEL SECURE_MUXING_EN RAM_PARITY_CHECK HSE_NOT_REMAPPED Res. WWDG_SW IWDG_STBY IWDG_STOP IWDG_SW NRST_SHDW NRST_STDBY NRST_STOP BORF_LEV[1:0] BORR_LEV[1:0] BOR_EN RDP[7:0] Reset value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X 0x024 FLASH_ PCROP1ASR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PCROP1A_STRT[8:0] Reset value   X   X   X   X   X   X   X   X   X 0x028 FLASH_ PCROP1AER PCROP_RDP. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PCROP1A_END[8:0] Reset value   X   X   X   X   X   X   X   X   X   X 0x02C FLASH_ WRP1AR Res. Res. Res. Res. Res. Res. Res. Res. Res. WRP1A_END[6:0] Res. Res. Res. Res. Res. Res. Res. Res. Res. WRP1A_STRT[6:0] Reset value   X   X   X   X   X   X   X   X   X   X   X   X   X   X 0x030 FLASH_ WRP1BR Res. Res. Res. Res. Res. Res. Res. Res. WRP1B_END[6:0] Res. Res. Res. Res. Res. Res. Res. Res. Res. WRP1B_STRT[6:0] Reset value   X   X   X   X   X   X   X   X   X   X   X   X   X   X 0x034 FLASH_ PCROP1BSR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PCROP1B_STRT[8:0] Reset value   X   X   X   X   X   X   X   X   X 0x038 FLASH_ PCROP1BER Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PCROP1B_END[8:0] Reset value   X   X   X   X   X   X   X   X   X 0x03C - 0x07F   Reserved Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res.

RM0490 Rev 5   91/1027  RM0490   Embedded flash memory (FLASH)  91  Refer to   Section 2.2 on page 45   for the register boundary addresses. 0x080   FLASH_SECR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. BOOT_LOCK Res. Res. Res. Res. Res. Res. Res. Res. Res. SEC_SIZE[6:0] Reset value   X   X   X   X   X   X   X   X  Table 26. FLASH register map and reset values (continued) Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

Power control (PWR)   RM0490  92/1027   RM0490 Rev 5  5   Power control (PWR) 5.1   Power supplies and voltage references  The devices are powered through the VDD/VDDA pin. Internally, the power is delivered through the V DD   power line supplying the internal resources in the V   DD   power domain and the flash memory, the V   DDA   power line supplying the ADC, and the V DDIO1   and V DDIO2 (V   DDIO2   only available on STM32C071xx) power lines supplying the I/O ring. Through the V   CORE   power line, the voltage regulator supplies the resources in the V CORE power domain including the core, SRAM and digital peripherals, the RTC domain and the flash memory. Refer to the following figure and to the device datasheets for further information.  Figure 5. Power supply overview  1.   Internally connected to VDD/VDDA pin on packages without VREF+ pin. 2.   Internally connected to VDD/VDDA pin on packages without VDDIO2 pin. 3.   Internally connected to VSS/VSSA pin on packages without VSS pin.  Note:   VDDIO2 and VSS pins are only available on some packages. VDDIO2 is only available on STM32C071xx.  5.1.1   ADC reference voltage  V   REF+   defines the full-scale ADC input signal level. On packages with VREF+ input pin, the V   REF+   voltage reference is supplied externally, which allows increasing the ADC resolution (voltage per step) and reducing the noise. Refer to the device datasheets for the allowed V   REF+   range.  MSv66171V2 V DDA   domain RTC domain A/D converter Standby circuitry (Wakeup logic, IWDG)   Core SRAM Digital peripherals LSE 32 kHz RTC I/O ring V CORE   domain Temp. sensor Reset block HSI48 V DDIO1 V DD   domain V   CORE VSS/VSSA V   DDA V   REF+ V SSA V SS V DD VREF+ (1) V DDIO1   domain Flash memory I/O ring USB   V DDIO2   domain VDDIO2   (2)   V DDIO2 VDD/VDDA Voltage regulator VSS (3)

RM0490 Rev 5   93/1027  RM0490   Power control (PWR)  117  5.1.2   Voltage regulator  When enabled, the voltage regulator provides the V   CORE   supply voltage to the V CORE domain. The regulator is enabled upon reset and remains enabled as long as the device operates in Run, Sleep, or Stop mode. In Standby and Shutdown modes, the regulator is disabled and the V   CORE   domain is not powered. As a consequence, the SRAM and register contents are lost.  5.2   Power supply supervisor 5.2.1   Power-on reset (POR) / power-down reset (PDR) / brown-out reset (BOR)  The device features an integrated power-on reset (POR) / power-down reset (PDR), coupled with a brown-out reset (BOR) circuitry. The POR/PDR is active in all power modes. The BOR can be enabled or disabled only through option bytes. It is not available in Shutdown mode. When the BOR is enabled, four BOR levels can be selected through option bytes, with independent configuration for rising and falling thresholds. During power-on, the BOR keeps the device under reset until the V   DD   supply voltage reaches the specified BOR rising threshold (V BORRx   ). At this point, the device reset is released and the system can start. During power-down, when V DD   drops below the selected BOR falling threshold (V BORFx ), the device is put under reset again.  Warning:   It is not allowed to configure BOR falling threshold (V BORFx ) to a value higher than BOR rising threshold (V BORRx ).

Power control (PWR)   RM0490  94/1027   RM0490 Rev 5  Figure 6. POR, PDR, and BOR thresholds  1.   The reset temporization t   RSTTEMPO   starts when V   DD   crosses V   POR   threshold, indifferently from the configuration of the BOR Option bits.  V   DD V BORR4 V BORF4 V BORR3 V BORF3 V BORR2 V BORF2 V BORR1 V BORF1 V POR V PDR t t RSTTEMPO (1) Reset with BOR off Reset with BOR on (V BORR4   V BORF1 ) POR/BOR rising thresholds PDR/BOR falling thresholds

RM0490 Rev 5   95/1027  RM0490   Power control (PWR)  117  For more details on the brown-out reset thresholds, refer to the electrical characteristics section in the datasheet.  5.3   Operating modes  The device has a full-operating mode called Run mode and several low-power modes allowing substantial power saving. Upon a system or a power-on reset, the device starts operating in Run mode. Sleep, Stop, Standby, and Shutdown low-power modes are available to save power when there is no need for the CPU to execute instructions, for example when waiting for an external event. Different low-power modes offer different trade-offs between power consumption, startup speed and wake-up possibilities. While the Sleep mode offers the highest agility at cost of the least power saving, the Shutdown mode provides the lowest power consumption at cost of slower wake-up and absence of power supply monitoring and BOR/PDR. The Standby mode, compared to Shutdown, keeps the LSI oscillator, the IWDG and the voltage monitoring active, at cost of a slightly greater power consumption. The Stop mode keeps low-speed clocks and peripherals, as well as GPIOs active. Refer to   Table 27: Device resources enabled in different operating modes   and   Table 29: Low-power mode exit overview   for all details. The device can transit from Run mode to any of the low-power modes and from any low- power operating mode to Run mode. Transiting from one low-power mode to another is not possible. Refer to the following figure.  Figure 7. Low-power mode transit diagram  Run mode Shutdown mode Standby mode Stop mode Sleep mode

Power control (PWR)   RM0490  96/1027   RM0490 Rev 5  The following table gives an overview of the device resources available in each operating mode and their capability to wake the device up from a low-power mode to Run mode. Refer to the table footnotes for complementary information.  Table 27. Device resources enabled in different operating modes Function Operating mode   (1) Run   Sleep   Stop (2)   Standby (2)   Shutdown (2)  CPU   Y   -   -   -   -   -   -   - Flash memory   Y   Y   A (3)   -   -   -   -   - SRAM   Y   Y   U   -   -   -   -   - V CORE   supply   (4)   Y   Y   Y   -   -   -   -   - BOR/POR/PDR   O   O   U   U   U   U   -   (5)   - NRST   Y   Y   Y   Y   Y   Y   Y   Y DMA/DMAMUX   O   U   -   -   -   -   -   - HSI48   Y   U (6)   -   (6)   -   -   -   -   - HSIUSB48   Y   U   -   -   -   -   -   - HSE   O   U   -   -   -   -   -   - LSI   O   U   U   -   U   -   -   - LSE   O   U   U   -   -   -   -   - CSS   O   U   -   -   -   -   -   - CSS on LSE   O   U   U   O   -   -   -   - RTC / Auto wake-up   O   U   U   O   -   -   -   - USART1   O   U (7)   U (7)   O   (7)   -   -   -   - USART2/3/4   O   U (7)   -   -   -   -   -   - I2C1   O   U (8)   U (8)   O   (8)   -   -   -   - I2C2   O   U   -   -   -   -   -   - SPI1, SPI2   O   U   -   -   -   -   -   - ADC   O   U   -   (9)   -   -   -   -   - Temperature sensor   O   U   -   (9)   -   -   -   -   - TIMx   O   U   -   -   -   -   -   - IWDG   O   U   U   O   U   O   -   - WWDG   O   U   -   -   -   -   -   - SysTick timer   O   U   -   -   -   -   -   -

RM0490 Rev 5   97/1027  RM0490   Power control (PWR)  117  5.3.1   Power saving in run mode  The power consumption in Run mode can be reduced through selecting a system clock with lower frequency, scaling down the system clock frequency, disabling unused peripherals and/or stopping their clocks (peripheral clock gating).  Slowing down system clocks  The SYSCLK, HCLK, and PCLK clock frequencies can be reduced with prescalers controlled through prescaler registers. Their settings also apply to the Sleep mode. For more details, refer to   Section 6.4.3: RCC clock configuration register (RCC_CFGR) . CRC   O   U   -   -   -   -   -   - GPIOs   O   U   U   O   (10)   (11)   (10)   (11) Individual peripheral clocks to peripherals   O   A (12)   A (12)   -   -   -   -   - USB   O   O   -   O   (13)   -   -   -   - FDCAN1   O   O   -   -   -   -   -   - 1.   Y   = (yes): resource enabled upon reset and upon wake-up from Stop, Standby, and Shutdown;   O   = (optional): resource disabled by default, and possible to enable by software;   U   = (unchanged): resource kept in the same operating state as before low-power mode entry;   A   = (automatic): resource can be set for automatic disable/power-down upon transiting to low-power mode;   -   = resource not available / without wake-up capability (grayed-out columns) 2.   The grayed-out column indicates the capability of the resource to wake the device up from a low-power mode. 3.   Possibility of automatic power-down. 4.   When not available (voltage regulator disabled), the SRAM and register contents are lost. 5.   The supply voltage monitoring is disabled and the product behavior is not guaranteed in case of a power voltage drop. 6.   When the HSI48 is off, peripherals with wake-up capability, such as I2C1, can wake the HSI48 oscillator up to allow temporary operation to assess the device wake-up condition such as I²C address match, then stop HSI48 if the wake-up condition is not met, or wake the device up if it is met. When the HSI48 is restarted by a peripheral with wake-up capability, during the low-power mode it only delivers clock to that peripheral. 7.   USART reception is functional in Sleep and Stop mode. It generates a wake-up interrupt on START, address match, or received frame event. The peripheral has the capability to restart the HSI48 oscillator to assess the address match and received frame event device wake-up conditions. 8.   I²C address detection is functional in Sleep and Stop mode. It generates a wake-up interrupt on address match. The peripheral has the capability to restart the HSI48 oscillator to assess the address match event device wake-up condition. 9.   Keeps consuming idle current unless disabled prior to entering Stop mode. 10. I/Os can be configured to keep, in Standby and Shutdown mode, internal pull-up or pull-down, or to float. Refer to PUCRx and PDCRx registers and the APC bit of the PWR_CR3 register. This configuration is kept when exiting Standby mode but it is lost when exiting Shutdown mode. 11. WKUPx I/Os (up to five, depending on the package), with wake-up from Standby/Shutdown mode capability. 12. Through the RCC_AHBSMENR and RCC_APBSMENRx registers, the software can configure the individual peripheral clocks to automatically disable upon entering Sleep and Stop modes. 13. USB bus state monitoring is functional in Stop mode. It generates a wake-up interrupt if the resume from the USB suspend is detected.  Table 27. Device resources enabled in different operating modes (continued) Function Operating mode   (1) Run   Sleep   Stop (2)   Standby (2)   Shutdown (2)

Power control (PWR)   RM0490  98/1027   RM0490 Rev 5  Peripheral clock gating  The HCLK and PCLK to individual peripherals and memories can be stopped (clock gating) at any time to reduce the power consumption. The RCC_AHBENR and RCC_APBENRx registers enable or disable individual clocks to peripherals (clock gating). To further reduce the power consumption in Sleep/Stop modes, the peripheral clocks can be disabled prior to executing the WFI or WFE instructions. Disabling the peripherals clocks in Sleep/Stop modes can be performed automatically, by clearing the corresponding bit of the RCC_AHBSMENR and RCC_APBSMENRx registers.  5.3.2   Low-power modes  The device features the following low-power modes:  •   Sleep mode  CPU clock is off, all peripherals including Cortex   ® -M0+ core peripherals such as NVIC and SysTick can run and wake up the CPU when an interrupt or an event occurs. To further reduce the power consumption in Sleep mode, the peripheral clocks can be disabled prior to executing the WFI or WFE instructions. This can also be done automatically, by configuring RCC_AHBSMENR and RCC_APBSMENRx registers. If disabled before entering Sleep mode, HSI48 can be restarted by a peripheral with wake-up capability requiring HSI48.  •   Stop mode  SRAM and register contents are retained. HSE and HSI48 stop. HSI48 can be restarted by a peripheral with wake-up capability requiring HSI48. The LSI and LSE oscillators can be kept running. The RTC can remain active (Stop mode with RTC, Stop mode without RTC). The event of exiting Stop mode enables the HSI48 oscillator and selects HSISYS as system clock.  •   Standby mode  V   CORE   domain is powered off and the SRAM and register contents lost, except   PWR control register 3 (PWR_CR3)   and   PWR backup x register (PWR_BKPxR) . All clocks in the V   CORE   domain are stopped and the HSI48 and HSE oscillators disabled. The IWDG and the LSI oscillator can be kept running. The event of exiting Standby mode enables the HSI48 oscillator, selects HSISYS as system clock and sets its prescaler division factor to four (HSIDIV[2:0] = 010).  •   Shutdown mode  V   CORE   domain is powered off and the SRAM and register contents lost. All oscillators are disabled. The event of exiting Shutdown mode enables the HSI48 oscillator, selects HSISYS as system clock and sets its prescaler division factor to four (HSIDIV[2:0] = 010). In this mode, the supply voltage monitoring is disabled and the product behavior is not guaranteed in case of a power voltage drop.  Debug in low-power modes  By default, the debug connection is lost upon entering Stop, Shutdown, or Standby mode, as the core is no longer clocked.

RM0490 Rev 5   99/1027  RM0490   Power control (PWR)  117  However, specific settings in the DBGMCU_CR register allow debugging the software even in low-power modes. For more details, refer to   Section 30.9.1: Debug support for low-power modes.  Low-power mode entry and exit  The software controls low-power mode entry, selection, and exit through:  •   SEVONPEND, SLEEPDEEP, and SLEEPONEXIT bits of the Cortex ® -M0+ system control register  •   LPMS[2:0] bitfield of the   PWR control register 1 (PWR_CR1)  •   WFI (wait for interrupt) and WFE (wait for event) instructions (low-power mode entry stimuli)  •   NVIC, EXTI and peripheral pending interrupt and event flags  •   configuring return from ISR (interrupt service routine) as low-power mode entry stimulus  Entering low-power modes  Conditionally, the device enters low-power modes upon one of the following stimuli:  •   WFI (wait for interrupt) instruction  •   WFE (wait for event) instruction  •   return from ISR (when the SLEEPONEXIT bit is high) The low-power mode entry stimulus occurring while a low-power mode exit condition is met, is ignored (the low-power mode entry is aborted) and the program execution continues. For low-power modes other than Sleep, the low-power mode entry is delayed (as opposed to aborted) until a potential ongoing flash memory or APB access is terminated. The selection of the low-power mode to enter is determined by the SLEEPDEEP and LPMS[2:0] bitfields. Refer to the following table (including the table footnotes) for details about low-power mode entry conditions. All the conditions in a table row must be met for the corresponding low- power mode entry to occur.  Table 28. Low-power mode entry overview Low-power mode Low-power mode entry stimulus Condition   (1) SLEEPDEEP SLEEPONEXIT LPMS[2:0] Interrupt pending   (2) Event pending (3) WUFx bit set Flash memory access APB access  Sleep WFI   0   -   -   Aa   -   -   -   - WFE   0   -   -   -   Aa   -   -   - Return from ISR   0   1   -   Aa   -   -   -   - Stop WFI   1   -   000   Aa   -   -   Ad   Ad WFE   1   -   000   -   Aa   -   Ad   Ad Return from ISR   1   1   000   Aa   -   -   Ad   Ad

Power control (PWR)   RM0490  100/1027   RM0490 Rev 5  Exiting low-power modes  The device exits any low-power mode upon external reset on NRST pin. Additionally, it exits Sleep, Stop, and Standby modes upon BOR/PDR and IWDG reset, and Sleep and Stop modes upon a CSS detection on LSE. For all other low-power mode exit conditions, refer to the following table (including the table footnotes). All conditions in a table row must be met for the corresponding low-power mode exit to occur. Standby WFI   1   -   011   Aa   -   Aa   Ad   Ad WFE   1   -   011   -   Aa   Aa   Ad   Ad Return from ISR   1   1   011   Aa   -   Aa   Ad   Ad Shutdown WFI   1   -   1XX   Aa   -   Aa   Ad   Ad WFE   1   -   1XX   -   Aa   Aa   Ad   Ad Return from ISR   1   1   1XX   Aa   -   Aa   Ad   Ad 1.   “ - ” = don’t care or not applicable. “ X ” = don’t care (bit value). “ Aa ” = Absent/none; abort the low-power mode entry if present. “ Ad ” = Absent/none; delay the low-power mode entry as long as present. 2.   Any EXTI line interrupt flag (in   EXTI rising edge pending register 1 (EXTI_RPR1)   and   EXTI falling edge pending register 1 (EXTI_FPR1) ) or any peripheral wake-up interrupt flag is set. 3.   Any enabled EXTI event. For the sleep mode, also any peripheral event with the associated interrupt enabled in the peripheral.  Table 28. Low-power mode entry overview (continued) Low-power mode Low-power mode entry stimulus Condition   (1) SLEEPDEEP SLEEPONEXIT LPMS[2:0] Interrupt pending (2) Event pending (3) WUFx bit set Flash memory access APB access

RM0490 Rev 5   101/1027  RM0490   Power control (PWR)  117  Table 29. Low-power mode exit overview Low-power mode Mode entry stimulus Condition (1) Wake-up latency Upon exit SEVONPEND Peripheral event / Interrupt EXTI interrupt   (2) EXTI event (3) NVIC IRQ interrupt (4) WUFx bit Clock   HSIDIV [2:0]   (5)   SBF (6)  Sleep WFI or return from ISR -   E   -   -   R   - None   As before entry As before entry   0 -   E   R   -   E   - WFE 0   E   -   -   R   - 0   E   R   -   E   - 0   E   -   R   -   - 1   E   -   -   R   - 1   E   R   -   -   - 1   E   -   R   -   - Stop WFI or return from ISR -   E   R   -   E   - HSI48 / flash memory startup   (7) HSISYS   As before entry   0 WFE 0   E   R   -   E   - 0   E   -   R   -   - 1   E   R   -   -   - 1   E   -   R   -   - Standby   -   -   -   -   -   -   R   Reset phase   HSISYS   010   1 Shutdown   -   -   -   -   -   -   R   Reset phase   HSISYS   010   0 1.   “ - ” = don’t care or not applicable, “ E ” = enabled, “ R ” = enabled and raised. 2.   Any EXTI line set as unmasked in   EXTI CPU wake-up with interrupt mask register 1 (EXTI_IMR1) . 3.   Any EXTI line set as unmasked in   EXTI CPU wake-up with event mask register (EXTI_EMR1)  4.   Any IRQ interrupt listed in   Table 55: Vector table   and activated in the NVIC_ISER register (refer to the product programming manual). 5.   Bitfield of   RCC clock control register (RCC_CR) , controlling the HSISYS prescale. The value HSIDIV[2:0] = 010 corresponds to division by four. 6.   Flag in   PWR status register 1 (PWR_SR1) . 7.   The longer of HSI48 oscillator startup time and flash memory startup time (from Stop mode).

Power control (PWR)   RM0490  102/1027   RM0490 Rev 5  Note:   For any NVIC IRQ interrupt, EXTI interrupt or EXTI event, the table assumes that the mechanism is activated through the NVIC ISER, EXTI_IMR1, or EXTI_EMR1 register, respectively. For any interrupt or event, it also has to be activated in the peripheral. Some peripherals send their interrupt request signal to both NVIC and EXTI and can generate both NVIC IRQ and EXTI interrupts if configured to do so. Some other peripherals only send their interrupt signal to NVIC and they can therefore only generate an NVIC interrupt. The latter type of peripheral cannot wake the system up from Stop mode. Upon waking up from Sleep and Stop modes, the pending bits associated to the interrupt/event having woken up the system must be cleared. It may also be necessary to clear the interrupt flag in the peripheral. Upon waking up from Standby and Shutdown mode, the program execution restarts in the same way as upon a reset (boot pin sampling, option bytes loading, reset vector is fetched, and so on).  Auto-wake-up from Stop mode  The RTC can wake the device up from Stop mode at regular intervals, without any external stimulus. For this purpose, select LSI or LSE as RTC clock source, through the RTCSEL[1:0] bitfield of the   RCC control/status register 1 (RCC_CSR1) . The LSI oscillator does not require an external quartz and reduces the system cost, at expense of accuracy. The LSE oscillator with an external quartz ensures higher accuracy but it leads to an extra cost. To enable the wake-up from Stop mode with RTC alarm:  •   Configure the EXTI Line 19 to be sensitive to rising edge.  •   Configure the RTC to generate wake-up event.  5.4   PWR registers  The peripheral registers can be accessed by half-words (16-bit) or words (32-bit).  5.4.1   PWR control register 1 (PWR_CR1)  The register is reset after wake-up from Standby mode. Address offset: 0x00 Reset value: 0x0000 0208 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   FPD_ SLP   Res.   FPD_ STOP   LPMS[2:0] rw   rw   rw   rw   rw

RM0490 Rev 5   103/1027  RM0490   Power control (PWR)  117  5.4.2   PWR control register 1 (PWR_CR2)  This register applies to STM32C071xx only. On the other devices, it is reserved. Address offset: 0x04 Reset value: 0x0000 0100 Bits 31:6   Reserved, must be kept at reset value. Bit 5   FPD_SLP : Flash memory powered down during Sleep mode This bit determines whether the flash memory is put in power-down mode or remains in idle mode when the device enters Sleep mode. 0: Flash memory idle 1: Flash memory powered down Bit 4   Reserved, must be kept at reset value. Bit 3   FPD_STOP : Flash memory powered down during Stop mode This bit determines whether the flash memory is put in power-down mode or remains in idle mode when the device enters Stop mode. 0: Flash memory idle 1: Flash memory powered down Bits 2:0   LPMS[2:0] : Low-power mode selection These bits select the low-power mode entered when CPU enters deepsleep mode. 000: Stop mode 001: Reserved 010: Reserved 011: Standby mode 1XX: Shutdown mode 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   PVM_VDDIO2 [1:0]   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. rw   rw Bits 31:10   Reserved, must be kept at reset value. Bits 9:8   PVM_VDDIO2[1:0] : V DDIO2   supply voltage monitoring This bitfield controls the voltage monitoring of V   DDIO2   with respect to 1.2 V threshold (further  “monitoring” ) and the IOs on V DDIO2   domain (further   “IOs ”). 00: Monitoring disabled; IOs in isolation mode 01: Monitoring enabled; IOs enabled or in isolation mode according to V DDIO2   level 10: Monitoring bypassed; IOs enabled 11: Reserved Bits 7:0   Reserved, must be kept at reset value.

Power control (PWR)   RM0490  104/1027   RM0490 Rev 5  5.4.3   PWR control register 3 (PWR_CR3)  The register is not reset when exiting Standby mode and with the PWRRST bit of the   RCC APB peripheral reset register 1 (RCC_APBRSTR1) . Address offset: 0x08 Reset value: 0x0000 8000 Access: Requires three (writing) or two (reading) extra APB clock cycles, compared to standard APB access. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 EIWUL   Res.   Res.   Res.   Res.   APC   Res.   Res.   Res.   Res.   EWUP 6 EWUP 5 EWUP 4 EWUP 3 EWUP 2 EWUP 1 rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bit 15   EIWUL : Enable internal wake-up line When set, a rising edge on the internal wake-up line triggers a wake-up event. 0: Disable 1: Enable Bits 14:11   Reserved, must be kept at reset value. Bit 10   APC : Apply pull-up and pull-down configuration This bit determines whether the I/O pull-up and pull-down configurations defined in the PWR_PUCRx and PWR_PDCRx registers are applied. 0: Not applied 1: Applied Bits 9:6   Reserved, must be kept at reset value. Bit 5   EWUP6 : Enable WKUP6 wake-up pin When this bit is set, the WKUP6 external wake-up pin is enabled and triggers a wake-up event when a rising or a falling edge occurs. The active edge is configured through WP6 bit in the PWR_CR4 register. Bit 4   EWUP5 : Enable WKUP5 wake-up pin When this bit is set, the WKUP5 external wake-up pin is enabled and triggers a wake-up event when a rising or a falling edge occurs. The active edge is configured through WP5 bit in the PWR_CR4 register.  Note:   Only applicable to STM32C071xx and N/A, reserved on the other products.  Bit 3   EWUP4 : Enable WKUP4 wake-up pin When this bit is set, the WKUP4 external wake-up pin is enabled and triggers a wake-up event when a rising or a falling edge occurs. The active edge is configured via the WP4 bit in the PWR_CR4 register.

RM0490 Rev 5   105/1027  RM0490   Power control (PWR)  117  5.4.4   PWR control register 4 (PWR_CR4)  The register is not reset when exiting Standby mode and with the PWRRST bit of the   RCC APB peripheral reset register 1 (RCC_APBRSTR1) . Address offset: 0x0C Reset value: 0x0000 0000 Access: Requires three (writing) or two (reading) extra APB clock cycles, compared to standard APB access. Bit 2   EWUP3 : Enable WKUP3 wake-up pin When this bit is set, the WKUP3 external wake-up pin is enabled and triggers a wake-up event when a rising or a falling edge occurs. The active edge is configured via the WP3 bit of the PWR_CR4 register. Bit 1   EWUP2 : Enable WKUP2 wake-up pin When this bit is set, the WKUP2 external wake-up pin is enabled and triggers a wake-up event when a rising or a falling edge occurs. The active edge is configured via the WP2 bit of the PWR_CR4 register. Bit 0   EWUP1 : Enable WKUP1 wake-up pin When this bit is set, the WKUP1 external wake-up pin is enabled and triggers a wake-up event when a rising or a falling edge occurs. The active edge is configured via the WP1 bit of the PWR_CR4 register. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   WP6   WP5   WP4   WP3   WP2   WP1 rw   rw   rw   rw   rw   rw Bits 31:6   Reserved, must be kept at reset value. Bit 5   WP6 : WKUP6 wake-up pin polarity WKUP6 external wake-up signal polarity (level or edge) to generate wake-up condition: 0: High level or rising edge 1: Low level or falling edge Bit 4   WP5 : WKUP5 wake-up pin polarity WKUP5 external wake-up signal polarity (level or edge) to generate wake-up condition: 0: High level or rising edge 1: Low level or falling edge  Note:   Only applicable to STM32C071xx and N/A, reserved on the other products.  Bit 3   WP4 : WKUP4 wake-up pin polarity WKUP4 external wake-up signal polarity (level or edge) to generate wake-up condition: 0: High level or rising edge 1: Low level or falling edge

Power control (PWR)   RM0490  106/1027   RM0490 Rev 5  5.4.5   PWR status register 1 ( PWR_SR1   )  The register is not reset when exiting Standby mode and with the PWRRST bit of the   RCC APB peripheral reset register 1 (RCC_APBRSTR1) . Address offset: 0x10 Reset value: 0x0000 0000 Access: Requires two extra APB clock cycles, compared to standard APB access. Bit 2   WP3 : WKUP3 wake-up pin polarity WKUP3 external wake-up signal polarity (level or edge) to generate wake-up condition: 0: High level or rising edge 1: Low level or falling edge Bit 1   WP2 : WKUP2 wake-up pin polarity WKUP2 external wake-up signal polarity (level or edge) to generate wake-up condition: 0: High level or rising edge 1: Low level or falling edge Bit 0   WP1 : WKUP1 wake-up pin polarity WKUP1 external wake-up signal polarity (level or edge) to generate wake-up condition: 0: High level or rising edge 1: Low level or falling edge 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 WUFI   Res.   Res.   Res.   Res.   Res.   Res.   SBF   Res.   Res.   WUF6   WUF5   WUF4   WUF3   WUF2   WUF1 r   r   r   r   r   r   r   r Bits 31:16   Reserved, must be kept at reset value. Bit 15   WUFI : Wake-up flag internal This bit is set when a wake-up condition is detected on the internal wake-up line. It is cleared when all internal wake-up sources are cleared. Bits 14:9   Reserved, must be kept at reset value. Bit 8   SBF : Standby flag This bit is set by hardware when the device enters Standby mode and is cleared by setting the CSBF bit in the PWR_SCR register, or by a power-on reset. It is not cleared by the system reset. 0: The device did not enter Standby mode 1: The device entered Standby mode Bits 7:6   Reserved, must be kept at reset value. Bit 5   WUF6 : Wake-up flag 6 This bit is set when a wake-up condition is detected on WKUP6 wake-up pin. It is cleared by setting the CWUF6 bit of the PWR_SCR register.

RM0490 Rev 5   107/1027  RM0490   Power control (PWR)  117  5.4.6   PWR status register 2 (PWR_SR2)  This register is reset when exiting Standby/Shutdown modes. Address offset: 0x14 Reset value: 0x0000 0000 Bit 4   WUF5 : Wake-up flag 5 This bit is set when a wake-up condition is detected on WKUP5 wake-up pin. It is cleared by setting the CWUF5 bit of the PWR_SCR register.  Note:   Only applicable to STM32C071xx and N/A, reserved on the other products.  Bit 3   WUF4 : Wake-up flag 4 This bit is set when a wake-up condition is detected on WKUP4 wake-up pin. It is cleared by setting the CWUF4 bit of the PWR_SCR register. Bit 2   WUF3 : Wake-up flag 3 This bit is set when a wake-up condition is detected on WKUP3 wake-up pin. It is cleared by setting the CWUF3 bit of the PWR_SCR register. Bit 1   WUF2 : Wake-up flag 2 This bit is set when a wake-up condition is detected on WKUP2 wake-up pin. It is cleared by setting the CWUF2 bit of the PWR_SCR register. Bit 0   WUF1 : Wake-up flag 1 This bit is set when a wake-up condition is detected on WKUP1 wake-up pin. It is cleared by setting the CWUF1 bit of the PWR_SCR register. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res. PVM_ VDDIO2 _OUT Res.   Res.   Res.   Res.   Res.   FLASH _RDY   Res.   Res.   Res.   Res.   Res.   Res.   Res. r   r Bits 31:14   Reserved, must be kept at reset value. Bit 13   PVM_VDDIO2_OUT:   V DDIO2   supply voltage monitoring output flag This flag indicates the readiness of the V DDIO2   supply voltage (excess of 1.2 V). 0: Ready 1: Not ready The flag is read as zero when the PVM of V DDIO2   is disabled (PVM_VDDIO2[0] = 0).  Note:   Only applicable on STM32C071xx, reserved on the other products.

Power control (PWR)   RM0490  108/1027   RM0490 Rev 5  5.4.7   PWR status clear register (PWR_SCR)  Address offset: 0x18 Reset value: 0x0000 0000 Access: Requires three extra APB clock cycles, compared to standard APB access. Bits 12:8   Reserved, must be kept at reset value. Bit 7   FLASH_RDY:   Flash ready flag This bit is set by hardware to indicate when the flash memory is ready to be accessed after wake-up from power-down. To place the flash memory in power-down, set either FPD_SLP or FPD_STOP bit. 0: Flash memory in power-down 1: Flash memory ready to be accessed  Note:   If the system boots from SRAM, the user application must wait till FLASH_RDY bit is set, prior to jumping to flash memory.  Bits 6:0   Reserved, must be kept at reset value. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   CSBF   Res.   Res.   CWUF 6 CWUF 5 CWUF 4 CWUF 3 CWUF 2 CWUF 1 w   w   w   w   w   w   w Bits 31:9   Reserved, must be kept at reset value. Bit 8   CSBF : Clear standby flag Setting this bit clears the SBF flag in the PWR_SR1 register. Bits 7:6   Reserved, must be kept at reset value. Bit 5   CWUF6 : Clear wake-up flag 6 Setting this bit clears the WUF6 flag in the PWR_SR1 register. Bit 4   CWUF5 : Clear wake-up flag 5 Setting this bit clears the WUF5 flag in the PWR_SR1 register.  Note:   Only applicable to STM32C071xx and N/A, reserved on the other products.  Bit 3   CWUF4 : Clear wake-up flag 4 Setting this bit clears the WUF4 flag in the PWR_SR1 register. Bit 2   CWUF3 : Clear wake-up flag 3 Setting this bit clears the WUF3 flag in the PWR_SR1 register. Bit 1   CWUF2 : Clear wake-up flag 2 Setting this bit clears the WUF2 flag in the PWR_SR1 register. Bit 0   CWUF1 : Clear wake-up flag 1 Setting this bit clears the WUF1 flag in the PWR_SR1 register.

RM0490 Rev 5   109/1027  RM0490   Power control (PWR)  117  5.4.8   PWR Port A pull-up control register (PWR_PUCRA)  The register is not reset when exiting Standby mode and with the PWRRST bit of the   RCC APB peripheral reset register 1 (RCC_APBRSTR1) . Address offset: 0x20 Reset value: 0x0000 0000 Access: Requires three (writing) or two (reading) extra APB clock cycles, compared to standard APB access.  5.4.9   PWR Port A pull-down control register (PWR_PDCRA)  The register is not reset when exiting Standby mode and with the PWRRST bit of the   RCC APB peripheral reset register 1 (RCC_APBRSTR1) . Address offset: 0x24 Reset value: 0x0000 0000 Access: Requires three (writing) or two (reading) extra APB clock cycles, compared to standard APB access. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 PU15   PU14   PU13   PU12   PU11   PU10   PU9   PU8   PU7   PU6   PU5   PU4   PU3   PU2   PU1   PU0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   PUi : Port A pull-up bit i (i = 15 to 0) Setting PUi bit while the corresponding PDi bit is zero and the APC bit of the PWR_CR3 register is set activates a pull-up device on the PA[i] I/O.  Note:   For the same pin, this pull-up device must not be activated when a pull-down device is set through the GPIOx_PUPDR register.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 PD15   PD14   PD13   PD12   PD11   PD10   PD9   PD8   PD7   PD6   PD5   PD4   PD3   PD2   PD1   PD0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   PDi : Port A pull-down bit i (i = 15 to 0) Setting PDi bit while the APC bit of the PWR_CR3 register is set activates a pull-down device on the PA[i] I/O.  Note:   For the same pin, this pull-down device must not be activated when a pull-up device is set through the GPIOx_PUPDR register.

Power control (PWR)   RM0490  110/1027   RM0490 Rev 5  5.4.10   PWR Port B pull-up control register (PWR_PUCRB)  The register is not reset when exiting Standby mode and with the PWRRST bit of the   RCC APB peripheral reset register 1 (RCC_APBRSTR1) . Address offset: 0x28 Reset value: 0x0000 0000 Access: Requires three (writing) or two (reading) extra APB clock cycles, compared to standard APB access.  5.4.11   PWR Port B pull-down control register (PWR_PDCRB)  The register is not reset when exiting Standby mode and with the PWRRST bit of the   RCC APB peripheral reset register 1 (RCC_APBRSTR1) . Address offset: 0x2C Reset value: 0x0000 0000 Access: Requires three (writing) or two (reading) extra APB clock cycles, compared to standard APB access. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 PU15   PU14   PU13   PU12   PU11   PU10   PU9   PU8   PU7   PU6   PU5   PU4   PU3   PU2   PU1   PU0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   PUi : Port B pull-up bit i (i = 15 to 0) Setting PUi bit while the corresponding PDi bit is zero and the APC bit of the PWR_CR3 register is set activates a pull-up device on the PB[i] I/O.  Note:   On STM32C011xx, only PU7 and PU6 are available. For the same pin, this pull-up device must not be activated when a pull-down device is set through the GPIOx_PUPDR register.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 PD15   PD14   PD13   PD12   PD11   PD10   PD9   PD8   PD7   PD6   PD5   PD4   PD3   PD2   PD1   PD0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

RM0490 Rev 5   111/1027  RM0490   Power control (PWR)  117  5.4.12   PWR Port C pull-up control register (PWR_PUCRC)  The register is not reset when exiting Standby mode and with the PWRRST bit of the   RCC APB peripheral reset register 1 (RCC_APBRSTR1) . Address offset: 0x30 Reset value: 0x0000 0000 Access: Requires three (writing) or two (reading) extra APB clock cycles, compared to standard APB access.  5.4.13   PWR Port C pull-down control register (PWR_PDCRC)  The register is not reset when exiting Standby mode and with the PWRRST bit of the   RCC APB peripheral reset register 1 (RCC_APBRSTR1) . Address offset: 0x34 Reset value: 0x0000 0000 Access: Requires three (writing) or two (reading) extra APB clock cycles, compared to standard APB access. Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   PDi : Port B pull-down bit i (i = 15 to 0) Setting PDi bit while the APC bit of the PWR_CR3 register is set activates a pull-down device on the PB[i] I/O.  Note:   On STM32C011xx, only PD7 and PD6 are available. For the same pin, this pull-down device must not be activated when a pull-up device is set through the GPIOx_PUPDR register.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 PU15   PU14   PU13   PU12   PU11   PU10   PU9   PU8   PU7   PU6   PU5   PU4   PU3   PU2   PU1   PU0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   PUi : Port C pull-up bit i (i = 15 to 0) Setting PUi bit while the corresponding PDi bit is zero and the APC bit of the PWR_CR3 register is set activates a pull-up device on the PC[i] I/O.  Note:   On STM32C011xx, only PU15 and PU14 are available. On STM32C031xx and STM32C051xx, only PU15 to PU13, PU7, and PU6 are available. For the same pin, this pull-up device must not be activated when a pull-down device is set through the GPIOx_PUPDR register.

Power control (PWR)   RM0490  112/1027   RM0490 Rev 5  5.4.14   PWR Port D pull-up control register (PWR_PUCRD)  The register is not reset when exiting Standby mode and with the PWRRST bit of the   RCC APB peripheral reset register 1 (RCC_APBRSTR1) . Address offset: 0x38 Reset value: 0x0000 0000 Access: Requires three (writing) or two (reading) extra APB clock cycles, compared to standard APB access. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 PD15   PD14   PD13   PD12   PD11   PD10   PD9   PD8   PD7   PD6   PD5   PD4   PD3   PD2   PD1   PD0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   PDi : Port C pull-down bit i (i = 15 to 0) Setting PDi bit while the APC bit of the PWR_CR3 register is set activates a pull-down device on the PC[i] I/O.  Note:   On STM32C011xx, only PD15 and PD14 are available. On STM32C031xx and STM32C051xx, only PD15 to PD13, PD7, and PD6 are available. For the same pin, this pull-down device must not be activated when a pull-up device is set through the GPIOx_PUPDR register.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   PU9   PU8   Res.   PU6   PU5   PU4   PU3   PU2   PU1   PU0 rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:10   Reserved, must be kept at reset value.

RM0490 Rev 5   113/1027  RM0490   Power control (PWR)  117  5.4.15   PWR Port D pull-down control register (PWR_PDCRD)  The register is not reset when exiting Standby mode and with the PWRRST bit of the   RCC APB peripheral reset register 1 (RCC_APBRSTR1) . Address offset: 0x3C Reset value: 0x0000 0000 Access: Requires three (writing) or two (reading) extra APB clock cycles, compared to standard APB access. Bits 9:8   PUi : Port D pull-up bit i (i = 9 to 8) Setting PUi bit while the corresponding PDi bit is zero and the APC bit of the PWR_CR3 register is set activates a pull-up device on the PD[i] I/O.  Note:   Only available on STM32C071xx and STM32C091xx/92xx. For the same pin, this pull-up device must not be activated when a pull-down device is set through the GPIOx_PUPDR register.  Bit 7   Reserved, must be kept at reset value. Bits 6:0   PUi : Port D pull-up bit i (i = 6 to 0) Setting PUi bit while the corresponding PDi bit is zero and the APC bit of the PWR_CR3 register is set activates a pull-up device on the PD[i] I/O.  Note:   Not available on STM32C011xx. On STM32C031xx and STM32C051xx, only PU3 to PU0 are available. For the same pin, this pull-up device must not be activated when a pull-down device is set through the GPIOx_PUPDR register.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   PD9   PD8   Res.   PD6   PD5   PD4   PD3   PD2   PD1   PD0 rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:10   Reserved, must be kept at reset value. Bits 9:8   PDi : Port D pull-down bit i (i = 9 to 8) Setting PDi bit while the APC bit of the PWR_CR3 register is set activates a pull-down device on the PD[i] I/O.  Note:   Only available on STM32C071xx and STM32C091xx/92xx. For the same pin, this pull-down device must not be activated when a pull-up device is set through the GPIOx_PUPDR register.  Bit 7   Reserved, must be kept at reset value. Bits 6:0   PDi : Port D pull-down bit i (i = 6 to 0) Setting PDi bit while the APC bit of the PWR_CR3 register is set activates a pull-down device on the PD[i] I/O.  Note:   Not available on STM32C011xx. On STM32C031xx and STM32C051xx, only PD3 to PD0 are available. For the same pin, this pull-down device must not be activated when a pull-up device is set through the GPIOx_PUPDR register.

Power control (PWR)   RM0490  114/1027   RM0490 Rev 5  5.4.16   PWR Port F pull-up control register (PWR_PUCRF)  The register is not reset when exiting Standby mode and with the PWRRST bit of the   RCC APB peripheral reset register 1 (RCC_APBRSTR1) . Address offset: 0x48 Reset value: 0x0000 0000 Access: Requires three (writing) or two (reading) extra APB clock cycles, compared to standard APB access.  5.4.17   PWR Port F pull-down control register (PWR_PDCRF)  The register is not reset when exiting Standby mode and with the PWRRST bit of the   RCC APB peripheral reset register 1 (RCC_APBRSTR1) . Address offset: 0x4C Reset value: 0x0000 0000 Access: Requires three (writing) or two (reading) extra APB clock cycles, compared to standard APB access. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   PU3   PU2   PU1   PU0 rw   rw   rw   rw Bits 31:4   Reserved, must be kept at reset value. Bits 3:0   PUi : Port F pull-up bit i (i = 3 to 0) Setting PUi bit while the corresponding PDi bit is zero and the APC bit of the PWR_CR3 register is set activates a pull-up device on the PF[i] I/O.  Note:   On STM32C011xx, only PU2 is available. On STM32C031xx, only PU2 to PU0 are available. For the same pin, this pull-up device must not be activated when a pull-down device is set through the GPIOx_PUPDR register.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   PD3   PD2   PD1   PD0 rw   rw   rw   rw

RM0490 Rev 5   115/1027  RM0490   Power control (PWR)  117  5.4.18   PWR backup x register (PWR_BKPxR)  The register is not reset when exiting Standby mode and with the PWRRST bit of the   RCC APB peripheral reset register 1 (RCC_APBRSTR1) . Address offset: 0x070 + 0x04 * x, (x = 0 to 3) Reset value: 0x0000 0000 Access: Requires three (writing) or two (reading) extra APB clock cycles, compared to standard APB access.  5.4.19   PWR register map  Bits 31:4   Reserved, must be kept at reset value. Bits 3:0   PDi : Port F pull-down bit i (i = 3 to 0) Setting PDi bit while the APC bit of the PWR_CR3 register is set activates a pull-down device on the PF[i] I/O.  Note:   On STM32C011xx, only PD2 is available. On STM32C031xx, only PD2 to PD0 are available. For the same pin, this pull-down device must not be activated when a pull-up device is set through the GPIOx_PUPDR register.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 BKP[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   BKP[15:0] : Backup bitfield This bitfield retains information when the device is in Standby.  Table 30. PWR register map and reset values Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x000   PWR_CR1 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. FPD_SLP Res. FPD_STOP LPMS [2:0] Reset value   0   1   0   0   0

Power control (PWR)   RM0490  116/1027   RM0490 Rev 5  0x004   PWR_CR2 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PVM_VDDIO2[1:0] Res. Res. Res. Res. Res. Res. Res. Res. Reset value   0   1 0x008   PWR_CR3 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. EIWUL Res. Res. Res. Res. APC Res. Res. Res. Res. EWUP6 EWUP5 EWUP4 EWUP3 EWUP2 EWUP1 Reset value   1   0   0   0   0   0   0   0 0x00C   PWR_CR4 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. WP6 WP5 WP4 WP3 WP2 WP1 Reset value   0   0   0   0   0   0 0x010   PWR_SR1 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. WUFI Res. Res. Res. Res. Res. Res. SBF Res. Res. WUF6 WUF5 WUF4 WUF3 WUF2 WUF1 Reset value   0   0   0   0   0   0   0   0 0x014   PWR_SR2 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PVM_VDDIO2_OUT Res. Res. Res. Res. Res. FLASH_RDY Res. Res. Res. Res. Res. Res. Res. Reset value   0   0 0x018   PWR_SCR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CSBF Res. Res. CWUF6 CWUF5 CWUF4 CWUF3 CWUF2 CWUF1 Reset value   0   0   0   0   0   0   0 0x020   PWR_PUCRA Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PU15 PU14 PU13 PU12 PU11 PU10 PU9 PU8 PU7 PU6 PU5 PU4 PU3 PU2 PU1 PU0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x024   PWR_PDCRA Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PD15 PD14 PD13 PD12 PD11 PD10 PD9 PD8 PD7 PD6 PD5 PD4 PD3 PD2 PD1 PD0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x028   PWR_PUCRB Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PU15 PU14 PU13 PU12 PU11 PU10 PU9 PU8 PU7 PU6 PU5 PU4 PU3 PU2 PU1 PU0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x02C   PWR_PDCRB Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PD15 PD14 PD13 PD12 PD11 PD10 PD9 PD8 PD7 PD6 PD5 PD4 PD3 PD2 PD1 PD0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x030   PWR_PUCRC Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PU15 PU14 PU13 PU12 PU11 PU10 PU9 PU8 PU7 PU6 PU5 PU4 PU3 PU2 PU1 PU0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x034   PWR_PDCRC Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PD15 PD14 PD13 PD12 PD11 PD10 PD9 PD8 PD7 PD6 PD5 PD4 PD3 PD2 PD1 PD0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x038   PWR_PUCRD Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PU9 PU8 Res. PU6 PU5 PU4 PU3 PU2 PU1 PU0 Reset value   0   0   0   0   0   0   0   0   0  Table 30. PWR register map and reset values (continued) Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

RM0490 Rev 5   117/1027  RM0490   Power control (PWR)  117  Refer to   Section 2.2 on page 45   for the register boundary addresses. 0x03C   PWR_PDCRD Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PD9 PD8 Res. PD6 PD5 PD4 PD3 PD2 PD1 PD0 Reset value   0   0   0   0   0   0   0   0   0 0x040- 044   Reserved Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. 0x048   PWR_PUCRF Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PU3 PU2 PU1 PU0 Reset value   0   0   0   0 0x04C   PWR_PDCRF Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PD3 PD2 PD1 PD0 Reset value   0   0   0   0 0x050- 06C   Reserved Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. 0x070   PWR_BKP0R Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. BKP[15:0] Reset value   rw rw rw rw rw rw rw rw rw rw rw rw rw rw rw rw 0x074   PWR_BKP1R Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. BKP[15:0] Reset value   rw rw rw rw rw rw rw rw rw rw rw rw rw rw rw rw 0x078   PWR_BKP2R Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. BKP[15:0] Reset value   rw rw rw rw rw rw rw rw rw rw rw rw rw rw rw rw 0x07C   PWR_BKP3R Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. BKP[15:0] Reset value   rw rw rw rw rw rw rw rw rw rw rw rw rw rw rw rw  Table 30. PWR register map and reset values (continued) Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

Reset and clock control (RCC)   RM0490  118/1027   RM0490 Rev 5  6   Reset and clock control (RCC) 6.1   Reset  There are three types of reset, defined as system reset, power reset and RTC domain reset.  6.1.1   Power reset  A power reset is generated when one of the following events occurs:  •   power-on reset (POR) or brown-out reset (BOR)  •   exit from Standby mode  •   exit from Shutdown mode Power and brown-out reset set all registers to their reset values. When exiting Standby mode, all registers in the V   CORE   domain are set to their reset value. Registers outside the V   CORE   domain (WKUP, IWDG, and Standby/Shutdown mode control) are not impacted. When exiting Shutdown mode, the brown-out reset is generated, resetting all registers.  6.1.2   System reset  System reset sets all registers to their reset values except the reset flags in the RCC control/status register 2 (RCC_CSR2) and the registers in the RTC domain. System reset is generated when one of the following events occurs:  •   low level on NRST (external reset)  •   window watchdog event (WWDG reset)  •   independent watchdog event (IWDG reset)  •   software reset (SW reset) (see   Software reset )  •   low-power mode security reset (see   Low-power mode security reset )  •   option byte loader reset (see   Option byte loader reset )  •   power-on reset The reset source can be identified by checking the reset flags in the RCC_CSR register (see   Section 6.4.23: RCC control/status register 2 (RCC_CSR2) ).  NRST (external reset)  Through specific option bits, the PF2-NRST pin is configurable for operating as:  •   Reset input/output   (default at device delivery) Valid reset signal on the pin is propagated to the internal logic, and each internal reset source is led to a pulse generator the output of which drives this pin. The GPIO functionality (PF2) is not available. The pulse generator guarantees a minimum reset pulse duration of 20 μs for each internal reset source to be output on the NRST pin. An internal reset holder option can be used, if enabled in the   FLASH option register (FLASH_OPTR) , to ensure that the pin is pulled low until its voltage meets V IL threshold. This function allows the detection of internal reset sources by external components when the line faces a significant capacitive load. The BOOT0 pin is

RM0490 Rev 5   119/1027  RM0490   Reset and clock control (RCC)  165  sampled on NRST rising edge, regardless whether caused by internal or external resets.  •   Reset   input  In this mode, any valid reset signal on the NRST pin is propagated to device internal logic, but resets generated internally by the device are not visible on the pin. The GPIO functionality (PF2) is not available. The BOOT0 pin is sampled on POR and any subsequent NRST rising edge, caused by external resets. Other internal resets do not trigger new BOOT0 sampling.  •   GPIO  In this mode, the pin can be used as PF2 GPIO. The reset function of the pin is not available. Reset is only possible from device internal reset sources and it is not propagated to the pin. Refer to   Section 8.3.15: Reset pin (PF2-NRST) in GPIO mode  for additional considerations for this mode. The BOOT0 pin is sampled on the POR NRST rising edge only. Subsequent internal resets or transitions on the PF2 GPIO do not trigger new BOOT0 sampling.  Caution:   Upon power reset or wake-up from Standby or Shutdown mode, the NRST pin is configured as Reset input/output and driven low by the system until it is reconfigured to the expected mode when the option bytes are loaded, in the fourth clock cycle after the end of t RSTTEMPO time (see datasheet).  Figure 8. Simplified diagram of the reset circuit Software reset  The SYSRESETREQ bit in Cortex ® -M0+ Application interrupt and reset control register must be set to force a software reset on the device (refer to the programming manual PM0223).  MSv47935V1 External reset V   DD R   PU Internal reset sources NRST System reset Filter Pulse generator (min 20   ȝ s) D   Q CLEAR Bidirectional reset Reset holder

Reset and clock control (RCC)   RM0490  120/1027   RM0490 Rev 5  Low-power mode security reset  To prevent that critical applications mistakenly enter a low-power mode, low-power mode security resets are available. If enabled in option bytes, the resets are generated in the following conditions:  •   Entering Standby mode  This type of reset is enabled by resetting nRST_STDBY bit in user option bytes. In this case, whenever a Standby mode entry sequence is successfully executed, the device is reset instead of entering Standby mode.  •   Entering Stop mode  This type of reset is enabled by resetting nRST_STOP bit in user option bytes. In this case, whenever a Stop mode entry sequence is successfully executed, the device is reset instead of entering Stop mode.  •   Entering Shutdown mode  This type of reset is enabled by resetting nRST_SHDW bit in user option bytes. In this case, whenever a Shutdown mode entry sequence is successfully executed, the device is reset instead of entering Shutdown mode. For further information on the user option bytes, refer to   Section 4.4.1: FLASH option byte description .  Option byte loader reset  The option byte loader reset is generated when the OBL_LAUNCH bit is set in the FLASH_CR register. This bit is used to launch the option byte loading by software.  6.1.3   RTC domain reset  The RTC domain has two specific resets. A RTC domain reset is generated when one of the following events occurs:  •   Software reset , triggered by setting the RTCRST bit of the   RCC control/status register 1 (RCC_CSR1) .  •   V   DD   power on . RTC domain reset only affects the LSE oscillator, the RTC, and the RCC control/status register 1.

RM0490 Rev 5   121/1027  RM0490   Reset and clock control (RCC)  165  6.2   Clocks  The device provides the following clock sources producing primary clocks:  •   HSI48 RC   - a high-speed fully-integrated RC oscillator producing   HSI48   clock (48 MHz)  •   HSIUSB48 RC   - - a high-speed fully-integrated RC oscillator producing   HSIUSB48  clock for USB (about 48 MHz)  •   HSE OSC   - a high-speed oscillator with external crystal/ceramic resonator or external clock source, producing   HSE   clock (4 to 48 MHz)  •   LSI RC   - a low-speed fully-integrated RC oscillator producing   LSI   clock (about 32 kHz)  •   LSE OSC   - a low-speed oscillator with external crystal/ceramic resonator or external clock source, producing   LSE   clock (accurate 32.768 kHz or external clock up to 1 MHz)  •   I2S_CKIN   - pin for direct clock input for I2S1 peripheral Each oscillator can be switched on or off independently when it is not used, to optimize power consumption. Check sub-sections of this section for more functional details. For electrical characteristics of the internal and external clock sources, refer to the device datasheet. The device produces secondary clocks by dividing the primary clocks:  •   HSISYS   - a clock derived from HSI48 through division by a factor programmable from 1 to 128  •   SYSCLK   - a clock obtained through selecting one of LSE, LSI, HSE, HSIUSB48, and HSISYS clocks  •   HSIKER   - a clock derived from HSI48 through division by a factor programmable from 1 to 8  •   HCLK   - a clock derived from SYSCLK through division by a factor programmable from 1 to 512  •   HCLK8   - a clock derived from HCLK through division by eight  •   PCLK   - a clock derived from HCLK through division by a factor programmable from 1 to 16  •   TIMPCLK   - a clock derived from PCLK, running at PCLK frequency if the APB prescaler division factor is set to 1, or at twice the PCLK frequency otherwise More secondary clocks are generated by fixed division of HSE, HSI48 and HCLK clocks. The HSISYS is used as system clock source after startup from reset, with the division by four (producing 12 MHz frequency). The HCLK clock and PCLK clock are used for clocking the AHB and the APB domains, respectively. Their maximum allowed frequency is 48 MHz. The peripherals are clocked with the clocks from the bus they are attached to (HCLK for AHB, PCLK for APB) except:  •   TIMx  –   TIMPCLK running at PCLK frequency if the APB prescaler division factor is set to 1, or at twice the PCLK frequency otherwise

Reset and clock control (RCC)   RM0490  122/1027   RM0490 Rev 5  •   USART1 , with these clock sources to select from: –   SYSCLK (system clock) –   HSIKER –   LSE –   PCLK (APB clock) The wake-up from Stop mode is supported only when the clock is HSI48 or LSE.  •   ADC , with these clock sources to select from: –   SYSCLK (system clock) –   HSIKER  •   I2C1 , with these clock sources to select from: –   SYSCLK (system clock) –   HSIKER –   PCLK (APB clock) The wake-up from Stop mode is supported only when the clock is HSI48.  •   I2S1 , with these clock sources to select from: –   SYSCLK (system clock) –   HSIKER –   I2S_CKIN pin  •   RTC , with these clock sources to select from: –   LSE –   LSI –   HSE clock divided by 32 The functionality in Stop mode (including wake-up) is supported only when the clock is LSI or LSE.  •   IWDG , always clocked with LSI clock.  •   USB , with these clock sources to select from: –   HSE –   HSIUSB48  •   FDCAN1 , with these clock sources to select from: –   PCLK –   HSIKER –   HSE  •   SysTick   (Cortex   ®   core system timer), with these clock sources to select from: –   HCLK (AHB clock) –   HCLK clock divided by 8 The selection is done through SysTick control and status register. HCLK is used as Cortex   ® -M0+ free-running clock (FCLK). For more details, refer to the programming manual PM0223.

RM0490 Rev 5   123/1027  RM0490   Reset and clock control (RCC)  165  Figure 9. Clock tree  1.   TIMPCLK runs at PCLK frequency if the APB prescaler division factor is set to 1, or at twice the PCLK frequency otherwise. 2.   Only applies to STM32C071xx. 3.   Only applies to STM32C051xx, STM32C071xx, and STM32C091xx/92xx. 4.   Only applies to STM32C092xx. 5.   128 for STM32C011xx and STM32C031xx, 1024 for STM32C051xx, STM32C071xx, STM32C091xx, and STM32C092xx.  6.2.1   HSE clock  The high speed external clock signal (HSE) can be generated from two possible clock sources:  •   HSE external crystal/ceramic resonator  •   HSE user external clock  MSv66111V5 MCO LSCO async clock to ADC to IWDG to RTC to PWR HCLK to AHB bus, core, memory and DMA FCLK Cortex free-running clock to Cortex system timer to APB peripherals PCLK to I2S1 LSE SYSCLK to USART1 to I2C1  I2S_CKIN  OSC32_OUT OSC32_IN LSI LSE HSE SYSCLK  HSE  HSISYS   SYSCLK OSC_OUT OSC_IN LSI RC 32 kHz HSIKER HSIKER LSE LSI /32 AHB PRESC / 1,2,4,..,512 / 1,2,…,128, ,1024   (5) HSE OSC 4-48 MHz Clock detector APB PRESC / 1,2,4,8,16 / 8  LSI  HSE  LSE  SYSCLK I2S_CKIN SYSCLK SYSCLK  BOLD:   clock origin LSE LSI LSE LSI HSE PCLK PCLK HSISYS HCLK8 LSE OSC 32.768 kHz Clock detector HSI48 RC 48 MHz  HSI48  HSI48 MCO2   / 1,2,…,128, ,1024   (5) HSIKER HSIKER HSIKER to TIMx x1, x2 TIMPCLK /1,2,4,…,128 /1,2,3,…,8 RTCCLK (1) HSIUSB48   (2) RC 48 MHz   HSIUSB48  to USB   (2) HSIUSB48 HSE HSIUSB48   (2) SYSDIV   (3) / 1,2,3,...8 CRS   (2) to FDCAN1   (4) PCLK HSIKER HSE

Reset and clock control (RCC)   RM0490  124/1027   RM0490 Rev 5  The resonator and the load capacitors have to be placed as close as possible to the oscillator pins in order to minimize output distortion and startup stabilization time. The loading capacitance values must be adjusted according to the selected oscillator.  Figure 10. HSE/ LSE clock sources External crystal/ceramic resonator (HSE crystal)  The 4 to 48 MHz external oscillator has the advantage of producing a very accurate rate on the main clock. The associated hardware configuration is shown in   Figure 10 . Refer to the electrical characteristics section of the   datasheet   for more details. The HSERDY flag in the   RCC clock control register (RCC_CR)   indicates if the HSE oscillator is stable or not. At startup, the clock is not released until this bit is set by hardware. An interrupt can be generated if enabled in the   RCC clock interrupt enable register (RCC_CIER) . The HSE Crystal can be switched on and off using the HSEON bit in the   RCC clock control register (RCC_CR) .  External source (HSE bypass)  In this mode, an external clock source must be provided. It can have a frequency of up to 48 MHz. This mode is selected by setting the HSEBYP and HSEON   bits in the   RCC clock control register (RCC_CR) . The external clock signal (square, sinus or triangle - refer to the datatsheet) must drive the OSC_IN pin, on devices where OSC_IN and OSC_OUT pins are available (see   Figure 10 ). The OSC_OUT pin can be used as a GPIO.  Clock source   Hardware configuration  External clock Crystal/Ceramic resonators OSC_OUT External source  GPIO  OSC_IN  (OSC_EN as AF)  OSC_IN   OSC_OUT Load capacitors C   L2 C   L1

RM0490 Rev 5   125/1027  RM0490   Reset and clock control (RCC)  165  The OSC_OUT pin can be used as a GPIO or it can be configured as OSC_EN alternate function, to provide an enable signal to external clock synthesizer. The OSC_EN output is high when the external HSE clock is required and low when the external HSE clock can be switched off. It allows stopping the external clock source when the device enters low power modes.  Note:   For details on pin availability, refer to the pinout section in the corresponding device datasheet.  To minimize the consumption, it is recommended to use the square signal.  6.2.2   HSI48 clock  The HSI48 clock signal is generated from an internal 48 MHz RC oscillator. The HSI48 RC oscillator has the advantage of providing a clock source at low cost (no external components). It also has a faster startup time than the HSE crystal oscillator. However, even after calibration, it is less accurate than an oscillator using a frequency reference such as quartz crystal or ceramic resonator. The HSISYS clock derived from HSI48 can be selected as system clock after wake-up from Stop mode. Refer to   Section 6.3: Low-power modes . It can also be used as a backup clock source (auxiliary clock) if the HSE crystal oscillator fails. Refer to   Section 6.2.7: Clock security system (CSS) .  Calibration  RC oscillator frequencies can vary from one chip to another due to manufacturing process variations. To compensate for this variation, each device is factory calibrated to 1 % accuracy at T   A   =25°C. After reset, the factory calibration value is loaded in the HSICAL[7:0] bits in the   RCC internal clock source calibration register (RCC_ICSCR) . Voltage or temperature variations in the application may affect the HSI48 frequency of the RC oscillator. It can be trimmed using the HSITRIM[6:0] bits in the   RCC internal clock source calibration register (RCC_ICSCR) . For more details on how to measure the HSI48 frequency variation, refer to   Section 6.2.14: Internal/external clock measurement with TIM14/TIM16/TIM17 . The HSIRDY flag in the   RCC clock control register (RCC_CR)   indicates if the HSI48 RC is stable or not. At startup, the HSI48 RC output clock is not released until this bit is set by hardware. The HSI48 RC can be switched on and off using the HSION bit in the   RCC clock control register (RCC_CR) . The HSI48 signal can also be used as a backup source (auxiliary clock) if the HSE crystal oscillator fails. Refer to   Section 6.2.7: Clock security system (CSS) on page 127 .  6.2.3   HSIUSB48 clock  Available on the STM32C071xx devices only, the HSIUSB48 clock signal is generated from an internal 48 MHz RC oscillator. It can be used as clock source for the USB peripheral or system clock.

Reset and clock control (RCC)   RM0490  126/1027   RM0490 Rev 5  The HSIUSB48 clock is of high-precision thanks to the clock recovery system (CRS). The CRS uses the USB SOF signal, the LSE clock or an external signal as timing reference, to precisely adjust the HSIUSB48 RC oscillator frequency. The HSIUSB48 RC oscillator is disabled as soon as the system enters Stop or Standby mode. When the CRS is not used, the HSIUSB48 RC oscillator runs on its free-run frequency that is subject to manufacturing process variations. The devices are factory-calibrated for about 3 % accuracy at T   A   = 25°C. Refer to the CRS section for more details on how to configure and use it. The HSIUSB48RDY flag in the RCC_CR register indicates if HSIUSB48 is stable or not. At startup, the HSIUSB48 clock is not released until the hardware sets this flag. The HSIUSB48 RC oscillator is enabled/disabled through the HSIUSB48ON bit of the RCC_CR register. It is automatically enabled (by hardware setting the HSIUSB48ON bit) when selected as clock source for the USB peripheral, as long as the USB peripheral is enabled. Furthermore, it is possible to output the HSIUSB48 clock through the MCO and MCO2 outputs and use it as a clock source for other application components.  6.2.4   LSE clock  The LSE crystal is a 32.768 kHz crystal or ceramic resonator. It has the advantage of providing a low-power but highly accurate clock source to the real-time clock peripheral (RTC) for clock/calendar or other timing functions. The LSE crystal is switched on and off using the LSEON bit of   RCC control/status register 1 (RCC_CSR1) . The crystal oscillator driving strength can be changed at runtime using the LSEDRV bit of the   RCC control/status register 1 (RCC_CSR1)   to obtain the best compromise between robustness and short start-up time on one side and low-power- consumption on the other side. The LSE drive can be decreased to the lower drive capability (LSEDRV cleared) when the LSE is ON. However, once LSEDRV is selected, the drive capability can not be increased if LSEON is set. The LSERDY flag in the   RCC control/status register 1 (RCC_CSR1)   indicates whether the LSE crystal is stable or not. At startup, the LSE crystal output clock signal is not released until this bit is set by hardware. An interrupt can be generated if enabled in the   RCC clock recovery RC register (RCC_CRRCR) .  External source (LSE bypass)  In this mode, an external clock source must be provided. It can have a frequency of up to 1 MHz. This mode is selected by setting the LSEBYP and LSEON bits in the   RCC AHB peripheral clock enable in Sleep/Stop mode register (RCC_AHBSMENR) . The external clock signal (square, sinus or triangle - refer to the datasheet) has to drive the OSCX_IN pin while the OSCX_OUT pin can be used as GPIO. See   Figure 10 .  6.2.5   LSI clock  The LSI RC acts as a low-power clock source that can be kept running in Stop and Standby mode for the independent watchdog (IWDG) and RTC. The clock frequency is 32 kHz. For more details, refer to the electrical characteristics section of the datasheets.

RM0490 Rev 5   127/1027  RM0490   Reset and clock control (RCC)  165  The LSI RC can be switched on and off using the LSION bit in the   RCC control/status register 2 (RCC_CSR2) . The LSIRDY flag in the   RCC control/status register 2 (RCC_CSR2)   indicates if the LSI oscillator is stable or not. At startup, the clock is not released until this bit is set by hardware. An interrupt can be generated if enabled in the   RCC clock recovery RC register (RCC_CRRCR) .  6.2.6   System clock (SYSCLK) selection  One of the following clocks can be selected as system clock (SYSCLK):  •   LSI  •   LSE  •   HSISYS  •   HSE  •   HSIUSB48 The system clock maximum frequency is 48 MHz. Upon system reset, the HSISYS clock derived from HSI48 oscillator is selected as system clock. When a clock source is used as a system clock, it is not possible to stop it. A switch from one clock source to another occurs only if the target clock source is ready (clock stable after startup delay). If a clock source which is not yet ready is selected, the switch occurs when the clock source becomes ready. Status bits in the   RCC clock control register (RCC_CR)   indicate which clock(s) is (are) ready and the   RCC clock configuration register (RCC_CFGR)   indicates which clock is currently used as a system clock.  6.2.7   Clock security system (CSS)  Clock security system can be activated by software. In this case, the clock detector is enabled after the HSE oscillator startup delay, and disabled when this oscillator is stopped. If a failure is detected on the HSE clock:  •   the HSE oscillator is automatically disabled  •   a clock failure event is sent to the break input of TIM1, TIM15, TIM16, and TIM17 timers  •   CSSI (clock security system interrupt) is generated The CSSI is linked to the Cortex ®   -M0+ NMI (non-maskable interrupt) exception vector. It makes the software aware of a HSE clock failure to allow it to perform rescue operations.  Note:   If the CSS is enabled and the HSE clock fails, the CSSI occurs and an NMI is automatically generated. The NMI is executed infinitely unless the CSS interrupt pending bit is cleared. It is therefore necessary that the NMI ISR clears the CSSI by setting the CSSC bit in the RCC clock interrupt clear register (RCC_CICR).  If HSE is selected directly or indirectly as system clock, and a failure of HSE clock is detected, the system clock switches automatically to HSISYS and the HSE oscillator is disabled.  6.2.8   Clock security system for LSE clock (LSECSS)  A clock security system on LSE can be activated by setting the LSECSSON bit in   RCC control/status register 1 (RCC_CSR1) . This bit can be cleared only by a hardware reset or

Reset and clock control (RCC)   RM0490  128/1027   RM0490 Rev 5  RTC software reset, or after LSE clock failure detection. LSECSSON must be written after LSE and LSI are enabled (LSEON and LSION enabled) and ready (LSERDY and LSIRDY flags set by hardware), and after selecting the RTC clock by RTCSEL. The LSECSS works in all modes except Standby and Shutdown. It keeps working also under system reset (excluding power-on reset). If a failure is detected on the LSE oscillator, the LSE clock is no longer supplied to the RTC but its registers are not impacted.  Note:   If the LSECSS is enabled and the LSE clock fails, the LSECSSI occurs and an NMI is automatically generated. The NMI is executed infinitely unless the LSECSS interrupt pending bit is cleared. It is therefore necessary that the NMI ISR clears the LSECSSI by setting the LSECSSC bit in the RCC clock interrupt clear register (RCC_CICR).  If LSE is used as system clock, and a failure of LSE clock is detected, the system clock switches automatically to LSI. In low-power modes, an LSE clock failure generates a wake- up. The interrupt flag must then be cleared within the RCC registers. The software   must   then disable the LSECSSON bit, stop the defective 32 kHz oscillator (by clearing LSEON), and change the RTC clock source (no clock, LSI or HSE, with RTCSEL), or take any appropriate action to secure the application. The frequency of the LSE oscillator must exceed 30 kHz to avoid false positive detections.  6.2.9   ADC clock  The ADC clock (refer to the device datasheet for maximum frequency) is derived from the system clock SYSCLK or from the kernel clock output HSIKER (see ADCSEL[1:0] bitfield of the   RCC peripherals independent clock configuration register 1 (RCC_CCIPR) ). It can be prescaled by 1, 2, 4, 6, 8, 10, 12, 16, 32, 64, 128 or 256, by configuring the PRESC[3:0] bitfield of the ADC_CCR register. It is asynchronous to the APB clock. Alternatively, the ADC clock can be derived from the APB clock of the ADC bus interface (synchronous clock), divided by a programmable factor (1, 2 or 4) set through the CKMODE[1:0] bitfield of the ADC_CFGR2 register.  6.2.10   RTC clock  The RTCCLK clock source can be either the HSE/32, LSE or LSI clock. It is selected by programming the RTCSEL[1:0] bits in the   RCC control/status register 1 (RCC_CSR1) . This selection cannot be modified without resetting the RTC domain. The system must always be configured so as to get a PCLK frequency greater then or equal to the RTCCLK frequency for a proper operation of the RTC. RTC does not operate if the V   DD   supply is powered off or if the internal voltage regulator is powered off (removing power from the V   CORE   domain). When the RTC clock is LSE or LSI, the RTC remains clocked and functional under system reset.  6.2.11   Timer clock  The timer clock TIMPCLK is derived from PCLK (used for APB) as follows: 1.   If the APB prescaler is set to 1, TIMPCLK frequency is equal to PCLK frequency. 2.   Otherwise, the TIMPCLK frequency is set to twice the PCLK frequency.

RM0490 Rev 5   129/1027  RM0490   Reset and clock control (RCC)  165  6.2.12   Watchdog clock  If the Independent watchdog (IWDG) is started by either hardware option or software access, the LSI oscillator is forced ON and cannot be disabled. After the LSI oscillator temporization, the clock is provided to the IWDG.  6.2.13   Clock-out capability MCO and MCO2  The MCO and MCO2 pins output, independently of each other, the clock selected from:  •   LSI  •   LSE  •   SYSCLK  •   HSI48  •   HSE  •   HSIUSB48 The multiplexers for MCO and MCO2, respectively, are controlled by the MCOSEL[3:0] and MCO2SEL[3:0] bitfields of the   RCC clock configuration register (RCC_CFGR) . Their outputs are further divided by a factor set through the MCOPRE[3:0] and MCO2PRE[3:0] bitfields of the   RCC clock configuration register (RCC_CFGR) .  LSCO  The LSCO pin allows outputting on of low-speed clocks:  •   LSI  •   LSE The selection is controlled by the LSCOSEL bit and enabled with the LSCOEN bit of the  RCC control/status register 1 (RCC_CSR1) . The configuration registers of the corresponding GPIO port must be programmed in alternate function mode. This function remains available in Stop mode.  6.2.14   Internal/external clock measurement with TIM14/TIM16/TIM17  It is possible to indirectly measure the frequency of all on-board clock sources with the TIM14, TIM16 and TIM17 channel 1 input capture, as represented in   Figure 11 ,   Figure 12  and   Figure 13 .  TIM14  By setting the TI1SEL[3:0] field of the TIM14_TISEL register, the clock selected for the input capture channel1 of TIM14 can be one of:  •   GPIO (refer to the alternate function mapping in the device datasheets)  •   RTC clock (RTCCLK)  •   HSE clock divided by 32  •   MCO (MCU clock output)  •   MCO2 (MCU clock output)

Reset and clock control (RCC)   RM0490  130/1027   RM0490 Rev 5  MCO and MCO2 are controlled by the MCOSEL[3:0] and MCO2SEL[3:0] bitfields, respectively, of the clock configuration register (RCC_CFGR). All clock sources can be selected for the MCO and MCO2 pins.  Figure 11. Frequency measurement with TIM14 in capture mode TIM16  By setting the TI1SEL[3:0] field of the TIM16_TISEL register, the clock selected for the input capture channel1 of TIM16 can be one of:  •   GPIO (refer to the alternate function mapping in the device datasheets).  •   LSI clock  •   LSE clock  •   MCO2 MCO2 is controlled by the MCO2SEL[3:0] bitfield of the clock configuration register (RCC_CFGR). All clock sources can be selected for the MCO2 pin.  Figure 12. Frequency measurement with TIM16 in capture mode  MSv66114V1 TIM 14 TI1 TI1SEL[3:0] GPIO HSE MCO RTCCLK / 32 MCO2  MSv66115V1 TIM 16 TI1 TI1SEL[3:0] GPIO LSE MCO2 LSI

RM0490 Rev 5   131/1027  RM0490   Reset and clock control (RCC)  165  TIM17  By setting the TI1SEL[3:0] field of the TIM17_TISEL register, the clock selected for the input capture channel1 of TIM17 can be one of:  •   GPIO Refer to the alternate function mapping in the device datasheets.  •   HSIUSB48 / 256 (only available on STM32C071xx device)  •   HSE clock divided by 32  •   MCO (MCU clock output)  •   MCO2 (MCU clock output) MCO and MCO2 are controlled by the MCOSEL[3:0] and MCO2SEL[3:0] bitfields, respectively, of the clock configuration register (RCC_CFGR). All clock sources can be selected for the MCO and MCO2 pins.  Figure 13. Frequency measurement with TIM17 in capture mode Calibration of the HSI48 oscillator  For TIM14, TIM16, and TIM17, the primary purpose of connecting the LSE to the channel 1 input capture is to precisely measure HSISYS (derived from HSI48) selected as system clock. Counting HSISYS clock pulses between consecutive edges of the LSE clock (the time reference) allows measuring the HSISYS (and HSI48) clock period. Such measurement can determine the HSI48 oscillator frequency with nearly the same accuracy as the accuracy of the 32.768 kHz quartz crystal used with the LSE oscillator (typically a few tens of ppm). The HSI48 oscillator can then be trimmed to compensate for deviations from target frequency, due to manufacturing, process, temperature and/or voltage variation. The HSI48 oscillator has dedicated user-accessible calibration bits for this purpose. The basic concept consists in providing a relative measurement (for example, the HSISYS/LSE ratio): the measurement accuracy is therefore closely related to the ratio between the two clock sources. Increasing the ratio allows improving the measurement accuracy. Generated by the HSE oscillator, the HSE clock (divided by 32) used as time reference is the second best method for reaching a good HSI48 frequency measurement accuracy. It is recommended in absence of the LSE clock.  MSv66116V2 TIM 17 TI1 TI1SEL[3:0] GPIO HSE   / 32 MCO MCO2 HSIUSB48 / 256

Reset and clock control (RCC)   RM0490  132/1027   RM0490 Rev 5  In order to further improve the precision of the HSI48 oscillator calibration, it is advised to employ one or a combination of the following measures to increase the frequency measurement accuracy:  •   set the HSISYS divider to 1 for HSISYS frequency to be equal to HSI48 frequency  •   average the results of multiple consecutive measurements  •   use the input capture prescaler of the timer (one capture every up to eight periods)  Measurement of the LSI oscillator frequency  The measurement of the LSI oscillator frequency uses the same principle as that for calibrating the HSI48 oscillator. TIM16 channel1 input capture must be used for LSI clock, and HSE selected as system clock source. The number of HSE clock pulses between consecutive edges of the LSI signal, counted by TIM16, is then representative of the LSI clock period.  6.2.15   Peripheral clock enable registers  The clock to each peripheral can individually be enabled by the corresponding enable bit of the RCC_AHBENR register or one of the RCC_APBENRx registers. The clocks to I/O ports can individually be enabled through the RCC_IOPENR register. When the clock to a peripheral or I/O port is not active, the read and write accesses to its registers are not effective.  Caution:   The enable bits have a synchronization mechanism to create a glitch-free clock for the the corresponding peripheral or I/O port. After an enable bit is set, there is a 2-clock-cycle delay before the clock becomes active, which the software must take into account.  6.3   Low-power modes  •   AHB and APB peripheral clocks, including DMA clock, can be disabled by software.  •   Sleep mode stops the CPU clock. The memory interface clocks (flash memory and SRAM interfaces) can be stopped by software during sleep mode. The AHB to APB bridge clocks are disabled by hardware during Sleep mode when all the clocks of the peripherals connected to them are disabled.  •   Stop mode stops all the clocks in the V   CORE   domain and disable the HSI48, HSIUSB48, and HSE oscillators. The USART1 and I2C1 peripherals can enable the HSI48 oscillator even when the MCU is in Stop mode (if HSI48 is selected as clock source for one of those peripherals). The USART1 peripheral can also operate with the clock from the LSE oscillator when the system is in Stop mode, if LSE is selected as clock source for that peripheral and the LSE oscillator is enabled (LSEON set). In that case, the LSE oscillator remains active when the device enters Stop mode (these peripherals do not have the capability to turn on the LSE oscillator).  •   Standby and Shutdown modes stop all clocks in the V   CORE   domain and disable the HSI48, HSIUSB48, and HSE oscillators. The CPU deepsleep mode can be overridden for debugging, by setting the DBG_STOP or DBG_STANDBY bits in the DBGMCU_CR register. When leaving the Stop mode, HSISYS becomes automatically the system clock.

RM0490 Rev 5   133/1027  RM0490   Reset and clock control (RCC)  165  When leaving the Standby and Shutdown modes, HSISYS (with frequency equal to HSI48/4) becomes automatically the system clock. At wake-up from Standby and Shutdown mode, the user trim is lost. If a flash memory programming operation is ongoing, Stop, Standby, and Shutdown entry is delayed until the flash memory interface access is finished. If an access to the APB domain is ongoing, the Stop, Standby, and Shutdown entry is delayed until the APB access is finished.  6.4   RCC registers  Unless otherwise specified, the RCC registers support word, half-word, and byte access, without any wait state.  6.4.1   RCC clock control register (RCC_CR)  Address offset: 0x00 Power-on reset value: 0x0000 1540 Other types of reset: same as power-on reset, except the HSEBYP bit that keeps its previous value. This register only supports word and half-word access. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. HSIUSB48RDY HSIUSB48ON Res.   Res.   CSS ON HSE BYP HSE RDY HSE ON rw   rw   rs   rw   r   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   HSIDIV[2:0]   HSI RDY HSI KERON   HSION   HSIKERDIV[2:0]   SYSDIV[2:0]   Res.   Res. rw   rw   rw   r   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:24   Reserved, must be kept at reset value. Bit 23   HSIUSB48RDY : HSIUSB48 clock ready flag Set by hardware when the HSIUSB48 oscillator is enabled through HSIUSB48ON and ready to use (stable). 0: Not ready 1: Ready  Note:   Only applicable to STM32C071xx, reserved on the other products.  Bit 22   HSIUSB48ON : HSIUSB48 clock enable Set and cleared by software and hardware, with hardware taking priority. Kept low by hardware as long as the device is in a low-power mode. Kept high by hardware as long as the system is clocked from HSIUSB48. 0: Disable 1: Enable  Note:   Only applicable to STM32C071xx, reserved on the other products.  Bits 21:20   Reserved, must be kept at reset value.

Reset and clock control (RCC)   RM0490  134/1027   RM0490 Rev 5  Bit 19   CSSON : Clock security system enable Set by software to enable the clock security system. When the bit is set, the clock detector is enabled by hardware when the HSE oscillator is ready, and disabled by hardware if a HSE clock failure is detected. The bit is cleared by hardware upon reset. 0: Disable 1: Enable Bit 18   HSEBYP : HSE crystal oscillator bypass Set and cleared by software. When the bit is set, the internal HSE oscillator is bypassed for use of an external clock. The external clock must then be enabled with the HSEON bit set. Write access to the bit is only effective when the HSE oscillator is disabled. 0: No bypass 1: Bypass Bit 17   HSERDY : HSE clock ready flag Set by hardware to indicate that the HSE oscillator is stable and ready for use. 0: Not ready 1: Ready  Note:   Upon clearing HSEON, HSERDY goes low after six HSE clock cycles.  Bit 16   HSEON : HSE clock enable Set and cleared by software. Cleared by hardware to stop the HSE oscillator when entering Stop, or Standby, or Shutdown mode. This bit cannot be cleared if the HSE oscillator is used directly or indirectly as the system clock. 0: Disable 1: Enable Bits 15:14   Reserved, must be kept at reset value. Bits 13:11   HSIDIV[2:0] : HSI48 clock division factor This bitfield controlled by software sets the division factor of the HSI48 clock divider to produce HSISYS clock: 000: 1 001: 2 010: 4 (reset value) 011: 8 100: 16 101: 32 110: 64 111: 128 Bit 10   HSIRDY : HSI48 clock ready flag Set by hardware when the HSI48 oscillator is enabled through HSION and ready to use (stable). 0: Not ready 1: Ready  Note:   Upon clearing HSION, HSIRDY goes low after six HSI48 clock cycles.

RM0490 Rev 5   135/1027  RM0490   Reset and clock control (RCC)  165  6.4.2   RCC internal clock source calibration register (RCC_ICSCR)  Address offset: 0x04 Reset value: 0x0000 40XX The X nibbles of the reset can vary from part to part as they depend on the part calibration in the factory. Bit 9   HSIKERON : HSI48 always-enable for peripheral kernels. Set and cleared by software. Setting the bit activates the HSI48 oscillator in Run and Stop modes, regardless of the HSION bit state. The HSI48 clock can only feed USART1, USART2, and I2C1 peripherals configured with HSI48 as kernel clock. 0: HSI48 oscillator enable depends on the HSION bit 1: HSI48 oscillator is active in Run and Stop modes  Note:   Keeping the HSI48 active in Stop mode allows speeding up the serial interface communication as the HSI48 clock is ready immediately upon exiting Stop mode.  Bit 8   HSION : HSI48 clock enable Set and cleared by software and hardware, with hardware taking priority. Kept low by hardware as long as the device is in a low-power mode. Kept high by hardware as long as the system is clocked with a clock derived from HSI48. This includes the exit from low-power modes and the system clock fall-back to HSI48 upon failing HSE oscillator clock selected as system clock source. 0: Disable 1: Enable Bits 7:5   HSIKERDIV[2:0] : HSI48 kernel clock division factor This bitfield controlled by software sets the division factor of the kernel clock divider to produce HSIKER clock: 000: 1 001: 2 010: 3 (reset value) 011: 4 100: 5 101: 6 110: 7 111: 8 Bits 4:2   SYSDIV[2:0] : Clock division factor for system clock  S et and cleared by software. SYSCLK is result of the division by: 000: 1 (no division, reset value) 001: 2 010: 3 011: 4 100: 5 101: 6 110: 7 111: 8  Note:   This bitfield is only available on STM32C051xx, STM32C071xx, and STM32C091xx/92xx.  Bits 1:0   Reserved, must be kept at reset value.

Reset and clock control (RCC)   RM0490  136/1027   RM0490 Rev 5  6.4.3   RCC clock configuration register (RCC_CFGR)  One or two wait states are inserted when accessing this register upon a clock source switch, and between zero and 15 wait states upon updating APB or AHB prescaler values. Address offset: 0x08 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   HSITRIM[6:0]   HSICAL[7:0] rw   rw   rw   rw   rw   rw   rw   r   r   r   r   r   r   r   r Bits 31:15   Reserved, must be kept at reset value. Bits 14:8   HSITRIM[6:0] : HSI48 clock trimming The value of this bitfield contributes to the HSICAL[7:0] bitfield value. It allows HSI48 clock frequency user trimming. The HSI48 frequency accuracy as stated in the device datasheet applies when this bitfield is left at its reset value. Bits 7:0   HSICAL[7:0] : HSI48 clock calibration This bitfield directly acts on the HSI48 clock frequency. Its value is a sum of an internal factory-programmed number and the value of the HSITRIM[6:0] bitfield. In the factory, the internal number is set to calibrate the HSI48 clock frequency to 48 MHz (with HSITRIM[6:0] left at its reset value). Refer to the device datasheet for HSI48 calibration accuracy and for the frequency trimming granularity.  Note:   The trimming effect presents discontinuities at HSICAL[7:0] multiples of 64.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 MCOPRE[3:0]   MCOSEL[3:0]   MCO2PRE[3:0]   MCO2SEL[3:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   PPRE[2:0]   HPRE[3:0]   Res.   Res.   SWS[2:0]   SW[2:0] rw   rw   rw   rw   rw   rw   rw   r   r   r   rw   rw   rw

RM0490 Rev 5   137/1027  RM0490   Reset and clock control (RCC)  165  Bits 31:28   MCOPRE[3:0] : Microcontroller clock output prescaler This bitfield is controlled by software. It sets the division factor of the clock sent to the MCO output as follows: 0000: 1 0001: 2 0010: 4 ... 0111: 128 1000: 256 1001: 512 1010: 1024 Other: Reserved It is highly recommended to set this field before the MCO output is enabled.  Note:   Values above 0111 are only significant for STM32C051xx, STM32C071xx, and STM32C091xx/92xx. On STM32C011xx and STM32C031xx devices, MCOPRE[3] is reserved.  Bits 27:24   MCOSEL[3:0] : Microcontroller clock output clock selector This bitfield is controlled by software. It sets the clock selector for MCO output as follows: 0000: no clock 0001: SYSCLK 0010: Reserved 0011: HSI48 0100: HSE 0101: Reserved 0110: LSI 0111: LSE 1000: HSIUSB48 Other: reserved, must not be used  Note:   This clock output may have some truncated cycles at startup or during MCO clock source switching. On STM32C011xx, STM32C031xx, STM32C051xx, and STM32C091xx/92xx, MCOSEL[3] is reserved.  Bits 23:20   MCO2PRE[3:0] : Microcontroller clock output 2 prescaler This bitfield is controlled by software. It sets the division factor of the clock sent to the MCO2 output as follows: 0000: 1 0001: 2 0010: 4 ... 0111: 128 1000: 256 1001: 512 1010: 1024 Other: Reserved It is highly recommended to set this field before the MCO2 output is enabled.  Note:   Values above 0111 are only significant for STM32C051xx, STM32C071xx, and STM32C091xx/92xx. On STM32C011xx and STM32C031xx devices, MCO2PRE[3] is reserved.

Reset and clock control (RCC)   RM0490  138/1027   RM0490 Rev 5  Bits 19:16   MCO2SEL[3:0] : Microcontroller clock output 2 clock selector This bitfield is controlled by software. It sets the clock selector for MCO2 output as follows: 0000: no clock 0001: SYSCLK 0010: Reserved 0011: HSI48 0100: HSE 0101: Reserved 0110: LSI 0111: LSE 1000: HSIUSB48 Other: reserved, must not be used  Note:   This clock output may have some truncated cycles at startup or during MCO2 clock source switching. On STM32C011xx, STM32C031xx, STM32C051xx, and STM32C091xx/92xx, MCO2SEL[3] is reserved.  Bit 15   Reserved, must be kept at reset value. Bits 14:12   PPRE[2:0] : APB prescaler This bitfield is controlled by software. To produce PCLK clock, it sets the division factor of HCLK clock as follows: 0xx: 1 100: 2 101: 4 110: 8 111: 16 Bits 11:8   HPRE[3:0] : AHB prescaler This bitfield is controlled by software. To produce HCLK clock, it sets the division factor of SYSCLK clock as follows: 0xxx: 1 1000: 2 1001: 4 1010: 8 1011: 16 1100: 64 1101: 128 1110: 256 1111: 512 Bits 7:6   Reserved, must be kept at reset value.

RM0490 Rev 5   139/1027  RM0490   Reset and clock control (RCC)  165  6.4.4   RCC clock recovery RC register (RCC_CRRCR)  This register is only available on STM32C071xx. On the other devices, it is reserved. Address offset: 0x14 Reset value: 0b0000 0000 0000 0000 0000 000X XXXX XXXX Access: no wait state, word, half-word and byte access  6.4.5   RCC clock interrupt enable register (RCC_CIER)  Address offset: 0x18 Reset value: 0x0000 0000 Bits 5:3   SWS[2:0] : System clock switch status This bitfield is controlled by hardware to indicate the clock source used as system clock: 000: HSISYS 001: HSE 010: HSIUSB48 on STM32C071xx, reserved on the other products 011: LSI 100: LSE Others: Reserved Bits 2:0   SW[2:0] : System clock switch This bitfield is controlled by software and hardware. The bitfield selects the clock for SYSCLK as follows: 000: HSISYS 001: HSE 010: HSIUSB48 on STM32C071xx, reserved on the other products 011: LSI 100: LSE Others: Reserved The setting is forced by hardware to 000 (HSISYS selected) when the MCU exits Stop, or Standby, or Shutdown mode, or when the setting is 001 (HSE selected) and HSE oscillator failure is detected. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   HSIUSB48CAL[8:0] r   r   r   r   r   r   r   r   r Bits 31:9   Reserved, must be kept at reset value. Bits 8:0   HSIUSB48CAL[8:0] : HSIUSB48 clock calibration These bits are initialized at startup with the factory-programmed HSIUSB48 calibration trim value.

Reset and clock control (RCC)   RM0490  140/1027   RM0490 Rev 5  6.4.6   RCC clock interrupt flag register (RCC_CIFR)  Address offset: 0x1C Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   HSE RDYIE HSI RDYIE HSI USB48 RDYIE LSE RDYIE LSI RDYIE rw   rw   rw   rw   rw Bits 31:5   Reserved, must be kept at reset value. Bit 4   HSERDYIE : HSE ready interrupt enable Set and cleared by software to enable/disable interrupt caused by the HSE oscillator stabilization: 0: Disable 1: Enable Bit 3   HSIRDYIE : HSI48 ready interrupt enable Set and cleared by software to enable/disable interrupt caused by the HSI48 oscillator stabilization: 0: Disable 1: Enable Bit 2   HSIUSB48RDYIE : HSIUSB48 ready interrupt enable Set and cleared by software to enable/disable interrupt caused by the HSIUSB48 oscillator stabilization: 0: Disable 1: Enable  Note:   Only applicable to STM32C071xx, reserved on the other products.  Bit 1   LSERDYIE : LSE ready interrupt enable Set and cleared by software to enable/disable interrupt caused by the LSE oscillator stabilization: 0: Disable 1: Enable Bit 0   LSIRDYIE : LSI ready interrupt enable Set and cleared by software to enable/disable interrupt caused by the LSI oscillator stabilization: 0: Disable 1: Enable

RM0490 Rev 5   141/1027  RM0490   Reset and clock control (RCC)  165  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   LSE CSSF   CSSF   Res.   Res.   Res.   HSE RDYF HSI RDYF HSI USB48 RDYF LSE RDYF LSI RDYF r   r   r   r   r   r   r Bits 31:10   Reserved, must be kept at reset value. Bit 9   LSECSSF : LSE clock security system interrupt flag This flag indicates a pending interrupt upon LSE clock failure. Set by hardware when a failure is detected in the LSE oscillator. Cleared by software by setting the LSECSSC bit. 0: Interrupt not pending 1: Interrupt pending Bit 8   CSSF : HSE clock security system interrupt flag This flag indicates a pending interrupt upon HSE clock failure. Set by hardware when a failure is detected in the HSE oscillator. Cleared by software setting the CSSC bit. 0: Interrupt not pending 1: Interrupt pending Bits 7:5   Reserved, must be kept at reset value. Bit 4   HSERDYF : HSE ready interrupt flag This flag indicates a pending interrupt upon HSE clock getting ready. Set by hardware when the HSE clock becomes stable and HSERDYIE is set. Cleared by software setting the HSERDYC bit. 0: Interrupt not pending 1: Interrupt pending Bit 3   HSIRDYF : HSI48 ready interrupt flag This flag indicates a pending interrupt upon HSI48 clock getting ready. Set by hardware when the HSI48 clock becomes stable and HSIRDYIE is set in response to setting the HSION (refer to   RCC clock control register (RCC_CR) ). When HSION is not set but the HSI48 oscillator is enabled by the peripheral through a clock request, this bit is not set and no interrupt is generated. Cleared by software setting the HSIRDYC bit. 0: Interrupt not pending 1: Interrupt pending

Reset and clock control (RCC)   RM0490  142/1027   RM0490 Rev 5  6.4.7   RCC clock interrupt clear register (RCC_CICR)  Address offset: 0x20 Reset value: 0x0000 0000 RCC Bit 2   HSIUSB48RDYF : HSIUSB48 ready interrupt flag Set by hardware when the HSIUSB48 clock becomes stable and HSIUSB48RDYIE is set as a response to setting HSIUSB48ON (refer to   RCC clock control register (RCC_CR) ). When HSIUSB48ON is not set but the HSIUSB48 oscillator is enabled by the peripheral through a clock request, this bit is not set and no interrupt is generated. Cleared by software setting the HSIUSB48RDYC bit. 0: Interrupt not pending 1: Interrupt pending  Note:   Only applicable to STM32C071xx, reserved on the other products.  Bit 1   LSERDYF : LSE ready interrupt flag This flag indicates a pending interrupt upon LSE clock getting ready. Set by hardware when the LSE clock becomes stable and LSERDYIE is set. Cleared by software setting the LSERDYC bit. 0: Interrupt not pending 1: Interrupt pending Bit 0   LSIRDYF : LSI ready interrupt flag This flag indicates a pending interrupt upon LSI clock getting ready. Set by hardware when the LSI clock becomes stable and LSIRDYIE is set. Cleared by software setting the LSIRDYC bit. 0: Interrupt not pending 1: Interrupt pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   LSE CSSC   CSSC   Res.   Res.   Res.   HSE RDYC HSI RDYC HSI USB48 RDYC LSE RDYC LSI RDYC w   w   w   w   w   w   w Bits 31:10   Reserved, must be kept at reset value. Bit 9   LSECSSC : LSE Clock security system interrupt clear This bit is set by software to clear the LSECSSF flag. 0: No effect 1: Clear LSECSSF flag Bit 8   CSSC : Clock security system interrupt clear This bit is set by software to clear the HSECSSF flag. 0: No effect 1: Clear CSSF flag Bits 7:5   Reserved, must be kept at reset value.

RM0490 Rev 5   143/1027  RM0490   Reset and clock control (RCC)  165  6.4.8   RCC I/O port reset register (RCC_IOPRSTR)  Address offset: 0x24 Reset value: 0x0000 0000 Bit 4   HSERDYC : HSE ready interrupt clear This bit is set by software to clear the HSERDYF flag. 0: No effect 1: Clear HSERDYF flag Bit 3   HSIRDYC : HSI48 ready interrupt clear This bit is set software to clear the HSIRDYF flag. 0: No effect 1: Clear HSIRDYF flag Bit 2   HSIUSB48RDYC : HSIUSB48 ready interrupt clear This bit is set software to clear the HSIUSB48RDYF flag. 0: No effect 1: Clear HSIUSB48RDYF flag  Note:   Only applicable to STM32C071xx, reserved on the other products.  Bit 1   LSERDYC : LSE ready interrupt clear This bit is set by software to clear the LSERDYF flag. 0: No effect 1: Clear LSERDYF flag Bit 0   LSIRDYC : LSI ready interrupt clear This bit is set by software to clear the LSIRDYF flag. 0: No effect 1: Clear LSIRDYF flag 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   GPIOF RST   Res.   GPIOD RST GPIOC RST GPIOB RST GPIOA RST rw   rw   rw   rw   rw Bits 31:6   Reserved, must be kept at reset value. Bit 5   GPIOFRST:   I/O port F reset This bit is set and cleared by software. 0: no effect 1: Reset I/O port F Bit 4   Reserved, must be kept at reset value. Bit 3   GPIODRST:   I/O port D reset This bit is set and cleared by software. 0: no effect 1: Reset I/O port D

Reset and clock control (RCC)   RM0490  144/1027   RM0490 Rev 5  6.4.9   RCC AHB peripheral reset register (RCC_AHBRSTR)  Address offset: 0x28 Reset value: 0x0000 0000  6.4.10   RCC APB peripheral reset register 1 (RCC_APBRSTR1)  Address offset: 0x2C Reset value: 0x0000 0000 Bit 2   GPIOCRST:   I/O port C reset This bit is set and cleared by software. 0: no effect 1: Reset I/O port C Bit 1   GPIOBRST:   I/O port B reset This bit is set and cleared by software. 0: no effect 1: Reset I/O port B Bit 0   GPIOARST:   I/O port A reset This bit is set and cleared by software. 0: no effect 1: Reset I/O port A 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   CRC RST   Res.   Res.   Res.   FLASH RST   Res.   Res.   Res.   Res.   Res.   Res.   Res.   DMA1 RST rw   rw   rw Bits 31:13   Reserved, must be kept at reset value. Bit 12   CRCRST : CRC reset Set and cleared by software. 0: No effect 1: Reset CRC Bits 11:9   Reserved, must be kept at reset value. Bit 8   FLASHRST : Flash memory interface reset Set and cleared by software. 0: No effect 1: Reset flash memory interface This bit can only be set when the flash memory is in power down mode. Bits 7:1   Reserved, must be kept at reset value. Bit 0   DMA1RST : DMA1 and DMAMUX reset Set and cleared by software. 0: No effect 1: Reset DMA1 and DMAMUX

RM0490 Rev 5   145/1027  RM0490   Reset and clock control (RCC)  165  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   PWR RST DBG RST   Res.   Res.   Res.   Res.   I2C2 RST I2C1 RST   Res.   USART4 RST USART3 RST USART2 RST CRS RST rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   SPI2 RST USB RST FD CAN1 RST Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TIM3 RST TIM2 RST rw   rw   rw   rw   rw Bits 31:29   Reserved, must be kept at reset value. Bit 28   PWRRST : Power interface reset Set and cleared by software. 0: No effect 1: Reset PWR Bit 27   DBGRST : Debug support reset Set and cleared by software. 0: No effect 1: Reset DBG Bits 26:23   Reserved, must be kept at reset value. Bit 22   I2C2RST : I2C2 reset Set and cleared by software. 0: No effect 1: Reset I2C2  Note:   Only applicable to STM32C051xx, STM32C071xx, and STM32C091xx/92xx, reserved on the other products.  Bit 21   I2C1RST : I2C1 reset Set and cleared by software. 0: No effect 1: Reset I2C1 Bit 20   Reserved, must be kept at reset value. Bit 19   USART4RST : USART4 reset Set and cleared by software. 0: No effect 1: Reset USART4  Note:   Only applicable to STM32C091xx/92xx, reserved on the other products.  Bit 18   USART3RST : USART3 reset Set and cleared by software. 0: No effect 1: Reset USART3  Note:   Only applicable to STM32C091xx/92xx, reserved on the other products.  Bit 17   USART2RST : USART2 reset Set and cleared by software. 0: No effect 1: Reset USART2

Reset and clock control (RCC)   RM0490  146/1027   RM0490 Rev 5  6.4.11   RCC APB peripheral reset register 2 (RCC_APBRSTR2)  Address offset: 0x30 Reset value: 0x0000 0000 Bit 16   CRSRST : CRS reset Set and cleared by software. 0: No effect 1: Reset CRS  Note:   Only applicable to STM32C071xx, reserved on the other products.  Bit 15   Reserved, must be kept at reset value. Bit 14   SPI2RST : SPI2 reset Set and cleared by software. 0: No effect 1: Reset SPI2  Note:   Only applicable to STM32C051xx, STM32C071xx, and STM32C091xx/92xx, reserved on the other products.  Bit 13   USBRST : USB reset Set and cleared by software. 0: No effect 1: Reset USB  Note:   Only applicable to STM32C071xx, reserved on the other products.  Bit 12   FDCAN1RST : FDCAN1 reset Set and cleared by software. 0: No effect 1: Reset FDCAN1  Note:   Only applicable to STM32C092xx, reserved on the other products.  Bits 11:2   Reserved, must be kept at reset value. Bit 1   TIM3RST : TIM3 timer reset Set and cleared by software. 0: No effect 1: Reset TIM3 Bit 0   TIM2RST : TIM2 timer reset Set and cleared by software. 0: No effect 1: Reset TIM2  Note:   Only applicable to STM32C051xx, STM32C071xx, and STM32C091xx/92xx, reserved on the other products.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   ADC RST   Res.   TIM17 RST TIM16 RST TIM15 RST rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 TIM14 RST USART1 RST   Res.   SPI1 RST TIM1 RST   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. SYS CFG RST rw   rw   rw   rw   rw

RM0490 Rev 5   147/1027  RM0490   Reset and clock control (RCC)  165  6.4.12   RCC I/O port clock enable register (RCC_IOPENR)  Address offset: 0x34 Bits 31:21   Reserved, must be kept at reset value. Bit 20   ADCRST : ADC reset Set and cleared by software. 0: No effect 1: Reset ADC Bit 19   Reserved, must be kept at reset value. Bit 18   TIM17RST : TIM16 timer reset Set and cleared by software. 0: No effect 1: Reset TIM17 timer Bit 17   TIM16RST : TIM16 timer reset Set and cleared by software. 0: No effect 1: Reset TIM16 timer Bit 16   TIM15RST : TIM15 timer reset Set and cleared by software. 0: No effect 1: Reset TIM15 timer  Note:   Only applicable to STM32C092xx, reserved on the other products.  Bit 15   TIM14RST : TIM14 timer reset Set and cleared by software. 0: No effect 1: Reset TIM14 timer Bit 14   USART1RST : USART1 reset Set and cleared by software. 0: No effect 1: Reset USART1 Bit 13   Reserved, must be kept at reset value. Bit 12   SPI1RST : SPI1 reset Set and cleared by software. 0: No effect 1: Reset SPI1 Bit 11   TIM1RST : TIM1 timer reset Set and cleared by software. 0: No effect 1: Reset TIM1 timer Bits 10:1   Reserved, must be kept at reset value. Bit 0   SYSCFGRST : SYSCFG reset Set and cleared by software. 0: No effect 1: Reset SYSCFG

Reset and clock control (RCC)   RM0490  148/1027   RM0490 Rev 5  Reset value: 0x0000 0000  6.4.13   RCC AHB peripheral clock enable register (RCC_AHBENR)  Address offset: 0x38 Reset value: 0x0000 0100 This register individually enables clocks to AHB peripherals. In Sleep and Stop modes, a clock enabled through this register is only supplied to the peripheral if the corresponding bit of the RCC_AHBSMENR register is also set. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   GPIOF EN   Res.   GPIOD EN GPIOC EN GPIOB EN GPIOA EN rw   rw   rw   rw   rw Bits 31:6   Reserved, must be kept at reset value. Bit 5   GPIOFEN:   I/O port F clock enable This bit is set and cleared by software. 0: Disable 1: Enable Bit 4   Reserved, must be kept at reset value. Bit 3   GPIODEN:   I/O port D clock enable This bit is set and cleared by software. 0: Disable 1: Enable Bit 2   GPIOCEN:   I/O port C clock enable This bit is set and cleared by software. 0: Disable 1: Enable Bit 1   GPIOBEN:   I/O port B clock enable This bit is set and cleared by software. 0: Disable 1: Enable Bit 0   GPIOAEN:   I/O port A clock enable This bit is set and cleared by software. 0: Disable 1: Enable

RM0490 Rev 5   149/1027  RM0490   Reset and clock control (RCC)  165  6.4.14   RCC APB peripheral clock enable register 1 (RCC_APBENR1)  Address offset: 0x3C Reset value: 0x0000 0000 This register individually enables clocks to APB peripherals. In Sleep and Stop modes, a clock enabled through this register is only supplied to the peripheral if the corresponding bit of the RCC_APBSMENR1 register is also set. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   CRC EN   Res.   Res.   Res.   FLASH EN   Res.   Res.   Res.   Res.   Res.   Res.   Res.   DMA1 EN rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:13   Reserved, must be kept at reset value. Bit 12   CRCEN : CRC clock enable Set and cleared by software. 0: Disable 1: Enable Bits 11:9   Reserved, must be kept at reset value. Bit 8   FLASHEN : Flash memory interface clock enable Set and cleared by software. 0: Disable 1: Enable This bit can only be cleared when the flash memory is in power down mode. Bits 7:1   Reserved, must be kept at reset value. Bit 0   DMA1EN : DMA1 and DMAMUX clock enable Set and cleared by software. 0: Disable 1: Enable DMAMUX is enabled as long as at least one DMA peripheral is enabled. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   PWR EN DBG EN   Res.   Res.   Res.   Res.   I2C2 EN I2C1 EN   Res.   USART4 EN USART3 EN USART2 EN CRS EN rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   SPI2 EN USB EN FD CAN1 EN WWDG EN RTC APB EN Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TIM3 EN TIM2 EN rw   rw   rw   rw   rw   rw   rw

Reset and clock control (RCC)   RM0490  150/1027   RM0490 Rev 5  Bits 31:29   Reserved, must be kept at reset value. Bit 28   PWREN : Power interface clock enable Set and cleared by software. 0: Disable 1: Enable Bit 27   DBGEN : Debug support clock enable Set and cleared by software. 0: Disable 1: Enable Bits 26:23   Reserved, must be kept at reset value. Bit 22   I2C2EN : I2C2 clock enable Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C051xx, STM32C071xx, and STM32C091xx/92xx, reserved on the other products.  Bit 21   I2C1EN : I2C1 clock enable Set and cleared by software. 0: Disable 1: Enable Bit 20   Reserved, must be kept at reset value. Bit 19   USART4EN : USART4 clock enable Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C091xx/92xx, reserved on the other products.  Bit 18   USART3EN : USART3 clock enable Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C091xx/92xx, reserved on the other products.  Bit 17   USART2EN : USART2 clock enable Set and cleared by software. 0: Disable 1: Enable Bit 16   CRSEN : CRS clock enable Set and cleared by software. 0: Disable 1: Enable  Only applicable to STM32C071xx, reserved on the other products.  Bit 15   Reserved, must be kept at reset value.

RM0490 Rev 5   151/1027  RM0490   Reset and clock control (RCC)  165  6.4.15   RCC APB peripheral clock enable register 2(RCC_APBENR2)  Address offset: 0x40 Reset value: 0x0000 0000 This register individually enables clocks to APB peripherals. In Sleep and Stop modes, a clock enabled through this register is only supplied to the peripheral if the corresponding bit of the RCC_APBSMENR2 register is also set. Bit 14   SPI2EN : SPI2 clock enable Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C051xx, STM32C071xx, and STM32C091xx/92xx, reserved on the other products.  Bit 13   USBEN : USB clock enable Set and cleared by software. 0: Disable 1: Enable  Only applicable to STM32C071xx, reserved on the other products.  Bit 12   FDCAN1EN : FDCAN1 clock enable Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C092xx, reserved on the other products.  Bit 11   WWDGEN : WWDG clock enable Set by software   to enable the window watchdog clock. Cleared by hardware system reset  0: Disable 1: Enable This bit can also be set by hardware if the WWDG_SW option bit is 0. Bit 10   RTCAPBEN : RTC APB clock enable Set and cleared by software. 0: Disable 1: Enable Bits 9:2   Reserved, must be kept at reset value. Bit 1   TIM3EN : TIM3 timer clock enable Set and cleared by software. 0: Disable 1: Enable Bit 0   TIM2EN : TIM2 timer clock enable Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C051xx, STM32C071xx, and STM32C091xx/92xx, reserved on the other products.

Reset and clock control (RCC)   RM0490  152/1027   RM0490 Rev 5  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   ADC EN   Res.   TIM17 EN TIM16 EN TIM15 EN rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 TIM14 EN USART1 EN   Res.   SPI1 EN TIM1 EN   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. SYS CFG EN rw   rw   rw   rw   rw Bits 31:21   Reserved, must be kept at reset value. Bit 20   ADCEN : ADC clock enable Set and cleared by software. 0: Disable 1: Enable Bit 19   Reserved, must be kept at reset value. Bit 18   TIM17EN : TIM16 timer clock enable Set and cleared by software. 0: Disable 1: Enable Bit 17   TIM16EN : TIM16 timer clock enable Set and cleared by software. 0: Disable 1: Enable Bit 16   TIM15EN : TIM15 timer clock enable Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C091xx/92xx, reserved on the other products.  Bit 15   TIM14EN : TIM14 timer clock enable Set and cleared by software. 0: Disable 1: Enable Bit 14   USART1EN : USART1 clock enable Set and cleared by software. 0: Disable 1: Enable Bit 13   Reserved, must be kept at reset value. Bit 12   SPI1EN : SPI1 clock enable Set and cleared by software. 0: Disable 1: Enable

RM0490 Rev 5   153/1027  RM0490   Reset and clock control (RCC)  165  6.4.16   RCC I/O port in Sleep mode clock enable register (RCC_IOPSMENR)  Address offset: 0x44 Reset value: 0x0000 002F Bit 11   TIM1EN : TIM1 timer clock enable Set and cleared by software. 0: Disable 1: Enable Bits 10:1   Reserved, must be kept at reset value. Bit 0   SYSCFGEN : SYSCFG clock enable Set and cleared by software. 0: Disable 1: Enable 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   GPIOF SMEN   Res.   GPIOD SMEN GPIOC SMEN GPIOB SMEN GPIOA SMEN rw   rw   rw   rw   rw Bits 31:6   Reserved, must be kept at reset value. Bit 5   GPIOFSMEN:   I/O port F clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bit 4   Reserved, must be kept at reset value. Bit 3   GPIODSMEN:   I/O port D clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bit 2   GPIOCSMEN:   I/O port C clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bit 1   GPIOBSMEN:   I/O port B clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bit 0   GPIOASMEN:   I/O port A clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable

Reset and clock control (RCC)   RM0490  154/1027   RM0490 Rev 5  6.4.17   RCC AHB peripheral clock enable in Sleep/Stop mode register (RCC_AHBSMENR)  Address offset: 0x48 Reset value: 0x0000 1301 This register can individually program which AHB peripheral clocks are disabled (bit cleared) upon the device entering Sleep or Stop mode. When a bit of this register is set (enable), the corresponding peripheral clock is supplied in Sleep or Stop mode according to the setting of the RCC_AHBENR register.  6.4.18   RCC APB peripheral clock enable in Sleep/Stop mode register 1 (RCC_APBSMENR1)  Address offset: 0x4C Reset value: 0x186F 7C03 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   CRC SMEN   Res.   Res.   SRAM SMEN FLASH SMEN   Res.   Res.   Res.   Res.   Res.   Res.   Res.   DMA1 SMEN rw   rw   rw   rw Bits 31:13   Reserved, must be kept at reset value. Bit 12   CRCSMEN : CRC clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bits 11:10   Reserved, must be kept at reset value. Bit 9   SRAMSMEN : SRAM clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bit 8   FLASHSMEN : Flash memory interface clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable This bit can be activated only when the flash memory is in power down mode. Bits 7:1   Reserved, must be kept at reset value. Bit 0   DMA1SMEN : DMA1 and DMAMUX clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Clock to DMAMUX during Sleep mode is enabled as long as the clock in Sleep mode is enabled to at least one DMA peripheral.

RM0490 Rev 5   155/1027  RM0490   Reset and clock control (RCC)  165  This register can individually program which APB peripheral clocks are disabled (bit cleared) upon the device entering Sleep or Stop mode. When a bit of this register is set (enable), the corresponding peripheral clock is supplied in Sleep or Stop mode according to the setting of the RCC_APBENR1 register. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   PWR SMEN DBG SMEN   Res.   Res.   Res.   Res.   I2C2 SMEN I2C1 SMEN   Res.   USART4 SMEN USART3 SMEN USART2 SMEN CRS SMEN rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   SPI2 SMEN USB SMEN FD CAN1 SMEN WWDG SMEN RTC APB SMEN Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TIM3 SMEN TIM2 SMEN rw   rw   rw   rw   rw   rw   rw Bits 31:29   Reserved, must be kept at reset value. Bit 28   PWRSMEN : Power interface clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bit 27   DBGSMEN : Debug support clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bits 26:23   Reserved, must be kept at reset value. Bit 22   I2C2SMEN : I2C2 clock enable during Sleep and Stop modes Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C051xx, STM32C071xx, and STM32C091xx/92xx, reserved on the other products.  Bit 21   I2C1SMEN : I2C1 clock enable during Sleep and Stop modes Set and cleared by software. 0: Disable 1: Enable Bit 20   Reserved, must be kept at reset value. Bit 19   USART4SMEN : USART4 clock enable during Sleep and Stop modes Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C091xx/92xx, reserved on the other products.  Bit 18   USART3SMEN : USART3 clock enable during Sleep and Stop modes Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C091xx/92xx, reserved on the other products.

Reset and clock control (RCC)   RM0490  156/1027   RM0490 Rev 5  Bit 17   USART2SMEN : USART2 clock enable during Sleep and Stop modes Set and cleared by software. 0: Disable 1: Enable Bit 16   CRSSMEN : CRS clock enable during Sleep and Stop modes Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C051xx, STM32C071xx, and STM32C091xx/92xx, reserved on the other products.  Bit 15   Reserved, must be kept at reset value. Bit 14   SPI2SMEN : SPI2 clock enable during Sleep and Stop modes Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C071xx, reserved on the other products.  Bit 13   USBSMEN : USB clock enable during Sleep and Stop modes Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C071xx, reserved on the other products.  Bit 12   FDCAN1SMEN : FDCAN1 clock enable during Sleep and Stop modes Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C092xx, reserved on the other products.  Bit 11   WWDGSMEN : WWDG clock enable during Sleep and Stop modes Set and cleared by software. 0: Disable 1: Enable Bit 10   RTCAPBSMEN : RTC APB clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bits 9:2   Reserved, must be kept at reset value. Bit 1   TIM3SMEN : TIM3 timer clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bit 0   TIM2SMEN : TIM2 timer clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C051xx, STM32C071xx, and STM32C091xx/92xx, reserved on the other products.

RM0490 Rev 5   157/1027  RM0490   Reset and clock control (RCC)  165  6.4.19   RCC APB peripheral clock enable in Sleep/Stop mode register 2 (RCC_APBSMENR2)  Address offset: 0x50 Reset value: 0x0017 D801 This register can individually program which APB peripheral clocks are disabled (bit cleared) upon the device entering Sleep or Stop mode. When a bit of this register is set (enable), the corresponding peripheral clock is supplied in Sleep or Stop mode according to the setting of the RCC_APBENR2 register. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   ADC SMEN   Res.   TIM17 SMEN TIM16 SMEN TIM15 SMEN rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 TIM14 SMEN USART1 SMEN   Res.   SPI1 SMEN TIM1 SMEN   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. SYS CFG SMEN rw   rw   rw   rw   rw Bits 31:21   Reserved, must be kept at reset value. Bit 20   ADCSMEN : ADC clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bit 19   Reserved, must be kept at reset value. Bit 18   TIM17SMEN : TIM16 timer clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bit 17   TIM16SMEN : TIM16 timer clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bit 16   TIM15SMEN : TIM15 timer clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable  Note:   Only applicable to STM32C091xx/92xx, reserved on the other products.  Bit 15   TIM14SMEN : TIM14 timer clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bit 14   USART1SMEN : USART1 clock enable during Sleep and Stop modes Set and cleared by software. 0: Disable 1: Enable

Reset and clock control (RCC)   RM0490  158/1027   RM0490 Rev 5  6.4.20   RCC peripherals independent clock configuration register 1 (RCC_CCIPR)  Address offset: 0x54 Reset value: 0x0000 0000 Bit 13   Reserved, must be kept at reset value. Bit 12   SPI1SMEN : SPI1 clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bit 11   TIM1SMEN : TIM1 timer clock enable during Sleep mode Set and cleared by software. 0: Disable 1: Enable Bits 10:1   Reserved, must be kept at reset value. Bit 0   SYSCFGSMEN : SYSCFG clock enable during Sleep and Stop modes Set and cleared by software. 0: Disable 1: Enable 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 ADCSEL[1:0]   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 I2S1SEL[1:0]   I2C1SEL[1:0]   Res.   Res.   FDCAN1SEL [1:0]   Res.   Res.   Res.   Res.   Res.   Res.   USART1SEL [1:0] rw   rw   rw   rw   rw   rw   rw   rw Bits 31:30   ADCSEL[1:0] : ADCs clock source selection This bitfield is controlled by software to select the asynchronous clock source for ADC: 00: System clock 01: Reserved 10: HSIKER 11: Reserved Bits 29:16   Reserved, must be kept at reset value. Bits 15:14   I2S1SEL[1:0] : I2S1 clock source selection This bitfield is controlled by software to select I2S1 clock source as follows: 00: SYSCLK 01: Reserved 10: HSIKER 11: I2S_CKIN

RM0490 Rev 5   159/1027  RM0490   Reset and clock control (RCC)  165  6.4.21   RCC peripherals independent clock configuration register 2 (RCC_CCIPR2)  This register is only available on STM32C071xx. On the other devices, it is reserved. Address offset: 0x58 Reset value: 0x0000 0000  6.4.22   RCC control/status register 1 (RCC_CSR1)  Up to three wait states are inserted in case of successive accesses to this register. Bits 13:12   I2C1SEL[1:0] : I2C1 clock source selection This bitfield is controlled by software to select I2C1 clock source as follows: 00: PCLK 01: SYSCLK 10: HSIKER 11: Reserved Bits 11:10   Reserved, must be kept at reset value. Bits 9:8   FDCAN1SEL[1:0] : FDCAN1 clock source selection This bitfield is controlled by software to select FDCAN1 clock source as follows: 00: PCLK 01: HSIKER 10: HSE 11: Reserved  Note:   Only applicable to STM32C092xx, reserved on the other products.  Bits 7:2   Reserved, must be kept at reset value. Bits 1:0   USART1SEL[1:0] : USART1 clock source selection This bitfield is controlled by software to select USART1 clock source as follows: 00: PCLK 01: SYSCLK 10: HSIKER 11: LSE 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   USBSEL   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. rw Bits 31:13   Reserved, must be kept at reset value. Bit 12   USBSEL : USB clock source selection Set and cleared by software. 0: HSIUSB48 1: HSE Bits 11:0   Reserved, must be kept at reset value.

Reset and clock control (RCC)   RM0490  160/1027   RM0490 Rev 5  The register bits are only reset upon RTC domain reset (see   Section 6.1.3: RTC domain reset ), except the LSCOSEL, LSCOEN, and RTCRST bits that are only reset upon RTC domain power-on reset. Any internal or external reset has no effect on these bits. Address offset: 0x5C Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   LSCO SEL LSCO EN   Res.   Res.   Res.   Res.   Res.   Res.   Res.   RTCRS T rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 RTC EN   Res.   Res.   Res.   Res.   Res.   RTCSEL[1:0]   Res.   LSE CSSD LSE CSSON   Res.   LSE DRV LSE BYP LSE RDY   LSEON rw   rw   rw   r   rw   rw   rw   r   rw Bits 31:26   Reserved, must be kept at reset value. Bit 25   LSCOSEL : Low-speed clock output selection Set and cleared by software to select the low-speed output clock: 0: LSI 1: LSE Bit 24   LSCOEN : Low-speed clock output (LSCO) enable Set and cleared by software. 0: Disable 1: Enable Bits 23:17   Reserved, must be kept at reset value. Bit 16   RTCRST : RTC domain software reset Set and cleared by software to reset the RTC domain: 0: No effect 1: Reset Bit 15   RTCEN : RTC clock enable Set and cleared by software. The bit enables clock to RTC. 0: Disable 1: Enable Bits 14:10   Reserved, must be kept at reset value. Bits 9:8   RTCSEL[1:0] : RTC clock source selection Set by software to select the clock source for the RTC as follows: 00: No clock 01: LSE 10: LSI 11: HSE divided by 32 Once the RTC clock source is selected, it cannot be changed anymore unless the RTC domain is reset, or unless a failure is detected on LSE (LSECSSD is set). The RTCRST bit can be used to reset this bitfield to 00. Bit 7   Reserved, must be kept at reset value.

RM0490 Rev 5   161/1027  RM0490   Reset and clock control (RCC)  165  6.4.23   RCC control/status register 2 (RCC_CSR2)  Up to three wait states are inserted in case of successive accesses to this register. The register is reset upon system reset, except for reset flags that are only reset upon power reset. Address offset: 0x60 Reset value: 0xXX00 0000 Bit 6   LSECSSD:   CSS on LSE failure Detection Set by hardware to indicate when a failure is detected by the clock security system on the external 32 kHz oscillator (LSE): 0: No failure detected 1: Failure detected Bit 5   LSECSSON:   CSS on LSE enable Set by software to enable the clock security system on LSE (32 kHz) oscillator as follows: 0: Disable 1: Enable LSECSSON must be enabled after the LSE oscillator is enabled (LSEON bit enabled) and ready (LSERDY flag set by hardware), and after the RTCSEL bit is selected. Once enabled, this bit cannot be disabled, except after a LSE failure detection (LSECSSD =1). In that case the software   must   disable the LSECSSON bit. Bit 4   Reserved, must be kept at reset value. Bit 3   LSEDRV : LSE oscillator drive capability Set by software to select the LSE oscillator drive capability as follows: 0: medium-high driving capability 1: high driving capability Applicable when the LSE oscillator is in Xtal mode, as opposed to bypass mode. Bit 2   LSEBYP : LSE oscillator bypass Set and cleared by software to bypass the LSE oscillator (in debug mode). 0: Not bypassed 1: Bypassed This bit can be written only when the external 32 kHz oscillator is disabled (LSEON=0 and LSERDY=0). Bit 1   LSERDY : LSE oscillator ready Set and cleared by hardware to indicate when the external 32 kHz oscillator is ready (stable): 0: Not ready 1: Ready After the LSEON bit is cleared, LSERDY goes low after 6 external low-speed oscillator clock cycles. Bit 0   LSEON : LSE oscillator enable Set and cleared by software to enable LSE oscillator: 0: Disable 1: Enable

Reset and clock control (RCC)   RM0490  162/1027   RM0490 Rev 5  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 LPWR RSTF WWDG RSTF IWDG RSTF SFT RSTF PWR RSTF PIN RSTF OBL RSTF   Res.   RMVF   Res.   Res.   Res.   Res.   Res.   Res.   Res. r   r   r   r   r   r   r   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   LSI RDY   LSION r   rw Bit 31   LPWRRSTF : Low-power reset flag Set by hardware when a reset occurs due to illegal Stop, or Standby, or Shutdown mode entry. Cleared by setting the RMVF bit. 0: No illegal mode reset occurred 1: Illegal mode reset occurred This operates only if nRST_STOP, or nRST_STDBY or nRST_SHDW option bits are cleared. Bit 30   WWDGRSTF : Window watchdog reset flag Set by hardware when a window watchdog reset occurs. Cleared by setting the RMVF bit. 0: No window watchdog reset occurred 1: Window watchdog reset occurred Bit 29   IWDGRSTF : Independent window watchdog reset flag Set by hardware when an independent watchdog reset domain occurs. Cleared by setting the RMVF bit. 0: No independent watchdog reset occurred 1: Independent watchdog reset occurred Bit 28   SFTRSTF : Software reset flag Set by hardware when a software reset occurs. Cleared by setting the RMVF bit. 0: No software reset occurred 1: Software reset occurred Bit 27   PWRRSTF : BOR or POR/PDR flag Set by hardware when a BOR or POR/PDR occurs. Cleared by setting the RMVF bit. 0: No BOR or POR occurred 1: BOR or POR occurred Bit 26   PINRSTF : Pin or other system reset flag Set by hardware when a system reset from PF2-NRST pin or from any other source occurs. Cleared by setting the RMVF bit. 0: No system reset occurred 1: System reset occurred Bit 25   OBLRSTF : Option byte loader reset flag Set by hardware when a reset from the Option byte loading occurs. Cleared by setting the RMVF bit. 0: No reset from Option byte loading occurred 1: Reset from Option byte loading occurred Bit 24   Reserved, must be kept at reset value.

RM0490 Rev 5   163/1027  RM0490   Reset and clock control (RCC)  165  6.4.24   RCC register map  The following table gives the RCC register map and the reset values. Bit 23   RMVF : Remove reset flags Set by software to clear the reset flags. 0: No effect 1: Clear reset flags Bits 22:2   Reserved, must be kept at reset value. Bit 1   LSIRDY : LSI oscillator ready Set and cleared by hardware to indicate when the LSI oscillator is ready (stable): 0: Not ready 1: Ready After the LSION bit is cleared, LSIRDY goes low after 3 LSI oscillator clock cycles. This bit can be set even if LSION = 0 if the LSI is requested by the Clock Security System on LSE, by the Independent Watchdog or by the RTC. Bit 0   LSION : LSI oscillator enable Set and cleared by software to enable/disable the LSI oscillator: 0: Disable 1: Enable  Table 31. RCC register map and reset values Off- set   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00   RCC_CR Res. Res. Res. Res. Res. Res. Res. Res. HSIUSB48RDY HSIUSB48ON Res. Res. CSSON HSEBYP HSERDY HSEON Res. Res. HSIDIV[2:0] HSIRDY HSIKERON HSION HSIKERDIV[2:0] SYSDIV[2:0] Res. Res. Reset value   0   0   0   0   0   0   0   1   0   1   0   1   0   1   0   0   0   0 0x04   RCC_ICSCR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. HSITRIM[6:0]   HSICAL[7:0] Reset value   1   0   0   0   0   0   0   X   X   X   X   X   X   X   X 0x08   RCC_CFGR MCOPRE[3:0] MCOSEL[3:0] MCO2PRE[3:0] MCO2SEL[3:0] Res. PPRE[2:0] HPRE[3:0] Res. Res. SWS[2:0] SW[2:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x0C   Reserved Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. 0x10   Reserved Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. 0x14   RCC_CRRCR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. HSIUSB48CAL[8:0] Reset value   X   X   X   X   X   X   X   X   X   X 0x18   RCC_CIER Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. HSERDYIE HSIRDYIE HSIUSB48RDYIE LSERDYIE LSIRDYIE Reset value   0   0   0   0   0

Reset and clock control (RCC)   RM0490  164/1027   RM0490 Rev 5  0x1C   RCC_CIFR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. LSECSSF CSSF Res. Res. Res. HSERDYF HSIRDYF HSIUSB48RDYF LSERDYF LSIRDYF Reset value   0   0   0   0   0   0   0 0x20   RCC_CICR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. LSECSSC CSSC Res. Res. Res. HSERDYC HSIRDYC HSIUSB48RDYC LSERDYC LSIRDYC Reset value   0   0   0   0   0   0   0 0x24 RCC_ IOPRSTR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. GPIOFRST Res. GPIODRST GPIOCRST GPIOBRST GPIOARST Reset value   0   0   0   0   0 0x28 RCC_ AHBRSTR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CRCRST. Res. Res. Res. FLASHRST. Res. Res. Res. Res. Res. Res. Res. DMA1RST Reset value   0   0   0 0x2C RCC_ APBRSTR1 Res. Res. Res. PWRRST DBGRST Res. Res. Res. Res. Res. I2C1RST Res. USART4RST USART3RST USART2RST CRSRST USBRST SPI2RST Res. FDCAN1RST Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TIM3RST TIM2RST Reset value   0   0   0   0   0   0   0   0   0   0   0   0 0x30 RCC_ APBRSTR2 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. ADCRST Res. TIM17RST TIM16RST TIM15RST TIM14RST USART1RST Res. SPI1RST TIM1RST Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. SYSCFGRST Reset value   0   0   0   0   0   0   0   0   0 0x34 RCC_ IOPENR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. GPIOFEN Res. GPIODEN GPIOCEN GPIOBEN GPIOAEN Reset value   0   0   0   0   0 0x38 RCC_ AHBENR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CRCEN Res. Res. Res. FLASHEN Res. Res. Res. Res. Res. Res. Res. DMA1EN Reset value   0   1   0 0x3C RCC_ APBENR1 Res. Res. Res. PWREN DBGEN Res. Res. Res. Res. I2C2EN I2C1EN Res. USART4EN USART3EN USART2EN CRSEN Res. SPI2EN USBEN FDCAN1EN WWDGEN RTCAPBEN Res. Res. Res. Res. Res. Res. Res. Res. TIM3EN TIM2EN Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x40 RCC_ APBENR2 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. ADCEN Res. TIM17EN TIM16EN TIM15EN TIM14EN USART1EN Res. SPI1EN TIM1EN Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. SYSCFGEN Reset value   0   0   0   0   0   0   0   0   0  Table 31. RCC register map and reset values (continued) Off- set   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

RM0490 Rev 5   165/1027  RM0490   Reset and clock control (RCC)  165  Refer to   Section 2.2 on page 45   for the register boundary addresses. 0x44 RCC_ IOPSMENR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. GPIOFSMEN Res. GPIODSMEN GPIOCSMEN GPIOBSMEN GPIOASMEN Reset value   1   1   1   1   1 0x48 RCC_ AHBSMENR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CRCSMEN Res. Res. SRAMSMEN FLASHSMEN Res. Res. Res. Res. Res. Res. Res. DMA1SMEN Reset value   1   1   1   1 0x4C RCC_ APBSMENR1 Res. Res. Res. PWRSMEN DBGSMEN Res. Res. Res. Res. I2C2SMEN I2C1SMEN Res. USART4SMEN USART3SMEN USART2SMEN CRSSMEN Res. SPI2SMEN USBSMEN FDCAN1SMEN WWDGSMEN RTCAPBSMEN Res. Res. Res. Res. Res. Res. Res. Res. TIM3SMEN TIM2SMEN Reset value   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 0x50 RCC_ APBSMENR2 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. ADCSMEN Res. TIM17SMEN TIM16SMEN TIM15SMEN TIM14SMEN USART1SMEN Res. SPI1SMEN TIM1SMEN Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. SYSCFGSMEN Reset value   1   1   1   1   1   1   1   1   1 0x54   RCC_CCIPR ADCSEL[1:0] Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. I2S1SEL[1:0] I2C1SEL[1:0] Res. Res. FDCAN1SEL[1:0] Res. Res. Res. Res. Res. Res. USART1SEL[1:0] Reset value   0   0   0   0   0   0   0   0   0   0 0x58   RCC_CCIPR2 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. USBSEL Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Reset value   0 0x5C   RCC_CSR1 Res. Res. Res. Res. Res. Res. LSCOSEL LSCOEN Res. Res. Res. Res. Res. Res. Res. RTCRST RTCEN Res. Res. Res. Res. Res. RTC SEL[1:0] Res. LSECSSD LSECSSON Res. LSEDRV LSEBYP LSERDY LSEON Reset value   0   0   0   0   0   0   0   0   0   0   0   0 0x60   RCC_CSR2 LPWRRSTF WWDGRSTF IWDGRSTF SFTRSTF PWRRSTF PINRSTF OBLRSTF Res. RMVF Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. LSIRDY LSION Reset value   0   0   0   0   0   0   0   0   0   0  Table 31. RCC register map and reset values (continued) Off- set   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

Clock recovery system (CRS)   RM0490  166/1027   RM0490 Rev 5  7   Clock recovery system (CRS)  This section applies only to STM32C071xx devices.  7.1   CRS introduction  The clock recovery system (CRS) is an advanced digital controller acting on the internal fine-granularity trimmable RC oscillator HSIUSB. The CRS provides powerful means to evaluate the oscillator output frequency, based on comparison with a selectable synchronization signal. The CRS can perform automatic trimming adjustments based on the measured frequency error value, while keeping the possibility of a manual trimming. The CRS is ideally suited to provide a precise clock to the USB peripheral. In this case, the synchronization signal can be derived from the start-of-frame (SOF) packet signalization on the USB bus, sent by a USB host at 1 ms intervals. The synchronization signal can also be derived from alternative synchronization or generated by the user software.  7.2   CRS main features  •   Selectable synchronization source with programmable prescaler and polarity (see  Section 7.4.2: CRS internal signals )  •   Possibility to generate synchronization pulses by software  •   Automatic oscillator trimming capability with no need of CPU action  •   Manual control option for faster startup convergence  •   16-bit frequency error counter with automatic error value capture and reload  •   Programmable limit for automatic frequency error value evaluation and status reporting  •   Maskable interrupts/events: –   Expected synchronization (ESYNC) –   Synchronization OK (SYNCOK) –   Synchronization warning (SYNCWARN) –   Synchronization or trimming error (ERR)  7.3   CRS implementation  Table 32. CRS features Feature   CRS  TRIM width   7 bits

RM0490 Rev 5   167/1027  RM0490   Clock recovery system (CRS)  176  7.4   CRS functional description 7.4.1   CRS block diagram Figure 14. CRS block diagram 7.4.2   CRS internal signals  Below the list of CRS internal signals.  MSv69553V2  CRS  RCC SYNCSRC SYNC divider (/1, /2, /4,…, /128) SWSYNC RELOAD SYNC 16-bit counter FECAP 48 MHz clock 48 MHz clock to peripherals crs_sync_in_0 FELIM TRIM   FEDIR crs_sync_in_1 crs_sync_in_2 crs_sync_in_3 crs_it crs_pclk 32-bit AHB bus crs_trimx crs_48m_ck  Table 33. CRS internal input/output signals Internal signal name   Signal type   Description  crs_it   Digital output   CRS interrupt crs_pclk   Digital input   AHB bus clock crs_48m_ck   Digital input   HSIUSB 48 MHz clock crs_trim[0:6]   Digital output   HSIUSB oscillator smooth trimming value

Clock recovery system (CRS)   RM0490  168/1027   RM0490 Rev 5  7.4.3   Synchronization input  The CRS synchronization source (crs_sync_in_x) can be selected through SYNCSRC[1:0] bitfield of CRS_CFGR register (refer to   Section 7.4.2: CRS internal signals   for the possible sources). For a better robustness of the crs_sync_in_x input, a simple digital filter (2 out of 3 majority votes, sampled by the 48 MHz clock) is implemented to filter out glitches. In addition, the source signal has a configurable polarity (selected through SYNCPOL bit of CRS_CFGR). The signal can then be divided by a programmable binary prescaler to obtain a synchronization signal in a suitable frequency range (usually around 1 kHz). For more information on the CRS synchronization source configuration, refer to CRS_CFGR register. It is also possible to generate a synchronization event by software, by setting the SWSYNC bit in the CRS_CR register. For more information on the CRS synchronization source configuration, refer to   CRS configuration register (CRS_CFGR) . It is also possible to generate a synchronization event by software, by setting the SWSYNC bit in the CRS_CR register.  7.4.4   Frequency error measurement  The frequency error counter is a 16-bit down/up counter, reloaded with the RELOAD value on each SYNC event. It starts counting down until it reaches the zero value, where the ESYNC (expected synchronization) event is generated. Then it starts counting up to the OUTRANGE limit, where it eventually stops (if no SYNC event is received), and generates a SYNCMISS event. The OUTRANGE limit is defined as the frequency error limit (FELIM field of the CRS_CFGR register) multiplied by 128. When the SYNC event is detected, the actual value of the frequency error counter and its counting direction are stored in the FECAP (frequency error capture) field and in the FEDIR (frequency error direction) bit of the CRS_ISR register. When the SYNC event is detected during the down-counting phase (before reaching the zero value), it means that the actual crs_sync_in_0 Digital input   SYNC signal source crs_sync_in_1 crs_sync_in_2 crs_sync_in_3  Table 34. CRS interconnection Internal signal name   Description  crs_sync_in_0   GPIO selected as SYNC signal source crs_sync_in_1   LSE selected as SYNC signal source crs_sync_in_2   USB SOF selected as SYNC signal source (default) crs_sync_in_3   Reserved  Table 33. CRS internal input/output signals (continued) Internal signal name   Signal type   Description

RM0490 Rev 5   169/1027  RM0490   Clock recovery system (CRS)  176  frequency is lower than the target (the TRIM value must be incremented). When it is detected during the up-counting phase, it means that the actual frequency is higher (the TRIM value must be decremented).  Figure 15. CRS counter behavior 7.4.5   Frequency error evaluation and automatic trimming  The measured frequency error is evaluated by comparing its value with a set of limits:  •   TOLERANCE LIMIT, given directly in the FELIM field of the CRS_CFGR register  •   WARNING LIMIT, defined as 3 × FELIM value  •   OUTRANGE (error limit), defined as 128 × FELIM value The result of this comparison is used to generate the status indication and also to control the automatic trimming, which is enabled by setting the AUTOTRIMEN bit in the CRS_CR register:  •   When the frequency error is below the tolerance limit, it means that the actual trimming value in the TRIM field is the optimal one, hence no trimming action is needed. –   SYNCOK status indicated –   TRIM value not changed in AUTOTRIM mode  •   When the frequency error is below the warning limit but above or equal to the tolerance limit, it means that some trimming action is necessary but that adjustment by one trimming step is enough to reach the optimal TRIM value. –   SYNCOK status indicated  MSv32122V1  CRS counter value RELOAD OUTRANGE (128 x FELIM) WARNING LIMIT (3 x FELIM) TOLERANCE LIMIT (FELIM) SYNCERR   SYNCWARN   SYNCOK   SYNCWARN SYNCMISS +2   +1 0   -1   -2 0  Down   Up Frequency error counter stopped  0 Trimming action: CRS event: ESYNC

Clock recovery system (CRS)   RM0490  170/1027   RM0490 Rev 5  –   TRIM value adjusted by one trimming step in AUTOTRIM mode  •   When the frequency error is above or equal to the warning limit but below the error limit, a stronger trimming action is necessary, and there is a risk that the optimal TRIM value is not reached for the next period. –   SYNCWARN status indicated –   TRIM value adjusted by two trimming steps in AUTOTRIM mode  •   When the frequency error is above or equal to the error limit, the frequency is out of the trimming range. This can also happen when the SYNC input is not clean, or when some SYNC pulse is missing (for example when one USB SOF is corrupted). –   SYNCERR or SYNCMISS status indicated –   TRIM value not changed in AUTOTRIM mode  Note:   If the actual value of the TRIM field is close to its limits and the automatic trimming can force it to overflow or underflow, the TRIM value is set to the limit, and the TRIMOVF status is indicated. In AUTOTRIM mode (AUTOTRIMEN bit set in the CRS_CR register), the TRIM field of CRS_CR is adjusted by hardware and is read-only.  7.4.6   CRS initialization and configuration RELOAD value  The RELOAD value must be selected according to the ratio between the target frequency and the frequency of the synchronization source after prescaling. This value is decreased by 1, to reach the expected synchronization on the zero value. The formula is the following: RELOAD = (f   TARGET   / f   SYNC   ) - 1 The reset value of the RELOAD field corresponds to a target frequency of 48 MHz and a synchronization signal frequency of 1 kHz (SOF signal from USB).  FELIM value  The selection of the FELIM value is closely coupled with the HSIUSB oscillator characteristics and its typical trimming step size. The optimal value corresponds to half of the trimming step size, expressed as a number of oscillator clock ticks. The following formula can be used: FELIM = (f TARGET   / f SYNC   ) * STEP[%] / 100% / 2 The result must be always rounded up to the nearest integer value to obtain the best trimming response. If frequent trimming actions are not needed in the application, the hysteresis can be increased by slightly increasing the FELIM value. The reset value of the FELIM field corresponds to (f TARGET   / f SYNC   ) = 48000, and to a typical trimming step size of 0.14%.  Note:   The trimming step size depends upon the product, check the datasheet for accurate setting.  Caution:   There is no hardware protection from a wrong configuration of the RELOAD and FELIM fields, this can lead to an erratic trimming response. The expected operational mode requires proper setup of the RELOAD value (according to the synchronization source frequency), which is also greater than 128 * FELIM value (OUTRANGE limit).

RM0490 Rev 5   171/1027  RM0490   Clock recovery system (CRS)  176  7.5   CRS in low-power modes  7.6   CRS interrupts  7.7   CRS registers  Refer to   Section 1.2   for a list of abbreviations used in register descriptions. The peripheral registers can be accessed only by words (32-bit).  7.7.1   CRS control register (CRS_CR)  Address offset: 0x00 Reset value: 0x0000 4000  Table 35. Effect of low-power modes on CRS Mode   Description  Sleep   No effect. CRS interrupts cause the device to exit the Sleep mode. Stop   CRS registers are frozen. The CRS stops operating until the Stop mode is exited and the HSIUSB oscillator is restarted. Standby   The peripheral is powered down and must be reinitialized after exiting Standby mode. Shutdown   The peripheral is powered down and must be reinitialized after exiting Shutdown mode.  Table 36. Interrupt control bits Interrupt event   Event flag   Enable control bit Clear flag bit  Expected synchronization   ESYNCF   ESYNCIE   ESYNCC Synchronization OK   SYNCOKF   SYNCOKIE   SYNCOKC Synchronization warning   SYNCWARNF   SYNCWARNIE   SYNCWARNC Synchronization or trimming error (TRIMOVF, SYNCMISS, SYNCERR)   ERRF   ERRIE   ERRC 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   TRIM[6:0]   SW SYNC AUTO TRIMEN   CEN   Res.   ESYNC IE ERR IE SYNC WARNIE SYNC OKIE rw   rw   rw   rw   rw   rw   rw   rt_w1   rw   rw   rw   rw   rw   rw Bits 31:15   Reserved, must be kept at reset value. Bits 14:8   TRIM[6:0] : HSIUSB oscillator smooth trimming The default value of the HSIUSB oscillator smooth trimming is 64, which corresponds to the middle of the trimming interval.

Clock recovery system (CRS)   RM0490  172/1027   RM0490 Rev 5  7.7.2   CRS configuration register (CRS_CFGR)  This register can be written only when the frequency error counter is disabled (the CEN bit is cleared in CRS_CR). When the counter is enabled, this register is write-protected. Address offset: 0x04 Reset value: 0x2022 BB7F Bit 7   SWSYNC : Generate software SYNC event This bit is set by software in order to generate a software SYNC event. It is automatically cleared by hardware. 0: No action 1: A software SYNC event is generated. Bit 6   AUTOTRIMEN : Automatic trimming enable This bit enables the automatic hardware adjustment of TRIM bits according to the measured frequency error between two SYNC events. If this bit is set, the TRIM bits are read-only. The TRIM value can be adjusted by hardware by one or two steps at a time, depending on the measured frequency error value. Refer to   Section 7.4.5   for more details. 0: Automatic trimming disabled, TRIM bits can be adjusted by the user. 1: Automatic trimming enabled, TRIM bits are read-only and under hardware control. Bit 5   CEN : Frequency error counter enable This bit enables the oscillator clock for the frequency error counter. 0: Frequency error counter disabled 1: Frequency error counter enabled When this bit is set, the CRS_CFGR register is write-protected and cannot be modified. Bit 4   Reserved, must be kept at reset value. Bit 3   ESYNCIE : Expected SYNC interrupt enable 0: Expected SYNC (ESYNCF) interrupt disabled 1: Expected SYNC (ESYNCF) interrupt enabled Bit 2   ERRIE : Synchronization or trimming error interrupt enable 0: Synchronization or trimming error (ERRF) interrupt disabled 1: Synchronization or trimming error (ERRF) interrupt enabled Bit 1   SYNCWARNIE : SYNC warning interrupt enable 0: SYNC warning (SYNCWARNF) interrupt disabled 1: SYNC warning (SYNCWARNF) interrupt enabled Bit 0   SYNCOKIE : SYNC event OK interrupt enable 0: SYNC event OK (SYNCOKF) interrupt disabled 1: SYNC event OK (SYNCOKF) interrupt enabled 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 SYNCPOL   Res.   SYNCSRC[1:0]   Res.   SYNCDIV[2:0]   FELIM[7:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 RELOAD[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

RM0490 Rev 5   173/1027  RM0490   Clock recovery system (CRS)  176  7.7.3   CRS interrupt and status register (CRS_ISR)  Address offset: 0x08 Reset value: 0x0000 0000 Bit 31   SYNCPOL : SYNC polarity selection This bit is set and cleared by software to select the input polarity for the SYNC signal source. 0: SYNC active on rising edge (default) 1: SYNC active on falling edge Bit 30   Reserved, must be kept at reset value. Bits 29:28   SYNCSRC[1:0] : SYNC signal source selection These bits are set and cleared by software to select the SYNC signal source (see  Section 7.4.2: CRS internal signals ). 00: crs_sync_in_0 selected as SYNC signal source 01: crs_sync_in_1 selected as SYNC signal source 10: crs_sync_in_2 selected as SYNC signal source 11: crs_sync_in_3 selected as SYNC signal source  Note:   When using USB LPM (link power management) and the device is in Sleep mode, the periodic USB SOF is not generated by the host. No SYNC signal is therefore provided to the CRS to calibrate the 48 MHz clock on the run. To guarantee the required clock precision after waking up from Sleep mode, the LSE clock or the SYNC pin must be used as SYNC signal.  Bit 27   Reserved, must be kept at reset value. Bits 26:24   SYNCDIV[2:0] : SYNC divider These bits are set and cleared by software to control the division factor of the SYNC signal. 000: SYNC not divided (default) 001: SYNC divided by 2 010: SYNC divided by 4 011: SYNC divided by 8 100: SYNC divided by 16 101: SYNC divided by 32 110: SYNC divided by 64 111: SYNC divided by 128 Bits 23:16   FELIM[7:0] : Frequency error limit FELIM contains the value to be used to evaluate the captured frequency error value latched in the FECAP[15:0] bits of the CRS_ISR register. Refer to   Section 7.4.5   for more details about FECAP evaluation. Bits 15:0   RELOAD[15:0] : Counter reload value RELOAD is the value to be loaded in the frequency error counter with each SYNC event. Refer to   Section 7.4.4   for more details about counter behavior. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 FECAP[15:0] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 FEDIR   Res.   Res.   Res.   Res.   TRIM OVF SYNC MISS SYNC ERR   Res.   Res.   Res.   Res.   ESYNCF   ERRF   SYNC WARNF SYNC OKF r   r   r   r   r   r   r   r

Clock recovery system (CRS)   RM0490  174/1027   RM0490 Rev 5  Bits 31:16   FECAP[15:0] : Frequency error capture FECAP is the frequency error counter value latched in the time of the last SYNC event. Refer to   Section 7.4.5   for more details about FECAP usage. Bit 15   FEDIR : Frequency error direction FEDIR is the counting direction of the frequency error counter latched in the time of the last SYNC event. It shows whether the actual frequency is below or above the target. 0: Up-counting direction, the actual frequency is above the target 1: Down-counting direction, the actual frequency is below the target Bits 14:11   Reserved, must be kept at reset value. Bit 10   TRIMOVF : Trimming overflow or underflow This flag is set by hardware when the automatic trimming tries to over- or under-flow the TRIM value. An interrupt is generated if the ERRIE bit is set in the CRS_CR register. It is cleared by software by setting the ERRC bit in the CRS_ICR register. 0: No trimming error signaled 1: Trimming error signaled Bit 9   SYNCMISS : SYNC missed This flag is set by hardware when the frequency error counter reaches value FELIM * 128 and no SYNC is detected, meaning either that a SYNC pulse was missed, or the frequency error is too big (internal frequency too high) to be compensated by adjusting the TRIM value, hence some other action must be taken. At this point, the frequency error counter is stopped (waiting for a next SYNC), and an interrupt is generated if the ERRIE bit is set in the CRS_CR register. It is cleared by software by setting the ERRC bit in the CRS_ICR register. 0: No SYNC missed error signaled 1: SYNC missed error signaled Bit 8   SYNCERR : SYNC error This flag is set by hardware when the SYNC pulse arrives before the ESYNC event and the measured frequency error is greater than or equal to FELIM * 128. This means that the frequency error is too big (internal frequency too low) to be compensated by adjusting the TRIM value, and that some other action has to be taken. An interrupt is generated if the ERRIE bit is set in the CRS_CR register. It is cleared by software by setting the ERRC bit in the CRS_ICR register. 0: No SYNC error signaled 1: SYNC error signaled Bits 7:4   Reserved, must be kept at reset value. Bit 3   ESYNCF : Expected SYNC flag This flag is set by hardware when the frequency error counter reached a zero value. An interrupt is generated if the ESYNCIE bit is set in the CRS_CR register. It is cleared by software by setting the ESYNCC bit in the CRS_ICR register. 0: No expected SYNC signaled 1: Expected SYNC signaled Bit 2   ERRF : Error flag This flag is set by hardware in case of any synchronization or trimming error. It is the logical OR of the TRIMOVF, SYNCMISS and SYNCERR bits. An interrupt is generated if the ERRIE bit is set in the CRS_CR register. It is cleared by software in reaction to setting the ERRC bit in the CRS_ICR register, which clears the TRIMOVF, SYNCMISS and SYNCERR bits. 0: No synchronization or trimming error signaled 1: Synchronization or trimming error signaled

RM0490 Rev 5   175/1027  RM0490   Clock recovery system (CRS)  176  7.7.4   CRS interrupt flag clear register (CRS_ICR)  Address offset: 0x0C Reset value: 0x0000 0000 Bit 1   SYNCWARNF : SYNC warning flag This flag is set by hardware when the measured frequency error is greater than or equal to FELIM * 3, but smaller than FELIM * 128. This means that to compensate the frequency error, the TRIM value must be adjusted by two steps or more. An interrupt is generated if the SYNCWARNIE bit is set in the CRS_CR register. It is cleared by software by setting the SYNCWARNC bit in the CRS_ICR register. 0: No SYNC warning signaled 1: SYNC warning signaled Bit 0   SYNCOKF : SYNC event OK flag This flag is set by hardware when the measured frequency error is smaller than FELIM * 3. This means that either no adjustment of the TRIM value is needed or that an adjustment by one trimming step is enough to compensate the frequency error. An interrupt is generated if the SYNCOKIE bit is set in the CRS_CR register. It is cleared by software by setting the SYNCOKC bit in the CRS_ICR register. 0: No SYNC event OK signaled 1: SYNC event OK signaled 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   ESYNCC   ERRC   SYNC WARNC SYNC OKC rw   rw   rw   rw Bits 31:4   Reserved, must be kept at reset value. Bit 3   ESYNCC : Expected SYNC clear flag Writing 1 to this bit clears the ESYNCF flag in the CRS_ISR register. Bit 2   ERRC : Error clear flag Writing 1 to this bit clears TRIMOVF, SYNCMISS, and SYNCERR bits and consequently also the ERRF flag in the CRS_ISR register. Bit 1   SYNCWARNC : SYNC warning clear flag Writing 1 to this bit clears the SYNCWARNF flag in the CRS_ISR register. Bit 0   SYNCOKC : SYNC event OK clear flag Writing 1 to this bit clears the SYNCOKF flag in the CRS_ISR register.

Clock recovery system (CRS)   RM0490  176/1027   RM0490 Rev 5  7.7.5   CRS register map  Refer to   Section 2.2   for the register boundary addresses.  Table 37. CRS register map and reset values Offset   Register name Reset value 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00   CRS_CR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TRIM[6:0] SWSYNC AUTOTRIMEN CEN Res. ESYNCIE ERRIE SYNCWARNIE SYNCOKIE Reset value   0x0000 4000 0x04   CRS_CFGR SYNCPOL Res.   SYNC SRC [1:0] Res.   SYNC DIV [2:0] FELIM[7:0]   RELOAD[15:0] Reset value   0   1   0   0   0   0   0   0   1   0   0   0   1   0   1   0   1   1   1   0   1   1   0   1   1   1   1   1   1   1 0x08   CRS_ISR   FECAP[15:0] FEDIR Res. Res. Res. Res. TRIMOVF SYNCMISS SYNCERR Res. Res. Res. Res. ESYNCF ERRF SYNCWARNF SYNCOKF Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x0C   CRS_ICR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. ESYNCC ERRC SYNCWARNC SYNCOKC Reset value   0   0   0   0

RM0490 Rev 5   177/1027  RM0490   General-purpose I/Os (GPIO)  194  8   General-purpose I/Os (GPIO) 8.1   Introduction  Each general-purpose I/O port has four 32-bit configuration registers (GPIOx_MODER, GPIOx_OTYPER, GPIOx_OSPEEDR and GPIOx_PUPDR), two 32-bit data registers (GPIOx_IDR and GPIOx_ODR) and a 32-bit set/reset register (GPIOx_BSRR). In addition all GPIOs have a 32-bit locking register (GPIOx_LCKR) and two 32-bit alternate function selection registers (GPIOx_AFRH and GPIOx_AFRL).  8.2   GPIO main features  •   Output states: push-pull or open drain + pull-up/down  •   Output data from output data register (GPIOx_ODR) or peripheral (alternate function output)  •   Speed selection for each I/O  •   Input states: floating, pull-up/down, I/O analog mode  •   Input data to input data register (GPIOx_IDR) or peripheral (alternate function input)  •   Bit set and reset register (GPIOx_ BSRR) for bitwise write access to GPIOx_ODR  •   Locking mechanism (GPIOx_LCKR) provided to freeze the I/O port configurations  •   Analog function  •   Alternate function selection registers (at most 16 AFs possible per I/O)  •   Fast toggle capable of changing every two clock cycles  •   Highly flexible pin multiplexing allows the use of I/O pins as GPIOs or as one of several peripheral functions  8.3   GPIO functional description  Subject to the specific hardware characteristics of each I/O port listed in the datasheet, each port bit of the general-purpose I/O (GPIO) ports can be individually configured by software in several modes:  •   Input floating  •   Input pull-up  •   Input-pull-down  •   Analog  •   Output open-drain with pull-up or pull-down capability  •   Output push-pull with pull-up or pull-down capability  •   Alternate function push-pull with pull-up or pull-down capability  •   Alternate function open-drain with pull-up or pull-down capability Each I/O port bit is freely programmable, however the I/O port registers have to be accessed as 32-bit words, half-words or bytes. The purpose of the GPIOx_BSRR and GPIOx_BRR registers is to allow atomic read/modify accesses to any of the GPIOx_ODR registers. In this way, there is no risk of an IRQ occurring between the read and the modify access.

General-purpose I/Os (GPIO)   RM0490  178/1027   RM0490 Rev 5  Figure 16   shows the basic structures of a standard I/O port bit.   Table 38   gives the possible port bit configurations.  Figure 16. Basic structure of an I/O port bit  MSv33182V2 Output control Output data register Bit set/reset registers Input data register Read To/from on-chip peripherals, power control and EXTI Analog input/output P-MOS Output driver   V DDIOx V SS N-MOS Push-pull, open-drain or disabled V SS V   DDIOx on/off on/off I/O pin TTL Schmitt trigger On/off Write Read/write Pull up Pull down Input driver Digital input Alternate function output From on-chip peripheral  Table 38. Port bit configuration table   (1) MODE(i) [1:0]   OTYPE(i)   OSPEED(i) [1:0] PUPD(i) [1:0]   I/O configuration  01 0 SPEED [1:0] 0   0   GP output   PP 0   0   1   GP output   PP + PU 0   1   0   GP output   PP + PD 0   1   1   Reserved 1   0   0   GP output   OD 1   0   1   GP output   OD + PU 1   1   0   GP output   OD + PD 1   1   1   Reserved (GP output OD) 10 0 SPEED [1:0] 0   0   AF   PP 0   0   1   AF   PP + PU 0   1   0   AF   PP + PD 0   1   1   Reserved 1   0   0   AF   OD 1   0   1   AF   OD + PU 1   1   0   AF   OD + PD 1   1   1   Reserved

RM0490 Rev 5   179/1027  RM0490   General-purpose I/Os (GPIO)  194  8.3.1   General-purpose I/O (GPIO)  During and just after reset, the alternate functions are not active and most of the I/O ports are configured in analog mode. The debug pins are in AF pull-up/pull-down after reset:  •   PA14: SWCLK in pull-down  •   PA13: SWDIO in pull-up  Note:   PA14 is shared with BOOT0 functionality. Caution is required as the debugging device can manipulate BOOT0 pin value.  When the pin is configured as output, the value written to the output data register (GPIOx_ODR) is output on the I/O pin. It is possible to use the output driver in push-pull mode or open-drain mode (only the low level is driven, high level is HI-Z). The input data register (GPIOx_IDR) captures the data present on the I/O pin at every AHB clock cycle. All GPIO pins have weak internal pull-up and pull-down resistors, which can be activated or not depending on the value in the GPIOx_PUPDR register. The GPIO pins can operate as:  •   GPIO:   output, input, or analog I/O, depending on the GPIOx_MODER register setting  •   Alternate function  The GPIOs with debug alternate functions are set to Alternate function mode upon reset.  •   Additional function  Available for some GPIO pins, the Additional function mode is set through the control registers of the corresponding functional block such as ADC, DAC, RTC, RCC, and PWR, regardless of the GPIOx_MODER register setting. When an I/O is set in Additional function mode, it is recommended to set its corresponding GPIO multiplexer in the GPIOx_MODER register to Analog mode. 00 x   x   x   0   0   Input   Floating x   x   x   0   1   Input   PU x   x   x   1   0   Input   PD x   x   x   1   1   Reserved (input floating) 11 x   x   x   0   0   Input/output   Analog x   x   x   0   1 Reserved x   x   x   1   0 x   x   x   1   1 1.   GP = general-purpose, PP = push-pull, PU = pull-up, PD = pull-down, OD = open-drain, AF = alternate function.  Table 38. Port bit configuration table (1)   (continued) MODE(i) [1:0]   OTYPE(i)   OSPEED(i) [1:0] PUPD(i) [1:0]   I/O configuration

General-purpose I/Os (GPIO)   RM0490  180/1027   RM0490 Rev 5  8.3.2   I/O pin alternate function multiplexer and mapping  Each functional block signal to connect on the device pins as alternate function is internally routed towards multiple GPIO pins. Each GPIO pin has a multiplexer with 16 positions (AF0 to AF15) controlled through the GPIOx_AFRL and GPIOx_AFRH registers, to select one of up to 16 alternate functions at a time. The alternate function selected for a GPIO pin is physically connected to the pin through GPIO mode multiplexer controlled by the GPIOx_MODER register. Upon reset, the alternate function multiplexer on each GPIO is set to AF0 position. This flexibility eases PCB routing and allows configuring small pin-count devices to match the application requirements. The mapping of alternate function signals to GPIO alternate function multiplexers is detailed in the device datasheet. To use an I/O in a given configuration, proceed as detailed in the following subsections.  Debug function  After each device reset, these pins are assigned as alternate function pins.  GPIO  Configure the desired I/O as output, input, or as an analog port, through the GPIOx_MODER register.  Peripheral alternate function  •   Connect the I/O to the desired AFx, through either GPIOx_AFRL or GPIOx_AFRH register.  •   Select the type, the pull-up or pull-down device, and the output speed via the GPIOx_OTYPER, GPIOx_PUPDR, and GPIOx_OSPEEDR register, respectively.  •   Configure the desired I/O as an alternate function, through the GPIOx_MODER register.  Cortex   ®   -M0+ alternate function (EVENTOUT)  The Cortex ® -M0+ output EVENTOUT signal can be used by configuring the I/O pin to output at the dedicated AF. An event can be signaled through the configured pin after executing the SEV instruction.  Additional functions  •   For the ADC, configure the desired I/O in analog mode, through the GPIOx_MODER register. Then configure the required function, through the ADC registers.  •   For the additional functions such as RTC, WKUPx, and oscillators, configure the required function through the related RTC, PWR, and RCC registers. These functions have priority over the configuration through the standard GPIO registers.

RM0490 Rev 5   181/1027  RM0490   General-purpose I/Os (GPIO)  194  8.3.3   I/O port control registers  Each of the GPIO ports has four 32-bit memory-mapped control registers (GPIOx_MODER, GPIOx_OTYPER, GPIOx_OSPEEDR, GPIOx_PUPDR) to configure up to 16 I/Os. The GPIOx_MODER register is used to select the I/O mode (input, output, AF, analog). The GPIOx_OTYPER and GPIOx_OSPEEDR registers are used to select the output type (push- pull or open-drain) and speed. The GPIOx_PUPDR register is used to select the pull- up/pull-down whatever the I/O direction.  8.3.4   I/O port data registers  Each GPIO has two 16-bit memory-mapped data registers: input and output data registers (GPIOx_IDR and GPIOx_ODR). GPIOx_ODR stores the data to be output, it is read/write accessible. The data input through the I/O are stored into the input data register (GPIOx_IDR), a read-only register. See   Section 8.5.5: GPIO port input data register (GPIOx_IDR) (x = A, B, C, D, F)   and  Section 8.5.6: GPIO port output data register (GPIOx_ODR) (x = A, B, C, D, F)   for the register descriptions.  8.3.5   I/O data bitwise handling  The bit set reset register (GPIOx_BSRR) is a 32-bit register which allows the application to set and reset each individual bit in the output data register (GPIOx_ODR). The bit set reset register has twice the size of GPIOx_ODR. To each bit in GPIOx_ODR, correspond two control bits in GPIOx_BSRR: BS(i) and BR(i). When written to 1, bit BS(i)   sets   the corresponding ODR(i) bit. When written to 1, bit BR(i)  resets   the ODR(i) corresponding bit. Writing any bit to 0 in GPIOx_BSRR does not have any effect on the corresponding bit in GPIOx_ODR. If there is an attempt to both set and reset a bit in GPIOx_BSRR, the set action takes priority. Using the GPIOx_BSRR register to change the values of individual bits in GPIOx_ODR is a “one-shot” effect that does not lock the GPIOx_ODR bits. The GPIOx_ODR bits can always be accessed directly. The GPIOx_BSRR register provides a way of performing atomic bitwise handling. There is no need for the software to disable interrupts when programming the GPIOx_ODR at bit level: it is possible to modify one or more bits in a single atomic AHB write access.  8.3.6   GPIO locking mechanism  It is possible to freeze the GPIO control registers by applying a specific write sequence to the GPIOx_LCKR register. The frozen registers are GPIOx_MODER, GPIOx_OTYPER, GPIOx_OSPEEDR, GPIOx_PUPDR, GPIOx_AFRL and GPIOx_AFRH. To write the GPIOx_LCKR register, a specific write / read sequence has to be applied. When the right LOCK sequence is applied to bit 16 in this register, the value of LCKR[15:0] is used to lock the configuration of the I/Os (during the write sequence the LCKR[15:0] value must be the same). When the LOCK sequence has been applied to a port bit, the value of the port bit can no longer be modified until the next MCU reset or peripheral reset. Each GPIOx_LCKR bit freezes the corresponding bit in the control registers (GPIOx_MODER, GPIOx_OTYPER, GPIOx_OSPEEDR, GPIOx_PUPDR, GPIOx_AFRL and GPIOx_AFRH.

General-purpose I/Os (GPIO)   RM0490  182/1027   RM0490 Rev 5  The LOCK sequence (refer to   Section 8.5.8: GPIO port configuration lock register (GPIOx_LCKR) (x = A, B, C, D, F) ) can only be performed using a word (32-bit long) access to the GPIOx_LCKR register due to the fact that GPIOx_LCKR bit 16 has to be set at the same time as the [15:0] bits. For more details refer to LCKR register description in   Section 8.5.8: GPIO port configuration lock register (GPIOx_LCKR) (x = A, B, C, D, F) .  8.3.7   I/O alternate function input/output  When an I/O pin operates in Alternate function mode, the alternate function selected determines whether it acts as an input or as an output. The pull-up/pull-down and output speed settings (via the GPIOx_OTYPER, GPIOx_PUPDR and GPIOx_OSPEEDER registers, respectively) remain effective.  8.3.8   External interrupt/wake-up lines  All ports have external interrupt capability. To use external interrupt lines, the given pin must not be configured in analog mode or being used as oscillator pin, so the input trigger is kept enabled. Refer to   Section 14: Extended interrupt and event controller (EXTI).  8.3.9   Input configuration  When the I/O port is programmed as input:  •   The output buffer is disabled  •   The Schmitt trigger input is activated  •   The pull-up and pull-down resistors are activated depending on the value in the GPIOx_PUPDR register  •   The data present on the I/O pin are sampled into the input data register every AHB clock cycle  •   A read access to the input data register provides the I/O state  Figure 17   shows the input configuration of the I/O port bit.

RM0490 Rev 5   183/1027  RM0490   General-purpose I/Os (GPIO)  194  Figure 17. Input floating/pull up/pull down configurations 8.3.10   Output configuration  When the I/O port is programmed as output:  •   The output buffer is enabled: –   Open drain mode: A “0” in the Output register activates the N-MOS whereas a “1” in the Output register leaves the port in Hi-Z (the P-MOS is never activated) –   Push-pull mode: A “0” in the Output register activates the N-MOS whereas a “1” in the Output register activates the P-MOS  •   The Schmitt trigger input is activated  •   The pull-up and pull-down resistors are activated depending on the value in the GPIOx_PUPDR register  •   The data present on the I/O pin are sampled into the input data register every AHB clock cycle  •   A read access to the input data register gets the I/O state  •   A read access to the output data register gets the last written value  Figure 18   shows the output configuration of the I/O port bit.  MSv33183V2 Output data register Bit set/reset registers Input data register Read To / from on-chip peripherals, power control and EXTI Analog input/output Output driver V SS V DDIOx on/off on/off I/O pin TTL Schmitt trigger On Write Read/write Pull up Pull down Input driver

General-purpose I/Os (GPIO)   RM0490  184/1027   RM0490 Rev 5  Figure 18. Output configuration 8.3.11   Alternate function configuration  When the I/O port is programmed as alternate function:  •   The output buffer can be configured in open-drain or push-pull mode  •   The output buffer is driven by the signals coming from the peripheral (transmitter enable and data)  •   The Schmitt trigger input is activated  •   The weak pull-up and pull-down resistors are activated or not depending on the value in the GPIOx_PUPDR register  •   The data present on the I/O pin are sampled into the input data register every AHB clock cycle  •   A read access to the input data register gets the I/O state  Figure 19   shows the Alternate function configuration   of the I/O port bit.  MSv33184V3 Output control Output data register Bit set/reset registers Input data register Read To / from on-chip peripherals, power control and EXTI Analog input/output P-MOS Output driver   V DDIOx V   SS N-MOS Push-pull or open-drain V SS V DDIOx on/off on/off I/O pin TTL Schmitt trigger On Write Read/write Pull up Pull down Input driver

RM0490 Rev 5   185/1027  RM0490   General-purpose I/Os (GPIO)  194  Figure 19. Alternate function configuration- 8.3.12   Analog configuration  When the I/O port is programmed as analog configuration:  •   The output buffer is disabled  •   The Schmitt trigger input is deactivated, providing zero consumption for every analog value of the I/O pin. The output of the Schmitt trigger is forced to a constant value (0).  •   The weak pull-up and pull-down resistors are disabled by hardware  •   Read access to the input data register gets the value “0”  Figure 20   shows the high-impedance, analog configuration of the I/O port bits.  Figure 20. High impedance-analog configuration  MSv31479V2 Output control Output data register Bit set/reset registers Input data register Read To/from on-chip peripheral Analog input/output P-MOS Output driver   V DDIOx V SS N-MOS Push-pull or open-drain V   SS V   DDIOx on/off on/off I/O pin TTL Schmitt trigger On Write Read/write Pull up Pull down Input driver Alternate function input Alternate function output From on-chip peripheral  MSv33185V2 Output data register Bit set/reset registers Input data register Read To/from on-chip peripheral   Analog input/output Output driver   I/O pin TTL Schmitt trigger Off Write Read/write Input driver 0

General-purpose I/Os (GPIO)   RM0490  186/1027   RM0490 Rev 5  8.3.13   Using the HSE or LSE oscillator pins as GPIOs  When the HSE or LSE oscillator is switched OFF (default state after reset), the related oscillator pins can be used as GPIOs. When the HSE or LSE oscillator is switched ON (by setting the HSEON or LSEON bit of the RCC_CSR register), the oscillator takes control of its associated pins and the GPIO configuration of these pins has no effect. When HSE or LSE oscillator is bypassed, its input pin is used as external clock input and its output pin is free for use as GPIO. For the devices housed in 48-pin packages, the HSE and LSE oscillators have separate input and output pins (see HSE_NOT_REMAPPED bit of the FLASH option bytes). On packages with less than 48 pins, HSE and LSE oscillators have one common input pin OSCX_IN and one common output pin OSCX_OUT, which restricts their use to one at a time (the other must be disabled).  8.3.14   Low pin count package adjustment  Due to the restriction of some low pin count packages, multiple GPIOs are connected to the same I/O pins. The SYSCFG_CFGR3 register allows selecting which of them is active, to prevent conflicts.  8.3.15   Reset pin (PF2-NRST) in GPIO mode  The PF2-NRST pin can be configured as reset I/O or as a GPIO. To configure PF2-NRST as a GPIO (input, output, AF, or analog I/O), set the NRST_MODE bitfield to GPIO mode in the FLASH option bytes. The new setting only takes effect upon the option byte loading (OBL) event following a reset. Until the reset release, PF2-NRST keeps acting as reset I/O. The user must ensure that, upon power-on, the level on the NRST pin can exceed the minimum V   IH(NRST)   level specified in the device datasheet. Otherwise, the device does not exit the power-on reset. This applies to any NRST configuration set through the NRST_MODE[1:0] bitfield, the GPIO mode inclusive. When PF2-NRST acts as a GPIO, reset can only be triggered from one of the device internal reset sources and the reset signal cannot be output. For further information on reset function, refer to the   RCC   section.  8.4   GPIO in low-power modes  Table 39. Effect of low-power modes on the GPIO Mode   Description  Sleep   No effect. GPIO (EXTI) interrupts cause the device to exit Sleep mode. Stop   No effect. GPIO (EXTI) interrupts cause the device to exit Stop mode.

RM0490 Rev 5   187/1027  RM0490   General-purpose I/Os (GPIO)  194  8.5   GPIO registers  This section gives a detailed description of the GPIO registers. For a summary of register bits, register address offsets and reset values, refer to   Table 40 . The peripheral registers can be written in word, half word or byte mode. Port D is only available on STM32C03xx products.  8.5.1   GPIO port mode register (GPIOx_MODER) (x =A, B, C, D, F)  Address offset:0x00 Reset value: 0xEBFF FFFF (port A) Reset value: 0xFFFF FFFF (ports other than A) Standby The GPIO digital interface is powered down and must be reinitialized after exiting Standby mode. Wake-up pins can be configured to cause the device to exit Standby mode. GPIO’s are set to analog mode by hardware. Pull-up or pull-down device can individually be enabled through the PWR_PUCRx and PWR_PDCRx registers, respectively, to keep the I/Os at defined levels. Shutdown The GPIO digital interface is powered down and must be reinitialized after exiting Shutdown mode. Wake-up pins can be configured to cause the device to exit Shutdown mode. The GPIO’s are set to analog mode by hardware. Pull-up or pull-down device can individually be enabled through the PWR_PUCRx and PWR_PDCRx registers, respectively, to keep the I/Os at defined levels.  Table 39. Effect of low-power modes on the GPIO (continued) Mode   Description  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 MODE15[1:0]   MODE14[1:0]   MODE13[1:0]   MODE12[1:0]   MODE11[1:0]   MODE10[1:0]   MODE9[1:0]   MODE8[1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 MODE7[1:0]   MODE6[1:0]   MODE5[1:0]   MODE4[1:0]   MODE3[1:0]   MODE2[1:0]   MODE1[1:0]   MODE0[1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:0   MODEy[1:0]:   Port x configuration for I/O y (y = 15 to 0) These bits are written by software to set the I/O to one of four operating modes. 00: Input 01: Output 10: Alternate function 11: Analog

General-purpose I/Os (GPIO)   RM0490  188/1027   RM0490 Rev 5  8.5.2   GPIO port output type register (GPIOx_OTYPER) (x = A, B, C, D, F)  Address offset: 0x04 Reset value: 0x0000 0000  8.5.3   GPIO port output speed register (GPIOx_OSPEEDR) (x = A, B, C, D, F)  Address offset: 0x08 Reset value: 0x0C00 0000 (for port A) Reset value: 0x0000 0000 (ports other than A)  8.5.4   GPIO port pull-up/pull-down register (GPIOx_PUPDR) (x = A, B, C, D, F)  Address offset: 0x0C 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 OT15   OT14   OT13   OT12   OT11   OT10   OT9   OT8   OT7   OT6   OT5   OT4   OT3   OT2   OT1   OT0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   OTy:   Port x configuration for I/O y (y = 15 to 0) These bits are written by software to configure the I/O output type. 0: Output push-pull (reset state) 1: Output open-drain 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 OSPEED15 [1:0] OSPEED14 [1:0] OSPEED13 [1:0] OSPEED12 [1:0] OSPEED11 [1:0] OSPEED10 [1:0] OSPEED9 [1:0] OSPEED8 [1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 OSPEED7 [1:0] OSPEED6 [1:0] OSPEED5 [1:0] OSPEED4 [1:0] OSPEED3 [1:0] OSPEED2 [1:0] OSPEED1 [1:0] OSPEED0 [1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:0   OSPEEDy[1:0] : Port x configuration for I/O y (y = 15 to 0) These bits are written by software to configure the I/O output speed. 00: Very low speed 01: Low speed 10: High speed 11: Very high speed  Note:   Refer to the device datasheet for the frequency specifications and the power supply and load conditions for each speed.. The FT_c GPIOs cannot be set to high speed.

RM0490 Rev 5   189/1027  RM0490   General-purpose I/Os (GPIO)  194  Reset value: 0x2400 0000 (for port A) Reset value: 0x0000 0000 (ports other than A)  8.5.5   GPIO port input data register (GPIOx_IDR) (x = A, B, C, D, F)  Address offset: 0x10 Reset value: 0x0000 XXXX  8.5.6   GPIO port output data register (GPIOx_ODR) (x = A, B, C, D, F)  Address offset: 0x14 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 PUPD15[1:0]   PUPD14[1:0]   PUPD13[1:0]   PUPD12[1:0]   PUPD11[1:0]   PUPD10[1:0]   PUPD9[1:0]   PUPD8[1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 PUPD7[1:0]   PUPD6[1:0]   PUPD5[1:0]   PUPD4[1:0]   PUPD3[1:0]   PUPD2[1:0]   PUPD1[1:0]   PUPD0[1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:0   PUPDy[1:0]:   Port x configuration I/O y (y = 15 to 0) These bits are written by software to configure the I/O pull-up or pull-down 00: No pull-up, pull-down 01: Pull-up 10: Pull-down 11: Reserved  Note:   On the same pin, this pull up/down must not be activated when a pull down/up is set through the PWR_PDCRx/PWR_PUCRx registers.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ID15   ID14   ID13   ID12   ID11   ID10   ID9   ID8   ID7   ID6   ID5   ID4   ID3   ID2   ID1   ID0 r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   IDy:   Port x input data I/O y (y = 15 to 0) These bits are read-only. They contain the input value of the corresponding I/O port. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 OD15   OD14   OD13   OD12   OD11   OD10   OD9   OD8   OD7   OD6   OD5   OD4   OD3   OD2   OD1   OD0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

General-purpose I/Os (GPIO)   RM0490  190/1027   RM0490 Rev 5  8.5.7   GPIO port bit set/reset register (GPIOx_BSRR) (x = A, B, C, D, F)  Address offset: 0x18 Reset value: 0x0000 0000  8.5.8   GPIO port configuration lock register (GPIOx_LCKR) (x = A, B, C, D, F)  This register is used to lock the configuration of the port bits when a correct write sequence is applied to bit 16 (LCKK). The value of bits [15:0] is used to lock the configuration of the GPIO. During the write sequence, the value of LCKR[15:0] must not change. When the LOCK sequence has been applied on a port bit, the value of this port bit can no longer be modified until the next MCU reset or peripheral reset.  Note:   A specific write sequence is used to write to the GPIOx_LCKR register. Only word access (32-bit long) is allowed during this locking sequence.  Each lock bit freezes a specific configuration register (control and alternate function registers). Address offset: 0x1C Reset value: 0x0000 0000 Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   ODy:   Port output data I/O y (y = 15 to 0) These bits can be read and written by software.  Note:   For atomic bit set/reset, the OD bits can be individually set and/or reset by writing to the GPIOx_BSRR register (x = A, B, C, D, F).  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 BR15   BR14   BR13   BR12   BR11   BR10   BR9   BR8   BR7   BR6   BR5   BR4   BR3   BR2   BR1   BR0 w   w   w   w   w   w   w   w   w   w   w   w   w   w   w   w 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 BS15   BS14   BS13   BS12   BS11   BS10   BS9   BS8   BS7   BS6   BS5   BS4   BS3   BS2   BS1   BS0 w   w   w   w   w   w   w   w   w   w   w   w   w   w   w   w Bits 31:16   BRy:   Port x reset I/O y (y = 15 to 0) These bits are write-only. A read operation always returns 0x0000. 0: No action on the corresponding ODRx bit 1: Resets the corresponding ODRx bit  Note:   If both BSx and BRx are set, BSx has priority.  Bits 15:0   BSy:   Port x set I/O y (y = 15 to 0) These bits are write-only. A read operation always returns 0x0000. 0: No action on the corresponding ODRx bit 1: Sets the corresponding ODRx bit

RM0490 Rev 5   191/1027  RM0490   General-purpose I/Os (GPIO)  194  8.5.9   GPIO alternate function low register (GPIOx_AFRL) (x = A, B, C, D, F)  Address offset: 0x20 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   LCKK rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 LCK15   LCK14   LCK13   LCK12   LCK11   LCK10   LCK9   LCK8   LCK7   LCK6   LCK5   LCK4   LCK3   LCK2   LCK1   LCK0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:17   Reserved, must be kept at reset value. Bit 16   LCKK:   Lock key This bit can be read any time. It can only be modified using the lock key write sequence. 0: Port configuration lock key not active 1: Port configuration lock key active. The GPIOx_LCKR register is locked until the next MCU reset or peripheral reset. LOCK key write sequence: WR LCKR[16] = ‘1’ + LCKR[15:0] WR LCKR[16] = ‘0’ + LCKR[15:0] WR LCKR[16] = ‘1’ + LCKR[15:0] RD LCKR RD LCKR[16] = ‘1’ (this read operation is optional but it confirms that the lock is active)  Note:   During the LOCK key write sequence, the value of LCK[15:0] must not change. Any error in the lock sequence aborts the lock. After the first lock sequence on any bit of the port, any read access on the LCKK bit returns ‘1’ until the next MCU reset or peripheral reset.  Bits 15:0   LCK[15:0]:   Port x lock I/O pin y (y = 15 to 0) These bits are read/write but can only be written when the LCKK bit is ‘0. 0: Port configuration not locked 1: Port configuration locked 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 AFSEL7[3:0]   AFSEL6[3:0]   AFSEL5[3:0]   AFSEL4[3:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 AFSEL3[3:0]   AFSEL2[3:0]   AFSEL1[3:0]   AFSEL0[3:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

General-purpose I/Os (GPIO)   RM0490  192/1027   RM0490 Rev 5  8.5.10   GPIO alternate function high register (GPIOx_AFRH) (x = A, B, C, D, F)  Address offset: 0x24 Reset value: 0x0000 0000 Bits 31:0   AFSELy[3:0]:   Alternate function selection for port x pin y (y = 7 to 0) These bits are written by software to configure alternate function I/Os 0000: AF0 0001: AF1 0010: AF2 0011: AF3 0100: AF4 0101: AF5 0110: AF6 0111: AF7 1000: AF8 1001: AF9 1010: AF10 1011: AF11 1100: AF12 1101: AF13 1110: AF14 1111: AF15 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 AFSEL15[3:0]   AFSEL14[3:0]   AFSEL13[3:0]   AFSEL12[3:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 AFSEL11[3:0]   AFSEL10[3:0]   AFSEL9[3:0]   AFSEL8[3:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:0   AFSELy[3:0]:   Alternate function selection for port x, I/O y (y = 15 to 8) These bits are written by software to configure alternate function I/Os 0000: AF0 0001: AF1 0010: AF2 0011: AF3 0100: AF4 0101: AF5 0110: AF6 0111: AF7 1000: AF8 1001: AF9 1010: AF10 1011: AF11 1100: AF12 1101: AF13 1110: AF14 1111: AF15

RM0490 Rev 5   193/1027  RM0490   General-purpose I/Os (GPIO)  194  8.5.11   GPIO port bit reset register (GPIOx_BRR) (x = A, B, C, D, F)  Address offset: 0x28 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 BR15   BR14   BR13   BR12   BR11   BR10   BR9   BR8   BR7   BR6   BR5   BR4   BR3   BR2   BR1   BR0 w   w   w   w   w   w   w   w   w   w   w   w   w   w   w   w Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   BRy:   Port x reset I/O y (y = 15 to 0) These bits are write-only. A read operation always returns 0x0000. 0: No action on the corresponding ODx bit 1: Reset the corresponding ODx bit

General-purpose I/Os (GPIO)   RM0490  194/1027   RM0490 Rev 5  8.5.12   GPIO register map  The following table gives the GPIO register map and reset values. Refer to   Section 2.2 on page 45   for the register boundary addresses.  Table 40. GPIO register map and reset values Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00  GPIOx_MODER  (x = A, B, C, D, F) MODE15[1:0] MODE14[1:0] MODE13[1:0] MODE12[1:0] MODE11[1:0] MODE10[1:0] MODE9[1:0] MODE8[1:0] MODE7[1:0] MODE6[1:0] MODE5[1:0] MODE4[1:0] MODE3[1:0] MODE2[1:0] MODE1[1:0] MODE0[1:0] Reset value (port A)   1   1   1   0   1   0   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 Reset value (ports other than A)   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 0x04  GPIOx_OTYPER  (x = A, B, C, D, F) Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. OT15 OT14 OT13 OT12 OT11 OT10 OT9 OT8 OT7 OT6 OT5 OT4 OT3 OT2 OT1 OT0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x08  GPIOx_OSPEEDR  (x = A, B, C, D, F) OSPEED15[1:0] OSPEED14[1:0] OSPEED13[1:0] OSPEED12[1:0] OSPEED11[1:0] OSPEED10[1:0] OSPEED9[1:0] OSPEED8[1:0] OSPEED7[1:0] OSPEED6[1:0] OSPEED5[1:0] OSPEED4[1:0] OSPEED3[1:0] OSPEED2[1:0] OSPEED1[1:0] OSPEED0[1:0] Reset value (port A)   0   0   0   0   1   1   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 Reset value (ports other than A)   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x0C  GPIOx_PUPDR  (x = A, B, C, D, F) PUPD15[1:0] PUPD14[1:0] PUPD13[1:0] PUPD12[1:0] PUPD11[1:0] PUPD10[1:0] PUPD9[1:0] PUPD8[1:0] PUPD7[1:0] PUPD6[1:0] PUPD5[1:0] PUPD4[1:0] PUPD3[1:0] PUPD2[1:0] PUPD1[1:0] PUPD0[1:0] Reset value (port A)   0   0   1   0   0   1   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 Reset value (ports other than A)   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x10  GPIOx_IDR  (x = A, B, C, D, F) Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. ID15 ID14 ID13 ID12 ID11 ID10 ID9 ID8 ID7 ID6 ID5 ID4 ID3 ID2 ID1 ID0 Reset value   x   x   x   x   x   x   x   x   x   x   x   x   x   x   x   x 0x14  GPIOx_ODR  (x = A, B, C, D, F) Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. OD15 OD14 OD13 OD12 OD11 OD10 OD9 OD8 OD7 OD6 OD5 OD4 OD3 OD2 OD1 OD0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x18  GPIOx_BSRR  (x = A, B, C, D, F) BR15 BR14 BR13 BR12 BR11 BR10 BR9 BR8 BR7 BR6 BR5 BR4 BR3 BR2 BR1 BR0 BS15 BS14 BS13 BS12 BS11 BS10 BS9 BS8 BS7 BS6 BS5 BS4 BS3 BS2 BS1 BS0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x1C  GPIOx_LCKR  (x = A, B, C, D, F) Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. LCKK LCK15 LCK14 LCK13 LCK12 LCK11 LCK10 LCK9 LCK8 LCK7 LCK6 LCK5 LCK4 LCK3 LCK2 LCK1 LCK0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x20  GPIOx_AFRL  (x = A, B, C, D, F) AFSEL7 [3:0] AFSEL6 [3:0] AFSEL5 [3:0] AFSEL4 [3:0] AFSEL3 [3:0] AFSEL2 [3:0] AFSEL1 [3:0] AFSEL0 [3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x24  GPIOx_AFRH  (x = A, B, C, D, F) AFSEL15 [3:0] AFSEL14 [3:0] AFSEL13 [3:0] AFSEL12 [3:0] AFSEL11 [3:0] AFSEL10 [3:0] AFSEL9 [3:0] AFSEL8 [3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x28  GPIOx_BRR  (x = A, B, C, D, F) Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. BR15 BR14 BR13 BR12 BR11 BR10 BR9 BR8 BR7 BR6 BR5 BR4 BR3 BR2 BR1 BR0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0

RM0490 Rev 5   195/1027  RM0490   System configuration controller (SYSCFG)  216  9   System configuration controller (SYSCFG)  The devices feature a set of configuration registers. The main purposes of the system configuration controller are the following:  •   Enabling/disabling I   2   C-bus Fast-mode Plus mode on some I/O ports  •   Configuring the IR modulation signal and its output polarity  •   Remapping of some I/O ports  •   Remapping the memory located at the beginning of the code area  •   Flag pending interrupts from each interrupt line  •   Managing robustness feature  9.1   SYSCFG registers 9.1.1   SYSCFG configuration register 1 (SYSCFG_CFGR1)  This register is used for specific configurations of memory remap and to control special I/O features.  Two bits are used to configure the type of memory accessible at address 0x0000 0000. These bits are used to select the physical remap by software and so, bypass the hardware BOOT selection. After reset these bits take the value selected by the actual boot mode configuration.  If the Fm+ mode is desired on the I2C pins, first assign GPIOs to I2Cx through the GPIOx_AFRH or GPIOx_AFRL alternate function registers and then only activate the Fm+ mode. The Fm+ mode on a GPIO   y   used as I2Cx can individually be activated by setting its corresponding I2C_ y _FMP bit. It can also collectively be activated for GPIOs used as I2C x , by setting the I2C x _FMP bit. If the Fm+ mode is not desired on a GPIO   y   used as I2C x , both I2C_ y _FMP and I2C x _FMP bits must be cleared. When the Fm+ mode is activated, the speed configuration of the I/O (GPIOx OSPEEDR) is ignored. Address offset: 0x00 Reset value: 0x0000 000X (X is the memory mode selected by the actual boot mode configuration) 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res. I2C_ PC14_ FMP I2C_ PA10_ FMP I2C_ PA9_ FMP I2C2_ FMP I2C1_ FMP I2C_ PB9_ FMP I2C_ PB8_ FMP I2C_ PB7_ FMP I2C_ PB6_ FMP rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   IR_MOD [1:0] IR_ POL PA12_ RMP PA11_ RMP   Res.   MEM_MODE [1:0] rw   rw   rw   rw   rw   rw   rw

System configuration controller (SYSCFG)   RM0490  196/1027   RM0490 Rev 5  Bits 31:25   Reserved, must be kept at reset value. Bit 24   I2C_PC14_FMP : Fast-mode Plus (Fm+) enable for PC14 This bit is set and cleared by software. It enables I2C Fm+ driving capability on PC14 I/O port. 0: Disable if not enabled through I2Cx_FMP 1: Enable  Note:   Not available on STM32C011xx.  Bit 23   I2C_PA10_FMP:   Fast-mode Plus (Fm+) enable for PA10 This bit is set and cleared by software. It enables I2C Fm+ driving capability on PA10 I/O port. 0: Disable disabled if not enabled through I2Cx_FMP 1: Enable Bit 22   I2C_PA9_FMP:   Fast-mode Plus (Fm+) enable for PA9 This bit is set and cleared by software. It enables I2C Fm+ driving capability on PA9 I/O port. 0: Disable disabled if not enabled through I2Cx_FMP 1: Enable Bit 21   I2C2_FMP : Fast-mode Plus (Fm+) enable for I2C2 This bit is set and cleared by software. It enables I2C Fm+ driving capability on I/O ports configured as I2C2 through GPIOx_AFR registers. 0: Disable disabled if not enabled through I2C_y_FMP 1: Enable  Note:   Only applicable to STM32C051xx, STM32C071xx, and STM32C091xx/92xx. Reserved on the other products.  Bit 20   I2C1_FMP : Fast-mode Plus (Fm+) enable for I2C1 This bit is set and cleared by software. It enables I2C Fm+ driving capability on I/O ports configured as I2C1 through GPIOx_AFR registers. 0: Disable disabled if not enabled through I2C_y_FMP 1: Enable Bit 19   I2C_PB9_FMP:   Fast-mode Plus (Fm+) enable for PB9 This bit is set and cleared by software. It enables I2C Fm+ driving capability on PB9 I/O port. 0: Disable disabled if not enabled through I2Cx_FMP 1: Enable  Note:   Not available on STM32C011xx.  Bit 18   I2C_PB8_FMP:   Fast-mode Plus (Fm+) enable for PB8 This bit is set and cleared by software. It enables I2C Fm+ driving capability on PB8 I/O port. 0: Disable disabled if not enabled through I2Cx_FMP 1: Enable  Note:   Not available on STM32C011xx.  Bit 17   I2C_PB7_FMP:   Fast-mode Plus (Fm+) enable for PB7 This bit is set and cleared by software. It enables I2C Fm+ driving capability on PB7 I/O port. 0: Disable disabled if not enabled through I2Cx_FMP 1: Enable Bit 16   I2C_PB6_FMP:   Fast-mode Plus (Fm+) enable for PB6 This bit is set and cleared by software. It enables I2C Fm+ driving capability on PB6 I/O port. 0: Disable disabled if not enabled through I2Cx_FMP 1: Enable Bits 15:8   Reserved, must be kept at reset value.

RM0490 Rev 5   197/1027  RM0490   System configuration controller (SYSCFG)  216  9.1.2   SYSCFG configuration register 2 (SYSCFG_CFGR2)  Address offset: 0x18 Reset value: 0x0000 0000 Bits 7:6   IR_MOD[1:0]:   IR Modulation Envelope signal selection This bitfield selects the signal for IR modulation envelope: 00: TIM16 01: USART1 10: USART2 11: Reserved Bit 5   IR_POL:   IR output polarity selection 0: Output of IRTIM (IR_OUT) is not inverted 1: Output of IRTIM (IR_OUT) is inverted Bit 4   PA12_RMP : PA12 pin remapping This bit is set and cleared by software. When set, it remaps the PA12 pin to operate as PA10 GPIO port, instead as PA12 GPIO port. In this case, the original PA10 pin (if available) is forced to analog mode. 0: No remap (PA12) 1: Remap (PA10)  Note:   If the PINMUX4[1:0] bitfield of the SYSCFG_CFGR3 register is at 00, PA12_RMP must be kept at 0 to prevent conflict due to two GPIO outputs with different output levels connected to the same pin.  Bit 3   PA11_RMP : PA11 pin remapping This bit is set and cleared by software. When set, it remaps the PA11 pin to operate as PA9 GPIO port, instead as PA11 GPIO port. In this case, the original PA9 pin (if available) is forced to analog mode. 0: No remap (PA11) 1: Remap (PA9)  Note:   If the PINMUX2[1:0] bitfield of the SYSCFG_CFGR3 register is at 00, PA11_RMP must be kept at 0 to prevent conflict due to two GPIO outputs with different output levels connected to the same pin.  Bit 2   Reserved, must be kept at reset value. Bits 1:0   MEM_MODE[1:0]:   Memory mapping selection bits This bitfield controlled by software selects the memory internally mapped at the address 0x0000 0000. Its reset value is determined by the boot mode configuration. Refer to  Section 3: Boot modes   for more details. x0: Main flash memory  01: System flash memory  11: Embedded SRAM 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. LOCKU P_LOC K rw

System configuration controller (SYSCFG)   RM0490  198/1027   RM0490 Rev 5  9.1.3   SYSCFG configuration register 3 (SYSCFG_CFGR3)  In some products/packages with low pin count, several GPIOs may be internally connected to the same pin. This register allows selecting the active GPIO that keeps the setting specified by its corresponding GPIOx_MODER register. For STM32C011xx, STM32C031xx, and STM32C071xx, the other GPIOs connected to the same pin are forced into digital input (passive) mode regardless of their corresponding GPIOx_MODER register settings. For STM32C051xx and STM32C091xx/92xx, the output buffer of the other GPIOs connected to the same pin are disabled regardless of their corresponding GPIOx_MODER register settings.  This is only effective when the SECURE_MUXING_EN bit of the   FLASH option register (FLASH_OPTR)   is set (default).  When SECURE_MUXING_EN is cleared, SYSCFG_CFGR3 has no effect. All GPIOs connected to the same pin keep the configuration set in their corresponding GPIOx_MODER register. The user software must then ensure that there is no conflict between the GPIOs. In the following bitfield descriptions, for products/packages not listed in the “condition” preceding the bitfield values, consider the bitfield as reserved and keep it at its reset value. Address offset: 0x3C Reset value: 0x0000 0000 Bits 31:1   Reserved, must be kept at reset value. Bit 0   LOCKUP_LOCK : Cortex ®   -M0+ LOCKUP enable This bit is set by software and cleared by system reset. When set, it enables the connection of Cortex ® -M0+ LOCKUP (HardFault) output to the TIM1/16/17 Break input. 0: Disable 1: Enable 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 PINMUX7[1:0]   PINMUX6[1:0]   PINMUX5[1:0]   PINMUX4[1:0]   PINMUX3[1:0]   PINMUX2[1:0]   PINMUX1[1:0]   PINMUX0[1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bits 31:16   Reserved, must be kept at reset value. Bits 15:14   PINMUX7[1:0] : Pin GPIO multiplexer 7 This bitfield is set and cleared by software. It selects an active GPIO on a pin. Condition: STM32C051x - GPIO assigned to WLCSP15 ball A2 or TSSOP20 pin 1 00: PB7 01: PB8 Other: Reserved

RM0490 Rev 5   199/1027  RM0490   System configuration controller (SYSCFG)  216  Bits 13:12   PINMUX6[1:0] : Pin GPIO multiplexer 6 This bitfield is set and cleared by software. It selects an active GPIO on a pin. Condition: STM32C051x - GPIO assigned to WLCSP15 ball B1 or TSSOP20 pin 20 00: PB6 01: PB3 10: PB4 11: PB5 Bits 11:10   PINMUX5[1:0] : Pin GPIO multiplexer 5 This bitfield is set and cleared by software. It selects an active GPIO on a pin. Condition: STM32C011x - GPIO assigned to WLCSP12 ball F1 00: PA3 01: PA4 10: PA5 11: PA6 Condition: STM32C051xx - GPIO assigned to WLCSP15 ball E2 or TSSOP20 pin 19 00: PA14-BOOT0 01: PA15 Other: Reserved Bits 9:8   PINMUX4[1:0] : Pin GPIO multiplexer 4 This bitfield is set and cleared by software. It selects an active GPIO on a pin. Condition: STM32C011x - GPIO assigned to WLCSP12 ball E2 00: PA7 01: PA12 Other: Reserved Condition: STM32C051xx - GPIO assigned to WLCSP15 ball H1 00: PA7 01: PA12 [PA10] Other: Reserved Condition: STM32C091/92xx - GPIO assigned to TSSOP20 pin 1 or WLCSP24 ball B4 00: PB7 01: PB8 Other: Reserved  Note:   The PA12_RMP bit of the SYSCFG_CFGR1 takes priority over the selection through this bitfield. Refer to the description of the SYSCFG_CFGR1 register for more details.

System configuration controller (SYSCFG)   RM0490  200/1027   RM0490 Rev 5  Bits 7:6   PINMUX3[1:0] : Pin GPIO multiplexer 3 This bitfield is set and cleared by software. It selects an active GPIO on a pin. Condition: STM32C011x - GPIO assigned to SO8 pin 8 00: PA14 01: PB6 10: PC15 11: Reserved Condition: STM32C051xx - GPIO assigned to WLCSP15 ball J2 00: PA5 01: PA6 Other: Reserved Condition: STM32C071xx - GPIO assigned to WLCSP19 ball B3 or TSSOP20 pin 1 00: PB7 01: PB8 Other: Reserved Condition: STM32C091/92xx - GPIO assigned WLCSP24 ball A3 00: PB5 01: PB3 Other: Reserved Bits 5:4   PINMUX2[1:0] : Pin GPIO multiplexer 2 This bitfield is set and cleared by software. It selects an active GPIO on a pin. Condition: STM32C011x - GPIO assigned to SO8 pin 5 00: PA8 01: PA11 Other: Reserved Condition: STM32C051xx - GPIO assigned to WLCSP15 ball K3 00: PA3 01: PA4 Other: Reserved Condition: STM32C071xx - GPIO assigned to TSSOP20 pin 20 00: PB6 01: PB3 10: PB4 11: PB5 Condition: STM32C091/92xx - GPIO assigned to TSSOP20 pin 20 00: PB6 01: PB3 10: PB4 11: PB5 Condition: STM32C091/92xx - GPIO assigned to WLCSP24 ball A5 00: PB6 01: PB4 Other: Reserved  Note:   The PA11_RMP bit of the SYSCFG_CFGR1 takes priority over the selection through this bitfield. Refer to the description of the SYSCFG_CFGR1 register for more details.

RM0490 Rev 5   201/1027  RM0490   System configuration controller (SYSCFG)  216  9.1.4   SYSCFG interrupt line 0 status register (SYSCFG_ITLINE0)  A dedicated set of registers is implemented on the device to collect all pending interrupt sources associated with each interrupt line into a single register. This allows users to check by single read which peripheral requires service in case more than one source is associated to the interrupt line.  All bits in those registers are read only, set by hardware when there is corresponding Bits 3:2   PINMUX1[1:0] : Pin GPIO multiplexer 1 This bitfield is set and cleared by software. It selects an active GPIO on a pin. Condition: STM32C011x - GPIO assigned to SO8 pin 4 00: PF2-NRST 01: PA0 10: PA1 11: PA2 Condition: STM32C051xx - GPIO assigned to WLCSP15 ball G2 00: PA1 01: PA2 Other: Reserved Condition: STM32C071xx - GPIO assigned to WLCSP19 ball B1 or TSSOP20 pin 19 00: PA14 01: PA15 Other: Reserved Condition: STM32C091/92xx - GPIO assigned to TSSOP20 pin 15 00: PA8 01: PB0 10: PB1 11: PB2 Condition: STM32C091/92xx - GPIO assigned to WLCSP24 pin G1 00: PA8 01: PB2 Other: Reserved Bits 1:0   PINMUX0[1:0] : Pin GPIO multiplexer 0 This bitfield is set and cleared by software. It selects an active GPIO on a pin. Condition: STM32C011x - GPIO assigned to SO8 pin 1 00: PB7 01: PC14 Other: Reserved Condition: STM32C051xx - GPIO assigned to WLCSP15 ball H3 00: PF2-NRST 01: PA0 Other: Reserved Condition: STM32C071xx - GPIO assigned to WLCSP19 ball H3 00: PF2-NRST 01: PA0 Other: Reserved Condition: STM32C091/92xx - GPIO assigned to TSSOP20 pin 19 00: PA14 01: PA15 Other: Reserved

System configuration controller (SYSCFG)   RM0490  202/1027   RM0490 Rev 5  interrupt request pending and cleared by resetting the interrupt source flags in the peripheral registers. Address offset: 0x80 Reset value: 0x0000 0000  9.1.5   SYSCFG interrupt line 1 status register (SYSCFG_ITLINE1)  This register is only available on STM32C071xx. On the other devices, it is reserved. Address offset: 0x84 Reset value: 0x0000 0000  9.1.6   SYSCFG interrupt line 2 status register (SYSCFG_ITLINE2)  Address offset: 0x88 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   WWDG r  Bits 31:1   Reserved, must be kept at reset value. Bit 0   WWDG : Window watchdog interrupt pending flag 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. PVM_ VDDIO2 _OUT Res. r  Bits 31:2   Reserved, must be kept at reset value. Bit 1   PVM_VDDIO2_OUT : V DDIO2   supply monitoring interrupt request pending (EXTI line 34) Bit 0   Reserved, must be kept at reset value. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   RTC   Res. r

RM0490 Rev 5   203/1027  RM0490   System configuration controller (SYSCFG)  216  9.1.7   SYSCFG interrupt line 3 status register (SYSCFG_ITLINE3)  Address offset: 0x8C Reset value: 0x0000 0000  9.1.8   SYSCFG interrupt line 4 status register (SYSCFG_ITLINE4)  Address offset: 0x90 Reset value: 0x0000 0000 Bits 31:2   Reserved, must be kept at reset value. Bit 1   RTC:   RTC interrupt request pending (EXTI line 19) Bit 0   Reserved, must be kept at reset value. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. FLASH _ ITF Res. r  Bits 31:2   Reserved, must be kept at reset value. Bit 1   FLASH_ITF : Flash interface interrupt request pending Bit 0   Reserved, must be kept at reset value. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CRS   RCC r   r  Bits 31:2   Reserved, must be kept at reset value. Bit 1   CRS : CRS interrupt request pending  Note:   Only applicable on STM32C071xx, reserved on other products.  Bit 0   RCC : Reset and clock control interrupt request pending

System configuration controller (SYSCFG)   RM0490  204/1027   RM0490 Rev 5  9.1.9   SYSCFG interrupt line 5 status register (SYSCFG_ITLINE5)  Address offset: 0x94 Reset value: 0x0000 0000  9.1.10   SYSCFG interrupt line 6 status register (SYSCFG_ITLINE6)  Address offset: 0x98 Reset value: 0x0000 0000  9.1.11   SYSCFG interrupt line 7 status register (SYSCFG_ITLINE7)  Address offset: 0x9C Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   EXTI1   EXTI0 r   r  Bits 31:2   Reserved, must be kept at reset value. Bit 1   EXTI1 : EXTI line 1 interrupt request pending Bit 0   EXTI0 : EXTI line 0 interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   EXTI3   EXTI2 r   r  Bits 31:2   Reserved, must be kept at reset value. Bit 1   EXTI3 : EXTI line 3 interrupt request pending Bit 0   EXTI2 : EXTI line 2 interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   EXTI15   EXTI14   EXTI13   EXTI12   EXTI11   EXTI10   EXTI9   EXTI8   EXTI7   EXTI6   EXTI5   EXTI4 r   r   r   r   r   r   r   r   r   r   r   r

RM0490 Rev 5   205/1027  RM0490   System configuration controller (SYSCFG)  216  9.1.12   SYSCFG interrupt line 8 status register (SYSCFG_ITLINE8)  This register is only available on STM32C071xx. On the other devices, it is reserved. Address offset: 0xA0 Reset value: 0x0000 0000  9.1.13   SYSCFG interrupt line 9 status register (SYSCFG_ITLINE9)  Address offset: 0xA4 Reset value: 0x0000 0000 Bits 31:12   Reserved, must be kept at reset value. Bit 11   EXTI15 : EXTI line 15 interrupt request pending Bit 10   EXTI14 : EXTI line 14 interrupt request pending Bit 9   EXTI13 : EXTI line 13 interrupt request pending Bit 8   EXTI12 : EXTI line 12 interrupt request pending Bit 7   EXTI11 : EXTI line 11 interrupt request pending Bit 6   EXTI10 : EXTI line 10 interrupt request pending Bit 5   EXTI9 : EXTI line 9 interrupt request pending Bit 4   EXTI8 : EXTI line 8 interrupt request pending Bit 3   EXTI7 : EXTI line 7 interrupt request pending Bit 2   EXTI6 : EXTI line 6 interrupt request pending Bit 1   EXTI5 : EXTI line 5 interrupt request pending Bit 0   EXTI4 : EXTI line 4 interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   USB r  Bits 31:1   Reserved, must be kept at reset value. Bit 0   USB : USB interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   DMA1 _CH1 r

System configuration controller (SYSCFG)   RM0490  206/1027   RM0490 Rev 5  9.1.14   SYSCFG interrupt line 10 status register (SYSCFG_ITLINE10)  Address offset: 0xA8 Reset value: 0x0000 0000  9.1.15   SYSCFG interrupt line 11 status register (SYSCFG_ITLINE11)  Address offset: 0xAC Reset value: 0x0000 0000 Bits 31:1   Reserved, must be kept at reset value. Bit 0   DMA1_CH1 : DMA1 channel 1interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   DMA1 _CH3 DMA1 _CH2 r   r  Bits 31:2   Reserved, must be kept at reset value. Bit 1   DMA1_CH3 : DMA1 channel 3 interrupt request pending Bit 0   DMA1_CH2 : DMA1 channel 2 interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   DMA_ CH7 DMA_ CH6 DMA_ CH5 DMA_ CH4 DMAM UX r   r   r   r   r  Bits 31:5   Reserved, must be kept at reset value. Bit 4   DMA_CH7 : DMA channel 7 interrupt request pending  Note:   Only applicable to STM32C091xx/92xx, reserved on the other products.  Bit 3   DMA_CH6 : DMA channel 6 interrupt request pending  Note:   Only applicable to STM32C091xx/92xx, reserved on the other products.  Bit 2   DMA_CH5 : DMA channel 5 interrupt request pending  Note:   Only applicable to STM32C051xx, STM32C071xx, and STM32C091xx/92xx, reserved on the other products.  Bit 1   DMA_CH4 : DMA channel 4 interrupt request pending  Note:   Only applicable to STM32C051xx, STM32C071xx, and STM32C091xx/92xx, reserved on the other products.  Bit 0   DMAMUX : DMAMUX interrupt request pending

RM0490 Rev 5   207/1027  RM0490   System configuration controller (SYSCFG)  216  9.1.16   SYSCFG interrupt line 12 status register (SYSCFG_ITLINE12)  Address offset: 0xB0 Reset value: 0x0000 0000  9.1.17   SYSCFG interrupt line 13 status register (SYSCFG_ITLINE13)  Address offset: 0xB4 Reset value: 0x0000 0000  9.1.18   SYSCFG interrupt line 14 status register (SYSCFG_ITLINE14)  Address offset: 0xB8 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   ADC r  Bits 31:1   Reserved, must be kept at reset value. Bit 0   ADC : ADC interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TIM1_B RK TIM1_ UPD TIM1_ TRG TIM1_ CCU r   r   r   r  Bits 31:4   Reserved, must be kept at reset value. Bit 3   TIM1_BRK : Timer 1 break interrupt request pending Bit 2   TIM1_UPD : Timer 1 update interrupt request pending Bit 1   TIM1_TRG : Timer 1 trigger interrupt request pending Bit 0   TIM1_CCU : Timer 1 commutation interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TIM1_ CC r

System configuration controller (SYSCFG)   RM0490  208/1027   RM0490 Rev 5  9.1.19   SYSCFG interrupt line 15 status register (SYSCFG_ITLINE15)  This register is only available on STM32C051xx, STM32C071xx, and STM32C091xx/92xx. On the other devices, it is reserved. Address offset: 0xBC Reset value: 0x0000 0000  9.1.20   SYSCFG interrupt line 16 status register (SYSCFG_ITLINE16)  Address offset: 0xC0 Reset value: 0x0000 0000  9.1.21   SYSCFG interrupt line 19 status register (SYSCFG_ITLINE19)  Address offset: 0xCC Reset value: 0x0000 0000 Bits 31:1   Reserved, must be kept at reset value. Bit 0   TIM1_CC : Timer 1 capture compare interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TIM2 r  Bits 31:1   Reserved, must be kept at reset value. Bit 0   TIM2 : TIM2 interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TIM3 r  Bits 31:1   Reserved, must be kept at reset value. Bit 0   TIM3 : Timer 3 interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TIM14 r

RM0490 Rev 5   209/1027  RM0490   System configuration controller (SYSCFG)  216  9.1.22   SYSCFG interrupt line 20 status register (SYSCFG_ITLINE20)  This register is only available on STM32C091xx/92xx. On the other devices, it is reserved. Address offset: 0xD0 Reset value: 0x0000 0000  9.1.23   SYSCFG interrupt line 21 status register (SYSCFG_ITLINE21)  Address offset: 0xD4 Reset value: 0x0000 0000  9.1.24   SYSCFG interrupt line 22 status register (SYSCFG_ITLINE22)  Address offset: 0xD8 Reset value: 0x0000 0000 Bits 31:1   Reserved, must be kept at reset value. Bit 0   TIM14 : Timer 14 interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TIM15 r  Bits 31:1   Reserved, must be kept at reset value. Bit 0   TIM15 : Timer 15 interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TIM16 r  Bits 31:1   Reserved, must be kept at reset value. Bit 0   TIM16 : Timer 16 interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TIM17 r

System configuration controller (SYSCFG)   RM0490  210/1027   RM0490 Rev 5  9.1.25   SYSCFG interrupt line 23 status register (SYSCFG_ITLINE23)  Address offset: 0xDC Reset value: 0x0000 0000  9.1.26   SYSCFG interrupt line 24 status register (SYSCFG_ITLINE24)  This register is only available on STM32C051xx, STM32C071xx, and STM32C091xx/92xx. On the other devices, it is reserved. Address offset: 0xE0 Reset value: 0x0000 0000  9.1.27   SYSCFG interrupt line 25 status register (SYSCFG_ITLINE25)  Address offset: 0xE4 Reset value: 0x0000 0000 Bits 31:1   Reserved, must be kept at reset value. Bit 0   TIM17 : Timer 17 interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   I2C1 r  Bits 31:1   Reserved, must be kept at reset value. Bit 0   I2C1 : I2C1 interrupt request pending, combined with EXTI line 23 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   I2C2 r  Bits 31:1   Reserved, must be kept at reset value. Bit 0   I2C2 : I2C2 interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   SPI1 r

RM0490 Rev 5   211/1027  RM0490   System configuration controller (SYSCFG)  216  9.1.28   SYSCFG interrupt line 26 status register (SYSCFG_ITLINE26)  This register is only available on STM32C051xx, STM32C071xx, and STM32C091xx/92xx. On the other devices, it is reserved. Address offset: 0xE8 Reset value: 0x0000 0000  9.1.29   SYSCFG interrupt line 27 status register (SYSCFG_ITLINE27)  Address offset: 0xEC Reset value: 0x0000 0000  9.1.30   SYSCFG interrupt line 28 status register (SYSCFG_ITLINE28)  Address offset: 0xF0 Reset value: 0x0000 0000 Bits 31:1   Reserved, must be kept at reset value. Bit 0   SPI1 : SPI1 interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   SPI2 r  Bits 31:1   Reserved, must be kept at reset value. Bit 0   SPI2 : SPI2 interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   USART 1 r  Bits 31:1   Reserved, must be kept at reset value. Bit 0   USART1 : USART1 interrupt request pending, combined with EXTI line 25

System configuration controller (SYSCFG)   RM0490  212/1027   RM0490 Rev 5  9.1.31   SYSCFG interrupt line 29 status register (SYSCFG_ITLINE29)  This register is only available on STM32C091xx/92xx. On the other devices, it is reserved. Address offset: 0xF4 Reset value: 0x0000 0000  9.1.32   SYSCFG interrupt line 30 status register (SYSCFG_ITLINE30)  This register is only available on STM32C092xx. On the other devices, it is reserved. Address offset: 0xF8 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   USART 2 r  Bits 31:1   Reserved, must be kept at reset value. Bit 0   USART2 : USART2 interrupt request pending (EXTI line 26) 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   USART4   USART3 r   r  Bits 31:2   Reserved, must be kept at reset value. Bit 1   USART4 : USART4 interrupt request pending Bit 0   USART3 : USART3 interrupt request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   FDCAN_ IT0 r  Bits 31:1   Reserved, must be kept at reset value. Bit 0   FDCAN_IT0 : FDCAN interrupt request 0 pending

RM0490 Rev 5   213/1027  RM0490   System configuration controller (SYSCFG)  216  9.1.33   SYSCFG interrupt line 31 status register (SYSCFG_ITLINE31)  This register is only available on STM32C092xx. On the other devices, it is reserved. Address offset: 0xFC Reset value: 0x0000 0000  9.1.34   SYSCFG register map  The following table gives the SYSCFG register map and the reset values. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   FDCAN_ IT1 r  Bits 31:1   Reserved, must be kept at reset value. Bit 0   FDCAN_IT1 : FDCAN interrupt request 1 pending  Table 41. SYSCFG register map and reset values Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00   SYSCFG_CFGR1  Res. Res. Res. Res. Res. Res. Res. I2C_PC14_FMP I2C_PA10_FMP I2C_PA9_FMP I2C2_FMP I2C1_FMP I2C_PB9_FMP I2C_PB8_FMP I2C_PB7_FMP I2C_PB6_FMP Res. Res. Res. Res. Res. Res. Res. Res. IR_MOD IR_POL PA12_RMP PA11_RMP Res. MEM_MODE[1:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   X   X 0x04 to 0x17   Reserved   Reserved 0x18   SYSCFG_CFGR2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. LOCUP_LOCK Reset value   0 0x1C to 0x3B   Reserved   Reserved 0x3C   SYSCFG_CFGR3  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PINMUX7 PINMUX6 PINMUX5 PINMUX4 PINMUX3 PINMUX2 PINMUX1 PINMUX0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x40 to 0x7F   Reserved   Reserved 0x80   SYSCFG_ITLINE0  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. WWDG Reset value

System configuration controller (SYSCFG)   RM0490  214/1027   RM0490 Rev 5  0x84   SYSCFG_ITLINE1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PVM_VDDIO2_OUT Res. Reset value   0 0x88   SYSCFG_ITLINE2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. RTC Res. Reset value   0 0x8C   SYSCFG_ITLINE3  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. FLASH_ITF Res. Reset value   0 0x90   SYSCFG_ITLINE4  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CRS RCC Reset value   0   0 0x94   SYSCFG_ITLINE5  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. EXTI1 EXTI0 Reset value   0   0 0x98   SYSCFG_ITLINE6  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. EXTI3 EXTI2 Reset value   0   0 0x9C   SYSCFG_ITLINE7  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. EXTI15 EXTI14 EXTI13 EXTI12 EXTI11 EXTI10 EXTI9 EXTI8 EXTI7 EXTI6 EXTI5 EXTI4 Reset value   0   0   0   0   0   0   0   0   0   0   0   0 0xA0   SYSCFG_ITLINE8  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. USB Reset value   0 0xA4   SYSCFG_ITLINE9  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DMA1_CH1 Reset value   0 0xA8   SYSCFG_ITLINE10  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DMA1_CH3 DMA1_CH2 Reset value   0   0 0xAC   SYSCFG_ITLINE11  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DMA1_CH7 DMA1_CH6 DMA1_CH5 DMA1_CH4 DMAMUX Reset value   0   0   0   0   0 0xB0   SYSCFG_ITLINE12  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. ADC Reset value   0 0xB4   SYSCFG_ITLINE13  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TIM1_BRK TIM1_UPD TIM1_TRG TIM1_CCU Reset value   0   0   0   0  Table 41. SYSCFG register map and reset values (continued) Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

RM0490 Rev 5   215/1027  RM0490   System configuration controller (SYSCFG)  216  0xB8   SYSCFG_ITLINE14  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TIM1_CC Reset value   0 0xBC   SYSCFG_ITLINE15  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TIM2 Reset value   0 0xC0   SYSCFG_ITLINE16  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TIM3 Reset value   0 0xC4- 0xC8   Reserved   Reserved 0xCC   SYSCFG_ITLINE19  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TIM14 Reset value   0 0xD0   SYSCFG_ITLINE20  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TIM15 Reset value   0 0xD4   SYSCFG_ITLINE21  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TIM16 Reset value   0 0xD8   SYSCFG_ITLINE22  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TIM17 Reset value   0 0xDC   SYSCFG_ITLINE23  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. I2C1 Reset value   0 0xE0   SYSCFG_ITLINE24  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. I2C2 Reset value   0 0xE4   SYSCFG_ITLINE25  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. SPI1 Reset value   0 0xE8   SYSCFG_ITLINE26  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. SPI2 Reset value   0 0xEC   SYSCFG_ITLINE27  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. USART1 Reset value   0 0xF0   SYSCFG_ITLINE28  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. USART2 Reset value   0 0xF4   SYSCFG_ITLINE29  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. USART4 USART3 Reset value   0   0 0xF8   SYSCFG_ITLINE30  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. FDCAN_IT0 Reset value   0  Table 41. SYSCFG register map and reset values (continued) Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

System configuration controller (SYSCFG)   RM0490  216/1027   RM0490 Rev 5  Refer to   Section 2.2 on page 45   for the register boundary addresses. 0xFC   SYSCFG_ITLINE31  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. FDCAN_IT1 Reset value   0  Table 41. SYSCFG register map and reset values (continued) Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

RM0490 Rev 5   217/1027  RM0490   Interconnect matrix  221  10   Interconnect matrix 10.1   Introduction  Several peripherals have direct connections between them. This allows autonomous communication and/or synchronization between peripherals, saving CPU resources thus power consumption. In addition, these hardware connections remove software latency and allow design of predictable systems. Depending on peripherals, these interconnections can operate in Run, Sleep, and Stop mode. For availability of peripherals on different STM32C0 series products, refer to   Section 1.5: Availability of peripherals .  10.2   Connection summary  The numbers in the following table are links to corresponding sub-sections in   Section 10.3: Interconnection details .The “-” symbol in grayed cells means “no interconnection”.  Table 42. Interconnect matrix Destination   ►  Source   ▼  TIM1 TIM2 TIM3 TIM14 TIM15 TIM16 TIM17 ADC1 DMAMUX IRTIM  TIM1   -   10.3.1   10.3.1   -   -   -   -   10.3.2   -   - TIM2   10.3.1   -   10.3.1   -   10.3.1   -   -   10.3.2   -   - TIM3   10.3.1   10.3.1   -   -   10.3.1   -   -   10.3.2   -   - TIM14   -   10.3.1   -   -   -   -   -   10.3.8   - TIM15   10.3.1   10.3.1   10.3.1   -   -   -   -   10.3.2   10.3.8   - TIM16   -   -   -   -   10.3.1   -   -   -   -   10.3.7  TIM17   10.3.1   -   -   -   10.3.1   -   -   -   -   10.3.7  USART1   -   -   -   -   -   -   -   -   -   10.3.7  USART2   -   -   -   -   -   -   -   -   -   10.3.7  ADC   10.3.3   -   -   -   -   -   -   -   -   - Temp. sensor   -   -   -   -   -   -   -   10.3.5   -   - VREFINT   -   -   -   -   -   -   -   10.3.5   -   - HSE   -   -   -   10.3.4   -   -   10.3.4   -   -   - LSE   -   -   -   -   -   10.3.4   -   -   -   - LSI   -   -   -   -   -   10.3.4   -   -   -   - MCO   -   -   -   10.3.4   -   -   10.3.4   -   -   -

Interconnect matrix   RM0490  218/1027   RM0490 Rev 5  10.3   Interconnection details 10.3.1   From TIM1, TIM2, TIM3, TIM14, TIM15, and TIM17, to TIM1, TIM2,  and TIM3 Purpose  Some of the TIMx timers are linked together internally for timer synchronization or chaining. When one timer is configured in master mode, it can reset, start, stop or clock the counter of another timer configured in slave mode. A description of the feature is provided in:   Section 18.3.19: Timer synchronization . The modes of synchronization are detailed in:  •   Section 17.3.26: Timer synchronization   for advanced-control timer TIM1  •   Section 18.3.18: Timers and external trigger synchronization   for general-purpose timers TIM2/TIM3  •   Section 20.4.20: External trigger synchronization (TIM15 only)   for general-purpose timer TIM15  Triggering signals  The output (from master) is on signal TIMx_TRGO (and TIMx_TRGOx), following a configurable timer event. With TIM14, TIM16 and TIM17 timers that do not have a trigger output, the output compare 1 is used instead. The input (to slave) is on signals TIMx_ITR0/ITR1/ITR2/ITR3. The input and output signals for TIM1 are shown in   Figure 57: Advanced-control timer block diagram . The possible master/slave connections are given in   Table 80: TIM1 internal trigger connection .  Relevant power modes  These interconnections operate in Run and Sleep modes. MCO2   -   -   -   10.3.4   -   10.3.4   10.3.4   -   -   - EXTI   -   -   -   -   -   -   -   10.3.2   10.3.2   - RTC   -   -   -   10.3.4   -   -   -   -   -   - SYST ERR   10.3.6   -   -   -   10.3.6   10.3.6   10.3.6   -   -   -  Table 42. Interconnect matrix (continued) Destination   ►  Source   ▼  TIM1 TIM2 TIM3 TIM14 TIM15 TIM16 TIM17 ADC1 DMAMUX IRTIM

RM0490 Rev 5   219/1027  RM0490   Interconnect matrix  221  10.3.2   From TIM1, TIM2, TIM3, TIM15, and EXTI, to ADC Purpose  The general-purpose timer TIM3, TIM15, advanced-control timer TIM1, and EXTI can be used to generate an ADC triggering event. TIMx synchronization is described in:   Section 17.3.27: ADC synchronization . ADC synchronization is described in:   Section 16.5: Conversion on external trigger and trigger polarity (EXTSEL, EXTEN) .  Triggering signals  The output (from timer) is on signal TIMx_TRGO, TIMx_TRGO2 or TIMx_CCx event. The input (to ADC) is on signal TRG[7:0]. The connection between timers and ADC is provided in   Table 68: External triggers .  Relevant power modes  These interconnections operate in Run and Sleep modes.  10.3.3   From ADC to TIM1 Purpose  ADC can provide trigger event through watchdog signals to the advanced-control timer TIM1. A description of the ADC analog watchdog setting is provided in:   Section 16.8: Analog window watchdogs . Trigger settings on the timer are provided in:   Section 17.3.4: External trigger input .  Triggering signals  The output (from ADC) is on signals ADC_AWDx_OUT x = 1, 2, 3 (three watchdogs per ADC) and the input (to timer) on signal TIMx_ETR (external trigger).  Relevant power modes  This interconnection operates in Run and Sleep modes.  10.3.4   From HSE, LSE, LSI, MCO, MCO2, and RTC, to TIM14,  TIM16, and TIM17 Purpose  External clocks (HSE, LSE), internal clock (LSI), microcontroller output clock (MCO and MCO2), RTC clock, and GPIO can be selected as inputs to capture channel 1 of some of TIM14/16/TIM17 timers. The timers allow calibrating or precisely measuring internal clocks such as HSI48 or LSI, using accurate clocks such as LSE or HSE/32 for timing reference. See details in  Section 6.2.14: Internal/external clock measurement with TIM14/TIM16/TIM17 .

Interconnect matrix   RM0490  220/1027   RM0490 Rev 5  When low-speed external (LSE) oscillator is used, no additional hardware connections are required.  Relevant power modes  These interconnections operate in Run and Sleep modes.  10.3.5   From internal analog sources to ADC Purpose  The internal temperature sensor output voltage V   TS   and the internal reference voltage V   REFINT   channel are connected to ADC input channels. More information is in:  •   Section 16.2: ADC main features  •   Section 16.4.8: Channel selection (CHSEL, SCANDIR, CHSELRMOD)  •   Figure 16.10: Temperature sensor and internal reference voltage  Relevant power modes  These interconnections operate in Run and Sleep modes.  10.3.6   From system errors to TIM1, TIM15, TIM16, and TIM17 Purpose  CSS, CPU HardFault, and RAM parity error can generate system errors in the form of timer break toward TIM1, TIM16, and TIM17. The purpose of the break function is to protect power switches driven by PWM signals from the timers. The relevant information is in:  •   Section 17.3.16: Using the break function   (TIM1)  •   Section 20.4.13: Using the break function   (TIM15/TIM16/TIM17)  •   Figure 182: TIM15 block diagram  •   Figure 183: TIM16/TIM17 block diagram  Relevant power modes  These interconnections operate in Run and Sleep modes.  10.3.7   From TIM16, TIM17, USART1, and USART2, to IRTIM Purpose  TIMx_OC1 output channel of TIM17 timer, associated with USART1 or USART2 transmission signal, can generate the infrared output waveform. The functionality is described in   Section 21: Infrared interface (IRTIM) .  Relevant power modes  These interconnections operate in Run and Sleep modes.

RM0490 Rev 5   221/1027  RM0490   Interconnect matrix  221  10.3.8   From TIM14 and EXTI to DMAMUX Purpose  TIM14 general-purpose timer and EXTI can be used as triggering event to DMAMUX.  Relevant power modes  These interconnections operate in Run and Sleep modes.

Direct memory access controller (DMA)   RM0490  222/1027   RM0490 Rev 5  11   Direct memory access controller (DMA) 11.1   Introduction  The direct memory access (DMA) controller is a bus master and system peripheral. The DMA is used to perform programmable data transfers between memory-mapped peripherals and/or memories, upon the control of an off-loaded CPU. The DMA controller features a single AHB master architecture. Refer to   Section 11.3   for information on DMA implementation. Each channel is dedicated to managing memory access requests from one or more peripherals. DMA includes an arbiter for handling the priority between DMA requests.  11.2   DMA main features  •   Single AHB master  •   Peripheral-to-memory, memory-to-peripheral, memory-to-memory, and peripheral-to- peripheral data transfers  •   Access, as source and destination, to on-chip memory-mapped devices such as flash memory, SRAM, and AHB and APB peripherals  •   All DMA channels are independently configurable: –   Each channel is associated either with a DMA request signal coming from a peripheral, or with a software trigger in memory-to-memory transfers. This configuration is done by software. –   Priority between the requests is programmable by software (four levels per channel: very high, high, medium, low) and by hardware in case of equality (such as request to channel 1 has priority over request to channel 2). –   Transfer size of source and destination are independent (byte, half-word, word), emulating packing and unpacking. Source and destination addresses must be aligned on the data size. –   Support of transfers from/to peripherals to/from memory with circular buffer management –   Programmable number of data to be transferred: 0 to 2   16   - 1  •   Generation of an interrupt request per channel. Each interrupt request is caused from any of the three DMA events: transfer complete, half transfer, or transfer error.

RM0490 Rev 5   223/1027  RM0490   Direct memory access controller (DMA)  241  11.3   DMA implementation 11.3.1   DMA1  DMA1 is implemented with the hardware configuration parameters shown in the table below.  11.3.2   DMA request mapping 11.4   DMA functional description 11.4.1   DMA block diagram  The DMA block diagram is shown in the figure below.  Figure 21. DMA block diagram  The DMA controller performs direct memory transfer by sharing the AHB system bus with other system masters. The bus matrix implements round-robin scheduling. DMA requests may stop the CPU access to the system bus for a number of bus cycles, when CPU and DMA target the same destination (memory or peripheral). According to its configuration through the AHB slave interface, the DMA controller arbitrates between the DMA channels and their associated received requests. The DMA controller also schedules the DMA data transfers over the single AHB port master.  Table 43. DMA implementation Number of channels   STM32C011xx/STM32C031xx   STM32C051xx/STM32C071xx   STM32C091xx/92xx  DMA1   3   5   7  MSv48187V1  DMA  AHB master interface Arbiter Ch 1 AHB slave interface Ch 2 Ch 7 32-bit AHB bus   32-bit AHB bus dma_req [1..7] dma_ack [1..7] ... Interrupt interface dma_it[1..7]

Direct memory access controller (DMA)   RM0490  224/1027   RM0490 Rev 5  The DMA controller generates an interrupt per channel to the interrupt controller.  11.4.2   DMA pins and internal signals  11.4.3   DMA transfers  The software configures the DMA controller at channel level, to perform a block transfer, composed of a sequence of AHB bus transfers. A DMA block transfer may be requested from a peripheral, or triggered by the software in case of memory-to-memory transfer. After an event, the following steps of a single DMA transfer occur: 1.   The peripheral sends a single DMA request signal to the DMA controller. 2.   The DMA controller serves the request, depending on the priority of the channel associated to this peripheral request. 3.   As soon as the DMA controller grants the peripheral, an acknowledge is sent to the peripheral by the DMA controller. 4.   The peripheral releases its request as soon as it gets the acknowledge from the DMA controller. 5.   Once the request is deasserted by the peripheral, the DMA controller releases the acknowledge. The peripheral may order a further single request and initiate another single DMA transfer. The request/acknowledge protocol is used when a peripheral is either the source or the destination of the transfer. For example, in case of memory-to-peripheral transfer, the peripheral initiates the transfer by driving its single request signal to the DMA controller. The DMA controller reads then a single data in the memory and writes this data to the peripheral. For a given channel x, a DMA block transfer consists of a repeated sequence of:  •   a single DMA transfer, encapsulating two AHB transfers of a single data, over the DMA AHB bus master: –   a single data read (byte, half-word, or word) from the peripheral data register or a location in the memory, addressed through an internal current peripheral/memory address register. The start address used for the first single transfer is the base address of the peripheral or memory, and is programmed in the DMA_CPARx or DMA_CMARx register. –   a single data write (byte, half-word, or word) to the peripheral data register or a location in the memory, addressed through an internal current peripheral/memory address register.  Table 44. DMA internal input/output signals Signal name   Signal type   Description  dma_req[x]   Input   DMA channel x request dma_ack[x]   Output   DMA channel x acknowledge dma_it[x]   Output   DMA channel x interrupt

RM0490 Rev 5   225/1027  RM0490   Direct memory access controller (DMA)  241  The start address used for the first transfer is the base address of the peripheral or memory, and is programmed in the DMA_CPARx or DMA_CMARx register.  •   postdecrementing of the programmed DMA_CNDTRx register This register contains the remaining number of data items to transfer (number of AHB ‘read followed by write’ transfers). This sequence is repeated until DMA_CNDTRx is null.  Note:   The AHB master bus source/destination address must be aligned with the programmed size of the transferred single data to the source/destination.  11.4.4   DMA arbitration  The DMA arbiter manages the priority between the different channels. When an active channel x is granted by the arbiter (hardware requested or software triggered), a single DMA transfer is issued (such as an AHB ‘read followed by write’ transfer of a single data). Then, the arbiter considers again the set of active channels and selects the one with the highest priority. The priorities are managed in two stages:  •   software: priority of each channel is configured in the DMA_CCRx register, to one of the four different levels: –   very high –   high –   medium –   low  •   hardware: if two requests have the same software priority level, the channel with the lowest index gets priority. For example, channel 2 gets priority over channel 4. When a channel x is programmed for a block transfer in memory-to-memory mode, re arbitration is considered between each single DMA transfer of this channel x. Whenever there is another concurrent active requested channel, the DMA arbiter automatically alternates and grants the other highest-priority requested channel, which may be of lower priority than the memory-to-memory channel.  11.4.5   DMA channels  Each channel may handle a DMA transfer between a peripheral register located at a fixed address, and a memory address. The number of data items to transfer is programmable. The register that contains the number of data items to transfer is decremented after each transfer. A DMA channel is programmed at block transfer level.  Programmable data sizes  The transfer sizes of a single data (byte, half-word, or word) to the peripheral and memory are programmable through, respectively, the PSIZE[1:0] and MSIZE[1:0] fields of the DMA_CCRx register.  Pointer incrementation  The peripheral and memory pointers may be automatically incremented after each transfer, depending on the PINC and MINC bits of the DMA_CCRx register.

Direct memory access controller (DMA)   RM0490  226/1027   RM0490 Rev 5  If the   incremented mode   is enabled (PINC or MINC set to 1), the address of the next transfer is the address of the previous one incremented by 1, 2 or 4, depending on the data size defined in PSIZE[1:0] or MSIZE[1:0]. The first transfer address is the one programmed in the DMA_CPARx or DMA_CMARx register. During transfers, these registers keep the initially programmed value. The current transfer addresses (in the current internal peripheral/memory address register) are not accessible by software. If the channel x is configured in   noncircular mode , no DMA request is served after the last data transfer (once the number of single data to transfer reaches zero). The DMA channel must be disabled to reload a new number of data items into the DMA_CNDTRx register.  Note:   If the channel x is disabled, the DMA registers are not reset. The DMA channel registers (DMA_CCRx, DMA_CPARx and DMA_CMARx) retain the initial values programmed during the channel configuration phase.  In   circular mode , after the last data transfer, the DMA_CNDTRx register is automatically reloaded with the initially programmed value. The current internal address registers are reloaded with the base address values from the DMA_CPARx and DMA_CMARx registers.  Channel configuration procedure  The following sequence is needed to configure a DMA channel x: 1.   Set the peripheral register address in the DMA_CPARx register. The data is moved from/to this address to/from the memory after the peripheral event, or after the channel is enabled in memory-to-memory mode. 2.   Set the memory address in the DMA_CMARx register. The data is written to/read from the memory after the peripheral event or after the channel is enabled in memory-to-memory mode. 3.   Configure the total number of data to transfer in the DMA_CNDTRx register. After each data transfer, this value is decremented. 4.   Configure the parameters listed below in the DMA_CCRx register: –   the channel priority –   the data transfer direction –   the circular mode –   the peripheral and memory incremented mode –   the peripheral and memory data size –   the interrupt enable at half and/or full transfer and/or transfer error 5.   Activate the channel by setting the EN bit in the DMA_CCRx register. A channel, as soon as enabled, may serve any DMA request from the peripheral connected to this channel, or may start a memory-to-memory block transfer.  Note:   The two last steps of the channel configuration procedure may be merged into a single access to the DMA_CCRx register, to configure and enable the channel.  Channel state and disabling a channel  A channel x in the active state is an enabled channel (read DMA_CCRx.EN = 1). An active channel x is a channel that must have been enabled by the software (DMA_CCRx.EN set to 1) and afterwards with no occurred transfer error (DMA_ISR.TEIFx = 0). In case there is a transfer error, the channel is automatically disabled by hardware (DMA_CCRx.EN = 0).

RM0490 Rev 5   227/1027  RM0490   Direct memory access controller (DMA)  241  The three following use cases may happen:  •   Suspend and resume a channel This corresponds to the two following actions: –   An active channel is disabled by software (writing DMA_CCRx.EN = 0 whereas DMA_CCRx.EN = 1). –   The software enables the channel again (DMA_CCRx.EN set to 1) without reconfiguring the other channel registers (such as DMA_CNDTRx, DMA_CPARx and DMA_CMARx). This case is not supported by the DMA hardware, which does not guarantee that the remaining data transfers are performed correctly.  •   Stop and abort a channel If the application does not need anymore the channel, this active channel can be disabled by software. The channel is stopped and aborted but the DMA_CNDTRx register content may not correctly reflect the remaining data transfers versus the aborted source and destination buffer/register.  •   Abort and restart a channel This corresponds to the software sequence: disable an active channel, then reconfigure the channel and enable it again. This is supported by the hardware if the following conditions are met: –   The application guarantees that, when the software is disabling the channel, a DMA data transfer is not occurring at the same time over its master port. For example, the application can first disable the peripheral in DMA mode, to ensure that there is no pending hardware DMA request from this peripheral. –   The software must operate separated write accesses to the same DMA_CCRx register: First disable the channel. Second reconfigure the channel for a next block transfer including the DMA_CCRx if a configuration change is needed. There are read-only DMA_CCRx register fields when DMA_CCRx.EN=1. Finally enable again the channel. When a channel transfer error occurs, the EN bit of the DMA_CCRx register is cleared by hardware. This EN bit cannot be set again by software to reactivate the channel x, until the TEIFx bit of the DMA_ISR register is set.  Circular mode (in memory-to-peripheral/peripheral-to-memory transfers)  The circular mode is available to handle circular buffers and continuous data flows (such as ADC scan mode). This feature is enabled using the CIRC bit in the DMA_CCRx register.  Note:   The circular mode must not be used in memory-to-memory mode. Before enabling a channel in circular mode (CIRC = 1), the software must clear the MEM2MEM bit of the DMA_CCRx register. When the circular mode is activated, the amount of data to transfer is automatically reloaded with the initial value programmed during the channel configuration phase, and the DMA requests continue to be served. To stop a circular transfer, the software needs to stop the peripheral from generating DMA requests (such as quit the ADC scan mode), before disabling the DMA channel. The software must explicitly program the DMA_CNDTRx value before starting/enabling a transfer, and after having stopped a circular transfer.

Direct memory access controller (DMA)   RM0490  228/1027   RM0490 Rev 5  Memory-to-memory mode  The DMA channels may operate without being triggered by a request from a peripheral. This mode is called memory-to-memory mode, and is initiated by software. If the MEM2MEM bit in the DMA_CCRx register is set, the channel, if enabled, initiates transfers. The transfer stops once the DMA_CNDTRx register reaches zero.  Note:   The memory-to-memory mode must not be used in circular mode. Before enabling a channel in memory-to-memory mode (MEM2MEM = 1), the software must clear the CIRC bit of the DMA_CCRx register.  Peripheral-to-peripheral mode  Any DMA channel can operate in peripheral-to-peripheral mode:  •   when the hardware request from a peripheral is selected to trigger the DMA channel This peripheral is the DMA initiator and paces the data transfer from/to this peripheral to/from a register belonging to another memory-mapped peripheral (this one being not configured in DMA mode).  •   when no peripheral request is selected and connected to the DMA channel The software configures a register-to-register transfer by setting the MEM2MEM bit of the DMA_CCRx register.  Programming transfer direction, assigning source/destination  The value of the DIR bit of the DMA_CCRx register sets the direction of the transfer, and consequently, it identifies the source and the destination, regardless of the source/destination type (peripheral or memory):  •   DIR = 1   defines typically a memory-to-peripheral transfer. More generally, if DIR = 1: –   The   source   attributes are defined by the DMA_MARx register, the MSIZE[1:0] field, and the MINC bit of the DMA_CCRx register. Regardless of their usual naming, these ‘memory’ register, field, and bit are used to define the source peripheral in peripheral-to-peripheral mode. –   The   destination   attributes are defined by the DMA_PARx register, the PSIZE[1:0] field and the PINC bit of the DMA_CCRx register. Regardless of their usual naming, these ‘peripheral’ register, field, and bit are used to define the destination memory in memory-to-memory mode.  •   DIR = 0   defines typically a peripheral-to-memory transfer. More generally, if DIR = 0: –   The   source   attributes are defined by the DMA_PARx register, the PSIZE[1:0] field and the PINC bit of the DMA_CCRx register. Regardless of their usual naming, these ‘peripheral’ register, field, and bit are used to define the source memory in memory-to-memory mode –   The   destination   attributes are defined by the DMA_MARx register, the MSIZE[1:0] field and the MINC bit of the DMA_CCRx register. Regardless of their usual naming, these ‘memory’ register, field, and bit are used to define the destination peripheral in peripheral-to-peripheral mode.

RM0490 Rev 5   229/1027  RM0490   Direct memory access controller (DMA)  241  11.4.6   DMA data width, alignment, and endianness  When PSIZE[1:0] and MSIZE[1:0] are not equal, the DMA controller performs some data alignments as described in the table below.  Table 45. Programmable data width and endian behavior (when PINC = MINC = 1) Source port width (MSIZE if DIR = 1, else PSIZE) Destinat ion port width (PSIZE if DIR = 1, else MSIZE) Number of data items to transfer (NDT) Source content: address / data (DMA_CMARx if DIR = 1, else DMA_CPARx) DMA transfers Destination content: address / data (DMA_CPARx if DIR = 1, else DMA_CMARx)  8   8   4 @0x0 / B0 @0x1 / B1 @0x2 / B2 @0x3 / B3 1: read B0[7:0] @0x0 then write B0[7:0] @0x0 2: read B1[7:0] @0x1 then write B1[7:0] @0x1 3: read B2[7:0] @0x2 then write B2[7:0] @0x2 4: read B3[7:0] @0x3 then write B3[7:0] @0x3 @0x0 / B0 @0x1 / B1 @0x2 / B2 @0x3 / B3 8   16   4 @0x0 / B0 @0x1 / B1 @0x2 / B2 @0x3 / B3 1: read B0[7:0] @0x0 then write 00B0[15:0] @0x0 2: read B1[7:0] @0x1 then write 00B1[15:0] @0x2 3: read B2[7:0] @0x2 then write 00B2[15:0] @0x4 4: read B3[7:0] @0x3 then write 00B3[15:0] @0x6 @0x0 / 00B0 @0x2 / 00B1 @0x4 / 00B2 @0x6 / 00B3 8   32   4 @0x0 / B0 @0x1 / B1 @0x2 / B2 @0x3 / B3 1: read B0[7:0] @0x0 then write 000000B0[31:0] @0x0 2: read B1[7:0] @0x1 then write 000000B1[31:0] @0x4 3: read B2[7:0] @0x2 then write 000000B2[31:0] @0x8 4: read B3[7:0] @0x3 then write 000000B3[31:0] @0xC @0x0 / 000000B0 @0x4 / 000000B1 @0x8 / 000000B2 @0xC / 000000B3 16   8   4 @0x0 / B1B0 @0x2 / B3B2 @0x4 / B5B4 @0x6 / B7B6 1: read B1B0[15:0] @0x0 then write B0[7:0] @0x0 2: read B3B2[15:0] @0x2 then write B2[7:0] @0x1 3: read B5B4[15:0] @0x4 then write B4[7:0] @0x2 4: read B7B6[15:0] @0x6 then write B6[7:0] @0x3 @0x0 / B0 @0x1 / B2 @0x2 / B4 @0x3 / B6 16   16   4 @0x0 / B1B0 @0x2 / B3B2 @0x4 / B5B4 @0x6 / B7B6 1: read B1B0[15:0] @0x0 then write B1B0[15:0] @0x0 2: read B3B2[15:0] @0x2 then write B3B2[15:0] @0x2 3: read B5B4[15:0] @0x4 then write B5B4[15:0] @0x4 4: read B7B6[15:0] @0x6 then write B7B6[15:0] @0x6 @0x0 / B1B0 @0x2 / B3B2 @0x4 / B5B4 @0x6 / B7B6 16   32   4 @0x0 / B1B0 @0x2 / B3B2 @0x4 / B5B4 @0x6 / B7B6 1: read B1B0[15:0] @0x0 then write 0000B1B0[31:0] @0x0 2: read B3B2[15:0] @0x2 then write 0000B3B2[31:0] @0x4 3: read B5B4[15:0] @0x4 then write 0000B5B4[31:0] @0x8 4: read B7B6[15:0] @0x6 then write 0000B7B6[31:0] @0xC @0x0 / 0000B1B0 @0x4 / 0000B3B2 @0x8 / 0000B5B4 @0xC / 0000B7B6 32   8   4 @0x0 / B3B2B1B0 @0x4 / B7B6B5B4 @0x8 / BBBAB9B8 @0xC / BFBEBDBC 1: read B3B2B1B0[31:0] @0x0 then write B0[7:0] @0x0 2: read B7B6B5B4[31:0] @0x4 then write B4[7:0] @0x1 3: read BBBAB9B8[31:0] @0x8 then write B8[7:0] @0x2 4: read BFBEBDBC[31:0] @0xC then write BC[7:0] @0x3 @0x0 / B0 @0x1 / B4 @0x2 / B8 @0x3 / BC 32   16   4 @0x0 / B3B2B1B0 @0x4 / B7B6B5B4 @0x8 / BBBAB9B8 @0xC / BFBEBDBC 1: read B3B2B1B0[31:0] @0x0 then write B1B0[15:0] @0x0 2: read B7B6B5B4[31:0] @0x4 then write B5B4[15:0] @0x2 3: read BBBAB9B8[31:0] @0x8 then write B9B8[15:0] @0x4 4: read BFBEBDBC[31:0] @0xC then write BDBC[15:0] @0x6 @0x0 / B1B0 @0x2 / B5B4 @0x4 / B9B8 @0x6 / BDBC 32   32   4 @0x0 / B3B2B1B0 @0x4 / B7B6B5B4 @0x8 / BBBAB9B8 @0xC / BFBEBDBC 1: read B3B2B1B0[31:0] @0x0 then write B3B2B1B0[31:0] @0x0 2: read B7B6B5B4[31:0] @0x4 then write B7B6B5B4[31:0] @0x4 3: read BBBAB9B8[31:0] @0x8 then write BBBAB9B8[31:0] @0x8 4: read BFBEBDBC[31:0] @0xC then write BFBEBDBC[31:0] @0xC @0x0 / B3B2B1B0 @0x4 / B7B6B5B4 @0x8 / BBBAB9B8 @0xC / BFBEBDBC

Direct memory access controller (DMA)   RM0490  230/1027   RM0490 Rev 5  Addressing AHB peripherals not supporting byte/half-word write transfers  When the DMA controller initiates an AHB byte or half-word write transfer, the data are duplicated on the unused lanes of the AHB master 32-bit data bus (HWDATA[31:0]). When the AHB slave peripheral does not support byte or half-word write transfers and does not generate any error, the DMA controller writes the 32 HWDATA bits as shown in the two examples below:  •   To write the half-word 0xABCD, the DMA controller sets the HWDATA bus to 0xABCDABCD with a half-word data size (HSIZE = HalfWord in the AHB master bus).  •   To write the byte 0xAB, the DMA controller sets the HWDATA bus to 0xABABABAB with a byte data size (HSIZE = Byte in the AHB master bus). Assuming the AHB/APB bridge is an AHB 32-bit slave peripheral that does not take into account the HSIZE data, any AHB byte or half-word transfer is changed into a 32-bit APB transfer as described below:  •   An AHB byte write transfer of 0xB0 to one of the 0x0, 0x1, 0x2, or 0x3 addresses, is converted to an APB word write transfer of 0xB0B0B0B0 to the 0x0 address.  •   An AHB half-word write transfer of 0xB1B0 to the 0x0 or 0x2 addresses is converted to an APB word write transfer of 0xB1B0B1B0 to the 0x0 address.  11.4.7   DMA error management  A DMA transfer error is generated when reading from or writing to a reserved address space. When a DMA transfer error occurs during a DMA read or write access, the faulty channel x is automatically disabled through a hardware clear of its EN bit in the corresponding DMA_CCRx register. The TEIFx bit of the DMA_ISR register is set. An interrupt is then generated if the TEIE bit of the DMA_CCRx register is set. The EN bit of the DMA_CCRx register cannot be set again by software (channel x reactivated) until the TEIFx bit of the DMA_ISR register is cleared (by setting the CTEIFx bit of the DMA_IFCR register). When the software is notified with a transfer error over a channel, which involves a peripheral, the software has first to stop this peripheral in DMA mode, in order to disable any pending or future DMA request. Then software may normally reconfigure both the DMA and the peripheral in DMA mode for a new transfer.

RM0490 Rev 5   231/1027  RM0490   Direct memory access controller (DMA)  241  11.5   DMA interrupts  An interrupt can be generated on a half transfer, transfer complete, or transfer error for each DMA channel x. Separate interrupt enable bits are available for flexibility.  11.6   DMA registers  Refer to   Section 1.2   for a list of abbreviations used in register descriptions. The DMA registers have to be accessed by words (32-bit).  11.6.1   DMA interrupt status register (DMA_ISR)  Address offset: 0x00 Reset value: 0x0000 0000 Every status bit is cleared by hardware when the software sets the corresponding clear bit or the corresponding global clear bit CGIFx, in the DMA_IFCR register.  Table 46. DMA interrupt requests Interrupt request   Interrupt event   Event flag   Interrupt enable bit  Channel x interrupt Half transfer on channel x   HTIFx   HTIEx Transfer complete on channel x   TCIFx   TCIEx Transfer error on channel x   TEIFx   TEIEx Half transfer or transfer complete or transfer error on channel x   GIFx   - 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   TEIF7   HTIF7   TCIF7   GIF7   TEIF6   HTIF6   TCIF6   GIF6   TEIF5   HTIF5   TCIF5   GIF5 r   r   r   r   r   r   r   r   r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 TEIF4   HTIF4   TCIF4   GIF4   TEIF3   HTIF3   TCIF3   GIF3   TEIF2   HTIF2   TCIF2   GIF2   TEIF1   HTIF1   TCIF1   GIF1 r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r Bits 31:28   Reserved, must be kept at reset value. Bit 27   TEIF7 : Transfer error (TE) flag for channel 7 0: No TE event 1: A TE event occurred. Bit 26   HTIF7 : Half transfer (HT) flag for channel 7 0: No HT event 1: An HT event occurred. Bit 25   TCIF7 : Transfer complete (TC) flag for channel 7 0: No TC event 1: A TC event occurred. Bit 24   GIF7 : Global interrupt flag for channel 7 0: No TE, HT, or TC event 1: A TE, HT, or TC event occurred.

Direct memory access controller (DMA)   RM0490  232/1027   RM0490 Rev 5  Bit 23   TEIF6 : Transfer error (TE) flag for channel 6 0: No TE event 1: A TE event occurred. Bit 22   HTIF6 : Half transfer (HT) flag for channel 6 0: No HT event 1:An HT event occurred. Bit 21   TCIF6 : Transfer complete (TC) flag for channel 6 0: No TC event 1: A TC event occurred. Bit 20   GIF6 : Global interrupt flag for channel 6 0: No TE, HT, or TC event 1: A TE, HT, or TC event occurred. Bit 19   TEIF5 : Transfer error (TE) flag for channel 5 0: No TE event 1: A TE event occurred. Bit 18   HTIF5 : Half transfer (HT) flag for channel 5 0: No HT event 1: An HT event occurred. Bit 17   TCIF5 : Transfer complete (TC) flag for channel 5 0: No TC event 1: A TC event occurred. Bit 16   GIF5 : global interrupt flag for channel 5 0: No TE, HT, or TC event 1: A TE, HT, or TC event occurred. Bit 15   TEIF4 : Transfer error (TE) flag for channel 4 0: No TE event 1: A TE event occurred. Bit 14   HTIF4 : Half transfer (HT) flag for channel 4 0: No HT event 1: An HT event occurred. Bit 13   TCIF4 : Transfer complete (TC) flag for channel 4 0: No TC event 1: A TC event occurred. Bit 12   GIF4 : global interrupt flag for channel 4 0: No TE, HT, or TC event 1: A TE, HT, or TC event occurred. Bit 11   TEIF3 : Transfer error (TE) flag for channel 3 0: No TE event 1: A TE event occurred. Bit 10   HTIF3 : Half transfer (HT) flag for channel 3 0: No HT event 1: An HT event occurred. Bit 9   TCIF3 : Transfer complete (TC) flag for channel 3 0: No TC event 1: A TC event occurred.

RM0490 Rev 5   233/1027  RM0490   Direct memory access controller (DMA)  241  11.6.2   DMA interrupt flag clear register (DMA_IFCR)  Address offset: 0x04 Reset value: 0x0000 0000 Setting the global clear bit CGIFx of the channel x in this DMA_IFCR register, causes the DMA hardware to clear the corresponding GIFx bit and any individual flag among TEIFx, HTIFx, TCIFx, in the DMA_ISR register. Setting any individual clear bit among CTEIFx, CHTIFx, CTCIFx in this DMA_IFCR register, causes the DMA hardware to clear the corresponding individual flag and the global flag GIFx in the DMA_ISR register, provided that none of the two other individual flags is set. Writing 0 into any flag clear bit has no effect. Bit 8   GIF3 : Global interrupt flag for channel 3 0: No TE, HT, or TC event 1: A TE, HT, or TC event occurred. Bit 7   TEIF2 : Transfer error (TE) flag for channel 2 0: No TE event 1: A TE event occurred. Bit 6   HTIF2 : Half transfer (HT) flag for channel 2 0: No HT event 1: An HT event occurred. Bit 5   TCIF2 : Transfer complete (TC) flag for channel 2 0: No TC event 1: A TC event occurred. Bit 4   GIF2 : Global interrupt flag for channel 2 0: No TE, HT, or TC event 1: A TE, HT, or TC event occurred. Bit 3   TEIF1 : Transfer error (TE) flag for channel 1 0: No TE event 1: A TE event occurred. Bit 2   HTIF1 : Half transfer (HT) flag for channel 1 0: No HT event 1: An HT event occurred. Bit 1   TCIF1 : Transfer complete (TC) flag for channel 1 0: No TC event 1: A TC event occurred. Bit 0   GIF1 : Global interrupt flag for channel 1 0: No TE, HT, or TC event 1: A TE, HT, or TC event occurred.

Direct memory access controller (DMA)   RM0490  234/1027   RM0490 Rev 5  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   CTEIF7   CHTIF7   CTCIF7   CGIF7   CTEIF6   CHTIF6   CTCIF6   CGIF6   CTEIF5   CHTIF5   CTCIF5   CGIF5 w   w   w   w   w   w   w   w   w   w   w   w 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CTEIF4   CHTIF4   CTCIF4   CGIF4   CTEIF3   CHTIF3   CTCIF3   CGIF3   CTEIF2   CHTIF2   CTCIF2   CGIF2   CTEIF1   CHTIF1   CTCIF1   CGIF1 w   w   w   w   w   w   w   w   w   w   w   w   w   w   w   w Bits 31:28   Reserved, must be kept at reset value. Bit 27   CTEIF7 : Transfer error flag clear for channel 7 Bit 26   CHTIF7 : Half transfer flag clear for channel 7 Bit 25   CTCIF7 : Transfer complete flag clear for channel 7 Bit 24   CGIF7 : Global interrupt flag clear for channel 7 Bit 23   CTEIF6 : Transfer error flag clear for channel 6 Bit 22   CHTIF6 : Half transfer flag clear for channel 6 Bit 21   CTCIF6 : Transfer complete flag clear for channel 6 Bit 20   CGIF6 : Global interrupt flag clear for channel 6 Bit 19   CTEIF5 : Transfer error flag clear for channel 5 Bit 18   CHTIF5 : Half transfer flag clear for channel 5 Bit 17   CTCIF5 : Transfer complete flag clear for channel 5 Bit 16   CGIF5 : Global interrupt flag clear for channel 5 Bit 15   CTEIF4 : Transfer error flag clear for channel 4 Bit 14   CHTIF4 : Half transfer flag clear for channel 4 Bit 13   CTCIF4 : Transfer complete flag clear for channel 4 Bit 12   CGIF4 : Global interrupt flag clear for channel 4 Bit 11   CTEIF3 : Transfer error flag clear for channel 3 Bit 10   CHTIF3 : Half transfer flag clear for channel 3 Bit 9   CTCIF3 : Transfer complete flag clear for channel 3 Bit 8   CGIF3 : Global interrupt flag clear for channel 3 Bit 7   CTEIF2 : Transfer error flag clear for channel 2 Bit 6   CHTIF2 : Half transfer flag clear for channel 2 Bit 5   CTCIF2 : Transfer complete flag clear for channel 2 Bit 4   CGIF2 : Global interrupt flag clear for channel 2 Bit 3   CTEIF1 : Transfer error flag clear for channel 1 Bit 2   CHTIF1 : Half transfer flag clear for channel 1 Bit 1   CTCIF1 : Transfer complete flag clear for channel 1 Bit 0   CGIF1 : Global interrupt flag clear for channel 1

RM0490 Rev 5   235/1027  RM0490   Direct memory access controller (DMA)  241  11.6.3   DMA channel x configuration register (DMA_CCRx)  Address offset: 0x08 + 0x14 * (x - 1), (x = 1 to 7) Reset value: 0x0000 0000 The register fields/bits MEM2MEM, PL[1:0], MSIZE[1:0], PSIZE[1:0], MINC, PINC, and DIR are read-only when EN = 1. The states of MEM2MEM and CIRC bits must not be both high at the same time. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   MEM2 MEM   PL[1:0]   MSIZE[1:0]   PSIZE[1:0]   MINC   PINC   CIRC   DIR   TEIE   HTIE   TCIE   EN rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:15   Reserved, must be kept at reset value. Bit 14   MEM2MEM : Memory-to-memory mode 0: Disabled 1: Enabled  Note:   This bit is set and cleared by software. It must not be written when the channel is enabled (EN = 1). It is read-only when the channel is enabled (EN = 1).  Bits 13:12   PL[1:0] : Priority level 00: Low 01: Medium 10: High 11: Very high  Note:   This bitfield is set and cleared by software. It must not be written when the channel is enabled (EN = 1). It is read-only when the channel is enabled (EN = 1).  Bits 11:10   MSIZE[1:0] : Memory size Defines the data size of each DMA transfer to the identified memory. In memory-to-memory mode, this bitfield identifies the memory source if DIR = 1 and the memory destination if DIR = 0. In peripheral-to-peripheral mode, this bitfield identifies the peripheral source if DIR = 1 and the peripheral destination if DIR = 0. 00: 8 bits 01: 16 bits 10: 32 bits 11: Reserved  Note:   This bitfield is set and cleared by software. It must not be written when the channel is enabled (EN = 1). It is read-only when the channel is enabled (EN = 1).

Direct memory access controller (DMA)   RM0490  236/1027   RM0490 Rev 5  Bits 9:8   PSIZE[1:0] : Peripheral size Defines the data size of each DMA transfer to the identified peripheral. In memory-to-memory mode, this bitfield identifies the memory destination if DIR = 1 and the memory source if DIR = 0. In peripheral-to-peripheral mode, this bitfield identifies the peripheral destination if DIR = 1 and the peripheral source if DIR = 0. 00: 8 bits 01: 16 bits 10: 32 bits 11: Reserved  Note:   This bitfield is set and cleared by software. It must not be written when the channel is enabled (EN = 1). It is read-only when the channel is enabled (EN = 1).  Bit 7   MINC : Memory increment mode Defines the increment mode for each DMA transfer to the identified memory. In memory-to-memory mode, this bit identifies the memory source if DIR = 1 and the memory destination if DIR = 0. In peripheral-to-peripheral mode, this bit identifies the peripheral source if DIR = 1 and the peripheral destination if DIR = 0. 0: Disabled 1: Enabled  Note:   This bit is set and cleared by software. It must not be written when the channel is enabled (EN = 1). It is read-only when the channel is enabled (EN = 1).  Bit 6   PINC : Peripheral increment mode Defines the increment mode for each DMA transfer to the identified peripheral. n memory-to-memory mode, this bit identifies the memory destination if DIR = 1 and the memory source if DIR = 0. In peripheral-to-peripheral mode, this bit identifies the peripheral destination if DIR = 1 and the peripheral source if DIR = 0. 0: Disabled 1: Enabled  Note:   This bit is set and cleared by software. It must not be written when the channel is enabled (EN = 1). It is read-only when the channel is enabled (EN = 1).  Bit 5   CIRC : Circular mode 0: Disabled 1: Enabled  Note:   This bit is set and cleared by software. It must not be written when the channel is enabled (EN = 1). It is not read-only when the channel is enabled (EN = 1).

RM0490 Rev 5   237/1027  RM0490   Direct memory access controller (DMA)  241  11.6.4   DMA channel x number of data to transfer register (DMA_CNDTRx)  Address offset: 0x0C + 0x14 * (x - 1), (x = 1 to 7) Reset value: 0x0000 0000 Bit 4   DIR : Data transfer direction This bit must be set only in memory-to-peripheral and peripheral-to-memory modes. 0: Read from peripheral –   Source attributes are defined by PSIZE and PINC, plus the DMA_CPARx register. This is still valid in a memory-to-memory mode. –   Destination attributes are defined by MSIZE and MINC, plus the DMA_CMARx register. This is still valid in a peripheral-to-peripheral mode. 1: Read from memory –   Destination attributes are defined by PSIZE and PINC, plus the DMA_CPARx register. This is still valid in a memory-to-memory mode. –   Source attributes are defined by MSIZE and MINC, plus the DMA_CMARx register. This is still valid in a peripheral-to-peripheral mode.  Note:   This bit is set and cleared by software. It must not be written when the channel is enabled (EN = 1). It is read-only when the channel is enabled (EN = 1).  Bit 3   TEIE : Transfer error interrupt enable 0: Disabled 1: Enabled  Note:   This bit is set and cleared by software. It must not be written when the channel is enabled (EN = 1). It is not read-only when the channel is enabled (EN = 1).  Bit 2   HTIE : Half transfer interrupt enable 0: Disabled 1: Enabled  Note:   This bit is set and cleared by software. It must not be written when the channel is enabled (EN = 1). It is not read-only when the channel is enabled (EN = 1).  Bit 1   TCIE : Transfer complete interrupt enable 0: Disabled 1: Enabled  Note:   This bit is set and cleared by software. It must not be written when the channel is enabled (EN = 1). It is not read-only when the channel is enabled (EN = 1).  Bit 0   EN : Channel enable When a channel transfer error occurs, this bit is cleared by hardware. It can not be set again by software (channel x re-activated) until the TEIFx bit of the DMA_ISR register is cleared (by setting the CTEIFx bit of the DMA_IFCR register). 0: Disabled 1: Enabled  Note:   This bit is set and cleared by software.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 NDT[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

Direct memory access controller (DMA)   RM0490  238/1027   RM0490 Rev 5  11.6.5   DMA channel x peripheral address register (DMA_CPARx)  Address offset: 0x10 + 0x14 * (x - 1), (x = 1 to 7) Reset value: 0x0000 0000 Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   NDT[15:0] : Number of data to transfer (0 to 2   16   - 1) This bitfield is updated by hardware when the channel is enabled: –   It is decremented after each single DMA ‘read followed by write’ transfer, indicating the remaining amount of data items to transfer. –   It is kept at zero when the programmed amount of data to transfer is reached, if the channel is not in circular mode (CIRC = 0 in the DMA_CCRx register). –   It is reloaded automatically by the previously programmed value, when the transfer is complete, if the channel is in circular mode (CIRC = 1). If this bitfield is zero, no transfer can be served whatever the channel status (enabled or not).  Note:   This bitfield is set and cleared by software. It must not be written when the channel is enabled (EN = 1). It is read-only when the channel is enabled (EN = 1).  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 PA[31:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 PA[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:0   PA[31:0] : Peripheral address It contains the base address of the peripheral data register from/to which the data is read/written. When PSIZE[1:0] = 01 (16 bits), bit 0 of PA[31:0] is ignored. Access is automatically aligned to a half-word address. When PSIZE[1:0] = 10 (32 bits), bits 1 and 0 of PA[31:0] are ignored. Access is automatically aligned to a word address. In memory-to-memory mode, this bitfield identifies the memory destination address if DIR = 1 and the memory source address if DIR = 0. In peripheral-to-peripheral mode, this bitfield identifies the peripheral destination address if DIR = 1 and the peripheral source address if DIR = 0.  Note:   This bitfield is set and cleared by software. It must not be written when the channel is enabled (EN = 1). It is not read-only when the channel is enabled (EN = 1).

RM0490 Rev 5   239/1027  RM0490   Direct memory access controller (DMA)  241  11.6.6   DMA channel x memory address register (DMA_CMARx)  Address offset: 0x14 + 0x14 * (x - 1), (x = 1 to 7) Reset value: 0x0000 0000  11.6.7   DMA register map  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 MA[31:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 MA[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:0   MA[31:0] : Peripheral address It contains the base address of the memory from/to which the data is read/written. When MSIZE[1:0] = 01 (16 bits), bit 0 of MA[31:0] is ignored. Access is automatically aligned to a half-word address. When MSIZE[1:0] = 10 (32 bits), bits 1 and 0 of MA[31:0] are ignored. Access is automatically aligned to a word address. In memory-to-memory mode, this bitfield identifies the memory source address if DIR = 1 and the memory destination address if DIR = 0. In peripheral-to-peripheral mode, this bitfield identifies the peripheral source address if DIR = 1 and the peripheral destination address if DIR = 0.  Note:   This bitfield is set and cleared by software. It must not be written when the channel is enabled (EN = 1). It is not read-only when the channel is enabled (EN = 1).  Table 47. DMA register map and reset values Offset Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x000   DMA_ISR Res. Res. Res. Res. TEIF7 HTIF7 TCIF7 GIF7 TEIF6 HTIF6 TCIF6 GIF6 TEIF5 HTIF5 TCIF5 GIF5 TEIF4 HTIF4 TCIF4 GIF4 TEIF3 HTIF3 TCIF3 GIF3 TEIF2 HTIF2 TCIF2 GIF2 TEIF1 HTIF1 TCIF1 GIF1 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x004   DMA_IFCR Res. Res. Res. Res. CTEIF7 CHTIF7 CTCIF7 CGIF7 CTEIF6 CHTIF6 CTCIF6 CGIF6 CTEIF5 CHTIF5 CTCIF5 CGIF5 CTEIF4 CHTIF4 CTCIF4 CGIF4 CTEIF3 CHTIF3 CTCIF3 CGIF3 CTEIF2 CHTIF2 CTCIF2 CGIF2 CTEIF1 CHTIF1 CTCIF1 CGIF1 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x008   DMA_CCR1 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. MEM2MEM PL[1:0] MSIZE[1:0] PSIZE[1:0] MINC PINC CIRC DIR TEIE HTIE TCIE EN Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x00C   DMA_CNDTR1 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. NDTR[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x010   DMA_CPAR1   PA[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x014   DMA_CMAR1   MA[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x018   Reserved   Reserved.

Direct memory access controller (DMA)   RM0490  240/1027   RM0490 Rev 5  0x01C   DMA_CCR2 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. MEM2MEM PL[1:0] MSIZE[1:0] PSIZE[1:0] MINC PINC CIRC DIR TEIE HTIE TCIE EN Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x020   DMA_CNDTR2 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. NDTR[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x024   DMA_CPAR2   PA[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x028   DMA_CMAR2   MA[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x02C   Reserved   Reserved. 0x030   DMA_CCR3 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. MEM2MEM PL[1:0] MSIZE[1:0] PSIZE[1:0] MINC PINC CIRC DIR TEIE HTIE TCIE EN Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x034   DMA_CNDTR3 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. NDTR[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x038   DMA_CPAR3   PA[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x03C   DMA_CMAR3   MA[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x040   Reserved   Reserved. 0x044   DMA_CCR4 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. MEM2MEM PL[1:0] MSIZE[1:0] PSIZE[1:0] MINC PINC CIRC DIR TEIE HTIE TCIE EN Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x048   DMA_CNDTR4 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. NDTR[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x04C   DMA_CPAR4   PA[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x050   DMA_CMAR4   MA[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x054   Reserved   Reserved. 0x058   DMA_CCR5 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. MEM2MEM PL[1:0] MSIZE[1:0] PSIZE[1:0] MINC PINC CIRC DIR TEIE HTIE TCIE EN Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x05C   DMA_CNDTR5 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. NDTR[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x060   DMA_CPAR5   PA[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x064   DMA_CMAR5   MA[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x068   Reserved   Reserved. 0x06C   DMA_CCR6 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. MEM2MEM PL[1:0] MSIZE[1:0] PSIZE[1:0] MINC PINC CIRC DIR TEIE HTIE TCIE EN Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0  Table 47. DMA register map and reset values (continued) Offset Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

RM0490 Rev 5   241/1027  RM0490   Direct memory access controller (DMA)  241  Refer to   Section 2.2   for the register boundary addresses. 0x070   DMA_CNDTR6 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. NDTR[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x074   DMA_CPAR6   PA[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x078   DMA_CMAR6   MA[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x07C   Reserved   Reserved. 0x080   DMA_CCR7 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. MEM2MEM PL[1:0] MSIZE[1:0] PSIZE[1:0] MINC PINC CIRC DIR TEIE HTIE TCIE EN Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x084   DMA_CNDTR7 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. NDTR[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x088   DMA_CPAR7   PA[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x08C   DMA_CMAR7   MA[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0  Table 47. DMA register map and reset values (continued) Offset Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

DMA request multiplexer (DMAMUX)   RM0490  242/1027   RM0490 Rev 5  12   DMA request multiplexer (DMAMUX) 12.1   Introduction  A peripheral indicates a request for DMA transfer by setting its DMA request signal. The DMA request is pending until served by the DMA controller that generates a DMA acknowledge signal, and the corresponding DMA request signal is deasserted. In this document, the set of control signals required for the DMA request/acknowledge protocol is not explicitly shown or described, and it is referred to as DMA request line. The DMAMUX request multiplexer enables routing a DMA request line between the peripherals and the DMA controller of the product. The routing function is ensured by a programmable multi-channel DMA request line multiplexer. Each channel selects a unique DMA request line, unconditionally or synchronously with events from its DMAMUX synchronization inputs. The DMAMUX may also be used as a DMA request generator from programmable events on its input trigger signals. The number of DMAMUX instances and their main characteristics are specified in  Section 12.3.1 . The assignment of DMAMUX request multiplexer inputs to the DMA request lines from peripherals and to the DMAMUX request generator outputs, the assignment of DMAMUX request multiplexer outputs to DMA controller channels, and the assignment of DMAMUX synchronizations and trigger inputs to internal and external signals depend upon product implementation. They are detailed in   Section 12.3.2 .

RM0490 Rev 5   243/1027  RM0490   DMA request multiplexer (DMAMUX)  256  12.2   DMAMUX main features  •   Up to 5-channel programmable DMA request line multiplexer output  •   4-channel DMA request generator  •   23 trigger inputs to DMA request generator  •   23 synchronization inputs  •   Per DMA request generator channel: –   DMA request trigger input selector –   DMA request counter –   Event overrun flag for selected DMA request trigger input  •   Per DMA request line multiplexer channel output: –   Up to 57 input DMA request lines from peripherals –   One DMA request line output –   Synchronization input selector –   DMA request counter –   Event overrun flag for selected synchronization input –   One event output, for DMA request chaining  12.3   DMAMUX implementation 12.3.1   DMAMUX instantiation  DMAMUX is instantiated with the hardware configuration parameters listed in the following table.  12.3.2   DMAMUX mapping  The mapping of resources to DMAMUX is hardwired.  Table 48. DMAMUX instantiation Feature   DMAMUX  Number of DMAMUX output request channels   3/5/7 (1) 1.   Seven instances for STM32C091/92xx devices, five instances for STM32C051/71xx devices, three instances for STM32C011/31xx devices. Number of DMAMUX request generator channels   4 Number of DMAMUX request trigger inputs   23 Number of DMAMUX synchronization inputs   23 Number of DMAMUX peripheral request inputs   Up to 57

DMA request multiplexer (DMAMUX)   RM0490  244/1027   RM0490 Rev 5  Table 49. DMAMUX: assignment of multiplexer inputs to resources DMA request MUX input Resource DMA request MUX input Resource DMA request MUX input Resource  1   dmamux_gen0_dma   20   tim1_ch1_dma   39   Reserved 2   dmamux_gen1_dma   21   tim1_ch2_dma   40   tim15_ch1_dma 3   dmamux_gen2_dma   22   tim1_ch3_dma   41   tim15_ch2_dma 4   dmamux_gen3_dma   23   tim1_ch4_dma   42   tim15_trgi_com_dma 5   adc1_dma   24   tim1_trgi_com_dma   43   tim15_up_dma 6   Reserved   25   tim1_up_dma   44   tim16_ch1_dma 7   Reserved   26   tim2_ch1_dma   45   tim16_trgi_com_dma 8   Reserved   27   tim2_ch2_dma   46   tim16_up_dma 9   Reserved   28   tim2_ch3_dma   47   tim17_ch1_dma 10   i2c1_rx_dma   29   tim2_ch4_dma   48   tim17_trgi_com_dma 11   i2c1_tx_dma   30   tim2_trgi_dma   49   tim17_up_dma 12   i2c2_rx_dma   31   tim2_up_dma   50   usart1_rx_dma 13   i2c2_tx_dma   32   tim3_ch1_dma   51   usart1_tx_dma 14   Reserved   33   tim3_ch2_dma   52   usart2_rx_dma 15   Reserved   34   tim3_ch3_dma   53   usart2_tx_dma 16   spi2s1_rx_dma   35   tim3_ch4_dma   54   usart3_rx_dma 17   spi2s1_tx_dma   36   tim3_trgi_dma   55   usart3_tx_dma 18   spi2_rx_dma   37   tim3_up_dma   56   usart4_rx_dma 19   spi2_tx_dma   38   Reserved   57   usart4_tx_dma  Table 50. DMAMUX: assignment of trigger inputs to resources Trigger input   Resource   Trigger input   Resource  0   EXTI0   12   EXTI12 1   EXTI1   13   EXTI13 2   EXTI2   14   EXTI14 3   EXTI3   15   EXTI15 4   EXTI4   16   dmamux_evt0 5   EXTI5   17   dmamux_evt1 6   EXTI6   18   dmamux_evt2 7   EXTI7   19   dmamux_evt3 8   EXTI8   20   Reserved 9   EXTI9   21   Reserved 10   EXTI10   22   tim14_trgo 11   EXTI11   23   Reserved

RM0490 Rev 5   245/1027  RM0490   DMA request multiplexer (DMAMUX)  256  Table 51. DMAMUX: assignment of synchronization inputs to resources Trigger input   Resource   Trigger input   Resource  0   EXTI0   12   EXTI12 1   EXTI1   13   EXTI13 2   EXTI2   14   EXTI14 3   EXTI3   15   EXTI15 4   EXTI4   16   dmamux_evt0 5   EXTI5   17   dmamux_evt1 6   EXTI6   18   dmamux_evt2 7   EXTI7   19   dmamux_evt3 8   EXTI8   20   Reserved 9   EXTI9   21   tim14_trgo 10   EXTI10   22   Reserved 11   EXTI11   23   Reserved

DMA request multiplexer (DMAMUX)   RM0490  246/1027   RM0490 Rev 5  12.4   DMAMUX functional description 12.4.1   DMAMUX block diagram  Figure 22   shows the DMAMUX block diagram.  Figure 22. DMAMUX block diagram  DMAMUX features two main sub-blocks: the request line multiplexer and the request line generator. The implementation assigns:  •   DMAMUX request multiplexer sub-block inputs (dmamux_reqx) from peripherals (dmamux_req_inx) and from channels of the DMAMUX request generator sub-block (dmamux_req_genx)  •   DMAMUX request outputs to channels of DMA controllers (dmamux_req_outx)  •   Internal or external signals to DMA request trigger inputs (dmamux_trgx)  •   Internal or external signals to synchronization inputs (dmamux_syncx)  MSv39745V1  DMAMUX_C0CR Channel 0  0   Channel select   Ctrl  Channel 1 Channel m DMAMUX   Request multiplexer  p n+3 n+2 n+p+2 1 0 n 2 1 n+1  Control registers  1  DMAMUX_CmCR DMAMUX_RGC0CR DMAMUX_RGC1CR DMAMUX_RGCnCR  Channel n Channel 1 Channel 0  Sync Request generator AHB slave interface  32-bit AHB bus dmamux_hclk  Interrupt interface Interrupt:  dmamux_ovr_it   Synchronization inputs:  dmamux_syncx  Trigger inputs:  dmamux_trgx  DMA requests to DMA controllers:  dmamux_req_outx  DMA channels events:  dmamux_evtx  DMA requests from peripherals:  dmamux_req_inx 0 1 s 0 1 s 0 1 m 0 1 m 0 1 t dmamux_req_genx dmamux_reqx

RM0490 Rev 5   247/1027  RM0490   DMA request multiplexer (DMAMUX)  256  12.4.2   DMAMUX signals  Table 52   lists the DMAMUX signals.  12.4.3   DMAMUX channels  A DMAMUX channel is a request multiplexer channel that can include, depending upon the selected input of the request multiplexer, an additional DMAMUX request generator channel. A DMAMUX request multiplexer channel is connected and dedicated to a single channel of DMA controller.  Channel configuration procedure  Follow the sequence below to configure a DMAMUX x channel and the related DMA channel y: 1.   Set and configure completely the DMA channel y, except enabling the channel y. 2.   Set and configure completely the related DMAMUX y channel. 3.   Last, activate the DMA channel y by setting the EN bit in the DMA y channel register.  12.4.4   DMAMUX request line multiplexer  The DMAMUX request multiplexer with its multiple channels ensures the actual routing of DMA request/acknowledge control signals, named DMA request lines. Each DMA request line is connected in parallel to all the channels of the DMAMUX request line multiplexer. A DMA request is sourced either from the peripherals, or from the DMAMUX request generator. The DMAMUX request line multiplexer channel x selects the DMA request line number as configured by the DMAREQ_ID field in the DMAMUX_CxCR register.  Note:   The null value in the field DMAREQ_ID corresponds to no DMA request line selected.  Table 52. DMAMUX signals Signal name   Description  dmamux_hclk   DMAMUX AHB clock dmamux_req_inx   DMAMUX DMA request line inputs from peripherals dmamux_trgx   DMAMUX DMA request triggers inputs (to request generator sub-block) dmamux_req_genx   DMAMUX request generator sub-block channels outputs dmamux_reqx   DMAMUX request multiplexer sub-block inputs (from peripheral requests and request generator channels) dmamux_syncx   DMAMUX synchronization inputs (to request multiplexer sub-block) dmamux_req_outx   DMAMUX requests outputs (to DMA controller) dmamux_evtx   DMAMUX events outputs

DMA request multiplexer (DMAMUX)   RM0490  248/1027   RM0490 Rev 5  Caution:   A same non-null DMAREQ_ID cannot be programmed to different x and y DMAMUX request multiplexer channels (via DMAMUX_CxCR and DMAMUX_CyCR), except when the application guarantees that the two connected DMA channels are not simultaneously active. On top of the DMA request selection, the synchronization mode and/or the event generation may be configured and enabled, if required.  Synchronization mode and channel event generation  Each DMAMUX request line multiplexer channel x can be individually synchronized by setting the synchronization enable (SE) bit in the DMAMUX_CxCR register. DMAMUX has multiple synchronization inputs. The synchronization inputs are connected in parallel to all the channels of the request multiplexer. The synchronization input is selected via the SYNC_ID field in the DMAMUX_CxCR register of a given channel x. When a channel is in this synchronization mode, the selected input DMA request line is propagated to the multiplexer channel output, once a programmable rising/falling edge is detected on the selected input synchronization signal, via the SPOL[1:0] field of the DMAMUX_CxCR register. Additionally, internally to the DMAMUX request multiplexer, there is a programmable DMA request counter, which can be used for the channel request output generation, and for an event generation. An event generation on the channel x output is enabled through the EGE bit (event generation enable) of the DMAMUX_CxCR register. As shown in   Figure 24 , upon the detected edge of the synchronization input, the pending selected input DMA request line is connected to the DMAMUX multiplexer channel x output.  Note:   If a synchronization event occurs while there is no pending selected input DMA request line, it is discarded. The following asserted input request lines is not connected to the DMAMUX multiplexer channel output until a synchronization event occurs again.  From this point on, each time the connected DMAMUX request is served by the DMA controller (a served request is deasserted), the DMAMUX request counter is decremented. At its underrun, the DMA request counter is automatically loaded with the value in the NBREQ field of the DMAMUX_CxCR register and the input DMA request line is disconnected from the multiplexer channel x output. Thus, the number of DMA requests transferred to the multiplexer channel x output following a detected synchronization event, is equal to the value in the NBREQ field, plus one.  Note:   The NBREQ field value can be written by software only when both synchronization enable bit (SE) and event generation enable bit (EGE) of the corresponding multiplexer channel x are disabled.

RM0490 Rev 5   249/1027  RM0490   DMA request multiplexer (DMAMUX)  256  Figure 23. Synchronization mode of the DMAMUX request line multiplexer channel Figure 24. Event generation of the DMA request line multiplexer channel  If EGE is enabled, the multiplexer channel generates a channel event, as a pulse of one AHB clock cycle, when its DMA request counter is automatically reloaded with the value of the programmed NBREQ field, as shown in   Figure 23   and   Figure 24 .  MSv41974V1 Selected DMA request line transferred to the output DMA request counter dmamux_evtx dmamux_req_outx dmamux_syncx Selected dmamux_reqx Synchronization event Input DMA request line connected to output 3   2   1   0 4   4 DMA request counter underrun DMA request counter auto-reload to NBREQ Input DMA request line disconnected from output Example: DMAMUX_CCRx configured with: NBREQ=4, SE=1, EGE=1, SPOL=01 (rising edge) Not pending DMA request pending DMA requests served  MSv41975V1 DMA request counter dmamux_evtx 2 3 DMA request counter reaches zero Event is generated on the output DMA request counter auto-reloads with NBREQ value Example with: DMAMUX_CCRx configured with: NBREQ=3, SE=0, EGE=1 1   0   3   2   1   0   3   2   1   0 SE EGE Selected DMA request line transferred to the output Selected dmamux_reqx dmamux_req_outx Not pending DMA request pending

DMA request multiplexer (DMAMUX)   RM0490  250/1027   RM0490 Rev 5  Note:   If EGE is enabled and NBREQ = 0, an event is generated after each served DMA request. Note:   A synchronization event (edge) is detected if the state following the edge remains stable for more than two AHB clock cycles. Upon writing into DMAMUX_CxCR register, the synchronization events are masked during three AHB clock cycles.  Synchronization overrun and interrupt  If a new synchronization event occurs before the request counter underrun (the internal request counter programmed via the NBREQ field of the DMAMUX_CxCR register), the synchronization overrun flag bit SOFx is set in the DMAMUX_CSR register.  Note:   The request multiplexer channel x synchronization must be disabled (DMAMUX_CxCR.SE = 0) when the use of the related channel of the DMA controller is completed. Else, upon a new detected synchronization event, there is a synchronization overrun due to the absence of a DMA acknowledge (that is, no served request) received from the DMA controller.  The overrun flag SOFx is reset by setting the associated clear synchronization overrun flag bit CSOFx in the DMAMUX_CFR register. Setting the synchronization overrun flag generates an interrupt if the synchronization overrun interrupt enable bit SOIE is set in the DMAMUX_CxCR register.  12.4.5   DMAMUX request generator  The DMAMUX request generator produces DMA requests following trigger events on its DMA request trigger inputs. The DMAMUX request generator has multiple channels. DMA request trigger inputs are connected in parallel to all channels. The outputs of DMAMUX request generator channels are inputs to the DMAMUX request line multiplexer. Each DMAMUX request generator channel x has an enable bit GE (generator enable) in the corresponding DMAMUX_RGxCR register. The DMA request trigger input for the DMAMUX request generator channel x is selected through the SIG_ID (trigger signal ID) field in the corresponding DMAMUX_RGxCR register. Trigger events on a DMA request trigger input can be rising edge, falling edge or either edge. The active edge is selected through the GPOL (generator polarity) field in the corresponding DMAMUX_RGxCR register. Upon the trigger event, the corresponding generator channel starts generating DMA requests on its output. Each time the DMAMUX generated request is served by the connected DMA controller (a served request is deasserted), a built-in (inside the DMAMUX request generator) DMA request counter is decremented. At its underrun, the request generator channel stops generating DMA requests and the DMA request counter is automatically reloaded to its programmed value upon the next trigger event. Thus, the number of DMA requests generated after the trigger event is GNBREQ + 1.

RM0490 Rev 5   251/1027  RM0490   DMA request multiplexer (DMAMUX)  256  Note:   The GNBREQ field value can be written by software only when the enable GE bit of the corresponding generator channel x is disabled. There is no hardware write protection. A trigger event (edge) is detected if the state following the edge remains stable for more than two AHB clock cycles. Upon writing into DMAMUX_RGxCR register, the trigger events are masked during three AHB clock cycles.  Trigger overrun and interrupt  If a new DMA request trigger event occurs before the DMAMUX request generator counter underrun (the internal counter programmed via the GNBREQ field of the DMAMUX_RGxCR register), and if the request generator channel x was enabled via GE, then the request trigger event overrun flag bit OFx is asserted by the hardware in the DMAMUX_RGSR register.  Note:   The request generator channel x must be disabled (DMAMUX_RGxCR.GE = 0) when the usage of the related channel of the DMA controller is completed. Else, upon a new detected trigger event, there is a trigger overrun due to the absence of an acknowledge (that is, no served request) received from the DMA.  The overrun flag OFx is reset by setting the associated clear overrun flag bit COFx in the DMAMUX_RGCFR register. Setting the DMAMUX request trigger overrun flag generates an interrupt if the DMA request trigger event overrun interrupt enable bit OIE is set in the DMAMUX_RGxCR register.  12.5   DMAMUX interrupts  An interrupt can be generated upon:  •   a synchronization event overrun in each DMA request line multiplexer channel  •   a trigger event overrun in each DMA request generator channel For each case, per-channel in.dividual interrupt enable, status, and clear flag register bits are available.  Table 53. DMAMUX interrupts Interrupt signal   Interrupt event   Event flag   Clear bit   Enable bit  dmamuxovr_it Synchronization event overrun on channel x of the DMAMUX request line multiplexer SOFx   CSOFx   SOIE Trigger event overrun on channel x of the DMAMUX request generator OFx   COFx   OIE

DMA request multiplexer (DMAMUX)   RM0490  252/1027   RM0490 Rev 5  12.6   DMAMUX registers  Refer to the table containing register boundary addresses for the DMAMUX base address. DMAMUX registers may be accessed per byte (8-bit), half-word (16-bit), or word (32-bit). The address must be aligned with the data size.  12.6.1   DMAMUX request line multiplexer channel x configuration register (DMAMUX_CxCR)  Address offset: 0x000 + 0x04 * x (x = 0 to 4) Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   SYNC_ID[4:0]   NBREQ[4:0]   SPOL[1:0]   SE rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   EGE   SOIE   Res.   Res.   DMAREQ_ID[5:0] rw   rw   rw   rw   rw   rw   rw   rw Bits 31:29   Reserved, must be kept at reset value. Bits 28:24   SYNC_ID[4:0] : Synchronization identification Selects the synchronization input (see   Table 51: DMAMUX: assignment of synchronization inputs to resources ). Bits 23:19   NBREQ[4:0] : Number of DMA requests minus 1 to forward Defines the number of DMA requests to forward to the DMA controller after a synchronization event, and/or the number of DMA requests before an output event is generated. This field must only be written when both SE and EGE bits are low. Bits 18:17   SPOL[1:0] : Synchronization polarity Defines the edge polarity of the selected synchronization input: 00: No event (no synchronization, no detection). 01: Rising edge 10: Falling edge 11: Rising and falling edges Bit 16   SE : Synchronization enable 0: Synchronization disabled 1: Synchronization enabled Bits 15:10   Reserved, must be kept at reset value. Bit 9   EGE : Event generation enable 0: Event generation disabled 1: Event generation enabled Bit 8   SOIE : Synchronization overrun interrupt enable 0: Interrupt disabled 1: Interrupt enabled

RM0490 Rev 5   253/1027  RM0490   DMA request multiplexer (DMAMUX)  256  12.6.2   DMAMUX request line multiplexer interrupt channel status register (DMAMUX_CSR)  Address offset: 0x080 Reset value: 0x0000 0000  12.6.3   DMAMUX request line multiplexer interrupt clear flag register (DMAMUX_CFR)  Address offset: 0x084 Reset value: 0x0000 0000 Bits 7:6   Reserved, must be kept at reset value. Bits 5:0   DMAREQ_ID[5:0] : DMA request identification Selects the input DMA request. See the DMAMUX table about assignments of multiplexer inputs to resources. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   SOF4   SOF3   SOF2   SOF1   SOF0 r   r   r   r   r Bits 31:5   Reserved, must be kept at reset value. Bits 4:0   SOF[4:0] : Synchronization overrun event flag The flag is set when a synchronization event occurs on a DMA request line multiplexer channel x, while the DMA request counter value is lower than NBREQ. The flag is cleared by writing 1 to the corresponding CSOFx bit in DMAMUX_CFR register. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CSOF 4 CSOF 3 CSOF 2 CSOF 1 CSOF 0 w   w   w   w   w Bits 31:5   Reserved, must be kept at reset value. Bits 4:0   CSOF[4:0] : Clear synchronization overrun event flag Writing 1 in each bit clears the corresponding overrun flag SOFx in the DMAMUX_CSR register.

DMA request multiplexer (DMAMUX)   RM0490  254/1027   RM0490 Rev 5  12.6.4   DMAMUX request generator channel x configuration register (DMAMUX_RGxCR)  Address offset: 0x100 + 0x04 * x (x = 0 to 3) Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   GNBREQ[4:0]   GPOL[1:0]   GE rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   OIE   Res.   Res.   Res.   SIG_ID[4:0] rw   rw   rw   rw   rw   rw Bits 31:24   Reserved, must be kept at reset value. Bits 23:19   GNBREQ[4:0] : Number of DMA requests to be generated (minus 1) Defines the number of DMA requests to be generated after a trigger event. The actual number of generated DMA requests is GNBREQ +1.  Note:   This field must be written only when GE bit is disabled.  Bits 18:17   GPOL[1:0] : DMA request generator trigger polarity Defines the edge polarity of the selected trigger input 00: No event, i.e. no trigger detection nor generation. 01: Rising edge 10: Falling edge 11: Rising and falling edges Bit 16   GE : DMA request generator channel x enable 0: DMA request generator channel x disabled 1: DMA request generator channel x enabled Bits 15:9   Reserved, must be kept at reset value. Bit 8   OIE : Trigger overrun interrupt enable 0: Interrupt on a trigger overrun event occurrence is disabled 1: Interrupt on a trigger overrun event occurrence is enabled Bits 7:5   Reserved, must be kept at reset value. Bits 4:0   SIG_ID[4:0] : Signal identification Selects the DMA request trigger input used for the channel x of the DMA request generator

RM0490 Rev 5   255/1027  RM0490   DMA request multiplexer (DMAMUX)  256  12.6.5   DMAMUX request generator interrupt status register (DMAMUX_RGSR)  Address offset: 0x140 Reset value: 0x0000 0000  12.6.6   DMAMUX request generator interrupt clear flag register (DMAMUX_RGCFR)  Address offset: 0x144 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   OF3   OF2   OF1   OF0 r   r   r   r Bits 31:4   Reserved, must be kept at reset value. Bits 3:0   OF[3:0] : Trigger overrun event flag The flag is set when a new trigger event occurs on DMA request generator channel x, before the request counter underrun (the internal request counter programmed via the GNBREQ field of the DMAMUX_RGxCR register). The flag is cleared by writing 1 to the corresponding COFx bit in the DMAMUX_RGCFR register. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   COF3   COF2   COF1   COF0 w   w   w   w Bits 31:4   Reserved, must be kept at reset value. Bits 3:0   COF[3:0] : Clear trigger overrun event flag Writing 1 in each bit clears the corresponding overrun flag OFx in the DMAMUX_RGSR register.

DMA request multiplexer (DMAMUX)   RM0490  256/1027   RM0490 Rev 5  12.6.7   DMAMUX register map  The following table summarizes the DMAMUX registers and reset values. Refer to the register boundary address table for the DMAMUX register base address. Refer to   Section 2.2 on page 45   for the register boundary addresses.  Table 54. DMAMUX register map and reset values Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x000   DMAMUX_C0CR Res. Res. Res. SYNC_ID[4:0]   NBREQ[4:0]   SPOL [1:0] SE Res. Res. Res. Res. Res. Res. EGE SOIE Res. Res. DMAREQ_ID[5:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x004   DMAMUX_C1CR Res. Res. Res. SYNC_ID[4:0]   NBREQ[4:0]   SPOL [1:0] SE Res. Res. Res. Res. Res. Res. EGE SOIE Res. Res. DMAREQ_ID[5:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x008   DMAMUX_C2CR Res. Res. Res. SYNC_ID[4:0]   NBREQ[4:0]   SPOL [1:0] SE Res. Res. Res. Res. Res. Res. EGE SOIE Res. Res. DMAREQ_ID[5:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x00C   DMAMUX_C3CR Res. Res. Res. SYNC_ID[4:0]   NBREQ[4:0]   SPOL [1:0] SE Res. Res. Res. Res. Res. Res. EGE SOIE Res. Res. DMAREQ_ID[5:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x010   DMAMUX_C4CR Res. Res. Res. SYNC_ID[4:0]   NBREQ[4:0]   SPOL [1:0] SE Res. Res. Res. Res. Res. Res. EGE SOIE Res. Res. DMAREQ_ID[5:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x014 - 0x07C   Reserved Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. 0x080   DMAMUX_CSR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. SOF4 SOF3 SOF2 SOF1 SOF0 Reset value   0   0   0   0   0 0x084   DMAMUX_CFR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CSOF4 CSOF3 CSOF2 CSOF1 CSOF0 Reset value   0   0   0   0   0 0x088 - 0x0FC   Reserved Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. 0x100   DMAMUX_RG0CR Res. Res. Res. Res. Res. Res. Res. Res. GNBREQ[4:0]   GPOL [1:0] GE Res. Res. Res. Res. Res. Res. Res. OIE Res. Res. Res. SIG_ID[4:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x104   DMAMUX_RG1CR Res. Res. Res. Res. Res. Res. Res. Res. GNBREQ[4:0]   GPOL [1:0] GE Res. Res. Res. Res. Res. Res. Res. OIE Res. Res. Res. SIG_ID[4:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x108   DMAMUX_RG2CR Res. Res. Res. Res. Res. Res. Res. Res. GNBREQ[4:0]   GPOL [1:0] GE Res. Res. Res. Res. Res. Res. Res. OIE Res. Res. Res. SIG_ID[4:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x10C   DMAMUX_RG3CR Res. Res. Res. Res. Res. Res. Res. Res. GNBREQ[4:0]   GPOL [1:0] GE Res. Res. Res. Res. Res. Res. Res. OIE Res. Res. Res. SIG_ID[4:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x110 - 0x13C   Reserved Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. 0x140   DMAMUX_RGSR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. OF3 OF2 OF1 OF0 Reset value   0   0   0   0 0x144   DMAMUX_RGCFR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. COF3 COF2 COF1 COF0 Reset value   0   0   0   0 0x148 - 0x3FC   Reserved Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res.

RM0490 Rev 5   257/1027  RM0490   Nested vectored interrupt controller (NVIC)  259  13   Nested vectored interrupt controller (NVIC) 13.1   Main features  •   32 maskable interrupt channels (not including the sixteen Cortex ® -M0+ interrupt lines)  •   4 programmable priority levels (2 bits of interrupt priority are used)  •   Low-latency exception and interrupt handling  •   Power management control  •   Implementation of system control registers The NVIC and the processor core interface are closely coupled, which enables low-latency interrupt processing and efficient processing of late arriving interrupts. All interrupts including the core exceptions are managed by the NVIC. For more information on exceptions and NVIC programming, refer to the programming manual PM0223.  13.2   SysTick calibration value register  The SysTick calibration value is set to 1000. SysTick reload value register may be adapted to the actual HCLK frequency and required time period, see PM0223 for more details.  13.3   Interrupt and exception vectors  Table 55   is the vector table. Information pertaining to a peripheral only applies to devices containing that peripheral.  Table 55. Vector table   (1) Position   Priority   Type of priority   Acronym   Description   Address  -   -   -   -   Reserved   0x0000_0000 -   -3   fixed   Reset   Reset   0x0000_0004 -   -2   fixed   NMI_Handler Non maskable interrupt. SRAM parity error, HSE CSS and LSE CSS are linked to the NMI vector. 0x0000_0008 -   -1   fixed   HardFault_Handler   All class of fault   0x0000_000C -   -   -   -   Reserved 0x0000_0010 0x0000_0014 0x0000_0018 0x0000_001C 0x0000_0020 0x0000_0024 0x0000_0028 -   3   settable   SVCall_Handler   System service call via SWI instruction   0x0000_002C

Nested vectored interrupt controller (NVIC)   RM0490  258/1027   RM0490 Rev 5  -   -   -   -   Reserved   0x0000_0030 0x0000_0034 -   5   settable   PendSV_Handler   Pendable request for system service   0x0000_0038 -   6   settable   SysTick_Handler   System tick timer   0x0000_003C 0   7   settable   WWDG   Window watchdog interrupt   0x0000_0040 1   8   settable   PVM   VDDIO2 monitor interrupt (EXTI line 34)   0x0000_0044 2   9   settable   RTC   RTC interrupts (EXTI line 19)   0x0000_0048 3   10   settable   FLASH   Flash global interrupt   0x0000_004C 4   11   settable   RCC/CRS   RCC/CRS global interrupt   0x0000_0050 5   12   settable   EXTI0_1   EXTI line 0 & 1 interrupt   0x0000_0054 6   13   settable   EXTI2_3   EXTI line 2 & 3 interrupt   0x0000_0058 7   14   settable   EXTI4_15   EXTI line 4 to 15 interrupt   0x0000_005C 8   15   settable   USB   USB global interrupt (combined with EXTI line 36)   0x0000_0060 9   16   settable   DMA1_Channel1   DMA1 channel 1 interrupt   0x0000_0064 10   17   settable   DMA1_Channel2_3   DMA1 channel 2 & 3 interrupts   0x0000_0068 11   18   settable DMAMUX/ DMA1_Channel4_5_6 _7 DMAMUX and DMA1 channel 4, 5, 6, and 7 interrupts   0x0000_006C 12   19   settable   ADC   ADC interrupt   0x0000_0070 13   20   settable   TIM1_BRK_UP_TRG _COM TIM1 break, update, trigger and commutation interrupts   0x0000_0074 14   21   settable   TIM1_CC   TIM1 Capture Compare interrupt   0x0000_0078 15   22   settable   TIM2   TIM2 global interrupt   0x0000_007C 16   23   settable   TIM3   TIM3 global interrupt   0x0000_0080 17   -   -   -   Reserved   0x0000_0084 18   -   -   -   Reserved   0x0000_0088 19   26   settable   TIM14   TIM14 global interrupt   0x0000_008C 20   27   settable   TIM15   TIM15 global interrupt   0x0000_0090 21   28   settable   TIM16   TIM16 global interrupt   0x0000_0094 22   29   settable   TIM17   TIM17 global interrupt   0x0000_0098 23   30   settable   I2C1   I2C1 global interrupt (combined with EXTI line 23)   0x0000_009C 24   31   settable   I2C2   I2C2 global interrupt   0x0000_00A0 25   32   settable   SPI1   SPI1 global interrupt   0x0000_00A4  Table 55. Vector table   (1)   (continued) Position   Priority   Type of priority   Acronym   Description   Address

RM0490 Rev 5   259/1027  RM0490   Nested vectored interrupt controller (NVIC)  259  26   33   settable   SPI2   SPI2 global interrupt   0x0000_00A8 27   34   settable   USART1   USART1 global interrupt (combined with EXTI line 25)   0x0000_00AC 28   35   settable   USART2   USART2 global interrupt   0x0000_00B0 29   36   settable   USART3/USART4   USART3/4 global interrupt (combined with EXTI 28)   0x0000_00B4 30   37   settable   FDCAN_IT0   FDCAN global interrupt 0   0x0000_00B8 31   38   settable   FDCAN_IT1   FDCAN global interrupt 1   0x0000_00BC 1.   The grayed cells correspond to the Cortex   ® -M0+ interrupts.  Table 55. Vector table   (1)   (continued) Position   Priority   Type of priority   Acronym   Description   Address

Extended interrupt and event controller (EXTI)   RM0490  260/1027   RM0490 Rev 5  14   Extended interrupt and event controller (EXTI)  The Extended interrupt and event controller (EXTI) manages the CPU and system wake-up through configurable and direct event inputs (lines). It provides wake-up requests to the power control, and generates an interrupt request to the CPU NVIC and events to the CPU event input. For the CPU an additional event generation block (EVG) is needed to generate the CPU event signal. The EXTI wake-up requests allow the system to be woken up from Stop modes. The interrupt request and event request generation can also be used in Run mode. The EXTI also includes the EXTI I/O port multiplexer.  14.1   EXTI main features  The EXTI main features are the following:  •   System wake-up upon event on any input  •   Wake-up flag and CPU interrupt generation for events not having a wake-up flag in their source peripheral  •   Configurable events (from I/Os, peripherals not having an associated interrupt pending status bit, or peripherals generating a pulse) –   Selectable active trigger edge –   Independent rising and falling edge interrupt pending status bits –   Individual interrupt and event generation mask, used for conditioning the CPU wake-up, interrupt and event generation –   SW trigger possibility  •   Direct events (from peripherals having an associated flag and interrupt pending status bit) –   Fixed rising edge active trigger –   No interrupt pending status bit in the EXTI –   Individual interrupt and event generation mask for conditioning the CPU wake-up and event generation –   No SW trigger possibility  •   I/O port selector  14.2   EXTI block diagram  The EXTI consists of a register block accessed via an AHB interface, the event input trigger block, the masking block, and EXTI multiplexer as shown in   Figure 25 . The register block contains all the EXTI registers. The event input trigger block provides an event input edge trigger logic. The masking block provides the event input distribution to the different wake-up, interrupt and event outputs, and the masking of these. The EXTI multiplexer provides the I/O port selection on to the EXTI event signal.

RM0490 Rev 5   261/1027  RM0490   Extended interrupt and event controller (EXTI)  277  Figure 25. EXTI block diagram  EVG Pulse EXTI Event Trigger Direct event(x) or configurable event(y) it_exti_per(y)* c_event Masking events Registers AHB interface PWR CPU rxev Peripherals sys_wakeup Wakeup Interrupt   Direct event(x) c_evt_exti c_evt_rst hclk c_fclk c_wakeup GPIO Configurable event(15:0) EXTImux IOPort exti[15:0]   To interconnect * it_exti_per(y) are only available for configurable events (y) MS44733V2  Table 56. EXTI signal overview Signal name   I/O   Description  AHB interface   I/O   EXTI register bus interface. When one event is configured to allow security, the AHB interface support secure accesses hclk   I   AHB bus clock and EXTI system clock Configurable event(y)   I   Asynchronous wake-up events from peripherals that do not have an associated interrupt and flag in the peripheral Direct event(x)   I   Synchronous and asynchronous wake-up events from peripherals having an associated interrupt and flag in the peripheral IOPort(n)   I   GPIO ports[15:0] exti[15:0]   O   EXTI output port to trigger other IPs it_exti_per (y)   O   Interrupts to the CPU associated with configurable event (y) c_evt_exti   O   High-level sensitive event output for CPU synchronous to hclk c_evt_rst   I   Asynchronous reset input to clear c_evt_exti sys_wakeup   O   Asynchronous system wake-up request to PWR for ck_sys and hclk c_wakeup   O   Wake-up request to PWR for CPU, synchronous to hclk  Table 57. EVG pin overview Pin name   I/O   Description  c_fclk   I   CPU free-running clock c_evt_in   I   High-level sensitive event input from EXTI, asynchronous to CPU clock c_event   O   Event pulse, synchronous to CPU clock c_evt_rst   O   Event reset signal, synchronous to CPU clock

Extended interrupt and event controller (EXTI)   RM0490  262/1027   RM0490 Rev 5  14.2.1   EXTI connections between peripherals and CPU  The peripherals able to generate wake-up or interrupt events when the system is in Stop mode are connected to the EXTI.  •   Peripheral wake-up signals that generate a pulse or that do not have an interrupt status bits in the peripheral, are connect to an EXTI configurable line. For these events the EXTI provides a status pending bit which requires to be cleared. It is the EXTI interrupt associated with the status bit that interrupts the CPU.  •   Peripheral interrupt and wake-up signals that have a status bit in the peripheral which requires to be cleared in the peripheral, are connected to an EXTI direct line. There is no status pending bit within the EXTI. The interrupt or wake-up is cleared by the CPU in the peripheral. It is the peripheral interrupt that interrupts the CPU directly.  •   All GPIO ports input to the EXTI multiplexer, allowing to select a port to wake up the system via a configurable event. The EXTI configurable event interrupts are connected to the NVIC(a) of the CPU. The dedicated EXTI/EVG CPU event is connected to the CPU rxev input. The EXTI CPU wake-up signals are connected to the PWR block, and are used to wake up the system and CPU sub-system bus clocks.  14.3   EXTI functional description  Depending on the EXTI line type and wake-up target(s), different logic implementations are used. The applicable features and control or status registers are:  •   rising and falling edge event enable through –   EXTI rising trigger selection register 1 (EXTI_RTSR1)  –   EXTI falling trigger selection register 1 (EXTI_FTSR1)  •   software trigger through   EXTI software interrupt event register 1 (EXTI_SWIER1)  •   pending interrupt flagging through –   EXTI rising edge pending register 1 (EXTI_RPR1)  –   EXTI falling edge pending register 1 (EXTI_FPR1)  –   EXTI external interrupt selection register (EXTI_EXTICRx)  •   CPU wake-up and interrupt enable through –   EXTI CPU wake-up with interrupt mask register 1 (EXTI_IMR1)  •   CPU wake-up and event enable through –   EXTI CPU wake-up with event mask register (EXTI_EMR1)  Table 58. EXTI event input configurations and register control Event input type   Logic implementation EXTI_RTSR1 EXTI_FTSR1 EXTI_SWIER1 EXTI_R/FPR1 EXTI_IMR1 EXTI_EMR1  Configurable   Configurable event input wake-up logic   x   x   x   x   x   x Direct   Direct event input wake-up logic   -   -   -   -   x   x

RM0490 Rev 5   263/1027  RM0490   Extended interrupt and event controller (EXTI)  277  14.3.1   EXTI configurable event input wake-up  Figure 26   is a detailed representation of the logic associated with configurable event inputs which wake up the CPU sub-system bus clocks and generated an EXTI pending flag and interrupt to the CPU and or a CPU wake-up event.  Figure 26. Configurable event trigger logic CPU wake-up  The software interrupt event register allows triggering configurable events by software, writing the corresponding register bit, irrespective of the edge selection setting. The rising edge and falling edge selection registers allow to enable and select the configurable event active trigger edge or both edges. The CPU has its dedicated interrupt mask register and a dedicated event mask registers. The enabled event allows generating an event on the CPU. All events for a CPU are OR-ed together into a single CPU event signal. The event pending registers (EXTI_RPR1 and EXTI_FPR1) is not set for an unmasked CPU event. The configurable events have unique interrupt pending request registers, shared by the CPU. The pending register is only set for an unmasked interrupt. Each configurable event provides a common interrupt to the CPU. The configurable event interrupts need to be acknowledged by software in the EXTI_RPR1 and/or EXTI_FPR1 registers. When a CPU interrupt or CPU event is enabled, the asynchronous edge detection circuit is reset by the clocked delay and rising edge detect pulse generator. This guarantees the wake-up of the EXTI hclk clock before the asynchronous edge detection circuit is reset.  Note:   A detected configurable event interrupt pending request can be cleared by the CPU. The system cannot enter low-power modes as long as an interrupt pending request is active.  14.3.2   EXTI direct event input wake-up  Figure 27   is a detailed representation of the logic associated with direct event inputs waking up the system. The direct events do not have an associated EXTI interrupt. The EXTI only wakes up the system and CPU sub-system clocks and may generate a CPU wake-up event. The peripheral synchronous interrupt, associated with the direct wake-up event wakes up the CPU.  EVG EXTI Peripheral interface Falling trigger selection register Rising trigger selection register Pending request register Asynchronous Edge detection circuit Configurable Event input(y) it_exti_per(y) CPU Event(y) (1) c_wakeup Rising Edge detect Pulse generator rst Delay hclk hclk CPU Interrupt mask register CPU Event mask register Other CPU Wakeups sys_wakeup Other Wakeups Wakeup(y) Other CPU Events(x,y) c_event CPU Wakeup(y) Synch hclk Software interrupt event register AHB interface CPU Rising Edge detect Pulse generator ck_fclk_c Rising Edge detect hclk rst   c_evt_exti c_evt_rst Same circuit for Configurable and Direct events MS46537V1

Extended interrupt and event controller (EXTI)   RM0490  264/1027   RM0490 Rev 5  The EXTI direct event is able to generate a CPU event. This CPU event wakes up the CPU. The CPU event may occur before the interrupt flag of the associated peripheral is set.  Figure 27. Direct event trigger logic CPU wake-up 14.3.3   EXTI multiplexer  The EXTI multiplexer allows selecting GPIOs as interrupts and wake-up. The GPIOs are connected via 16 EXTI multiplexer lines to the first 16 EXTI events as configurable event. The selection of GPIO port as EXTI multiplexer output is controlled through the   EXTI external interrupt selection register (EXTI_EXTICRx)   register.  Figure 28. EXTI GPIO multiplexer  The EXTIs multiplexer outputs are available as output signals from the EXTI, to trigger other functional blocks. The EXTI multiplexer outputs are available independently of mask setting through the EXTI_IMR and EXTI_EMR registers. The EXTI lines (event inputs) are connected as shown in the following table.  EVG EXTI Direct Event input(x)   Asynchronous Rising Edge detect circuit Falling Edge detect Pulse generator rst Delay hclk CPU Rising Edge detect Pulse generator hclk ck_fclk_c Peripheral interface CPU Event mask register c_event c_wakeup sys_wakeup Other CPU Wakeups Other Wakeups CPU Event(x) (1) CPU Wakeup(x) Wakeup(x) Synch hclk AHB interface CPU Interrupt mask register c_evt_exti hclk Other CPU Events(x,y) hclk rst c_evt_rst Same circuit for Configurable and Direct events MS46536V1 Rising Edge detect  MS44726V1 PA0 PB0 PC0 Px0   ………....   EXTI0 _ PA1 PB1 PC1 Px1   ………....   EXTI1 _ PA15 PB15 PC15 Px15   ………....   EXTI15 _ ………....

RM0490 Rev 5   265/1027  RM0490   Extended interrupt and event controller (EXTI)  277  14.4   EXTI functional behavior  The direct event inputs are enabled in the respective peripheral generating the wake-up event. The configurable events are enabled by enabling at least one of the trigger edges. Once an event input is enabled, the generation of a CPU wake-up is conditioned by the CPU interrupt mask and CPU event mask.  Table 59. EXTI line connections EXTI line   Line source   Line type  0-15   GPIO   Configurable 16   Reserved   - 17   Reserved   - 18   Reserved   - 19   RTC   Direct 20   Reserved   - 21   Reserved   - 22   Reserved   - 23   I2C1 wake-up   Direct 24   Reserved   - 25   USART1 wake-up   Direct 26   Reserved   - 27   Reserved   - 28   Reserved   - 29   Reserved   - 30   Reserved   - 31   LSE_CSS   Direct 32   Reserved   - 33   Reserved   - 34   VDDIO2 monitoring   Configurable 35   Reserved   - 36   USB wake-up   Direct  Table 60. Masking functionality CPU interrupt enable EXTI_IMR.IMn CPU event enable EXTI_EMR.EMn Configurable event inputs EXTI_RPR.RPIFn EXTI_FPR.FPIFn exti(n) interrupt   (1) CPU event   CPU wake-up  0   0   No   Masked   Masked   Masked 1   No   Masked   Yes   Yes

Extended interrupt and event controller (EXTI)   RM0490  266/1027   RM0490 Rev 5  For configurable event inputs, upon an edge on the event input, an event request is generated if that edge (rising or/and falling) is enabled. When the associated CPU interrupt is unmasked, the corresponding RPIFn and/or FPIFn bit is/are set in the EXTI_RPR or/and EXTI_FPR register, waking up the CPU subsystem and activating CPU interrupt signal. The RPIFn and/or FPIFn pending bit is cleared by writing 1 to it, which clears the CPU interrupt request. For direct event inputs, when enabled in the associated peripheral, an event request is generated on the rising edge only. There is no corresponding CPU pending bit in the EXTI. When the associated CPU interrupt is unmasked, the corresponding CPU subsystem is woken up. The CPU is woken up (interrupted) by the peripheral synchronous interrupt. The CPU event must be unmasked to generate an event. Upon an enabled edge occurring on an event input, a CPU event pulse is generated. There is no event pending bit. For the configurable event inputs, the software can generate an event request by setting the corresponding bit of the software interrupt/event register EXTI_SWIER1, which has the effect of a rising edge on the event input. The pending rising edge event flag is set in the EXTI_RPR1 register, irrespective of the EXTI_RTSR1 register setting.  14.5   EXTI registers  The EXTI register map is divided in the following sections: All the registers can be accessed with word (32-bit), half-word (16-bit) and byte (8-bit) access.  14.5.1   EXTI rising trigger selection register 1 (EXTI_RTSR1)  Address offset: 0x000 Reset value: 0x0000 0000 1   0   Status latched   Yes   Masked   Yes (2) 1   Status latched   Yes   Yes   Yes 1.   The single exti(n) interrupt goes to the CPU. If no interrupt is required for CPU, the exti(n) interrupt must be masked in the CPU NVIC. 2.   Only if CPU interrupt is enabled in EXTI_IMR.IMn.  Table 60. Masking functionality (continued) CPU interrupt enable EXTI_IMR.IMn CPU event enable EXTI_EMR.EMn Configurable event inputs EXTI_RPR.RPIFn EXTI_FPR.FPIFn exti(n) interrupt   (1) CPU event   CPU wake-up Table 61. EXTI register map sections Address   Description  0x000 - 0x01C   General configurable event [31:0] configuration 0x060 - 0x06C   EXTI I/O port multiplexer 0x080 - 0x0BC   CPU input event configuration

RM0490 Rev 5   267/1027  RM0490   Extended interrupt and event controller (EXTI)  277  Contains only register bits for configurable events.  14.5.2   EXTI falling trigger selection register 1 (EXTI_FTSR1)  Address offset: 0x004 Reset value: 0x0000 0000 Contains only register bits for configurable events.  14.5.3   EXTI software interrupt event register 1 (EXTI_SWIER1)  Address offset: 0x008 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 RT15   RT14   RT13   RT12   RT11   RT10   RT9   RT8   RT7   RT6   RT5   RT4   RT3   RT2   RT1   RT0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   RTx:   Rising trigger event configuration bit of configurable line x (x = 15 to 0) Each bit enables/disables the rising edge trigger for the event and interrupt on the corresponding line. 0: Disable 1: Enable  Note:   The configurable lines are edge triggered; no glitch must be generated on these inputs. If a rising edge on the configurable line occurs during writing of the register, the associated pending bit is not set. Rising edge trigger can be set for a line with falling edge trigger enabled. In this case, both edges generate a trigger.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 FT15   FT14   FT13   FT12   FT11   FT10   FT9   FT8   FT7   FT6   FT5   FT4   FT3   FT2   FT1   FT0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   FTx:   Falling trigger event configuration bit of configurable line x (x = 15 to 0). Each bit enables/disables the falling edge trigger for the event and interrupt on the corresponding line. 0: Disable 1: Enable  Note:   The configurable lines are edge triggered; no glitch must be generated on these inputs. If a falling edge on the configurable line occurs during writing of the register, the associated pending bit is not set. Falling edge trigger can be set for a line with rising edge trigger enabled. In this case, both edges generate a trigger.

Extended interrupt and event controller (EXTI)   RM0490  268/1027   RM0490 Rev 5  Reset value: 0x0000 0000 Contains only register bits for configurable events.  14.5.4   EXTI rising edge pending register 1 (EXTI_RPR1)  Address offset: 0x00C Reset value: 0x0000 0000 Contains only register bits for configurable events.  14.5.5   EXTI falling edge pending register 1 (EXTI_FPR1)  Address offset: 0x010 Reset value: 0x0000 0000 Contains only register bits for configurable events. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 SWI 15 SWI 14 SWI 13 SWI 12 SWI 11 SWI 10   SWI9   SWI8   SWI7   SWI6   SWI5   SWI4   SWI3   SWI2   SWI1   SWI0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   SWIx:   Software rising edge event trigger on line x (x = 15 to 0) Setting of any bit by software triggers a rising edge event on the corresponding line x, resulting in an interrupt, independently of EXTI_RTSR1 and EXTI_FTSR1 settings. The bits are automatically cleared by HW. Reading of any bit always returns 0. 0: No effect 1: Rising edge event generated on the corresponding line, followed by an interrupt 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 RPIF15   RPIF14   RPIF13   RPIF12   RPIF11   RPIF10   RPIF9   RPIF8   RPIF7   RPIF6   RPIF5   RPIF4   RPIF3   RPIF2   RPIF1   RPIF0 rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1 Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   RPIFx:   Rising edge event pending for configurable line x (x = 15 to 0) Each bit is set upon a rising edge event generated by hardware or by software (through the EXTI_SWIER1 register) on the corresponding line. Each bit is cleared by writing 1 into it. 0: No rising edge trigger request occurred 1: Rising edge trigger request occurred

RM0490 Rev 5   269/1027  RM0490   Extended interrupt and event controller (EXTI)  277  14.5.6   EXTI rising trigger selection register 2 (EXTI_RTSR2)  This register is only available on STM32C071xx. On the other devices, it is reserved. Address offset: 0x020 Reset value: 0x0000 0000 Contains only register bits for configurable events.  14.5.7   EXTI falling trigger selection register 2 (EXTI_FTSR2)  This register is only available on STM32C071xx. On the other devices, it is reserved. Address offset: 0x024 Reset value: 0x0000 0000 Contains only register bits for configurable events. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 FPIF15   FPIF14   FPIF13   FPIF12   FPIF11   FPIF10   FPIF9   FPIF8   FPIF7   FPIF6   FPIF5   FPIF4   FPIF3   FPIF2   FPIF1   FPIF0 rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1 Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   FPIFx:   Falling edge event pending for configurable line x (x = 15 to 0) Each bit is set upon a falling edge event generated by hardware or by software (through the EXTI_SWIER1 register) on the corresponding line. Each bit is cleared by writing 1 into it. 0: No falling edge trigger request occurred 1: Falling edge trigger request occurred 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   RT34   Res.   Res. rw Bits 31:3   Reserved, must be kept at reset value. Bit 2   RT34:   Rising trigger event configuration bit of configurable line 34 Each bit enables/disables the rising edge trigger for the event and interrupt on the line 34. 0: Disable 1: Enable  Note:   This configurable line is edge triggered; no glitch must be generated on this inputs. If a rising edge on the configurable line occurs during writing of the register, the associated pending bit is not set. Rising edge trigger can be set for a line with falling edge trigger enabled. In this case, both edges generate a trigger.  Bits 1:0   Reserved, must be kept at reset value.

Extended interrupt and event controller (EXTI)   RM0490  270/1027   RM0490 Rev 5  14.5.8   EXTI software interrupt event register 2 (EXTI_SWIER2)  This register is only available on STM32C071xx. On the other devices, it is reserved. Address offset: 0x028 Reset value: 0x0000 0000 Contains only register bits for configurable events.  14.5.9   EXTI rising edge pending register 2 (EXTI_RPR2)  This register is only available on STM32C071xx. On the other devices, it is reserved. Address offset: 0x02C Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   FT34   Res.   Res. rw Bits 31:3   Reserved, must be kept at reset value. Bit 2   FT34:   Falling trigger event configuration bit of configurable line 34. Each bit enables/disables the falling edge trigger for the event and interrupt on the line 34. 0: Disable 1: Enable  Note:   The configurable lines are edge triggered; no glitch must be generated on these inputs. If a falling edge on the configurable line occurs during writing of the register, the associated pending bit is not set. Falling edge trigger can be set for a line with rising edge trigger enabled. In this case, both edges generate a trigger.  Bits 1:0   Reserved, must be kept at reset value. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   SWI34   Res.   Res. rw Bits 31:3   Reserved, must be kept at reset value. Bit 2   SWI34:   Software rising edge event trigger on line 34 Setting of any bit by software triggers a rising edge event on the line 34, resulting in an interrupt, independently of EXTI_RTSR2 and EXTI_FTSR2 settings. The bits are automatically cleared by HW. Reading of any bit always returns 0. 0: No effect 1: Rising edge event generated on the corresponding line, followed by an interrupt Bits 1:0   Reserved, must be kept at reset value.

RM0490 Rev 5   271/1027  RM0490   Extended interrupt and event controller (EXTI)  277  Contains only register bits for configurable events.  14.5.10   EXTI falling edge pending register 2 (EXTI_FPR2)  This register is only available on STM32C071xx. On the other devices, it is reserved. Address offset: 0x030 Reset value: 0x0000 0000 Contains only register bits for configurable events.  14.5.11   EXTI external interrupt selection register (EXTI_EXTICRx)  Address offset: 0x060 + 0x4 * (x - 1), (x = 1 to 4) Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   RPIF34   Res.   Res. rc_w1 Bits 31:3   Reserved, must be kept at reset value. Bit 2   RPIF34:   Rising edge event pending for configurable line 34 Each bit is set upon a rising edge event generated by hardware or by software (through the EXTI_SWIER2 register) on the line 34. Each bit is cleared by writing 1 into it. 0: No rising edge trigger request occurred 1: Rising edge trigger request occurred Bits 1:0   Reserved, must be kept at reset value. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   FPIF34   Res.   Res. rc_w1 Bits 31:3   Reserved, must be kept at reset value. Bit 2   FPIF34:   Falling edge event pending for configurable line 34 Each bit is set upon a falling edge event generated by hardware or by software (through the EXTI_SWIER2 register) on the line 34. Each bit is cleared by writing 1 into it. 0: No falling edge trigger request occurred 1: Falling edge trigger request occurred Bits 1:0   Reserved, must be kept at reset value.

Extended interrupt and event controller (EXTI)   RM0490  272/1027   RM0490 Rev 5  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 EXTI{4*(x-1)+3}[7:0]   EXTI{4*(x-1)+2}[7:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 EXTI{4*(x-1)+1}[7:0]   EXTI{4*(x-1)}[7:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:24   EXTI{4*(x-1)+3}[7:0]:   EXTI{4*(x-1)+3} GPIO port selection These bits are written by software to select the source input for EXTI{4*(x-1)+3} external interrupt. 0x00: PA[{4*(x-1)+3}] pin 0x01: PB[{4*(x-1)+3}] pin 0x02: PC[{4*(x-1)+3}] pin 0x03: PD[{4*(x-1)+3}] pin 0x04: reserved 0x05: PF[{4*(x-1)+3}] pin Other: reserved Bits 23:16   EXTI{4*(x-1)+2}[7:0]:   EXTI{4*(x-1)+2} GPIO port selection These bits are written by software to select the source input for EXTI{4*(x-1)+2} external interrupt. 0x00: PA[{4*(x-1)+2}] pin 0x01: PB[{4*(x-1)+2}] pin 0x02: PC[{4*(x-1)+2}] pin 0x03: PD[{4*(x-1)+2}] pin 0x04: reserved 0x05: PF[{4*(x-1)+2}] pin Other: reserved Bits 15:8   EXTI{4*(x-1)+1}[7:0]:   EXTI{4*(x-1)+1} GPIO port selection These bits are written by software to select the source input for EXTI{4*(x-1)+1} external interrupt. 0x00: PA[{4*(x-1)+1}] pin 0x01: PB[{4*(x-1)+1}] pin 0x02: PC[{4*(x-1)+1}] pin 0x03: PD[{4*(x-1)+1}] pin 0x04: reserved 0x05: PF[{4*(x-1)+1}] pin Other: reserved Bits 7:0   EXTI{4*(x-1)}[7:0]:   EXTI{4*(x-1)} GPIO port selection These bits are written by software to select the source input for EXTI{4*(x-1)} external interrupt. 0x00: PA[{4*(x-1)}] pin 0x01: PB[{4*(x-1)}] pin 0x02: PC[{4*(x-1)}] pin 0x03: PD[{4*(x-1)}] pin 0x04: reserved 0x05: PF[{4*(x-1)}] pin Other: reserved

RM0490 Rev 5   273/1027  RM0490   Extended interrupt and event controller (EXTI)  277  14.5.12   EXTI CPU wake-up with interrupt mask register 1 (EXTI_IMR1)  Address offset: 0x080 Reset value: 0xFFF8 0000 Contains register bits for configurable events and direct events. The reset value is set such as to, by default, enable interrupt from direct lines, and disable interrupt from configurable lines. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 IM31   Res.   Res.   Res.   Res.   Res.   IM25   Res.   IM23   Res.   Res.   Res.   IM19   Res.   Res.   Res. rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 IM15   IM14   IM13   IM12   IM11   IM10   IM9   IM8   IM7   IM6   IM5   IM4   IM3   IM2   IM1   IM0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 31   IM31:   CPU wake-up with interrupt mask on line 31 Setting/clearing this bit unmasks/masks the CPU wake-up with interrupt, by an event on the corresponding line. 0: wake-up with interrupt masked 1: wake-up with interrupt unmasked Bits 30:26   Reserved, must be kept at reset value. Bit 25   IM25:   CPU wake-up with interrupt mask on line 25 Setting/clearing each bit unmasks/masks the CPU wake-up with interrupt, by an event on the corresponding line. 0: wake-up with interrupt masked 1: wake-up with interrupt unmasked Bit 24   Reserved, must be kept at reset value. Bit 23   IM23:   CPU wake-up with interrupt mask on line 23 Setting/clearing each bit unmasks/masks the CPU wake-up with interrupt, by an event on the corresponding line. 0: wake-up with interrupt masked 1: wake-up with interrupt unmasked Bits 22:20   Reserved, must be kept at reset value. Bit 19   IM19:   CPU wake-up with interrupt mask on line 19 Setting/clearing this bit unmasks/masks the CPU wake-up with interrupt, by an event on the corresponding line. 0: wake-up with interrupt masked 1: wake-up with interrupt unmasked Bits 18:16   Reserved, must be kept at reset value. Bits 15:0   IMx:   CPU wake-up with interrupt mask on line x (x = 15 to 0) Setting/clearing each bit unmasks/masks the CPU wake-up with interrupt, by an event on the corresponding line. 0: wake-up with interrupt masked 1: wake-up with interrupt unmasked

Extended interrupt and event controller (EXTI)   RM0490  274/1027   RM0490 Rev 5  14.5.13   EXTI CPU wake-up with event mask register (EXTI_EMR1)  Address offset: 0x084 Reset value: 0x0000 0000  14.5.14   EXTI CPU wake-up with interrupt mask register 2 (EXTI_IMR2)  This register is only available on STM32C071xx. On the other devices, it is reserved. Address offset: 0x090 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 EM31   Res.   Res.   Res.   Res.   Res.   EM25   Res.   EM23   Res.   Res.   Res.   EM19   Res.   Res.   Res. rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 EM15   EM14   EM13   EM12   EM11   EM10   EM9   EM8   EM7   EM6   EM5   EM4   EM3   EM2   EM1   EM0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 31   EM31:   CPU wake-up with event generation mask on line 31 Setting/clearing this bit unmasks/masks the CPU wake-up with event generation on the corresponding line. 0: wake-up with event generation masked 1: wake-up with event generation unmasked Bits 30:26   Reserved, must be kept at reset value. Bit 25   EM25:   CPU wake-up with event generation mask on line 25 Setting/clearing this bit unmasks/masks the CPU wake-up with event generation on the corresponding line. 0: wake-up with event generation masked 1: wake-up with event generation unmasked Bit 24   Reserved, must be kept at reset value. Bit 23   EM23:   CPU wake-up with event generation mask on line 23 Setting/clearing this bit unmasks/masks the CPU wake-up with event generation on the corresponding line. 0: wake-up with event generation masked 1: wake-up with event generation unmasked Bits 22:20   Reserved, must be kept at reset value. Bit 19   EM19:   CPU wake-up with event generation mask on line 19 Setting/clearing this bit unmasks/masks the CPU wake-up with event generation on the corresponding line. 0: wake-up with event generation masked 1: wake-up with event generation unmasked Bits 18:16   Reserved, must be kept at reset value. Bits 15:0   EMx:   CPU wake-up with event generation mask on line x (x = 15 to 0) Setting/clearing each bit unmasks/masks the CPU wake-up with event generation on the corresponding line. 0: wake-up with event generation masked 1: wake-up with event generation unmasked

RM0490 Rev 5   275/1027  RM0490   Extended interrupt and event controller (EXTI)  277  Reset value: 0x0000 0000 Contains register bits for configurable events and direct events. The reset value is set such as to, by default, enable interrupt from direct lines, and disable interrupt from configurable lines.  14.5.15   EXTI CPU wake-up with event mask register 2 (EXTI_EMR2)  This register is only available on STM32C071xx. On the other devices, it is reserved. Address offset: 0x094 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   IM36   Res.   IM34   Res.   Res. rw   rw Bits 31:5   Reserved, must be kept at reset value. Bit 4   IM36:   CPU wake-up with interrupt mask on line 36 Setting/clearing the bit unmasks/masks the CPU wake-up with interrupt request from the line 36. 0: wake-up with interrupt masked 1: wake-up with interrupt unmasked Bit 3   Reserved, must be kept at reset value. Bit 2   IM34:   CPU wake-up with interrupt mask on line 34 Setting/clearing the bit unmasks/masks the CPU wake-up with interrupt request from the line 34. 0: wake-up with interrupt masked 1: wake-up with interrupt unmasked Bits 1:0   Reserved, must be kept at reset value. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   EM36   Res.   EM34   Res.   Res. rw   rw

Extended interrupt and event controller (EXTI)   RM0490  276/1027   RM0490 Rev 5  14.5.16   EXTI register map  The following table gives the EXTI register map and the reset values. Bits 31:5   Reserved, must be kept at reset value. Bit 4   EM36:   CPU wake-up with event generation mask on line 36 Setting/clearing this bit unmasks/masks the CPU wake-up with event generation on the line 36. 0: wake-up with event generation masked 1: wake-up with event generation unmasked Bit 3   Reserved, must be kept at reset value. Bit 2   EM34:   CPU wake-up with event generation mask on line 34 Setting/clearing this bit unmasks/masks the CPU wake-up with event generation on the line 34. 0: wake-up with event generation masked 1: wake-up with event generation unmasked Bits 1:0   Reserved, must be kept at reset value.  Table 62. EXTI controller register map and reset values Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x000   EXTI_RTSR1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. RT15 RT14 RT13 RT12 RT11 RT10 RT9 RT8 RT7 RT6 RT5 RT4 RT3 RT2 RT1 RT0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x004   EXTI_FTSR1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. FT15 FT14 FT13 FT12 FT11 FT10 FT9 FT8 FT7 FT6 FT5 FT4 FT3 FT2 FT1 FT0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x008   EXTI_SWIER1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. SWI15 SWI14 SWI13 SWI12 SWI11 SWI10 SWI9 SWI8 SWI7 SWI6 SWI5 SWI4 SWI3 SWI2 SWI1 SWI0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x00C   EXTI_RPR1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. RPIF15 RPIF14 RPIF13 RPIF12 RPIF11 RPIF10 RPIF9 RPIF8 RPIF7 RPIF6 RPIF5 RPIF4 RPIF3 RPIF2 RPIF1 RPIF0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x010   EXTI_FPR1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. FPIF15 FPIF14 FPIF13 FPIF12 FPIF11 FPIF10 FPIF9 FPIF8 FPIF7 FPIF6 FPIF5 FPIF4 FPIF3 FPIF2 FPIF1 FPIF0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x014- 0x01C   Reserved Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. 0x020   EXTI_RTSR2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. RT34 Res. Res. Reset value   0 0x024   EXTI_FTSR2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. FT34 Res. Res. Reset value   0 0x028   EXTI_SWIER2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. SWI34 Res. Res. Reset value   0

RM0490 Rev 5   277/1027  RM0490   Extended interrupt and event controller (EXTI)  277  Refer to   Section 2.2 on page 45   for the register boundary addresses. 0x02C   EXTI_RPR2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. RPIF34 Res. Res. Reset value   0 0x030   EXTI_FPR2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. FPIF34 Res. Res. Reset value   0 0x034- 0x05C   Reserved Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. 0x060   EXTI_EXTICR1   EXTI3[7:0]   EXTI2[7:0]   EXTI1[7:0]   EXTI0[7:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x064   EXTI_EXTICR2   EXTI7[7:0]   EXTI6[7:0]   EXTI5[7:0]   EXTI4[7:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x068   EXTI_EXTICR3   EXTI11[7:0]   EXTI10[7:0]   EXTI9[7:0]   EXTI8[7:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x06C   EXTI_EXTICR4   EXTI15[7:0]   EXTI14[7:0]   EXTI13[7:0]   EXTI12[7:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x070- 0x07C   Reserved Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. 0x080   EXTI_IMR1  IM31 Res. Res. Res. Res. Res. IM25 Res. IM23 Res. Res. Res. IM19 Res. Res. Res. IM15 IM14 IM13 IM12 IM11 IM10 IM9 IM8 IM7 IM6 IM5 IM4 IM3 IM2 IM1 IM0 Reset value   1   1   1   1   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x084   EXTI_EMR1  EM31 Res. Res. Res. Res. Res. EM25 Res. EM23 Res. Res. Res. EM19 Res. Res. Res. EM15 EM14 EM13 EM12 EM11 EM10 EM9 EM8 EM7 EM6 EM5 EM4 EM3 EM2 EM1 EM0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x088- 0x08C   Reserved Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. 0x090   EXTI_IMR2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. IM36 Res. IM34 Res. Res. Reset value   0   0 0x094   EXTI_EMR2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. EM36 Res. EM34 Res. Res. Reset value   0   0  Table 62. EXTI controller register map and reset values (continued) Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

Cyclic redundancy check calculation unit (CRC)   RM0490  278/1027   RM0490 Rev 5  15   Cyclic redundancy check calculation unit (CRC) 15.1   Introduction  The CRC (cyclic redundancy check) calculation unit is used to get a CRC code from 8-, 16- or 32-bit data word and a generator polynomial. Among other applications, CRC-based techniques are used to verify data transmission or storage integrity. In the scope of the functional safety standards, they offer a means of verifying the flash memory integrity. The CRC calculation unit helps compute a signature of the software during runtime, to be compared with a reference signature generated at link time and stored at a given memory location.  15.2   CRC main features  •   Uses CRC-32 (Ethernet) polynomial: 0x4C11DB7 X   32   + X   26   + X   23   + X   22   + X 16   + X   12   + X   11   + X   10   +X 8   + X   7   + X 5   + X 4   + X   2   + X +1  •   Alternatively, uses fully programmable polynomial with programmable size (7, 8, 16, 32 bits)  •   Handles 8-,16-, 32-bit data size  •   Programmable CRC initial value  •   Single input/output 32-bit data register  •   Input buffer to avoid bus stall during calculation  •   CRC computation done in 4 AHB clock cycles (HCLK) for the 32-bit data size  •   General-purpose 8-bit register (can be used for temporary storage)  •   Reversibility option on I/O data  •   Accessed through AHB slave peripheral by 32-bit words only, with the exception of CRC_DR register that can be accessed by words, right-aligned half-words and right-aligned bytes

RM0490 Rev 5   279/1027  RM0490   Cyclic redundancy check calculation unit (CRC)  284  15.3   CRC functional description 15.3.1   CRC block diagram Figure 29. CRC calculation unit block diagram 15.3.2   CRC internal signals  15.3.3   CRC operation  The CRC calculation unit has a single 32-bit read/write data register (CRC_DR). It is used to input new data (write access), and holds the result of the previous CRC calculation (read access). Each write operation to the data register creates a combination of the previous CRC value (stored in CRC_DR) and the new one. CRC computation is done on the whole 32-bit data word or byte by byte depending on the format of the data being written. The CRC_DR register can be accessed by word, right-aligned half-word and right-aligned byte. For the other registers only 32-bit accesses are allowed. The duration of the computation depends on data width:  •   4 AHB clock cycles for 32 bits  •   2 AHB clock cycles for 16 bits  •   1 AHB clock cycles for 8 bits An input buffer allows a second data to be immediately written without waiting for any wait-states due to the previous CRC calculation.  MS19882V3 Data register (output) read access Data register (input) write access 32-bit AHB bus crc_hclk CRC computation 32-bit accesses CRC_INIT CRC_CR CRC_POL CRC_IDR  Table 63. CRC internal input/output signals Signal name   Signal type   Description  crc_hclk   Digital input   AHB clock

Cyclic redundancy check calculation unit (CRC)   RM0490  280/1027   RM0490 Rev 5  The data size can be dynamically adjusted to minimize the number of write accesses for a given number of bytes. For instance, a CRC for 5 bytes can be computed with a word write followed by a byte write. The input data can be reversed to manage the various endianness schemes. The reversing operation can be performed on 8 bits, 16 bits and 32 bits depending on the REV_IN[1:0] bits in the CRC_CR register. For example, 0x1A2B3C4D input data are used for CRC calculation as:  •   0x58D43CB2 with bit-reversal done by byte  •   0xD458B23C with bit-reversal done by half-word  •   0xB23CD458 with bit-reversal done on the full word The output data can also be reversed by setting the REV_OUT bit in the CRC_CR register. The operation is done at bit level. For example, 0x11223344 output data are converted to 0x22CC4488. The CRC calculator can be initialized to a programmable value using the RESET control bit in the CRC_CR register (the default value is 0xFFFFFFFF). The initial CRC value can be programmed with the CRC_INIT register. The CRC_DR register is automatically initialized upon CRC_INIT register write access. The CRC_IDR register can be used to hold a temporary value related to CRC calculation. It is not affected by the RESET bit in the CRC_CR register.  Polynomial programmability  The polynomial coefficients are fully programmable through the CRC_POL register, and the polynomial size can be configured to be 7, 8, 16 or 32 bits by programming the POLYSIZE[1:0] bits in the CRC_CR register. Even polynomials are not supported.  Note:   The type of an even polynomial is X+X   2   +..+X   n   , while the type of an odd polynomial is 1+X+X   2   +..+X   n   .  If the CRC data is less than 32-bit, its value can be read from the least significant bits of the CRC_DR register. To obtain a reliable CRC calculation, the change on-fly of the polynomial value or size can not be performed during a CRC calculation. As a result, if a CRC calculation is ongoing, the application must either reset it or perform a CRC_DR read before changing the polynomial. The default polynomial value is the CRC-32 (Ethernet) polynomial: 0x4C11DB7.

RM0490 Rev 5   281/1027  RM0490   Cyclic redundancy check calculation unit (CRC)  284  15.4   CRC registers  The CRC_DR register can be accessed by words, right-aligned half-words and right-aligned bytes. For the other registers only 32-bit accesses are allowed.  15.4.1   CRC data register (CRC_DR)  Address offset: 0x00 Reset value: 0xFFFF FFFF  15.4.2   CRC independent data register (CRC_IDR)  Address offset: 0x04 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 DR[31:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 DR[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:0   DR[31:0]:   Data register bits This register is used to write new data to the CRC calculator. It holds the previous CRC calculation result when it is read. If the data size is less than 32 bits, the least significant bits are used to write/read the correct value. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 IDR[31:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 IDR[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:0   IDR[31:0] : General-purpose 32-bit data register bits These bits can be used as a temporary storage location for four bytes. This register is not affected by CRC resets generated by the RESET bit in the CRC_CR register

Cyclic redundancy check calculation unit (CRC)   RM0490  282/1027   RM0490 Rev 5  15.4.3   CRC control register (CRC_CR)  Address offset: 0x08 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   REV_ OUT   REV_IN[1:0]   POLYSIZE[1:0]   Res.   Res.   RESET rw   rw   rw   rw   rw   rs Bits 31:8   Reserved, must be kept at reset value. Bit 7   REV_OUT : Reverse output data This bit controls the reversal of the bit order of the output data. 0: Bit order not affected 1: Bit-reversed output format Bits 6:5   REV_IN[1:0] : Reverse input data This bitfield controls the reversal of the bit order of the input data 00: Bit order not affected 01: Bit reversal done by byte 10: Bit reversal done by half-word 11: Bit reversal done by word Bits 4:3   POLYSIZE[1:0] : Polynomial size These bits control the size of the polynomial. 00: 32 bit polynomial 01: 16 bit polynomial 10: 8 bit polynomial 11: 7 bit polynomial Bits 2:1   Reserved, must be kept at reset value. Bit 0   RESET : RESET bit This bit is set by software to reset the CRC calculation unit and set the data register to the value stored in the CRC_INIT register. This bit can only be set, it is automatically cleared by hardware

RM0490 Rev 5   283/1027  RM0490   Cyclic redundancy check calculation unit (CRC)  284  15.4.4   CRC initial value (CRC_INIT)  Address offset: 0x10 Reset value: 0xFFFF FFFF  15.4.5   CRC polynomial (CRC_POL)  Address offset: 0x14 Reset value: 0x04C1 1DB7 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 CRC_INIT[31:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CRC_INIT[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:0   CRC_INIT[31:0] :   Programmable initial CRC value This register is used to write the CRC initial value. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 POL[31:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 POL[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:0   POL[31:0] :   Programmable polynomial This register is used to write the coefficients of the polynomial to be used for CRC calculation. If the polynomial size is less than 32 bits, the least significant bits have to be used to program the correct value.

Cyclic redundancy check calculation unit (CRC)   RM0490  284/1027   RM0490 Rev 5  15.4.6   CRC register map  Refer to   Section 2.2   for the register boundary addresses.  Table 64. CRC register map and reset values Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00 CRC_DR   DR[31:0] Reset value   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 0x04 CRC_IDR   IDR[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x08 CRC_CR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. REV_OUT REV_IN[1:0] POLYSIZE[1:0] Res. Res. RESET Reset value   0   0   0   0   0   0 0x10 CRC_INIT   CRC_INIT[31:0] Reset value   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 0x14 CRC_POL   POL[31:0] Reset value   0   0   0   0   0   1   0   0   1   1   0   0   0   0   0   1   0   0   0   1   1   1   0   1   1   0   1   1   0   1   1   1

RM0490 Rev 5   285/1027  RM0490   Analog-to-digital converter (ADC)  343  16   Analog-to-digital converter (ADC) 16.1   Introduction  The 12-bit ADC is a successive approximation analog-to-digital converter. It has up to 23 multiplexed channels allowing it to measure signals from 19 external and 4 internal sources. A/D conversion of the various channels can be performed in single, continuous, scan or discontinuous mode. The result of the ADC is stored in a left-aligned or right-aligned 16-bit data register. The analog watchdog feature allows the application to detect if the input voltage goes outside the user-defined higher or lower thresholds. An efficient low-power mode is implemented to allow very low consumption at low frequency. A built-in hardware oversampler allows analog performances to be improved while off- loading the related computational burden from the CPU.

Analog-to-digital converter (ADC)   RM0490  286/1027   RM0490 Rev 5  16.2   ADC main features  •   High performance –   12-bit, 10-bit, 8-bit or 6-bit configurable resolution –   ADC conversion time: 0.4 μs for 12-bit resolution (2.5Msps), faster conversion times can be obtained by lowering resolution. –   Self-calibration –   Programmable sampling time –   Data alignment with built-in data coherency –   DMA support  •   Low-power –   The application can reduce PCLK frequency for low-power operation while still keeping optimum ADC performance. For example, 0.4 μs conversion time is kept, whatever the PCLK frequency –   Wait mode: prevents ADC overrun in applications with low PCLK frequency –   Auto off mode: ADC is automatically powered off except during the active conversion phase. This dramatically reduces the power consumption of the ADC.  •   Analog input channels –   Up to 19 external analog inputs –   1 channel for internal temperature sensor (V   SENSE   ) –   1 channel for internal reference voltage (V   REFINT ) –   2 channels for monitoring internal power supply (V DDA   /V   SSA   )  •   Start-of-conversion can be initiated: –   By software –   By hardware triggers with configurable polarity (timer events or GPIO input events)  •   Conversion modes –   Can convert a single channel or can scan a sequence of channels. –   Single mode converts selected inputs once per trigger –   Continuous mode converts selected inputs continuously –   Discontinuous mode  •   Interrupt generation at the end of sampling, end of conversion, end of sequence conversion, and in case of analog watchdog or overrun events  •   Analog watchdog  •   Oversampler –   16-bit data register –   Oversampling ratio adjustable from 2 to 256x –   Programmable data shift up to 8-bits  •   ADC input range: V   SSA   ≤   V   IN   ≤   V   REF+

RM0490 Rev 5   287/1027  RM0490   Analog-to-digital converter (ADC)  343  16.3   ADC implementation  Table 65. ADC main features ADC modes/features   STM32C011xx   STM32C031/51/71/91/92xx  Resolution   12 bits Maximum sampling speed   2.5 Msps Hardware offset calibration   X Single-ended inputs   X Differential inputs   - Oversampling mode   X Data register   16 bits DMA support   X Number of analog watchdogs   3 Number of external channels   13   19 Number of internal channels   4

Analog-to-digital converter (ADC)   RM0490  288/1027   RM0490 Rev 5  16.4   ADC functional description  Figure 30   shows the ADC block diagram and   Table 66   gives the ADC pin description.  Figure 30. ADC block diagram  1.   TRGi are mapped at product level. Refer to   Table External triggers   in   Section 16.4.1: ADC pins and internal signals .  MSv68740V5 Input selection & scan control SMP[2:0] sampling time ADC_IN[22:17, 14:11,8:0]   Analog input channels AUTDLY Auto-delayed conversion ADSTART SW trigger EXTEN[1:0] trigger enable and edge selection HW trigger EXTSEL[2:0] trigger selection LFTRIG Analog supply (VDDA) start  AHB interface   DMA request ADC interrupt ADC_AWDx _OUT to analog watchdogs AWDxEN AWDxSGL AWDCHx[4:0] LTx[11:0] HTx[11:0] DISCEN Discontinuous mode enable V   IN ADCAL self- calibration ADSTP stop conversion SCANDIR up/down  SAR ADC  Suppy and reference CONVERTED DATA APB interface ADREADY EOSMP EOS EOC OVR AWDx V   IN   [X] AHB slave CHSEL[22:0] CONT single/continuous AUTOFF Auto-off mode ADEN/ADDIS OVRMOD (overrun mode) ALIGN (left/right) RES[1:0] (12, 10, 8 bits) DATA[15:0] DMAEN DMACFG Start & Stop  control  V REFINT V SENSE V SSA V DDA TRG0 TRG1 TRG2 TRG3 TRG4 TRG5 TRG6 TRG7 TOVS OVSS[3:0] OVSR[3:0] OVSE Over- sampler VREF+

RM0490 Rev 5   289/1027  RM0490   Analog-to-digital converter (ADC)  343  16.4.1   ADC pins and internal signals  Table 66. ADC input/output pins Name   Signal type   Remarks  VDDA   Input, analog power supply Analog power supply and positive reference voltage for the ADC VSSA   Input, analog supply ground   Ground for analog power supply VREF+   Input, analog reference positive   The higher/positive reference voltage for the ADC. ADC_INx   Analog input signals   Up to 19 external analog input channels  Table 67. ADC internal input/output signals Internal signal name   Signal type   Description  V IN   [x]   Analog input channels Connected either to internal channels or to ADC_IN i  external channels TRGx   Input   ADC conversion triggers V SENSE   Input   Internal temperature sensor output voltage V REFINT   Input   Internal voltage reference output voltage ADC_AWDx_OUT   Output   Internal analog watchdog output signal connected to on- chip timers (x = Analog watchdog number = 1,2,3)  Table 68. External triggers Name   Source   EXTSEL[2:0]  TRG0   TIM1_TRGO2   000 TRG1   TIM1_CC4   001 TRG2   TIM2_TRGO   (1) 1.   Available only on STM32C051/71/91/92xx devices. 010 TRG3   TIM3_TRGO   011 TRG4   TIM15_TRGO   (2) 2.   Available only on STM32C091/92xx devices. 100 TRG5   Reserved   101 TRG6   Reserved   110 TRG7   EXTI11   111

Analog-to-digital converter (ADC)   RM0490  290/1027   RM0490 Rev 5  16.4.2   ADC voltage regulator (ADVREGEN)  The ADC has a specific internal voltage regulator which must be enabled and stable before using the ADC. The ADC internal voltage regulator can be enabled by setting ADVREGEN bit to 1 in the ADC_CR register. The software must wait for the ADC voltage regulator startup time (t   ADCVREG_STUP   ) before launching a calibration or enabling the ADC. This delay must be managed by software (for details on t   ADCVREG_STUP , refer to the device datasheet). After ADC operations are complete, the ADC is disabled (ADEN = 0). To keep power consumption low, it is important to disable the ADC voltage regulator before entering low- power mode (LPRun, LPSleep or Stop mode). Refer to   Section : ADC voltage regulator disable sequence ).  Note:   When the internal voltage regulator is disabled, the internal analog calibration is kept.  Analog reference from the power control unit  The internal ADC voltage regulator internally uses an analog reference delivered by the power control unit through a buffer. This buffer is always enabled when the main voltage regulator of the power control unit operates in normal Run mode (refer to Reset and clock control and power control sections). If the main voltage regulator enters low-power mode (such as Low-power run mode), this buffer is disabled and the ADC cannot be used.  ADC Voltage regulator enable sequence  To enable the ADC voltage regulator, set ADVREGEN bit to 1 in ADC_CR register.  ADC voltage regulator disable sequence  To disable the ADC voltage regulator, follow the sequence below: 1.   Make sure that the ADC is disabled (ADEN = 0). 2.   Clear ADVREGEN bit in ADC_CR register.  16.4.3   Calibration (ADCAL)  The ADC has a calibration feature. During the procedure, the ADC calculates a calibration factor which is internally applied to the ADC until the next ADC power-off. The application must not use the ADC during calibration and must wait until it is complete. Calibration should be performed before starting A/D conversion. It removes the offset error which may vary from chip to chip due to process variation. The calibration is initiated by software by setting bit ADCAL to 1. It can be initiated only when all the following conditions are met:  •   the ADC voltage regulator is enabled (ADVREGEN = 1),  •   the ADC is disabled (ADEN = 0), and  •   the Auto-off mode is disabled (AUTOFF = 0). ADCAL bit stays at 1 during all the calibration sequence. It is then cleared by hardware as soon the calibration completes. After this, the calibration factor can be read from the ADC_DR register (from bits 6 to 0).

RM0490 Rev 5   291/1027  RM0490   Analog-to-digital converter (ADC)  343  The internal analog calibration is kept if the ADC is disabled (ADEN = 0). When the ADC operating conditions change (V   REF+   changes are the main contributor to ADC offset variations and temperature change to a lesser extend), it is recommended to re-run a calibration cycle. The calibration factor is lost in the following cases:  •   The power supply is removed from the ADC (for example when the product enters Standby mode)  •   The ADC peripheral is reset. The calibration factor is lost each time power is removed from the ADC (for example when the product enters Standby mode). Still, it is possible to save and restore the calibration factor by software to save time when re-starting the ADC (as long as temperature and voltage are stable during the ADC power-down). The calibration factor can be written if the ADC is enabled but not converting (ADEN = 1 and ADSTART = 0). Then, at the next start of conversion, the calibration factor is automatically injected into the analog ADC. This loading is transparent and does not add any cycle latency to the start of the conversion.  Software calibration procedure  1.   Ensure that ADEN = 0, AUTOFF = 0, ADVREGEN = 1, and DMAEN = 0. 2.   Set ADCAL = 1. 3.   Wait until ADCAL = 0 (or until EOCAL = 1). This can be handled by interrupt if the interrupt is enabled by setting the EOCALIE bit in the ADC_IER register. 4.   The calibration factor minus one can then be read from bits 6:0 of the ADC_DR or ADC_CALFACT registers. The resulting calibration factor must be incremented by one and written back to the ADC_CALFACT register. 5.   To reduce the noise effect of the calibration factor extraction, the software can make the average of eight calibration factor values. This step is optional but recommended for better accuracy. The averaging procedure is as follows a)   Obtain eight incremented calibration factor values (perform eight times step 2 to step 4). b)   Calculate the average of these eight values and round it up to the nearest integer. c)   Write the result to the ADC_CALFACT   register.  Note:   If the resulting calibration factor is higher than 0x7F, write 0x7F to the ADC_CALFACT register to avoid overflow.

Analog-to-digital converter (ADC)   RM0490  292/1027   RM0490 Rev 5  Figure 31. ADC calibration Calibration factor forcing software procedure  1.   Ensure that ADEN = 1 and ADSTART = 0 (ADC started with no conversion ongoing) 2.   Write ADC_CALFACT with the saved calibration factor 3.   The calibration factor is used as soon as a new conversion is launched.  Figure 32. Calibration factor forcing 16.4.4   ADC on-off control (ADEN, ADDIS, ADRDY)  At power-up, the ADC is disabled and put in power-down mode (ADEN = 0). As shown in   Figure 33 , the ADC needs a stabilization time of t   STAB   before it starts converting accurately. Two control bits are used to enable or disable the ADC:  •   Set ADEN = 1 to enable the ADC. The ADRDY flag is set as soon as the ADC is ready for operation.  •   Set ADDIS = 1 to disable the ADC and put the ADC in power down mode. The ADEN and ADDIS bits are then automatically cleared by hardware as soon as the ADC is fully disabled.  MSv33703V2 tCAB ADCAL ADC State ADC_DR[6:0]   0x00 CALIBRATE   OFF Startup OFF by SW   by HW CALIBRATION FACTOR ADC_CALFACT[6:0]  MSv31925V2 ADC state F2 F1   F2 Ready (not converting)   Converting channel   Ready   Converting channel (Single ended)   (Single ended) Updating caibration by S/W Internal calibration factor[6:0] Start conversion (hardware or software) WRITE ADC_CALFACT by H/W CALFACT[6:0]

RM0490 Rev 5   293/1027  RM0490   Analog-to-digital converter (ADC)  343  Conversion can then start either by setting ADSTART to 1 (refer to   Section 16.5: Conversion on external trigger and trigger polarity (EXTSEL, EXTEN) ) or when an external trigger event occurs if triggers are enabled. Follow this procedure to enable the ADC: 1.   Clear the ADRDY bit in ADC_ISR register by programming this bit to 1. 2.   Set ADEN = 1 in the ADC_CR register. 3.   Wait until ADRDY = 1 in the ADC_ISR register (ADRDY is set after the ADC startup time). This can be handled by interrupt if the interrupt is enabled by setting the ADRDYIE bit in the ADC_IER register. Follow this procedure to disable the ADC: 1.   Check that ADSTART = 0 in the ADC_CR register to ensure that no conversion is ongoing. If required, stop any ongoing conversion by writing 1 to the ADSTP bit in the ADC_CR register and waiting until this bit is read at 0. 2.   Set ADDIS = 1 in the ADC_CR register. 3.   If required by the application, wait until ADEN = 0 in the ADC_CR register, indicating that the ADC is fully disabled (ADDIS is automatically reset once ADEN = 0). 4.   Clear the ADRDY bit in ADC_ISR register by programming this bit to 1 (optional).  Figure 33. Enabling/disabling the ADC  Note:   In Auto-off mode (AUTOFF = 1) the power-on/off phases are performed automatically, by hardware and the ADRDY flag is not set. When the bus clock is much faster than the analog ADC clock (f ADC   ), a minimum delay of ten f   ADC   clock cycles must be respected between ADEN and ADDIS bit settings.  MSv62472V1 t STAB ADEN ADRDY ADDIS ADC state   Converting CH   OFF by H/W by S/W REQ -OF OFF   Startup   RDY   RDY

Analog-to-digital converter (ADC)   RM0490  294/1027   RM0490 Rev 5  16.4.5   ADC clock (CKMODE, PRESC[3:0])  The ADC has a dual clock-domain architecture, so that the ADC can be fed with a clock (ADC asynchronous clock) independent from the APB clock (PCLK).  Figure 34. ADC clock scheme  1.   Refer to   Section Reset and clock control (RCC ) for how the PCLK clock and ADC asynchronous clock are enabled. The input clock of the analog ADC can be selected between two different clock sources (see  Figure 34: ADC clock scheme   to see how the PCLK clock and the ADC asynchronous clock are enabled): a)   The ADC clock can be a specific clock source, named “ADC asynchronous clock“ which is independent and asynchronous with the APB clock. Refer to RCC Section for more information on generating this clock source. To select this scheme, bits CKMODE[1:0] of the ADC_CFGR2 register must be reset. b)   The ADC clock can be derived from the APB clock of the ADC bus interface, divided by a programmable factor (1, 2 or 4) according to bits CKMODE[1:0]. To select this scheme, bits CKMODE[1:0] of the ADC_CFGR2 register must be different from “00”. In option a), the generated ADC clock can eventually be divided by a prescaler (1, 2, 4, 6, 8, 10, 12, 16, 32, 64, 128, 256) when programming the bits PRESC[3:0] in the ADC_CCR register). Option a) has the advantage of reaching the maximum ADC clock frequency whatever the APB clock scheme selected. Option b) has the advantage of bypassing the clock domain resynchronizations. This can be useful when the ADC is triggered by a timer and if the application requires that the ADC is precisely triggered without any uncertainty (otherwise, an uncertainty of the trigger instant is added by the resynchronizations between the two clock domains).  MSv31926V5 ADITF Analog ADC RCC (Reset & Clock Controller) PCLK ADC asynchronous clock APB interface Analog ADC clock (f ADC   ) /1 or /2 or /4   Others 00 Bits CKMODE[1:0] of ADC_CFGR2 Bits CKMODE[1:0] of ADC_CFGR2 /1,2,4,6,8,10,12 16,32,64,128,256 Bits PRESC[3:0] of ADC_CCR

RM0490 Rev 5   295/1027  RM0490   Analog-to-digital converter (ADC)  343  Caution:   For correct operation of the ADC analog block, the analog ADC clock (f   ADC ) must have a duty cycle ranging from 45% to 55%. This is granted when the incoming clock (PCLK or ADC asynchronous clock) is divided by a factor of two or higher, using one of the scaler blocks inside the ADC. If it is not the case, some additional rules must be followed:  •   When CKMODE[1:0] = 11 (PCLK divided by one), the AHB and APB prescalers in the RCC must be configured in bypass mode.  •   When the analog ADC clock is derived from the HSE or LSE bypass clock, this bypass clock must have a 45-to-55% duty cycle unless this clock is routed to the ADC through the PLL.  Table 69. Latency between trigger and start of conversion (1)  1.   Refer to the device datasheet for the maximum ADC frequency (f   ADC   ).  ADC clock source   CKMODE[1:0]   Latency between the trigger event and the start of conversion  SYSCLK, or HSIKER clock   (2) 2.   Selected with ADCSEL bitfield of the RCC_CCIPR register. 00   Latency is not deterministic (jitter) PCLK divided by 2   01   Latency is deterministic (no jitter) and equal to 3.25 f ADC   cycles PCLK divided by 4   10   Latency is deterministic (no jitter) and equal to 3.125 f ADC   cycles PCLK divided by 1   11   Latency is deterministic (no jitter) and equal to 3.5 f ADC   cycles

Analog-to-digital converter (ADC)   RM0490  296/1027   RM0490 Rev 5  16.4.6   ADC connectivity  ADC inputs are connected to the external channels as well as internal sources as described in   Figure 35 .  Figure 35. ADC connectivity  1.   ADC_IN17 to ADC_IN22 are available only on STM32C031/51/71/91/92xx devices.  MSv68741V5 SAR ADC1 ADC ADC_IN2 ADC_IN3 ADC_IN4 ADC_IN5 ADC_IN6 V   IN   [1] V   IN   [2]  STM32C0xx  V IN   [0] V IN   [3] V IN   [4] V IN   [5] V IN   [6] V IN   [8] V   IN   [9] V IN   [7] V IN   [10] V IN   [11] V IN   [12] V IN   [13] V IN   [14] V IN   [15] V IN   [16] V IN   [17] V IN   [18] V DDA ADC_IN7 V   IN V SSA Channel selection ADC_IN11 V REFINT ADC_IN0 ADC_IN1 V SENSE ADC_IN12 ADC_IN13 ADC_IN14 V   DDA V SSA ADC_IN17   (1) ADC_IN18   (1) ADC_IN19   (1) ADC_IN20   (1) ADC_IN21   (1) ADC_IN22   (1) V IN   [19] V   IN   [20] V IN[21] V   IN   [22] ADC_IN8

RM0490 Rev 5   297/1027  RM0490   Analog-to-digital converter (ADC)  343  16.4.7   Configuring the ADC  The software must write the ADCAL and ADEN bits in the ADC_CR register and configure the ADC_CFGR1 and ADC_CFGR2 registers only when the ADC is disabled (ADEN must be cleared). The software must only write to the ADSTART and ADDIS bits in the ADC_CR register only if the ADC is enabled and there is no pending request to disable the ADC (ADEN = 1 and ADDIS = 0). For all the other control bits in the ADC_IER, ADC_SMPR, ADC_CHSELR and ADC_CCR registers, refer to the description of the corresponding control bit in   Section 16.12: ADC registers . ADC_AWDTRx registers can be modified when conversion is ongoing. The software must only write to the ADSTP bit in the ADC_CR register if the ADC is enabled (and possibly converting) and there is no pending request to disable the ADC (ADSTART = 1 and ADDIS = 0).  Note:   There is no hardware protection preventing software from making write operations forbidden by the above rules. If such a forbidden write access occurs, the ADC may enter an undefined state. To recover correct operation in this case, the ADC must be disabled (clear ADEN = 0 and all the bits in the ADC_CR register).  16.4.8   Channel selection (CHSEL, SCANDIR, CHSELRMOD)  There are up to 23 multiplexed channels:  •   Up to 19 analog inputs from GPIO pins (ADC_INx)  •   4 internal analog inputs (temperature sensor, internal reference voltage, analog supply and analog ground) It is possible to convert a single channel or a sequence of channels. The sequence of the channels to be converted can be programmed in the ADC_CHSELR channel selection register: each analog input channel has a dedicated selection bit (CHSELx). The ADC scan sequencer can be used in two different modes:  •   Sequencer not fully configurable: The order in which the channels are scanned is defined by the channel number (CHSELRMOD bit must be cleared in ADC_CFGR1 register): –   Sequence length configured through CHSELx bits in ADC_CHSELR register –   Sequence direction: the channels are scanned in a forward direction (from the lowest to the highest channel number) or backward direction (from the highest to the lowest channel number) depending on the value of SCANDIR bit (SCANDIR = 0: forward scan, SCANDIR = 1: backward scan)

Analog-to-digital converter (ADC)   RM0490  298/1027   RM0490 Rev 5  –   Any channel can belong to in these sequences  •   Sequencer fully configurable The CHSELRMOD bit is set in ADC_CFGR1 register. –   Sequencer length is up to 8 channels –   The order in which the channels are scanned is independent from the channel number. Any order can be configured through SQ1[3:0] to SQ8[3:0] bits in ADC_CHSELR register. –   Only channel 0 to channel 14 can be selected in this sequence –   If the sequencer detects SQx[3:0] = 0b1111, the following SQx[3:0] registers are ignored. –   If no 0b1111 is programmed in SQx[3:0], the sequencer scans full eight channels. After programming ADC CHSELR, SCANDIR and CHSELRMOD bits, it is mandatory to wait for CCRDY flag before starting conversions. It indicates that the new channel setting has been applied. If a new configuration is required, the CCRDY flag must be cleared prior to starting the conversion. The software is allowed to program the CHSEL, SCANDIR, CHSELRMOD bits only when ADSTART bit is cleared (which ensures that no conversion is ongoing).  Temperature sensor, V   REFINT   and VDDA and VSSA internal channels  The temperature sensor is connected to channel ADC V IN   [9]. The internal voltage reference V REFINT   is connected to channel ADC V IN   [10]. V   DDA   channel is connected to ADC V IN [15]. When V   REF+   is lower than V   DDA , this channel is not converted. V   SSA   channel is connected to ADC V   IN [16].  16.4.9   Programmable sampling time (SMPx[2:0])  Before starting a conversion, the ADC needs to establish a direct connection between the voltage source to be measured and the embedded sampling capacitor of the ADC. This sampling time must be enough for the input voltage source to charge the sample and hold capacitor to the input voltage level. Having a programmable sampling time allows the conversion speed to be trimmed according to the input resistance of the input voltage source. The ADC samples the input voltage for a number of ADC clock cycles that can be modified using the SMP1[2:0] and SMP2[2:0] bits in the ADC_SMPR register. Each channel can choose one out of two sampling times configured in SMP1[2:0] and SMP2[2:0] bitfields, through SMPSELx bits in ADC_SMPR register. The total conversion time is calculated as follows: t CONV   = Sampling time + 12.5 x ADC clock cycles Example: With f ADC   = 16 MHz and a sampling time of 1.5 ADC clock cycles: t CONV   = 1.5 + 12.5 = 14 ADC clock cycles = 0.875 μs The ADC indicates the end of the sampling phase by setting the EOSMP flag.

RM0490 Rev 5   299/1027  RM0490   Analog-to-digital converter (ADC)  343  16.4.10   Single conversion mode (CONT   =   0)  In Single conversion mode, the ADC performs a single sequence of conversions, converting all the channels once. This mode is selected when CONT   =   0 in the ADC_CFGR1 register. Conversion is started by either:  •   Setting the ADSTART bit in the ADC_CR register  •   Hardware trigger event Inside the sequence, after each conversion is complete:  •   The converted data are stored in the 16-bit ADC_DR register  •   The EOC (end of conversion) flag is set  •   An interrupt is generated if the EOCIE bit is set After the sequence of conversions is complete:  •   The EOS (end of sequence) flag is set  •   An interrupt is generated if the EOSIE bit is set Then the ADC stops until a new external trigger event occurs or the ADSTART bit is set again.  Note:   To convert a single channel, program a sequence with a length of 1.  16.4.11   Continuous conversion mode (CONT   =   1)  In continuous conversion mode, when a software or hardware trigger event occurs, the ADC performs a sequence of conversions, converting all the channels once and then automatically re-starts and continuously performs the same sequence of conversions. This mode is selected when CONT   =   1 in the ADC_CFGR1 register. Conversion is started by either:  •   Setting the ADSTART bit in the ADC_CR register  •   Hardware trigger event Inside the sequence, after each conversion is complete:  •   The converted data are stored in the 16-bit ADC_DR register  •   The EOC (end of conversion) flag is set  •   An interrupt is generated if the EOCIE bit is set After the sequence of conversions is complete:  •   The EOS (end of sequence) flag is set  •   An interrupt is generated if the EOSIE bit is set Then, a new sequence restarts immediately and the ADC continuously repeats the conversion sequence.  Note:   To convert a single channel, program a sequence with a length of 1. It is not possible to have both discontinuous mode and continuous mode enabled: it is forbidden to set both bits DISCEN = 1 and CONT = 1.

Analog-to-digital converter (ADC)   RM0490  300/1027   RM0490 Rev 5  16.4.12   Starting conversions (ADSTART)  Software starts ADC conversions by setting ADSTART   =   1. When ADSTART is set, the conversion:  •   Starts immediately if EXTEN   =   00 (software trigger)  •   At the next active edge of the selected hardware trigger if EXTEN   ≠   00 The ADSTART bit is also used to indicate whether an ADC operation is currently ongoing. It is possible to re-configure the ADC while ADSTART   =   0, indicating that the ADC is idle. The ADSTART bit is cleared by hardware:  •   In single mode with software trigger (CONT   =   0, EXTEN   =   00) –   At any end of conversion sequence (EOS   =   1)  •   In discontinuous mode with software trigger (CONT   =   0, DISCEN   =   1, EXTEN   =   00) –   At end of conversion (EOC   =   1)  •   In all cases (CONT   =   x, EXTEN   =   XX) –   After execution of the ADSTP procedure invoked by software (see  Section 16.4.14: Stopping an ongoing conversion (ADSTP) on page 302 )  Note:   In continuous mode (CONT = 1), the ADSTART bit is not cleared by hardware when the EOS flag is set because the sequence is automatically relaunched. When hardware trigger is selected in single mode (CONT = 0 and EXTEN =   01 ), ADSTART is not cleared by hardware when the EOS flag is set (except if DMAEN = 1 and DMACFG = 0 in which case ADSTART is cleared at end of the DMA transfer). This avoids the need for software having to set the ADSTART bit again and ensures the next trigger event is not missed. After changing channel selection configuration (by programming ADC_CHSELR register or changing CHSELRMOD or SCANDIR), it is mandatory to wait until CCRDY flag is asserted before asserting ADSTART, otherwise the value written to ADSTART is ignored.

RM0490 Rev 5   301/1027  RM0490   Analog-to-digital converter (ADC)  343  16.4.13   Timings  The elapsed time between the start of a conversion and the end of conversion is the sum of the configured sampling time plus the successive approximation time depending on data resolution:  Figure 36. Analog-to-digital conversion time  1.   t   SMPL   depends on SMP[2:0]. 2.   t   SAR   depends on RES[2:0]. 3.   The synchronization between the analog clock and the digital clock domains is not described in the above figure.  Figure 37. ADC conversion timings  1.   EXTEN   =   00 or EXTEN   ≠   00. 2.   Trigger latency (refer to datasheet for more details). 3.   ADC_DR register write latency (refer to datasheet for more details). t   CONV   = t   SMPL   + t SAR   = [1.5   |min   + 12.5   |12bit ] x 1/f ADC t CONV   = t   SMPL   + t SAR   = 42.9 ns   |min   + 357.1 ns   |12bit   = 0.400 μs   |min   (for f ADC   = 35 MHz)  MSv30532V5 Sampling Ch(N+1) Sample AIN(N+1) Data N-1   Data N ADC state ADSTART ADC_DR Analog channel Internal S/H EOSMP EOC RDY Set by SW Sampling Ch(N)   Converting Ch(N) Ch(N+1) Hold AIN(N) Ch(N) Sample AIN(N) Indicative timings t SMPL (1)   t SAR (2) Set by HW Cleared by SW Set by HW Cleared by HW/SW  MSv33174V2  Ready   S0   Conversion 0  t LATR  (2) ADSTART   (1) ADC state ADC_DR  S1   Conversion 1   S2   Conversion 2   S3   Conversion 3  W LATENCY  (3)   W LATENCY  (3)   W LATENCY  (3) Data 1 Data 0   Data 2

Analog-to-digital converter (ADC)   RM0490  302/1027   RM0490 Rev 5  16.4.14   Stopping an ongoing conversion (ADSTP)  The software can decide to stop any ongoing conversions by setting ADSTP   =   1 in the ADC_CR register. This resets the ADC operation and the ADC is idle, ready for a new operation. When the ADSTP bit is set by software, any ongoing conversion is aborted and the result is discarded (ADC_DR register is not updated with the current conversion). The scan sequence is also aborted and reset (meaning that restarting the ADC would re- start a new sequence). Once this procedure is complete, the ADSTP and ADSTART bits are both cleared by hardware and the software must wait until ADSTART=0 before starting new conversions.  Figure 38. Stopping an ongoing conversion 16.5   Conversion on external trigger and trigger polarity (EXTSEL, EXTEN)  A conversion or a sequence of conversion can be triggered either by software or by an external event (for example timer capture). If the EXTEN[1:0] control bits are not equal to “0b00”, then external events are able to trigger a conversion with the selected polarity. The trigger selection is effective once software has set bit ADSTART   =   1. Any hardware triggers which occur while a conversion is ongoing are ignored. If bit ADSTART   =   0, any hardware triggers which occur are ignored.  Table 70   provides the correspondence between the EXTEN[1:0] values and the trigger polarity.  MSv30337V2 DATA N-1 ADC state ADSTART set by SW RDY   SAMPLING CH(N) ADC_DR CONVERTING CH(N)   RDY ADSTOP   cleared by HW set by SW cleared by HW  Table 70. Configuring the trigger polarity Source   EXTEN[1:0]  Trigger detection disabled   00 Detection on rising edge   01 Detection on falling edge   10 Detection on both rising and falling edges   11

RM0490 Rev 5   303/1027  RM0490   Analog-to-digital converter (ADC)  343  Note:   The polarity of the external trigger can be changed only when the ADC is not converting (ADSTART = 0).  The EXTSEL[2:0] control bits are used to select which of 8 possible events can trigger conversions. Refer to   Table 68: External triggers   in   Section 16.4.1: ADC pins and internal signals   for the list of all the external triggers that can be used for regular conversion. The software source trigger events can be generated by setting the ADSTART bit in the ADC_CR register.  Note:   The trigger selection can be changed only when the ADC is not converting (ADSTART = 0).  16.5.1   Discontinuous mode (DISCEN)  This mode is enabled by setting the DISCEN bit in the ADC_CFGR1 register. In this mode (DISCEN   =   1), a hardware or software trigger event is required to start each conversion defined in the sequence. On the contrary, if DISCEN   =   0, a single hardware or software trigger event successively starts all the conversions defined in the sequence. Example:  •   DISCEN   =   1, channels to be converted = 0, 3, 7, 10 –   1st trigger: channel 0 is converted and an EOC event is generated –   2nd trigger: channel 3 is converted and an EOC event is generated –   3rd trigger: channel 7 is converted and an EOC event is generated –   4th trigger: channel 10 is converted and both EOC and EOS events are generated. –   5th trigger: channel 0 is converted an EOC event is generated –   6th trigger: channel 3 is converted and an EOC event is generated –   ...  •   DISCEN   =   0, channels to be converted = 0, 3, 7, 10 –   1st trigger: the complete sequence is converted: channel 0, then 3, 7 and 10. Each conversion generates an EOC event and the last one also generates an EOS event. –   Any subsequent trigger events restarts the complete sequence.  Note:   It is not possible to have both discontinuous mode and continuous mode enabled: it is forbidden to set both bits DISCEN = 1 and CONT = 1.  16.5.2   Programmable resolution (RES) - Fast conversion mode  It is possible to obtain faster conversion times (t   SAR   ) by reducing the ADC resolution. The resolution can be configured to be either 12, 10, 8, or 6 bits by programming the RES[1:0] bits in the ADC_CFGR1 register. Lower resolution allows faster conversion times for applications where high data precision is not required.  Note:   The RES[1:0] bit must only be changed when the ADEN bit is reset.  The result of the conversion is always 12 bits wide and any unused LSB bits are read as zeros.

Analog-to-digital converter (ADC)   RM0490  304/1027   RM0490 Rev 5  Lower resolution reduces the conversion time needed for the successive approximation steps as shown in   Table 71 .  16.5.3   End of conversion, end of sampling phase (EOC, EOSMP flags)  The ADC indicates each end of conversion (EOC) event. The ADC sets the EOC flag in the ADC_ISR register as soon as a new conversion data result is available in the ADC_DR register. An interrupt can be generated if the EOCIE bit is set in the ADC_IER register. The EOC flag is cleared by software either by writing 1 to it, or by reading the ADC_DR register. The ADC also indicates the end of sampling phase by setting the EOSMP flag in the ADC_ISR register. The EOSMP flag is cleared by software by writing1 to it. An interrupt can be generated if the EOSMPIE bit is set in the ADC_IER register. The aim of this interrupt is to allow the processing to be synchronized with the conversions. Typically, an analog multiplexer can be accessed in hidden time during the conversion phase, so that the multiplexer is positioned when the next sampling starts.  Note:   As there is only a very short time left between the end of the sampling and the end of the conversion, it is recommenced to use polling or a WFE instruction rather than an interrupt and a WFI instruction.  16.5.4   End of conversion sequence (EOS flag)  The ADC notifies the application of each end of sequence (EOS) event. The ADC sets the EOS flag in the ADC_ISR register as soon as the last data result of a conversion sequence is available in the ADC_DR register. An interrupt can be generated if the EOSIE bit is set in the ADC_IER register. The EOS flag is cleared by software by writing 1 to it.  Table 71. t   SAR   timings depending on resolution RES[1:0] (bits) t   SAR (f   ADC   cycles) t   SAR   at f   ADC   = 35 MHz (ns) t   SMPL(min) (f   ADC   cycles) t   CONV   with min. t   SMPL (f   ADC   cycles) t   CONV(min)   at f   ADC   = 35 MHz (ns)  12   12.5   357   1.5   14   400 10   10.5   300   1.5   12   343 8   8.5   243   1.5   10   286 6   6.5   186   1.5   8   229

RM0490 Rev 5   305/1027  RM0490   Analog-to-digital converter (ADC)  343  16.5.5   Example timing diagrams (single/continuous modes  hardware/software triggers) Figure 39. Single conversions of a sequence, software trigger  1.   EXTEN = 00, CONT = 0 2.   CHSEL = 0x20601, WAIT = 0, AUTOFF = 0  Figure 40. Continuous conversion of a sequence, software trigger  1.   EXTEN = 00, CONT = 1, 2.   CHSEL = 0x20601, WAIT = 0, AUTOFF = 0  MSv30338V3 RDY EOC SCANDIR CH9   CH17   CH9 ADC_DR   D0   D10   D17   D10   D9   D0 ADC state   (2) ADSTART   (1) EOS D9   D17 RDY CH0 CH10 RDY   CH17 CH10 CH0 by S/W   by H/W  MSv30339V2 ADSTP CH9   CH17   STP D0   D10 CH9 D0   D9 CH10 D17 EOC SCANDIR ADC_DR ADC state   (2) ADSTART (1) EOS RDY   CH17 CH10 CH0 by S/W   by H/W RDY   CH0   CH10 D9   D17

Analog-to-digital converter (ADC)   RM0490  306/1027   RM0490 Rev 5  Figure 41. Single conversions of a sequence, hardware trigger  1.   EXTSEL = TRGx (over-frequency), EXTEN = 01 (rising edge), CONT = 0 2.   CHSEL = 0xF, SCANDIR = 0, WAIT = 0, AUTOFF = 0  Figure 42. Continuous conversions of a sequence, hardware trigger  1.   EXTSEL = TRGx, EXTEN = 10 (falling edge), CONT = 1 2.   CHSEL = 0xF, SCANDIR = 0, WAIT = 0, AUTOFF = 0  MSv30340V2 CH1   CH1 CH3   CH0   CH2 D0   D1   D2   D1   D2   D3 D3 CH2 EOC ADC_DR ADC state   (2) ADSTART   (1) EOS RDY RDY   CH0   CH3 TRGx (1) RDY D0 by H/W ignored by S/W triggered  MSv30341V2 CH1   CH2 D0   D1   D2 CH0   CH2   CH0 D3   D0   D1   D2   D3 STOP ADC_DR ADSTP by H/W CH1   CH3 ignored EOC ADC state   (2) ADSTART (1) EOS RDY CH0   CH3 TRGx (1) RDY by S/W triggered

RM0490 Rev 5   307/1027  RM0490   Analog-to-digital converter (ADC)  343  16.5.6   Low frequency trigger mode  Once the ADC is enabled or the last ADC conversion is complete, the ADC is ready to start a new conversion. The ADC needs to be started at a predefined time (t   idle ) otherwise ADC converted data might be corrupted due to the transistor leakage (refer to the device datasheet for the maximum value of t   idle ). If the application has to support a time longer than the maximum t   idle   value (between one trigger to another for single conversion mode or between the ADC enable and the first ADC conversion), then the ADC internal state needs to be rearmed. This mechanism can be enabled by setting LFTRIG bit to 1 in ADC_CFGR2 register. By setting this bit, any trigger (software or hardware) sends a rearm command to ADC. The conversion starts after a one ADC clock cycle delay compared to LFTRIG cleared. It is not necessary to use this mode when AUTOFF bit is set. For Wait mode, only the first trigger generates an internal rearm command.  16.6   Data management 16.6.1   Data register and data alignment (ADC_DR, ALIGN)  At the end of each conversion (when an EOC event occurs), the result of the converted data is stored in the ADC_DR data register which is 16-bit wide. The format of the ADC_DR depends on the configured data alignment and resolution. The ALIGN bit in the ADC_CFGR1 register selects the alignment of the data stored after conversion. Data can be right-aligned (ALIGN = 0) or left-aligned (ALIGN = 1) as shown in  Figure 43 .  Figure 43. Data alignment and resolution (oversampling disabled: OVSE = 0) 16.6.2   ADC overrun (OVR, OVRMOD)  The overrun flag (OVR) indicates a data overrun event, when the converted data was not read in time by the CPU or the DMA, before the data from a new conversion is available. The OVR flag is set in the ADC_ISR register if the EOC flag is still at ‘1’ at the time when a new conversion completes. An interrupt can be generated if the OVRIE bit is set in the ADC_IER register.  0x0 0x00 0x00 0x00 DR[11:0] DR[9:0] DR[7:0] 0x00 DR[11:0] DR[9:0] DR[7:0] DR[5:0] DR[5:0] 0x0 0x00 0x00 0x0 ALIGN   RES 0   0x0 1 0x1 0x2 0x3 0x0 0x1 0x2 0x3 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 MS30342V1

Analog-to-digital converter (ADC)   RM0490  308/1027   RM0490 Rev 5  When an overrun condition occurs, the ADC keeps operating and can continue to convert unless the software decides to stop and reset the sequence by setting the ADSTP bit in the ADC_CR register. The OVR flag is cleared by software by writing 1 to it. It is possible to configure if the data is preserved or overwritten when an overrun event occurs by programming the OVRMOD bit in the ADC_CFGR1 register:  •   OVRMOD = 0 –   An overrun event preserves the data register from being overwritten: the old data is maintained and the new conversion is discarded. If OVR remains at 1, further conversions can be performed but the resulting data is discarded.  •   OVRMOD = 1 –   The data register is overwritten with the last conversion result and the previous unread data is lost. If OVR remains at 1, further conversions can be performed and the ADC_DR register always contains the data from the latest conversion.  Figure 44. Example of overrun (OVR)  MSv30343V3 RDY EOC EOS CH0   CH1   CH2   CH0 D0   D1   D2 CH1   CH2   CH0   STOP D0 OVR RDY D0   D1   D2   D0   D1   D2 ADC_DR read access OVERRUN by S/W   by H/W triggered ADC_DR (OVRMOD=0) ADSTP ADC state (2) ADSTART (1) TRGx (1) ADC_DR (OVRMOD=1)

RM0490 Rev 5   309/1027  RM0490   Analog-to-digital converter (ADC)  343  16.6.3   Managing a sequence of data converted without using the DMA  If the conversions are slow enough, the conversion sequence can be handled by software. In this case the software must use the EOC flag and its associated interrupt to handle each data result. Each time a conversion is complete, the EOC bit is set in the ADC_ISR register and the ADC_DR register can be read. The OVRMOD bit in the ADC_CFGR1 register should be configured to 0 to manage overrun events as an error.  16.6.4   Managing converted data without using the DMA without overrun  It may be useful to let the ADC convert one or more channels without reading the data after each conversion. In this case, the OVRMOD bit must be configured at 1 and the OVR flag should be ignored by the software. When OVRMOD = 1, an overrun event does not prevent the ADC from continuing to convert and the ADC_DR register always contains the latest conversion data.  16.6.5   Managing converted data using the DMA  Since all converted channel values are stored in a single data register, it is efficient to use DMA when converting more than one channel. This avoids losing the conversion data results stored in the ADC_DR register. When DMA mode is enabled (DMAEN bit set in the ADC_CFGR1 register), a DMA request is generated after the conversion of each channel. This allows the transfer of the converted data from the ADC_DR register to the destination location selected by the software.  Note:   The DMAEN bit in the ADC_CFGR1 register must be set after the ADC calibration phase.  Despite this, if an overrun occurs (OVR = 1) because the DMA could not serve the DMA transfer request in time, the ADC stops generating DMA requests and the data corresponding to the new conversion is not transferred by the DMA. Which means that all the data transferred to the RAM can be considered as valid. Depending on the configuration of OVRMOD bit, the data is either preserved or overwritten (refer to   Section 16.6.2: ADC overrun (OVR, OVRMOD) on page 307 ). The DMA transfer requests are blocked until the software clears the OVR bit. Two different DMA modes are proposed depending on the application use and are configured with bit DMACFG in the ADC_CFGR1 register:  •   DMA one shot mode (DMACFG = 0).  This mode should be selected when the DMA is programmed to transfer a fixed number of data words.  •   DMA circular mode (DMACFG = 1)  This mode should be selected when programming the DMA in circular mode or double buffer mode.  DMA one shot mode (DMACFG   =   0)  In this mode, the ADC generates a DMA transfer request each time a new conversion data word is available and stops generating DMA requests once the DMA has reached the last DMA transfer (when a transfer complete interrupt occurs, see   Section 11: Direct memory access controller (DMA) on page 222 ) even if a conversion has been started again.

Analog-to-digital converter (ADC)   RM0490  310/1027   RM0490 Rev 5  When the DMA transfer is complete (all the transfers configured in the DMA controller have been done):  •   The content of the ADC data register is frozen.  •   Any ongoing conversion is aborted and its partial result discarded  •   No new DMA request is issued to the DMA controller. This avoids generating an overrun error if there are still conversions which are started.  •   The scan sequence is stopped and reset  •   The DMA is stopped  DMA circular mode (DMACFG   =   1)  In this mode, the ADC generates a DMA transfer request each time a new conversion data word is available in the data register, even if the DMA has reached the last DMA transfer. This allows the DMA to be configured in circular mode to handle a continuous analog input data stream.  16.7   Low-power features 16.7.1   Wait mode conversion  Wait mode conversion can be used to simplify the software as well as optimizing the performance of applications clocked at low frequency where there might be a risk of ADC overrun occurring. When the WAIT bit is set in the ADC_CFGR1 register, a new conversion can start only if the previous data has been treated, once the ADC_DR register has been read or if the EOC bit has been cleared. This is a way to automatically adapt the speed of the ADC to the speed of the system that reads the data.  Note:   Any hardware triggers which occur while a conversion is ongoing or during the wait time preceding the read access are ignored.

RM0490 Rev 5   311/1027  RM0490   Analog-to-digital converter (ADC)  343  Figure 45. Wait mode conversion (continuous mode, software trigger)  1.   EXTEN = 00, CONT = 1 2.   CHSEL = 0x3, SCANDIR = 0, WAIT = 1, AUTOFF = 0  16.7.2   Auto-off mode (AUTOFF)  The ADC has an automatic power management feature which is called auto-off mode, and is enabled by setting AUTOFF = 1 in the ADC_CFGR1 register. When AUTOFF = 1, the ADC is always powered off when not converting and automatically wakes-up when a conversion is started (by software or hardware trigger). A startup-time is automatically inserted between the trigger event which starts the conversion and the sampling time of the ADC. The ADC is then automatically disabled once the sequence of conversions is complete. Auto-off mode can cause a dramatic reduction in the power consumption of applications which need relatively few conversions or when conversion requests are timed far enough apart (for example with a low frequency hardware trigger) to justify the extra power and extra time used for switching the ADC on and off.  MSv30344V2 ADC_DR by S/W ADSTP EOC ADC state ADSTART EOS CH1   CH2   STOP CH1 CH3   RDY DLY RDY   DLY ADC_DR Read access DLY   DLY D1   D3   D1 D2 by H/W

Analog-to-digital converter (ADC)   RM0490  312/1027   RM0490 Rev 5  Auto-off mode can be combined with the wait mode conversion (WAIT = 1) for applications clocked at low frequency. This combination can provide significant power savings if the ADC is automatically powered-off during the wait phase and restarted as soon as the ADC_DR register is read by the application (see   Figure 47: Behavior with WAIT = 1, AUTOFF = 1 ).  Figure 46. Behavior with WAIT = 0, AUTOFF = 1  1.   EXTSEL = TRGx, EXTEN = 01 (rising edge), CONT = x, ADSTART = 1, CHSEL = 0xF, SCANDIR = 0, WAIT = 1, AUTOFF = 1  Figure 47. Behavior with WAIT = 1, AUTOFF = 1  1.   EXTSEL = TRGx, EXTEN = 01 (rising edge), CONT = x, ADSTART = 1, CHSEL = 0xF, SCANDIR = 0, WAIT = 1, AUTOFF = 1  MSv30345V2 TRGx EOC EOS ADC_DR Read access ADC state ADC_DR by H/W by S/W triggered D1   D3 D2   D4 RDY   CH1   CH2 Startup   CH4 CH3   OFF   Startup  MSv30346V2 D1   D2   D3   D4 TRGx EOC EOS ADC_DR Read access ADC state ADC_DR RDY   CH1   OFF Startup   CH2 OFF Startup DLY Startup   CH3   OFF DLY   DLY Startup   CH1 OFF CH2 DLY by H/W by S/W triggered

RM0490 Rev 5   313/1027  RM0490   Analog-to-digital converter (ADC)  343  16.8   Analog window watchdogs  The three AWD analog watchdogs monitor whether some channels remain within a configured voltage range (window).  16.8.1   Description of analog watchdog 1  AWD1 analog watchdog is enabled by setting the AWD1EN bit in the ADC_CFGR1 register. It is used to monitor that either one selected channel or all enabled channels   (see   Table 73: Analog watchdog 1 channel selection )   remain within a configured voltage range (window) as shown in   Figure 48 . The AWD1 analog watchdog status bit is set if the analog voltage converted by the ADC is below a lower threshold or above a higher threshold. These thresholds are programmed in HT1[11:0] and LT1[11:0] bits of ADC_AWD1TR register. An interrupt can be enabled by setting the AWD1IE bit in the ADC_IER register. The AWD1 flag is cleared by software by programing it to 1. When converting data with a resolution of less than 12-bit (according to bits DRES[1:0]), the LSB of the programmed thresholds must be kept cleared because the internal comparison is always performed on the full 12-bit raw converted data (left aligned).  Table 72   describes how the comparison is performed for all the possible resolutions.  Table 73   shows how to configure the AWD1SGL and AWD1EN bits in the ADC_CFGR1 register to enable the analog watchdog on one or more channels.  Figure 48. Analog watchdog guarded area  Table 72. Analog watchdog comparison Resolution bits RES[1:0] Analog Watchdog comparison between: Comments Raw converted data, left aligned   (1)   Thresholds  00: 12-bit   DATA[11:0]   LTx[11:0] and HTx[11:0]   - 01: 10-bit   DATA[11:2],00   LTx[11:0] and HTx[11:0]   The user must configure LTx[1:0] and HTx[1:0] to “00” 10: 8-bit   DATA[11:4],0000   LTx[11:0] and HTx[11:0]   The user must configure LTx[3:0] and HTx[3:0] to “0000” 11: 6-bit   DATA[11:6],000000   LTx[11:0] and HTx[11:0]   The user must configure LTx[5:0] and HTx[5:0] to “000000” 1.   The watchdog comparison is performed on the raw converted data before any alignment calculation.  MS45396V1 Analog voltage Higher threshold Lower threshold Guarded area HTx LTx

Analog-to-digital converter (ADC)   RM0490  314/1027   RM0490 Rev 5  16.8.2   Description of analog watchdog 2 and 3  The second and third analog watchdogs are more flexible and can guard several selected channels by programming the AWDxCHy in ADC_AWDxCR (x = 2, 3). The corresponding watchdog is enabled when any AWDxCHy bit (x = 2,3) is set in ADC_AWDxCR register. When converting data with a resolution of less than 12 bits (configured through DRES[1:0] bits), the LSB of the programmed thresholds must be kept cleared because the internal comparison is always performed on the full 12-bit raw converted data (left aligned).  Table 72   describes how the comparison is performed for all the possible resolutions. The AWD2/3 analog watchdog status bit is set if the analog voltage converted by the ADC is below a low threshold or above a high threshold. These thresholds are programmed in HTx[11:0] and LTx[11:0] of ADC_AWDxTR registers (x = 2 or 3). An interrupt can be enabled by setting the AWDxIE bit in the ADC_IER register. The AWD2 and ADW3 flags are cleared by software by programming them to 1.  16.8.3   ADC_AWDx_OUT output signal generation  Each analog watchdog is associated to an internal hardware signal, ADC_AWDx_OUT (x being the watchdog number) that is directly connected to the ETR input (external trigger) of some on-chip timers (refer to the timers section for details on how to select the ADC_AWDx_OUT signal as ETR). ADC_AWDx_OUT is activated when the associated analog watchdog is enabled:  •   ADC_AWDx_OUT is set when a guarded conversion is outside the programmed thresholds.  •   ADC_AWDx_OUT is reset after the end of the next guarded conversion which is inside the programmed thresholds. It remains at 1 if the next guarded conversions are still outside the programmed thresholds.  •   ADC_AWDx_OUT is also reset when disabling the ADC (when setting ADDIS to 1). Note that stopping conversions (ADSTP set), might clear the ADC_AWDx_OUT state.  •   ADC_AWDx_OUT state does not change when the ADC converts the none-guarded channel (see   Figure 51 ) AWDx flag is set by hardware and reset by software: AWDx flag has no influence on the generation of ADC_AWDx_OUT (as an example, ADC_AWDx_OUT can toggle while AWDx flag remains at 1 if the software has not cleared the flag). The ADC_AWDx_OUT signal is generated by the f   ADC   clock domain. This signal can be generated even the APB clock is stopped.  Table 73. Analog watchdog 1 channel selection Channels guarded by the analog watchdog   AWD1SGL bit   AWD1EN bit  None   x   0 All channels   0   1 Single (1)   channel 1.   Selected by the AWD1CH[4:0] bits 1   1

RM0490 Rev 5   315/1027  RM0490   Analog-to-digital converter (ADC)  343  The AWD comparison is performed at the end of each ADC conversion. The ADC_AWDx_OUT rising edge and falling edge occurs two f   ADC   clock cycles after the comparison. As ADC_AWDx_OUT is generated by the f   ADC   clock domain and AWD flag is generated by the APB clock domain, the rising edges of these signals are not synchronized.  Figure 49. ADC_AWDx_OUT signal generation Figure 50. ADC_AWDx_OUT signal generation (AWDx flag not cleared by software)  MSv45362V1 EOC FLAG ADC STATE   RDY AWDx FLAG Conversion1 outside ADC_AWDx_OUT inside Cleared by SW Conversion2   Conversion3   Conversion4   Conversion5   Conversion6   Conversion7 outside inside   outside   outside   inside - Converted channels: 1,2,3,4,5,6,7 - Guarded converted channels: 1,2,3,4,5,6,7 Cleared by SW Cleared by SW Cleared by SW  MSv45363V1 EOC FLAG ADC STATE   RDY AWDx FLAG Conversion1 outside ADC_AWDx_OUT inside not cleared by SW Conversion2   Conversion3   Conversion4   Conversion5   Conversion6   Conversion7 outside inside   outside   outside   inside - Converted channels: 1,2,3,4,5,6,7 - Guarded converted channels: 1,2,3,4,5,6,7

Analog-to-digital converter (ADC)   RM0490  316/1027   RM0490 Rev 5  Figure 51. ADC_AWDx_OUT signal generation (on a single channel) 16.8.4   Analog watchdog threshold control  LTx[11:0] and HTx[11:0] can be changed during an analog-to-digital conversion (that is between the start of the conversion and the end of conversion of the ADC internal state). If HTx and LTx bits are programmed during the ADC guarded channel conversion, the watchdog function is masked for this conversion. This mask is cleared when starting a new conversion, and the resulting new AWD threshold is applied starting the next ADC conversion result. AWD comparison is performed at each end of conversion. If the current ADC data are out of the new threshold interval, this does not generated any interrupt or an ADC_AWDx_OUT signal. The Interrupt and the ADC_AWDx_OUT generation only occurs at the end of the ADC conversion that started after the threshold update. If ADC_AWDx_OUT is already asserted, programming the new threshold does not deassert the ADC_AWDx_OUT signal.  Figure 52. Analog watchdog threshold update  MSv45364V2 EOC FLAG ADC STATE AWDx FLAG Conversion1 outside ADC_AWDx_OUT Cleared by SW Conversion2   Conversion1   Conversion2   Conversion1   Conversion2   Conversion1 inside   outside   outside Conversion2 EOS FLAG   Cleared by SW - Converted channels: 1 and 2 - Only channel 1 is guarded  MSv45365V1 ADC state   Conversion   Conversion LTx, HTx   XXXX Comparison   Active XXXY Masked Threshold updated Conversion Active XXXZ Conversion

RM0490 Rev 5   317/1027  RM0490   Analog-to-digital converter (ADC)  343  16.9   Oversampler  The oversampling unit performs data preprocessing to offload the CPU. It can handle multiple conversions and average them into a single data with increased data width, up to 16-bit. It provides a result with the following form, where N and M can be adjusted: It allows the following functions to be performed by hardware: averaging, data rate reduction, SNR improvement, basic filtering. The oversampling ratio N is defined using the OVSR[2:0] bits in the ADC_CFGR2 register. It can range from 2x to 256x. The division coefficient M consists of a right bit shift up to 8 bits. It is configured through the OVSS[3:0] bits in the ADC_CFGR2 register. The summation unit can yield a result up to 20 bits (256 x 12-bit), which is first shifted right. The upper bits of the result are then truncated, keeping only the 16 least significant bits rounded to the nearest value using the least significant bits left apart by the shifting, before being finally transferred into the ADC_DR data register.  Note:   If the intermediate result after the shifting exceeds 16 bits, the upper bits of the result are simply truncated.  Figure 53. 20-bit to 16-bit result truncation  Figure 54   gives a numerical example of the processing, from a raw 20-bit accumulated data to the final 16-bit result.  Figure 54. Numerical example with 5-bit shift and rounding  Result   1 M  ---- -   Conversion t   n (   )  n   0 =  n   N   1 – =  ∑ × =  0 3 7 11 15 19 Raw 20-bit data Truncation and rounding Shifting 0 15 MS31928V2  0 3 7 11 15 19 Raw 20-bit data: B   F 15 B   7 3   7 D 1   D MS31929V1 Final result after 5-bits shift and rounding to nearest

Analog-to-digital converter (ADC)   RM0490  318/1027   RM0490 Rev 5  Table 74   gives the data format for the various N and M combination, for a raw conversion data equal to 0xFFF. The conversion timings in oversampled mode do not change compared to standard conversion mode: the sample time is maintained equal during the whole oversampling sequence. New data are provided every N conversion, with an equivalent delay equal to N x t CONV   = N x (t SMPL   + t SAR ). The flags features are raised as following:  •   the end of the sampling phase (EOSMP) is set after each sampling phase  •   the end of conversion (EOC) occurs once every N conversions, when the oversampled result is available  •   the end of sequence (EOCSEQ) occurs once the sequence of oversampled data is completed (i.e. after N x sequence length conversions total)  16.9.1   ADC operating modes supported when oversampling  In oversampling mode, most of the ADC operating modes are available:  •   Single or continuous mode conversions, forward or backward scanned sequences  •   ADC conversions start either by software or with triggers  •   ADC stop during a conversion (abort)  •   Data read via CPU or DMA with overrun detection  •   Low-power modes (WAIT, AUTOFF)  •   Programmable resolution: in this case, the reduced conversion values (as per RES[1:0] bits in ADC_CFGR1 register) are accumulated, truncated, rounded and shifted in the same way as 12-bit conversions are  Note:   The alignment mode is not available when working with oversampled data. The ALIGN bit in ADC_CFGR1 is ignored and the data are always provided right-aligned.  Table 74. Maximum output results vs N and M. Grayed values indicates truncation Oversa mpling ratio Max Raw data No-shift OVSS = 0000 1-bit shift OVSS = 0001 2-bit shift OVSS = 0010 3-bit shift OVSS = 0011 4-bit shift OVSS = 0100 5-bit shift OVSS = 0101 6-bit shift OVSS = 0110 7-bit shift OVSS = 0111 8-bit shift OVSS = 1000  2x   0x1FFE   0x1FFE   0x0FFF   0x0800   0x0400   0x0200   0x0100   0x0080   0x0040   0x0020 4x   0x3FFC   0x3FFC   0x1FFE   0x0FFF   0x0800   0x0400   0x0200   0x0100   0x0080   0x0040 8x   0x7FF8   0x7FF8   0x3FFC   0x1FFE   0x0FFF   0x0800   0x0400   0x0200   0x0100   0x0080 16x   0xFFF0   0xFFF0   0x7FF8   0x3FFC   0x1FFE   0x0FFF   0x0800   0x0400   0x0200   0x0100 32x   0x1FFE0   0xFFE0   0xFFF0   0x7FF8   0x3FFC   0x1FFE   0x0FFF   0x0800   0x0400   0x0200 64x   0x3FFC0   0xFFC0   0xFFE0   0xFFF0   0x7FF8   0x3FFC   0x1FFE   0x0FFF   0x0800   0x0400 128x   0x7FF80   0xFF80   0xFFC0   0xFFE0   0xFFF0   0x7FF8   0x3FFC   0x1FFE   0x0FFF   0x0800 256x   0xFFF00   0xFF00   0xFF80   0xFFC0   0xFFE0   0xFFF0   0x7FF8   0x3FFC   0x1FFE   0x0FFF

RM0490 Rev 5   319/1027  RM0490   Analog-to-digital converter (ADC)  343  16.9.2   Analog watchdog  The analog watchdog functionality is available, with the following differences:  •   the RES[1:0] bits are ignored, comparison is always done on using the full 12-bits values HTx[11:0] and LTx[11:0]  •   the comparison is performed on the most significant 12 bits of the 16 bits oversampled results ADC_DR[15:4]  Note:   Care must be taken when using high shifting values. This reduces the comparison range. For instance, if the oversampled result is shifted by 4 bits thus yielding a 12-bit data right- aligned, the affective analog watchdog comparison can only be performed on 8 bits. The comparison is done between ADC_DR[11:4] and HT x [7:0] / LT x [[7:0], and HT x [11:8] / LT x [11:8] must be kept reset.  16.9.3   Triggered mode  The averager can also be used for basic filtering purposes. Although not a very efficient filter (slow roll-off and limited stop band attenuation), it can be used as a notch filter to reject constant parasitic frequencies (typically coming from the mains or from a switched mode power supply). For this purpose, a specific discontinuous mode can be enabled with TOVS bit in ADC_CFGR2, to be able to have an oversampling frequency defined by a user and independent from the conversion time itself.  Figure 55   below shows how conversions are started in response to triggers in discontinuous mode. If the TOVS bit is set, the content of the DISCEN bit is ignored and considered as 1.  Figure 55. Triggered oversampling mode (TOVS bit = 1) 16.10   Temperature sensor and internal reference voltage  The temperature sensor can be used to measure the junction temperature (T J   ) of the device. The temperature sensor is internally connected to the ADC V IN   [9] input channel which is used to convert the sensor’s output voltage to a digital value. The sampling time for the temperature sensor analog pin must be greater than the minimum T   S_temp   value specified in the datasheet. When not in use, the sensor can be put in power down mode.  MS33700V1 Ch(N) 0 Ch(N) 1 Ch(N) 2 Ch(N) 3 Trigger   Trigger CONT = 0 (DISCEN = 1)* TOVS = 0 (DISCEN = 1)*: DISCEN bit is forced to 1 by software when TOVS bit is set EOC flag set EOC flag set CONT = 0 (DISCEN = 1)* TOVS = 1 Trigger Ch(N) 0 Ch(N) 1 Ch(N) 2 Ch(N) 3 Trigger Ch(N) 2 Trigger Ch(N) 3 Trigger Ch(N) 2 Trigger Ch(N) 0 Trigger Ch(N) 1 Trigger Ch(N) 1 Ch(N) 0

Analog-to-digital converter (ADC)   RM0490  320/1027   RM0490 Rev 5  The internal voltage reference (V   REFINT   ) provides a stable (bandgap) voltage output for the ADC. V REFINT   is internally connected to the ADC V IN [10] input channel. The precise voltage of V   REFINT   is individually measured for each part by ST during production test and stored in the system memory area.  Figure 56   shows the block diagram of connections between the temperature sensor, the internal voltage reference and the ADC. The TSEN bit must be set to enable the conversion of ADC V IN [9] (temperature sensor) and the VREFEN bit must be set to enable the conversion of ADC V   IN [10] (V   REFINT   ). The temperature sensor output voltage changes linearly with temperature. The offset of this line varies from chip to chip due to process variation (up to 45 °C from one chip to another). The uncalibrated internal temperature sensor is more suited for applications that detect temperature variations instead of absolute temperatures. To improve the accuracy of the temperature sensor measurement, calibration values are stored in system memory for each device by ST during production. During the manufacturing process, the calibration data of the temperature sensor and the internal voltage reference are stored in the system memory area. The user application can then read them and use them to improve the accuracy of the temperature sensor or the internal reference. Refer to the datasheet for additional information.  Note:   Before entering any Stop mode, the temperature sensor and the internal reference voltage must be disabled by clearing TSEN and VREFEN, respectively.  Main features  •   Linearity: ±2 °C max, precision depending on calibration  Figure 56. Temperature sensor and V   REFINT   channel block diagram  MSv68742V2 V SENSE TSEN control bit Address/data bus converted data ADC V   IN [10] Temperature sensor Internal power block ADC VREFEN control bit ADC V IN [9] + - + - V   REFINT

RM0490 Rev 5   321/1027  RM0490   Analog-to-digital converter (ADC)  343  Reading the temperature  1.   Select the ADC V   IN [9] input channel. 2.   Select an appropriate sampling time specified in the device datasheet (T S_temp   ). 3.   Set the TSEN bit in the ADC_CCR register to wake up the temperature sensor from power down mode and wait for its stabilization time (t START   ). 4.   Start the ADC conversion by setting the ADSTART bit in the ADC_CR register (or by external trigger). 5.   Read the resulting V   SENSE   data in the ADC_DR register. 6.   Calculate the temperature using the following formula Where:  •   TS_CAL1 is the temperature sensor calibration value acquired at TS_CAL1_TEMP (refer to the datasheet for TS_CAL1 value)  •   TS_DATA is the actual temperature sensor output value converted by ADC Refer to the specific device datasheet for more information about TS_CAL1 calibration point.  •   Avg_Slope is the coefficient of the temperature sensor output voltage expressed in mV/°C (refer to the datasheet for Avg_Slope value).  Note:   The sensor has a startup time after waking from power down mode before it can output V   SENSE   at the correct level. The ADC also has a startup time after power-on, so to minimize the delay, the ADEN and TSEN bits should be set at the same time.  Calculating the actual V   REF+   voltage using the internal reference voltage  V   REF+   voltage may be subject to variation or not precisely known. The embedded internal reference voltage (V   REFINT   ) and its calibration data acquired by the ADC during the manufacturing process at V   REF+_charac   can be used to evaluate the actual V   REF+   voltage level. The following formula gives the actual V   REF+   voltage supplying the device: Where:  •   V   REF+_Charac   is the value of V REF+   voltage characterized at V   REFINT   during the manufacturing process. It is specified in the device datasheet.  •   VREFINT_CAL is the VREFINT calibration value  •   VREFINT_DATA is the actual VREFINT output value converted by ADC Temperature   in °C (   )   Sense_DATA   TS_CAL1 –  Avg_Slope_Code  ------------------------------------------------------------------- -   TS_CAL1_TEMP + =  Avg_Slope_Code   Avg_Slope   4096 ×   3000 ⁄ =  Sense_DATA   TS_DATA   V DDA ×   3.0 ⁄ =  V REF+   V REF   _Charac +   VREFINT_CAL   VREFINT_DATA ⁄ × =

Analog-to-digital converter (ADC)   RM0490  322/1027   RM0490 Rev 5  Converting a supply-relative ADC measurement to an absolute voltage value  The ADC is designed to deliver a digital value corresponding to the ratio between the analog power supply and the voltage applied on the converted channel. For most application use cases, it is necessary to convert this ratio into a voltage independent of V REF+ . For applications where V   REF+   is known and ADC converted values are right-aligned you can use the following formula to get this absolute value: For applications where V   REF+   value is not known, you must use the internal voltage reference and V   REF+   can be replaced by the expression provided in   Calculating the actual V   REF+   voltage using the internal reference voltage , resulting in the following formula: Where:  •   V   REF+_Charac   is the value of V REF+   voltage characterized at V   REFINT   during the manufacturing process. It is specified in the device datasheet.  •   VREFINT_CAL is the VREFINT calibration value  •   ADC_DATA x   is the value measured by the ADC on channelx (right-aligned)  •   VREFINT_DATA is the actual VREFINT output value converted by the ADC  •   NUM_CODES is the number of ADC output codes. For example with 12-bit resolution, it is 2 12   = 4096 or with 8-bit resolution, 2   8   = 256.  Note:   If ADC measurements are done using an output format other than 12 bit right-aligned, all the parameters must first be converted to a compatible format before the calculation is done.  16.11   ADC interrupts  An interrupt can be generated by any of the following events:  •   End Of Calibration (EOCAL flag)  •   ADC power-up, when the ADC is ready (ADRDY flag)  •   End of any conversion (EOC flag)  •   End of a sequence of conversions (EOS flag)  •   When an analog watchdog detection occurs (AWD1, AWD2, AWD3 flags)  •   When the Channel configuration is ready (CCRDY flag)  •   When the end of sampling phase occurs (EOSMP flag)  •   when a data overrun occurs (OVR flag) Separate interrupt enable bits are available for flexibility. V CHANNELx V REF+ NUM_CODES  ------------------------------------- -   ADC_DATA x × =  V CHANNELx V REF+_Charac   VREFINT_CAL   ADC_DATA x × ×  VREFINT_DATA   NUM_CODES ×  ------------------------------------------------------------------------------------------------------------------------------------ - =  Table 75. ADC interrupts Interrupt event   Event flag   Enable control bit  End Of Calibration   EOCAL   EOCALIE ADC ready   ADRDY   ADRDYIE End of conversion   EOC   EOCIE

RM0490 Rev 5   323/1027  RM0490   Analog-to-digital converter (ADC)  343  End of sequence of conversions   EOS   EOSIE Analog watchdog 1 status bit is set   AWD1   AWD1IE Analog watchdog 2 status bit is set   AWD2   AWD2IE Analog watchdog 3 status bit is set   AWD3   AWD3IE Channel Configuration Ready   CCRDY   CCRDYIE End of sampling phase   EOSMP   EOSMPIE Overrun   OVR   OVRIE  Table 75. ADC interrupts (continued) Interrupt event   Event flag   Enable control bit

Analog-to-digital converter (ADC)   RM0490  324/1027   RM0490 Rev 5  16.12   ADC registers  Refer to   Section 1.2   for a list of abbreviations used in register descriptions.  16.12.1   ADC interrupt and status register (ADC_ISR)  Address offset: 0x00 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   CCRD Y   Res.   EOCAL   Res.   AWD3   AWD2   AWD1   Res.   Res.   OVR   EOS   EOC   EOSM P   ADRDY rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1  Bits 31:14   Reserved, must be kept at reset value. Bit 13   CCRDY : Channel Configuration Ready flag This flag bit is set by hardware when the channel configuration is applied after programming to ADC_CHSELR register or changing CHSELRMOD or SCANDIR. It is cleared by software by programming it to it. 0: Channel configuration update not applied. 1: Channel configuration update is applied.  Note:   When the software configures the channels (by programming ADC_CHSELR or changing CHSELRMOD or SCANDIR), it must wait until the CCRDY flag rises before configuring again or starting conversions, otherwise the new configuration (or the START bit) is ignored. Once the flag is asserted, if the software needs to configure again the channels, it must clear the CCRDY flag before proceeding with a new configuration.  Bit 12   Reserved, must be kept at reset value. Bit 11   EOCAL : End Of Calibration flag This bit is set by hardware when calibration is complete. It is cleared by software writing 1 to it. 0: Calibration is not complete 1: Calibration is complete Bit 10   Reserved, must be kept at reset value. Bit 9   AWD3 : Analog watchdog 3 flag This bit is set by hardware when the converted voltage crosses the values programmed in ADC_AWD3TR and ADC_AWD3TR registers. It is cleared by software by programming it to 1. 0: No analog watchdog event occurred (or the flag event was already acknowledged and cleared by software) 1: Analog watchdog event occurred Bit 8   AWD2 : Analog watchdog 2 flag This bit is set by hardware when the converted voltage crosses the values programmed in ADC_AWD2TR and ADC_AWD2TR registers. It is cleared by software programming it it. 0: No analog watchdog event occurred (or the flag event was already acknowledged and cleared by software) 1: Analog watchdog event occurred

RM0490 Rev 5   325/1027  RM0490   Analog-to-digital converter (ADC)  343  16.12.2   ADC interrupt enable register (ADC_IER)  Address offset: 0x04 Reset value: 0x0000 0000 Bit 7   AWD1 : Analog watchdog 1 flag This bit is set by hardware when the converted voltage crosses the values programmed in ADC_TR1 and ADC_HR1 registers. It is cleared by software by programming it to 1. 0: No analog watchdog event occurred (or the flag event was already acknowledged and cleared by software) 1: Analog watchdog event occurred Bits 6:5   Reserved, must be kept at reset value. Bit 4   OVR : ADC overrun This bit is set by hardware when an overrun occurs, meaning that a new conversion has complete while the EOC flag was already set. It is cleared by software writing 1 to it. 0: No overrun occurred (or the flag event was already acknowledged and cleared by software) 1: Overrun has occurred Bit 3   EOS : End of sequence flag This bit is set by hardware at the end of the conversion of a sequence of channels selected by the CHSEL bits. It is cleared by software writing 1 to it. 0: Conversion sequence not complete (or the flag event was already acknowledged and cleared by software) 1: Conversion sequence complete Bit 2   EOC : End of conversion flag This bit is set by hardware at the end of each conversion of a channel when a new data result is available in the ADC_DR register. It is cleared by software writing 1 to it or by reading the ADC_DR register. 0: Channel conversion not complete (or the flag event was already acknowledged and cleared by software) 1: Channel conversion complete Bit 1   EOSMP : End of sampling flag This bit is set by hardware during the conversion, at the end of the sampling phase.It is cleared by software by programming it to ‘1’. 0: Not at the end of the sampling phase (or the flag event was already acknowledged and cleared by software) 1: End of sampling phase reached Bit 0   ADRDY : ADC ready This bit is set by hardware after the ADC has been enabled (ADEN = 1) and when the ADC reaches a state where it is ready to accept conversion requests. It is cleared by software writing 1 to it. 0: ADC not yet ready to start conversion (or the flag event was already acknowledged and cleared by software) 1: ADC is ready to start conversion

Analog-to-digital converter (ADC)   RM0490  326/1027   RM0490 Rev 5  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   CCRD YIE   Res.   EOCAL IE   Res.   AWD3I E AWD2I E AWD1I E   Res.   Res.   OVRIE   EOSIE   EOCIE   EOSM PIE ADRDY IE rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bits 31:14   Reserved, must be kept at reset value. Bit 13   CCRDYIE : Channel Configuration Ready Interrupt enable This bit is set and cleared by software to enable/disable the channel configuration ready interrupt. 0: Channel configuration ready interrupt disabled 1: Channel configuration ready interrupt enabled  Note:   The software is allowed to write this bit only when ADSTART bit is cleared (this ensures that no conversion is ongoing).  Bit 12   Reserved, must be kept at reset value. Bit 11   EOCALIE : End of calibration interrupt enable This bit is set and cleared by software to enable/disable the end of calibration interrupt. 0: End of calibration interrupt disabled 1: End of calibration interrupt enabled  Note:   The software is allowed to write this bit only when ADSTART bit is cleared (this ensures that no conversion is ongoing).  Bit 10   Reserved, must be kept at reset value. Bit 9   AWD3IE : Analog watchdog 3 interrupt enable This bit is set and cleared by software to enable/disable the analog watchdog interrupt. 0: Analog watchdog interrupt disabled 1: Analog watchdog interrupt enabled  Note:   The Software is allowed to write this bit only when ADSTART bit is cleared (this ensures that no conversion is ongoing).  Bit 8   AWD2IE : Analog watchdog 2 interrupt enable This bit is set and cleared by software to enable/disable the analog watchdog interrupt. 0: Analog watchdog interrupt disabled 1: Analog watchdog interrupt enabled  Note:   The Software is allowed to write this bit only when ADSTART bit is cleared (this ensures that no conversion is ongoing).  Bit 7   AWD1IE : Analog watchdog 1 interrupt enable This bit is set and cleared by software to enable/disable the analog watchdog interrupt. 0: Analog watchdog interrupt disabled 1: Analog watchdog interrupt enabled  Note:   The Software is allowed to write this bit only when ADSTART bit is cleared (this ensures that no conversion is ongoing).  Bits 6:5   Reserved, must be kept at reset value.

RM0490 Rev 5   327/1027  RM0490   Analog-to-digital converter (ADC)  343  16.12.3   ADC control register (ADC_CR)  Address offset: 0x08 Reset value: 0x0000 0000 Bit 4   OVRIE : Overrun interrupt enable This bit is set and cleared by software to enable/disable the overrun interrupt. 0: Overrun interrupt disabled 1: Overrun interrupt enabled. An interrupt is generated when the OVR bit is set.  Note:   The software is allowed to write this bit only when ADSTART bit is cleared (this ensures that no conversion is ongoing).  Bit 3   EOSIE : End of conversion sequence interrupt enable This bit is set and cleared by software to enable/disable the end of sequence of conversions interrupt. 0: EOS interrupt disabled 1: EOS interrupt enabled. An interrupt is generated when the EOS bit is set.  Note:   The software is allowed to write this bit only when ADSTART bit is cleared (this ensures that no conversion is ongoing).  Bit 2   EOCIE : End of conversion interrupt enable This bit is set and cleared by software to enable/disable the end of conversion interrupt. 0: EOC interrupt disabled 1: EOC interrupt enabled. An interrupt is generated when the EOC bit is set.  Note:   The software is allowed to write this bit only when ADSTART bit is cleared (this ensures that no conversion is ongoing).  Bit 1   EOSMPIE : End of sampling flag interrupt enable This bit is set and cleared by software to enable/disable the end of the sampling phase interrupt. 0: EOSMP interrupt disabled. 1: EOSMP interrupt enabled. An interrupt is generated when the EOSMP bit is set.  Note:   The software is allowed to write this bit only when ADSTART bit is cleared (this ensures that no conversion is ongoing).  Bit 0   ADRDYIE : ADC ready interrupt enable This bit is set and cleared by software to enable/disable the ADC Ready interrupt. 0: ADRDY interrupt disabled. 1: ADRDY interrupt enabled. An interrupt is generated when the ADRDY bit is set.  Note:   The software is allowed to write this bit only when ADSTART bit is cleared (this ensures that no conversion is ongoing).  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 ADCAL   Res.   Res.   ADVRE GEN   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. rs   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   ADSTP   Res.   ADSTA RT   ADDIS   ADEN rs   rs   rs   rs

Analog-to-digital converter (ADC)   RM0490  328/1027   RM0490 Rev 5  Bit 31   ADCAL : ADC calibration This bit is set by software to start the calibration of the ADC. It is cleared by hardware after calibration is complete. 0: Calibration complete 1: Write 1 to calibrate the ADC. Read at 1 means that a calibration is in progress.  Note:   The software is allowed to set ADCAL only when the ADC is disabled (ADCAL   =   0, ADSTART   =   0, ADSTP   =   0, ADDIS   =   0, AUTOFF = 0, and ADEN   =   0). The software is allowed to update the calibration factor by writing ADC_CALFACT only when ADEN = 1 and ADSTART = 0 (ADC enabled and no conversion is ongoing).  Bits 30:29   Reserved, must be kept at reset value. Bit 28   ADVREGEN : ADC Voltage Regulator Enable This bit is set by software, to enable the ADC internal voltage regulator. The voltage regulator output is available after t ADCVREG_STUP . It is cleared by software to disable the voltage regulator. It can be cleared only if ADEN is cleared. 0: ADC voltage regulator disabled 1: ADC voltage regulator enabled  Note:   The software is allowed to program this bit field only when the ADC is disabled (ADCAL   =   0, ADSTART   =   0, ADSTP   =   0, ADDIS   =   0 and ADEN   =   0).  Bits 27:5   Reserved, must be kept at reset value. Bit 4   ADSTP : ADC stop conversion command This bit is set by software to stop and discard an ongoing conversion (ADSTP Command). It is cleared by hardware when the conversion is effectively discarded and the ADC is ready to accept a new start conversion command. 0: No ADC stop conversion command ongoing 1: Write 1 to stop the ADC. Read 1 means that an ADSTP command is in progress.  Note:   Setting ADSTP to ‘1’ is only effective when ADSTART   =   1 and ADDIS   =   0 (ADC is enabled and may be converting and there is no pending request to disable the ADC)  Bit 3   Reserved, must be kept at reset value. Bit 2   ADSTART : ADC start conversion command This bit is set by software to start ADC conversion. Depending on the EXTEN [1:0] configuration bits, a conversion either starts immediately (software trigger configuration) or once a hardware trigger event occurs (hardware trigger configuration). It is cleared by hardware: – In single conversion mode (CONT = 0, DISCEN = 0), when software trigger is selected (EXTEN = 00): at the assertion of the end of Conversion Sequence (EOS) flag. – In discontinuous conversion mode (CONT = 0, DISCEN = 1), when the software trigger is selected (EXTEN = 00): at the assertion of the end of Conversion (EOC) flag. – In all other cases: after the execution of the ADSTP command, at the same time as the ADSTP bit is cleared by hardware. 0: No ADC conversion is ongoing. 1: Write 1 to start the ADC. Read 1 means that the ADC is operating and may be converting.  Note:   The software is allowed to set ADSTART only when ADEN   =   1 and ADDIS   =   0 (ADC is enabled and there is no pending request to disable the ADC). After writing to ADC_CHSELR register or changing CHSELRMOD or SCANDIRW, it is mandatory to wait until CCRDY flag is asserted before setting ADSTART, otherwise, the value written to ADSTART is ignored.

RM0490 Rev 5   329/1027  RM0490   Analog-to-digital converter (ADC)  343  16.12.4   ADC configuration register 1 (ADC_CFGR1)  Address offset: 0x0C Reset value: 0x0000 0000 The software is allowed to program ADC_CFGR1 only when ADEN is cleared in ADC_CR. Bit 1   ADDIS : ADC disable command This bit is set by software to disable the ADC (ADDIS command) and put it into power-down state (OFF state). It is cleared by hardware once the ADC is effectively disabled (ADEN is also cleared by hardware at this time). 0: No ADDIS command ongoing 1: Write 1 to disable the ADC. Read 1 means that an ADDIS command is in progress.  Note:   Setting ADDIS to ‘1’ is only effective when ADEN   =   1 and ADSTART   =   0 (which ensures that no conversion is ongoing)  Bit 0   ADEN : ADC enable command This bit is set by software to enable the ADC. The ADC is effectively ready to operate once the ADRDY flag has been set. It is cleared by hardware when the ADC is disabled, after the execution of the ADDIS command. 0: ADC is disabled (OFF state) 1: Write 1 to enable the ADC.  Note:   The software is allowed to set ADEN only when ADCAL   =   0, ADSTP   =   0, ADSTART   =   0, ADDIS   =   0, ADEN   =   0, and ADVREGEN = 1.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   AWD1CH[4:0]   Res.   Res.   AWD1E N AWD1S GL CHSEL RMOD   Res.   Res.   Res.   Res.   DISCE N rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 AUTOF F   WAIT   CONT   OVRM OD   EXTEN[1:0]   Res.   EXTSEL[2:0]   ALIGN   RES[1:0]   SCAND IR DMAC FG DMAE N rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bit 31   Reserved, must be kept at reset value. Bits 30:26   AWD1CH[4:0] : Analog watchdog channel selection These bits are set and cleared by software. They select the input channel to be guarded by the analog watchdog. 00000: ADC analog input Channel 0 monitored by AWD 00001: ADC analog input Channel 1 monitored by AWD ..... 10110: ADC analog input Channel 22 monitored by AWD Others: Reserved  Note:   The channel selected by the AWDCH[4:0] bits must be also set into the CHSELR register.  Bits 25:24   Reserved, must be kept at reset value.

Analog-to-digital converter (ADC)   RM0490  330/1027   RM0490 Rev 5  Bit 23   AWD1EN : Analog watchdog enable This bit is set and cleared by software. 0: Analog watchdog   1   disabled 1: Analog watchdog   1   enabled Bit 22   AWD1SGL : Enable the watchdog on a single channel or on all channels This bit is set and cleared by software to enable the analog watchdog on the channel identified by the AWDCH[4:0] bits or on all the channels 0: Analog watchdog   1   enabled on all channels 1: Analog watchdog   1   enabled on a single channel Bit 21   CHSELRMOD : Mode selection of the ADC_CHSELR register This bit is set and cleared by software to control the ADC_CHSELR feature: 0: Each bit of the ADC_CHSELR register enables an input 1: ADC_CHSELR register is able to sequence up to 8 channels  Note:   If CCRDY is not yet asserted after channel configuration (writing ADC_CHSELR register or changing CHSELRMOD or SCANDIR), the value written to this bit is ignored.  Bits 20:17   Reserved, must be kept at reset value. Bit 16   DISCEN : Discontinuous mode This bit is set and cleared by software to enable/disable discontinuous mode. 0: Discontinuous mode disabled 1: Discontinuous mode enabled  Note:   It is not possible to have both discontinuous mode and continuous mode enabled: it is forbidden to set both bits DISCEN   =   1 and CONT   =   1.  Bit 15   AUTOFF : Auto-off mode This bit is set and cleared by software to enable/disable auto-off mode. .  0: Auto-off mode disabled 1: Auto-off mode enabled Bit 14   WAIT : Wait conversion mode This bit is set and cleared by software to enable/disable wait conversion mode. .  0: Wait conversion mode off 1: Wait conversion mode on Bit 13   CONT : Single / continuous conversion mode This bit is set and cleared by software. If it is set, conversion takes place continuously until it is cleared. 0: Single conversion mode 1: Continuous conversion mode  Note:   It is not possible to have both discontinuous mode and continuous mode enabled: it is forbidden to set both bits DISCEN   =   1 and CONT   =   1.

RM0490 Rev 5   331/1027  RM0490   Analog-to-digital converter (ADC)  343  Bit 12   OVRMOD : Overrun management mode This bit is set and cleared by software and configure the way data overruns are managed. 0: ADC_DR register is preserved with the old data when an overrun is detected. 1: ADC_DR register is overwritten with the last conversion result when an overrun is detected. Bits 11:10   EXTEN[1:0] : External trigger enable and polarity selection These bits are set and cleared by software to select the external trigger polarity and enable the trigger. 00: Hardware trigger detection disabled (conversions can be started by software)  01: Hardware trigger detection on the rising edge  10: Hardware trigger detection on the falling edge  11: Hardware trigger detection on both the rising and falling edges Bit 9   Reserved, must be kept at reset value. Bits 8:6   EXTSEL[2:0] : External trigger selection These bits select the external event used to trigger the start of conversion (refer to   Table 68: External triggers   for details): 000: TRG0 001: TRG1 010: TRG2 011: TRG3 100: TRG4 101: TRG5 110: TRG6 111: TRG7 Bit 5   ALIGN : Data alignment This bit is set and cleared by software to select right or left alignment. Refer to   Figure 43: Data alignment and resolution (oversampling disabled: OVSE = 0) on page 307  0: Right alignment 1: Left alignment Bits 4:3   RES[1:0] : Data resolution These bits are written by software to select the resolution of the conversion. 00: 12 bits 01: 10 bits 10: 8 bits 11: 6 bits Bit 2   SCANDIR : Scan sequence direction This bit is set and cleared by software to select the direction in which the channels is scanned in the sequence. It is effective only if CHSELMOD bit is cleared. 0: Upward scan (from CHSEL0 to CHSEL22) 1: Backward scan (from CHSEL22 to CHSEL0)  Note:   If CCRDY is not yet asserted after channel configuration (writing ADC_CHSELR register or changing CHSELRMOD or SCANDIR), the value written to this bit is ignored.

Analog-to-digital converter (ADC)   RM0490  332/1027   RM0490 Rev 5  16.12.5   ADC configuration register 2 (ADC_CFGR2)  Address offset: 0x10 Reset value: 0x0000 0000 The software is allowed to program ADC_CFGR2 only when ADEN is cleared in ADC_CR. Bit 1   DMACFG : Direct memory access configuration This bit is set and cleared by software to select between two DMA modes of operation and is effective only when DMAEN = 1. 0: DMA one shot mode selected 1: DMA circular mode selected For more details, refer to   Section 16.6.5: Managing converted data using the DMA on page 309 . Bit 0   DMAEN : Direct memory access enable This bit is set and cleared by software to enable the generation of DMA requests. This allows the DMA controller to be used to manage automatically the converted data. For more details, refer to   Section 16.6.5: Managing converted data using the DMA on page 309 . 0: DMA disabled 1: DMA enabled 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 CKMODE[1:0]   LFTRI G   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   TOVS   OVSS[3:0]   OVSR[2:0]   Res.   OVSE rw   rw   rw   rw   rw   rw   rw   rw   rw  Bits 31:30   CKMODE[1:0]:   ADC clock mode These bits are set and cleared by software to define how the analog ADC is clocked: 00: ADCCLK (Asynchronous clock mode), generated at product level (refer to RCC section)  01: PCLK/2 (Synchronous clock mode) 10: PCLK/4 (Synchronous clock mode) 11: PCLK (Synchronous clock mode). This configuration must be enabled only if PCLK has a 50% duty clock cycle (APB prescaler configured inside the RCC must be bypassed and the system clock must by 50% duty cycle) In all synchronous clock modes, there is no jitter in the delay from a timer trigger to the start of a conversion.  Note:   The software is allowed to write these bits only when the ADC is disabled (ADCAL   =   0, ADSTART   =   0, ADSTP   =   0, ADDIS   =   0 and ADEN   =   0).  Bit 29   LFTRIG : Low frequency trigger mode enable This bit is set and cleared by software. 0: Low Frequency Trigger Mode disabled 1: Low Frequency Trigger Mode enabled  Note:   The software is allowed to write this bit only when ADEN bit is cleared.  Bits 28:10   Reserved, must be kept at reset value.

RM0490 Rev 5   333/1027  RM0490   Analog-to-digital converter (ADC)  343  Bit 9   TOVS : Triggered Oversampling This bit is set and cleared by software. 0: All oversampled conversions for a channel are done consecutively after a trigger 1: Each oversampled conversion for a channel needs a trigger  Note:   The software is allowed to write this bit only when ADEN bit is cleared.  Bits 8:5   OVSS[3:0] : Oversampling shift This bit is set and cleared by software. 0000: No shift 0001: Shift 1-bit 0010: Shift 2-bits 0011: Shift 3-bits 0100: Shift 4-bits 0101: Shift 5-bits 0110: Shift 6-bits 0111: Shift 7-bits 1000: Shift 8-bits Others: Reserved  Note:   The software is allowed to write this bit only when ADEN bit is cleared.  Bits 4:2   OVSR[2:0] : Oversampling ratio This bit filed defines the number of oversampling ratio. 000: 2x 001: 4x 010: 8x 011: 16x 100: 32x 101: 64x 110: 128x 111: 256x Starting from 32x, it is mandatory to use OVSS[3:0] to reduce the data size to less than 16 bits to fit to the ADC_DR register. For example, if OVSR[2:0] is configured to 32x, the data width is 17 bits, and OVSS[3:0] must be set to 1-bit shift.  Note:   The software is allowed to write this bit only when ADEN bit is cleared.  Bit 1   Reserved, must be kept at reset value. Bit 0   OVSE : Oversampler Enable This bit is set and cleared by software. 0: Oversampler disabled 1: Oversampler enabled  Note:   The software is allowed to write this bit only when ADEN bit is cleared.

Analog-to-digital converter (ADC)   RM0490  334/1027   RM0490 Rev 5  16.12.6   ADC sampling time register (ADC_SMPR)  Address offset: 0x14 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   SMPSE L22 SMPSE L21 SMPSE L20 SMPSE L19 SMPSE L18 SMPSE L17 SMPSE L16 SMPSE L15 SMPSE L14 SMPSE L13 SMPSE L12 SMPSE L11 SMPSE L10 SMPSE L9 SMPSE L8 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 SMPSE L7 SMPSE L6 SMPSE L5 SMPSE L4 SMPSE L3 SMPSE L2 SMPSE L1 SMPSE L0   Res.   SMP2[2:0]   Res.   SMP1[2:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bit 31   Reserved, must be kept at reset value. Bits 30:8   SMPSELx :   Channel-x sampling time selection (x = 22 to 0) These bits are written by software to define which sampling time is used. 0: Sampling time of CHANNELx use the setting of SMP1[2:0] register. 1: Sampling time of CHANNELx use the setting of SMP2[2:0] register.  Note:   The software is allowed to write this bit only when ADSTART   =   0 (which ensures that no conversion is ongoing). Refer to Section 16.3: ADC implementation for the maximum number of channels.  Bit 7   Reserved, must be kept at reset value. Bits 6:4   SMP2[2:0]:   Sampling time selection 2 These bits are written by software to select the sampling time that applies to all channels. 000: 1.5 ADC clock cycles 001: 3.5 ADC clock cycles 010: 7.5 ADC clock cycles 011: 12.5 ADC clock cycles 100: 19.5 ADC clock cycles 101: 39.5 ADC clock cycles 110: 79.5 ADC clock cycles 111: 160.5 ADC clock cycles  Note:   The software is allowed to write this bit only when ADSTART   =   0 (which ensures that no conversion is ongoing).  Bit 3   Reserved, must be kept at reset value. Bits 2:0   SMP1[2:0]:   Sampling time selection   1 These bits are written by software to select the sampling time that applies to all channels. 000: 1.5 ADC clock cycles 001: 3.5 ADC clock cycles 010: 7.5 ADC clock cycles 011: 12.5 ADC clock cycles 100: 19.5 ADC clock cycles 101: 39.5 ADC clock cycles 110: 79.5 ADC clock cycles 111: 160.5 ADC clock cycles  Note:   The software is allowed to write this bit only when ADSTART   =   0 (which ensures that no conversion is ongoing).

RM0490 Rev 5   335/1027  RM0490   Analog-to-digital converter (ADC)  343  16.12.7   ADC watchdog threshold register (ADC_AWD1TR)  Address offset: 0x20 Reset value: 0x0FFF 0000  16.12.8   ADC watchdog threshold register (ADC_AWD2TR)  Address offset: 0x24 Reset value: 0x0FFF 0000  16.12.9   ADC channel selection register (ADC_CHSELR)  Address offset: 0x28 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   HT1[11:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   LT1[11:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bits 31:28   Reserved, must be kept at reset value. Bits 27:16   HT1[11:0] : Analog watchdog 1 higher threshold These bits are written by software to define the higher threshold for the analog watchdog. Refer to   Section 16.8: Analog window watchdogs on page 313 . Bits 15:12   Reserved, must be kept at reset value. Bits 11:0   LT1[11:0] : Analog watchdog   1   lower threshold These bits are written by software to define the lower threshold for the analog watchdog. Refer to   Section 16.8: Analog window watchdogs on page 313 . 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   HT2[11:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   LT2[11:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bits 31:28   Reserved, must be kept at reset value. Bits 27:16   HT2[11:0] : Analog watchdog 2 higher threshold These bits are written by software to define the higher threshold for the analog watchdog. Refer to   Section 16.8: Analog window watchdogs on page 313 . Bits 15:12   Reserved, must be kept at reset value. Bits 11:0   LT2[11:0] : Analog watchdog 2 lower threshold These bits are written by software to define the lower threshold for the analog watchdog. Refer to   Section 16.8: Analog window watchdogs on page 313 .

Analog-to-digital converter (ADC)   RM0490  336/1027   RM0490 Rev 5  The same register can be used in two different modes: – Each ADC_CHSELR bit enables an input (CHSELRMOD = 0 in ADC_CFGR1). Refer to the current section. – ADC_CHSELR is able to sequence up to 8 channels (CHSELRMOD = 1 in ADC_CFGR1). Refer to next section.  CHSELRMOD = 0 in ADC_CFGR1  16.12.10   ADC channel selection register [alternate] (ADC_CHSELR)  Address offset: 0x28 Reset value: 0x0000 0000 The same register can be used in two different modes: – Each ADC_CHSELR bit enables an input (CHSELRMOD = 0 in ADC_CFGR1). Refer to the current previous section. – ADC_CHSELR is able to sequence up to 8 channels (CHSELRMOD = 1 in ADC_CFGR1). Refer to this section.  CHSELRMOD = 1 in ADC_CFGR1:  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CHSEL 22 CHSEL 21 CHSEL 20 CHSEL 19 CHSEL 18 CHSEL 17 CHSEL 16 rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CHSEL 15 CHSEL 14 CHSEL 13 CHSEL 12 CHSEL 11 CHSEL 10 CHSEL 9 CHSEL 8 CHSEL 7 CHSEL 6 CHSEL 5 CHSEL 4 CHSEL 3 CHSEL 2 CHSEL 1 CHSEL 0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bits 31:23   Reserved, must be kept at reset value. Bits 22:0   CHSEL[22:0] : Channel-x selection These bits are written by software and define which channels are part of the sequence of channels to be converted. Refer to   Figure 35: ADC connectivity   for ADC inputs connected to external channels and internal sources. 0: Input Channel-x is not selected for conversion 1: Input Channel-x is selected for conversion  Note:   The software is allowed to write this bit only when ADSTART   =   0 (which ensures that no conversion is ongoing). If CCRDY is not yet asserted after channel configuration (writing ADC_CHSELR register or changing CHSELRMOD or SCANDIR), the value written to this bit is ignored.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 SQ8[3:0]   SQ7[3:0]   SQ6[3:0]   SQ5[3:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 SQ4[3:0]   SQ3[3:0]   SQ2[3:0]   SQ1[3:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

RM0490 Rev 5   337/1027  RM0490   Analog-to-digital converter (ADC)  343  Bits 31:28   SQ8[3:0] : 8th conversion of the sequence These bits are programmed by software with the channel number (0...14) assigned to the 8th conversion of the sequence. 0b1111 indicates the end of the sequence. When 0b1111 (end of sequence) is programmed to the lower sequence channels, these bits are ignored. 0000: CH0 0001: CH1 ... 1100: CH12 1101: CH13 1110: CH14 1111: No channel selected (End of sequence)  Note:   The software is allowed to write this bit only when ADSTART   =   0 (which ensures that no conversion is ongoing).  Bits 27:24   SQ7[3:0] : 7th conversion of the sequence These bits are programmed by software with the channel number (0...14) assigned to the 8th conversion of the sequence. 0b1111 indicates end of the sequence. When 0b1111 (end of sequence) is programmed to the lower sequence channels, these bits are ignored. Refer to SQ8[3:0] for a definition of channel selection.  Note:   The software is allowed to write this bit only when ADSTART   =   0 (which ensures that no conversion is ongoing).  Bits 23:20   SQ6[3:0] : 6th conversion of the sequence These bits are programmed by software with the channel number (0...14) assigned to the 8th conversion of the sequence. 0b1111 indicates end of the sequence. When 0b1111 (end of sequence) is programmed to the lower sequence channels, these bits are ignored. Refer to SQ8[3:0] for a definition of channel selection.  Note:   The software is allowed to write this bit only when ADSTART   =   0 (which ensures that no conversion is ongoing).  Bits 19:16   SQ5[3:0] : 5th conversion of the sequence These bits are programmed by software with the channel number (0...14) assigned to the 8th conversion of the sequence. 0b1111 indicates end of the sequence. When 0b1111 (end of sequence) is programmed to the lower sequence channels, these bits are ignored. Refer to SQ8[3:0] for a definition of channel selection.  Note:   The software is allowed to write this bit only when ADSTART   =   0 (which ensures that no conversion is ongoing).  Bits 15:12   SQ4[3:0] : 4th conversion of the sequence These bits are programmed by software with the channel number (0...14) assigned to the 8th conversion of the sequence. 0b1111 indicates end of the sequence. When 0b1111 (end of sequence) is programmed to the lower sequence channels, these bits are ignored. Refer to SQ8[3:0] for a definition of channel selection.  Note:   The software is allowed to write this bit only when ADSTART   =   0 (which ensures that no conversion is ongoing).

Analog-to-digital converter (ADC)   RM0490  338/1027   RM0490 Rev 5  16.12.11   ADC watchdog threshold register (ADC_AWD3TR)  Address offset: 0x2C Reset value: 0x0FFF 0000 Bits 11:8   SQ3[3:0] : 3rd conversion of the sequence These bits are programmed by software with the channel number (0...14) assigned to the 8th conversion of the sequence. 0b1111 indicates end of the sequence. When 0b1111 (end of sequence) is programmed to the lower sequence channels, these bits are ignored. Refer to SQ8[3:0] for a definition of channel selection.  Note:   The software is allowed to write this bit only when ADSTART   =   0 (which ensures that no conversion is ongoing).  Bits 7:4   SQ2[3:0] : 2nd conversion of the sequence These bits are programmed by software with the channel number (0...14) assigned to the 8th conversion of the sequence. 0b1111 indicates end of the sequence. When 0b1111 (end of sequence) is programmed to the lower sequence channels, these bits are ignored. Refer to SQ8[3:0] for a definition of channel selection.  Note:   The software is allowed to write this bit only when ADSTART   =   0 (which ensures that no conversion is ongoing).  Bits 3:0   SQ1[3:0] : 1st conversion of the sequence These bits are programmed by software with the channel number (0...14) assigned to the 8th conversion of the sequence. 0b1111 indicates end of the sequence. When 0b1111 (end of sequence) is programmed to the lower sequence channels, these bits are ignored. Refer to SQ8[3:0] for a definition of channel selection.  Note:   The software is allowed to write this bit only when ADSTART   =   0 (which ensures that no conversion is ongoing).  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   HT3[11:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   LT3[11:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bits 31:28   Reserved, must be kept at reset value. Bits 27:16   HT3[11:0] : Analog watchdog 3 higher threshold These bits are written by software to define the higher threshold for the analog watchdog. Refer to   Section 16.8: Analog window watchdogs on page 313 . Bits 15:12   Reserved, must be kept at reset value. Bits 11:0   LT3[11:0] : Analog watchdog   3 lower threshold These bits are written by software to define the lower threshold for the analog watchdog. Refer to   Section 16.8: Analog window watchdogs on page 313 .

RM0490 Rev 5   339/1027  RM0490   Analog-to-digital converter (ADC)  343  16.12.12   ADC data register (ADC_DR)  Address offset: 0x40 Reset value: 0x0000 0000  16.12.13   ADC analog watchdog 2 configuration register (ADC_AWD2CR)  Address offset: 0xA0 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 DATA[15:0] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r  Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   DATA[15:0] : Converted data These bits are read-only. They contain the conversion result from the last converted channel. The data are left- or right-aligned as shown in   Figure 43 . Just after a calibration is complete, DATA[6:0] contains the calibration factor. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   AWD2 CH22 AWD2 CH21 AWD2 CH20 AWD2 CH19 AWD2 CH18 AWD2 CH17 AWD2 CH16 rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 AWD2 CH15 AWD2 CH14 AWD2 CH13 AWD2 CH12 AWD2 CH11 AWD2 CH10 AWD2 CH9 AWD2 CH8 AWD2 CH7 AWD2 CH6 AWD2 CH5 AWD2 CH4 AWD2 CH3 AWD2 CH2 AWD2 CH1 AWD2 CH0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bits 31:23   Reserved, must be kept at reset value. Bits 22:0   AWD2CH[22:0]:   Analog watchdog channel selection These bits are set and cleared by software. They enable and select the input channels to be guarded by analog watchdog 2 (AWD2). 0: ADC analog channel-x is not monitored by AWD2 1: ADC analog channel-x is monitored by AWD2  Note:   The channels selected through ADC_AWD2CR must be also configured into the ADC_CHSELR registers. The software is allowed to write this bit only when ADEN   =   0.

Analog-to-digital converter (ADC)   RM0490  340/1027   RM0490 Rev 5  16.12.14   ADC Analog Watchdog 3 Configuration register (ADC_AWD3CR)  Address offset: 0xA4 Reset value: 0x0000 0000  16.12.15   ADC calibration factor (ADC_CALFACT)  Address offset: 0xB4 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   AWD3 CH22 AWD3 CH21 AWD3 CH20 AWD3 CH19 AWD3 CH18 AWD3 CH17 AWD3 CH16 rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 AWD3 CH15 AWD3 CH14 AWD3 CH13 AWD3 CH12 AWD3 CH11 AWD3 CH10 AWD3 CH9 AWD3 CH8 AWD3 CH7 AWD3 CH6 AWD3 CH5 AWD3 CH4 AWD3 CH3 AWD3 CH2 AWD3 CH1 AWD3 CH0 rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bits 31:23   Reserved, must be kept at reset value. Bits 22:0   AWD3CH[22:0]:   Analog watchdog channel selection These bits are set and cleared by software. They enable and select the input channels to be guarded by analog watchdog 3 (AWD3). 0: ADC analog channel-x is not monitored by AWD3 1: ADC analog channel-x is monitored by AWD3  Note:   The channels selected through ADC_AWD3CR must be also configured into the ADC_CHSELR registers. The software is allowed to write this bit only when ADEN = 0.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CALFACT[6:0] rw   rw   rw   rw   rw   rw   rw  Bits 31:7   Reserved, must be kept at reset value. Bits 6:0   CALFACT[6:0] : Calibration factor These bits are written by hardware or by software. – Once a calibration is complete, they are updated by hardware with the calibration factors. – Software can write these bits with a new calibration factor. If the new calibration factor is different from the current one stored into the analog ADC, it is then applied once a new conversion is launched. – Just after a calibration is complete, DATA[6:0] contains the calibration factor.  Note:   Software can write these bits only when ADEN=1 (ADC is enabled and no calibration is ongoing and no conversion is ongoing).

RM0490 Rev 5   341/1027  RM0490   Analog-to-digital converter (ADC)  343  16.12.16   ADC common configuration register (ADC_CCR)  Address offset: 0x308 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TSEN   VREFEN   PRESC[3:0]   Res.   Res. rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.  Bits 31:25   Reserved, must be kept at reset value. Bit 24   Reserved, must be kept at reset value. Bit 23   TSEN : Temperature sensor buffer enable This bit is set and cleared by software to enable/disable the temperature sensor buffer. 0: Temperature sensor buffer disabled 1: Temperature sensor buffer enabled  Note:   Software is allowed to write this bit only when ADSTART   =   0 (which ensures that no conversion is ongoing). This bit must be cleared before entering low-power modes to avoid unwanted power consumption.  Bit 22   VREFEN : V REFINT   buffer enable This bit is set and cleared by software to enable/disable the V   REFINT   buffer. 0: V REFINT   buffer disabled 1: V REFINT   buffer enabled  Note:   Software is allowed to write this bit only when ADSTART   =   0 (which ensures that no conversion is ongoing). This bit must be cleared before entering low-power modes to avoid unwanted power consumption.  Bits 21:18   PRESC[3:0]:   ADC prescaler Set and cleared by software to select the frequency of the clock to the ADC. 0000: input ADC clock not divided 0001: input ADC clock divided by 2 0010: input ADC clock divided by 4 0011: input ADC clock divided by 6 0100: input ADC clock divided by 8 0101: input ADC clock divided by 10 0110: input ADC clock divided by 12 0111: input ADC clock divided by 16 1000: input ADC clock divided by 32 1001: input ADC clock divided by 64 1010: input ADC clock divided by 128 1011: input ADC clock divided by 256 Other: Reserved  Note:   Software is allowed to write these bits only when the ADC is disabled (ADCAL   =   0, ADSTART   =   0, ADSTP   =   0, ADDIS   =   0 and ADEN   =   0).  Bits 17:0   Reserved, must be kept at reset value.

Analog-to-digital converter (ADC)   RM0490  342/1027   RM0490 Rev 5  16.13   ADC register map  The following table summarizes the ADC registers.  Table 76. ADC register map and reset values Offset   Register name Reset value 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00  ADC_ISR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CCRDY Res. EOCAL Res. AWD3 AWD2 AWD1 Res. Res. OVR EOS EOC EOSMP ADRDY Reset value   0   0   0   0   0   0   0   0   0   0 0x04  ADC_IER  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CCRDYIE Res. EOCALIE Res. AWD3IE AWD2IE AWD1IE Res. Res. OVRIE EOSIE EOCIE EOSMPIE ADRDYIE Reset value   0   0   0   0   0   0   0   0   0   0 0x08  ADC_CR  ADCAL Res. Res. ADVREGEN Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. ADSTP Res. ADSTART ADDIS ADEN Reset value   0   0   0   0   0   0 0x0C  ADC_CFGR1  Res. AWDCH[4:0] Res. Res. AWD1EN AWD1SGL CHSELRMOD Res. Res. Res. Res. DISCEN AUTOFF WAIT CONT OVRMOD EXTEN[1:0] Res.   EXTSEL [2:0] ALIGN RES [1:0] SCANDIR DMACFG DMAEN Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x10  ADC_CFGR2  CKMODE[1:0] LFTRIG Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TOVS OVSS[3:0] OVSR[2:0] Res. OVSE Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0 0x14  ADC_SMPR  Res. SMPSEL22. SMPSEL21. SMPSEL20. SMPSEL19. SMPSEL18. SMPSEL17 SMPSEL16 SMPSEL15 SMPSEL14 SMPSEL13 SMPSEL12 SMPSEL11 SMPSEL10 SMPSEL9 SMPSEL8 SMPSEL7 SMPSEL6 SMPSEL5 SMPSEL4 SMPSEL3 SMPSEL2 SMPSEL1 SMPSEL0 Res.   SMP2 [2:0] Res.   SMP1 [2:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x18   Reserved   Reserved 0x1C   Reserved   Reserved 0x20  ADC_AWD1TR  Res. Res. Res. Res. HT1[11:0] Res. Res. Res. Res. LT1[11:0] Reset value   1   1   1   1   1   1   1   1   1   1   1   1   0   0   0   0   0   0   0   0   0   0   0   0 0x24  ADC_AWD2TR  Res. Res. Res. Res. HT2[11:0] Res. Res. Res. Res. LT2[11:0] Reset value   1   1   1   1   1   1   1   1   1   1   1   1   0   0   0   0   0   0   0   0   0   0   0   0 0x28  ADC_CHSELR  (CHSELRMOD= 0) Res. Res. Res. Res. Res. Res. Res. Res. Res. CHSEL22 CHSEL21 CHSEL20 CHSEL19 CHSEL18 CHSEL17 CHSEL16 CHSEL15 CHSEL14 CHSEL13 CHSEL12 CHSEL11 CHSEL10 CHSEL9 CHSEL8 CHSEL7 CHSEL6 CHSEL5 CHSEL4 CHSEL3 CHSEL2 CHSEL1 CHSEL0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0

RM0490 Rev 5   343/1027  RM0490   Analog-to-digital converter (ADC)  343  Refer to   Section 2.2   for the register boundary addresses. 0x28  ADC_CHSELR  (CHSELRMOD= 1) SQ8[3:0]   SQ7[3:0]   SQ6[3:0]   SQ5[3:0]   SQ4[3:0]   SQ3[3:0]   SQ2[3:0]   SQ1[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x2C  ADC_AWD3TR  Res. Res. Res. Res. HT3[11:0] Res. Res. Res. Res. LT3[11:0] Reset value   1   1   1   1   1   1   1   1   1   1   1   1   0   0   0   0   0   0   0   0   0   0   0   0 0x30 0x34 0x38 0x3C Reserved   Reserved 0x40  ADC_DR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DATA[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 ...   Reserved   Reserved 0xA0   ADC_AWD2CR  Res. Res. Res. Res. Res. Res. Res. Res. Res. AWD2CH22 AWD2CH21 AWD2CH20 AWD2CH19 AWD2CH18 AWD2CH17 AWD2CH16 AWD2CH15 AWD2CH14 AWD2CH13 AWD2CH12 AWD2CH11 AWD2CH10 AWD2CH9 AWD2CH8 AWD2CH7 AWD2CH6 AWD2CH5 AWD2CH4 AWD2CH3 AWD2CH2 AWD2CH1 AWD2CH0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0xA4  ADC_AWD3CR  Res. Res. Res. Res. Res. Res. Res. Res. Res. AWD3CH22 AWD3CH21 AWD3CH20 AWD3CH19 AWD3CH18 AWD3CH17 AWD3CH16 AWD3CH15 AWD3CH14 AWD3CH13 AWD3CH12 AWD3CH11 AWD3CH10 AWD3CH9 AWD3CH8 AWD3CH7 AWD3CH6 AWD3CH5 AWD3CH4 AWD3CH3 AWD3CH2 AWD3CH1 AWD3CH0 Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 ...   Reserved   Reserved 0xB4  ADC_CALFACT  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CALFACT[6:0] Reset value   0   0   0   0   0   0   0 ...   Reserved   Reserved 0x308  ADC_CCR  Res. Res. Res. Res. Res. Res. Res. Res. TSEN VREFEN PRESC3 PRESC2 PRESC1 PRESC0 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Reset value   0   0   0   0   0   0  Table 76. ADC register map and reset values (continued) Offset   Register name Reset value 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

Advanced-control timer (TIM1)   RM0490  344/1027   RM0490 Rev 5  17   Advanced-control timer (TIM1)  In this section, “TIMx” should be understood as “TIM1” since there is only one instance of this type of timer for the products to which this reference manual applies.  17.1   TIM1 introduction  The advanced-control timer (TIM1) consists of a 16-bit auto-reload counter driven by a programmable prescaler. It may be used for a variety of purposes, including measuring the pulse lengths of input signals (input capture) or generating output waveforms (output compare, PWM, complementary PWM with dead-time insertion). Pulse lengths and waveform periods can be modulated from a few microseconds to several milliseconds using the timer prescaler and the RCC clock controller prescalers. The advanced-control (TIM1) and general-purpose (TIMy) timers are completely independent, and do not share any resources. They can be synchronized together as described in   Section 17.3.26: Timer synchronization .

RM0490 Rev 5   345/1027  RM0490   Advanced-control timer (TIM1)  442  17.2   TIM1 main features  TIM1 timer features include:  •   16-bit up, down, up/down auto-reload counter.  •   16-bit programmable prescaler allowing dividing (also “on the fly”) the counter clock frequency either by any factor between 1 and 65536.  •   Up to 6 independent channels for: –   Input Capture (but channels 5 and 6) –   Output Compare –   PWM generation (Edge and Center-aligned Mode) –   One-pulse mode output  •   Complementary outputs with programmable dead-time  •   Synchronization circuit to control the timer with external signals and to interconnect several timers together.  •   Repetition counter to update the timer registers only after a given number of cycles of the counter.  •   2 break inputs to put the timer’s output signals in a safe user selectable configuration.  •   Interrupt/DMA generation on the following events: –   Update: counter overflow/underflow, counter initialization (by software or internal/external trigger) –   Trigger event (counter start, stop, initialization or count by internal/external trigger) –   Input capture –   Output compare  •   Supports incremental (quadrature) encoder and Hall-sensor circuitry for positioning purposes  •   Trigger input for external clock or cycle-by-cycle current management

Advanced-control timer (TIM1)   RM0490  346/1027   RM0490 Rev 5  Figure 57. Advanced-control timer block diagram  1.   The internal break event source can be: -   A clock failure event generated by CSS. For further information on the CSS, refer to   Section 6.2.7: Clock security system (CSS)  -   SRAM parity error signal -   Cortex   ® -M0+ LOCKUP (Hardfault) output.  MSv40115V4 U U U CC1I CC2I Trigger controller +/- Stop, clear or up/down TI1FP1 TI2FP2 ITR[0..15] TRGI Output control DTG TRGO OC1REF OC2REF REP register U Repetition counter UI Reset, enable, up/down, count CK_PSC IC1 IC2   IC2PS IC1PS TI1FP1 TRG TRC TRC ITR TRC TI1F_ED CC1I CC2I TI1FP2 TI2FP1 TI2FP2 TI1 TIMx_CH1   OC1 TIMx_CH1 TIMx_CH1N OC1N to other timers to peripherals Slave controller mode PSC prescaler   CNT counter Internal clock (CK_INT) CK_CNT from RCC DTG registers Capture/Compare 1 register Notes: Reg   Preload registers transferred to active registers on U event according to control bit Event Interrupt & DMA output TIMx_BKIN Internal sources Auto-reload register Capture/Compare 2 register Prescaler Prescaler Output control Encoder Interface Polarity selection & edgedetector & prescaler Input filter ETRF ETRP ETR TIMx_ETR U U CC3I CC4I Output control DTG OC3REF OC4REF IC3 IC4   IC4PS IC3PS TI3FP3 TRC TRC CC3I CC4I TI3FP4 TI4FP3 TI4FP4 OC3 OC4 TIMx_CH3 TIMx_CH4 TIMx_CH3N OC3N Capture/Compare 3 register Capture/Compare 4 register Prescaler Prescaler Output control DTG OC2 TIMx_CH2 TIMx_CH2N OC2N OC5REF   OC5 Capture/Compare 5 register   Output control OC6REF   OC6 Capture/Compare 6 register   Output control Break and Break2 circuitry (1) TIMx_BKIN2 ETRF SBIF BIF B2IF BRK request BRK2 request TI1[1..15] TI1[0] XOR Input filter & edge detector Input filter & edge detector Input filter & edge detector Input filter & edge detector TIMx_CH2 TI2[1..15] TI2[0] TI2 TIMx_CH3 TI3[1..15] TI3[0] TI3 TIMx_CH4 TI4[1..15] TI4[0] TI4 On-chip ETR sources

RM0490 Rev 5   347/1027  RM0490   Advanced-control timer (TIM1)  442  17.3   TIM1 functional description 17.3.1   Time-base unit  The main block of the programmable advanced-control timer is a 16-bit counter with its related auto-reload register. The counter can count up, down or both up and down. The counter clock can be divided by a prescaler. The counter, the auto-reload register and the prescaler register can be written or read by software. This is true even when the counter is running. The time-base unit includes:  •   Counter register (TIMx_CNT)  •   Prescaler register (TIMx_PSC)  •   Auto-reload register (TIMx_ARR)  •   Repetition counter register (TIMx_RCR) The auto-reload register is preloaded. Writing to or reading from the auto-reload register accesses the preload register. The content of the preload register are transferred into the shadow register permanently or at each update event (UEV), depending on the auto-reload preload enable bit (ARPE) in TIMx_CR1 register. The update event is sent when the counter reaches the overflow (or underflow when downcounting) and if the UDIS bit equals 0 in the TIMx_CR1 register. It can also be generated by software. The generation of the update event is described in detailed for each configuration. The counter is clocked by the prescaler output CK_CNT, which is enabled only when the counter enable bit (CEN) in TIMx_CR1 register is set (refer also to the slave mode controller description to get more details on counter enabling). Note that the counter starts counting 1 clock cycle after setting the CEN bit in the TIMx_CR1 register.  Prescaler description  The prescaler can divide the counter clock frequency by any factor between 1 and 65536. It is based on a 16-bit counter controlled through a 16-bit register (in the TIMx_PSC register). It can be changed on the fly as this control register is buffered. The new prescaler ratio is taken into account at the next update event.  Figure 58   and   Figure 59   give some examples of the counter behavior when the prescaler ratio is changed on the fly:

Advanced-control timer (TIM1)   RM0490  348/1027   RM0490 Rev 5  Figure 58. Counter timing diagram with prescaler division change from 1 to 2 Figure 59. Counter timing diagram with prescaler division change from 1 to 4  CK_PSC 00 CEN Timerclock = CK_CNT Counter register Update event (UEV) 0 Prescaler control register   1 0 Write a new value in TIMx_PSC Prescaler buffer   1 0 Prescaler counter   0   1   0   1   0   1   0   1 01   02   03 FA   FB F7   F8   F9   FC MS31076V2  0 3 0 0   1   2   3   0   1   2   3 MS31077V2 CK_PSC CEN Timerclock = CK_CNT Counter register Update event (UEV) Prescaler control register Write a new value in TIMx_PSC Prescaler buffer Prescaler counter 00   01 FA   FB F7   F8   F9   FC 3 0

RM0490 Rev 5   349/1027  RM0490   Advanced-control timer (TIM1)  442  17.3.2   Counter modes Upcounting mode  In upcounting mode, the counter counts from 0 to the auto-reload value (content of the TIMx_ARR register), then restarts from 0 and generates a counter overflow event. If the repetition counter is used, the update event (UEV) is generated after upcounting is repeated for the number of times programmed in the repetition counter register (TIMx_RCR) + 1. Else the update event is generated at each counter overflow. Setting the UG bit in the TIMx_EGR register (by software or by using the slave mode controller) also generates an update event. The UEV event can be disabled by software by setting the UDIS bit in the TIMx_CR1 register. This is to avoid updating the shadow registers while writing new values in the preload registers. Then no update event occurs until the UDIS bit has been written to 0. However, the counter restarts from 0, as well as the counter of the prescaler (but the prescale rate does not change). In addition, if the URS bit (update request selection) in TIMx_CR1 register is set, setting the UG bit generates an update event UEV but without setting the UIF flag (thus no interrupt or DMA request is sent). This is to avoid generating both update and capture interrupts when clearing the counter on the capture event. When an update event occurs, all the registers are updated and the update flag (UIF bit in TIMx_SR register) is set (depending on the URS bit):  •   The repetition counter is reloaded with the content of TIMx_RCR register,  •   The auto-reload shadow register is updated with the preload value (TIMx_ARR),  •   The buffer of the prescaler is reloaded with the preload value (content of the TIMx_PSC register). The following figures show some examples of the counter behavior for different clock frequencies when TIMx_ARR=0x36.

Advanced-control timer (TIM1)   RM0490  350/1027   RM0490 Rev 5  Figure 60. Counter timing diagram, internal clock divided by 1 Figure 61. Counter timing diagram, internal clock divided by 2  00   02   03   04   05   06   07 32   33   34   35   36 31 MS31078V2 CK_PSC CNT_EN Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 01  MS31079V2 CK_PSC CNT_EN Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 0034   0035   0036   0000   0001   0002   0003

RM0490 Rev 5   351/1027  RM0490   Advanced-control timer (TIM1)  442  Figure 62. Counter timing diagram, internal clock divided by 4 Figure 63. Counter timing diagram, internal clock divided by N  0000   0001 0035   0036 MS31080V2 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) CNT_EN  00 1F   20 MS31081V2 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF)

Advanced-control timer (TIM1)   RM0490  352/1027   RM0490 Rev 5  Figure 64. Counter timing diagram, update event when ARPE=0 (TIMx_ARR not preloaded) Figure 65. Counter timing diagram, update event when ARPE=1 (TIMx_ARR preloaded)  FF   36  MS31082V3  CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 00   02   03   04   05   06   07 32   33   34   35   36 31   01 CEN Auto-reload preload register Write a new value in TIMx_ARR  MS31083V2 F5   36 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 00   02   03   04   05   06   07 F1   F2   F3   F4   F5 F0   01 CEN Auto-reload preload register Write a new value in TIMx_ARR Auto-reload shadow register   F5   36

RM0490 Rev 5   353/1027  RM0490   Advanced-control timer (TIM1)  442  Downcounting mode  In downcounting mode, the counter counts from the auto-reload value (content of the TIMx_ARR register) down to 0, then restarts from the auto-reload value and generates a counter underflow event. If the repetition counter is used, the update event (UEV) is generated after downcounting is repeated for the number of times programmed in the repetition counter register (TIMx_RCR) + 1. Else the update event is generated at each counter underflow. Setting the UG bit in the TIMx_EGR register (by software or by using the slave mode controller) also generates an update event. The UEV update event can be disabled by software by setting the UDIS bit in TIMx_CR1 register. This is to avoid updating the shadow registers while writing new values in the preload registers. Then no update event occurs until UDIS bit has been written to 0. However, the counter restarts from the current auto-reload value, whereas the counter of the prescaler restarts from 0 (but the prescale rate doesn’t change). In addition, if the URS bit (update request selection) in TIMx_CR1 register is set, setting the UG bit generates an update event UEV but without setting the UIF flag (thus no interrupt or DMA request is sent). This is to avoid generating both update and capture interrupts when clearing the counter on the capture event. When an update event occurs, all the registers are updated and the update flag (UIF bit in TIMx_SR register) is set (depending on the URS bit):  •   The repetition counter is reloaded with the content of TIMx_RCR register.  •   The buffer of the prescaler is reloaded with the preload value (content of the TIMx_PSC register).  •   The auto-reload active register is updated with the preload value (content of the TIMx_ARR register). Note that the auto-reload is updated before the counter is reloaded, so that the next period is the expected one. The following figures show some examples of the counter behavior for different clock frequencies when TIMx_ARR=0x36.

Advanced-control timer (TIM1)   RM0490  354/1027   RM0490 Rev 5  Figure 66. Counter timing diagram, internal clock divided by 1 Figure 67. Counter timing diagram, internal clock divided by 2  36   34   33   32   31   30   2F 04   03   02   01   00 05 MS31184V1 CK_PSC CNT_EN Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow (cnt_udf) Update interrupt flag (UIF) 35  MS31185V1 CK_PSC CNT_EN Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow Update interrupt flag (UIF) 0002   0001   0000   0036   0035   0034   0033

RM0490 Rev 5   355/1027  RM0490   Advanced-control timer (TIM1)  442  Figure 68. Counter timing diagram, internal clock divided by 4 Figure 69. Counter timing diagram, internal clock divided by N  0000   0001 0001   0000 MS31186V1 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow Update interrupt flag (UIF) CNT_EN  00 1F 20 MS31187V1 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow Update interrupt flag (UIF) 36

Advanced-control timer (TIM1)   RM0490  356/1027   RM0490 Rev 5  Figure 70. Counter timing diagram, update event when repetition counter is not used Center-aligned mode (up/down counting)  In center-aligned mode, the counter counts from 0 to the auto-reload value (content of the TIMx_ARR register) – 1, generates a counter overflow event, then counts from the auto- reload value down to 1 and generates a counter underflow event. Then it restarts counting from 0. Center-aligned mode is active when the CMS bits in TIMx_CR1 register are not equal to '00'. The Output compare interrupt flag of channels configured in output is set when: the counter counts down (Center aligned mode 1, CMS = "01"), the counter counts up (Center aligned mode 2, CMS = "10") the counter counts up and down (Center aligned mode 3, CMS = "11"). In this mode, the DIR direction bit in the TIMx_CR1 register cannot be written. It is updated by hardware and gives the current direction of the counter. The update event can be generated at each counter overflow and at each counter underflow or by setting the UG bit in the TIMx_EGR register (by software or by using the slave mode controller) also generates an update event. In this case, the counter restarts counting from 0, as well as the counter of the prescaler. The UEV update event can be disabled by software by setting the UDIS bit in the TIMx_CR1 register. This is to avoid updating the shadow registers while writing new values in the preload registers. Then no update event occurs until UDIS bit has been written to 0. However, the counter continues counting up and down, based on the current auto-reload value. In addition, if the URS bit (update request selection) in TIMx_CR1 register is set, setting the UG bit generates an UEV update event but without setting the UIF flag (thus no interrupt or  FF   36 MS31188V1 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow Update interrupt flag (UIF) 00 02 03 04 05   30   2F 32 33 34 35 36   31 01 CEN Auto-reload preload register Write a new value in TIMx_ARR

RM0490 Rev 5   357/1027  RM0490   Advanced-control timer (TIM1)  442  DMA request is sent). This is to avoid generating both update and capture interrupts when clearing the counter on the capture event. When an update event occurs, all the registers are updated and the update flag (UIF bit in TIMx_SR register) is set (depending on the URS bit):  •   The repetition counter is reloaded with the content of TIMx_RCR register  •   The buffer of the prescaler is reloaded with the preload value (content of the TIMx_PSC register)  •   The auto-reload active register is updated with the preload value (content of the TIMx_ARR register). Note that if the update source is a counter overflow, the auto- reload is updated before the counter is reloaded, so that the next period is the expected one (the counter is loaded with the new value). The following figures show some examples of the counter behavior for different clock frequencies.  Figure 71. Counter timing diagram, internal clock divided by 1, TIMx_ARR = 0x6  1.   Here, center-aligned mode 1 is used (for more details refer to   Section 17.4: TIM1 registers ).  MS31189V3 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) CEN Counter underflow 00 02 03 04   05   06 01   02   03   04 01   05   03 04

Advanced-control timer (TIM1)   RM0490  358/1027   RM0490 Rev 5  Figure 72. Counter timing diagram, internal clock divided by 2 Figure 73. Counter timing diagram, internal clock divided by 4, TIMx_ARR=0x36  MS31190V1 CK_PSC CNT_EN Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow Update interrupt flag (UIF) 0003   0002   0001   0000   0001   0002   0003  0034   0035 MS31191V1 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) CNT_EN Note: Here, center_aligned mode 2 or 3 is updated with an UIF on overflow 0036   0035

RM0490 Rev 5   359/1027  RM0490   Advanced-control timer (TIM1)  442  Figure 74. Counter timing diagram, internal clock divided by N Figure 75. Counter timing diagram, update event with ARPE=1 (counter underflow)  00 1F 20 MS31192V1 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow Update interrupt flag (UIF) 01  FD   36 MS31193V1 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow Update interrupt flag (UIF) 00   02   03   04   05   06   07 01 CEN Auto-reload preload register Write a new value in TIMx_ARR 06   05   04   03   02   01 FD   36 Auto-reload active register

Advanced-control timer (TIM1)   RM0490  360/1027   RM0490 Rev 5  Figure 76. Counter timing diagram, Update event with ARPE=1 (counter overflow) 17.3.3   Repetition counter  Section 17.3.1: Time-base unit   describes how the update event (UEV) is generated with respect to the counter overflows/underflows. It is actually generated only when the repetition counter has reached zero. This can be useful when generating PWM signals. This means that data are transferred from the preload registers to the shadow registers (TIMx_ARR auto-reload register, TIMx_PSC prescaler register, but also TIMx_CCRx capture/compare registers in compare mode) every N+1 counter overflows or underflows, where N is the value in the TIMx_RCR repetition counter register. The repetition counter is decremented:  •   At each counter overflow in upcounting mode,  •   At each counter underflow in downcounting mode,  •   At each counter overflow and at each counter underflow in center-aligned mode. Although this limits the maximum number of repetition to 32768 PWM cycles, it makes it possible to update the duty cycle twice per PWM period. When refreshing compare registers only once per PWM period in center-aligned mode, maximum resolution is 2xT ck   , due to the symmetry of the pattern. The repetition counter is an auto-reload type; the repetition rate is maintained as defined by the TIMx_RCR register value (refer to   Figure 77 ). When the update event is generated by software (by setting the UG bit in TIMx_EGR register) or by hardware through the slave mode controller, it occurs immediately whatever the value of the repetition counter is and the repetition counter is reloaded with the content of the TIMx_RCR register.  MS31194V1 FD   36 CK_PSC Timer clock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 36   34   33   32   31   30   2F F8   F9   FA   FB   FC F7   35 CEN Auto-reload preload register Write a new value in TIMx_ARR Auto-reload active register   FD   36

RM0490 Rev 5   361/1027  RM0490   Advanced-control timer (TIM1)  442  In Center aligned mode, for odd values of RCR, the update event occurs either on the overflow or on the underflow depending on when the RCR register was written and when the counter was launched: if the RCR was written before launching the counter, the UEV occurs on the underflow. If the RCR was written after launching the counter, the UEV occurs on the overflow. For example, for RCR = 3, the UEV is generated each 4th overflow or underflow event depending on when the RCR was written.  Figure 77. Update rate examples depending on mode and TIMx_RCR register settings  MSv31195V1  UEV UEV UEV UEV UEV  Counter-aligned mode   Edge-aligned mode Upcounting   Downcounting (by SW) (by SW) (by SW) TIMx_RCR = 3 and re-synchronization TIMx_RCR = 3 TIMx_RCR = 2 TIMx_RCR = 1 TIMx_RCR = 0 Counter TIMx_CNT  UEV   Update event : Preload registers transferred to active registers and update interrupt generated  Update Event   if the repetition counter underflow occurs when the counter is equal to the auto-reload value.

Advanced-control timer (TIM1)   RM0490  362/1027   RM0490 Rev 5  17.3.4   External trigger input  The timer features an external trigger input ETR. It can be used as:  •   external clock (external clock mode 2, see   Section 17.3.5 )  •   trigger for the slave mode (see   Section 17.3.26 )  •   PWM reset input for cycle-by-cycle current regulation (see   Section 17.3.7 )  Figure 78   below describes the ETR input conditioning. The input polarity is defined with the ETP bit in TIMxSMCR register. The trigger can be prescaled with the divider programmed by the ETPS[1:0] bitfield and digitally filtered with the ETF[3:0] bitfield.  Figure 78. External trigger input block  The ETR input comes from multiple sources: input pins (default configuration) and analog watchdogs. The selection is done with the ETRSEL[3:0] bitfield.  Figure 79. TIM1 ETR input circuitry  MS34403V2 To the Output mode controller To the CK_PSC circuitry To the Slave mode controller 0 1 ETR input   ETR ETP TIMx_SMCR Divider /1, /2, /4, /8 ETPS[1:0] TIMx_SMCR Filter downcounter ETF[3:0] TIMx_SMCR ETRP f DTS  MSv50978V1 TIM1_AF1[17:14] ETR input ETR inputs from AF controller NC ADC1 AWD1 ADC1 AWD2 ADC1 AWD3

RM0490 Rev 5   363/1027  RM0490   Advanced-control timer (TIM1)  442  17.3.5   Clock selection  The counter clock can be provided by the following clock sources:  •   Internal clock (CK_INT)  •   External clock mode1: external input pin  •   External clock mode2: external trigger input ETR  •   Encoder mode  Internal clock source (CK_INT)  If the slave mode controller is disabled (SMS=000), then the CEN, DIR (in the TIMx_CR1 register) and UG bits (in the TIMx_EGR register) are actual control bits and can be changed only by software (except UG which remains cleared automatically). As soon as the CEN bit is written to 1, the prescaler is clocked by the internal clock CK_INT.  Figure 80   shows the behavior of the control circuit and the upcounter in normal mode, without prescaler.  Figure 80. Control circuit in normal mode, internal clock divided by 1 External clock source mode 1  This mode is selected when SMS=111 in the TIMx_SMCR register.   The counter can count at each rising or falling edge on a selected input.  MSv31085V3 Internal clock Counter clock = CK_CNT = CK_PSC Counter register CEN=CNT_EN UG Counter initialization (internal) 00   02   03   04   05   06   07 3 2   33   34   35   36 31   01

Advanced-control timer (TIM1)   RM0490  364/1027   RM0490 Rev 5  Figure 81. TI2 external clock connection example  1.   Codes ranging from 01000 to 11111 are reserved For example, to configure the upcounter to count in response to a rising edge on the TI2 input, use the following procedure: 1.   Select the proper TI2x source (internal or external) with the TI2SEL[3:0] bits in the TIMx_TISEL register. 2.   Configure channel 2 to detect rising edges on the TI2 input by writing CC2S = ‘01’ in the TIMx_CCMR1 register. 3.   Configure the input filter duration by writing the IC2F[3:0] bits in the TIMx_CCMR1 register (if no filter is needed, keep IC2F=0000). 4.   Select rising edge polarity by writing CC2P=0 and CC2NP=0 in the TIMx_CCER register. 5.   Configure the timer in external clock mode 1 by writing SMS=111 in the TIMx_SMCR register. 6.   Select TI2 as the trigger input source by writing TS=00110 in the TIMx_SMCR register. 7.   Enable the counter by writing CEN=1 in the TIMx_CR1 register.  Note:   The capture prescaler is not used for triggering, so the user does not need to configure it.  When a rising edge occurs on TI2, the counter counts once and the TIF flag is set. The delay between the rising edge on TI2 and the actual clock of the counter is due to the resynchronization circuit on TI2 input.  MSv40117V1 External clock mode 1 Internal clock mode CK_PSC TIMx_SMCR SMS[2:0] ITRx TI1_ED TI1FP1 TI2FP2 TIMx_SMCR TS[4:0] TI2[0] 0 1 TIMx_CCER CC2P TIMx_CCMR1 Edge detector TI2F_Rising TI2F_Falling 00110 000xx 00100 00101 Filter ICF[3:0]   (internal clock) Encoder mode ETRF   00111 External clock mode 2 ECE TI2[1..15]   TI2 TRGI ETRF CK_INT TI1F   or TI2F   or or TIMx_CH2 (1)

RM0490 Rev 5   365/1027  RM0490   Advanced-control timer (TIM1)  442  Figure 82. Control circuit in external clock mode 1 External clock source mode 2  This mode is selected by writing ECE=1 in the TIMx_SMCR register. The counter can count at each rising or falling edge on the external trigger input ETR. The   Figure 83   gives an overview of the external trigger input block.  Figure 83. External trigger input block  1.   Refer to   Figure 79: TIM1 ETR input circuitry . For example, to configure the upcounter to count each 2 rising edges on ETR, use the following procedure:  Counter clock = CK_CNT = CK_PSC Counter register   35   36 34 TI2 CNT_EN TIF Write TIF=0 MS31087V2  MSv40118V1 External clock mode 1 Internal clock mode CK_PSC TIMx_SMCR SMS[2:0] (internal clock) TI1F   or TI2F   or or Encoder mode External clock mode 2 ECE 0 1 TIMx_SMCR ETR pin   ETR Filter downcounter f DTS ETRP TIMx_SMCR ETPS[1:0] TIMx_SMCR ETF[3:0] TIMx_AF1[17:14] ETRF TRGI CK_INT Divider /1, /2, /4, /8 ETP (1)

Advanced-control timer (TIM1)   RM0490  366/1027   RM0490 Rev 5  1.   As no filter is needed in this example, write ETF[3:0]=0000 in the TIMx_SMCR register. 2.   Set the prescaler by writing ETPS[1:0]=01 in the TIMx_SMCR register 3.   Select rising edge detection on the ETR pin by writing ETP=0 in the TIMx_SMCR register 4.   Enable external clock mode 2 by writing ECE=1 in the TIMx_SMCR register. 5.   Enable the counter by writing CEN=1 in the TIMx_CR1 register. The counter counts once each 2 ETR rising edges. The delay between the rising edge on ETR and the actual clock of the counter is due to the resynchronization circuit on the ETRP signal. As a consequence, the maximum frequency which can be correctly captured by the counter is at most ¼ of TIMxCLK frequency. When the ETRP signal is faster, the user should apply a division of the external signal by proper ETPS prescaler setting.  Figure 84. Control circuit in external clock mode 2  MSv33111V3 34   35   36 f  CK_INT CNT_EN ETR ETRP ETRF Counter clock = CK_CNT =CK_PSC Counter register

RM0490 Rev 5   367/1027  RM0490   Advanced-control timer (TIM1)  442  17.3.6   Capture/compare channels  Each Capture/Compare channel is built around a capture/compare register (including a shadow register), an input stage for capture (with digital filter, multiplexing, and prescaler, except for channels 5 and 6) and an output stage (with comparator and output control).  Figure 85   to   Figure 88   give an overview of one Capture/Compare channel. The input stage samples the corresponding TIx input to generate a filtered signal TIxF. Then, an edge detector with polarity selection generates a signal (TIxFPx) which can be used as trigger input by the slave mode controller or as the capture command. It is prescaled before the capture register (ICxPS).  Figure 85. Capture/compare channel (example: channel 1 input stage)  The output stage generates an intermediate waveform which is then used for reference: OCxRef (active high). The polarity acts at the end of the chain.  Figure 86. Capture/compare channel 1 main circuit  MSv40120V2 0 1 ICPS[1:0] TI1F_ED To the slave mode controller TI1FP1 11 01 CC1S[1:0] IC1 TI2FP1 TRC (from slave mode controller) 10   IC1PS 0 1   TIMx_CCER CC1P/CC1NP TIMx_CCMR1 Edge detector TI1F_Rising TI1F_Falling Filter downcounter ICF[3:0] Divider /1, /2, /4, /8 TIMx_CCMR1 TIMx_CCER TI2F_Rising (from channel 2) TI2F_Falling (from channel 2) TI1F f DTS CC1E TIMx_CH1 TI1[1..15] TI1[0] TIMx_TISEL[3:0]  MSv63030V1 CC1E compare shadow register Comparator Capture/compare preload register Counter IC1PS CC1S[0] CC1S[1] Capture Input mode CC1S[0] CC1S[1] Output mode UEV OC1PE (from time base unit) Compare transfer APB Bus 16/32-bit MCU-peripheral interface TIMx_CCMR1 OC1PE CNT>CCR1 CNT=CCR1 TIMx_EGR CC1G

Advanced-control timer (TIM1)   RM0490  368/1027   RM0490 Rev 5  Figure 87. Output stage of capture/compare channel (channel 1, idem ch. 2 and 3)  1.   OCxREF, where x is the rank of the complementary channel  Figure 88. Output stage of capture/compare channel (channel 4)  MS31199V2 Output mode controller CNT>CCR1 CNT=CCR1 TIM1_CCMR1 OC1M[3:0] OC1REF OC1CE Dead-time generator OC1_DT OC1N_DT DTG[7:0] TIM1_BDTR ‘0’ ‘0’ CC1E TIM1_CCER CC1NE 0 1 CC1P TIM1_CCER 0 1 CC1NP TIM1_CCER OC1 Output enable circuit OC1N CC1E   TIM1_CCER CC1NE OSSI TIM1_BDTR MOE   OSSR 0x 10 11 11 01 x0 Output selector OCxREF OC1REFC To the master mode controller Output enable circuit 0 1 OC5REF (1) ocref_clr_int OCREF_CLR ETRF OCCS TIMx_SMCR OIS1N TIM1_CR2 OIS1  MS33100V2 Output mode controller CNT > CCR4 CNT = CCR4 TIM1_CCMR2 OC4M[3:0] 0 1 CC4P TIM1_CCER Output enable circuit OC4 CC4E   TIM1_CCER To the master mode controller OC4REF OC4CE 0 1 CC4E TIM1_CCER ‘0’ TIM1_BDTR OSSI MOE OIS4   TIM1_CR2 0 1 ocref_clr_int ETRF OCREF_CLR OCCS TIMx_SMCR Output selector OC3REF OC4REFC

RM0490 Rev 5   369/1027  RM0490   Advanced-control timer (TIM1)  442  Figure 89. Output stage of capture/compare channel (channel 5, idem ch. 6)  1.   Not available externally. The capture/compare block is made of one preload register and one shadow register. Write and read always access the preload register. In capture mode, captures are actually done in the shadow register, which is copied into the preload register. In compare mode, the content of the preload register is copied into the shadow register which is compared to the counter.  17.3.7   Input capture mode  In Input capture mode, the Capture/Compare Registers (TIMx_CCRx) are used to latch the value of the counter after a transition detected by the corresponding ICx signal. When a capture occurs, the corresponding CCXIF flag (TIMx_SR register) is set and an interrupt or a DMA request can be sent if they are enabled. If a capture occurs while the CCxIF flag was already high, then the over-capture flag CCxOF (TIMx_SR register) is set. CCxIF can be cleared by software by writing it to ‘0’ or by reading the captured data stored in the TIMx_CCRx register. CCxOF is cleared when written with ‘0’. The following example shows how to capture the counter value in TIMx_CCR1 when TI1 input rises. To do this, use the following procedure: 1.   Select the proper TI1x source (internal or external) with the TI1SEL[3:0] bits in the TIMx_TISEL register. 2.   Select the active input: TIMx_CCR1 must be linked to the TI1 input, so write the CC1S bits to 01 in the TIMx_CCMR1 register. As soon as CC1S becomes different from 00, the channel is configured in input and the TIMx_CCR1 register becomes read-only. 3.   Program the appropriate input filter duration in relation with the signal connected to the timer (when the input is one of the TIx (ICxF bits in the TIMx_CCMRx register). Let’s imagine that, when toggling, the input signal is not stable during at must 5 internal clock cycles. We must program a filter duration longer than these 5 clock cycles. We can validate a transition on TI1 when 8 consecutive samples with the new level have been  MS33101V2 Output mode controller CNT > CCR5 CNT = CCR5 TIM1_CCMR2 OC5M[3:0] 0 1 CC5P TIM1_CCER Output enable circuit OC5 CC5E   TIM1_CCER To the master mode controller OC5REF OC5CE 0 1 CC5E TIM1_CCER ‘0’ TIM1_BDTR OSSI MOE OIS5   TIM1_CR2 (1) 0 1 ocref_clr_int ETRF OCREF_CLR OCCS TIMx_SMCR

Advanced-control timer (TIM1)   RM0490  370/1027   RM0490 Rev 5  detected (sampled at f   DTS   frequency). Then write IC1F bits to 0011 in the TIMx_CCMR1 register. 4.   Select the edge of the active transition on the TI1 channel by writing CC1P and CC1NP bits to 0 in the TIMx_CCER register (rising edge in this case). 5.   Program the input prescaler. In our example, we wish the capture to be performed at each valid transition, so the prescaler is disabled (write IC1PS bits to ‘00’ in the TIMx_CCMR1 register). 6.   Enable capture from the counter into the capture register by setting the CC1E bit in the TIMx_CCER register. 7.   If needed, enable the related interrupt request by setting the CC1IE bit in the TIMx_DIER register, and/or the DMA request by setting the CC1DE bit in the TIMx_DIER register. When an input capture occurs:  •   The TIMx_CCR1 register gets the value of the counter on the active transition.  •   CC1IF flag is set (interrupt flag). CC1OF is also set if at least two consecutive captures occurred whereas the flag was not cleared.  •   An interrupt is generated depending on the CC1IE bit.  •   A DMA request is generated depending on the CC1DE bit. In order to handle the overcapture, it is recommended to read the data before the overcapture flag. This is to avoid missing an overcapture which could happen after reading the flag and before reading the data.  Note:   IC interrupt and/or DMA requests can be generated by software by setting the corresponding CCxG bit in the TIMx_EGR register.  17.3.8   PWM input mode  This mode is a particular case of input capture mode. The procedure is the same except:  •   Two ICx signals are mapped on the same TIx input.  •   These 2 ICx signals are active on edges with opposite polarity.  •   One of the two TIxFP signals is selected as trigger input and the slave mode controller is configured in reset mode. For example, the user can measure the period (in TIMx_CCR1 register) and the duty cycle (in TIMx_CCR2 register) of the PWM applied on TI1 using the following procedure (depending on CK_INT frequency and prescaler value):

RM0490 Rev 5   371/1027  RM0490   Advanced-control timer (TIM1)  442  1.   Select the proper TI1x source (internal or external) with the TI1SEL[3:0] bits in the TIMx_TISEL register. 2.   Select the active input for TIMx_CCR1: write the CC1S bits to 01 in the TIMx_CCMR1 register (TI1 selected). 3.   Select the active polarity for TI1FP1 (used both for capture in TIMx_CCR1 and counter clear): write the CC1P and CC1NP bits to ‘0’ (active on rising edge). 4.   Select the active input for TIMx_CCR2: write the CC2S bits to 10 in the TIMx_CCMR1 register (TI1 selected). 5.   Select the active polarity for TI1FP2 (used for capture in TIMx_CCR2): write the CC2P and CC2NP bits to CC2P/CC2NP=’10’ (active on falling edge). 6.   Select the valid trigger input: write the TS bits to 00101 in the TIMx_SMCR register (TI1FP1 selected). 7.   Configure the slave mode controller in reset mode: write the SMS bits to 0100 in the TIMx_SMCR register. 8.   Enable the captures: write the CC1E and CC2E bits to ‘1’ in the TIMx_CCER register.  Figure 90. PWM input mode timing 17.3.9   Forced output mode  In output mode (CCxS bits = 00 in the TIMx_CCMRx register), each output compare signal (OCxREF and then OCx/OCxN) can be forced to active or inactive level directly by software, independently of any comparison between the output compare register and the counter. To force an output compare signal (OCXREF/OCx) to its active level, user just needs to write 0101 in the OCxM bits in the corresponding TIMx_CCMRx register. Thus OCXREF is forced high (OCxREF is always active high) and OCx get opposite value to CCxP polarity bit. For example: CCxP=0 (OCx active high) => OCx is forced to high level. The OCxREF signal can be forced low by writing the OCxM bits to 0100 in the TIMx_CCMRx register. Anyway, the comparison between the TIMx_CCRx shadow register and the counter is still performed and allows the flag to be set. Interrupt and DMA requests can be sent accordingly. This is described in the output compare mode section below.

Advanced-control timer (TIM1)   RM0490  372/1027   RM0490 Rev 5  17.3.10   Output compare mode  This function is used to control an output waveform or indicate when a period of time has elapsed. Channels 1 to 4 can be output, while Channel 5 and 6 are only available inside the device (for instance, for compound waveform generation or for ADC triggering). When a match is found between the capture/compare register and the counter, the output compare function:  •   Assigns the corresponding output pin to a programmable value defined by the output compare mode (OCxM bits in the TIMx_CCMRx register) and the output polarity (CCxP bit in the TIMx_CCER register). The output pin can keep its level (OCXM=0000), be set active (OCxM=0001), be set inactive (OCxM=0010) or can toggle (OCxM=0011) on match.  •   Sets a flag in the interrupt status register (CCxIF bit in the TIMx_SR register).  •   Generates an interrupt if the corresponding interrupt mask is set (CCXIE bit in the TIMx_DIER register).  •   Sends a DMA request if the corresponding enable bit is set (CCxDE bit in the TIMx_DIER register, CCDS bit in the TIMx_CR2 register for the DMA request selection). The TIMx_CCRx registers can be programmed with or without preload registers using the OCxPE bit in the TIMx_CCMRx register. In output compare mode, the update event UEV has no effect on OCxREF and OCx output. The timing resolution is one count of the counter. Output compare mode can also be used to output a single pulse (in One Pulse mode).  Procedure  1.   Select the counter clock (internal, external, prescaler). 2.   Write the desired data in the TIMx_ARR and TIMx_CCRx registers. 3.   Set the CCxIE bit if an interrupt request is to be generated. 4.   Select the output mode. For example: –   Write OCxM = 0011 to toggle OCx output pin when CNT matches CCRx –   Write OCxPE = 0 to disable preload register –   Write CCxP = 0 to select active high polarity –   Write CCxE = 1 to enable the output 5.   Enable the counter by setting the CEN bit in the TIMx_CR1 register. The TIMx_CCRx register can be updated at any time by software to control the output waveform, provided that the preload register is not enabled (OCxPE=’0’, else TIMx_CCRx shadow register is updated only at the next update event UEV). An example is given in  Figure 91 .

RM0490 Rev 5   373/1027  RM0490   Advanced-control timer (TIM1)  442  Figure 91. Output compare mode, toggle on OC1 17.3.11   PWM mode  Pulse Width Modulation mode allows a signal to be generated with a frequency determined by the value of the TIMx_ARR register and a duty cycle determined by the value of the TIMx_CCRx register. The PWM mode can be selected independently on each channel (one PWM per OCx output) by writing ‘0110’ (PWM mode 1) or ‘0111’ (PWM mode 2) in the OCxM bits in the TIMx_CCMRx register. The corresponding preload register must be enabled by setting the OCxPE bit in the TIMx_CCMRx register, and eventually the auto-reload preload register (in upcounting or center-aligned modes) by setting the ARPE bit in the TIMx_CR1 register. As the preload registers are transferred to the shadow registers only when an update event occurs, before starting the counter, all registers must be initialized by setting the UG bit in the TIMx_EGR register. OCx polarity is software programmable using the CCxP bit in the TIMx_CCER register. It can be programmed as active high or active low. OCx output is enabled by a combination of the CCxE, CCxNE, MOE, OSSI and OSSR bits (TIMx_CCER and TIMx_BDTR registers). Refer to the TIMx_CCER register description for more details. In PWM mode (1 or 2), TIMx_CNT and TIMx_CCRx are always compared to determine whether TIMx_CCRx   ≤   TIMx_CNT or TIMx_CNT   ≤   TIMx_CCRx (depending on the direction of the counter). The timer is able to generate PWM in edge-aligned mode or center-aligned mode depending on the CMS bits in the TIMx_CR1 register.  MS31092V1 OC1REF= OC1 TIM1_CNT   B200   B201 0039 TIM1_CCR1   003A Write B201h in the CC1R register Match detected on CCR1 Interrupt generated if enabled 003B B201 003A

Advanced-control timer (TIM1)   RM0490  374/1027   RM0490 Rev 5  PWM edge-aligned mode  •   Upcounting configuration Upcounting is active when the DIR bit in the TIMx_CR1 register is low. Refer to the  Upcounting mode on page 349 . In the following example, we consider PWM mode 1. The reference PWM signal OCxREF is high as long as TIMx_CNT < TIMx_CCRx else it becomes low. If the compare value in TIMx_CCRx is greater than the auto-reload value (in TIMx_ARR) then OCxREF is held at ‘1’. If the compare value is 0 then OCxRef is held at ‘0’.  Figure 92   shows some edge-aligned PWM waveforms in an example where TIMx_ARR=8.  Figure 92. Edge-aligned PWM waveforms (ARR=8)  •   Downcounting configuration Downcounting is active when DIR bit in TIMx_CR1 register is high. Refer to the  Downcounting mode on page 353  In PWM mode 1, the reference signal OCxRef is low as long as TIMx_CNT > TIMx_CCRx else it becomes high. If the compare value in TIMx_CCRx is greater than the auto-reload value in TIMx_ARR, then OCxREF is held at ‘1’. 0% PWM is not possible in this mode.  PWM center-aligned mode  Center-aligned mode is active when the CMS bits in TIMx_CR1 register are different from ‘00’ (all the remaining configurations having the same effect on the OCxRef/OCx signals). The compare flag is set when the counter counts up, when it counts down or both when it counts up and down depending on the CMS bits configuration. The direction bit (DIR) in the  MS31093V1 Counter register ‘1’ 0   1   2   3   4   5   6   7   8   0   1 OCXREF CCxIF OCXREF CCxIF OCXREF CCxIF OCXREF CCxIF CCRx=4 CCRx=8 CCRx>8 CCRx=0 ‘0’

RM0490 Rev 5   375/1027  RM0490   Advanced-control timer (TIM1)  442  TIMx_CR1 register is updated by hardware and must not be changed by software. Refer to the   Center-aligned mode (up/down counting) on page 356 .  Figure 93   shows some center-aligned PWM waveforms in an example where:  •   TIMx_ARR=8,  •   PWM mode is the PWM mode 1,  •   The flag is set when the counter counts down corresponding to the center-aligned mode 1 selected for CMS=01 in TIMx_CR1 register.  Figure 93. Center-aligned PWM waveforms (ARR=8)  Hints on using center-aligned mode  •   When starting in center-aligned mode, the current up-down configuration is used. It means that the counter counts up or down depending on the value written in the DIR bit  CCxIF 0   1   2   3   4   5   6   7   8   7   6   5   4   3   2   1   0   1 Counter register CCRx = 4 OCxREF CMS=01 CMS=10 CMS=11 CCxIF CCRx=7 OCxREF CMS=10 or 11 CCxIF CCRx=8 OCxREF CMS=01 CMS=10 CMS=11 ‘1’ CCxIF CCRx>8 OCxREF CMS=01 CMS=10 CMS=11 ‘1’ CCxIF CCRx=0 OCxREF CMS=01 CMS=10 CMS=11 ‘0’ AI14681b

Advanced-control timer (TIM1)   RM0490  376/1027   RM0490 Rev 5  in the TIMx_CR1 register. Moreover, the DIR and CMS bits must not be changed at the same time by the software.  •   Writing to the counter while running in center-aligned mode is not recommended as it can lead to unexpected results. In particular: –   The direction is not updated if a value greater than the auto-reload value is written in the counter (TIMx_CNT>TIMx_ARR). For example, if the counter was counting up, it continues to count up. –   The direction is updated if 0 or the TIMx_ARR value is written in the counter but no Update Event UEV is generated.  •   The safest way to use center-aligned mode is to generate an update by software (setting the UG bit in the TIMx_EGR register) just before starting the counter and not to write the counter while it is running.  17.3.12   Asymmetric PWM mode  Asymmetric mode allows two center-aligned PWM signals to be generated with a programmable phase shift. While the frequency is determined by the value of the TIMx_ARR register, the duty cycle and the phase-shift are determined by a pair of TIMx_CCRx register. One register controls the PWM during up-counting, the second during down counting, so that PWM is adjusted every half PWM cycle: –   OC1REFC (or OC2REFC) is controlled by TIMx_CCR1 and TIMx_CCR2 –   OC3REFC (or OC4REFC) is controlled by TIMx_CCR3 and TIMx_CCR4 Asymmetric PWM mode can be selected independently on two channel (one OCx output per pair of CCR registers) by writing ‘1110’ (Asymmetric PWM mode 1) or ‘1111’ (Asymmetric PWM mode 2) in the OCxM bits in the TIMx_CCMRx register.  Note:   The OCxM[3:0] bit field is split into two parts for compatibility reasons, the most significant bit is not contiguous with the 3 least significant ones.  When a given channel is used as asymmetric PWM channel, its complementary channel can also be used. For instance, if an OC1REFC signal is generated on channel 1 (Asymmetric PWM mode 1), it is possible to output either the OC2REF signal on channel 2, or an OC2REFC signal resulting from asymmetric PWM mode 1.  Figure 94   represents an example of signals that can be generated using Asymmetric PWM mode (channels 1 to 4 are configured in Asymmetric PWM mode 1). Together with the deadtime generator, this allows a full-bridge phase-shifted DC to DC converter to be controlled.

RM0490 Rev 5   377/1027  RM0490   Advanced-control timer (TIM1)  442  Figure 94. Generation of 2 phase-shifted PWM signals with 50% duty cycle 17.3.13   Combined PWM mode  Combined PWM mode allows two edge or center-aligned PWM signals to be generated with programmable delay and phase shift between respective pulses. While the frequency is determined by the value of the TIMx_ARR register, the duty cycle and delay are determined by the two TIMx_CCRx registers. The resulting signals, OCxREFC, are made of an OR or AND logical combination of two reference PWMs: –   OC1REFC (or OC2REFC) is controlled by TIMx_CCR1 and TIMx_CCR2 –   OC3REFC (or OC4REFC) is controlled by TIMx_CCR3 and TIMx_CCR4 Combined PWM mode can be selected independently on two channels (one OCx output per pair of CCR registers) by writing ‘1100’ (Combined PWM mode 1) or ‘1101’ (Combined PWM mode 2) in the OCxM bits in the TIMx_CCMRx register. When a given channel is used as combined PWM channel, its complementary channel must be configured in the opposite PWM mode (for instance, one in Combined PWM mode 1 and the other in Combined PWM mode 2).  Note:   The OCxM[3:0] bit field is split into two parts for compatibility reasons, the most significant bit is not contiguous with the 3 least significant ones. Figure 95   represents an example of signals that can be generated using Asymmetric PWM mode, obtained with the following configuration: –   Channel 1 is configured in Combined PWM mode 2, –   Channel 2 is configured in PWM mode 1, –   Channel 3 is configured in Combined PWM mode 2, –   Channel 4 is configured in PWM mode 1.  MS33117V1 Counter register OC1REFC CCR1=0 CCR2=8 CCR3=3 CCR4=5 0   1   2   3   4   5   6   7   0 1 2 3 4 5 6 7 8   1 1 OC3REFC

Advanced-control timer (TIM1)   RM0490  378/1027   RM0490 Rev 5  Figure 95. Combined PWM mode on channel 1 and 3 17.3.14   Combined 3-phase PWM mode  Combined 3-phase PWM mode allows one to three center-aligned PWM signals to be generated with a single programmable signal ANDed in the middle of the pulses. The OC5REF signal is used to define the resulting combined signal. The 3-bits GC5C[3:1] in the TIMx_CCR5 allow selection on which reference signal the OC5REF is combined. The resulting signals, OCxREFC, are made of an AND logical combination of two reference PWMs: –   If GC5C1 is set, OC1REFC is controlled by TIMx_CCR1 and TIMx_CCR5 –   If GC5C2 is set, OC2REFC is controlled by TIMx_CCR2 and TIMx_CCR5 –   If GC5C3 is set, OC3REFC is controlled by TIMx_CCR3 and TIMx_CCR5 Combined 3-phase PWM mode can be selected independently on channels 1 to 3 by setting at least one of the 3-bits GC5C[3:1].  MS31094V1 OC1REF OC2REF OC1REF’ OC2REF’ OC1REFC OC1REFC’ OC1REFC = OC1REF AND OC2REF OC1REFC’ = OC1REF’ OR OC2REF’ OC1 OC2 OC1’ OC2’

RM0490 Rev 5   379/1027  RM0490   Advanced-control timer (TIM1)  442  Figure 96. 3-phase combined PWM signals with multiple trigger pulses per period  The TRGO2 waveform shows how the ADC can be synchronized on given 3-phase PWM signals. Refer to   Section 17.3.27: ADC synchronization   for more details.  17.3.15   Complementary outputs and dead-time insertion  The advanced-control timers (TIM1) can output two complementary signals and manage the switching-off and the switching-on instants of the outputs. This time is generally known as dead-time and it has to be adjusted depending on the devices that are connected to the outputs and their characteristics (intrinsic delays of level- shifters, delays due to power switches...) The polarity of the outputs (main output OCx or complementary OCxN) can be selected independently for each output. This is done by writing to the CCxP and CCxNP bits in the TIMx_CCER register. The complementary signals OCx and OCxN are activated by a combination of several control bits: the CCxE and CCxNE bits in the TIMx_CCER register and the MOE, OISx, OISxN, OSSI and OSSR bits in the TIMx_BDTR and TIMx_CR2 registers. Refer to  Table 81: Output control bits for complementary OCx and OCxN channels with break feature on page 425   for more details. In particular, the dead-time is activated when switching to the idle state (MOE falling down to 0).  ARR OC5 OC1 OC2 OC3 OC5ref OC1refC OC6 OC4 TRGO2 100   xxx 001   100 Preload GC5C[3:0] xxx Counter MS33102V1 OC2refC OC3refC Active OC4ref OC6ref

Advanced-control timer (TIM1)   RM0490  380/1027   RM0490 Rev 5  Dead-time insertion is enabled by setting both CCxE and CCxNE bits, and the MOE bit if the break circuit is present. There is one 10-bit dead-time generator for each channel. From a reference waveform OCxREF, it generates 2 outputs OCx and OCxN. If OCx and OCxN are active high:  •   The OCx output signal is the same as the reference signal except for the rising edge, which is delayed relative to the reference rising edge.  •   The OCxN output signal is the opposite of the reference signal except for the rising edge, which is delayed relative to the reference falling edge. If the delay is greater than the width of the active output (OCx or OCxN) then the corresponding pulse is not generated. The following figures show the relationships between the output signals of the dead-time generator and the reference signal OCxREF. (we suppose CCxP=0, CCxNP=0, MOE=1, CCxE=1 and CCxNE=1 in these examples)  Figure 97. Complementary output with dead-time insertion Figure 98. Dead-time waveforms with delay greater than the negative pulse  delay delay OCxREF OCx OCxN MS31095V1  MS31096V1 delay OCxREF OCx OCxN

RM0490 Rev 5   381/1027  RM0490   Advanced-control timer (TIM1)  442  Figure 99. Dead-time waveforms with delay greater than the positive pulse  The dead-time delay is the same for each of the channels and is programmable with the DTG bits in the TIMx_BDTR register. Refer to   Section 17.4.20: TIM1 break and dead-time register (TIM1_BDTR)   for delay calculation.  Re-directing OCxREF to OCx or OCxN  In output mode (forced, output compare or PWM), OCxREF can be re-directed to the OCx output or to OCxN output by configuring the CCxE and CCxNE bits in the TIMx_CCER register. This allows a specific waveform to be sent (such as PWM or static active level) on one output while the complementary remains at its inactive level. Other alternative possibilities are to have both outputs at inactive level or both outputs active and complementary with dead-time.  Note:   When only OCxN is enabled (CCxE=0, CCxNE=1), it is not complemented and becomes active as soon as OCxREF is high. For example, if CCxNP=0 then OCxN=OCxRef. On the other hand, when both OCx and OCxN are enabled (CCxE=CCxNE=1) OCx becomes active when OCxREF is high whereas OCxN is complemented and becomes active when OCxREF is low.  17.3.16   Using the break function  The purpose of the break function is to protect power switches driven by PWM signals generated with the TIM1 timer. The two break inputs are usually connected to fault outputs of power stages and 3-phase inverters. When activated, the break circuitry shuts down the PWM outputs and forces them to a predefined safe state. A number of internal MCU events can also be selected to trigger an output shut-down. The break features two channels. A break channel which gathers both system-level fault (clock failure, parity error,...) and application fault (from input pins), and can force the outputs to a predefined level (either active or inactive) after a deadtime duration. A break2 channel which only includes application faults and is able to force the outputs to an inactive state.  MS31097V1 delay OCxREF OCx OCxN

Advanced-control timer (TIM1)   RM0490  382/1027   RM0490 Rev 5  The output enable signal and output levels during break are depending on several control bits: –   the MOE bit in TIMx_BDTR register allows the outputs to be enabled/disabled by software and is reset in case of break or break2 event. –   the OSSI bit in the TIMx_BDTR register defines whether the timer controls the output in inactive state or releases the control to the GPIO controller (typically to have it in Hi-Z mode) –   the OISx and OISxN bits in the TIMx_CR2 register which are setting the output shut-down level, either active or inactive. The OCx and OCxN outputs cannot be set both to active level at a given time, whatever the OISx and OISxN values. Refer to   Table 81: Output control bits for complementary OCx and OCxN channels with break feature on page 425   for more details. When exiting from reset, the break circuit is disabled and the MOE bit is low. The break functions can be enabled by setting the BKE and BK2E bits in the TIMx_BDTR register. The break input polarities can be selected by configuring the BKP and BK2P bits in the same register. BKE/BK2E and BKP/BK2P can be modified at the same time. When the BKE/BK2E and BKP/BK2P bits are written, a delay of 1 APB clock cycle is applied before the writing is effective. Consequently, it is necessary to wait 1 APB clock period to correctly read back the bit after the write operation. Because MOE falling edge can be asynchronous, a resynchronization circuit has been inserted between the actual signal (acting on the outputs) and the synchronous control bit (accessed in the TIMx_BDTR register). It results in some delays between the asynchronous and the synchronous signals. In particular, if MOE is set to 1 whereas it was low, a delay must be inserted (dummy instruction) before reading it correctly. This is because the write acts on the asynchronous signal whereas the read reflects the synchronous signal. The break can be generated from multiple sources which can be individually enabled and with programmable edge sensitivity, using the TIMx_OR2 and TIMx_OR3 registers. The sources for break (BRK) channel are:  •   An external source connected to one of the BKIN pin (as per selection done in the GPIO alternate function registers), with polarity selection and optional digital filtering  •   An internal source: –   the Cortex ®   -M0+ LOCKUP output –   the SRAM parity error signal –   a clock failure event generated by the CSS detector The source for break2 (BRK2) is an external source connected to one of the BKIN pin (as per selection done in the GPIO alternate function registers), with polarity selection and optional digital filtering. Break events can also be generated by software using BG and B2G bits in the TIMx_EGR register. The software break generation using BG and B2G is active whatever the BKE and BK2E enable bits values. All sources are ORed before entering the timer BRK or BRK2 inputs, as per   Figure 100  below.

RM0490 Rev 5   383/1027  RM0490   Advanced-control timer (TIM1)  442  Figure 100. Break and Break2 circuitry overview  Note:   An asynchronous (clockless) operation is only guaranteed when the programmable filter is disabled. If it is enabled, a fail safe clock mode (for example by using the CSS) must be used to guarantee that break events are handled.  When one of the breaks occurs (selected level on one of the break inputs):  •   The MOE bit is cleared asynchronously, putting the outputs in inactive state, idle state or even releasing the control to the GPIO controller (selected by the OSSI bit). This feature is enabled even if the MCU oscillator is off.  •   Each output channel is driven with the level programmed in the OISx bit in the TIMx_CR2 register as soon as MOE=0. If OSSI=0, the timer releases the output control (taken over by the GPIO controller), otherwise the enable output remains high.  •   When complementary outputs are used: –   The outputs are first put in inactive state (depending on the polarity). This is done asynchronously so that it works even if no clock is provided to the timer. –   If the timer clock is still present, then the dead-time generator is reactivated in order to drive the outputs with the level programmed in the OISx and OISxN bits after a dead-time. Even in this case, OCx and OCxN cannot be driven to their  MSv67589V1 BKIN2 inputs from AF controller BK2INE BK2INP   BK2F[3:0] Filter BK2P Application break requests BKIN inputs from AF controller BKINE BKINP   BKF[3:0] Filter BKP Application break requests Parity LOCK Lockup LOCK RAM parity Error Core Lockup CSS SBIF flag System break requests Software break requests: B2G B2IF flag BRK2 request BKE BRK request BIF flag Software break requests: BG BK2E

Advanced-control timer (TIM1)   RM0490  384/1027   RM0490 Rev 5  active level together. Note that because of the resynchronization on MOE, the dead-time duration is slightly longer than usual (around 2 ck_tim clock cycles). –   If OSSI=0, the timer releases the output control (taken over by the GPIO controller which forces a Hi-Z state), otherwise the enable outputs remain or become high as soon as one of the CCxE or CCxNE bits is high.  •   The break status flag (SBIF, BIF and B2IF bits in the TIMx_SR register) is set. An interrupt is generated if the BIE bit in the TIMx_DIER register is set.  •   If the AOE bit in the TIMx_BDTR register is set, the MOE bit is automatically set again at the next update event (UEV). As an example, this can be used to perform a regulation. Otherwise, MOE remains low until the application sets it to ‘1’ again. In this case, it can be used for security and the break input can be connected to an alarm from power drivers, thermal sensors or any security components.  Note:   If the MOE is reset by the CPU while the AOE bit is set, the outputs are in idle state and forced to inactive level or Hi-Z depending on OSSI value. If both the MOE and AOE bits are reset by the CPU, the outputs are in disabled state and driven with the level programmed in the OISx bit in the TIMx_CR2 register. Note:   The break inputs are active on level. Thus, the MOE cannot be set while the break input is active (neither automatically nor by software). In the meantime, the status flag BIF and B2IF cannot be cleared.  In addition to the break input and the output management, a write protection has been implemented inside the break circuit to safeguard the application. It allows the configuration of several parameters to be freezed (dead-time duration, OCx/OCxN polarities and state when disabled, OCxM configurations, break enable and polarity). The application can choose from 3 levels of protection selected by the LOCK bits in the TIMx_BDTR register. Refer to   Section 17.4.20: TIM1 break and dead-time register (TIM1_BDTR) . The LOCK bits can be written only once after an MCU reset.  Figure 101   shows an example of behavior of the outputs in response to a break.

RM0490 Rev 5   385/1027  RM0490   Advanced-control timer (TIM1)  442  Figure 101. Various output behavior in response to a break event on BRK (OSSI = 1)  delay   delay   delay delay   delay   delay delay delay OCxREF OCx (OCxN not implemented, CCxP=0, OISx=1) OCx (OCxN not implemented, CCxP=0, OISx=0) OCx (OCxN not implemented, CCxP=1, OISx=1) OCx (OCxN not implemented, CCxP=1, OISx=0) OCx OCxN (CCxE=1, CCxP=0, OISx=0, CCxNE=1, CCxNP=0, OISxN=1) OCx OCxN (CCxE=1, CCxP=0, OISx=1, CCxNE=1, CCxNP=1, OISxN=1) OCx OCxN (CCxE=1, CCxP=0, OISx=0, CCxNE=0, CCxNP=0, OISxN=1) OCx OCxN (CCxE=1, CCxP=0, OISx=1, CCxNE=0, CCxNP=0, OISxN=0) OCx OCxN (CCxE=1, CCxP=0, CCxNE=0, CCxNP=0, OISx=OISxN=0 or OISx=OISxN=1) MS31098V1 BREAK (MOE   )

Advanced-control timer (TIM1)   RM0490  386/1027   RM0490 Rev 5  The two break inputs have different behaviors on timer outputs: –   The BRK input can either disable (inactive state) or force the PWM outputs to a predefined safe state. –   BRK2 can only disable (inactive state) the PWM outputs. The BRK has a higher priority than BRK2 input, as described in   Table 77 .  Note:   BRK2 must only be used with OSSR = OSSI = 1.  Figure 102   gives an example of OCx and OCxN output behavior in case of active signals on BRK and BRK2 inputs. In this case, both outputs have active high polarities (CCxP = CCxNP = 0 in TIMx_CCER register).  Figure 102. PWM output state following BRK and BRK2 pins assertion (OSSI=1) Table 77. Behavior of timer outputs versus BRK/BRK2 inputs BRK   BRK2   Timer outputs state Typical use case OCxN output (low side switches) OCx output (high side switches)  Active   X – Inactive then forced output state (after a deadtime) – Outputs disabled if OSSI = 0 (control taken over by GPIO logic) ON after deadtime insertion   OFF Inactive   Active   Inactive   OFF   OFF  MS34106V1 BRK2 BRK OCx I/O state Deadtime   Deadtime Active   Inactive   Idle

RM0490 Rev 5   387/1027  RM0490   Advanced-control timer (TIM1)  442  Figure 103. PWM output state following BRK assertion (OSSI=0) 17.3.17   Bidirectional break inputs  The TIM1 are featuring bidirectional break I/Os, as represented on   Figure 104 . They allow the following:  •   A board-level global break signal available for signaling faults to external MCUs or gate drivers, with a unique pin being both an input and an output status pin  •   Internal break sources and multiple external open drain comparator outputs ORed together to trigger a unique break event, when multiple internal and external break sources must be merged The break and break2 inputs are configured in bidirectional mode using the BKBID and BK2BID bits in the TIMxBDTR register. The BKBID programming bits can be locked in read- only mode using the LOCK bits in the TIMxBDTR register (in LOCK level 1 or above). The bidirectional mode is available for both the break and break2 inputs, and require the I/O to be configured in open-drain mode with active low polarity (using BKINP, BKP, BK2INP and BK2P bits). Any break request coming either from system (e.g. CSS), from on-chip peripherals or from break inputs forces a low level on the break input to signal the fault event. The bidirectional mode is inhibited if the polarity bits are not correctly set (active high polarity), for safety purposes. The break software events (BG and B2G) also cause the break I/O to be forced to '0' to indicate to the external components that the timer has entered in break state. However, this is valid only if the break is enabled (BK(2)E = 1). When a software break event is generated with BK(2)E = 0, the outputs are put in safe state and the break flag is set, but there is no effect on the break(2) I/O. A safe disarming mechanism prevents the system to be definitively locked-up (a low level on the break input triggers a break which enforces a low level on the same input). When the BKDSRM (BK2DSRM) bit is set to 1, this releases the break output to clear a fault signal and to give the possibility to re-arm the system. At no point the break protection circuitry can be disabled:  •   The break input path is always active: a break event is active even if the BKDSRM (BK2DSRM) bit is set and the open drain control is released. This prevents the PWM output to be re-started as long as the break condition is present.  •   The BK(2)DSRM bit cannot disarm the break protection as long as the outputs are enabled (MOE bit is set) (see   Table 78 )  MS34107V1 BRK OCx I/O state Deadtime Active   Inactive   Disabled I/O state defined by the GPIO controller (HI-Z) I/O state defined by the GPIO controller (HI-Z)

Advanced-control timer (TIM1)   RM0490  388/1027   RM0490 Rev 5  Arming and re-arming break circuitry  The break circuitry (in input or bidirectional mode) is armed by default (peripheral reset configuration). The following procedure must be followed to re-arm the protection after a break (break2) event:  •   The BKDSRM (BK2DSRM) bit must be set to release the output control  •   The software must wait until the system break condition disappears (if any) and clear the SBIF status flag (or clear it systematically before re-arming)  •   The software must poll the BKDSRM (BK2DSRM) bit until it is cleared by hardware (when the application break condition disappears) From this point, the break circuitry is armed and active, and the MOE bit can be set to re- enable the PWM outputs.  Figure 104. Output redirection (BRK2 request not represented) Table 78. Break protection disarming conditions MOE   BKDIR (BK2DIR) BKDSRM (BK2DSRM)   Break protection state  0   0   X   Armed 0   1   0   Armed 0   1   1   Disarmed 1   X   X   Armed  MSv42028V2 BKIN inputs from AF controller BKF[3:0] Filter BKP BKE BRK request BIF flag SBIF flag System break request Peripheral break sources AF controller mode control logic MOE   BKBID   BKBDSRM BRK request System break request Bidirectional Break I/O Other break inputs Application break requests Vss Bidirectional AF input (active low) AF output (open drain) Software break requests: BG

RM0490 Rev 5   389/1027  RM0490   Advanced-control timer (TIM1)  442  17.3.18   Clearing the OCxREF signal on an external event  When ETRF is chosen, ETR must be configured as follows: 1.   The External Trigger Prescaler should be kept off: bits ETPS[1:0] of the TIMx_SMCR register set to ‘00’. 2.   The external clock mode 2 must be disabled: bit ECE of the TIMx_SMCR register set to ‘0’. 3.   The External Trigger Polarity (ETP) and the External Trigger Filter (ETF) can be configured according to the user needs.  Figure 105   shows the behavior of the OCxREF signal when the ETRF Input becomes High, for both values of the enable bit OCxCE. In this example, the timer TIMx is programmed in PWM mode.  Figure 105. Clearing TIMx OCxREF  Note:   In case of a PWM with a 100% duty cycle (if CCRx>ARR), then OCxREF is enabled again at the next counter overflow.  The OCxREF signal of a given channel can be cleared when a high level is applied on the ocref_clr_int input (OCxCE enable bit in the corresponding TIMx_CCMRx register set to 1). OCxREF remains low until the next transition to the active state, on the following PWM cycle. This function can only be used in Output compare and PWM modes. It does not work in Forced mode. ocref_clr_int input can be selected between the OCREF_CLR input and ETRF (ETR after the filter) by configuring the OCCS bit in the TIMx_SMCR register.  MS33105V2 (CCRx) Counter (CNT) ETRF OCxREF (OCxCE = ‘0’) OCxREF (OCxCE = ‘1’) ocref_clr_int becomes high ocref_clr_int still high

Advanced-control timer (TIM1)   RM0490  390/1027   RM0490 Rev 5  17.3.19   6-step PWM generation  When complementary outputs are used on a channel, preload bits are available on the OCxM, CCxE and CCxNE bits. The preload bits are transferred to the shadow bits at the COM commutation event. Thus one can program in advance the configuration for the next step and change the configuration of all the channels at the same time. COM can be generated by software by setting the COM bit in the TIMx_EGR register or by hardware (on TRGI rising edge). A flag is set when the COM event occurs (COMIF bit in the TIMx_SR register), which can generate an interrupt (if the COMIE bit is set in the TIMx_DIER register) or a DMA request (if the COMDE bit is set in the TIMx_DIER register). The   Figure 106   describes the behavior of the OCx and OCxN outputs when a COM event occurs, in 3 different examples of programmed configurations.  Figure 106. 6-step generation, COM example (OSSR=1)

RM0490 Rev 5   391/1027  RM0490   Advanced-control timer (TIM1)  442  17.3.20   One-pulse mode  One-pulse mode (OPM) is a particular case of the previous modes. It allows the counter to be started in response to a stimulus and to generate a pulse with a programmable length after a programmable delay. Starting the counter can be controlled through the slave mode controller. Generating the waveform can be done in output compare mode or PWM mode. One-pulse mode is selected by setting the OPM bit in the TIMx_CR1 register. This makes the counter stop automatically at the next update event UEV. A pulse can be correctly generated only if the compare value is different from the counter initial value. Before starting (when the timer is waiting for the trigger), the configuration must be:  •   In upcounting: CNT < CCRx   ≤   ARR (in particular, 0 < CCRx)  •   In downcounting: CNT > CCRx  Figure 107. Example of one pulse mode.  For example one may want to generate a positive pulse on OC1 with a length of t PULSE   and after a delay of t   DELAY   as soon as a positive edge is detected on the TI2 input pin. Let’s use TI2FP2 as trigger 1: 1.   Select the proper TI2x source (internal or external) with the TI2SEL[3:0] bits in the TIMx_TISEL register. 2.   Map TI2FP2 to TI2 by writing CC2S=’01’ in the TIMx_CCMR1 register. 3.   TI2FP2 must detect a rising edge, write CC2P=’0’ and CC2NP=’0’ in the TIMx_CCER register. 4.   Configure TI2FP2 as trigger for the slave mode controller (TRGI) by writing TS=00110 in the TIMx_SMCR register. 5.   TI2FP2 is used to start the counter by writing SMS to ‘110’ in the TIMx_SMCR register (trigger mode).  MS31099V1 TI2 OC1REF Counter t 0 TIM1_ARR TIM1_CCR1 OC1 t   DELAY   t   PULSE

Advanced-control timer (TIM1)   RM0490  392/1027   RM0490 Rev 5  The OPM waveform is defined by writing the compare registers (taking into account the clock frequency and the counter prescaler).  •   The t DELAY   is defined by the value written in the TIMx_CCR1 register.  •   The t PULSE   is defined by the difference between the auto-reload value and the compare value (TIMx_ARR - TIMx_CCR1).  •   Let’s say one want to build a waveform with a transition from ‘0’ to ‘1’ when a compare match occurs and a transition from ‘1’ to ‘0’ when the counter reaches the auto-reload value. To do this PWM mode 2 must be enabled by writing OC1M=111 in the TIMx_CCMR1 register. Optionally the preload registers can be enabled by writing OC1PE=’1’ in the TIMx_CCMR1 register and ARPE in the TIMx_CR1 register. In this case one has to write the compare value in the TIMx_CCR1 register, the auto-reload value in the TIMx_ARR register, generate an update by setting the UG bit and wait for external trigger event on TI2. CC1P is written to ‘0’ in this example. In our example, the DIR and CMS bits in the TIMx_CR1 register should be low. Since only 1 pulse (Single mode) is needed, a 1 must be written in the OPM bit in the TIMx_CR1 register to stop the counter at the next update event (when the counter rolls over from the auto-reload value back to 0). When OPM bit in the TIMx_CR1 register is set to '0', so the Repetitive Mode is selected. Particular case: OCx fast enable: In One-pulse mode, the edge detection on TIx input set the CEN bit which enables the counter. Then the comparison between the counter and the compare value makes the output toggle. But several clock cycles are needed for these operations and it limits the minimum delay t   DELAY   min we can get. If one wants to output a waveform with the minimum delay, the OCxFE bit can be set in the TIMx_CCMRx register. Then OCxRef (and OCx) are forced in response to the stimulus, without taking in account the comparison. Its new level is the same as if a compare match had occurred. OCxFE acts only if the channel is configured in PWM1 or PWM2 mode.  17.3.21   Retriggerable one pulse mode  This mode allows the counter to be started in response to a stimulus and to generate a pulse with a programmable length, but with the following differences with Non-retriggerable one pulse mode described in   Section 17.3.20 : –   The pulse starts as soon as the trigger occurs (no programmable delay) –   The pulse is extended if a new trigger occurs before the previous one is completed The timer must be in Slave mode, with the bits SMS[3:0] = ‘1000’ (Combined Reset + trigger mode) in the TIMx_SMCR register, and the OCxM[3:0] bits set to ‘1000’ or ‘1001’ for retriggerable OPM mode 1 or 2. If the timer is configured in Up-counting mode, the corresponding CCRx must be set to 0 (the ARR register sets the pulse length). If the timer is configured in Down-counting mode, CCRx must be above or equal to ARR.  Note:   The OCxM[3:0] and SMS[3:0] bit fields are split into two parts for compatibility reasons, the most significant bit are not contiguous with the 3 least significant ones. This mode must not be used with center-aligned PWM modes. It is mandatory to have CMS[1:0] = 00 in TIMx_CR1.

RM0490 Rev 5   393/1027  RM0490   Advanced-control timer (TIM1)  442  Figure 108. Retriggerable one pulse mode 17.3.22   Encoder interface mode  To select Encoder Interface mode write SMS=‘001’ in the TIMx_SMCR register if the counter is counting on TI2 edges only, SMS=’010’ if it is counting on TI1 edges only and SMS=’011’ if it is counting on both TI1 and TI2 edges. Select the TI1 and TI2 polarity by programming the CC1P and CC2P bits in the TIMx_CCER register. When needed, the input filter can be programmed as well. CC1NP and CC2NP must be kept low. The two inputs TI1 and TI2 are used to interface to a quadrature encoder. Refer to   Table 79 . The counter is clocked by each valid transition on TI1FP1 or TI2FP2 (TI1 and TI2 after input filter and polarity selection, TI1FP1=TI1 if not filtered and not inverted, TI2FP2=TI2 if not filtered and not inverted) assuming that it is enabled (CEN bit in TIMx_CR1 register written to ‘1’). The sequence of transitions of the two inputs is evaluated and generates count pulses as well as the direction signal. Depending on the sequence the counter counts up or down, the DIR bit in the TIMx_CR1 register is modified by hardware accordingly. The DIR bit is calculated at each transition on any input (TI1 or TI2), whatever the counter is counting on TI1 only, TI2 only or both TI1 and TI2. Encoder interface mode acts simply as an external clock with direction selection. This means that the counter just counts continuously between 0 and the auto-reload value in the TIMx_ARR register (0 to ARR or ARR down to 0 depending on the direction). So the TIMx_ARR must be configured before starting. In the same way, the capture, compare, repetition counter, trigger output features continue to work as normal. Encoder mode and External clock mode 2 are not compatible and must not be selected together.  Note:   The prescaler must be set to zero when encoder mode is enabled  In this mode, the counter is modified automatically following the speed and the direction of the quadrature encoder and its content, therefore, always represents the encoder’s position. The count direction correspond to the rotation direction of the connected sensor. The table summarizes the possible combinations, assuming TI1 and TI2 do not switch at the same time.  MS33106V2 TRGI Counter Output

Advanced-control timer (TIM1)   RM0490  394/1027   RM0490 Rev 5  A quadrature encoder can be connected directly to the MCU without external interface logic. However, comparators are normally be used to convert the encoder’s differential outputs to digital signals. This greatly increases noise immunity. The third encoder output which indicate the mechanical zero position, may be connected to an external interrupt input and trigger a counter reset. The   Figure 109   gives an example of counter operation, showing count signal generation and direction control. It also shows how input jitter is compensated where both edges are selected. This might occur if the sensor is positioned near to one of the switching points. For this example we assume that the configuration is the following:  •   CC1S=’01’ (TIMx_CCMR1 register, TI1FP1 mapped on TI1).  •   CC2S=’01’ (TIMx_CCMR1 register, TI2FP2 mapped on TI2)  •   CC1P=’0’ and CC1NP=’0’ (TIMx_CCER register, TI1FP1 non-inverted, TI1FP1=TI1).  •   CC2P=’0’ and CC2NP=’0’ (TIMx_CCER register, TI1FP2 non-inverted, TI1FP2= TI2).  •   SMS=’011’ (TIMx_SMCR register, both inputs are active on both rising and falling edges).  •   CEN=’1’ (TIMx_CR1 register, Counter enabled).  Figure 109. Example of counter operation in encoder interface mode. Table 79. Counting direction versus encoder signals Active edge Level on opposite signal (TI1FP1 for TI2, TI2FP2 for TI1) TI1FP1 signal   TI2FP2 signal Rising   Falling   Rising   Falling  Counting on TI1 only High   Down   Up   No Count   No Count Low   Up   Down   No Count   No Count Counting on TI2 only High   No Count   No Count   Up   Down Low   No Count   No Count   Down   Up Counting on TI1 and TI2 High   Down   Up   Up   Down Low   Up   Down   Down   Up  TI1 backward jitter   jitter up   down   up TI2 Counter forward   forward MS33107V1

RM0490 Rev 5   395/1027  RM0490   Advanced-control timer (TIM1)  442  Figure 110   gives an example of counter behavior when TI1FP1 polarity is inverted (same configuration as above except CC1P=’1’).  Figure 110. Example of encoder interface mode with TI1FP1 polarity inverted.  The timer, when configured in Encoder Interface mode provides information on the sensor’s current position. Dynamic information can be obtained (speed, acceleration, deceleration) by measuring the period between two encoder events using a second timer configured in capture mode. The output of the encoder which indicates the mechanical zero can be used for this purpose. Depending on the time between two events, the counter can also be read at regular times. This can be done by latching the counter value into a third input capture register if available (then the capture signal must be periodic and can be generated by another timer). when available, it is also possible to read its value through a DMA request. The IUFREMAP bit in the TIMx_CR1 register forces a continuous copy of the update interrupt flag (UIF) into the timer counter register’s bit 31 (TIMxCNT[31]). This allows both the counter value and a potential roll-over condition signaled by the UIFCPY flag to be read in an atomic way. It eases the calculation of angular speed by avoiding race conditions caused, for instance, by a processing shared between a background task (counter reading) and an interrupt (update interrupt). There is no latency between the UIF and UIFCPY flag assertions. In 32-bit timer implementations, when the IUFREMAP bit is set, bit 31 of the counter is overwritten by the UIFCPY flag upon read access (the counter’s most significant bit is only accessible in write mode).  17.3.23   UIF bit remapping  The IUFREMAP bit in the TIMx_CR1 register forces a continuous copy of the Update Interrupt Flag UIF into the timer counter register’s bit 31 (TIMxCNT[31]). This allows both the counter value and a potential roll-over condition signaled by the UIFCPY flag to be read in an atomic way. In particular cases, it can ease the calculations by avoiding race conditions, caused for instance by a processing shared between a background task (counter reading) and an interrupt (Update Interrupt). There is no latency between the UIF and UIFCPY flags assertion.  TI1 backward jitter   jitter up down TI2 Counter forward   forward MS33108V1 down

Advanced-control timer (TIM1)   RM0490  396/1027   RM0490 Rev 5  17.3.24   Timer input XOR function  The TI1S bit in the TIMx_CR2 register, allows the input filter of channel 1 to be connected to the output of an XOR gate, combining the three input pins TIMx_CH1, TIMx_CH2 and TIMx_CH3. The XOR output can be used with all the timer input functions such as trigger or input capture. It is convenient to measure the interval between edges on two input signals, as per  Figure 111   below.  Figure 111. Measuring time interval between edges on 3 signals 17.3.25   Interfacing with Hall sensors  This is done using the advanced-control timer (TIM1) to generate PWM signals to drive the motor and another timer TIMx (TIM3) referred to as “interfacing timer” in   Figure 112 . The “interfacing timer” captures the 3 timer input pins (CC1, CC2, CC3) connected through a XOR to the TI1 input channel (selected by setting the TI1S bit in the TIMx_CR2 register). The slave mode controller is configured in reset mode; the slave input is TI1F_ED. Thus, each time one of the 3 inputs toggles, the counter restarts counting from 0. This creates a time base triggered by any change on the Hall inputs. On the “interfacing timer”, capture/compare channel 1 is configured in capture mode, capture signal is TRC (See   Figure 85: Capture/compare channel (example: channel 1 input stage) on page 367 ). The captured value, which corresponds to the time elapsed between 2 changes on the inputs, gives information about motor speed. The “interfacing timer” can be used in output mode to generate a pulse which changes the configuration of the channels of the advanced-control timer (TIM1) (by triggering a COM event). The TIM1 timer is used to generate PWM signals to drive the motor. To do this, the interfacing timer channel must be programmed so that a positive pulse is generated after a programmed delay (in output compare or PWM mode). This pulse is sent to the advanced- control timer (TIM1) through the TRGO output.  MS33109V1 TI1 TI2 XOR Counter TI3 TIMx

RM0490 Rev 5   397/1027  RM0490   Advanced-control timer (TIM1)  442  Example: one wants to change the PWM configuration of the advanced-control timer TIM1 after a programmed delay each time a change occurs on the Hall inputs connected to one of the TIMx timers.  •   Configure 3 timer inputs ORed to the TI1 input channel by writing the TI1S bit in the TIMx_CR2 register to ‘1’,  •   Program the time base: write the TIMx_ARR to the max value (the counter must be cleared by the TI1 change. Set the prescaler to get a maximum counter period longer than the time between 2 changes on the sensors,  •   Program the channel 1 in capture mode (TRC selected): write the CC1S bits in the TIMx_CCMR1 register to ‘11’. The digital filter can also be programmed if needed,  •   Program the channel 2 in PWM 2 mode with the desired delay: write the OC2M bits to ‘111’ and the CC2S bits to ‘00’ in the TIMx_CCMR1 register,  •   Select OC2REF as trigger output on TRGO: write the MMS bits in the TIMx_CR2 register to ‘101’, In the advanced-control timer TIM1, the right ITR input must be selected as trigger input, the timer is programmed to generate PWM signals, the capture/compare control signals are preloaded (CCPC=1 in the TIMx_CR2 register) and the COM event is controlled by the trigger input (CCUS=1 in the TIMx_CR2 register). The PWM control bits (CCxE, OCxM) are written after a COM event for the next step (this can be done in an interrupt subroutine generated by the rising edge of OC2REF). The   Figure 112   describes this example.

Advanced-control timer (TIM1)   RM0490  398/1027   RM0490 Rev 5  Figure 112. Example of Hall sensor interface  Counter (CNT) TRGO=OC2REF (CCR2) OC1 OC1N COM Write CCxE, CCxNE TIH1 TIH2 TIH3 CCR1 OC2 OC2N OC3 OC3N C796 and OCxM for next step Interfacing timer Advanced-control timers (TIM1) MS32672V1 C7A3   C7A8   C794   C7A5   C7AB

RM0490 Rev 5   399/1027  RM0490   Advanced-control timer (TIM1)  442  17.3.26   Timer synchronization  The TIMx timers are linked together internally for timer synchronization or chaining. Refer to  Section 18.3.19: Timer synchronization   for details. They can be synchronized in several modes: Reset mode, Gated mode, and Trigger mode.  Slave mode: Reset mode  The counter and its prescaler can be reinitialized in response to an event on a trigger input. Moreover, if the URS bit from the TIMx_CR1 register is low, an update event UEV is generated. Then all the preloaded registers (TIMx_ARR, TIMx_CCRx) are updated. In the following example, the upcounter is cleared in response to a rising edge on TI1 input:  •   Configure the channel 1 to detect rising edges on TI1. Configure the input filter duration (in this example, we do not need any filter, so we keep IC1F=0000). The capture prescaler is not used for triggering, so it does not need to be configured. The CC1S bits select the input capture source only, CC1S = 01 in the TIMx_CCMR1 register. Write CC1P=0 and CC1NP=’0’ in TIMx_CCER register to validate the polarity (and detect rising edges only).  •   Configure the timer in reset mode by writing SMS=100 in TIMx_SMCR register. Select TI1 as the input source by writing TS=00101 in TIMx_SMCR register.  •   Start the counter by writing CEN=1 in the TIMx_CR1 register. The counter starts counting on the internal clock, then behaves normally until TI1 rising edge. When TI1 rises, the counter is cleared and restarts from 0. In the meantime, the trigger flag is set (TIF bit in the TIMx_SR register) and an interrupt request, or a DMA request can be sent if enabled (depending on the TIE and TDE bits in TIMx_DIER register). The following figure shows this behavior when the auto-reload register TIMx_ARR=0x36. The delay between the rising edge on TI1 and the actual reset of the counter is due to the resynchronization circuit on TI1 input.  Figure 113. Control circuit in reset mode  MS31401V1 00 Counter clock = ck_cnt = ck_psc Counter register   01   02   03   00   01   02   03 32   33   34   35   36 UG TI1 31 30 TIF

Advanced-control timer (TIM1)   RM0490  400/1027   RM0490 Rev 5  Slave mode: Gated mode  The counter can be enabled depending on the level of a selected input. In the following example, the upcounter counts only when TI1 input is low:  •   Configure the channel 1 to detect low levels on TI1. Configure the input filter duration (in this example, we do not need any filter, so we keep IC1F=0000). The capture prescaler is not used for triggering, so it does not need to be configured. The CC1S bits select the input capture source only, CC1S=01 in TIMx_CCMR1 register. Write CC1P=1 and CC1NP=’0’ in TIMx_CCER register to validate the polarity (and detect low level only).  •   Configure the timer in gated mode by writing SMS=101 in TIMx_SMCR register. Select TI1 as the input source by writing TS=00101 in TIMx_SMCR register.  •   Enable the counter by writing CEN=1 in the TIMx_CR1 register (in gated mode, the counter doesn’t start if CEN=0, whatever is the trigger input level). The counter starts counting on the internal clock as long as TI1 is low and stops as soon as TI1 becomes high. The TIF flag in the TIMx_SR register is set both when the counter starts or stops. The delay between the rising edge on TI1 and the actual stop of the counter is due to the resynchronization circuit on TI1 input.  Figure 114. Control circuit in Gated mode Slave mode: Trigger mode  The counter can start in response to an event on a selected input. In the following example, the upcounter starts in response to a rising edge on TI2 input:  •   Configure the channel 2 to detect rising edges on TI2. Configure the input filter duration (in this example, we do not need any filter, so we keep IC2F=0000). The capture prescaler is not used for triggering, so it does not need to be configured. The CC2S bits are configured to select the input capture source only, CC2S=01 in TIMx_CCMR1  MS31402V1 TI1 cnt_en Write TIF=0 37 Counter clock = ck_cnt = ck_psc Counter register   38 32   33   34   35   36 31 30 TIF

RM0490 Rev 5   401/1027  RM0490   Advanced-control timer (TIM1)  442  register. Write CC2P=1 and CC2NP=0 in TIMx_CCER register to validate the polarity (and detect low level only).  •   Configure the timer in trigger mode by writing SMS=110 in TIMx_SMCR register. Select TI2 as the input source by writing TS=00110 in TIMx_SMCR register. When a rising edge occurs on TI2, the counter starts counting on the internal clock and the TIF flag is set. The delay between the rising edge on TI2 and the actual start of the counter is due to the resynchronization circuit on TI2 input.  Figure 115. Control circuit in trigger mode Slave mode: Combined reset + trigger mode  In this case, a rising edge of the selected trigger input (TRGI) reinitializes the counter, generates an update of the registers, and starts the counter. This mode is used for one-pulse mode.  Slave mode: external clock mode 2 + trigger mode  The external clock mode 2 can be used in addition to another slave mode (except external clock mode 1 and encoder mode). In this case, the ETR signal is used as external clock input, and another input can be selected as trigger input (in reset mode, gated mode or trigger mode). It is recommended not to select ETR as TRGI through the TS bits of TIMx_SMCR register.  MS31403V1 TI2 cnt_en 37 Counter clock = ck_cnt = ck_psc Counter register   38 34   35   36 TIF

Advanced-control timer (TIM1)   RM0490  402/1027   RM0490 Rev 5  In the following example, the upcounter is incremented at each rising edge of the ETR signal as soon as a rising edge of TI1 occurs: 1.   Configure the external trigger input circuit by programming the TIMx_SMCR register as follows: –   ETF = 0000: no filter –   ETPS = 00: prescaler disabled –   ETP = 0: detection of rising edges on ETR and ECE=1 to enable the external clock mode 2. 2.   Configure the channel 1 as follows, to detect rising edges on TI: –   IC1F = 0000: no filter. –   The capture prescaler is not used for triggering and does not need to be configured. –   CC1S = 01 in TIMx_CCMR1 register to select only the input capture source –   CC1P = 0 and CC1NP = 0 in TIMx_CCER register to validate the polarity (and detect rising edge only). 3.   Configure the timer in trigger mode by writing SMS=110 in TIMx_SMCR register. Select TI1 as the input source by writing TS=00101 in TIMx_SMCR register. A rising edge on TI1 enables the counter and sets the TIF flag. The counter then counts on ETR rising edges. The delay between the rising edge of the ETR signal and the actual reset of the counter is due to the resynchronization circuit on ETRP input.  Figure 116. Control circuit in external clock mode 2 + trigger mode  Note:   The clock of the slave peripherals (timer, ADC, ...) receiving the TRGO or the TRGO2 signals must be enabled prior to receive events from the master timer, and the clock frequency (prescaler) must not be changed on-the-fly while triggers are received from the master timer.  MS33110V1 34   35   36 TIF Counter register Counter clock = CK_CNT = CK_PSC ETR CEN/CNT_EN TI1

RM0490 Rev 5   403/1027  RM0490   Advanced-control timer (TIM1)  442  17.3.27   ADC synchronization  The timer can generate an ADC triggering event with various internal signals, such as reset, enable or compare events. It is also possible to generate a pulse issued by internal edge detectors, such as: –   Rising and falling edges of OC4ref –   Rising edge on OC5ref or falling edge on OC6ref The triggers are issued on the TRGO2 internal line which is redirected to the ADC. There is a total of 16 possible events, which can be selected using the MMS2[3:0] bits in the TIMx_CR2 register. An example of an application for 3-phase motor drives is given in   Figure 96 on page 379 .  Note:   The clock of the slave peripherals (timer, ADC, ...) receiving the TRGO or the TRGO2 signals must be enabled prior to receive events from the master timer, and the clock frequency (prescaler) must not be changed on-the-fly while triggers are received from the master timer. Note:   The clock of the ADC must be enabled prior to receive events from the master timer, and must not be changed on-the-fly while triggers are received from the timer.  17.3.28   DMA burst mode  The TIMx timers have the capability to generate multiple DMA requests upon a single event. The main purpose is to be able to re-program part of the timer multiple times without software overhead, but it can also be used to read several registers in a row, at regular intervals. The DMA controller destination is unique and must point to the virtual register TIMx_DMAR. On a given timer event, the timer launches a sequence of DMA requests (burst). Each write into the TIMx_DMAR register is actually redirected to one of the timer registers. The DBL[4:0] bits in the TIMx_DCR register set the DMA burst length. The timer recognizes a burst transfer when a read or a write access is done to the TIMx_DMAR address), i.e. the number of transfers (either in half-words or in bytes). The DBA[4:0] bits in the TIMx_DCR registers define the DMA base address for DMA transfers (when read/write access are done through the TIMx_DMAR address). DBA is defined as an offset starting from the address of the TIMx_CR1 register: Example: 00000: TIMx_CR1 00001: TIMx_CR2 00010: TIMx_SMCR As an example, the timer DMA burst feature is used to update the contents of the CCRx registers (x = 2, 3, 4) upon an update event, with the DMA transferring half words into the CCRx registers.

Advanced-control timer (TIM1)   RM0490  404/1027   RM0490 Rev 5  This is done in the following steps: 1.   Configure the corresponding DMA channel as follows: –   DMA channel peripheral address is the DMAR register address –   DMA channel memory address is the address of the buffer in the RAM containing the data to be transferred by DMA into CCRx registers. –   Number of data to transfer = 3 (See note below). –   Circular mode disabled. 2.   Configure the DCR register by configuring the DBA and DBL bit fields as follows: DBL = 3 transfers, DBA = 0xE. 3.   Enable the TIMx update DMA request (set the UDE bit in the DIER register). 4.   Enable TIMx 5.   Enable the DMA channel This example is for the case where every CCRx register to be updated once. If every CCRx register is to be updated twice for example, the number of data to transfer should be 6. Let's take the example of a buffer in the RAM containing data1, data2, data3, data4, data5 and data6. The data is transferred to the CCRx registers as follows: on the first update DMA request, data1 is transferred to CCR2, data2 is transferred to CCR3, data3 is transferred to CCR4 and on the second update DMA request, data4 is transferred to CCR2, data5 is transferred to CCR3 and data6 is transferred to CCR4.  Note:   A null value can be written to the reserved registers.  17.3.29   Debug mode  When the microcontroller enters debug mode (Cortex   ® -M0+ core halted), the TIMx counter either continues to work normally or stops, depending on DBG_TIMx_STOP configuration bit in DBG module. For safety purposes, when the counter is stopped, the outputs are disabled (as if the MOE bit was reset). The outputs can either be forced to an inactive state (OSSI bit = 1), or have their control taken over by the GPIO controller (OSSI bit = 0), typically to force a Hi-Z. For more details, refer to section Debug support (DBG).

RM0490 Rev 5   405/1027  RM0490   Advanced-control timer (TIM1)  442  17.4   TIM1 registers  Refer to for a list of abbreviations used in register descriptions. The peripheral registers can be accessed by half-words (16-bit) or words (32-bit).  17.4.1   TIM1 control register 1 (TIM1_CR1)  Address offset: 0x00 Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   UIFRE MAP   Res.   CKD[1:0]   ARPE   CMS[1:0]   DIR   OPM   URS   UDIS   CEN rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:12   Reserved, must be kept at reset value. Bit 11   UIFREMAP : UIF status bit remapping 0: No remapping. UIF status bit is not copied to TIMx_CNT register bit 31. 1: Remapping enabled. UIF status bit is copied to TIMx_CNT register bit 31. Bit 10   Reserved, must be kept at reset value. Bits 9:8   CKD[1:0] : Clock division This bit-field indicates the division ratio between the timer clock (CK_INT) frequency and the dead-time and sampling clock (t DTS )used by the dead-time generators and the digital filters (ETR, TIx): 00: t DTS =t CK_INT 01: t DTS =2*t   CK_INT 10: t DTS =4*t   CK_INT 11: Reserved, do not program this value  Note:   t   DTS   = 1/f DTS   , t   CK_INT   = 1/f   CK_INT .  Bit 7   ARPE : Auto-reload preload enable 0: TIMx_ARR register is not buffered 1: TIMx_ARR register is buffered Bits 6:5   CMS[1:0] : Center-aligned mode selection 00: Edge-aligned mode. The counter counts up or down depending on the direction bit (DIR). 01: Center-aligned mode 1. The counter counts up and down alternatively. Output compare interrupt flags of channels configured in output (CCxS=00 in TIMx_CCMRx register) are set only when the counter is counting down. 10: Center-aligned mode 2. The counter counts up and down alternatively. Output compare interrupt flags of channels configured in output (CCxS=00 in TIMx_CCMRx register) are set only when the counter is counting up. 11: Center-aligned mode 3. The counter counts up and down alternatively. Output compare interrupt flags of channels configured in output (CCxS=00 in TIMx_CCMRx register) are set both when the counter is counting up or down.  Note:   Switch from edge-aligned mode to center-aligned mode as long as the counter is enabled (CEN=1) is not allowed

Advanced-control timer (TIM1)   RM0490  406/1027   RM0490 Rev 5  17.4.2   TIM1 control register 2 (TIM1_CR2)  Address offset: 0x04 Reset value: 0x0000 0000 Bit 4   DIR : Direction 0: Counter used as upcounter 1: Counter used as downcounter  Note:   This bit is read only when the timer is configured in Center-aligned mode or Encoder mode.  Bit 3   OPM : One pulse mode 0: Counter is not stopped at update event 1: Counter stops counting at the next update event (clearing the bit CEN) Bit 2   URS :   Update request source This bit is set and cleared by software to select the UEV event sources. 0: Any of the following events generate an update interrupt or DMA request if enabled. These events can be: –   Counter overflow/underflow –   Setting the UG bit –   Update generation through the slave mode controller 1: Only counter overflow/underflow generates an update interrupt or DMA request if enabled. Bit 1   UDIS :   Update disable This bit is set and cleared by software to enable/disable UEV event generation. 0: UEV enabled. The Update (UEV) event is generated by one of the following events: –   Counter overflow/underflow –   Setting the UG bit –   Update generation through the slave mode controller Buffered registers are then loaded with their preload values. 1: UEV disabled. The Update event is not generated, shadow registers keep their value (ARR, PSC, CCRx). However the counter and the prescaler are reinitialized if the UG bit is set or if a hardware reset is received from the slave mode controller. Bit 0   CEN : Counter enable 0: Counter disabled 1: Counter enabled  Note:   External clock, gated mode and encoder mode can work only if the CEN bit has been previously set by software. However trigger mode can set the CEN bit automatically by hardware.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   MMS2[3:0]   Res.   OIS6   Res.   OIS5 rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   OIS4   OIS3N   OIS3   OIS2N   OIS2   OIS1N   OIS1   TI1S   MMS[2:0]   CCDS   CCUS   Res.   CCPC rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

RM0490 Rev 5   407/1027  RM0490   Advanced-control timer (TIM1)  442  Bits 31:24   Reserved, must be kept at reset value. Bits 23:20   MMS2[3:0] : Master mode selection 2 These bits allow the information to be sent to ADC for synchronization (TRGO2) to be selected. The combination is as follows: 0000:   Reset   - the UG bit from the TIMx_EGR register is used as trigger output (TRGO2). If the reset is generated by the trigger input (slave mode controller configured in reset mode), the signal on TRGO2 is delayed compared to the actual reset. 0001:   Enable   - the Counter Enable signal CNT_EN is used as trigger output (TRGO2). It is useful to start several timers at the same time or to control a window in which a slave timer is enabled. The Counter Enable signal is generated by a logic AND between the CEN control bit and the trigger input when configured in Gated mode. When the Counter Enable signal is controlled by the trigger input, there is a delay on TRGO2, except if the Master/Slave mode is selected (see the MSM bit description in TIMx_SMCR register). 0010:   Update   - the update event is selected as trigger output (TRGO2). For instance, a master timer can then be used as a prescaler for a slave timer. 0011:   Compare pulse   - the trigger output sends a positive pulse when the CC1IF flag is to be set (even if it was already high), as soon as a capture or compare match occurs (TRGO2). 0100:   Compare   - OC1REFC signal is used as trigger output (TRGO2) 0101:   Compare   - OC2REFC signal is used as trigger output (TRGO2) 0110:   Compare   - OC3REFC signal is used as trigger output (TRGO2) 0111:   Compare   - OC4REFC signal is used as trigger output (TRGO2) 1000:   Compare   - OC5REFC signal is used as trigger output (TRGO2) 1001:   Compare   - OC6REFC signal is used as trigger output (TRGO2) 1010:   Compare Pulse   - OC4REFC rising or falling edges generate pulses on TRGO2 1011:   Compare Pulse   - OC6REFC rising or falling edges generate pulses on TRGO2 1100:   Compare Pulse   - OC4REFC or OC6REFC rising edges generate pulses on TRGO2 1101:   Compare Pulse   - OC4REFC rising or OC6REFC falling edges generate pulses on TRGO2 1110:   Compare Pulse   - OC5REFC or OC6REFC rising edges generate pulses on TRGO2 1111:   Compare Pulse   - OC5REFC rising or OC6REFC falling edges generate pulses on TRGO2  Note:   The clock of the slave timer or ADC must be enabled prior to receive events from the master timer, and must not be changed on-the-fly while triggers are received from the master timer.  Bit 19   Reserved, must be kept at reset value. Bit 18   OIS6 : Output Idle state 6 (OC6 output) Refer to OIS1 bit Bit 17   Reserved, must be kept at reset value. Bit 16   OIS5 : Output Idle state 5 (OC5 output) Refer to OIS1 bit Bit 15   Reserved, must be kept at reset value. Bit 14   OIS4 : Output Idle state 4 (OC4 output) Refer to OIS1 bit Bit 13   OIS3N : Output Idle state 3 (OC3N output) Refer to OIS1N bit

Advanced-control timer (TIM1)   RM0490  408/1027   RM0490 Rev 5  Bit 12   OIS3 : Output Idle state 3 (OC3 output) Refer to OIS1 bit Bit 11   OIS2N : Output Idle state 2 (OC2N output) Refer to OIS1N bit Bit 10   OIS2 : Output Idle state 2 (OC2 output) Refer to OIS1 bit Bit 9   OIS1N : Output Idle state 1 (OC1N output) 0: OC1N=0 after a dead-time when MOE=0 1: OC1N=1 after a dead-time when MOE=0  Note:   This bit can not be modified as long as LOCK level 1, 2 or 3 has been programmed (LOCK bits in TIMx_BDTR register).  Bit 8   OIS1 : Output Idle state 1 (OC1 output) 0: OC1=0 (after a dead-time if OC1N is implemented) when MOE=0 1: OC1=1 (after a dead-time if OC1N is implemented) when MOE=0  Note:   This bit can not be modified as long as LOCK level 1, 2 or 3 has been programmed (LOCK bits in TIMx_BDTR register).  Bit 7   TI1S : TI1 selection 0: The TIMx_CH1 pin is connected to TI1 input 1: The TIMx_CH1, CH2 and CH3 pins are connected to the TI1 input (XOR combination) Bits 6:4   MMS[2:0] : Master mode selection These bits allow selected information to be sent in master mode to slave timers for synchronization (TRGO). The combination is as follows: 000:   Reset   - the UG bit from the TIMx_EGR register is used as trigger output (TRGO). If the reset is generated by the trigger input (slave mode controller configured in reset mode) then the signal on TRGO is delayed compared to the actual reset. 001:   Enable   - the Counter Enable signal CNT_EN is used as trigger output (TRGO). It is useful to start several timers at the same time or to control a window in which a slave timer is enable. The Counter Enable signal is generated by a logic AND between CEN control bit and the trigger input when configured in gated mode. When the Counter Enable signal is controlled by the trigger input, there is a delay on TRGO, except if the master/slave mode is selected (see the MSM bit description in TIMx_SMCR register). 010:   Update   - The update event is selected as trigger output (TRGO). For instance a master timer can then be used as a prescaler for a slave timer. 011:   Compare Pulse   - The trigger output send a positive pulse when the CC1IF flag is to be set (even if it was already high), as soon as a capture or a compare match occurred. (TRGO). 100:   Compare   - OC1REFC signal is used as trigger output (TRGO) 101:   Compare   - OC2REFC signal is used as trigger output (TRGO) 110:   Compare   - OC3REFC signal is used as trigger output (TRGO) 111:   Compare   - OC4REFC signal is used as trigger output (TRGO)  Note:   The clock of the slave timer or ADC must be enabled prior to receive events from the master timer, and must not be changed on-the-fly while triggers are received from the master timer.  Bit 3   CCDS : Capture/compare DMA selection 0: CCx DMA request sent when CCx event occurs 1: CCx DMA requests sent when update event occurs

RM0490 Rev 5   409/1027  RM0490   Advanced-control timer (TIM1)  442  17.4.3   TIM1 slave mode control register (TIM1_SMCR)  Address offset: 0x08 Reset value: 0x0000 0000 Bit 2   CCUS :   Capture/compare control update selection 0: When capture/compare control bits are preloaded (CCPC=1), they are updated by setting the COMG bit only 1: When capture/compare control bits are preloaded (CCPC=1), they are updated by setting the COMG bit or when an rising edge occurs on TRGI  Note:   This bit acts only on channels that have a complementary output.  Bit 1   Reserved, must be kept at reset value. Bit 0   CCPC : Capture/compare preloaded control 0: CCxE, CCxNE and OCxM bits are not preloaded 1: CCxE, CCxNE and OCxM bits are preloaded, after having been written, they are updated only when a commutation event (COM) occurs (COMG bit set or rising edge detected on TRGI, depending on the CCUS bit).  Note:   This bit acts only on channels that have a complementary output.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TS[4:3]   Res.   Res.   Res.   SMS[3] rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ETP   ECE   ETPS[1:0]   ETF[3:0]   MSM   TS[2:0]   OCCS   SMS[2:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:22   Reserved, must be kept at reset value. Bits 19:17   Reserved, must be kept at reset value. Bit 15   ETP : External trigger polarity This bit selects whether ETR or ETR is used for trigger operations 0: ETR is non-inverted, active at high level or rising edge. 1: ETR is inverted, active at low level or falling edge. Bit 14   ECE : External clock enable This bit enables External clock mode 2. 0: External clock mode 2 disabled 1: External clock mode 2 enabled. The counter is clocked by any active edge on the ETRF signal.  Note:   Setting the ECE bit has the same effect as selecting external clock mode 1 with TRGI connected to ETRF (SMS=111 and TS=00111). It is possible to simultaneously use external clock mode 2 with the following slave modes: reset mode, gated mode and trigger mode. Nevertheless, TRGI must not be connected to ETRF in this case (TS bits must not be 00111). If external clock mode 1 and external clock mode 2 are enabled at the same time, the external clock input is ETRF.

Advanced-control timer (TIM1)   RM0490  410/1027   RM0490 Rev 5  Bits 13:12   ETPS[1:0] : External trigger prescaler External trigger signal ETRP frequency must be at most 1/4 of f CK_INT   frequency. A prescaler can be enabled to reduce ETRP frequency. It is useful when inputting fast external clocks. 00: Prescaler OFF 01: ETRP frequency divided by 2 10: ETRP frequency divided by 4 11: ETRP frequency divided by 8 Bits 11:8   ETF[3:0] : External trigger filter This bit-field then defines the frequency used to sample ETRP signal and the length of the digital filter applied to ETRP. The digital filter is made of an event counter in which N consecutive events are needed to validate a transition on the output: 0000: No filter, sampling is done at f   DTS 0001: f   SAMPLING   =f   CK_INT , N=2 0010: f   SAMPLING   =f   CK_INT , N=4 0011: f SAMPLING   =f   CK_INT   , N=8 0100: f   SAMPLING   =f   DTS   /2, N=6 0101: f   SAMPLING   =f   DTS   /2, N=8 0110: f   SAMPLING   =f   DTS   /4, N=6 0111: f   SAMPLING =f   DTS   /4, N=8 1000: f   SAMPLING   =f   DTS   /8, N=6 1001: f   SAMPLING   =f   DTS   /8, N=8 1010: f   SAMPLING   =f   DTS   /16, N=5 1011: f SAMPLING   =f   DTS   /16, N=6 1100: f   SAMPLING   =f   DTS   /16, N=8 1101: f   SAMPLING   =f   DTS   /32, N=5 1110: f   SAMPLING =f   DTS   /32, N=6 1111: f   SAMPLING =f DTS   /32, N=8 Bit 7   MSM:   Master/slave mode 0: No action 1: The effect of an event on the trigger input (TRGI) is delayed to allow a perfect synchronization between the current timer and its slaves (through TRGO). It is useful if we want to synchronize several timers on a single external event. Bits 21, 20, 6, 5, 4   TS[4:0]:   Trigger selection This bit-field selects the trigger input to be used to synchronize the counter. 00000: Internal Trigger 0 (ITR0) 00001: Internal Trigger 1 (ITR1) 00010: Internal Trigger 2 (ITR2) 00011: Internal Trigger 3 (ITR3) 00100: TI1 Edge Detector (TI1F_ED) 00101: Filtered Timer Input 1 (TI1FP1) 00110: Filtered Timer Input 2 (TI2FP2) 00111: External Trigger input (ETRF) Others: Reserved See   Table 80: TIM1 internal trigger connection on page 411   for more details on ITRx meaning for each Timer.  Note:   These bits must be changed only when they are not used (e.g. when SMS=000) to avoid wrong edge detections at the transition.  Bit 3   OCCS:   OCREF clear selection This bit is used to select the OCREF clear source. 0: OCREF_CLR_INT is not connected (reserved configuration) 1: OCREF_CLR_INT is connected to ETRF

RM0490 Rev 5   411/1027  RM0490   Advanced-control timer (TIM1)  442  17.4.4   TIM1 DMA/interrupt enable register (TIM1_DIER)  Address offset: 0x0C Reset value: 0x0000 Bits 16, 2, 1, 0   SMS[3:0]:   Slave mode selection When external signals are selected the active edge of the trigger signal (TRGI) is linked to the polarity selected on the external input (refer to ETP bit in TIMx_SMCR for tim_etr_in and CCxP/CCxNP bits in TIMx_CCER register for tim_ti1fp1 and tim_ti2fp2). 0000: Slave mode disabled - if CEN = ‘1’ then the prescaler is clocked directly by the internal clock. 0001: Encoder mode 1 - Counter counts up/down on TI1FP1 edge depending on TI2FP2 level. 0010: Encoder mode 2 - Counter counts up/down on TI2FP2 edge depending on TI1FP1 level. 0011: Encoder mode 3 - Counter counts up/down on both TI1FP1 and TI2FP2 edges depending on the level of the other input. 0100: Reset Mode - Rising edge of the selected trigger input (TRGI) reinitializes the counter and generates an update of the registers. 0101: Gated Mode - The counter clock is enabled when the trigger input (TRGI) is high. The counter stops (but is not reset) as soon as the trigger becomes low. Both start and stop of the counter are controlled. 0110: Trigger Mode - The counter starts at a rising edge of the trigger TRGI (but it is not reset). Only the start of the counter is controlled. 0111: External Clock Mode 1 - Rising edges of the selected trigger (TRGI) clock the counter. 1000: Combined reset + trigger mode - Rising edge of the selected trigger input (TRGI) reinitializes the counter, generates an update of the registers and starts the counter. Codes above 1000: Reserved.  Note:   The gated mode must not be used if TI1F_ED is selected as the trigger input (TS=00100). Indeed, TI1F_ED outputs 1 pulse for each transition on TI1F, whereas the gated mode checks the level of the trigger signal. Note:   The clock of the slave peripherals (timer, ADC, ...) receiving the TRGO or the TRGO2 signals must be enabled prior to receive events from the master timer, and the clock frequency (prescaler) must not be changed on-the-fly while triggers are received from the master timer.  Table 80. TIM1 internal trigger connection Slave TIM   ITR0 (TS = 00000)   ITR1 (TS = 00001)   ITR2 (TS = 00010)   ITR3 (TS = 00011)  TIM1   TIM15 (1) 1.   Applies only to STM32C091xx/92xx devices. TIM2   (2) 2.   Applies only to STM32C051xx/71xx/91xx/92xx devices. TIM3   TIM17 OC1 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   TDE   COMDE   CC4DE   CC3DE   CC2DE   CC1DE   UDE   BIE   TIE   COMIE   CC4IE   CC3IE   CC2IE   CC1IE   UIE rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

Advanced-control timer (TIM1)   RM0490  412/1027   RM0490 Rev 5  Bit 15   Reserved, must be kept at reset value. Bit 14   TDE : Trigger DMA request enable 0: Trigger DMA request disabled 1: Trigger DMA request enabled Bit 13   COMDE : COM DMA request enable 0: COM DMA request disabled 1: COM DMA request enabled Bit 12   CC4DE : Capture/Compare 4 DMA request enable 0: CC4 DMA request disabled 1: CC4 DMA request enabled Bit 11   CC3DE : Capture/Compare 3 DMA request enable 0: CC3 DMA request disabled 1: CC3 DMA request enabled Bit 10   CC2DE : Capture/Compare 2 DMA request enable 0: CC2 DMA request disabled 1: CC2 DMA request enabled Bit 9   CC1DE : Capture/Compare 1 DMA request enable 0: CC1 DMA request disabled 1: CC1 DMA request enabled Bit 8   UDE : Update DMA request enable 0: Update DMA request disabled 1: Update DMA request enabled Bit 7   BIE : Break interrupt enable 0: Break interrupt disabled 1: Break interrupt enabled Bit 6   TIE : Trigger interrupt enable 0: Trigger interrupt disabled 1: Trigger interrupt enabled Bit 5   COMIE : COM interrupt enable 0: COM interrupt disabled 1: COM interrupt enabled Bit 4   CC4IE : Capture/Compare 4 interrupt enable 0: CC4 interrupt disabled 1: CC4 interrupt enabled Bit 3   CC3IE : Capture/Compare 3 interrupt enable 0: CC3 interrupt disabled 1: CC3 interrupt enabled

RM0490 Rev 5   413/1027  RM0490   Advanced-control timer (TIM1)  442  17.4.5   TIM1 status register (TIM1_SR)  Address offset: 0x10 Reset value: 0x0000 0000 Bit 2   CC2IE : Capture/Compare 2 interrupt enable 0: CC2 interrupt disabled 1: CC2 interrupt enabled Bit 1   CC1IE : Capture/Compare 1 interrupt enable 0: CC1 interrupt disabled 1: CC1 interrupt enabled Bit 0   UIE : Update interrupt enable 0: Update interrupt disabled 1: Update interrupt enabled 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CC6IF   CC5IF rc_w0   rc_w0 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   SBIF   CC4OF   CC3OF   CC2OF   CC1OF   B2IF   BIF   TIF   COMIF   CC4IF   CC3IF   CC2IF   CC1IF   UIF rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0 Bits 31:18   Reserved, must be kept at reset value. Bit 17   CC6IF : Compare 6 interrupt flag Refer to CC1IF description (Note: Channel 6 can only be configured as output) Bit 16   CC5IF : Compare 5 interrupt flag Refer to CC1IF description (Note: Channel 5 can only be configured as output) Bits 15:14   Reserved, must be kept at reset value. Bit 13   SBIF : System Break interrupt flag This flag is set by hardware as soon as the system break input goes active. It can be cleared by software if the system break input is not active. This flag must be reset to re-start PWM operation. 0: No break event occurred. 1: An active level has been detected on the system break input. An interrupt is generated if BIE=1 in the TIMx_DIER register. Bit 12   CC4OF : Capture/Compare 4 overcapture flag Refer to CC1OF description Bit 11   CC3OF : Capture/Compare 3 overcapture flag Refer to CC1OF description Bit 10   CC2OF : Capture/Compare 2 overcapture flag Refer to CC1OF description

Advanced-control timer (TIM1)   RM0490  414/1027   RM0490 Rev 5  Bit 9   CC1OF : Capture/Compare 1 overcapture flag This flag is set by hardware only when the corresponding channel is configured in input capture mode. It is cleared by software by writing it to ‘0’. 0: No overcapture has been detected. 1: The counter value has been captured in TIMx_CCR1 register while CC1IF flag was already set Bit 8   B2IF : Break 2 interrupt flag This flag is set by hardware as soon as the break 2 input goes active. It can be cleared by software if the break 2 input is not active. 0: No break event occurred. 1: An active level has been detected on the break 2 input. An interrupt is generated if BIE=1 in the TIMx_DIER register. Bit 7   BIF : Break interrupt flag This flag is set by hardware as soon as the break input goes active. It can be cleared by software if the break input is not active. 0: No break event occurred. 1: An active level has been detected on the break input. An interrupt is generated if BIE=1 in the TIMx_DIER register. Bit 6   TIF : Trigger interrupt flag This flag is set by hardware on the TRG trigger event (active edge detected on TRGI input when the slave mode controller is enabled in all modes but gated mode. It is set when the counter starts or stops when gated mode is selected. It is cleared by software. 0: No trigger event occurred. 1: Trigger interrupt pending. Bit 5   COMIF : COM interrupt flag This flag is set by hardware on COM event (when Capture/compare Control bits - CCxE, CCxNE, OCxM - have been updated). It is cleared by software. 0: No COM event occurred. 1: COM interrupt pending. Bit 4   CC4IF : Capture/Compare 4 interrupt flag Refer to CC1IF description Bit 3   CC3IF : Capture/Compare 3 interrupt flag Refer to CC1IF description Bit 2   CC2IF : Capture/Compare 2 interrupt flag Refer to CC1IF description Bit 1   CC1IF : Capture/Compare 1 interrupt flag This flag is set by hardware. It is cleared by software (input capture or output compare mode) or by reading the TIMx_CCR1 register (input capture mode only). 0: No compare match / No input capture occurred 1: A compare match or an input capture occurred.  If channel CC1 is configured as output : this flag is set when the content of the counter TIMx_CNT matches the content of the TIMx_CCR1 register. When the content of TIMx_CCR1 is greater than the content of TIMx_ARR, the CC1IF bit goes high on the counter overflow (in up-counting and up/down-counting modes) or underflow (in down- counting mode). There are 3 possible options for flag setting in center-aligned mode, refer to the CMS bits in the TIMx_CR1 register for the full description.  If channel CC1 is configured as input : this bit is set when counter value has been captured in TIMx_CCR1 register (an edge has been detected on IC1, as per the edge sensitivity defined with the CC1P and CC1NP bits setting, in TIMx_CCER).

RM0490 Rev 5   415/1027  RM0490   Advanced-control timer (TIM1)  442  17.4.6   TIM1 event generation register (TIM1_EGR)  Address offset: 0x14 Reset value: 0x0000 Bit 0   UIF : Update interrupt flag This bit is set by hardware on an update event. It is cleared by software. 0: No update occurred. 1: Update interrupt pending. This bit is set by hardware when the registers are updated: – At overflow or underflow regarding the repetition counter value (update if repetition counter = 0) and if the UDIS=0 in the TIMx_CR1 register. – When CNT is reinitialized by software using the UG bit in TIMx_EGR register, if URS=0 and UDIS=0 in the TIMx_CR1 register. – When CNT is reinitialized by a trigger event (refer to   Section 17.4.3: TIM1 slave mode control register (TIM1_SMCR) ), if URS=0 and UDIS=0 in the TIMx_CR1 register. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   B2G   BG   TG   COMG   CC4G   CC3G   CC2G   CC1G   UG w   w   w   w   w   w   w   w   w Bits 15:9   Reserved, must be kept at reset value. Bit 8   B2G : Break 2 generation This bit is set by software in order to generate an event, it is automatically cleared by hardware. 0: No action 1: A break 2 event is generated. MOE bit is cleared and B2IF flag is set. Related interrupt can occur if enabled. Bit 7   BG : Break generation This bit is set by software in order to generate an event, it is automatically cleared by hardware. 0: No action 1: A break event is generated. MOE bit is cleared and BIF flag is set. Related interrupt or DMA transfer can occur if enabled. Bit 6   TG : Trigger generation This bit is set by software in order to generate an event, it is automatically cleared by hardware. 0: No action 1: The TIF flag is set in TIMx_SR register. Related interrupt or DMA transfer can occur if enabled. Bit 5   COMG :   Capture/Compare control update generation This bit can be set by software, it is automatically cleared by hardware 0: No action 1: When CCPC bit is set, it allows CCxE, CCxNE and OCxM bits to be updated.  Note:   This bit acts only on channels having a complementary output.  Bit 4   CC4G : Capture/Compare 4 generation Refer to CC1G description Bit 3   CC3G : Capture/Compare 3 generation Refer to CC1G description

Advanced-control timer (TIM1)   RM0490  416/1027   RM0490 Rev 5  17.4.7   TIM1 capture/compare mode register 1 (TIM1_CCMR1)  Address offset: 0x18 Reset value: 0x0000 0000 The same register can be used for input capture mode (this section) or for output compare mode (next section). The direction of a channel is defined by configuring the corresponding CCxS bits. All the other bits of this register have a different function for input capture and for output compare modes. It is possible to combine both modes independently (e.g. channel 1 in input capture mode and channel 2 in output compare mode).  Input capture mode:  Bit 2   CC2G : Capture/Compare 2 generation Refer to CC1G description Bit 1   CC1G : Capture/Compare 1 generation This bit is set by software in order to generate an event, it is automatically cleared by hardware. 0: No action 1: A capture/compare event is generated on channel 1:  If channel CC1 is configured as output:  CC1IF flag is set, Corresponding interrupt or DMA request is sent if enabled.  If channel CC1 is configured as input:  The current value of the counter is captured in TIMx_CCR1 register. The CC1IF flag is set, the corresponding interrupt or DMA request is sent if enabled. The CC1OF flag is set if the CC1IF flag was already high. Bit 0   UG : Update generation This bit can be set by software, it is automatically cleared by hardware. 0: No action 1: Reinitialize the counter and generates an update of the registers. The prescaler internal counter is also cleared (the prescaler ratio is not affected). The counter is cleared if the center-aligned mode is selected or if DIR=0 (upcounting), else it takes the auto-reload value (TIMx_ARR) if DIR=1 (downcounting). 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 IC2F[3:0]   IC2PSC[1:0]   CC2S[1:0]   IC1F[3:0]   IC1PSC[1:0]   CC1S[1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:12   IC2F[3:0] :   Input capture 2 filter Refer to IC1F[3:0] description. Bits 11:10   IC2PSC[1:0] : Input capture 2 prescaler Refer to IC1PSC[1:0] description.

RM0490 Rev 5   417/1027  RM0490   Advanced-control timer (TIM1)  442  17.4.8   TIM1 capture/compare mode register 1 [alternate] (TIM1_CCMR1)  Address offset: 0x18 Reset value: 0x0000 0000 The same register can be used for output compare mode (this section) or for input capture mode (previous section). The direction of a channel is defined by configuring the Bits 9:8   CC2S[1:0] : Capture/Compare 2 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC2 channel is configured as output 01: CC2 channel is configured as input, IC2 is mapped on TI2 10: CC2 channel is configured as input, IC2 is mapped on TI1 11: CC2 channel is configured as input, IC2 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC2S bits are writable only when the channel is OFF (CC2E = ‘0’ in TIMx_CCER).  Bits 7:4   IC1F[3:0] :   Input capture 1 filter This bit-field defines the frequency used to sample TI1 input and the length of the digital filter applied to TI1. The digital filter is made of an event counter in which N consecutive events are needed to validate a transition on the output: 0000: No filter, sampling is done at f   DTS 0001: f   SAMPLING =f CK_INT , N=2 0010: f   SAMPLING =f CK_INT , N=4 0011: f   SAMPLING =f   CK_INT , N=8 0100: f   SAMPLING =f DTS /2, N=6 0101: f   SAMPLING =f DTS /2, N=8 0110: f   SAMPLING =f   DTS /4, N=6 0111: f   SAMPLING =f   DTS /4, N=8 1000: f   SAMPLING =f DTS /8, N=6 1001: f   SAMPLING =f DTS /8, N=8 1010: f   SAMPLING =f DTS /16, N=5 1011: f   SAMPLING =f   DTS /16, N=6 1100: f   SAMPLING =f   DTS /16, N=8 1101: f   SAMPLING =f   DTS /32, N=5 1110: f   SAMPLING =f   DTS /32, N=6 1111: f   SAMPLING =f   DTS /32, N=8 Bits 3:2   IC1PSC[1:0] :   Input capture 1 prescaler This bit-field defines the ratio of the prescaler acting on CC1 input (IC1). The prescaler is reset as soon as CC1E=’0’ (TIMx_CCER register). 00: no prescaler, capture is done each time an edge is detected on the capture input 01: capture is done once every 2 events 10: capture is done once every 4 events 11: capture is done once every 8 events Bits 1:0   CC1S[1:0] : Capture/Compare 1 Selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC1 channel is configured as output 01: CC1 channel is configured as input, IC1 is mapped on TI1 10: CC1 channel is configured as input, IC1 is mapped on TI2 11: CC1 channel is configured as input, IC1 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC1S bits are writable only when the channel is OFF (CC1E = ‘0’ in TIMx_CCER).

Advanced-control timer (TIM1)   RM0490  418/1027   RM0490 Rev 5  corresponding CCxS bits. All the other bits of this register have a different function for input capture and for output compare modes. It is possible to combine both modes independently (e.g. channel 1 in input capture mode and channel 2 in output compare mode).  Output compare mode:  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC2M[3]   Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC1M[3] rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 OC2 CE   OC2M[2:0]   OC2 PE OC2 FE   CC2S[1:0]   OC1 CE   OC1M[2:0]   OC1 PE OC1 FE   CC1S[1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:25   Reserved, must be kept at reset value. Bits 23:17   Reserved, must be kept at reset value. Bit 15   OC2CE:   Output Compare 2 clear enable Refer to OC1CE description. Bits 24, 14:12   OC2M[3:0] : Output Compare 2 mode Refer to OC1M[3:0] description. Bit 11   OC2PE : Output Compare 2 preload enable Refer to OC1PE description. Bit 10   OC2FE : Output Compare 2 fast enable Refer to OC1FE description. Bits 9:8   CC2S[1:0] : Capture/Compare 2 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC2 channel is configured as output 01: CC2 channel is configured as input, IC2 is mapped on TI2 10: CC2 channel is configured as input, IC2 is mapped on TI1 11: CC2 channel is configured as input, IC2 is mapped on TRC. This mode is working only if an internal trigger input is selected through the TS bit (TIMx_SMCR register)  Note:   CC2S bits are writable only when the channel is OFF (CC2E = ‘0’ in TIMx_CCER).  Bit 7   OC1CE:   Output Compare 1 clear enable 0: OC1Ref is not affected by the ocref_clr_int signal 1: OC1Ref is cleared as soon as a High level is detected on ocref_clr_int signal (OCREF_CLR input or ETRF input)

RM0490 Rev 5   419/1027  RM0490   Advanced-control timer (TIM1)  442  Bits 16, 6:4   OC1M[3:0] : Output Compare 1 mode These bits define the behavior of the output reference signal OC1REF from which OC1 and OC1N are derived. OC1REF is active high whereas OC1 and OC1N active level depends on CC1P and CC1NP bits. 0000: Frozen - The comparison between the output compare register TIMx_CCR1 and the counter TIMx_CNT has no effect on the outputs. This mode can be used when the timer serves as a software timebase. When the frozen mode is enabled during timer operation, the output keeps the state (active or inactive) it had before entering the frozen state. 0001: Set channel 1 to active level on match. OC1REF signal is forced high when the counter TIMx_CNT matches the capture/compare register 1 (TIMx_CCR1). 0010: Set channel 1 to inactive level on match. OC1REF signal is forced low when the counter TIMx_CNT matches the capture/compare register 1 (TIMx_CCR1). 0011: Toggle - OC1REF toggles when TIMx_CNT=TIMx_CCR1. 0100: Force inactive level - OC1REF is forced low. 0101: Force active level - OC1REF is forced high. 0110: PWM mode 1 - In upcounting, channel 1 is active as long as TIMx_CNT<TIMx_CCR1 else inactive. In downcounting, channel 1 is inactive (OC1REF=‘0’) as long as TIMx_CNT>TIMx_CCR1 else active (OC1REF=’1’). 0111: PWM mode 2 - In upcounting, channel 1 is inactive as long as TIMx_CNT<TIMx_CCR1 else active. In downcounting, channel 1 is active as long as TIMx_CNT>TIMx_CCR1 else inactive. 1000: Retriggerable   OPM mode 1 - In up-counting mode, the channel is active until a trigger event is detected (on TRGI signal). Then, a comparison is performed as in PWM mode 1 and the channels becomes active again at the next update. In down-counting mode, the channel is inactive until a trigger event is detected (on TRGI signal). Then, a comparison is performed as in PWM mode 1 and the channels becomes inactive again at the next update. 1001: Retriggerable   OPM mode 2 - In up-counting mode, the channel is inactive until a trigger event is detected (on TRGI signal). Then, a comparison is performed as in PWM mode 2 and the channels becomes inactive again at the next update. In down- counting mode, the channel is active until a trigger event is detected (on TRGI signal). Then, a comparison is performed as in PWM mode 1 and the channels becomes active again at the next update. 1010: Reserved, 1011: Reserved, 1100: Combined PWM mode 1 - OC1REF has the same behavior as in PWM mode 1. OC1REFC is the logical OR between OC1REF and OC2REF. 1101: Combined PWM mode 2 - OC1REF has the same behavior as in PWM mode 2. OC1REFC is the logical AND between OC1REF and OC2REF. 1110: Asymmetric PWM mode 1 - OC1REF has the same behavior as in PWM mode 1. OC1REFC outputs OC1REF when the counter is counting up, OC2REF when it is counting down. 1111: Asymmetric PWM mode 2 - OC1REF has the same behavior as in PWM mode 2. OC1REFC outputs OC1REF when the counter is counting up, OC2REF when it is counting down.  Note:   These bits can not be modified as long as LOCK level 3 has been programmed (LOCK bits in TIMx_BDTR register) and CC1S=’00’ (the channel is configured in output). Note:   In PWM mode, the OCREF level changes only when the result of the comparison changes or when the output compare mode switches from “frozen” mode to “PWM” mode. Note:   On channels having a complementary output, this bit field is preloaded. If the CCPC bit is set in the TIMx_CR2 register then the OC1M active bits take the new value from the preloaded bits only when a COM event is generated. Note:   The OC1M[3] bit is not contiguous, located in bit 16.

Advanced-control timer (TIM1)   RM0490  420/1027   RM0490 Rev 5  17.4.9   TIM1 capture/compare mode register 2 (TIM1_CCMR2)  Address offset: 0x1C Reset value: 0x0000 0000 The same register can be used for input capture mode (this section) or for output compare mode (next section). The direction of a channel is defined by configuring the corresponding CCxS bits. All the other bits of this register have a different function for input capture and for output compare modes. It is possible to combine both modes independently (e.g. channel 1 in input capture mode and channel 2 in output compare mode).  Input capture mode:  Bit 3   OC1PE : Output Compare 1 preload enable 0: Preload register on TIMx_CCR1 disabled. TIMx_CCR1 can be written at anytime, the new value is taken in account immediately. 1: Preload register on TIMx_CCR1 enabled. Read/Write operations access the preload register. TIMx_CCR1 preload value is loaded in the active register at each update event.  Note:   These bits can not be modified as long as LOCK level 3 has been programmed (LOCK bits in TIMx_BDTR register) and CC1S=’00’ (the channel is configured in output).  Bit 2   OC1FE : Output Compare 1 fast enable This bit decreases the latency between a trigger event and a transition on the timer output. It must be used in one-pulse mode (OPM bit set in TIMx_CR1 register), to have the output pulse starting as soon as possible after the starting trigger. 0: CC1 behaves normally depending on counter and CCR1 values even when the trigger is ON. The minimum delay to activate CC1 output when an edge occurs on the trigger input is 5 clock cycles. 1: An active edge on the trigger input acts like a compare match on CC1 output. Then, OC is set to the compare level independently from the result of the comparison. Delay to sample the trigger input and to activate CC1 output is reduced to 3 clock cycles. OCFE acts only if the channel is configured in PWM1 or PWM2 mode. Bits 1:0   CC1S[1:0] : Capture/Compare 1 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC1 channel is configured as output 01: CC1 channel is configured as input, IC1 is mapped on TI1 10: CC1 channel is configured as input, IC1 is mapped on TI2 11: CC1 channel is configured as input, IC1 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC1S bits are writable only when the channel is OFF (CC1E = ‘0’ in TIMx_CCER).  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 IC4F[3:0]   IC4PSC[1:0]   CC4S[1:0]   IC3F[3:0]   IC3PSC[1:0]   CC3S[1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

RM0490 Rev 5   421/1027  RM0490   Advanced-control timer (TIM1)  442  17.4.10   TIM1 capture/compare mode register 2 [alternate] (TIM1_CCMR2)  Address offset: 0x1C Reset value: 0x0000 0000 The same register can be used for output compare mode (this section) or for input capture mode (previous section). The direction of a channel is defined by configuring the corresponding CCxS bits. All the other bits of this register have a different function for input capture and for output compare modes. It is possible to combine both modes independently (e.g. channel 1 in input capture mode and channel 2 in output compare mode).  Output compare mode  Bits 31:16   Reserved, must be kept at reset value. Bits 15:12   IC4F[3:0] :   Input capture 4 filter Refer to IC1F[3:0] description. Bits 11:10   IC4PSC[1:0] :   Input capture 4 prescaler Refer to IC1PSC[1:0] description. Bits 9:8   CC4S[1:0] : Capture/Compare 4 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC4 channel is configured as output 01: CC4 channel is configured as input, IC4 is mapped on TI4 10: CC4 channel is configured as input, IC4 is mapped on TI3 11: CC4 channel is configured as input, IC4 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC4S bits are writable only when the channel is OFF (CC4E = ‘0’ in TIMx_CCER).  Bits 7:4   IC3F[3:0] :   Input capture 3 filter Refer to IC1F[3:0] description. Bits 3:2   IC3PSC[1:0] :   Input capture 3 prescaler Refer to IC1PSC[1:0] description. Bits 1:0   CC3S[1:0] : Capture/compare 3 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC3 channel is configured as output 01: CC3 channel is configured as input, IC3 is mapped on TI3 10: CC3 channel is configured as input, IC3 is mapped on TI4 11: CC3 channel is configured as input, IC3 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC3S bits are writable only when the channel is OFF (CC3E = ‘0’ in TIMx_CCER).  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC4M[3]   Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC3M[3] rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 OC4 CE   OC4M[2:0]   OC4 PE OC4 FE   CC4S[1:0]   OC3 CE   OC3M[2:0]   OC3 PE OC3 FE   CC3S[1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

Advanced-control timer (TIM1)   RM0490  422/1027   RM0490 Rev 5  Bits 31:25   Reserved, must be kept at reset value. Bits 23:17   Reserved, must be kept at reset value. Bit 15   OC4CE : Output compare 4 clear enable Refer to OC1CE description. Bits 24, 14:12   OC4M[3:0] : Output compare 4 mode Refer to OC3M[3:0] description. Bit 11   OC4PE : Output compare 4 preload enable Refer to OC1PE description. Bit 10   OC4FE : Output compare 4 fast enable Refer to OC1FE description. Bits 9:8   CC4S[1:0] : Capture/Compare 4 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC4 channel is configured as output 01: CC4 channel is configured as input, IC4 is mapped on TI4 10: CC4 channel is configured as input, IC4 is mapped on TI3 11: CC4 channel is configured as input, IC4 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC4S bits are writable only when the channel is OFF (CC4E = ‘0’ in TIMx_CCER).  Bit 7   OC3CE:   Output compare 3 clear enable Refer to OC1CE description. Bits 16, 6:4   OC3M[3:0] : Output compare 3 mode Refer to OC1M[3:0] description. Bit 3   OC3PE : Output compare 3 preload enable Refer to OC1PE description. Bit 2   OC3FE : Output compare 3 fast enable Refer to OC1FE description. Bits 1:0   CC3S[1:0] : Capture/Compare 3 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC3 channel is configured as output 01: CC3 channel is configured as input, IC3 is mapped on TI3 10: CC3 channel is configured as input, IC3 is mapped on TI4 11: CC3 channel is configured as input, IC3 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC3S bits are writable only when the channel is OFF (CC3E = ‘0’ in TIMx_CCER).

RM0490 Rev 5   423/1027  RM0490   Advanced-control timer (TIM1)  442  17.4.11   TIM1 capture/compare enable register (TIM1_CCER)  Address offset: 0x20 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CC6P   CC6E   Res.   Res.   CC5P   CC5E rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CC4NP   Res.   CC4P   CC4E   CC3NP   CC3NE   CC3P   CC3E   CC2NP   CC2NE   CC2P   CC2E   CC1NP   CC1NE   CC1P   CC1E rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:22   Reserved, must be kept at reset value. Bit 21   CC6P : Capture/Compare 6 output polarity Refer to CC1P description Bit 20   CC6E : Capture/Compare 6 output enable Refer to CC1E description Bits 19:18   Reserved, must be kept at reset value. Bit 17   CC5P : Capture/Compare 5 output polarity Refer to CC1P description Bit 16   CC5E : Capture/Compare 5 output enable Refer to CC1E description Bit 15   CC4NP : Capture/Compare 4 complementary output polarity Refer to CC1NP description Bit 14   Reserved, must be kept at reset value. Bit 13   CC4P : Capture/Compare 4 output polarity Refer to CC1P description Bit 12   CC4E : Capture/Compare 4 output enable Refer to CC1E description Bit 11   CC3NP : Capture/Compare 3 complementary output polarity Refer to CC1NP description Bit 10   CC3NE : Capture/Compare 3 complementary output enable Refer to CC1NE description Bit 9   CC3P : Capture/Compare 3 output polarity Refer to CC1P description Bit 8   CC3E : Capture/Compare 3 output enable Refer to CC1E description Bit 7   CC2NP : Capture/Compare 2 complementary output polarity Refer to CC1NP description Bit 6   CC2NE : Capture/Compare 2 complementary output enable Refer to CC1NE description

Advanced-control timer (TIM1)   RM0490  424/1027   RM0490 Rev 5  Bit 5   CC2P : Capture/Compare 2 output polarity Refer to CC1P description Bit 4   CC2E : Capture/Compare 2 output enable Refer to CC1E description Bit 3   CC1NP : Capture/Compare 1 complementary output polarity  CC1 channel configured as output : 0: OC1N active high. 1: OC1N active low.  CC1 channel configured as input : This bit is used in conjunction with CC1P to define the polarity of TI1FP1 and TI2FP1. Refer to CC1P description.  Note:   This bit is not writable as soon as LOCK level 2 or 3 has been programmed (LOCK bits in TIMx_BDTR register) and CC1S=”00” (channel configured as output). On channels having a complementary output, this bit is preloaded. If the CCPC bit is set in the TIMx_CR2 register then the CC1NP active bit takes the new value from the preloaded bit only when a Commutation event is generated.  Bit 2   CC1NE : Capture/Compare 1 complementary output enable 0: Off - OC1N is not active. OC1N level is then function of MOE, OSSI, OSSR, OIS1, OIS1N and CC1E bits. 1: On - OC1N signal is output on the corresponding output pin depending on MOE, OSSI, OSSR, OIS1, OIS1N and CC1E bits.  On channels having a complementary output, this bit is preloaded. If the CCPC bit is set in the TIMx_CR2 register then the CC1NE active bit takes the new value from the preloaded bit only when a Commutation event is generated.  Bit 1   CC1P : Capture/Compare 1 output polarity 0: OC1 active high (output mode) / Edge sensitivity selection (input mode, see below) 1: OC1 active low (output mode) / Edge sensitivity selection (input mode, see below) When CC1 channel is configured as input, both CC1NP/CC1P bits select the active polarity of TI1FP1 and TI2FP1 for trigger or capture operations. CC1NP=0, CC1P=0: non-inverted/rising edge. The circuit is sensitive to TIxFP1 rising edge (capture or trigger operations in reset, external clock or trigger mode), TIxFP1 is not inverted (trigger operation in gated mode or encoder mode). CC1NP=0, CC1P=1: inverted/falling edge. The circuit is sensitive to TIxFP1 falling edge (capture or trigger operations in reset, external clock or trigger mode), TIxFP1 is inverted (trigger operation in gated mode or encoder mode). CC1NP=1, CC1P=1: non-inverted/both edges/ The circuit is sensitive to both TIxFP1 rising and falling edges (capture or trigger operations in reset, external clock or trigger mode), TIxFP1is not inverted (trigger operation in gated mode). This configuration must not be used in encoder mode. CC1NP=1, CC1P=0: The configuration is reserved, it must not be used.  Note:   This bit is not writable as soon as LOCK level 2 or 3 has been programmed (LOCK bits in TIMx_BDTR register). On channels having a complementary output, this bit is preloaded. If the CCPC bit is set in the TIMx_CR2 register then the CC1P active bit takes the new value from the preloaded bit only when a Commutation event is generated.

RM0490 Rev 5   425/1027  RM0490   Advanced-control timer (TIM1)  442  Note:   The state of the external I/O pins connected to the complementary OCx and OCxN channels depends on the OCx and OCxN channel state and the GPIO registers.  Bit 0   CC1E : Capture/Compare 1 output enable 0: Capture mode disabled / OC1 is not active (see below) 1: Capture mode enabled / OC1 signal is output on the corresponding output pin  When CC1 channel is configured as output , the OC1 level depends on MOE, OSSI, OSSR, OIS1, OIS1N and CC1NE bits, regardless of the CC1E bits state. Refer to   Table 81  for details.  Note:   On channels having a complementary output, this bit is preloaded. If the CCPC bit is set in the TIMx_CR2 register then the CC1E active bit takes the new value from the preloaded bit only when a Commutation event is generated.  Table 81. Output control bits for complementary OCx and OCxN channels with break feature Control bits   Output states   (1) MOE bit OSSI bit OSSR bit CCxE bit CCxNE bit   OCx output state   OCxN output state  1   X X   0   0   Output disabled (not driven by the timer: Hi-Z) OCx=0, OCxN=0 0   0   1 Output disabled (not driven by the timer: Hi-Z) OCx=0 OCxREF + Polarity OCxN = OCxREF xor CCxNP 0   1   0   OCxREF + Polarity OCx=OCxREF xor CCxP Output Disabled (not driven by the timer: Hi-Z) OCxN=0 X   1   1   OCREF + Polarity + dead- time Complementary to OCREF (not OCREF) + Polarity + dead-time 1   0   1 Off-State (output enabled with inactive state) OCx=CCxP OCxREF + Polarity OCxN = OCxREF x or CCxNP 1   1   0   OCxREF + Polarity OCx=OCxREF xor CCxP Off-State (output enabled with inactive state) OCxN=CCxNP 0 0 X X   X   Output disabled (not driven by the timer: Hi-Z). 1 0   0 0   1   Off-State (output enabled with inactive state) Asynchronously: OCx=CCxP, OCxN=CCxNP (if BRK or BRK2 is triggered). Then (this is valid only if BRK is triggered), if the clock is present: OCx=OISx and OCxN=OISxN after a dead-time, assuming that OISx and OISxN do not correspond to OCX and OCxN both in active state (may cause a short circuit when driving switches in half-bridge configuration).  Note : BRK2 can only be used if OSSI = OSSR = 1. 1   0 1   1 1.   When both outputs of a channel are not used (control taken over by GPIO), the OISx, OISxN, CCxP and CCxNP bits must be kept cleared.

Advanced-control timer (TIM1)   RM0490  426/1027   RM0490 Rev 5  17.4.12   TIM1 counter (TIM1_CNT)  Address offset: 0x24 Reset value: 0x0000 0000  17.4.13   TIM1 prescaler (TIM1_PSC)  Address offset: 0x28 Reset value: 0x0000  17.4.14   TIM1 auto-reload register (TIM1_ARR)  Address offset: 0x2C Reset value: 0xFFFF 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 UIF CPY   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CNT[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 31   UIFCPY : UIF copy This bit is a read-only copy of the UIF bit of the TIMx_ISR register. If the UIFREMAP bit in the TIMxCR1 is reset, bit 31 is reserved and read at 0. Bits 30:16   Reserved, must be kept at reset value. Bits 15:0   CNT[15:0] : Counter value 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 PSC[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   PSC[15:0] : Prescaler value The counter clock frequency (CK_CNT) is equal to f CK_PSC   / (PSC[15:0] + 1). PSC contains the value to be loaded in the active prescaler register at each update event (including when the counter is cleared through UG bit of TIMx_EGR register or through trigger controller when configured in “reset mode”). 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ARR[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   ARR[15:0] : Auto-reload value ARR is the value to be loaded in the actual auto-reload register. Refer to the   Section 17.3.1: Time-base unit on page 347   for more details about ARR update and behavior. The counter is blocked while the auto-reload value is null.

RM0490 Rev 5   427/1027  RM0490   Advanced-control timer (TIM1)  442  17.4.15   TIM1 repetition counter register (TIM1_RCR)  Address offset: 0x30 Reset value: 0x0000  17.4.16   TIM1 capture/compare register 1 (TIM1_CCR1)  Address offset: 0x34 Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 REP[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   REP[15:0] : Repetition counter value These bits allow the user to set-up the update rate of the compare registers (i.e. periodic transfers from preload to active registers) when preload registers are enable, as well as the update interrupt generation rate, if this interrupt is enable. Each time the REP_CNT related downcounter reaches zero, an update event is generated and it restarts counting from REP value. As REP_CNT is reloaded with REP value only at the repetition update event U_RC, any write to the TIMx_RCR register is not taken in account until the next repetition update event. It means in PWM mode (REP+1) corresponds to: the number of PWM periods in edge-aligned mode the number of half PWM period in center-aligned mode. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CCR1[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   CCR1[15:0] : Capture/Compare 1 value  If channel CC1 is configured as output : CCR1 is the value to be loaded in the actual capture/compare 1 register (preload value). It is loaded permanently if the preload feature is not selected in the TIMx_CCMR1 register (bit OC1PE). Else the preload value is copied in the active capture/compare 1 register when an update event occurs. The active capture/compare register contains the value to be compared to the counter TIMx_CNT and signaled on OC1 output.  If channel CC1 is configured as input : CR1 is the counter value transferred by the last input capture 1 event (IC1). The TIMx_CCR1 register is read-only and cannot be programmed.

Advanced-control timer (TIM1)   RM0490  428/1027   RM0490 Rev 5  17.4.17   TIM1 capture/compare register 2 (TIM1_CCR2)  Address offset: 0x38 Reset value: 0x0000  17.4.18   TIM1 capture/compare register 3 (TIM1_CCR3)  Address offset: 0x3C Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CCR2[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   CCR2[15:0] : Capture/Compare 2 value  If channel CC2 is configured as output : CCR2 is the value to be loaded in the actual capture/compare 2 register (preload value). It is loaded permanently if the preload feature is not selected in the TIMx_CCMR1 register (bit OC2PE). Else the preload value is copied in the active capture/compare 2 register when an update event occurs. The active capture/compare register contains the value to be compared to the counter TIMx_CNT and signaled on OC2 output.  If channel CC2 is configured as input : CCR2 is the counter value transferred by the last input capture 2 event (IC2). The TIMx_CCR2 register is read-only and cannot be programmed. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CCR3[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   CCR3[15:0] : Capture/Compare value  If channel CC3 is configured as output : CCR3 is the value to be loaded in the actual capture/compare 3 register (preload value). It is loaded permanently if the preload feature is not selected in the TIMx_CCMR2 register (bit OC3PE). Else the preload value is copied in the active capture/compare 3 register when an update event occurs. The active capture/compare register contains the value to be compared to the counter TIMx_CNT and signalled on OC3 output.  If channel CC3 is configured as input : CCR3 is the counter value transferred by the last input capture 3 event (IC3). The TIMx_CCR3 register is read-only and cannot be programmed.

RM0490 Rev 5   429/1027  RM0490   Advanced-control timer (TIM1)  442  17.4.19   TIM1 capture/compare register 4 (TIM1_CCR4)  Address offset: 0x40 Reset value: 0x0000  17.4.20   TIM1 break and dead-time register (TIM1_BDTR)  Address offset: 0x44 Reset value: 0x0000 0000  Note:   As the bits BK2BID, BKBID, BK2DSRM, BKDSRM, BK2P, BK2E, BK2F[3:0], BKF[3:0], AOE, BKP, BKE, OSSI, OSSR and DTG[7:0] can be write-locked depending on the LOCK configuration, it can be necessary to configure all of them during the first write access to the TIMx_BDTR register.  15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CCR4[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   CCR4[15:0] : Capture/Compare value  If channel CC4 is configured as output : CCR4 is the value to be loaded in the actual capture/compare 4 register (preload value). It is loaded permanently if the preload feature is not selected in the TIMx_CCMR2 register (bit OC4PE). Else the preload value is copied in the active capture/compare 4 register when an update event occurs. The active capture/compare register contains the value to be compared to the counter TIMx_CNT and signalled on OC4 output.  If channel CC4 is configured as input : CCR4 is the counter value transferred by the last input capture 4 event (IC4). The TIMx_CCR4 register is read-only and cannot be programmed. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   BK2BID   BKBID   BK2 DSRM BK DSRM   BK2P   BK2E   BK2F[3:0]   BKF[3:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 MOE   AOE   BKP   BKE   OSSR   OSSI   LOCK[1:0]   DTG[7:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:30   Reserved, must be kept at reset value. Bit 29   BK2BID : Break2 bidirectional Refer to BKBID description

Advanced-control timer (TIM1)   RM0490  430/1027   RM0490 Rev 5  Bit 28   BKBID : Break Bidirectional 0: Break input BRK in input mode 1: Break input BRK in bidirectional mode In the bidirectional mode (BKBID bit set to 1), the break input is configured both in input mode and in open drain output mode. Any active break event asserts a low logic level on the Break input to indicate an internal break event to external devices.  Note:   This bit cannot be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register). Note:   Any write operation to this bit takes a delay of 1 APB clock cycle to become effective.  Bit 27   BK2DSRM : Break2 Disarm Refer to BKDSRM description Bit 26   BKDSRM : Break Disarm 0: Break input BRK is armed 1: Break input BRK is disarmed This bit is cleared by hardware when no break source is active. The BKDSRM bit must be set by software to release the bidirectional output control (open- drain output in Hi-Z state) and then be polled it until it is reset by hardware, indicating that the fault condition has disappeared.  Note:   Any write operation to this bit takes a delay of 1 APB clock cycle to become effective.  Bit 25   BK2P : Break 2 polarity 0: Break input BRK2 is active low 1: Break input BRK2 is active high  Note:   This bit cannot be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register). Note:   Any write operation to this bit takes a delay of 1 APB clock cycle to become effective.  Bit 24   BK2E : Break 2 enable 0: Break input BRK2 disabled 1: Break input BRK2 enabled  Note:   The BRK2 must only be used with OSSR = OSSI = 1. Note:   This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register). Note:   Any write operation to this bit takes a delay of 1 APB clock cycle to become effective.

RM0490 Rev 5   431/1027  RM0490   Advanced-control timer (TIM1)  442  Bits 23:20   BK2F[3:0] :   Break 2 filter This bit-field defines the frequency used to sample BRK2 input and the length of the digital filter applied to BRK2. The digital filter is made of an event counter in which N consecutive events are needed to validate a transition on the output: 0000: No filter, BRK2 acts asynchronously 0001: f SAMPLING =f CK_INT , N=2 0010: f SAMPLING =f CK_INT , N=4 0011: f   SAMPLING =f CK_INT , N=8 0100: f SAMPLING =f DTS /2, N=6 0101: f SAMPLING =f DTS /2, N=8 0110: f   SAMPLING =f DTS /4, N=6 0111: f SAMPLING   =f DTS /4, N=8 1000: f SAMPLING =f DTS /8, N=6 1001: f SAMPLING =f DTS /8, N=8 1010: f SAMPLING =f DTS /16, N=5 1011: f   SAMPLING =f DTS /16, N=6 1100: f   SAMPLING =f DTS /16, N=8 1101: f   SAMPLING =f DTS /32, N=5 1110: f SAMPLING   =f DTS /32, N=6 1111: f SAMPLING =f   DTS /32, N=8  Note:   This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).  Bits 19:16   BKF[3:0] :   Break filter This bit-field defines the frequency used to sample BRK input and the length of the digital filter applied to BRK. The digital filter is made of an event counter in which N consecutive events are needed to validate a transition on the output: 0000: No filter, BRK acts asynchronously 0001: f SAMPLING =f CK_INT , N=2 0010: f SAMPLING =f CK_INT , N=4 0011: f   SAMPLING =f CK_INT , N=8 0100: f SAMPLING =f DTS /2, N=6 0101: f SAMPLING =f DTS /2, N=8 0110: f   SAMPLING =f DTS /4, N=6 0111: f SAMPLING   =f DTS /4, N=8 1000: f SAMPLING =f DTS /8, N=6 1001: f SAMPLING =f DTS /8, N=8 1010: f SAMPLING =f DTS /16, N=5 1011: f   SAMPLING =f DTS /16, N=6 1100: f   SAMPLING =f DTS /16, N=8 1101: f   SAMPLING =f DTS /32, N=5 1110: f SAMPLING   =f DTS /32, N=6 1111: f SAMPLING =f   DTS /32, N=8  Note:   This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).

Advanced-control timer (TIM1)   RM0490  432/1027   RM0490 Rev 5  Bit 15   MOE : Main output enable This bit is cleared asynchronously by hardware as soon as one of the break inputs is active (BRK or BRK2). It is set by software or automatically depending on the AOE bit. It is acting only on the channels which are configured in output. 0: In response to a break 2 event. OC and OCN outputs are disabled In response to a break event or if MOE is written to 0: OC and OCN outputs are disabled or forced to idle state depending on the OSSI bit. 1: OC and OCN outputs are enabled if their respective enable bits are set (CCxE, CCxNE in TIMx_CCER register). See OC/OCN enable description for more details ( Section 17.4.11: TIM1 capture/compare enable register (TIM1_CCER) ). Bit 14   AOE : Automatic output enable 0: MOE can be set only by software 1: MOE can be set by software or automatically at the next update event (if none of the break inputs BRK and BRK2 is active)  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).  Bit 13   BKP : Break polarity 0: Break input BRK is active low 1: Break input BRK is active high  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register). Note:   Any write operation to this bit takes a delay of 1 APB clock cycle to become effective.  Bit 12   BKE : Break enable This bit enables the complete break protection (including all sources connected to bk_acth and BRK sources, as per   Figure 100: Break and Break2 circuitry overview ). 0: Break function disabled 1: Break function enabled  Note:   This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register). Note:   Any write operation to this bit takes a delay of 1 APB clock cycle to become effective.  Bit 11   OSSR :   Off-state selection for Run mode This bit is used when MOE=1 on channels having a complementary output which are configured as outputs. OSSR is not implemented if no complementary output is implemented in the timer. See OC/OCN enable description for more details ( Section 17.4.11: TIM1 capture/compare enable register (TIM1_CCER) ). 0: When inactive, OC/OCN outputs are disabled (the timer releases the output control which is taken over by the GPIO logic, which forces a Hi-Z state). 1: When inactive, OC/OCN outputs are enabled with their inactive level as soon as CCxE=1 or CCxNE=1 (the output is still controlled by the timer).  Note:   This bit can not be modified as soon as the LOCK level 2 has been programmed (LOCK bits in TIMx_BDTR register).

RM0490 Rev 5   433/1027  RM0490   Advanced-control timer (TIM1)  442  17.4.21   TIM1 DMA control register (TIM1_DCR)  Address offset: 0x48 Reset value: 0x0000 Bit 10   OSSI :   Off-state selection for Idle mode This bit is used when MOE=0 due to a break event or by a software write, on channels configured as outputs. See OC/OCN enable description for more details ( Section 17.4.11: TIM1 capture/compare enable register (TIM1_CCER) ). 0: When inactive, OC/OCN outputs are disabled (the timer releases the output control which is taken over by the GPIO logic and which imposes a Hi-Z state). 1: When inactive, OC/OCN outputs are first forced with their inactive level then forced to their idle level after the deadtime. The timer maintains its control over the output.  Note:   This bit can not be modified as soon as the LOCK level 2 has been programmed (LOCK bits in TIMx_BDTR register).  Bits 9:8   LOCK[1:0] : Lock configuration These bits offer a write protection against software errors. 00: LOCK OFF - No bit is write protected. 01: LOCK Level 1 = DTG bits in TIMx_BDTR register, OISx and OISxN bits in TIMx_CR2 register and B K2BID, BKBID, BK2DSRM, BKDSRM, BK2P, BK2E, BK2F[3:0], BKF[3:0], AOE, BKP, BKE, OSSI, OSSR and DTG[7:0]   bits in TIMx_BDTR register can no longer be written. 10: LOCK Level 2 = LOCK Level 1 + CC Polarity bits (CCxP/CCxNP bits in TIMx_CCER register, as long as the related channel is configured in output through the CCxS bits) as well as OSSR and OSSI bits can no longer be written. 11: LOCK Level 3 = LOCK Level 2 + CC Control bits (OCxM and OCxPE bits in TIMx_CCMRx registers, as long as the related channel is configured in output through the CCxS bits) can no longer be written.  Note:   The LOCK bits can be written only once after the reset. Once the TIMx_BDTR register has been written, their content is frozen until the next reset.  Bits 7:0   DTG[7:0] : Dead-time generator setup This bit-field defines the duration of the dead-time inserted between the complementary outputs. DT correspond to this duration. DTG[7:5] = 0xx => DT = DTG[7:0] x t   DTG   with t DTG   = t   DTS . DTG[7:5] = 10x => DT = (64 + DTG[5:0]) x t DTG   with t   DTG   = 2 x t   DTS . DTG[7:5] = 110 => DT = (32 + DTG[4:0]) x t DTG   with t   DTG   = 8 x t   DTS   . DTG[7:5] = 111 => DT = (32 + DTG[4:0]) x t DTG   with t   DTG   = 16 x t   DTS . Example if t DTS   = 125 ns (8 MHz), dead-time possible values are: 0 to 15875 ns by 125 ns steps, 16   μ s to 31750 ns by 250 ns steps, 32   μ s to 63   μ s by 1   μ s steps, 64   μ s to 126   μ s by 2   μ s steps  Note:   This bit-field can not be modified as long as LOCK level 1, 2 or 3 has been programmed (LOCK bits in TIMx_BDTR register).  15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   DBL[4:0]   Res.   Res.   Res.   DBA[4:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

Advanced-control timer (TIM1)   RM0490  434/1027   RM0490 Rev 5  17.4.22   TIM1 DMA address for full transfer (TIM1_DMAR)  Address offset: 0x4C Reset value: 0x0000 0000 Bits 15:13   Reserved, must be kept at reset value. Bits 12:8   DBL[4:0] : DMA burst length This 5-bit vector defines the length of DMA transfers (the timer recognizes a burst transfer when a read or a write access is done to the TIMx_DMAR address), i.e. the number of transfers. Transfers can be in half-words or in bytes (see example below). 00000: 1 transfer 00001: 2 transfers 00010: 3 transfers ... 10001: 18 transfers  Example:   Let us consider the following transfer: DBL = 7 bytes & DBA = TIMx_CR1. – If DBL = 7 bytes and DBA = TIMx_CR1 represents the address of the byte to be transferred, the address of the transfer should be given by the following equation: (TIMx_CR1 address) + DBA + (DMA index), where DMA index = DBL In this example, 7 bytes are added to (TIMx_CR1 address) + DBA, which gives us the address from/to which the data is copied. In this case, the transfer is done to 7 registers starting from the following address: (TIMx_CR1 address) + DBA According to the configuration of the DMA Data Size, several cases may occur: – If the DMA Data Size is configured in half-words, 16-bit data is transferred to each of the 7 registers. – If the DMA Data Size is configured in bytes, the data is also transferred to 7 registers: the first register contains the first MSB byte, the second register, the first LSB byte and so on. So with the transfer Timer, one also has to specify the size of data transferred by DMA. Bits 7:5   Reserved, must be kept at reset value. Bits 4:0   DBA[4:0] : DMA base address This 5-bits vector defines the base-address for DMA transfers (when read/write access are done through the TIMx_DMAR address). DBA is defined as an offset starting from the address of the TIMx_CR1 register. Example: 00000: TIMx_CR1, 00001: TIMx_CR2, 00010: TIMx_SMCR, ... 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 DMAB[31:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 DMAB[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

RM0490 Rev 5   435/1027  RM0490   Advanced-control timer (TIM1)  442  17.4.23   TIM1 capture/compare mode register 3 (TIM1_CCMR3)  Address offset: 0x54 Reset value: 0x0000 0000 The channels 5 and 6 can only be configured in output.  Output compare mode:  Bits 31:0   DMAB[31:0] : DMA register for burst accesses A read or write operation to the DMAR register accesses the register located at the address (TIMx_CR1 address) + (DBA + DMA index) x 4 where TIMx_CR1 address is the address of the control register 1, DBA is the DMA base address configured in TIMx_DCR register, DMA index is automatically controlled by the DMA transfer, and ranges from 0 to DBL (DBL configured in TIMx_DCR). 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC6M[3]   Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC5M[3] rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 OC6 CE   OC6M[2:0]   OC6 PE   OC6FE   Res.   Res.   OC5 CE   OC5M[2:0]   OC5PE   OC5FE   Res.   Res. rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:25   Reserved, must be kept at reset value. Bits 23:17   Reserved, must be kept at reset value. Bit 15   OC6CE : Output compare 6 clear enable Refer to OC1CE description. Bits 24, 14, 13, 12   OC6M[3:0] : Output compare 6 mode Refer to OC1M description. Bit 11   OC6PE : Output compare 6 preload enable Refer to OC1PE description. Bit 10   OC6FE : Output compare 6 fast enable Refer to OC1FE description. Bits 9:8   Reserved, must be kept at reset value. Bit 7   OC5CE:   Output compare 5 clear enable Refer to OC1CE description. Bits 16, 6, 5, 4   OC5M[3:0] : Output compare 5 mode Refer to OC1M description. Bit 3   OC5PE : Output compare 5 preload enable Refer to OC1PE description. Bit 2   OC5FE : Output compare 5 fast enable Refer to OC1FE description. Bits 1:0   Reserved, must be kept at reset value.

Advanced-control timer (TIM1)   RM0490  436/1027   RM0490 Rev 5  17.4.24   TIM1 capture/compare register 5 (TIM1_CCR5)  Address offset: 0x58 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 GC5C3   GC5C2   GC5C1   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CCR5[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 31   GC5C3 : Group Channel 5 and Channel 3 Distortion on Channel 3 output: 0: No effect of OC5REF on OC3REFC 1: OC3REFC is the logical AND of OC3REFC and OC5REF This bit can either have immediate effect or be preloaded and taken into account after an update event (if preload feature is selected in TIMxCCMR2).  Note:   it is also possible to apply this distortion on combined PWM signals.  Bit 30   GC5C2 : Group Channel 5 and Channel 2 Distortion on Channel 2 output: 0: No effect of OC5REF on OC2REFC 1: OC2REFC is the logical AND of OC2REFC and OC5REF This bit can either have immediate effect or be preloaded and taken into account after an update event (if preload feature is selected in TIMxCCMR1).  Note:   it is also possible to apply this distortion on combined PWM signals.  Bit 29   GC5C1 : Group Channel 5 and Channel 1 Distortion on Channel 1 output: 0: No effect of OC5REF on OC1REFC5 1: OC1REFC is the logical AND of OC1REFC and OC5REF This bit can either have immediate effect or be preloaded and taken into account after an update event (if preload feature is selected in TIMxCCMR1).  Note:   it is also possible to apply this distortion on combined PWM signals.  Bits 28:16   Reserved, must be kept at reset value. Bits 15:0   CCR5[15:0] : Capture/Compare 5 value CCR5 is the value to be loaded in the actual capture/compare 5 register (preload value). It is loaded permanently if the preload feature is not selected in the TIMx_CCMR3 register (bit OC5PE). Else the preload value is copied in the active capture/compare 5 register when an update event occurs. The active capture/compare register contains the value to be compared to the counter TIMx_CNT and signaled on OC5 output.

RM0490 Rev 5   437/1027  RM0490   Advanced-control timer (TIM1)  442  17.4.25   TIM1 capture/compare register 6 (TIM1_CCR6)  Address offset: 0x5C Reset value: 0x0000  17.4.26   TIM1 alternate function option register 1 (TIM1_AF1)  Address offset: 0x60 Reset value: 0x0000 0001 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CCR6[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   CCR6[15:0] : Capture/Compare 6 value CCR6 is the value to be loaded in the actual capture/compare 6 register (preload value). It is loaded permanently if the preload feature is not selected in the TIMx_CCMR3 register (bit OC6PE). Else the preload value is copied in the active capture/compare 6 register when an update event occurs. The active capture/compare register contains the value to be compared to the counter TIMx_CNT and signaled on OC6 output. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   ETRSEL[3:2] rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ETRSEL[1:0]   Res.   Res.   Res.   Res.   BKINP   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   BKINE rw   rw   rw   rw Bits 31:18   Reserved, must be kept at reset value. Bits 17:14   ETRSEL[3:0] : ETR source selection These bits select the ETR input source. 0000: ETR legacy mode 0011: ADC1 AWD1 0100: ADC1 AWD2 0101: ADC1 AWD3 Others: Reserved Note:   These bits can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register). Bits 13:10   Reserved, must be kept at reset value. Bit 9   BKINP : BRK BKIN input polarity This bit selects the BKIN alternate function input sensitivity. It must be programmed together with the BKP polarity bit. 0: BKIN input polarity is not inverted (active low if BKP=0, active high if BKP=1) 1: BKIN input polarity is inverted (active high if BKP=0, active low if BKP=1)  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).

Advanced-control timer (TIM1)   RM0490  438/1027   RM0490 Rev 5  Note:   Refer to Figure 79: TIM1 ETR input circuitry and to Figure 100: Break and Break2 circuitry overview.  17.4.27   TIM1 Alternate function register 2 (TIM1_AF2)  Address offset: 0x64 Reset value: 0x0000 0001  Note:   Refer to Figure 100: Break and Break2 circuitry overview.  Bits 8:1   Reserved, must be kept at reset value. Bit 0   BKINE : BRK BKIN input enable This bit enables the BKIN alternate function input for the timer’s BRK input. BKIN input is ‘ORed’ with the other BRK sources. 0: BKIN input disabled 1: BKIN input enabled  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   BK2 INP   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   BK2INE rw   rw Bits 31:10   Reserved, must be kept at reset value. Bit 9   BK2INP : BRK2 BKIN2 input polarity This bit selects the BKIN2 alternate function input sensitivity. It must be programmed together with the BK2P polarity bit. 0: BKIN2 input polarity is not inverted (active low if BK2P=0, active high if BK2P=1) 1: BKIN2 input polarity is inverted (active high if BK2P=0, active low if BK2P=1)  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).  Bits 8:1   Reserved, must be kept at reset value. Bit 0   BK2INE : BRK2 BKIN input enable This bit enables the BKIN2 alternate function input for the timer’s BRK2 input. BKIN2 input is ‘ORed’ with the other BRK2 sources. 0: BKIN2 input disabled 1: BKIN2 input enabled  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).

RM0490 Rev 5   439/1027  RM0490   Advanced-control timer (TIM1)  442  17.4.28   TIM1 timer input selection register (TIM1_TISEL)  Address offset: 0x68 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   TI4SEL[3:0]   Res.   Res.   Res.   Res.   TI3SEL[3:0] rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   TI2SEL[3:0]   Res.   Res.   Res.   Res.   TI1SEL[3:0] rw   rw   rw   rw   rw   rw   rw   rw Bits 31:28   Reserved, must be kept at reset value. Bits 27:24   TI4SEL[3:0] : selects TI4[0] to TI4[15] input 0000: TIM1_CH4 input Others: Reserved Bits 23:20   Reserved, must be kept at reset value. Bits 19:16   TI3SEL[3:0] : selects TI3[0] to TI3[15] input 0000: TIM1_CH3 input Others: Reserved Bits 15:12   Reserved, must be kept at reset value. Bits 11:8   TI2SEL[3:0] : selects TI2[0] to TI2[15] input 0000: TIM1_CH2 input Others: Reserved Bits 7:4   Reserved, must be kept at reset value. Bits 3:0   TI1SEL[3:0] : selects TI1[0] to TI1[15] input 0000: TIM1_CH1 input Others: Reserved

Advanced-control timer (TIM1)   RM0490  440/1027   RM0490 Rev 5  17.4.29   TIM1 register map  TIM1 registers are mapped as 16-bit addressable registers as described in the table below:  Table 82. TIM1 register map and reset values Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00  TIM1_CR1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. UIFREMAP Res.   CKD [1:0] ARPE   CMS [1:0] DIR OPM URS UDIS CEN Reset value   0   0   0   0   0   0   0   0   0   0   0 0x04  TIM1_CR2  Res. Res. Res. Res. Res. Res. Res. Res. MMS2[3:0] Res. OIS6 Res. OIS5 Res. OIS4 OIS3N OIS3 OIS2N OIS2 OIS1N OIS1 TI1S   MMS [2:0] CCDS CCUS Res. CCPC Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x08  TIM1_SMCR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res.   TS [4:3] Res. Res. Res. SMS[3] ETP ECE   ETP S [1:0] ETF[3:0] MSM TS[2:0] OCCS SMS[2:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x0C  TIM1_DIER  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TDE COMDE CC4DE CC3DE CC2DE CC1DE UDE BIE TIE COMIE CC4IE CC3IE CC2IE CC1IE UIE Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x10  TIM1_SR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CC6IF CC5IF Res. Res. SBIF CC4OF CC3OF CC2OF CC1OF B2IF BIF TIF COMIF CC4IF CC3IF CC2IF CC1IF UIF Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x14  TIM1_EGR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. B2G BG TG COMG CC4G CC3G CC2G CC1G UG Reset value   0   0   0   0   0   0   0   0   0 0x18  TIM1_CCMR1  Output Compare mode Res. Res. Res. Res. Res. Res. Res. OC2M[3] Res. Res. Res. Res. Res. Res. Res. OC1M[3] OC2CE OC2M [2:0] OC2PE OC2FE   CC2 S [1:0] OC1CE OC1M [2:0] OC1PE OC1FE   CC1 S [1:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0  TIM1_CCMR1  Input Capture mode Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. IC2F[3:0] IC2 PSC [1:0] CC2 S [1:0] IC1F[3:0] IC1 PSC [1:0] CC1 S [1:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x1C  TIM1_CCMR2  Output Compare mode Res. Res. Res. Res. Res. Res. Res. OC4M[3] Res. Res. Res. Res. Res. Res. Res. OC3M[3] OC4CE OC4M [2:0] OC4PE OC4FE   CC4 S [1:0] OC3CE OC3M [2:0] OC3PE OC3FE   CC3 S [1:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0  TIM1_CCMR2  Input Capture mode Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. IC4F[3:0] IC4 PSC [1:0] CC4 S [1:0] IC3F[3:0] IC3 PSC [1:0] CC3 S [1:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x20  TIM1_CCER  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CC6P CC6E Res. Res. CC5P CC5E CC4NP Res. CC4P CC4E CC3NP CC3NE CC3P CC3E CC2NP CC2NE CC2P CC2E CC1NP CC1NE CC1P CC1E Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0

RM0490 Rev 5   441/1027  RM0490   Advanced-control timer (TIM1)  442  0x24  TIM1_CNT  UIFCP Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CNT[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x28  TIM1_PSC  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PSC[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x2C  TIM1_ARR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. ARR[15:0] Reset value   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 0x30  TIM1_RCR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. REP[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x34  TIM1_CCR1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CCR1[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x38  TIM1_CCR2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CCR2[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x3C  TIM1_CCR3  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CCR3[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x40  TIM1_CCR4  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CCR4[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x44  TIM1_BDTR  Res. Res. BK2BID BKBID BK2DSRM BKDSRM BK2P BK2E BK2F[3:0]   BKF[3:0] MOE AOE BKP BKE OSSR OSSI   LOC K [1:0] DT[7:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x48  TIM1_DCR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DBL[4:0] Res. Res. Res. DBA[4:0] Reset value   0   0   0   0   0   0   0   0   0   0 0x4C  TIM1_DMAR   DMAB[31:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x50   Reserved   Res. 0x54  TIM1_CCMR3  Output Compare mode Res. Res. Res. Res. Res. Res. Res. OC6M[3] Res. Res. Res. Res. Res. Res. Res. OC5M[3] OC6CE OC6M [2:0] OC6PE OC6FE Res. Res. OC5CE OC5M [2:0] OC5PE OC5FE Res. Res. Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x58  TIM1_CCR5  GC5C3 GC5C2 GC5C1 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CCR5[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0  Table 82. TIM1 register map and reset values (continued) Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

Advanced-control timer (TIM1)   RM0490  442/1027   RM0490 Rev 5  Refer to   Section 2.2 on page 45   for the register boundary addresses. 0x5C  TIM1_CCR6  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CCR6[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x60  TIM1_AF1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res.   Res ETRSEL [3:0] Res. Res. Res. Res. BKINP Res. Res. Res. Res. Res. Res. Res. Res. BKINE Reset value   0   0   0   0   0   1 0x64  TIM1_AF2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. BK2INP Res. Res. Res. Res. Res. Res. Res. Res. BK2INE Reset value   0   1 0x68  TIM1_TISEL  Res. Res. Res. Res. TI4SEL[3:0] Res. Res. Res. Res. TI3SEL[3:0] Res. Res. Res. Res. TI2SEL[3:0] Res. Res. Res. Res. TI1SEL[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0  Table 82. TIM1 register map and reset values (continued) Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

RM0490 Rev 5   443/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  18   General-purpose timers (TIM2/TIM3)  TIM2 is only available on the STM32C051xx/STM32C071xx/STM32C091xx/92xx devices.  18.1   TIM2/TIM3 introduction  The general-purpose timers consist of a 16-bit/32-bit auto-reload counter driven by a programmable prescaler. They may be used for a variety of purposes, including measuring the pulse lengths of input signals ( input capture ) or generating output waveforms ( output compare and PWM ). Pulse lengths and waveform periods can be modulated from a few microseconds to several milliseconds using the timer prescaler and the RCC clock controller prescalers. The timers are completely independent, and do not share any resources. They can be synchronized together as described in   Section 18.3.19: Timer synchronization .  18.2   TIM2/TIM3 main features  General-purpose TIMx timer features include:  •   16-bit TIM3 or 32-bit (TIM2) up, down, up/down auto-reload counter.  •   16-bit programmable prescaler used to divide (also “on the fly”) the counter clock frequency by any factor between 1 and 65535.  •   Up to 4 independent channels for: –   Input capture –   Output compare –   PWM generation (Edge- and Center-aligned modes) –   One-pulse mode output  •   Synchronization circuit to control the timer with external signals and to interconnect several timers.  •   Interrupt/DMA generation on the following events: –   Update: counter overflow/underflow, counter initialization (by software or internal/external trigger) –   Trigger event (counter start, stop, initialization or count by internal/external trigger) –   Input capture –   Output compare  •   Supports incremental (quadrature) encoder and hall-sensor circuitry for positioning purposes  •   Trigger input for external clock or cycle-by-cycle current management

General-purpose timers (TIM2/TIM3)   RM0490  444/1027   RM0490 Rev 5  Figure 117. General-purpose timer block diagram  MSv62393V2 U U U CC1I CC2I Trigger controller +/- Stop, clear or up/down TI1FP1 TI2FP2 TRGI Output control TRGO OC1REF OC2REF U UI Reset, enable, count CK_PSC IC1 IC2   IC2PS IC1PS TI1FP1 TRG TRC TRC ITR TRC TI1F_ED CC1I CC2I TI1FP2 TI2FP1 TI2FP2 OC1 OC2   TIMx_CH2 TIMx_CH1 to other timers to peripherals Slave controller mode PSC prescaler   CNT counter Internal clock (CK_INT) CK_CNT Capture/Compare 1 register Notes: Reg   Preload registers transferred to active registers on U event according to control bit Event Interrupt & DMA output Auto-reload register Capture/Compare 2 register Prescaler Prescaler Output control U U CC3I CC4I Output control OC3REF OC4REF IC3 IC4   IC4PS IC3PS TI4FP3 TI4FP4 OC3 OC4   TIMx_CH4 TIMx_CH3 Capture/Compare 3 register Capture/Compare 4 register Prescaler Prescaler Output control TRC TI3FP3 TI3FP4 TRC CC3I CC4I Encoder interface Input filter Polarity selection & edge detector & prescaler ETR   ETRP ETRF ETRF ITR[0..15] TI1 TIMx_CH1 TI1[1..15] TI1[0] XOR Input filter & edge detector Input filter & edge detector Input filter & edge detector Input filter & edge detector TIMx_CH2 TI2[1..15] TI2[0] TI2 TIMx_CH3 TI3[1..15] TI3[0] TI3 TIMx_CH4 TI4[1..15] TI4[0] TI4 TIMx_ETR On-chip ETR sources From RCC

RM0490 Rev 5   445/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  18.3   TIM2/TIM3 functional description 18.3.1   Time-base unit  The main block of the programmable timer is a 16-bit/32-bit counter with its related auto- reload register. The counter can count up, down or both up and down. The counter clock can be divided by a prescaler. The counter, the auto-reload register and the prescaler register can be written or read by software. This is true even when the counter is running. The time-base unit includes:  •   Counter Register (TIMx_CNT)  •   Prescaler Register (TIMx_PSC)  •   Auto-Reload Register (TIMx_ARR) The auto-reload register is preloaded. Writing to or reading from the auto-reload register accesses the preload register. The content of the preload register are transferred into the shadow register permanently or at each update event (UEV), depending on the auto-reload preload enable bit (ARPE) in TIMx_CR1 register. The update event is sent when the counter reaches the overflow (or underflow when downcounting) and if the UDIS bit equals 0 in the TIMx_CR1 register. It can also be generated by software. The generation of the update event is described in detail for each configuration. The counter is clocked by the prescaler output CK_CNT, which is enabled only when the counter enable bit (CEN) in TIMx_CR1 register is set (refer also to the slave mode controller description to get more details on counter enabling). Note that the actual counter enable signal CNT_EN is set 1 clock cycle after CEN.  Prescaler description  The prescaler can divide the counter clock frequency by any factor between 1 and 65536. It is based on a 16-bit counter controlled through a 16-bit/32-bit register (in the TIMx_PSC register). It can be changed on the fly as this control register is buffered. The new prescaler ratio is taken into account at the next update event.  Figure 118   and   Figure 119   give some examples of the counter behavior when the prescaler ratio is changed on the fly:

General-purpose timers (TIM2/TIM3)   RM0490  446/1027   RM0490 Rev 5  Figure 118. Counter timing diagram with prescaler division change from 1 to 2 Figure 119. Counter timing diagram with prescaler division change from 1 to 4  CK_PSC 00 CEN Timerclock = CK_CNT Counter register Update event (UEV) 0 Prescaler control register   1 0 Write a new value in TIMx_PSC Prescaler buffer   1 0 Prescaler counter   0   1   0   1   0   1   0   1 01   02   03 FA   FB F7   F8   F9   FC MS31076V2  0 3 0 0   1   2   3   0   1   2   3 MS31077V2 CK_PSC CEN Timerclock = CK_CNT Counter register Update event (UEV) Prescaler control register Write a new value in TIMx_PSC Prescaler buffer Prescaler counter 00   01 FA   FB F7   F8   F9   FC 3 0

RM0490 Rev 5   447/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  18.3.2   Counter modes Upcounting mode  In upcounting mode, the counter counts from 0 to the auto-reload value (content of the TIMx_ARR register), then restarts from 0 and generates a counter overflow event. An Update event can be generated at each counter overflow or by setting the UG bit in the TIMx_EGR register (by software or by using the slave mode controller). The UEV event can be disabled by software by setting the UDIS bit in TIMx_CR1 register. This is to avoid updating the shadow registers while writing new values in the preload registers. Then no update event occurs until the UDIS bit has been written to 0. However, the counter restarts from 0, as well as the counter of the prescaler (but the prescale rate does not change). In addition, if the URS bit (update request selection) in TIMx_CR1 register is set, setting the UG bit generates an update event UEV but without setting the UIF flag (thus no interrupt or DMA request is sent). This is to avoid generating both update and capture interrupts when clearing the counter on the capture event. When an update event occurs, all the registers are updated and the update flag (UIF bit in TIMx_SR register) is set (depending on the URS bit):  •   The buffer of the prescaler is reloaded with the preload value (content of the TIMx_PSC register)  •   The auto-reload shadow register is updated with the preload value (TIMx_ARR) The following figures show some examples of the counter behavior for different clock frequencies when TIMx_ARR=0x36.  Figure 120. Counter timing diagram, internal clock divided by 1  00   02   03   04   05   06   07 32   33   34   35   36 31 MS31078V2 CK_PSC CNT_EN Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 01

General-purpose timers (TIM2/TIM3)   RM0490  448/1027   RM0490 Rev 5  Figure 121. Counter timing diagram, internal clock divided by 2 Figure 122. Counter timing diagram, internal clock divided by 4  MS31079V2 CK_PSC CNT_EN Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 0034   0035   0036   0000   0001   0002   0003  0000   0001 0035   0036 MS31080V2 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) CNT_EN

RM0490 Rev 5   449/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Figure 123. Counter timing diagram, internal clock divided by N Figure 124. Counter timing diagram, Update event when ARPE=0 (TIMx_ARR not preloaded)  00 1F   20 MS31081V2 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF)  FF   36 MS31082V2 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 00   02   03   04   05   06   07 32   33   34   35   36 31   01 CEN Auto-reload preload register Write a new value in TIMx_ARR

General-purpose timers (TIM2/TIM3)   RM0490  450/1027   RM0490 Rev 5  Figure 125. Counter timing diagram, Update event when ARPE=1 (TIMx_ARR preloaded) Downcounting mode  In downcounting mode, the counter counts from the auto-reload value (content of the TIMx_ARR register) down to 0, then restarts from the auto-reload value and generates a counter underflow event. An Update event can be generate at each counter underflow or by setting the UG bit in the TIMx_EGR register (by software or by using the slave mode controller) The UEV update event can be disabled by software by setting the UDIS bit in TIMx_CR1 register. This is to avoid updating the shadow registers while writing new values in the preload registers. Then no update event occurs until UDIS bit has been written to 0. However, the counter restarts from the current auto-reload value, whereas the counter of the prescaler restarts from 0 (but the prescale rate doesn’t change). In addition, if the URS bit (update request selection) in TIMx_CR1 register is set, setting the UG bit generates an update event UEV but without setting the UIF flag (thus no interrupt or DMA request is sent). This is to avoid generating both update and capture interrupts when clearing the counter on the capture event. When an update event occurs, all the registers are updated and the update flag (UIF bit in TIMx_SR register) is set (depending on the URS bit):  •   The buffer of the prescaler is reloaded with the preload value (content of the TIMx_PSC register).  •   The auto-reload active register is updated with the preload value (content of the TIMx_ARR register). Note that the auto-reload is updated before the counter is reloaded, so that the next period is the expected one.  MS31083V2 F5   36 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 00   02   03   04   05   06   07 F1   F2   F3   F4   F5 F0   01 CEN Auto-reload preload register Write a new value in TIMx_ARR Auto-reload shadow register   F5   36

RM0490 Rev 5   451/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  The following figures show some examples of the counter behavior for different clock frequencies when TIMx_ARR=0x36.  Figure 126. Counter timing diagram, internal clock divided by 1 Figure 127. Counter timing diagram, internal clock divided by 2  36   34   33   32   31   30   2F 04   03   02   01   00 05 MS31184V1 CK_PSC CNT_EN Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow (cnt_udf) Update interrupt flag (UIF) 35  MS31185V1 CK_PSC CNT_EN Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow Update interrupt flag (UIF) 0002   0001   0000   0036   0035   0034   0033

General-purpose timers (TIM2/TIM3)   RM0490  452/1027   RM0490 Rev 5  Figure 128. Counter timing diagram, internal clock divided by 4 Figure 129. Counter timing diagram, internal clock divided by N  0000   0001 0001   0000 MS31186V1 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow Update interrupt flag (UIF) CNT_EN  00 1F 20 MS31187V1 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow Update interrupt flag (UIF) 36

RM0490 Rev 5   453/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Figure 130. Counter timing diagram, Update event Center-aligned mode (up/down counting)  In center-aligned mode, the counter counts from 0 to the auto-reload value (content of the TIMx_ARR register) – 1, generates a counter overflow event, then counts from the auto- reload value down to 1 and generates a counter underflow event. Then it restarts counting from 0. Center-aligned mode is active when the CMS bits in TIMx_CR1 register are not equal to '00'. The Output compare interrupt flag of channels configured in output is set when: the counter counts down (Center aligned mode 1, CMS = "01"), the counter counts up (Center aligned mode 2, CMS = "10") the counter counts up and down (Center aligned mode 3, CMS = "11"). In this mode, the direction bit (DIR from TIMx_CR1 register) cannot be written. It is updated by hardware and gives the current direction of the counter. The update event can be generated at each counter overflow and at each counter underflow or by setting the UG bit in the TIMx_EGR register (by software or by using the slave mode controller) also generates an update event. In this case, the counter restarts counting from 0, as well as the counter of the prescaler. The UEV update event can be disabled by software by setting the UDIS bit in TIMx_CR1 register. This is to avoid updating the shadow registers while writing new values in the preload registers. Then no update event occurs until the UDIS bit has been written to 0. However, the counter continues counting up and down, based on the current auto-reload value. In addition, if the URS bit (update request selection) in TIMx_CR1 register is set, setting the UG bit generates an update event UEV but without setting the UIF flag (thus no interrupt or  FF   36 MS31188V1 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow Update interrupt flag (UIF) 00 02 03 04 05   30   2F 32 33 34 35 36   31 01 CEN Auto-reload preload register Write a new value in TIMx_ARR

General-purpose timers (TIM2/TIM3)   RM0490  454/1027   RM0490 Rev 5  DMA request is sent). This is to avoid generating both update and capture interrupt when clearing the counter on the capture event. When an update event occurs, all the registers are updated and the update flag (UIF bit in TIMx_SR register) is set (depending on the URS bit):  •   The buffer of the prescaler is reloaded with the preload value (content of the TIMx_PSC register).  •   The auto-reload active register is updated with the preload value (content of the TIMx_ARR register). Note that if the update source is a counter overflow, the auto- reload is updated before the counter is reloaded, so that the next period is the expected one (the counter is loaded with the new value). The following figures show some examples of the counter behavior for different clock frequencies.  Figure 131. Counter timing diagram, internal clock divided by 1, TIMx_ARR=0x6  1.   Here, center-aligned mode 1 is used (for more details refer to   Section 18.4.1: TIMx control register 1 (TIMx_CR1)(x = 2 to 3) on page 488 ).  MS31189V3 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) CEN Counter underflow 00 02 03 04   05   06 01   02   03   04 01   05   03 04

RM0490 Rev 5   455/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Figure 132. Counter timing diagram, internal clock divided by 2 Figure 133. Counter timing diagram, internal clock divided by 4, TIMx_ARR=0x36  1.   Center-aligned mode 2 or 3 is used with an UIF on overflow.  MS31190V1 CK_PSC CNT_EN Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow Update interrupt flag (UIF) 0003   0002   0001   0000   0001   0002   0003  0034   0035 MS31191V1 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) CNT_EN Note: Here, center_aligned mode 2 or 3 is updated with an UIF on overflow 0036   0035

General-purpose timers (TIM2/TIM3)   RM0490  456/1027   RM0490 Rev 5  Figure 134. Counter timing diagram, internal clock divided by N Figure 135. Counter timing diagram, Update event with ARPE=1 (counter underflow)  00 1F 20 MS31192V1 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow Update interrupt flag (UIF) 01  FD   36 MS31193V1 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter underflow Update interrupt flag (UIF) 00   02   03   04   05   06   07 01 CEN Auto-reload preload register Write a new value in TIMx_ARR 06   05   04   03   02   01 FD   36 Auto-reload active register

RM0490 Rev 5   457/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Figure 136. Counter timing diagram, Update event with ARPE=1 (counter overflow) 18.3.3   Clock selection  The counter clock can be provided by the following clock sources:  •   Internal clock (CK_INT)  •   External clock mode1: external input pin (TIx)  •   External clock mode2: external trigger input (ETR)  •   Internal trigger inputs (ITRx): using one timer as prescaler for another timer, for example, Timer X can be configured to act as a prescaler for Timer Y. Refer to   : Using one timer as prescaler for another timer on page 482   for more details.  Internal clock source (CK_INT)  If the slave mode controller is disabled (SMS=000 in the TIMx_SMCR register), then the CEN, DIR (in the TIMx_CR1 register) and UG bits (in the TIMx_EGR register) are actual control bits and can be changed only by software (except UG which remains cleared automatically). As soon as the CEN bit is written to 1, the prescaler is clocked by the internal clock CK_INT.  Figure 137   shows the behavior of the control circuit and the upcounter in normal mode, without prescaler.  MS31194V1 FD   36 CK_PSC Timer clock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 36   34   33   32   31   30   2F F8   F9   FA   FB   FC F7   35 CEN Auto-reload preload register Write a new value in TIMx_ARR Auto-reload active register   FD   36

General-purpose timers (TIM2/TIM3)   RM0490  458/1027   RM0490 Rev 5  Figure 137. Control circuit in normal mode, internal clock divided by 1 External clock source mode 1  This mode is selected when SMS=111 in the TIMx_SMCR register.   The counter can count at each rising or falling edge on a selected input.  Figure 138. TI2 external clock connection example  1.   Codes ranging from 01000 to 11111: ITRy. For example, to configure the upcounter to count in response to a rising edge on the TI2 input, use the following procedure: 1.   Select the proper TI2x source (internal or external) with the TI2SEL[3:0] bits in the TIMx_TISEL register. 2.   Configure channel 2 to detect rising edges on the TI2 input by writing CC2S= ‘01 in the TIMx_CCMR1 register. 3.   Configure the input filter duration by writing the IC2F[3:0] bits in the TIMx_CCMR1 register (if no filter is needed, keep IC2F=0000).  MSv67545V1 Internal clock Counter clock = CK_CNT = CK_PSC Counter register CEN=CNT_EN UG Counter initialization (internal) 00   02   03   04   05   06   07 3 2   33   34   35   36 31   01  MSv40117V1 External clock mode 1 Internal clock mode CK_PSC TIMx_SMCR SMS[2:0] ITRx TI1_ED TI1FP1 TI2FP2 TIMx_SMCR TS[4:0] TI2[0] 0 1 TIMx_CCER CC2P TIMx_CCMR1 Edge detector TI2F_Rising TI2F_Falling 00110 000xx 00100 00101 Filter ICF[3:0]   (internal clock) Encoder mode ETRF   00111 External clock mode 2 ECE TI2[1..15]   TI2 TRGI ETRF CK_INT TI1F   or TI2F   or or TIMx_CH2 (1)

RM0490 Rev 5   459/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Note:   The capture prescaler is not used for triggering, so it does not need to be configured.  4.   Select rising edge polarity by writing CC2P=0 and CC2NP=0 and CC2NP=0 in the TIMx_CCER register. 5.   Configure the timer in external clock mode 1 by writing SMS=111 in the TIMx_SMCR register. 6.   Select TI2 as the input source by writing TS=00110 in the TIMx_SMCR register. 7.   Enable the counter by writing CEN=1 in the TIMx_CR1 register. When a rising edge occurs on TI2, the counter counts once and the TIF flag is set. The delay between the rising edge on TI2 and the actual clock of the counter is due to the resynchronization circuit on TI2 input.  Figure 139. Control circuit in external clock mode 1 External clock source mode 2  This mode is selected by writing ECE=1 in the TIMx_SMCR register. The counter can count at each rising or falling edge on the external trigger input ETR.  Figure 140   gives an overview of the external trigger input block.  Counter clock = CK_CNT = CK_PSC Counter register   35   36 34 TI2 CNT_EN TIF Write TIF=0 MS31087V2

General-purpose timers (TIM2/TIM3)   RM0490  460/1027   RM0490 Rev 5  Figure 140. External trigger input block  For example, to configure the upcounter to count each 2 rising edges on ETR, use the following procedure: 1.   Select the proper ETR source (internal or external) with the ETRSEL[3:0] bits in the TIMx_AF1 register. 2.   As no filter is needed in this example, write ETF[3:0]=0000 in the TIMx_SMCR register. 3.   Set the prescaler by writing ETPS[1:0]=01 in the TIMx_SMCR register 4.   Select rising edge detection on the ETR pin by writing ETP=0 in the TIMx_SMCR register 5.   Enable external clock mode 2 by writing ECE=1 in the TIMx_SMCR register. 6.   Enable the counter by writing CEN=1 in the TIMx_CR1 register. The counter counts once each 2 ETR rising edges. The delay between the rising edge on ETR and the actual clock of the counter is due to the resynchronization circuit on the ETRP signal. As a consequence, the maximum frequency which can be correctly captured by the counter is at most ¼ of TIMxCLK frequency. When the ETRP signal is faster, the user should apply a division of the external signal by a proper ETPS prescaler setting.  TBD  MSv40928V1 Internal clock mode CK_INT CK_PSC TIMx_SMCR SMS[2:0] (internal clock) TI1F   or TI2F   or or Encoder mode External clock mode 2 ETRF ECE 0 1 TIMx_SMCR ETP ETR f ETRP TIMx_SMCR ETPS[1:0] TIMx_SMCR ETF[3:0] DTS ETR0 input from AF controller External clock mode 1 TRGI Filter downcounter Divider /1, /2, /4, /8 ETR1..15 inputs from on-chip sources ETRSEL[3:0] TIMx_AF1

RM0490 Rev 5   461/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Figure 141. Control circuit in external clock mode 2 18.3.4   Capture/Compare channels  Each Capture/Compare channel is built around a capture/compare register (including a shadow register), a input stage for capture (with digital filter, multiplexing and prescaler) and an output stage (with comparator and output control). The following figure gives an overview of one Capture/Compare channel. The input stage samples the corresponding TIx input to generate a filtered signal TIxF. Then, an edge detector with polarity selection generates a signal (TIxFPx) which can be used as trigger input by the slave mode controller or as the capture command. It is prescaled before the capture register (ICxPS).  Figure 142. Capture/Compare channel (example: channel 1 input stage)  The output stage generates an intermediate waveform which is then used for reference: OCxRef (active high). The polarity acts at the end of the chain.  MSv33111V3 34   35   36 f  CK_INT CNT_EN ETR ETRP ETRF Counter clock = CK_CNT =CK_PSC Counter register  MSv40120V1 0 1 ICPS[1:0] TI1F_ED To the slave mode controller TI1FP1 11 01 CC1S[1:0] IC1 TI2FP1 TRC (from slave mode controller) 10   IC1PS 0 1   TIMx_CCER CC1P/CC1NP TIMx_CCMR1 Edge detector TI1F_Rising TI1F_Falling Filter downcounter ICF[3:0] Divider /1, /2, /4, /8 TIMx_CCMR1 TIMx_CCER TI2F_Rising (from channel 2) TI2F_Falling (from channel 2) TI1F f DTS CC1E TIMx_CH1 TI1[1..15] TI1[0]

General-purpose timers (TIM2/TIM3)   RM0490  462/1027   RM0490 Rev 5  Figure 143. Capture/Compare channel 1 main circuit Figure 144. Output stage of Capture/Compare channel (channel 1)  The capture/compare block is made of one preload register and one shadow register. Write and read always access the preload register. In capture mode, captures are actually done in the shadow register, which is copied into the preload register. In compare mode, the content of the preload register is copied into the shadow register which is compared to the counter.  MSv63030V1 CC1E compare shadow register Comparator Capture/compare preload register Counter IC1PS CC1S[0] CC1S[1] Capture Input mode CC1S[0] CC1S[1] Output mode UEV OC1PE (from time base unit) Compare transfer APB Bus 16/32-bit MCU-peripheral interface TIMx_CCMR1 OC1PE CNT>CCR1 CNT=CCR1 TIMx_EGR CC1G  MS33145V5 Output mode controller CNT > CCR1 CNT = CCR1 TIMx_CCMR1 OC1M[3:0] 0 1 CC1P TIMx_CCER Output enable circuit OC1 CC1E   TIMx_CCER To the master mode controller OC1REF OC1CE 0 1 CC1E TIMx_CCER ‘0’ 0 1 ocref_clr_int ETRF OCREF_CLR OCCS TIMx_SMCR Output selector OC2REF OC1REFC

RM0490 Rev 5   463/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  18.3.5   Input capture mode  In Input capture mode, the Capture/Compare Registers (TIMx_CCRx) are used to latch the value of the counter after a transition detected by the corresponding ICx signal. When a capture occurs, the corresponding CCXIF flag (TIMx_SR register) is set and an interrupt or a DMA request can be sent if they are enabled. If a capture occurs while the CCxIF flag was already high, then the over-capture flag CCxOF (TIMx_SR register) is set. CCxIF can be cleared by software by writing it to 0 or by reading the captured data stored in the TIMx_CCRx register. CCxOF is cleared when it is written with 0. The following example shows how to capture the counter value in TIMx_CCR1 when TI1 input rises. To do this, use the following procedure: 1.   Select the proper TI1x source (internal or external) with the TI1SEL[3:0] bits in the TIMx_TISEL register. 2.   Select the active input: TIMx_CCR1 must be linked to the TI1 input, so write the CC1S bits to 01 in the TIMx_CCMR1 register. As soon as CC1S becomes different from 00, the channel is configured in input and the TIMx_CCR1 register becomes read-only. 3.   Program the appropriate input filter duration in relation with the signal connected to the timer (when the input is one of the TIx (ICxF bits in the TIMx_CCMRx register). Let’s imagine that, when toggling, the input signal is not stable during at must 5 internal clock cycles. We must program a filter duration longer than these 5 clock cycles. We can validate a transition on TI1 when 8 consecutive samples with the new level have been detected (sampled at f   DTS   frequency). Then write IC1F bits to 0011 in the TIMx_CCMR1 register. 4.   Select the edge of the active transition on the TI1 channel by writing the CC1P and CC1NP and CC1NP bits to 000 in the TIMx_CCER register (rising edge in this case). 5.   Program the input prescaler. In our example, we wish the capture to be performed at each valid transition, so the prescaler is disabled (write IC1PS bits to 00 in the TIMx_CCMR1 register). 6.   Enable capture from the counter into the capture register by setting the CC1E bit in the TIMx_CCER register. 7.   If needed, enable the related interrupt request by setting the CC1IE bit in the TIMx_DIER register, and/or the DMA request by setting the CC1DE bit in the TIMx_DIER register. When an input capture occurs:  •   The TIMx_CCR1 register gets the value of the counter on the active transition.  •   CC1IF flag is set (interrupt flag). CC1OF is also set if at least two consecutive captures occurred whereas the flag was not cleared.  •   An interrupt is generated depending on the CC1IE bit.  •   A DMA request is generated depending on the CC1DE bit. In order to handle the overcapture, it is recommended to read the data before the overcapture flag. This is to avoid missing an overcapture which could happen after reading the flag and before reading the data.  Note:   IC interrupt and/or DMA requests can be generated by software by setting the corresponding CCxG bit in the TIMx_EGR register.

General-purpose timers (TIM2/TIM3)   RM0490  464/1027   RM0490 Rev 5  18.3.6   PWM input mode  This mode is a particular case of input capture mode. The procedure is the same except:  •   Two ICx signals are mapped on the same TIx input.  •   These 2 ICx signals are active on edges with opposite polarity.  •   One of the two TIxFP signals is selected as trigger input and the slave mode controller is configured in reset mode. For example, one can measure the period (in TIMx_CCR1 register) and the duty cycle (in TIMx_CCR2 register) of the PWM applied on TI1 using the following procedure (depending on CK_INT frequency and prescaler value): 1.   Select the proper TI1x source (internal or external) with the TI1SEL[3:0] bits in the TIMx_TISEL register. 2.   Select the active input for TIMx_CCR1: write the CC1S bits to 01 in the TIMx_CCMR1 register (TI1 selected). 3.   Select the active polarity for TI1FP1 (used both for capture in TIMx_CCR1 and counter clear): write the CC1P to ‘0’ and the CC1NP bit to ‘0’ (active on rising edge). 4.   Select the active input for TIMx_CCR2: write the CC2S bits to 10 in the TIMx_CCMR1 register (TI1 selected). 5.   Select the active polarity for TI1FP2 (used for capture in TIMx_CCR2): write the CC2P bit to ‘1’ and the CC2NP bit to ’0’ (active on falling edge). 6.   Select the valid trigger input: write the TS bits to 00101 in the TIMx_SMCR register (TI1FP1 selected). 7.   Configure the slave mode controller in reset mode: write the SMS bits to 100 in the TIMx_SMCR register. 8.   Enable the captures: write the CC1E and CC2E bits to ‘1 in the TIMx_CCER register.  Figure 145. PWM input mode timing  1.   The PWM input mode can be used only with the TIMx_CH1/TIMx_CH2 signals due to the fact that only TI1FP1 and TI2FP2 are connected to the slave mode controller.

RM0490 Rev 5   465/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  18.3.7   Forced output mode  In output mode (CCxS bits = 00 in the TIMx_CCMRx register), each output compare signal (OCxREF and then OCx) can be forced to active or inactive level directly by software, independently of any comparison between the output compare register and the counter. To force an output compare signal (ocxref/OCx) to its active level, one just needs to write 101 in the OCxM bits in the corresponding TIMx_CCMRx register. Thus ocxref is forced high (OCxREF is always active high) and OCx get opposite value to CCxP polarity bit. e.g.: CCxP=0 (OCx active high) => OCx is forced to high level. ocxref signal can be forced low by writing the OCxM bits to 100 in the TIMx_CCMRx register. Anyway, the comparison between the TIMx_CCRx shadow register and the counter is still performed and allows the flag to be set. Interrupt and DMA requests can be sent accordingly. This is described in the Output Compare Mode section.  18.3.8   Output compare mode  This function is used to control an output waveform or indicating when a period of time has elapsed. When a match is found between the capture/compare register and the counter, the output compare function:  •   Assigns the corresponding output pin to a programmable value defined by the output compare mode (OCxM bits in the TIMx_CCMRx register) and the output polarity (CCxP bit in the TIMx_CCER register). The output pin can keep its level (OCXM=000), be set active (OCxM=001), be set inactive (OCxM=010) or can toggle (OCxM=011) on match.  •   Sets a flag in the interrupt status register (CCxIF bit in the TIMx_SR register).  •   Generates an interrupt if the corresponding interrupt mask is set (CCXIE bit in the TIMx_DIER register).  •   Sends a DMA request if the corresponding enable bit is set (CCxDE bit in the TIMx_DIER register, CCDS bit in the TIMx_CR2 register for the DMA request selection). The TIMx_CCRx registers can be programmed with or without preload registers using the OCxPE bit in the TIMx_CCMRx register. In output compare mode, the update event UEV has no effect on ocxref and OCx output. The timing resolution is one count of the counter. Output compare mode can also be used to output a single pulse (in One-pulse mode).  Procedure  1.   Select the counter clock (internal, external, prescaler). 2.   Write the desired data in the TIMx_ARR and TIMx_CCRx registers. 3.   Set the CCxIE and/or CCxDE bits if an interrupt and/or a DMA request is to be generated. 4.   Select the output mode. For example, one must write OCxM=011, OCxPE=0, CCxP=0 and CCxE=1 to toggle OCx output pin when CNT matches CCRx, CCRx preload is not used, OCx is enabled and active high. 5.   Enable the counter by setting the CEN bit in the TIMx_CR1 register.

General-purpose timers (TIM2/TIM3)   RM0490  466/1027   RM0490 Rev 5  The TIMx_CCRx register can be updated at any time by software to control the output waveform, provided that the preload register is not enabled (OCxPE=0, else TIMx_CCRx shadow register is updated only at the next update event UEV). An example is given in  Figure 146 .  Figure 146. Output compare mode, toggle on OC1 18.3.9   PWM mode  Pulse width modulation mode permits to generate a signal with a frequency determined by the value of the TIMx_ARR register and a duty cycle determined by the value of the TIMx_CCRx register. The PWM mode can be selected independently on each channel (one PWM per OCx output) by writing 110 (PWM mode 1) or ‘111 (PWM mode 2) in the OCxM bits in the TIMx_CCMRx register. The corresponding preload register must be enabled by setting the OCxPE bit in the TIMx_CCMRx register, and eventually the auto-reload preload register (in upcounting or center-aligned modes) by setting the ARPE bit in the TIMx_CR1 register. As the preload registers are transferred to the shadow registers only when an update event occurs, before starting the counter, all registers must be initialized by setting the UG bit in the TIMx_EGR register. OCx polarity is software programmable using the CCxP bit in the TIMx_CCER register. It can be programmed as active high or active low. OCx output is enabled by the CCxE bit in the TIMx_CCER register. Refer to the TIMx_CCERx register description for more details. In PWM mode (1 or 2), TIMx_CNT and TIMx_CCRx are always compared to determine whether TIMx_CCRx   ≤   TIMx_CNT or TIMx_CNT   ≤   TIMx_CCRx (depending on the direction of the counter). However, to comply with the OCREF_CLR functionality (OCREF can be  MS31092V1 OC1REF= OC1 TIM1_CNT   B200   B201 0039 TIM1_CCR1   003A Write B201h in the CC1R register Match detected on CCR1 Interrupt generated if enabled 003B B201 003A

RM0490 Rev 5   467/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  cleared by an external event through the ETR signal until the next PWM period), the OCREF signal is asserted only:  •   When the result of the comparison or  •   When the output compare mode (OCxM bits in TIMx_CCMRx register) switches from the “frozen” configuration (no comparison, OCxM=‘000) to one of the PWM modes (OCxM=‘110 or ‘111). This forces the PWM by software while the timer is running. The timer is able to generate PWM in edge-aligned mode or center-aligned mode depending on the CMS bits in the TIMx_CR1 register.  PWM edge-aligned mode  Upcounting configuration Upcounting is active when the DIR bit in the TIMx_CR1 register is low. Refer to   Upcounting mode on page 447 . In the following example, we consider PWM mode 1. The reference PWM signal OCxREF is high as long as TIMx_CNT <TIMx_CCRx else it becomes low. If the compare value in TIMx_CCRx is greater than the auto-reload value (in TIMx_ARR) then OCxREF is held at ‘1. If the compare value is 0 then OCxREF is held at ‘0.   Figure 147   shows some edge-aligned PWM waveforms in an example where TIMx_ARR=8.  Figure 147. Edge-aligned PWM waveforms (ARR=8)  MS31093V1 Counter register ‘1’ 0   1   2   3   4   5   6   7   8   0   1 OCXREF CCxIF OCXREF CCxIF OCXREF CCxIF OCXREF CCxIF CCRx=4 CCRx=8 CCRx>8 CCRx=0 ‘0’

General-purpose timers (TIM2/TIM3)   RM0490  468/1027   RM0490 Rev 5  Downcounting configuration  Downcounting is active when DIR bit in TIMx_CR1 register is high. Refer to   Downcounting mode on page 450 . In PWM mode 1, the reference signal ocxref is low as long as TIMx_CNT>TIMx_CCRx else it becomes high. If the compare value in TIMx_CCRx is greater than the auto-reload value in TIMx_ARR, then ocxref is held at 100%. PWM is not possible in this mode.  PWM center-aligned mode  Center-aligned mode is active when the CMS bits in TIMx_CR1 register are different from ‘00 (all the remaining configurations having the same effect on the ocxref/OCx signals). The compare flag is set when the counter counts up, when it counts down or both when it counts up and down depending on the CMS bits configuration. The direction bit (DIR) in the TIMx_CR1 register is updated by hardware and must not be changed by software. Refer to  Center-aligned mode (up/down counting) on page 453 .  Figure 148   shows some center-aligned PWM waveforms in an example where:  •   TIMx_ARR=8,  •   PWM mode is the PWM mode 1,  •   The flag is set when the counter counts down corresponding to the center-aligned mode 1 selected for CMS=01 in TIMx_CR1 register.

RM0490 Rev 5   469/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Figure 148. Center-aligned PWM waveforms (ARR=8)  Hints on using center-aligned mode:  •   When starting in center-aligned mode, the current up-down configuration is used. It means that the counter counts up or down depending on the value written in the DIR bit in the TIMx_CR1 register. Moreover, the DIR and CMS bits must not be changed at the same time by the software.  •   Writing to the counter while running in center-aligned mode is not recommended as it can lead to unexpected results. In particular: –   The direction is not updated if a value greater than the auto-reload value is written in the counter (TIMx_CNT>TIMx_ARR). For example, if the counter was counting up, it continues to count up. –   The direction is updated if 0 or the TIMx_ARR value is written in the counter but no Update Event UEV is generated.  •   The safest way to use center-aligned mode is to generate an update by software (setting the UG bit in the TIMx_EGR register) just before starting the counter and not to write the counter while it is running.  CCxIF 0   1   2   3   4   5   6   7   8   7   6   5   4   3   2   1   0   1 Counter register CCRx = 4 OCxREF CMS=01 CMS=10 CMS=11 CCxIF CCRx=7 OCxREF CMS=10 or 11 CCxIF CCRx=8 OCxREF CMS=01 CMS=10 CMS=11 ‘1’ CCxIF CCRx>8 OCxREF CMS=01 CMS=10 CMS=11 ‘1’ CCxIF CCRx=0 OCxREF CMS=01 CMS=10 CMS=11 ‘0’ AI14681b

General-purpose timers (TIM2/TIM3)   RM0490  470/1027   RM0490 Rev 5  18.3.10   Asymmetric PWM mode  Asymmetric mode allows two center-aligned PWM signals to be generated with a programmable phase shift. While the frequency is determined by the value of the TIMx_ARR register, the duty cycle and the phase-shift are determined by a pair of TIMx_CCRx registers. One register controls the PWM during up-counting, the second during down counting, so that PWM is adjusted every half PWM cycle:  •   OC1REFC (or OC2REFC) is controlled by TIMx_CCR1 and TIMx_CCR2  •   OC3REFC (or OC4REFC) is controlled by TIMx_CCR3 and TIMx_CCR4 Asymmetric PWM mode can be selected independently on two channels (one OCx output per pair of CCR registers) by writing ‘1110’ (Asymmetric PWM mode 1) or ‘1111’ (Asymmetric PWM mode 2) in the OCxM bits in the TIMx_CCMRx register.  Note:   The OCxM[3:0] bit field is split into two parts for compatibility reasons, the most significant bit is not contiguous with the 3 least significant ones.  When a given channel is used as asymmetric PWM channel, its secondary channel can also be used. For instance, if an OC1REFC signal is generated on channel 1 (Asymmetric PWM mode 1), it is possible to output either the OC2REF signal on channel 2, or an OC2REFC signal resulting from asymmetric PWM mode 2.  Figure 149   shows an example of signals that can be generated using Asymmetric PWM mode (channels 1 to 4 are configured in Asymmetric PWM mode 1).  Figure 149. Generation of 2 phase-shifted PWM signals with 50% duty cycle 18.3.11   Combined PWM mode  Combined PWM mode allows two edge or center-aligned PWM signals to be generated with programmable delay and phase shift between respective pulses. While the frequency is determined by the value of the TIMx_ARR register, the duty cycle and delay are determined by the two TIMx_CCRx registers. The resulting signals, OCxREFC, are made of an OR or AND logical combination of two reference PWMs: – OC1REFC (or OC2REFC) is controlled by TIMx_CCR1 and TIMx_CCR2 – OC3REFC (or OC4REFC) is controlled by TIMx_CCR3 and TIMx_CCR4 Combined PWM mode can be selected independently on two channels (one OCx output per pair of CCR registers) by writing ‘1100’ (Combined PWM mode 1) or ‘1101’ (Combined PWM mode 2) in the OCxM bits in the TIMx_CCMRx register.  MS33117V1 Counter register OC1REFC CCR1=0 CCR2=8 CCR3=3 CCR4=5 0   1   2   3   4   5   6   7   0 1 2 3 4 5 6 7 8   1 1 OC3REFC

RM0490 Rev 5   471/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  When a given channel is used as combined PWM channel, its secondary channel must be configured in the opposite PWM mode (for instance, one in Combined PWM mode 1 and the other in Combined PWM mode 2).  Note:   The OCxM[3:0] bit field is split into two parts for compatibility reasons, the most significant bit is not contiguous with the 3 least significant ones. Figure 150   shows an example of signals that can be generated using Asymmetric PWM mode, obtained with the following configuration:  •   Channel 1 is configured in Combined PWM mode 2,  •   Channel 2 is configured in PWM mode 1,  •   Channel 3 is configured in Combined PWM mode 2,  •   Channel 4 is configured in PWM mode 1  Figure 150. Combined PWM mode on channels 1 and 3 18.3.12   Clearing the OCxREF signal on an external event  The OCxREF signal of a given channel can be cleared when a high level is applied on the ocref_clr_int input (OCxCE enable bit in the corresponding TIMx_CCMRx register set to 1). OCxREF remains low until the next transition to the active state, on the following PWM cycle. This function can only be used in Output compare and PWM modes. It does not work in Forced mode. OCREF_CLR_INPUT can be selected between the OCREF_CLR input and ETRF (ETR after the filter) by configuring the OCCS bit in the TIMx_SMCR register.  MS31094V1 OC1REF OC2REF OC1REF’ OC2REF’ OC1REFC OC1REFC’ OC1REFC = OC1REF AND OC2REF OC1REFC’ = OC1REF’ OR OC2REF’ OC1 OC2 OC1’ OC2’

General-purpose timers (TIM2/TIM3)   RM0490  472/1027   RM0490 Rev 5  The OCxREF signal for a given channel can be reset by applying a high level on the ETRF input (OCxCE enable bit set to 1 in the corresponding TIMx_CCMRx register). OCxREF remains low until the next transition to the active state, on the following PWM cycle. This function can be used only in the output compare and PWM modes. It does not work in forced mode. For example, the OCxREF signal can be connected to the output of a comparator to be used for current handling. In this case, ETR must be configured as follows: 1.   The external trigger prescaler should be kept off: bits ETPS[1:0] in the TIMx_SMCR register are cleared to 00. 2.   The external clock mode 2 must be disabled: bit ECE in the TIM1_SMCR register is cleared to 0. 3.   The external trigger polarity (ETP) and the external trigger filter (ETF) can be configured according to the application’s needs.  Figure 151   shows the behavior of the OCxREF signal when the ETRF input becomes high, for both values of the OCxCE enable bit. In this example, the timer TIMx is programmed in PWM mode.  Figure 151. Clearing TIMx OCxREF  Note:   In case of a PWM with a 100% duty cycle (if CCRx>ARR), OCxREF is enabled again at the next counter overflow.  MS33105V2 (CCRx) Counter (CNT) ETRF OCxREF (OCxCE = ‘0’) OCxREF (OCxCE = ‘1’) ocref_clr_int becomes high ocref_clr_int still high

RM0490 Rev 5   473/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  18.3.13   One-pulse mode  One-pulse mode (OPM) is a particular case of the previous modes. It allows the counter to be started in response to a stimulus and to generate a pulse with a programmable length after a programmable delay. Starting the counter can be controlled through the slave mode controller. Generating the waveform can be done in output compare mode or PWM mode. One-pulse mode is selected by setting the OPM bit in the TIMx_CR1 register. This makes the counter stop automatically at the next update event UEV. A pulse can be correctly generated only if the compare value is different from the counter initial value. Before starting (when the timer is waiting for the trigger), the configuration must be:  •   CNT<CCRx   ≤   ARR (in particular, 0<CCRx),  Figure 152. Example of one-pulse mode.  For example one may want to generate a positive pulse on OC1 with a length of t PULSE   and after a delay of t   DELAY   as soon as a positive edge is detected on the TI2 input pin. Let’s use TI2FP2 as trigger 1: 1.   Select the proper TI2x source (internal or external) with the TI2SEL[3:0] bits in the TIMx_TISEL register. 2.   Map TI2FP2 on TI2 by writing CC2S=01 in the TIMx_CCMR1 register. 3.   TI2FP2 must detect a rising edge, write CC2P=0 and CC2NP=’0’ in the TIMx_CCER register. 4.   Configure TI2FP2 as trigger for the slave mode controller (TRGI) by writing TS=00110 in the TIMx_SMCR register. 5.   TI2FP2 is used to start the counter by writing SMS to ‘110 in the TIMx_SMCR register (trigger mode).  MS31099V1 TI2 OC1REF Counter t 0 TIM1_ARR TIM1_CCR1 OC1 t   DELAY   t   PULSE

General-purpose timers (TIM2/TIM3)   RM0490  474/1027   RM0490 Rev 5  The OPM waveform is defined by writing the compare registers (taking into account the clock frequency and the counter prescaler).  •   The t DELAY   is defined by the value written in the TIMx_CCR1 register.  •   The t PULSE   is defined by the difference between the auto-reload value and the compare value (TIMx_ARR - TIMx_CCR1).  •   Let’s say one want to build a waveform with a transition from ‘0 to ‘1 when a compare match occurs and a transition from ‘1 to ‘0 when the counter reaches the auto-reload value. To do this PWM mode 2 must be enabled by writing OC1M=111 in the TIMx_CCMR1 register. Optionally the preload registers can be enabled by writing OC1PE=1 in the TIMx_CCMR1 register and ARPE in the TIMx_CR1 register. In this case one has to write the compare value in the TIMx_CCR1 register, the auto-reload value in the TIMx_ARR register, generate an update by setting the UG bit and wait for external trigger event on TI2. CC1P is written to ‘0 in this example. In our example, the DIR and CMS bits in the TIMx_CR1 register should be low. Since only 1 pulse (Single mode) is needed, a 1 must be written in the OPM bit in the TIMx_CR1 register to stop the counter at the next update event (when the counter rolls over from the auto-reload value back to 0). When OPM bit in the TIMx_CR1 register is set to '0', so the Repetitive Mode is selected.  Particular case: OCx fast enable:  In One-pulse mode, the edge detection on TIx input set the CEN bit which enables the counter. Then the comparison between the counter and the compare value makes the output toggle. But several clock cycles are needed for these operations and it limits the minimum delay t   DELAY   min we can get. If one wants to output a waveform with the minimum delay, the OCxFE bit can be set in the TIMx_CCMRx register. Then OCxRef (and OCx) is forced in response to the stimulus, without taking in account the comparison. Its new level is the same as if a compare match had occurred. OCxFE acts only if the channel is configured in PWM1 or PWM2 mode.  18.3.14   Retriggerable one pulse mode  This mode allows the counter to be started in response to a stimulus and to generate a pulse with a programmable length, but with the following differences with Non-retriggerable one pulse mode described in   Section 18.3.13 :  •   The pulse starts as soon as the trigger occurs (no programmable delay)  •   The pulse is extended if a new trigger occurs before the previous one is completed The timer must be in Slave mode, with the bits SMS[3:0] = ‘1000’ (Combined Reset + trigger mode) in the TIMx_SMCR register, and the OCxM[3:0] bits set to ‘1000’ or ‘1001’ for Retriggerable OPM mode 1 or 2. If the timer is configured in Up-counting mode, the corresponding CCRx must be set to 0 (the ARR register sets the pulse length). If the timer is configured in Down-counting mode CCRx must be above or equal to ARR.  Note:   In retriggerable one pulse mode, the CCxIF flag is not significant. The OCxM[3:0] and SMS[3:0] bit fields are split into two parts for compatibility reasons, the most significant bit is not contiguous with the 3 least significant ones. This mode must not be used with center-aligned PWM modes. It is mandatory to have CMS[1:0] = 00 in TIMx_CR1.

RM0490 Rev 5   475/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Figure 153. Retriggerable one-pulse mode 18.3.15   Encoder interface mode  To select Encoder Interface mode write SMS=‘001 in the TIMx_SMCR register if the counter is counting on TI2 edges only, SMS=010 if it is counting on TI1 edges only and SMS=011 if it is counting on both TI1 and TI2 edges. Select the TI1 and TI2 polarity by programming the CC1P and CC2P bits in the TIMx_CCER register. CC1NP and CC2NP must be kept cleared. When needed, the input filter can be programmed as well. CC1NP and CC2NP must be kept low. The two inputs TI1 and TI2 are used to interface to an incremental encoder. Refer to  Table 83 . The counter is clocked by each valid transition on TI1FP1 or TI2FP2 (TI1 and TI2 after input filter and polarity selection, TI1FP1=TI1 if not filtered and not inverted, TI2FP2=TI2 if not filtered and not inverted) assuming that it is enabled (CEN bit in TIMx_CR1 register written to ‘1). The sequence of transitions of the two inputs is evaluated and generates count pulses as well as the direction signal. Depending on the sequence the counter counts up or down, the DIR bit in the TIMx_CR1 register is modified by hardware accordingly. The DIR bit is calculated at each transition on any input (TI1 or TI2), whatever the counter is counting on TI1 only, TI2 only or both TI1 and TI2. Encoder interface mode acts simply as an external clock with direction selection. This means that the counter just counts continuously between 0 and the auto-reload value in the TIMx_ARR register (0 to ARR or ARR down to 0 depending on the direction). So the TIMx_ARR must be configured before starting. In the same way, the capture, compare, prescaler, trigger output features continue to work as normal. In this mode, the counter is modified automatically following the speed and the direction of the quadrature encoder and its content, therefore, always represents the encoder’s position. The count direction correspond to the rotation direction of the connected sensor. The table summarizes the possible combinations, assuming TI1 and TI2 do not switch at the same time.  MS33106V2 TRGI Counter Output

General-purpose timers (TIM2/TIM3)   RM0490  476/1027   RM0490 Rev 5  An external incremental encoder can be connected directly to the MCU without external interface logic. However, comparators are normally be used to convert the encoder’s differential outputs to digital signals. This greatly increases noise immunity. The third encoder output which indicate the mechanical zero position, may be connected to an external interrupt input and trigger a counter reset.  Figure 154   gives an example of counter operation, showing count signal generation and direction control. It also shows how input jitter is compensated where both edges are selected. This might occur if the sensor is positioned near to one of the switching points. For this example we assume that the configuration is the following:  •   CC1S= 01 (TIMx_CCMR1 register, TI1FP1 mapped on TI1)  •   CC2S= 01 (TIMx_CCMR1 register, TI2FP2 mapped on TI2)  •   CC1P and CC1NP = ‘0’ (TIMx_CCER register, TI1FP1 noninverted, TI1FP1=TI1)  •   CC2P and CC2NP = ‘0’ (TIMx_CCER register, TI2FP2 noninverted, TI2FP2=TI2)  •   SMS= 011 (TIMx_SMCR register, both inputs are active on both rising and falling edges)  •   CEN= 1 (TIMx_CR1 register, Counter is enabled)  Figure 154. Example of counter operation in encoder interface mode  Figure 155   gives an example of counter behavior when TI1FP1 polarity is inverted (same configuration as above except CC1P=1).  Table 83. Counting direction versus encoder signals Active edge Level on opposite signal (TI1FP1 for TI2, TI2FP2 for TI1) TI1FP1 signal   TI2FP2 signal Rising   Falling   Rising   Falling  Counting on TI1 only High   Down   Up   No Count   No Count Low   Up   Down   No Count   No Count Counting on TI2 only High   No Count   No Count   Up   Down Low   No Count   No Count   Down   Up Counting on TI1 and TI2 High   Down   Up   Up   Down Low   Up   Down   Down   Up  TI1 backward jitter   jitter up   down   up TI2 Counter forward   forward MS33107V1

RM0490 Rev 5   477/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Figure 155. Example of encoder interface mode with TI1FP1 polarity inverted  The timer, when configured in Encoder Interface mode provides information on the sensor’s current position. Dynamic information can be obtained (speed, acceleration, deceleration) by measuring the period between two encoder events using a second timer configured in capture mode. The output of the encoder which indicates the mechanical zero can be used for this purpose. Depending on the time between two events, the counter can also be read at regular times. This can be done by latching the counter value into a third input capture register if available (then the capture signal must be periodic and can be generated by another timer). when available, it is also possible to read its value through a DMA request generated by a Real-Time clock.  18.3.16   UIF bit remapping  The IUFREMAP bit in the TIMx_CR1 register forces a continuous copy of the update interrupt flag (UIF) into bit 31 of the timer counter register’s bit 31 (TIMxCNT[31]). This permits to atomically read both the counter value and a potential roll-over condition signaled by the UIFCPY flag. It eases the calculation of angular speed by avoiding race conditions caused, for instance, by a processing shared between a background task (counter reading) and an interrupt (update interrupt). There is no latency between the UIF and UIFCPY flag assertions. In 32-bit timer implementations, when the IUFREMAP bit is set, bit 31 of the counter is overwritten by the UIFCPY flag upon read access (the counter’s most significant bit is only accessible in write mode).  18.3.17   Timer input XOR function  The TI1S bit in the TIM1xx_CR2 register, allows the input filter of channel 1 to be connected to the output of a XOR gate, combining the three input pins TIMx_CH1 to TIMx_CH3. The XOR output can be used with all the timer input functions such as trigger or input capture. An example of this feature used to interface Hall sensors is given in   Section 17.3.25: Interfacing with Hall sensors on page 396 .  TI1 backward jitter   jitter up down TI2 Counter forward   forward MS33108V1 down

General-purpose timers (TIM2/TIM3)   RM0490  478/1027   RM0490 Rev 5  18.3.18   Timers and external trigger synchronization  The TIMx Timers can be synchronized with an external trigger in several modes: Reset mode, Gated mode and Trigger mode.  Slave mode: Reset mode  The counter and its prescaler can be reinitialized in response to an event on a trigger input. Moreover, if the URS bit from the TIMx_CR1 register is low, an update event UEV is generated. Then all the preloaded registers (TIMx_ARR, TIMx_CCRx) are updated. In the following example, the upcounter is cleared in response to a rising edge on TI1 input: 1.   Configure the channel 1 to detect rising edges on TI1. Configure the input filter duration (in this example, we do not need any filter, so we keep IC1F=0000). The capture prescaler is not used for triggering, so it does not need to be configured. The CC1S bits select the input capture source only, CC1S = 01 in the TIMx_CCMR1 register. Write CC1P=0 and CC1NP=0 in TIMx_CCER register to validate the polarity (and detect rising edges only). 2.   Configure the timer in reset mode by writing SMS=100 in TIMx_SMCR register. Select TI1 as the input source by writing TS=00101 in TIMx_SMCR register. 3.   Start the counter by writing CEN=1 in the TIMx_CR1 register. The counter starts counting on the internal clock, then behaves normally until TI1 rising edge. When TI1 rises, the counter is cleared and restarts from 0. In the meantime, the trigger flag is set (TIF bit in the TIMx_SR register) and an interrupt request, or a DMA request can be sent if enabled (depending on the TIE and TDE bits in TIMx_DIER register). The following figure shows this behavior when the auto-reload register TIMx_ARR=0x36. The delay between the rising edge on TI1 and the actual reset of the counter is due to the resynchronization circuit on TI1 input.  Figure 156. Control circuit in reset mode Slave mode: Gated mode  The counter can be enabled depending on the level of a selected input. In the following example, the upcounter counts only when TI1 input is low:  MS31401V2 00 Counter clock = ck_cnt = ck_psc Counter register   01   02   03   00   01   02   03 32   33   34   35   36 UG TI1 31 30 TIF

RM0490 Rev 5   479/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  1.   Configure the channel 1 to detect low levels on TI1. Configure the input filter duration (in this example, we do not need any filter, so we keep IC1F=0000). The capture prescaler is not used for triggering, so it does not need to be configured. The CC1S bits select the input capture source only, CC1S=01 in TIMx_CCMR1 register. Write CC1P=1 and CC1NP=0 in TIMx_CCER register to validate the polarity (and detect low level only). 2.   Configure the timer in gated mode by writing SMS=101 in TIMx_SMCR register. Select TI1 as the input source by writing TS=00101 in TIMx_SMCR register. 3.   Enable the counter by writing CEN=1 in the TIMx_CR1 register (in gated mode, the counter doesn’t start if CEN=0, whatever is the trigger input level). The counter starts counting on the internal clock as long as TI1 is low and stops as soon as TI1 becomes high. The TIF flag in the TIMx_SR register is set both when the counter starts or stops. The delay between the rising edge on TI1 and the actual stop of the counter is due to the resynchronization circuit on TI1 input.  Figure 157. Control circuit in gated mode  1.   The configuration “CCxP=CCxNP=1” (detection of both rising and falling edges) does not have any effect in gated mode because gated mode acts on a level and not on an edge.  Note:   The configuration “CCxP=CCxNP=1” (detection of both rising and falling edges) does not have any effect in gated mode because gated mode acts on a level and not on an edge.  Slave mode: Trigger mode  The counter can start in response to an event on a selected input. In the following example, the upcounter starts in response to a rising edge on TI2 input: 1.   Configure the channel 2 to detect rising edges on TI2. Configure the input filter duration (in this example, we do not need any filter, so we keep IC2F=0000). The capture prescaler is not used for triggering, so it does not need to be configured. CC2S bits are selecting the input capture source only, CC2S=01 in TIMx_CCMR1 register. Write  MS31402V1 TI1 cnt_en Write TIF=0 37 Counter clock = ck_cnt = ck_psc Counter register   38 32   33   34   35   36 31 30 TIF

General-purpose timers (TIM2/TIM3)   RM0490  480/1027   RM0490 Rev 5  CC2P=1 and CC2NP=0 in TIMx_CCER register to validate the polarity (and detect low level only). 2.   Configure the timer in trigger mode by writing SMS=110 in TIMx_SMCR register. Select TI2 as the input source by writing TS=00110 in TIMx_SMCR register. When a rising edge occurs on TI2, the counter starts counting on the internal clock and the TIF flag is set. The delay between the rising edge on TI2 and the actual start of the counter is due to the resynchronization circuit on TI2 input.  Figure 158. Control circuit in trigger mode Slave mode: Combined reset + trigger mode  In this case, a rising edge of the selected trigger input (TRGI) reinitializes the counter, generates an update of the registers, and starts the counter. This mode is used for one-pulse mode.  Slave mode: External Clock mode 2 + trigger mode  The external clock mode 2 can be used in addition to another slave mode (except external clock mode 1 and encoder mode). In this case, the ETR signal is used as external clock input, and another input can be selected as trigger input when operating in reset mode, gated mode or trigger mode. It is recommended not to select ETR as TRGI through the TS bits of TIMx_SMCR register. In the following example, the upcounter is incremented at each rising edge of the ETR signal as soon as a rising edge of TI1 occurs:  MS31403V1 TI2 cnt_en 37 Counter clock = ck_cnt = ck_psc Counter register   38 34   35   36 TIF

RM0490 Rev 5   481/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  1.   Configure the external trigger input circuit by programming the TIMx_SMCR register as follows: –   ETF = 0000: no filter –   ETPS=00: prescaler disabled –   ETP=0: detection of rising edges on ETR and ECE=1 to enable the external clock mode 2. 2.   Configure the channel 1 as follows, to detect rising edges on TI: –   IC1F=0000: no filter. –   The capture prescaler is not used for triggering and does not need to be configured. –   CC1S=01in TIMx_CCMR1 register to select only the input capture source –   CC1P=0 and CC1NP=0 in TIMx_CCER register to validate the polarity (and detect rising edge only). 3.   Configure the timer in trigger mode by writing SMS=110 in TIMx_SMCR register. Select TI1 as the input source by writing TS=00101 in TIMx_SMCR register. A rising edge on TI1 enables the counter and sets the TIF flag. The counter then counts on ETR rising edges. The delay between the rising edge of the ETR signal and the actual reset of the counter is due to the resynchronization circuit on ETRP input.  Figure 159. Control circuit in external clock mode 2 + trigger mode 18.3.19   Timer synchronization  The TIMx timers are linked together internally for timer synchronization or chaining. When one Timer is configured in Master Mode, it can reset, start, stop or clock the counter of another Timer configured in Slave Mode.  Figure 160: Master/Slave timer example   and   Figure 161: Master/slave connection example with 1 channel only timers   present an overview of the trigger selection and the master mode selection blocks.  MS33110V1 34   35   36 TIF Counter register Counter clock = CK_CNT = CK_PSC ETR CEN/CNT_EN TI1

General-purpose timers (TIM2/TIM3)   RM0490  482/1027   RM0490 Rev 5  Figure 160. Master/Slave timer example Figure 161. Master/slave connection example with 1 channel only timers  Note:   The timers with one channel only (see Figure 161) do not feature a master mode. However, the OC1 output signal can be used to trigger some other timers (including timers described in other sections of this document). Check the “TIMx internal trigger connection” table of any TIMx_SMCR register on the device to identify which timers can be targeted as slave. The OC1 signal pulse width must be programmed to be at least 2 clock cycles of the destination timer, to make sure the slave timer detects the trigger. For instance, if the destination's timer CK_INT clock is 4 times slower than the source timer, the OC1 pulse width must be 8 clock cycles.  Using one timer as prescaler for another timer  For example, TIMy can be configured to act as a prescaler for TIMz. Refer to   Figure 160 . To do this:  MSv62394V1 Master mode control UEV Clock Prescaler   Counter Slave mode control Prescaler   Counter CK_PSC ITR2 TRGO MMS   SMS TS Input trigger selection TIMy   TIMz  MSv65225V1 Compare 1 Output control Slave mode control   Counter Prescaler CK_PSC tim_itr tim_oc1 SMS TS Input trigger selection TIM_mstr   TIM_slv Counter Prescaler Clock TIM_CH1

RM0490 Rev 5   483/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  1.   Configure TIMy in master mode so that it outputs a periodic trigger signal on each update event UEV. If MMS=010 is written in the TIMy_CR2 register, a rising edge is output on TRGO each time an update event is generated. 2.   To connect the TRGO output of TIMy to TIMz, TIMz must be configured in slave mode using ITR as internal trigger. This is selected through the TS bits in the TIMz_SMCR register (writing TS=00). 3.   Then the slave mode controller must be put in external clock mode 1 (write SMS=111 in the TIMz_SMCR register). This causes TIMz to be clocked by the rising edge of the periodic TIMy trigger signal (which correspond to the TIMy counter overflow). 4.   Finally both timers must be enabled by setting their respective CEN bits (TIMx_CR1 register).  Note:   If OCx is selected on TIM y   as the trigger output (MMS=1xx), its rising edge is used to clock the counter of TIM z .  Using one timer to enable another timer  In this example, we control the enable of TIMz with the output compare 1 of Timer y. Refer to   Figure 160   for connections. TIMz counts on the divided internal clock only when OC1REF of TIMy is high. Both counter clock frequencies are divided by 3 by the prescaler compared to CK_INT (f   CK_CNT   = f   CK_INT   /3). 1.   Configure TIMy master mode to send its Output Compare 1 Reference (OC1REF) signal as trigger output (MMS=100 in the TIMy_CR2 register). 2.   Configure the TIMy OC1REF waveform (TIMy_CCMR1 register). 3.   Configure TIMz to get the input trigger from TIMy (TS=00 in the TIMz_SMCR register). 4.   Configure TIMz in gated mode (SMS=101 in TIMz_SMCR register). 5.   Enable TIMz by writing ‘1 in the CEN bit (TIMz_CR1 register). 6.   Start TIMy by writing ‘1 in the CEN bit (TIMy_CR1 register).  Note:   The counter   z   clock is not synchronized with counter 1, this mode only affects the TIM z  counter enable signal.  Figure 162. Gating TIM z   with OC1REF of TIM y In the example in   Figure 162 , the TIMz counter and prescaler are not initialized before being started. So they start counting from their current value. It is possible to start from a given value by resetting both timers before starting TIMy. Then any value can be written in the timer counters. The timers can easily be reset by software using the UG bit in the TIMx_EGR registers.  MSv37634V1 CK_INT FC   FD   FE   FF   00   01 TIMy-OC1REF TIMy-CNT 3046 3045   3047   3048 TIMz-CNT TIMz-TIF Write TIF = 0

General-purpose timers (TIM2/TIM3)   RM0490  484/1027   RM0490 Rev 5  In the next example (refer to   Figure 163 ), we synchronize TIMy and TIMz. TIMy is the master and starts from 0. TIMz is the slave and starts from 0xE7. The prescaler ratio is the same for both timers. TIMz stops when TIMy is disabled by writing ‘0 to the CEN bit in the TIMy_CR1 register: 1.   Configure TIMy master mode to send its Output Compare 1 Reference (OC1REF) signal as trigger output (MMS=100 in the TIMy_CR2 register). 2.   Configure the TIMy OC1REF waveform (TIMy_CCMR1 register). 3.   Configure TIMz to get the input trigger from TIMy (TS=00 in the TIMz_SMCR register). 4.   Configure TIMz in gated mode (SMS=101 in TIMz_SMCR register). 5.   Reset TIMy by writing ‘1 in UG bit (TIMy_EGR register). 6.   Reset TIMz by writing ‘1 in UG bit (TIMz_EGR register). 7.   Initialize TIMz to 0xE7 by writing ‘0xE7’ in the TIMz counter (TIMz_CNTL). 8.   Enable TIMz by writing ‘1 in the CEN bit (TIMz_CR1 register). 9.   Start TIMy by writing ‘1 in the CEN bit (TIMy_CR1 register). 10.   Stop TIMy by writing ‘0 in the CEN bit (TIMy_CR1 register).  Figure 163. Gating TIM z   with Enable of TIM y  Using one timer to start another timer  In this example, we set the enable of Timer z with the update event of Timer y. Refer to  Figure 160   for connections. Timer z starts counting from its current value (which can be non- zero) on the divided internal clock as soon as the update event is generated by Timer 1. When Timer z receives the trigger signal its CEN bit is automatically set and the counter counts until we write ‘0 to the CEN bit in the TIMz_CR1 register. Both counter clock frequencies are divided by 3 by the prescaler compared to CK_INT (f CK_CNT   = f CK_INT   /3). 1.   Configure TIMy master mode to send its Update Event (UEV) as trigger output (MMS=010 in the TIMy_CR2 register). 2.   Configure the TIMy period (TIMy_ARR registers). 3.   Configure TIMz to get the input trigger from TIMy (TS=00 in the TIMz_SMCR register). 4.   Configure TIMz in trigger mode (SMS=110 in TIMz_SMCR register). 5.   Start TIMy by writing ‘1 in the CEN bit (TIMy_CR1 register).  MSv37635V1 CK_INT 75   00 E7 TIMy-CNT_INIT TIMy-CNT AB TIMz-CNT TIMz-CNT_INIT Write TIF = 0 01   02 E9 E8 00 TIMy-CEN=CNT_EN TIMz-write CNT TIMz-TIF

RM0490 Rev 5   485/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Figure 164. Triggering TIM z   with update of TIM y As in the previous example, both counters can be initialized before starting counting.  Figure 165   shows the behavior with the same configuration as in   Figure 164   but in trigger mode instead of gated mode (SMS=110 in the TIMz_SMCR register).  Figure 165. Triggering TIM z   with Enable of TIM y  Starting 2 timers synchronously in response to an external trigger  In this example, we set the enable of TIMy when its TI1 input rises, and the enable of TIMz with the enable of TIMy. Refer to   Figure 160   for connections. To ensure the counters are aligned, TIMy must be configured in Master/Slave mode (slave with respect to TI1, master with respect to TIMz):  MSv37636V1 CK_INT TIMz-CNT FD TIMy-CNT Write TIF = 0 TIMz-CEN=CNT_EN TIMz-TIF FE   FF   00   01   02 46   47   48 45 TIMy-UEV  MSv37637V1 CK_INT TIMz-CNT TIMy-CNT_INIT Write TIF = 0 TIMy-CEN=CNT_EN TIMz-TIF E7 02 00   01 E9 75 CD   00   E8   EA TIMy-CNT TIMz-CNT_INIT TIMz write CNT

General-purpose timers (TIM2/TIM3)   RM0490  486/1027   RM0490 Rev 5  1.   Configure TIMy master mode to send its Enable as trigger output (MMS=001 in the TIMy_CR2 register). 2.   Configure TIMy slave mode to get the input trigger from TI1 (TS=00100 in the TIMy_SMCR register). 3.   Configure TIMy in trigger mode (SMS=110 in the TIMy_SMCR register). 4.   Configure the TIMy in Master/Slave mode by writing MSM=1 (TIMy_SMCR register). 5.   Configure TIMz to get the input trigger from TIMy (TS=00000 in the TIMz_SMCR register). 6.   Configure TIMz in trigger mode (SMS=110 in the TIMz_SMCR register). When a rising edge occurs on TI1 (TIMy), both counters starts counting synchronously on the internal clock and both TIF flags are set.  Note:   In this example both timers are initialized before starting (by setting their respective UG bits). Both counters starts from 0, but an offset can easily be inserted between them by writing any of the counter registers (TIMx_CNT). One can see that the master/slave mode insert a delay between CNT_EN and CK_PSC on TIM y .  Figure 166. Triggering TIM y   and TIM z   with TIM y   TI1 input  Note:   The clock of the slave peripherals (timer, ADC, ...) receiving the TRGO or the TRGO2 signals must be enabled prior to receive events from the master timer, and the clock frequency (prescaler) must not be changed on-the-fly while triggers are received from the master timer.  18.3.20   DMA burst mode  The TIMx timers have the capability to generate multiple DMA requests upon a single event. The main purpose is to be able to re-program part of the timer multiple times without software overhead, but it can also be used to read several registers in a row, at regular intervals. The DMA controller destination is unique and must point to the virtual register TIMx_DMAR. On a given timer event, the timer launches a sequence of DMA requests (burst). Each write into the TIMx_DMAR register is actually redirected to one of the timer registers.  MSv37638V1 CK_INT TIMz-CNT TIMy-CEN=CNT_EN TIMz-TIF 01 TIMy-CNT   02   03   04   05   06   07   08   09 00 01   02   03   04   05   06   07   08   09 00 TIMz-CEN=CNT_EN TIMy-TIF TIMy-CK_PSC TIMy-TI1 TIMz-CK_PSC

RM0490 Rev 5   487/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  The DBL[4:0] bits in the TIMx_DCR register set the DMA burst length. The timer recognizes a burst transfer when a read or a write access is done to the TIMx_DMAR address), i.e. the number of transfers (either in half-words or in bytes). The DBA[4:0] bits in the TIMx_DCR registers define the DMA base address for DMA transfers (when read/write access are done through the TIMx_DMAR address). DBA is defined as an offset starting from the address of the TIMx_CR1 register: Example: 00000: TIMx_CR1 00001: TIMx_CR2 00010: TIMx_SMCR As an example, the timer DMA burst feature is used to update the contents of the CCRx registers (x = 2, 3, 4) upon an update event, with the DMA transferring half words into the CCRx registers. This is done in the following steps: 1.   Configure the corresponding DMA channel as follows: –   DMA channel peripheral address is the DMAR register address –   DMA channel memory address is the address of the buffer in the RAM containing the data to be transferred by DMA into CCRx registers. –   Number of data to transfer = 3 (See note below). –   Circular mode disabled. 2.   Configure the DCR register by configuring the DBA and DBL bit fields as follows: DBL = 3 transfers, DBA = 0xE. 3.   Enable the TIMx update DMA request (set the UDE bit in the DIER register). 4.   Enable TIMx 5.   Enable the DMA channel This example is for the case where every CCRx register has to be updated once. If every CCRx register is to be updated twice for example, the number of data to transfer should be 6. Let's take the example of a buffer in the RAM containing data1, data2, data3, data4, data5 and data6. The data is transferred to the CCRx registers as follows: on the first update DMA request, data1 is transferred to CCR2, data2 is transferred to CCR3, data3 is transferred to CCR4 and on the second update DMA request, data4 is transferred to CCR2, data5 is transferred to CCR3 and data6 is transferred to CCR4.  Note:   A null value can be written to the reserved registers.  18.3.21   Debug mode  When the microcontroller enters debug mode (Cortex ®   -M0+ core - halted), the TIMx counter either continues to work normally or stops, depending on DBG_TIMx_STOP configuration bit in DBGMCU module. For more details, refer to   Section 30.9.2: Debug support for timers, watchdog, and I2C .

General-purpose timers (TIM2/TIM3)   RM0490  488/1027   RM0490 Rev 5  18.4   TIM2/TIM3 registers  For STM32C011xx and STM32C031xx, “TIMx” should be understood as “TIM3” since there is only one instance of this type of timer for these products. Refer to   Section 1.2   for a list of abbreviations used in register descriptions. The peripheral registers can be accessed by half-words (16-bit) or words (32-bit).  18.4.1   TIMx control register 1 (TIMx_CR1)(x = 2 to 3)  Address offset: 0x00 Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   UIFRE MAP   Res.   CKD[1:0]   ARPE   CMS[1:0]   DIR   OPM   URS   UDIS   CEN rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:12   Reserved, must be kept at reset value. Bit 11   UIFREMAP : UIF status bit remapping 0: No remapping. UIF status bit is not copied to TIMx_CNT register bit 31. 1: Remapping enabled. UIF status bit is copied to TIMx_CNT register bit 31. Bit 10   Reserved, must be kept at reset value. Bits 9:8   CKD[1:0] : Clock division This bit-field indicates the division ratio between the timer clock (CK_INT) frequency and sampling clock used by the digital filters (ETR, TIx), 00: t DTS   = t   CK_INT 01: t DTS   = 2 × t   CK_INT 10: t DTS   = 4 × t   CK_INT 11: Reserved Bit 7   ARPE : Auto-reload preload enable 0: TIMx_ARR register is not buffered 1: TIMx_ARR register is buffered Bits 6:5   CMS[1:0] : Center-aligned mode selection 00: Edge-aligned mode. The counter counts up or down depending on the direction bit (DIR). 01: Center-aligned mode 1. The counter counts up and down alternatively. Output compare interrupt flags of channels configured in output (CCxS=00 in TIMx_CCMRx register) are set only when the counter is counting down. 10: Center-aligned mode 2. The counter counts up and down alternatively. Output compare interrupt flags of channels configured in output (CCxS=00 in TIMx_CCMRx register) are set only when the counter is counting up. 11: Center-aligned mode 3. The counter counts up and down alternatively. Output compare interrupt flags of channels configured in output (CCxS=00 in TIMx_CCMRx register) are set both when the counter is counting up or down.  Note:   It is not allowed to switch from edge-aligned mode to center-aligned mode as long as the counter is enabled (CEN=1)

RM0490 Rev 5   489/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  18.4.2   TIMx control register 2 (TIMx_CR2)(x = 2 to 3)  Address offset: 0x04 Reset value: 0x0000 Bit 4   DIR : Direction 0: Counter used as upcounter 1: Counter used as downcounter  Note:   This bit is read only when the timer is configured in Center-aligned mode or Encoder mode.  Bit 3   OPM : One-pulse mode 0: Counter is not stopped at update event 1: Counter stops counting at the next update event (clearing the bit CEN) Bit 2   URS :   Update request source This bit is set and cleared by software to select the UEV event sources. 0: Any of the following events generate an update interrupt or DMA request if enabled. These events can be: –   Counter overflow/underflow –   Setting the UG bit –   Update generation through the slave mode controller 1: Only counter overflow/underflow generates an update interrupt or DMA request if enabled. Bit 1   UDIS :   Update disable This bit is set and cleared by software to enable/disable UEV event generation. 0: UEV enabled. The Update (UEV) event is generated by one of the following events: –   Counter overflow/underflow –   Setting the UG bit –   Update generation through the slave mode controller Buffered registers are then loaded with their preload values. 1: UEV disabled. The Update event is not generated, shadow registers keep their value (ARR, PSC, CCRx). However the counter and the prescaler are reinitialized if the UG bit is set or if a hardware reset is received from the slave mode controller. Bit 0   CEN : Counter enable 0: Counter disabled 1: Counter enabled  Note:   External clock, gated mode and encoder mode can work only if the CEN bit has been previously set by software. However trigger mode can set the CEN bit automatically by hardware.  CEN is cleared automatically in one-pulse mode, when an update event occurs. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TI1S   MMS[2:0]   CCDS   Res.   Res.   Res. rw   rw   rw   rw   rw

General-purpose timers (TIM2/TIM3)   RM0490  490/1027   RM0490 Rev 5  Bits 15:8   Reserved, must be kept at reset value. Bit 7   TI1S : TI1 selection 0: The TIMx_CH1 pin is connected to TI1 input 1: The TIMx_CH1, CH2 and CH3 pins are connected to the TI1 input (XOR combination) See also   Section 17.3.25: Interfacing with Hall sensors on page 396  Bits 6:4   MMS[2:0] : Master mode selection These bits permit to select the information to be sent in master mode to slave timers for synchronization (TRGO). The combination is as follows: 000:   Reset   - the UG bit from the TIMx_EGR register is used as trigger output (TRGO). If the reset is generated by the trigger input (slave mode controller configured in reset mode) then the signal on TRGO is delayed compared to the actual reset. 001:   Enable   - the Counter enable signal, CNT_EN, is used as trigger output (TRGO). It is useful to start several timers at the same time or to control a window in which a slave timer is enabled. The Counter Enable signal is generated by a logic AND between CEN control bit and the trigger input when configured in gated mode. When the Counter Enable signal is controlled by the trigger input, there is a delay on TRGO, except if the master/slave mode is selected (see the MSM bit description in TIMx_SMCR register). 010:   Update   - The update event is selected as trigger output (TRGO). For instance a master timer can then be used as a prescaler for a slave timer. 011:   Compare Pulse   - The trigger output send a positive pulse when the CC1IF flag is to be set (even if it was already high), as soon as a capture or a compare match occurred. (TRGO) 100:   Compare   - OC1REFC signal is used as trigger output (TRGO) 101:   Compare   - OC2REFC signal is used as trigger output (TRGO) 110:   Compare   - OC3REFC signal is used as trigger output (TRGO) 111:   Compare   - OC4REFC signal is used as trigger output (TRGO)  Note:   The clock of the slave timer or ADC must be enabled prior to receive events from the master timer, and must not be changed on-the-fly while triggers are received from the master timer.  Bit 3   CCDS : Capture/compare DMA selection 0: CCx DMA request sent when CCx event occurs 1: CCx DMA requests sent when update event occurs Bits 2:0   Reserved, must be kept at reset value.

RM0490 Rev 5   491/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  18.4.3   TIMx slave mode control register (TIMx_SMCR)(x = 2 to 3)  Address offset: 0x08 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TS[4:3]   Res.   Res.   Res.   SMS[3] rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ETP   ECE   ETPS[1:0]   ETF[3:0]   MSM   TS[2:0]   OCCS   SMS[2:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:22   Reserved, must be kept at reset value. Bits 19:17   Reserved, must be kept at reset value. Bit 15   ETP : External trigger polarity This bit selects whether ETR or ETR is used for trigger operations 0: ETR is non-inverted, active at high level or rising edge 1: ETR is inverted, active at low level or falling edge Bit 14   ECE : External clock enable This bit enables External clock mode 2. 0: External clock mode 2 disabled 1: External clock mode 2 enabled. The counter is clocked by any active edge on the ETRF signal.  Note:   Setting the ECE bit has the same effect as selecting external clock mode 1 with TRGI connected to ETRF (SMS=111 and TS=00111). It is possible to simultaneously use external clock mode 2 with the following slave modes: reset mode, gated mode and trigger mode. Nevertheless, TRGI must not be connected to ETRF in this case (TS bits must not be 00111). If external clock mode 1 and external clock mode 2 are enabled at the same time, the external clock input is ETRF.  Bits 13:12   ETPS[1:0] : External trigger prescaler External trigger signal ETRP frequency must be at most 1/4 of CK_INT frequency. A prescaler can be enabled to reduce ETRP frequency. It is useful when inputting fast external clocks. 00: Prescaler OFF 01: ETRP frequency divided by 2 10: ETRP frequency divided by 4 11: ETRP frequency divided by 8

General-purpose timers (TIM2/TIM3)   RM0490  492/1027   RM0490 Rev 5  Bits 11:8   ETF[3:0] : External trigger filter This bit-field then defines the frequency used to sample ETRP signal and the length of the digital filter applied to ETRP. The digital filter is made of an event counter in which N consecutive events are needed to validate a transition on the output: 0000: No filter, sampling is done at f   DTS 0001:   f   SAMPLING =f CK_INT , N=2 0010:   f   SAMPLING =f CK_INT , N=4 0011:   f SAMPLING =f CK_INT , N=8 0100:   f   SAMPLING =f DTS /2, N=6 0101:   f SAMPLING =f DTS /2, N=8 0110:   f   SAMPLING =f DTS /4, N=6 0111:   f   SAMPLING   =f DTS /4, N=8 1000:   f   SAMPLING =f DTS /8, N=6 1001:   f SAMPLING =f DTS /8, N=8 1010:   f SAMPLING =f DTS /16, N=5 1011:   f SAMPLING =f DTS /16, N=6 1100:   f   SAMPLING =f DTS /16, N=8 1101:   f   SAMPLING =f DTS /32, N=5 1110:   f   SAMPLING   =f DTS /32, N=6 1111:   f   SAMPLING =f   DTS /32, N=8 Bit 7   MSM :   Master/Slave mode 0: No action 1: The effect of an event on the trigger input (TRGI) is delayed to allow a perfect synchronization between the current timer and its slaves (through TRGO). It is useful if we want to synchronize several timers on a single external event.

RM0490 Rev 5   493/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Bits 21, 20, 6, 5, 4   TS[4:0] : Trigger selection This bit-field selects the trigger input to be used to synchronize the counter. 00000: Internal Trigger 0 (ITR0) 00001: Internal Trigger 1 (ITR1) 00010: Internal Trigger 2 (ITR2) 00011: Internal Trigger 3 (ITR3) 00100: TI1 Edge Detector (TI1F_ED) 00101: Filtered Timer Input 1 (TI1FP1) 00110: Filtered Timer Input 2 (TI2FP2) 00111: External Trigger input (ETRF) 01000: Internal Trigger 4 (ITR4) 01001: Internal Trigger 5 (ITR5) 01010: Internal Trigger 6 (ITR6) 01011: Internal Trigger 7 (ITR7) 01100: Internal Trigger 8 (ITR8) Others: Reserved See   Table 84: TIM2/TIM3 internal trigger connection on page 494   for more details on ITRx meaning for each Timer.  Note:   These bits must be changed only when they are not used (e.g. when SMS=000) to avoid wrong edge detections at the transition.  Bit 3   OCCS : OCREF clear selection This bit is used to select the OCREF clear source 0: OCREF_CLR_INT is unconnected. 1: OCREF_CLR_INT is connected to ETRF

General-purpose timers (TIM2/TIM3)   RM0490  494/1027   RM0490 Rev 5  18.4.4   TIMx DMA/Interrupt enable register (TIMx_DIER)(x = 2 to 3)  Address offset: 0x0C Reset value: 0x0000 Bits 16, 2, 1, 0   SMS[3:0] : Slave mode selection When external signals are selected the active edge of the trigger signal (TRGI) is linked to the polarity selected on the external input (see Input Control register and Control Register description. 0000: Slave mode disabled - if CEN = ‘1 then the prescaler is clocked directly by the internal clock. 0001: Encoder mode 1 - Counter counts up/down on TI1FP1 edge depending on TI2FP2 level. 0010: Encoder mode 2 - Counter counts up/down on TI2FP2 edge depending on TI1FP1 level. 0011: Encoder mode 3 - Counter counts up/down on both TI1FP1 and TI2FP2 edges depending on the level of the other input. 0100: Reset Mode - Rising edge of the selected trigger input (TRGI) reinitializes the counter and generates an update of the registers. 0101: Gated Mode - The counter clock is enabled when the trigger input (TRGI) is high. The counter stops (but is not reset) as soon as the trigger becomes low. Both start and stop of the counter are controlled. 0110: Trigger Mode - The counter starts at a rising edge of the trigger TRGI (but it is not reset). Only the start of the counter is controlled. 0111: External Clock Mode 1 - Rising edges of the selected trigger (TRGI) clock the counter. 1000: Combined reset + trigger mode - Rising edge of the selected trigger input (TRGI) reinitializes the counter, generates an update of the registers and starts the counter.  Note:   The gated mode must not be used if TI1F_ED is selected as the trigger input (TS=00100). Indeed, TI1F_ED outputs 1 pulse for each transition on TI1F, whereas the gated mode checks the level of the trigger signal. Note:   The clock of the slave peripherals (timer, ADC, ...) receiving the TRGO or the TRGO2 signals must be enabled prior to receive events from the master timer, and the clock frequency (prescaler) must not be changed on-the-fly while triggers are received from the master timer.  Table 84. TIM2/TIM3 internal trigger connection Slave TIM   ITR0   ITR1   ITR2   ITR3  TIM2 (1) 1.   TIM2 is available on the STM32C051xx/71xx/91xx/92xx devices only. TIM1   TIM15   (2) 2.   Applies to STM32C091xx/92xx devices only. TIM3   TIM14_OC1 TIM3   TIM1   TIM2 (1)   TIM15 (2)   TIM14_OC1 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   TDE   Res.   CC4DE   CC3DE   CC2DE   CC1DE   UDE   Res.   TIE   Res.   CC4IE   CC3IE   CC2IE   CC1IE   UIE rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

RM0490 Rev 5   495/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Bit 15   Reserved, must be kept at reset value. Bit 14   TDE : Trigger DMA request enable 0: Trigger DMA request disabled. 1: Trigger DMA request enabled. Bit 13   Reserved, must be kept at reset value. Bit 12   CC4DE : Capture/Compare 4 DMA request enable 0: CC4 DMA request disabled. 1: CC4 DMA request enabled. Bit 11   CC3DE : Capture/Compare 3 DMA request enable 0: CC3 DMA request disabled. 1: CC3 DMA request enabled. Bit 10   CC2DE : Capture/Compare 2 DMA request enable 0: CC2 DMA request disabled. 1: CC2 DMA request enabled. Bit 9   CC1DE : Capture/Compare 1 DMA request enable 0: CC1 DMA request disabled. 1: CC1 DMA request enabled. Bit 8   UDE : Update DMA request enable 0: Update DMA request disabled. 1: Update DMA request enabled. Bit 7   Reserved, must be kept at reset value. Bit 6   TIE : Trigger interrupt enable 0: Trigger interrupt disabled. 1: Trigger interrupt enabled. Bit 5   Reserved, must be kept at reset value. Bit 4   CC4IE : Capture/Compare 4 interrupt enable 0: CC4 interrupt disabled. 1: CC4 interrupt enabled. Bit 3   CC3IE : Capture/Compare 3 interrupt enable 0: CC3 interrupt disabled. 1: CC3 interrupt enabled. Bit 2   CC2IE : Capture/Compare 2 interrupt enable 0: CC2 interrupt disabled. 1: CC2 interrupt enabled. Bit 1   CC1IE : Capture/Compare 1 interrupt enable 0: CC1 interrupt disabled. 1: CC1 interrupt enabled. Bit 0   UIE : Update interrupt enable 0: Update interrupt disabled. 1: Update interrupt enabled.

General-purpose timers (TIM2/TIM3)   RM0490  496/1027   RM0490 Rev 5  18.4.5   TIMx status register (TIMx_SR)(x = 2 to 3)  Address offset: 0x10 Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   CC4OF   CC3OF   CC2OF   CC1OF   Res.   Res.   TIF   Res.   CC4IF   CC3IF   CC2IF   CC1IF   UIF rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0 Bits 15:13   Reserved, must be kept at reset value. Bit 12   CC4OF : Capture/Compare 4 overcapture flag refer to CC1OF description Bit 11   CC3OF : Capture/Compare 3 overcapture flag refer to CC1OF description Bit 10   CC2OF : Capture/compare 2 overcapture flag refer to CC1OF description Bit 9   CC1OF : Capture/Compare 1 overcapture flag This flag is set by hardware only when the corresponding channel is configured in input capture mode. It is cleared by software by writing it to ‘0’. 0: No overcapture has been detected. 1: The counter value has been captured in TIMx_CCR1 register while CC1IF flag was already set Bits 8:7   Reserved, must be kept at reset value. Bit 6   TIF : Trigger interrupt flag This flag is set by hardware on the TRG trigger event (active edge detected on TRGI input when the slave mode controller is enabled in all modes but gated mode. It is set when the counter starts or stops when gated mode is selected. It is cleared by software. 0: No trigger event occurred. 1: Trigger interrupt pending. Bit 5   Reserved, must be kept at reset value. Bit 4   CC4IF : Capture/Compare 4 interrupt flag Refer to CC1IF description Bit 3   CC3IF : Capture/Compare 3 interrupt flag Refer to CC1IF description

RM0490 Rev 5   497/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  18.4.6   TIMx event generation register (TIMx_EGR)(x = 2 to 3)  Address offset: 0x14 Reset value: 0x0000 Bit 2   CC2IF : Capture/Compare 2 interrupt flag Refer to CC1IF description Bit 1   CC1IF : Capture/compare 1 interrupt flag This flag is set by hardware. It is cleared by software (input capture or output compare mode) or by reading the TIMx_CCR1 register (input capture mode only). 0: No compare match / No input capture occurred 1: A compare match or an input capture occurred  If channel CC1 is configured as output : this flag is set when the content of the counter TIMx_CNT matches the content of the TIMx_CCR1 register. When the content of TIMx_CCR1 is greater than the content of TIMx_ARR, the CC1IF bit goes high on the counter overflow (in up-counting and up/down-counting modes) or underflow (in down- counting mode). There are 3 possible options for flag setting in center-aligned mode, refer to the CMS bits in the TIMx_CR1 register for the full description.  If channel CC1 is configured as input : this bit is set when counter value has been captured in TIMx_CCR1 register (an edge has been detected on IC1, as per the edge sensitivity defined with the CC1P and CC1NP bits setting, in TIMx_CCER). Bit 0   UIF : Update interrupt flag This bit is set by hardware on an update event. It is cleared by software. 0: No update occurred 1: Update interrupt pending. This bit is set by hardware when the registers are updated: At overflow or underflow and if UDIS=0 in the TIMx_CR1 register. When CNT is reinitialized by software using the UG bit in TIMx_EGR register, if URS=0 and UDIS=0 in the TIMx_CR1 register. When CNT is reinitialized by a trigger event (refer to the synchro control register description), if URS=0 and UDIS=0 in the TIMx_CR1 register. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TG   Res.   CC4G   CC3G   CC2G   CC1G   UG w   w   w   w   w   w Bits 15:7   Reserved, must be kept at reset value. Bit 6   TG : Trigger generation This bit is set by software in order to generate an event, it is automatically cleared by hardware. 0: No action 1: The TIF flag is set in TIMx_SR register. Related interrupt or DMA transfer can occur if enabled. Bit 5   Reserved, must be kept at reset value. Bit 4   CC4G : Capture/compare 4 generation Refer to CC1G description Bit 3   CC3G : Capture/compare 3 generation Refer to CC1G description

General-purpose timers (TIM2/TIM3)   RM0490  498/1027   RM0490 Rev 5  18.4.7   TIMx capture/compare mode register 1 (TIMx_CCMR1)(x = 2 to 3)  Address offset: 0x18 Reset value: 0x0000 0000 The same register can be used for input capture mode (this section) or for output compare mode (next section). The direction of a channel is defined by configuring the corresponding CCxS bits. All the other bits of this register have a different function in input and in output mode.  Input capture mode:  Bit 2   CC2G : Capture/compare 2 generation Refer to CC1G description Bit 1   CC1G : Capture/compare 1 generation This bit is set by software in order to generate an event, it is automatically cleared by hardware. 0: No action 1: A capture/compare event is generated on channel 1:  If channel CC1 is configured as output : CC1IF flag is set, Corresponding interrupt or DMA request is sent if enabled.  If channel CC1 is configured as input : The current value of the counter is captured in TIMx_CCR1 register. The CC1IF flag is set, the corresponding interrupt or DMA request is sent if enabled. The CC1OF flag is set if the CC1IF flag was already high. Bit 0   UG : Update generation This bit can be set by software, it is automatically cleared by hardware. 0: No action 1: Re-initialize the counter and generates an update of the registers. Note that the prescaler counter is cleared too (anyway the prescaler ratio is not affected). The counter is cleared if the center-aligned mode is selected or if DIR=0 (upcounting), else it takes the auto-reload value (TIMx_ARR) if DIR=1 (downcounting). 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 IC2F[3:0]   IC2PSC[1:0]   CC2S[1:0]   IC1F[3:0]   IC1PSC[1:0]   CC1S[1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:12   IC2F[3:0] : Input capture 2 filter Bits 11:10   IC2PSC[1:0] :   Input capture 2 prescaler

RM0490 Rev 5   499/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Bits 9:8   CC2S[1:0] : Capture/compare 2 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC2 channel is configured as output. 01: CC2 channel is configured as input, IC2 is mapped on TI2. 10: CC2 channel is configured as input, IC2 is mapped on TI1. 11: CC2 channel is configured as input, IC2 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC2S bits are writable only when the channel is OFF (CC2E = 0 in TIMx_CCER).  Bits 7:4   IC1F[3:0] : Input capture 1 filter This bit-field defines the frequency used to sample TI1 input and the length of the digital filter applied to TI1. The digital filter is made of an event counter in which N consecutive events are needed to validate a transition on the output: 0000: No filter, sampling is done at f   DTS 0001: f   SAMPLING   =f CK_INT , N=2 0010: f   SAMPLING   =f CK_INT , N=4 0011: f   SAMPLING =f   CK_INT , N=8 0100: f   SAMPLING   =f DTS /2, N=6 0101: f   SAMPLING   =f DTS /2, N=8 0110: f   SAMPLING =f   DTS /4, N=6 0111: f   SAMPLING =f   DTS /4, N=8 1000: f   SAMPLING   =f DTS /8, N=6 1001: f   SAMPLING   =f DTS /8, N=8 1010: f   SAMPLING   =f DTS /16, N=5 1011: f   SAMPLING =f   DTS /16, N=6 1100: f   SAMPLING =f   DTS /16, N=8 1101: f   SAMPLING =f   DTS /32, N=5 1110: f   SAMPLING =f   DTS /32, N=6 1111: f   SAMPLING =f   DTS /32, N=8 Bits 3:2   IC1PSC[1:0] :   Input capture 1 prescaler This bit-field defines the ratio of the prescaler acting on CC1 input (IC1). The prescaler is reset as soon as CC1E=0 (TIMx_CCER register). 00: no prescaler, capture is done each time an edge is detected on the capture input 01: capture is done once every 2 events 10: capture is done once every 4 events 11: capture is done once every 8 events Bits 1:0   CC1S[1:0] : Capture/Compare 1 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC1 channel is configured as output 01: CC1 channel is configured as input, IC1 is mapped on TI1 10: CC1 channel is configured as input, IC1 is mapped on TI2 11: CC1 channel is configured as input, IC1 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC1S bits are writable only when the channel is OFF (CC1E = 0 in TIMx_CCER).

General-purpose timers (TIM2/TIM3)   RM0490  500/1027   RM0490 Rev 5  18.4.8   TIMx capture/compare mode register 1 [alternate] (TIMx_CCMR1) (x = 2 to 3)  Address offset: 0x18 Reset value: 0x0000 0000 The same register can be used for output compare mode (this section) or for input capture mode (previous section). The direction of a channel is defined by configuring the corresponding CCxS bits. All the other bits of this register have a different function in input and in output mode.  Output compare mode:  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC2M [3]   Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC1M [3] rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 OC2CE   OC2M[2:0]   OC2PE   OC2FE   CC2S[1:0]   OC1CE   OC1M[2:0]   OC1PE   OC1FE   CC1S[1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:25   Reserved, must be kept at reset value. Bits 23:17   Reserved, must be kept at reset value. Bit 15   OC2CE : Output compare 2 clear enable Bits 24, 14:12   OC2M[3:0] : Output compare 2 mode refer to OC1M description on bits 6:4 Bit 11   OC2PE : Output compare 2 preload enable Bit 10   OC2FE : Output compare 2 fast enable Bits 9:8   CC2S[1:0] : Capture/Compare 2 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC2 channel is configured as output 01: CC2 channel is configured as input, IC2 is mapped on TI2 10: CC2 channel is configured as input, IC2 is mapped on TI1 11: CC2 channel is configured as input, IC2 is mapped on TRC. This mode is working only if an internal trigger input is selected through the TS bit (TIMx_SMCR register)  Note:   CC2S bits are writable only when the channel is OFF (CC2E = 0 in TIMx_CCER).  Bit 7   OC1CE : Output compare 1 clear enable 0: OC1Ref is not affected by the ETRF input 1: OC1Ref is cleared as soon as a High level is detected on ETRF input

RM0490 Rev 5   501/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Bits 16, 6:4   OC1M[3:0] : Output compare 1 mode These bits define the behavior of the output reference signal OC1REF from which OC1 and OC1N are derived. OC1REF is active high whereas OC1 and OC1N active level depends on CC1P and CC1NP bits. 0000: Frozen - The comparison between the output compare register TIMx_CCR1 and the counter TIMx_CNT has no effect on the outputs. This mode can be used when the timer serves as a software timebase. When the frozen mode is enabled during timer operation, the output keeps the state (active or inactive) it had before entering the frozen state. 0001: Set channel 1 to active level on match. OC1REF signal is forced high when the counter TIMx_CNT matches the capture/compare register 1 (TIMx_CCR1). 0010: Set channel 1 to inactive level on match. OC1REF signal is forced low when the counter TIMx_CNT matches the capture/compare register 1 (TIMx_CCR1). 0011: Toggle - OC1REF toggles when TIMx_CNT=TIMx_CCR1. 0100: Force inactive level - OC1REF is forced low. 0101: Force active level - OC1REF is forced high. 0110: PWM mode 1 - In upcounting, channel 1 is active as long as TIMx_CNT<TIMx_CCR1 else inactive. In downcounting, channel 1 is inactive (OC1REF=‘0) as long as TIMx_CNT>TIMx_CCR1 else active (OC1REF=1). 0111: PWM mode 2 - In upcounting, channel 1 is inactive as long as TIMx_CNT<TIMx_CCR1 else active. In downcounting, channel 1 is active as long as TIMx_CNT>TIMx_CCR1 else inactive. 1000: Retriggerable OPM mode 1 - In up-counting mode, the channel is active until a trigger event is detected (on TRGI signal). Then, a comparison is performed as in PWM mode 1 and the channels becomes inactive again at the next update. In down-counting mode, the channel is inactive until a trigger event is detected (on TRGI signal). Then, a comparison is performed as in PWM mode 1 and the channels becomes inactive again at the next update. 1001: Retriggerable OPM mode 2 - In up-counting mode, the channel is inactive until a trigger event is detected (on TRGI signal). Then, a comparison is performed as in PWM mode 2 and the channels becomes inactive again at the next update. In down-counting mode, the channel is active until a trigger event is detected (on TRGI signal). Then, a comparison is performed as in PWM mode 1 and the channels becomes active again at the next update. 1010: Reserved, 1011: Reserved, 1100: Combined PWM mode 1 - OC1REF has the same behavior as in PWM mode 1. OC1REFC is the logical OR between OC1REF and OC2REF. 1101: Combined PWM mode 2 - OC1REF has the same behavior as in PWM mode 2. OC1REFC is the logical AND between OC1REF and OC2REF. 1110: Asymmetric PWM mode 1 - OC1REF has the same behavior as in PWM mode 1. OC1REFC outputs OC1REF when the counter is counting up, OC2REF when it is counting down. 1111: Asymmetric PWM mode 2 - OC1REF has the same behavior as in PWM mode 2. OC1REFC outputs OC1REF when the counter is counting up, OC2REF when it is counting down.  Note:   In PWM mode, the OCREF level changes only when the result of the comparison changes or when the output compare mode switches from “frozen” mode to “PWM” mode. Note:   The OC1M[3] bit is not contiguous, located in bit 16.

General-purpose timers (TIM2/TIM3)   RM0490  502/1027   RM0490 Rev 5  18.4.9   TIMx capture/compare mode register 2 (TIMx_CCMR2)(x = 2 to 3)  Address offset: 0x1C Reset value: 0x0000 0000 The same register can be used for input capture mode (this section) or for output compare mode (next section). The direction of a channel is defined by configuring the corresponding CCxS bits. All the other bits of this register have a different function in input and in output mode.  Input capture mode:  Bit 3   OC1PE : Output compare 1 preload enable 0: Preload register on TIMx_CCR1 disabled. TIMx_CCR1 can be written at anytime, the new value is taken in account immediately. 1: Preload register on TIMx_CCR1 enabled. Read/Write operations access the preload register. TIMx_CCR1 preload value is loaded in the active register at each update event. Bit 2   OC1FE : Output compare 1 fast enable This bit decreases the latency between a trigger event and a transition on the timer output. It must be used in one-pulse mode (OPM bit set in TIMx_CR1 register), to have the output pulse starting as soon as possible after the starting trigger. 0: CC1 behaves normally depending on counter and CCR1 values even when the trigger is ON. The minimum delay to activate CC1 output when an edge occurs on the trigger input is 5 clock cycles. 1: An active edge on the trigger input acts like a compare match on CC1 output. Then, OC is set to the compare level independently from the result of the comparison. Delay to sample the trigger input and to activate CC1 output is reduced to 3 clock cycles. OCFE acts only if the channel is configured in PWM1 or PWM2 mode. Bits 1:0   CC1S[1:0] : Capture/Compare 1 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC1 channel is configured as output. 01: CC1 channel is configured as input, IC1 is mapped on TI1. 10: CC1 channel is configured as input, IC1 is mapped on TI2. 11: CC1 channel is configured as input, IC1 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC1S bits are writable only when the channel is OFF (CC1E = 0 in TIMx_CCER).  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 IC4F[3:0]   IC4PSC[1:0]   CC4S[1:0]   IC3F[3:0]   IC3PSC[1:0]   CC3S[1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:12   IC4F[3:0] :   Input capture 4 filter Bits 11:10   IC4PSC[1:0] : Input capture 4 prescaler

RM0490 Rev 5   503/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  18.4.10   TIMx capture/compare mode register 2 [alternate] (TIMx_CCMR2) (x = 2 to 3)  Address offset: 0x1C Reset value: 0x0000 0000 The same register can be used for output compare mode (this section) or for input capture mode (previous section). The direction of a channel is defined by configuring the corresponding CCxS bits. All the other bits of this register have a different function in input and in output mode.  Output compare mode:  Bits 9:8   CC4S[1:0] : Capture/Compare 4 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC4 channel is configured as output 01: CC4 channel is configured as input, IC4 is mapped on TI4 10: CC4 channel is configured as input, IC4 is mapped on TI3 11: CC4 channel is configured as input, IC4 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC4S bits are writable only when the channel is OFF (CC4E = 0 in TIMx_CCER).  Bits 7:4   IC3F[3:0] : Input capture 3 filter Bits 3:2   IC3PSC[1:0] : Input capture 3 prescaler Bits 1:0   CC3S[1:0] : Capture/Compare 3 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC3 channel is configured as output 01: CC3 channel is configured as input, IC3 is mapped on TI3 10: CC3 channel is configured as input, IC3 is mapped on TI4 11: CC3 channel is configured as input, IC3 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC3S bits are writable only when the channel is OFF (CC3E = 0 in TIMx_CCER).  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC4M [3]   Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC3M [3] rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 OC4CE   OC4M[2:0]   OC4PE   OC4FE   CC4S[1:0]   OC3CE   OC3M[2:0]   OC3PE   OC3FE   CC3S[1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:25   Reserved, must be kept at reset value. Bits 23:17   Reserved, must be kept at reset value. Bit 15   OC4CE : Output compare 4 clear enable Bits 24, 14:12   OC4M[3:0] : Output compare 4 mode Refer to OC1M description (bits 6:4 in TIMx_CCMR1 register) Bit 11   OC4PE : Output compare 4 preload enable Bit 10   OC4FE : Output compare 4 fast enable

General-purpose timers (TIM2/TIM3)   RM0490  504/1027   RM0490 Rev 5  18.4.11   TIMx capture/compare enable register (TIMx_CCER)(x = 2 to 3)  Address offset: 0x20 Reset value: 0x0000 Bits 9:8   CC4S[1:0] : Capture/Compare 4 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC4 channel is configured as output 01: CC4 channel is configured as input, IC4 is mapped on TI4 10: CC4 channel is configured as input, IC4 is mapped on TI3 11: CC4 channel is configured as input, IC4 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC4S bits are writable only when the channel is OFF (CC4E = 0 in TIMx_CCER).  Bit 7   OC3CE : Output compare 3 clear enable Bits 16, 6:4   OC3M[3:0] : Output compare 3 mode Refer to OC1M description (bits 6:4 in TIMx_CCMR1 register) Bit 3   OC3PE : Output compare 3 preload enable Bit 2   OC3FE : Output compare 3 fast enable Bits 1:0   CC3S[1:0] : Capture/Compare 3 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC3 channel is configured as output 01: CC3 channel is configured as input, IC3 is mapped on TI3 10: CC3 channel is configured as input, IC3 is mapped on TI4 11: CC3 channel is configured as input, IC3 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC3S bits are writable only when the channel is OFF (CC3E = 0 in TIMx_CCER).  15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CC4NP   Res.   CC4P   CC4E   CC3NP   Res.   CC3P   CC3E   CC2NP   Res.   CC2P   CC2E   CC1NP   Res.   CC1P   CC1E rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 15   CC4NP :   Capture/Compare 4 output Polarity.  Refer to CC1NP description Bit 14   Reserved, must be kept at reset value. Bit 13   CC4P :   Capture/Compare 4 output Polarity.  Refer to CC1P description Bit 12   CC4E :   Capture/Compare 4 output enable.  refer to CC1E description Bit 11   CC3NP :   Capture/Compare 3 output Polarity.  Refer to CC1NP description Bit 10   Reserved, must be kept at reset value. Bit 9   CC3P :   Capture/Compare 3 output Polarity.  Refer to CC1P description Bit 8   CC3E :   Capture/Compare 3 output enable.  Refer to CC1E description

RM0490 Rev 5   505/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Note:   The state of the external IO pins connected to the standard OCx channels depends on the OCx channel state and the GPIO control and alternate function registers.  18.4.12   TIMx counter (TIMx_CNT)(x = 2 to 3)  Bit 31 of this register has two possible definitions depending on the value of UIFREMAP in TIMx_CR1 register:  •   This section is for UIFREMAP = 0  •   Next section is for UIFREMAP = 1 Bit 7   CC2NP :   Capture/Compare 2 output Polarity.  Refer to CC1NP description Bit 6   Reserved, must be kept at reset value. Bit 5   CC2P :   Capture/Compare 2 output Polarity.  refer to CC1P description Bit 4   CC2E :   Capture/Compare 2 output enable.  Refer to CC1E description Bit 3   CC1NP :   Capture/Compare 1 output Polarity.  CC1 channel configured as output : CC1NP must be kept cleared in this case.  CC1 channel configured as input : This bit is used in conjunction with CC1P to define TI1FP1/TI2FP1 polarity. refer to CC1P description. Bit 2   Reserved, must be kept at reset value. Bit 1   CC1P :   Capture/Compare 1 output Polarity.  0: OC1 active high (output mode) / Edge sensitivity selection (input mode, see below) 1: OC1 active low (output mode) / Edge sensitivity selection (input mode, see below)  When CC1 channel is configured as input , both CC1NP/CC1P bits select the active polarity of TI1FP1 and TI2FP1 for trigger or capture operations. CC1NP=0, CC1P=0: non-inverted/rising edge. The circuit is sensitive to TIxFP1 rising edge (capture or trigger operations in reset, external clock or trigger mode), TIxFP1 is not inverted (trigger operation in gated mode or encoder mode). CC1NP=0, CC1P=1: inverted/falling edge. The circuit is sensitive to TIxFP1 falling edge (capture or trigger operations in reset, external clock or trigger mode), TIxFP1 is inverted (trigger operation in gated mode or encoder mode). CC1NP=1, CC1P=1: non-inverted/both edges. The circuit is sensitive to both TIxFP1 rising and falling edges (capture or trigger operations in reset, external clock or trigger mode), TIxFP1is not inverted (trigger operation in gated mode). This configuration must not be used in encoder mode. CC1NP=1, CC1P=0: This configuration is reserved, it must not be used. Bit 0   CC1E :   Capture/Compare 1 output enable.  0: Capture mode disabled / OC1 is not active 1: Capture mode enabled / OC1 signal is output on the corresponding output pin  Table 85. Output control bit for standard OCx channels  CCxE bit   OCx output state 0   Output disabled (not driven by the timer: Hi-Z) 1   Output enabled (tim_ocx = tim_ocxref + Polarity)

General-purpose timers (TIM2/TIM3)   RM0490  506/1027   RM0490 Rev 5  Address offset: 0x24 Reset value: 0x0000 0000  18.4.13   TIMx counter [alternate] (TIMx_CNT)(x = 2 to 3)  Bit 31 of this register has two possible definitions depending on the value of UIFREMAP in TIMx_CR1 register:  •   Previous section is for UIFREMAP = 0  •   This section is for UIFREMAP = 1 Address offset: 0x24 Reset value: 0x0000 0000  18.4.14   TIMx prescaler (TIMx_PSC)(x = 2 to 3)  Address offset: 0x28 Reset value: 0x0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 CNT[31:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CNT[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   CNT[31:16] : Most significant part counter value Bits 15:0   CNT[15:0] : Least significant part of counter value 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 UIFCPY   CNT[30:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CNT[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 31   UIFCPY : UIF Copy This bit is a read-only copy of the UIF bit of the TIMx_ISR register Bits 30:16   CNT[30:16] : Most significant part counter value Bits 15:0   CNT[15:0] : Least significant part of counter value 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 PSC[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

RM0490 Rev 5   507/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  18.4.15   TIMx auto-reload register (TIMx_ARR)(x = 2 to 3)  Address offset: 0x2C Reset value: 0xFFFF FFFF  18.4.16   TIMx capture/compare register 1 (TIMx_CCR1)(x = 2 to 3)  Address offset: 0x34 Reset value: 0x0000 0000 Bits 15:0   PSC[15:0] : Prescaler value The counter clock frequency CK_CNT is equal to f CK_PSC   / (PSC[15:0] + 1). PSC contains the value to be loaded in the active prescaler register at each update event (including when the counter is cleared through UG bit of TIMx_EGR register or through trigger controller when configured in “reset mode”). 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 ARR[31:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ARR[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   ARR[31:16] : High auto-reload value Bits 15:0   ARR[15:0] : Low Auto-reload value ARR is the value to be loaded in the actual auto-reload register. Refer to the   Section 18.3.1: Time-base unit on page 445   for more details about ARR update and behavior. The counter is blocked while the auto-reload value is null. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 CCR1[31:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CCR1[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

General-purpose timers (TIM2/TIM3)   RM0490  508/1027   RM0490 Rev 5  18.4.17   TIMx capture/compare register 2 (TIMx_CCR2)(x = 2 to 3)  Address offset: 0x38 Reset value: 0x0000 0000  18.4.18   TIMx capture/compare register 3 (TIMx_CCR3)(x = 2 to 3)  Address offset: 0x3C Reset value: 0x0000 0000 Bits 31:16   CCR1[31:16] :   High Capture/Compare 1 value Bits 15:0   CCR1[15:0] : Low Capture/Compare 1 value  If channel CC1 is configured as output : CCR1 is the value to be loaded in the actual capture/compare 1 register (preload value). It is loaded permanently if the preload feature is not selected in the TIMx_CCMR1 register (bit OC1PE). Else the preload value is copied in the active capture/compare 1 register when an update event occurs. The active capture/compare register contains the value to be compared to the counter TIMx_CNT and signaled on OC1 output.  If channel CC1is configured as input : CCR1 is the counter value transferred by the last input capture 1 event (IC1). The TIMx_CCR1 register is read-only and cannot be programmed. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 CCR2[31:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CCR2[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   CCR2[31:16] : High Capture/Compare 2 value Bits 15:0   CCR2[15:0] : Low Capture/Compare 2 value  If channel CC2 is configured as output : CCR2 is the value to be loaded in the actual capture/compare 2 register (preload value). It is loaded permanently if the preload feature is not selected in the TIMx_CCMR1 register (bit OC2PE). Else the preload value is copied in the active capture/compare 2 register when an update event occurs. The active capture/compare register contains the value to be compared to the counter TIMx_CNT and signalled on OC2 output.  If channel CC2 is configured as input : CCR2 is the counter value transferred by the last input capture 2 event (IC2). The TIMx_CCR2 register is read-only and cannot be programmed.

RM0490 Rev 5   509/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  18.4.19   TIMx capture/compare register 4 (TIMx_CCR4)(x = 2 to 3)  Address offset: 0x40 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 CCR3[31:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CCR3[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   CCR3[31:16] : High Capture/Compare 3 value Bits 15:0   CCR3[15:0] : Low Capture/Compare value  If channel CC3 is configured as output : CCR3 is the value to be loaded in the actual capture/compare 3 register (preload value). It is loaded permanently if the preload feature is not selected in the TIMx_CCMR2 register (bit OC3PE). Else the preload value is copied in the active capture/compare 3 register when an update event occurs. The active capture/compare register contains the value to be compared to the counter TIMx_CNT and signalled on OC3 output.  If channel CC3is configured as input : CCR3 is the counter value transferred by the last input capture 3 event (IC3). The TIMx_CCR3 register is read-only and cannot be programmed. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 CCR4[31:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CCR4[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   CCR4[31:16] : High Capture/Compare 4 value Bits 15:0   CCR4[15:0] : Low Capture/Compare value 1.   if CC4 channel is configured as output (CC4S bits): CCR4 is the value to be loaded in the actual capture/compare 4 register (preload value). It is loaded permanently if the preload feature is not selected in the TIMx_CCMR2 register (bit OC4PE). Else the preload value is copied in the active capture/compare 4 register when an update event occurs. The active capture/compare register contains the value to be compared to the counter TIMx_CNT and signalled on OC4 output. 2.   if CC4 channel is configured as input (CC4S bits in TIMx_CCMR4 register): CCR4 is the counter value transferred by the last input capture 4 event (IC4). The TIMx_CCR4 register is read-only and cannot be programmed.

General-purpose timers (TIM2/TIM3)   RM0490  510/1027   RM0490 Rev 5  18.4.20   TIMx DMA control register (TIMx_DCR)(x = 2 to 3)  Address offset: 0x48 Reset value: 0x0000  18.4.21   TIMx DMA address for full transfer (TIMx_DMAR)(x = 2 to 3)  Address offset: 0x4C Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   DBL[4:0]   Res.   Res.   Res.   DBA[4:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:13   Reserved, must be kept at reset value. Bits 12:8   DBL[4:0] : DMA burst length This 5-bit vector defines the number of DMA transfers (the timer recognizes a burst transfer when a read or a write access is done to the TIMx_DMAR address). 00000: 1 transfer, 00001: 2 transfers, 00010: 3 transfers, ... 10001: 18 transfers. Bits 7:5   Reserved, must be kept at reset value. Bits 4:0   DBA[4:0] : DMA base address This 5-bit vector defines the base-address for DMA transfers (when read/write access are done through the TIMx_DMAR address). DBA is defined as an offset starting from the address of the TIMx_CR1 register. Example: 00000: TIMx_CR1 00001: TIMx_CR2 00010: TIMx_SMCR ...  Example : Let us consider the following transfer: DBL = 7 transfers & DBA = TIMx_CR1. In this case the transfer is done to/from 7 registers starting from the TIMx_CR1 address. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 DMAB[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   DMAB[15:0] : DMA register for burst accesses A read or write operation to the DMAR register accesses the register located at the address (TIMx_CR1 address) + (DBA + DMA index) x 4 where TIMx_CR1 address is the address of the control register 1, DBA is the DMA base address configured in TIMx_DCR register, DMA index is automatically controlled by the DMA transfer, and ranges from 0 to DBL (DBL configured in TIMx_DCR).

RM0490 Rev 5   511/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  18.4.22   TIM2 alternate function option register 1 (TIM2_AF1)  This register applies to STM32C071xx only. It is reserved otherwise. Address offset: 0x60 Reset value: 0x0000 0000  18.4.23   TIM3 alternate function option register 1 (TIM3_AF1)  Address offset: 0x60 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   ETRSEL[3:2] rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ETRSEL[1:0]   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. rw   rw Bits 31:18   Reserved, must be kept at reset value. Bits 17:14   ETRSEL[3:0] : ETR source selection These bits select the ETR input source. 0000: ETR legacy mode 0011: LSE 0100: MCO 0101: MCO2 Others: Reserved Bits 13:0   Reserved, must be kept at reset value. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   ETRSEL[3:2] rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ETRSEL[1:0]   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. rw   rw Bits 31:18   Reserved, must be kept at reset value. Bits 17:14   ETRSEL[3:0] : ETR source selection These bits select the ETR input source. 0000: ETR legacy mode Others: Reserved Bits 13:0   Reserved, must be kept at reset value.

General-purpose timers (TIM2/TIM3)   RM0490  512/1027   RM0490 Rev 5  18.4.24   TIM2 timer input selection register (TIM2_TISEL)  This register applies to STM32C071xx only. It is reserved otherwise. Address offset: 0x68 Reset value: 0x0000 0000  18.4.25   TIM3 timer input selection register (TIM3_TISEL)  Address offset: 0x68 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TI3SEL[3:0] rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   TI2SEL[3:0]   Res.   Res.   Res.   Res.   TI1SEL[3:0] rw   rw   rw   rw   rw   rw   rw   rw Bits 31:20   Reserved, must be kept at reset value. Bits 19:16   TI3SEL[3:0] : TI3[0] to TI3[15] input selection These bits select the TI3[0] to TI3[15] input source. 0000: TIM2_CH3 input Others: Reserved Bits 15:12   Reserved, must be kept at reset value. Bits 11:8   TI2SEL[3:0] : TI2[0] to TI2[15] input selection These bits select the TI2[0] to TI2[15] input source. 0000: TIM2_CH2 input Others: Reserved Bits 7:4   Reserved, must be kept at reset value. Bits 3:0   TI1SEL[3:0] : TI1[0] to TI1[15] input selection These bits select the TI1[0] to TI1[15] input source. 0000: TIM2_CH1 input Others: Reserved 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TI3SEL[3:0] rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   TI2SEL[3:0]   Res.   Res.   Res.   Res.   TI1SEL[3:0] rw   rw   rw   rw   rw   rw   rw   rw

RM0490 Rev 5   513/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  Bits 31:20   Reserved, must be kept at reset value. Bits 19:16   TI3SEL[3:0] : TI3[0] to TI3[15] input selection These bits select the TI3[0] to TI3[15] input source. 0000: TIM3_CH3 input Others: Reserved Bits 15:12   Reserved, must be kept at reset value. Bits 11:8   TI2SEL[3:0] : TI2[0] to TI2[15] input selection These bits select the TI2[0] to TI2[15] input source. 0000: TIM3_CH2 input Others: Reserved Bits 7:4   Reserved, must be kept at reset value. Bits 3:0   TI1SEL[3:0] : TI1[0] to TI1[15] input selection These bits select the TI1[0] to TI1[15] input source. 0000: TIM3_CH1 input Others: Reserved

General-purpose timers (TIM2/TIM3)   RM0490  514/1027   RM0490 Rev 5  18.4.26   TIMx register map  TIMx registers are mapped as described in the table below:  Table 86. TIM2/TIM3 register map and reset values Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00  TIMx_CR1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. UIFREMA Res.   CKD [1:0] ARPE CMS [1:0] DIR OPM URS UDIS CEN Reset value   0   0   0   0   0   0   0   0   0   0   0 0x04  TIMx_CR2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TI1S MMS[2:0] CCDS Res. Res. Res. Reset value   0   0   0   0   0 0x08  TIMx_SMCR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res.   TS [4:3] Res. Res. Res. SMS[3] ETP ECE   ETPS [1:0]   ETF[3:0] MSM TS[2:0] Res. SMS[2:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x0C  TIMx_DIER  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TDE Res. CC4DE CC3DE CC2DE CC1DE UDE Res. TIE Res. CC4IE CC3IE CC2IE CC1IE UIE Reset value   0   0   0   0   0   0   0   0   0   0   0   0 0x10  TIMx_SR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CC4OF CC3OF CC2OF CC1OF Res. Res. TIF Res. CC4IF CC3IF CC2IF CC1IF UIF Reset value   0   0   0   0   0   0   0   0   0   0 0x14  TIMx_EGR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TG Res. CC4G CC3G CC2G CC1G UG Reset value   0   0   0   0   0   0 0x18  TIMx_CCMR1  Output Compare mode Res. Res. Res. Res. Res. Res. Res. OC2M[3] Res. Res. Res. Res. Res. Res. Res. OC1M[3] OC2CE OC2M [2:0] OC2PE OC2FE CC2S [1:0] OC1CE OC1M [2:0] OC1PE OC1FE CC1S [1:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0  TIMx_CCMR1  Input Capture mode Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. IC2F[3:0] IC2 PSC [1:0] CC2S [1:0]   IC1F[3:0] IC1 PSC [1:0] CC1S [1:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x1C  TIMx_CCMR2  Output Compare mode Res. Res. Res. Res. Res. Res. Res. OC4M[3] Res. Res. Res. Res. Res. Res. Res. OC3M[3] O24CE OC4M [2:0] OC4PE OC4FE CC4S [1:0] OC3CE OC3M [2:0] OC3PE OC3FE CC3S [1:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0  TIMx_CCMR2  Input Capture mode Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. IC4F[3:0] IC4 PSC [1:0] CC4S [1:0]   IC3F[3:0] IC3 PSC [1:0] CC3S [1:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x20  TIMx_CCER  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CC4NP Res. CC4P CC4E CC3NP Res. CC3P CC3E CC2NP Res. CC2P CC2E CC1NP Res. CC1P CC1E Reset value   0   0   0   0   0   0   0   0   0   0   0   0

RM0490 Rev 5   515/1027  RM0490   General-purpose timers (TIM2/TIM3)  516  0x24  TIMx_CNT  CNT[31] or UIFCPY CNT[30:16] ( only, reserved on the other timers)   CNT[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x28  TIMx_PSC  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PSC[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x2C  TIMx_ARR   ARR[31:16] ( only, reserved on the other timers)   ARR[15:0] Reset value   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 0x30   Reserved 0x34  TIMx_CCR1   CCR1[31:16] ( only, reserved on the other timers)   CCR1[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x38  TIMx_CCR2   CCR2[31:16] ( only, reserved on the other timers)   CCR2[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x3C  TIMx_CCR3   CCR3[31:16] ( only, reserved on the other timers)   CCR3[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x40  TIMx_CCR4   CCR4[31:16] ( only, reserved on the other timers)   CCR4[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x44   Reserved 0x48  TIMx_DCR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DBL[4:0] Res. Res. Res. DBA[4:0] Reset value   0   0   0   0   0   0   0   0   0   0 0x4C  TIMx_DMAR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DMAB[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x60  TIM2_AF1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res.   ETRSEL [3:0] Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Reset value   0   0   0   0 0x60  TIM3_AF1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res.   ETRSEL [3:0] Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Reset value   0   0   0   0  Table 86. TIM2/TIM3 register map and reset values (continued) Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

General-purpose timers (TIM2/TIM3)   RM0490  516/1027   RM0490 Rev 5  Refer to   Section 2.2 on page 45   for the register boundary addresses. 0x68  TIM2_TISEL  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TI3SEL[3:0] Res. Res. Res. Res. TI2SEL[3:0] Res. Res. Res. Res. TI1SEL[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0 0x68  TIM3_TISEL  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TI3SEL[3:0] Res. Res. Res. Res. TI2SEL[3:0] Res. Res. Res. Res. TI1SEL[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0  Table 86. TIM2/TIM3 register map and reset values (continued) Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

RM0490 Rev 5   517/1027  RM0490   General-purpose timers (TIM14)  542  19   General-purpose timers (TIM14) 19.1   TIM14 introduction  The TIM14 general-purpose timer consists of a 16-bit auto-reload counter driven by a programmable prescaler. It may be used for a variety of purposes, including measuring the pulse lengths of input signals (input capture) or generating output waveforms (output compare, PWM). Pulse lengths and waveform periods can be modulated from a few microseconds to several milliseconds using the timer prescaler and the RCC clock controller prescalers. The TIM14 timer is completely independent, and does not share any resources.  19.2   TIM14 main features 19.2.1   TIM14 main features  The features of general-purpose timer TIM14 include:  •   16-bit auto-reload upcounter  •   16-bit programmable prescaler used to divide the counter clock frequency by any factor between 1 and 65536 (can be changed “on the fly”)  •   independent channel for: –   Input capture –   Output compare –   PWM generation (edge-aligned mode) –   One-pulse mode output  •   Interrupt generation on the following events: –   Update: counter overflow, counter initialization (by software) –   Input capture –   Output compare

General-purpose timers (TIM14)   RM0490  518/1027   RM0490 Rev 5  Figure 167. General-purpose timer block diagram (TIM14)  1.   This signal can be used as trigger for some slave timers, see   Section 19.3.11: Using timer output as trigger for other timers (TIM14) .  MSv40931V2 Input filter & edge selector PSC prescaler Prescaler Internal clock (CK_INT) Auto-reload register CNT counter +/- TI1FP1   IC1 CK_PSC   CK_CNT IC1PS Stop, clear OC1REF CC1I C1I U UI U OC1   TIMx_CH1 U Notes: Reg   Preload registers transferred to active registers on U event according to control bit Event Interrupt & DMA output Enable counter Trigger Controller Capture/compare 1 register TIMx_CH1 TI1[1..15] TI1[0] Output control To other timers for cross- trigerring   (1)

RM0490 Rev 5   519/1027  RM0490   General-purpose timers (TIM14)  542  19.3   TIM14 functional description 19.3.1   Time-base unit  The main block of the timer is a 16-bit up-counter with its related auto-reload register. The counter clock can be divided by a prescaler. The counter, the auto-reload register and the prescaler register can be written or read by software. This is true even when the counter is running. The time-base unit includes:  •   Counter register (TIMx_CNT)  •   Prescaler register (TIMx_PSC)  •   Auto-reload register (TIMx_ARR) The auto-reload register is preloaded. Writing to or reading from the auto-reload register accesses the preload register. The content of the preload register are transferred into the shadow register permanently or at each update event (UEV), depending on the auto-reload preload enable bit (ARPE) in TIMx_CR1 register. The update event is sent when the counter reaches the overflow and if the UDIS bit equals 0 in the TIMx_CR1 register. It can also be generated by software. The generation of the update event is described in details for each configuration. The counter is clocked by the prescaler output CK_CNT, which is enabled only when the counter enable bit (CEN) in TIMx_CR1 register is set. Note that the counter starts counting 1 clock cycle after setting the CEN bit in the TIMx_CR1 register.  Prescaler description  The prescaler can divide the counter clock frequency by any factor between 1 and 65536. It is based on a 16-bit counter controlled through a 16-bit register (in the TIMx_PSC register). It can be changed on the fly as this control register is buffered. The new prescaler ratio is taken into account at the next update event.  Figure 168   and   Figure 169   give some examples of the counter behavior when the prescaler ratio is changed on the fly.

General-purpose timers (TIM14)   RM0490  520/1027   RM0490 Rev 5  Figure 168. Counter timing diagram with prescaler division change from 1 to 2 Figure 169. Counter timing diagram with prescaler division change from 1 to 4  CK_PSC 00 CEN Timerclock = CK_CNT Counter register Update event (UEV) 0 Prescaler control register   1 0 Write a new value in TIMx_PSC Prescaler buffer   1 0 Prescaler counter   0   1   0   1   0   1   0   1 01   02   03 FA   FB F7   F8   F9   FC MS31076V2  0 3 0 0   1   2   3   0   1   2   3 MS31077V2 CK_PSC CEN Timerclock = CK_CNT Counter register Update event (UEV) Prescaler control register Write a new value in TIMx_PSC Prescaler buffer Prescaler counter 00   01 FA   FB F7   F8   F9   FC 3 0

RM0490 Rev 5   521/1027  RM0490   General-purpose timers (TIM14)  542  19.3.2   Counter modes Upcounting mode  In upcounting mode, the counter counts from 0 to the auto-reload value (content of the TIMx_ARR register), then restarts from 0 and generates a counter overflow event. Setting the UG bit in the TIMx_EGR register (by software) also generates an update event. The UEV event can be disabled by software by setting the UDIS bit in the TIMx_CR1 register. This is to avoid updating the shadow registers while writing new values in the preload registers. Then no update event occurs until the UDIS bit has been written to 0. However, the counter restarts from 0, as well as the counter of the prescaler (but the prescale rate does not change). In addition, if the URS bit (update request selection) in TIMx_CR1 register is set, setting the UG bit generates an update event UEV but without setting the UIF flag (thus no interrupt is sent). This is to avoid generating both update and capture interrupts when clearing the counter on the capture event. When an update event occurs, all the registers are updated and the update flag (UIF bit in TIMx_SR register) is set (depending on the URS bit):  •   The auto-reload shadow register is updated with the preload value (TIMx_ARR),  •   The buffer of the prescaler is reloaded with the preload value (content of the TIMx_PSC register). The following figures show some examples of the counter behavior for different clock frequencies when TIMx_ARR=0x36.  Figure 170. Counter timing diagram, internal clock divided by 1  00   02   03   04   05   06   07 32   33   34   35   36 31 MS31078V2 CK_PSC CNT_EN Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 01

General-purpose timers (TIM14)   RM0490  522/1027   RM0490 Rev 5  Figure 171. Counter timing diagram, internal clock divided by 2 Figure 172. Counter timing diagram, internal clock divided by 4  MS31079V2 CK_PSC CNT_EN Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 0034   0035   0036   0000   0001   0002   0003  0000   0001 0035   0036 MS31080V2 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) CNT_EN

RM0490 Rev 5   523/1027  RM0490   General-purpose timers (TIM14)  542  Figure 173. Counter timing diagram, internal clock divided by N Figure 174. Counter timing diagram, update event when ARPE=0 (TIMx_ARR not preloaded)  00 1F   20 MS31081V2 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF)  FF   36 MS31082V2 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 00   02   03   04   05   06   07 32   33   34   35   36 31   01 CEN Auto-reload preload register Write a new value in TIMx_ARR

General-purpose timers (TIM14)   RM0490  524/1027   RM0490 Rev 5  Figure 175. Counter timing diagram, update event when ARPE=1 (TIMx_ARR preloaded) 19.3.3   Clock selection  The counter clock can be provided by the following clock sources:  •   Internal clock (CK_INT)  Internal clock source (CK_INT)  The internal clock source is the default clock source for TIM14.  Figure 176   shows the behavior of the control circuit and the upcounter in normal mode, without prescaler.  MS31083V2 F5   36 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 00   02   03   04   05   06   07 F1   F2   F3   F4   F5 F0   01 CEN Auto-reload preload register Write a new value in TIMx_ARR Auto-reload shadow register   F5   36

RM0490 Rev 5   525/1027  RM0490   General-purpose timers (TIM14)  542  Figure 176. Control circuit in normal mode, internal clock divided by 1 19.3.4   Capture/compare channels  Each Capture/Compare channel is built around a capture/compare register (including a shadow register), a input stage for capture (with digital filter, multiplexing and prescaler) and an output stage (with comparator and output control).  Figure 177   to   Figure 179   give an overview of one capture/compare channel. The input stage samples the corresponding TIx input to generate a filtered signal TIxF. Then, an edge detector with polarity selection generates a signal (TIxFPx) which can be used as the capture command. It is prescaled before the capture register (ICxPS).  Figure 177. Capture/compare channel (example: channel 1 input stage)  The output stage generates an intermediate waveform which is then used for reference: OCxRef (active high). The polarity acts at the end of the chain.  MSv31085V3 Internal clock Counter clock = CK_CNT = CK_PSC Counter register CEN=CNT_EN UG Counter initialization (internal) 00   02   03   04   05   06   07 3 2   33   34   35   36 31   01  MSv45749V1 0 1 Divider /1, /2, /4, /8 ICPS[1:0] TI1FP1   01 CC1S[1:0] IC1   IC1PS TIMx_CCER CC1P/CC1NP TIMx_CCMR1 TI1F_Rising TI1F_Falling ICF[3:0] TIMx_CCMR1 TIMx_CCER TI1F   Edge detector f CC1E DTS Filter downcounter TIMx_CH1 TI1[1..15] TI1[0]

General-purpose timers (TIM14)   RM0490  526/1027   RM0490 Rev 5  Figure 178. Capture/compare channel 1 main circuit Figure 179. Output stage of capture/compare channel (channel 1)  1.   Available on TIM12 only. The capture/compare block is made of one preload register and one shadow register. Write and read always access the preload register. In capture mode, captures are actually done in the shadow register, which is copied into the preload register. In compare mode, the content of the preload register is copied into the shadow register which is compared to the counter.  19.3.5   Input capture mode  In Input capture mode, the Capture/Compare Registers (TIMx_CCRx) are used to latch the value of the counter after a transition detected by the corresponding ICx signal. When a capture occurs, the corresponding CCXIF flag (TIMx_SR register) is set and an interrupt or a DMA request can be sent if they are enabled. If a capture occurs while the CCxIF flag was already high, then the over-capture flag CCxOF (TIMx_SR register) is set. CCxIF can be  MSv63030V1 CC1E compare shadow register Comparator Capture/compare preload register Counter IC1PS CC1S[0] CC1S[1] Capture Input mode CC1S[0] CC1S[1] Output mode UEV OC1PE (from time base unit) Compare transfer APB Bus 16/32-bit MCU-peripheral interface TIMx_CCMR1 OC1PE CNT>CCR1 CNT=CCR1 TIMx_EGR CC1G  MSv45743V3 Output mode controller CNT > CCR1 CNT = CCR1 Output selector OC2REF   (1) OC1M[3:0] TIMx_CCMR1 OC1REF   OC1REFC To the master mode controller 0 1 ‘0’ CC1E TIM1_CCER 0 1 CC1P TIM1_CCER Output enable circuit CC1E TIM1_CCER OC1

RM0490 Rev 5   527/1027  RM0490   General-purpose timers (TIM14)  542  cleared by software by writing it to ‘0’ or by reading the captured data stored in the TIMx_CCRx register. CCxOF is cleared when it is written with 0. The following example shows how to capture the counter value in TIMx_CCR1 when TI1 input rises. To do this, use the following procedure: 1.   Select the proper TI1[x] source (internal or external) with the TI1SEL[3:0] bits in the TIMx_TISEL register. 2.   Select the active input: TIMx_CCR1 must be linked to the TI1 input, so write the CC1S bits to ‘01’ in the TIMx_CCMR1 register. As soon as CC1S becomes different from ‘00’, the channel is configured in input mode and the TIMx_CCR1 register becomes read- only. 3.   Program the appropriate input filter duration in relation with the signal connected to the timer (by programming the ICxF bits in the TIMx_CCMRx register if the input is one of the TIx inputs). Let’s imagine that, when toggling, the input signal is not stable during at must 5 internal clock cycles. We must program a filter duration longer than these 5 clock cycles. We can validate a transition on TI1 when 8 consecutive samples with the new level have been detected (sampled at f   DTS   frequency). Then write IC1F bits to ‘0011’ in the TIMx_CCMR1 register. 4.   Select the edge of the active transition on the TI1 channel by programming CC1P and CC1NP bits to ‘00’ in the TIMx_CCER register (rising edge in this case). 5.   Program the input prescaler. In our example, we wish the capture to be performed at each valid transition, so the prescaler is disabled (write IC1PS bits to ‘00’ in the TIMx_CCMR1 register). 6.   Enable capture from the counter into the capture register by setting the CC1E bit in the TIMx_CCER register. 7.   If needed, enable the related interrupt request by setting the CC1IE bit in the TIMx_DIER register. When an input capture occurs:  •   The TIMx_CCR1 register gets the value of the counter on the active transition.  •   CC1IF flag is set (interrupt flag). CC1OF is also set if at least two consecutive captures occurred whereas the flag was not cleared.  •   An interrupt is generated depending on the CC1IE bit. In order to handle the overcapture, it is recommended to read the data before the overcapture flag. This is to avoid missing an overcapture which could happen after reading the flag and before reading the data.  Note:   IC interrupt requests can be generated by software by setting the corresponding CCxG bit in the TIMx_EGR register.  19.3.6   Forced output mode  In output mode (CCxS bits = ‘00’ in the TIMx_CCMRx register), each output compare signal (OCxREF and then OCx) can be forced to active or inactive level directly by software, independently of any comparison between the output compare register and the counter. To force an output compare signal (OCXREF/OCx) to its active level, one just needs to write ‘0101’ in the OCxM bits in the corresponding TIMx_CCMRx register. Thus OCXREF is forced high (OCxREF is always active high) and OCx get opposite value to CCxP polarity bit. For example: CCxP=’0’ (OCx active high) => OCx is forced to high level.

General-purpose timers (TIM14)   RM0490  528/1027   RM0490 Rev 5  The OCxREF signal can be forced low by writing the OCxM bits to ‘0100’ in the TIMx_CCMRx register. Anyway, the comparison between the TIMx_CCRx shadow register and the counter is still performed and allows the flag to be set. Interrupt requests can be sent accordingly. This is described in the output compare mode section below.  19.3.7   Output compare mode  This function is used to control an output waveform or indicating when a period of time has elapsed. When a match is found between the capture/compare register and the counter, the output compare function: 1.   Assigns the corresponding output pin to a programmable value defined by the output compare mode (OCxM bits in the TIMx_CCMRx register) and the output polarity (CCxP bit in the TIMx_CCER register). The output pin can keep its level (OCxM=’0000’), be set active (OCxM=’0001’), be set inactive (OCxM=’0010’) or can toggle (OCxM=’0011’) on match. 2.   Sets a flag in the interrupt status register (CCxIF bit in the TIMx_SR register). 3.   Generates an interrupt if the corresponding interrupt mask is set (CCXIE bit in the TIMx_DIER register). The TIMx_CCRx registers can be programmed with or without preload registers using the OCxPE bit in the TIMx_CCMRx register. In output compare mode, the update event UEV has no effect on OCxREF and OCx output. The timing resolution is one count of the counter. Output compare mode can also be used to output a single pulse (in One-pulse mode). Procedure: 1.   Select the counter clock (internal, external, prescaler). 2.   Write the desired data in the TIMx_ARR and TIMx_CCRx registers. 3.   Set the CCxIE bit if an interrupt request is to be generated. 4.   Select the output mode. For example: –   Write OCxM = ‘0011’ to toggle OCx output pin when CNT matches CCRx –   Write OCxPE = ‘0’ to disable preload register –   Write CCxP = ‘0’ to select active high polarity –   Write CCxE = ‘1’ to enable the output 5.   Enable the counter by setting the CEN bit in the TIMx_CR1 register. The TIMx_CCRx register can be updated at any time by software to control the output waveform, provided that the preload register is not enabled (OCxPE=’0’, else TIMx_CCRx shadow register is updated only at the next update event UEV). An example is given in  Figure 180 .

RM0490 Rev 5   529/1027  RM0490   General-purpose timers (TIM14)  542  Figure 180. Output compare mode, toggle on OC1. 19.3.8   PWM mode  Pulse Width Modulation mode allows to generate a signal with a frequency determined by the value of the TIMx_ARR register and a duty cycle determined by the value of the TIMx_CCRx register. The PWM mode can be selected independently on each channel (one PWM per OCx output) by writing ‘0110’ (PWM mode 1) or ‘0111’ (PWM mode 2) in the OCxM bits in the TIMx_CCMRx register. The corresponding preload register must be enabled by setting the OCxPE bit in the TIMx_CCMRx register, and eventually the auto-reload preload register (in upcounting or center-aligned modes) by setting the ARPE bit in the TIMx_CR1 register. As the preload registers are transferred to the shadow registers only when an update event occurs, before starting the counter, all registers must be initialized by setting the UG bit in the TIMx_EGR register. The OCx polarity is software programmable using the CCxP bit in the TIMx_CCER register. It can be programmed as active high or active low. The OCx output is enabled by the CCxE bit in the TIMx_CCER register. Refer to the TIMx_CCERx register description for more details. In PWM mode (1 or 2), TIMx_CNT and TIMx_CCRx are always compared to determine whether TIMx_CNT   ≤   TIMx_CCRx. The timer is able to generate PWM in edge-aligned mode only since the counter is upcounting. In the following example, we consider PWM mode 1. The reference PWM signal OCxREF is high as long as TIMx_CNT < TIMx_CCRx else it becomes low. If the compare value in TIMx_CCRx is greater than the auto-reload value (in TIMx_ARR) then OCxREF is held at ‘1’. If the compare value is 0 then OCxRef is held at ‘0’.   Figure 181   shows some edge- aligned PWM waveforms in an example where TIMx_ARR=8.  MS31092V1 OC1REF= OC1 TIM1_CNT   B200   B201 0039 TIM1_CCR1   003A Write B201h in the CC1R register Match detected on CCR1 Interrupt generated if enabled 003B B201 003A

General-purpose timers (TIM14)   RM0490  530/1027   RM0490 Rev 5  Figure 181. Edge-aligned PWM waveforms (ARR=8) 19.3.9   One-pulse mode  One-pulse mode (OPM) is a particular case of the previous modes. It allows the counter to be started in response to a stimulus and to generate a pulse with a programmable length after a programmable delay. Starting the counter can be controlled using the CEN bit. Generating the waveform can be done in output compare mode or PWM mode. One-pulse mode is selected by setting the OPM bit in the TIMx_CR1 register. This makes the counter stop automatically at the next update event UEV. A pulse can be correctly generated only if the compare value is different from the counter initial value. Before starting (when the timer is waiting for the trigger), the configuration must be as follows: CNT < CCRx = ARR (in particular, 0 < CCRx)  19.3.10   UIF bit remapping  The IUFREMAP bit in the TIMx_CR1 register forces a continuous copy of the Update Interrupt Flag UIF into bit 31 of the timer counter register (TIMxCNT[31]). This allows to atomically read both the counter value and a potential roll-over condition signaled by the UIFCPY flag. In particular cases, it can ease the calculations by avoiding race conditions caused for instance by a processing shared between a background task (counter reading) and an interrupt (Update Interrupt). There is no latency between the assertions of the UIF and UIFCPY flags.  MS31093V1 Counter register ‘1’ 0   1   2   3   4   5   6   7   8   0   1 OCXREF CCxIF OCXREF CCxIF OCXREF CCxIF OCXREF CCxIF CCRx=4 CCRx=8 CCRx>8 CCRx=0 ‘0’

RM0490 Rev 5   531/1027  RM0490   General-purpose timers (TIM14)  542  19.3.11   Using timer output as trigger for other timers (TIM14)  The timers with one channel only do not feature a master mode. However, the OC1 output signal can be used to trigger some other timers (including timers described in other sections of this document). Check the “TIMx internal trigger connection” table of any TIMx_SMCR register on the device to identify which timers can be targeted as slave. The OC1 signal pulse width must be programmed to be at least 2 clock cycles of the destination timer, to make sure the slave timer will detect the trigger. For instance, if the destination's timer CK_INT clock is 4 times slower than the source timer, the OC1 pulse width must be 8 clock cycles.  19.3.12   Debug mode  When the microcontroller enters debug mode (Cortex   ® -M0+ core halted), the TIMx counter either continues to work normally or stops, depending on DBG_TIMx_STOP configuration bit in DBG module. For more details, refer to   Section 30.9.2: Debug support for timers, watchdog, and I2C .

General-purpose timers (TIM14)   RM0490  532/1027   RM0490 Rev 5  19.4   TIM14 registers  The peripheral registers have to be written by half-words (16 bits) or words (32 bits). Read accesses can be done by bytes (8 bits), half-words (16 bits) or words (32 bits).  19.4.1   TIM14 control register 1 (TIM14_CR1)  Address offset: 0x00 Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   UIFRE MAP   Res.   CKD[1:0]   ARPE   Res.   Res.   Res.   OPM   URS   UDIS   CEN rw   rw   rw   rw   rw   rw   rw   rw  Bits 15:12   Reserved, must be kept at reset value. Bit 11   UIFREMAP : UIF status bit remapping 0: No remapping. UIF status bit is not copied to TIMx_CNT register bit 31. 1: Remapping enabled. UIF status bit is copied to TIMx_CNT register bit 31. Bit 10   Reserved, must be kept at reset value. Bits 9:8   CKD[1:0] : Clock division This bit-field indicates the division ratio between the timer clock (CK_INT) frequency and sampling clock used by the digital filters (TIx), 00: t DTS   = t CK_INT  01: t DTS   = 2 × t CK_INT  10: t DTS   = 4 × t CK_INT  11: Reserved Bit 7   ARPE : Auto-reload preload enable 0: TIMx_ARR register is not buffered  1: TIMx_ARR register is buffered Bits 6:4   Reserved, must be kept at reset value. Bit 3   OPM : One-pulse mode 0: Counter is not stopped on the update event  1: Counter stops counting on the next update event (clearing the CEN bit).

RM0490 Rev 5   533/1027  RM0490   General-purpose timers (TIM14)  542  19.4.2   TIM14 Interrupt enable register (TIM14_DIER)  Address offset: 0x0C Reset value: 0x0000  19.4.3   TIM14 status register (TIM14_SR)  Address offset: 0x10 Reset value: 0x0000 Bit 2   URS :   Update request source This bit is set and cleared by software to select the update interrupt (UEV) sources. 0: Any of the following events generate an UEV if enabled: –   Counter overflow –   Setting the UG bit 1: Only counter overflow generates an UEV if enabled. Bit 1   UDIS :   Update disable This bit is set and cleared by software to enable/disable update interrupt (UEV) event generation. 0: UEV enabled. An UEV is generated by one of the following events: –   Counter overflow –   Setting the UG bit. Buffered registers are then loaded with their preload values. 1: UEV disabled. No UEV is generated, shadow registers keep their value (ARR, PSC, CCRx). The counter and the prescaler are reinitialized if the UG bit is set. Bit 0   CEN : Counter enable 0: Counter disabled 1: Counter enabled  Note:   External clock and gated mode can work only if the CEN bit has been previously set by  software. However trigger mode can set the CEN bit automatically by hardware. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CC1IE   UIE rw   rw  Bits 15:2   Reserved, must be kept at reset value. Bit 1   CC1IE : Capture/Compare 1 interrupt enable 0: CC1 interrupt disabled  1: CC1 interrupt enabled Bit 0   UIE : Update interrupt enable 0: Update interrupt disabled  1: Update interrupt enabled 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   CC1OF   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CC1IF   UIF rc_w0   rc_w0   rc_w0

General-purpose timers (TIM14)   RM0490  534/1027   RM0490 Rev 5  19.4.4   TIM14 event generation register (TIM14_EGR)  Address offset: 0x14 Reset value: 0x0000 Bits 15:10   Reserved, must be kept at reset value. Bit 9   CC1OF : Capture/Compare 1 overcapture flag This flag is set by hardware only when the corresponding channel is configured in input capture mode. It is cleared by software by writing it to ‘0’.  0: No overcapture has been detected.  1: The counter value has been captured in TIMx_CCR1 register while CC1IF flag was already set Bits 8:2   Reserved, must be kept at reset value. Bit 1   CC1IF : Capture/compare 1 interrupt flag This flag is set by hardware. It is cleared by software (input capture or output compare mode) or by reading the TIMx_CCR1 register (input capture mode only). 0: No compare match / No input capture occurred 1: A compare match or an input capture occurred.  If channel CC1 is configured as output : this flag is set when the content of the counter TIMx_CNT matches the content of the TIMx_CCR1 register. When the content of TIMx_CCR1 is greater than the content of TIMx_ARR, the CC1IF bit goes high on the counter overflow (in up-counting and up/down-counting modes) or underflow (in down- counting mode). There are 3 possible options for flag setting in center-aligned mode, refer to the CMS bits in the TIMx_CR1 register for the full description.  If channel CC1 is configured as input : this bit is set when counter value has been captured in TIMx_CCR1 register (an edge has been detected on IC1, as per the edge sensitivity defined with the CC1P and CC1NP bits setting, in TIMx_CCER). Bit 0   UIF : Update interrupt flag This bit is set by hardware on an update event. It is cleared by software. 0: No update occurred.  1: Update interrupt pending. This bit is set by hardware when the registers are updated: –   At overflow and if UDIS=’0’ in the TIMx_CR1 register. –   When CNT is reinitialized by software using the UG bit in TIMx_EGR register, if URS=’0’ and UDIS=’0’ in the TIMx_CR1 register. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CC1G   UG w   w

RM0490 Rev 5   535/1027  RM0490   General-purpose timers (TIM14)  542  19.4.5   TIM14 capture/compare mode register 1 (TIM14_CCMR1)  Address offset: 0x18 Reset value: 0x0000 0000 The same register can be used for input capture mode (this section) or for output compare mode (next section). The direction of a channel is defined by configuring the corresponding CCxS bits. All the other bits of this register have a different function in input and in output mode.  Input capture mode:  Bits 15:2   Reserved, must be kept at reset value. Bit 1   CC1G : Capture/compare 1 generation This bit is set by software in order to generate an event, it is automatically cleared by hardware.  0: No action  1: A capture/compare event is generated on channel 1:  If channel CC1 is configured as output:  CC1IF flag is set, Corresponding interrupt or is sent if enabled.  If channel CC1 is configured as input:  The current value of the counter is captured in TIMx_CCR1 register. The CC1IF flag is set, the corresponding interrupt is sent if enabled. The CC1OF flag is set if the CC1IF flag was already high. Bit 0   UG : Update generation This bit can be set by software, it is automatically cleared by hardware.  0: No action  1: Re-initialize the counter and generates an update of the registers. Note that the prescaler counter is cleared too (anyway the prescaler ratio is not affected). The counter is cleared. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   IC1F[3:0]   IC1PSC[1:0]   CC1S[1:0] rw   rw   rw   rw   rw   rw   rw   rw  Bits 31:8   Reserved, must be kept at reset value.

General-purpose timers (TIM14)   RM0490  536/1027   RM0490 Rev 5  19.4.6   TIM14 capture/compare mode register 1 [alternate] (TIM14_CCMR1)  Address offset: 0x18 Reset value: 0x0000 0000 The same register can be used for output compare mode (this section) or for input capture mode (previous section). The direction of a channel is defined by configuring the Bits 7:4   IC1F[3:0] : Input capture 1 filter This bit-field defines the frequency used to sample TI1 input and the length of the digital filter applied to TI1. The digital filter is made of an event counter in which N consecutive events are needed to validate a transition on the output: 0000: No filter, sampling is done at f DTS  0001: f SAMPLING =f CK_INT , N=2  0010: f SAMPLING =f CK_INT , N=4  0011: f   SAMPLING =f CK_INT , N=8  0100: f SAMPLING =f DTS /2, N=6  0101: f SAMPLING =f DTS /2, N=8  0110: f   SAMPLING =f DTS /4, N=6  0111: f SAMPLING =f   DTS /4, N=8  1000: f SAMPLING =f DTS /8, N=6  1001: f SAMPLING =f DTS /8, N=8  1010: f SAMPLING =f DTS /16, N=5  1011: f   SAMPLING =f DTS /16, N=6  1100: f   SAMPLING =f DTS /16, N=8  1101: f   SAMPLING =f DTS /32, N=5  1110: f SAMPLING =f   DTS /32, N=6  1111: f SAMPLING =f   DTS /32, N=8 Bits 3:2   IC1PSC[1:0] :   Input capture 1 prescaler This bit-field defines the ratio of the prescaler acting on CC1 input (IC1).  The prescaler is reset as soon as CC1E=’0’ (TIMx_CCER register).  00: no prescaler, capture is done each time an edge is detected on the capture input  01: capture is done once every 2 events  10: capture is done once every 4 events  11: capture is done once every 8 events Bits 1:0   CC1S[1:0] : Capture/Compare 1 selection This bit-field defines the direction of the channel (input/output) as well as the used input.  00: CC1 channel is configured as output  01: CC1 channel is configured as input, IC1 is mapped on TI1  10: Reserved  11: Reserved  Note:   CC1S bits are writable only when the channel is OFF (CC1E = 0 in TIMx_CCER).

RM0490 Rev 5   537/1027  RM0490   General-purpose timers (TIM14)  542  corresponding CCxS bits. All the other bits of this register have a different function in input and in output mode.  Output compare mode:  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC1M [3] rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC1M[2:0]   OC1PE   OC1FE   CC1S[1:0] rw   rw   rw   rw   rw   rw   rw  Bits 31:17   Reserved, must be kept at reset value. Bits 15:7   Reserved, must be kept at reset value. Bits 16, 6:4   OC1M[3:0] : Output compare 1 mode (refer to bit 16 for OC1M[3]) These bits define the behavior of the output reference signal OC1REF from which OC1 is derived. OC1REF is active high whereas OC1 active level depends on CC1P bit. 0000: Frozen. The comparison between the output compare register TIMx_CCR1 and the counter TIMx_CNT has no effect on the outputs. This mode can be used when the timer serves as a software timebase. When the frozen mode is enabled during timer operation, the output keeps the state (active or inactive) it had before entering the frozen state. 0001: Set channel 1 to active level on match. OC1REF signal is forced high when the counter TIMx_CNT matches the capture/compare register 1 (TIMx_CCR1). 0010: Set channel 1 to inactive level on match. OC1REF signal is forced low when the counter TIMx_CNT matches the capture/compare register 1 (TIMx_CCR1). 0011: Toggle - OC1REF toggles when TIMx_CNT = TIMx_CCR1. 0100: Force inactive level - OC1REF is forced low. 0101: Force active level - OC1REF is forced high. 0110: PWM mode 1 - Channel 1 is active as long as TIMx_CNT < TIMx_CCR1 else inactive. 0111: PWM mode 2 - Channel 1 is inactive as long as TIMx_CNT < TIMx_CCR1 else active Others: Reserved  Note:   In PWM mode 1 or 2, the OCREF level changes when the result of the comparison changes or when the output compare mode switches from frozen to PWM mode. Note:   The OC1M[3] bit is not contiguous, located in bit 16.

General-purpose timers (TIM14)   RM0490  538/1027   RM0490 Rev 5  19.4.7   TIM14 capture/compare enable register (TIM14_CCER)  Address offset: 0x20 Reset value: 0x0000 Bit 3   OC1PE : Output compare 1 preload enable 0: Preload register on TIMx_CCR1 disabled. TIMx_CCR1 can be written at anytime, the new value is taken in account immediately. 1: Preload register on TIMx_CCR1 enabled. Read/Write operations access the preload register. TIMx_CCR1 preload value is loaded in the active register at each update event. Bit 2   OC1FE : Output compare 1 fast enable This bit decreases the latency between a trigger event and a transition on the timer output. It must be used in one-pulse mode (OPM bit set in TIMx_CR1 register), to have the output pulse starting as soon as possible after the starting trigger. 0: CC1 behaves normally depending on counter and CCR1 values even when the trigger is ON. The minimum delay to activate CC1 output when an edge occurs on the trigger input is 5 clock cycles. 1: An active edge on the trigger input acts like a compare match on CC1 output. OC is then set to the compare level independently of the result of the comparison. Delay to sample the trigger input and to activate CC1 output is reduced to 3 clock cycles. OC1FE acts only if the channel is configured in PWM1 or PWM2 mode. Bits 1:0   CC1S[1:0] : Capture/Compare 1 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC1 channel is configured as output. 01: CC1 channel is configured as input, IC1 is mapped on TI1. 10: Reserved. 11: Reserved.  Note:   CC1S bits are writable only when the channel is OFF (CC1E = 0 in TIMx_CCER).  15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CC1NP   Res.   CC1P   CC1E rw   rw   rw  Bits 15:4   Reserved, must be kept at reset value. Bit 3   CC1NP : Capture/Compare 1 complementary output Polarity. CC1 channel configured as output: CC1NP must be kept cleared. CC1 channel configured as input: CC1NP bit is used in conjunction with CC1P to define TI1FP1 polarity (refer to CC1P description).

RM0490 Rev 5   539/1027  RM0490   General-purpose timers (TIM14)  542  Note:   The state of the external I/O pins connected to the standard OCx channels depends on the OCx channel state and the GPIO registers.  19.4.8   TIM14 counter (TIM14_CNT)  Address offset: 0x24 Reset value: 0x0000 0000 Bit 2   Reserved, must be kept at reset value. Bit 1   CC1P : Capture/Compare 1 output Polarity. 0: OC1 active high (output mode) / Edge sensitivity selection (input mode, see below) 1: OC1 active low (output mode) / Edge sensitivity selection (input mode, see below)  When CC1 channel is configured as input , both CC1NP/CC1P bits select the active polarity of TI1FP1 and TI2FP1 for trigger or capture operations. CC1NP=0, CC1P=0: non-inverted/rising edge. The circuit is sensitive to TIxFP1 rising edge (capture or trigger operations in reset, external clock or trigger mode), TIxFP1 is not inverted (trigger operation in gated mode or encoder mode). CC1NP=0, CC1P=1: inverted/falling edge. The circuit is sensitive to TIxFP1 falling edge (capture or trigger operations in reset, external clock or trigger mode), TIxFP1 is inverted (trigger operation in gated mode or encoder mode). CC1NP=1, CC1P=1: non-inverted/both edges/ The circuit is sensitive to both TIxFP1 rising and falling edges (capture or trigger operations in reset, external clock or trigger mode), TIxFP1is not inverted (trigger operation in gated mode). This configuration must not be used in encoder mode. CC1NP=1, CC1P=0:This configuration is reserved, it must not be used. Bit 0   CC1E : Capture/Compare 1 output enable. 0: Capture mode disabled / OC1 is not active 1: Capture mode enabled / OC1 signal is output on the corresponding output pin  Table 87. Output control bit for standard OCx channels  CCxE bit   OCx output state 0   Output disabled (not driven by the timer: Hi-Z) 1   Output enabled (tim_ocx = tim_ocxref + Polarity)  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 UIF CPY   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CNT[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bit 31   UIFCPY : UIF Copy This bit is a read-only copy of the UIF bit in the TIMx_ISR register. Bits 30:16   Reserved, must be kept at reset value. Bits 15:0   CNT[15:0] : Counter value

General-purpose timers (TIM14)   RM0490  540/1027   RM0490 Rev 5  19.4.9   TIM14 prescaler (TIM14_PSC)  Address offset: 0x28 Reset value: 0x0000  19.4.10   TIM14 auto-reload register (TIM14_ARR)  Address offset: 0x2C Reset value: 0xFFFF  19.4.11   TIM14 capture/compare register 1 (TIM14_CCR1)  Address offset: 0x34 Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 PSC[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bits 15:0   PSC[15:0] : Prescaler value The counter clock frequency CK_CNT is equal to f   CK_PSC   / (PSC[15:0] + 1). PSC contains the value to be loaded in the active prescaler register at each update event. (including when the counter is cleared through UG bit of TIMx_EGR register or through trigger controller when configured in “reset mode”). 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ARR[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bits 15:0   ARR[15:0] : Auto-reload value ARR is the value to be loaded in the actual auto-reload register. Refer to   Section 19.3.1: Time-base unit on page 519   for more details about ARR update and behavior. The counter is blocked while the auto-reload value is null. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CCR1[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

RM0490 Rev 5   541/1027  RM0490   General-purpose timers (TIM14)  542  19.4.12   TIM14 timer input selection register (TIM14_TISEL)  Address offset: 0x68 Reset value: 0x0000  19.4.13   TIM14 register map  TIMx registers are mapped as 16-bit addressable registers as described in the tables below: Bits 15:0   CCR1[15:0] : Capture/Compare 1 value  If channel CC1 is configured as output :  CCR1 is the value to be loaded in the actual capture/compare 1 register (preload value). It is loaded permanently if the preload feature is not selected in the TIMx_CCMR1 register (bit OC1PE). Else the preload value is copied in the active capture/compare 1 register when an update event occurs. The active capture/compare register contains the value to be compared to the counter TIMx_CNT and signaled on OC1 output.  If channel CC1is configured as input :  CCR1 is the counter value transferred by the last input capture 1 event (IC1). 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TI1SEL[3:0] rw   rw   rw   rw  Bits 15:4   Reserved, must be kept at reset value. Bits 3:0   TI1SEL[3:0] : selects TI1[0] to TI1[15] input 0000: TIM14_CH1 input 0001: RTC CLK 0010: HSE/32 0011: MCO 0100: MCO2 Others: Reserved  Table 88. TIM14 register map and reset values Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00  TIMx_CR1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. UIFREMA Res.   CKD [1:0] ARPE Res. Res. Res. OPM URS UDIS CEN Reset value   0   0   0   0   0   0   0   0 0x04 to 0x08   Reserved   Res. 0x0C  TIMx_DIER  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CC1IE UIE Reset value   0   0

General-purpose timers (TIM14)   RM0490  542/1027   RM0490 Rev 5  Refer to   Section 2.2 on page 45   for the register boundary addresses. 0x10  TIMx_SR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CC1OF Res. Res. Res. Res. Res. Res. Res. CC1IF UIF Reset value   0   0   0 0x14  TIMx_EGR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CC1G UG Reset value   0   0 0x18  TIMx_CCMR1  Output compare mode Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. OC1M[3] Res. Res. Res. Res. Res. Res. Res. Res. Res.   OC1M [2:0] OC1PE OC1FE CC1S [1:0] Reset value   0   0   0   0   0   0   0   0  TIMx_CCMR1  Input capture mode Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. IC1F[3:0] IC1 PSC [1:0] CC1S [1:0] Reset value   0   0   0   0   0   0   0   0 0x1C   Reserved   Res. 0x20  TIMx_CCER  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CC1NP Res. CC1P CC1E Reset value   0   0   0 0x24  TIMx_CNT  UIFCPY Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CNT[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x28  TIMx_PSC  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PSC[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x2C  TIMx_ARR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. ARR[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x30   Reserved   Res. 0x34  TIMx_CCR1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CCR1[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x38 to 0x64   Reserved   Res. 0x68  TIM14_TISEL  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TI1SEL[3:0] Reset value   0   0   0   0  Table 88. TIM14 register map and reset values (continued) Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

RM0490 Rev 5   543/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20   General-purpose timers (TIM15/TIM16/TIM17)  TIM15 is only available for STM32C091xx/92xx devices.  20.1   TIM15/TIM16/TIM17 introduction  The TIM15/TIM16/TIM17 timers consist of a 16-bit auto-reload counter driven by a programmable prescaler. They may be used for a variety of purposes, including measuring the pulse lengths of input signals (input capture) or generating output waveforms (output compare, PWM, complementary PWM with dead-time insertion). Pulse lengths and waveform periods can be modulated from a few microseconds to several milliseconds using the timer prescaler and the RCC clock controller prescalers. The TIM15/TIM16/TIM17 timers are completely independent, and do not share any resources. TIM15 can be synchronized as described in   Section 20.4.23: Timer synchronization (TIM15) .  20.2   TIM15 main features  TIM15 includes the following features:  •   16-bit auto-reload upcounter  •   16-bit programmable prescaler used to divide (also “on the fly”) the counter clock frequency by any factor between 1 and 65535  •   Up to 2 independent channels for: –   Input capture –   Output compare –   PWM generation (edge mode) –   One-pulse mode output  •   Complementary outputs with programmable dead-time (for channel 1 only)  •   Synchronization circuit to control the timer with external signals and to interconnect several timers together  •   Repetition counter to update the timer registers only after a given number of cycles of the counter  •   Break input to put the timer’s output signals in the reset state or a known state  •   Interrupt/DMA generation on the following events: –   Update: counter overflow, counter initialization (by software or internal/external trigger) –   Trigger event (counter start, stop, initialization or count by internal/external trigger) –   Input capture –   Output compare –   Break input (interrupt request)

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  544/1027   RM0490 Rev 5  20.3   TIM16/TIM17 main features  The TIM16/TIM17 timers include the following features:  •   16-bit auto-reload upcounter  •   16-bit programmable prescaler used to divide (also “on the fly”) the counter clock frequency by any factor between 1 and 65535  •   One channel for: –   Input capture –   Output compare –   PWM generation (edge-aligned mode) –   One-pulse mode output  •   Complementary outputs with programmable dead-time  •   Repetition counter to update the timer registers only after a given number of cycles of the counter  •   Break input to put the timer’s output signals in the reset state or a known state  •   Interrupt/DMA generation on the following events: –   Update: counter overflow –   Input capture –   Output compare –   Break input

RM0490 Rev 5   545/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Figure 182. TIM15 block diagram  1.   The internal break event source can be: - A clock failure event generated by CSS. For further information on the CSS, refer to   Section 6.2.7: Clock security system (CSS)  - A PVD output - SRAM parity error signal - Cortex ®   -M0+ LOCKUP (Hardfault) output - COMP output  MSv40934V5 U U U CC1I CC2I Trigger controller +/- Stop, clear or up/down TI1FP1 TI2FP2 ITR0 ITR1 ITR2   TRGI Output control DTG TRGO OC1REF OC2REF REP register U Repetition counter UI Reset, enable, count CK_PSC IC1 IC2   IC2PS IC1PS TI1FP1 TRG TRC TRC ITR TRC TI1F_ED CC1I CC2I TI1FP2 TI2FP1 TI2FP2 TI1 TI2 TIMx_CH1 TIMx_CH2 OC1 OC2 TIMx_CH1 TIMx_CH2 TIMx_CH1N OC1N to other timers Slave controller mode PSC prescaler   CNT counter Internal clock (CK_INT) from RCC CK_CNT ITR3 DTG registers Capture/Compare 1 register Notes: Reg   Preload registers transferred to active registers on U event according to control bit Event Interrupt & DMA output TIMx_BKIN Internal sources   SBIF Auto-reload register Capture/Compare 2 register Prescaler Prescaler XOR Output control Input filter & edge detector Break circuitry   (1) BIF   BRK request TI1[1..15] TI1[0] Input filter & edge detector TI2[1..15] TI2[0] (1)

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  546/1027   RM0490 Rev 5  Figure 183. TIM16/TIM17 block diagram  1.   This signal can be used as trigger for some slave timer, see   Section 20.4.24: Using timer output as trigger for other timers (TIM16/TIM17) . 2.   The internal break event source can be: - A clock failure event generated by CSS. For further information on the CSS, refer to   Section 6.2.7: Clock security system (CSS)  - SRAM parity error signal - Cortex ®   -M0+ LOCKUP (Hardfault) output  MSv40937V2 Internal clock (CK_INT) Counter Enable (CEN) TIMx_CH1 TIMx_BKIN Auto-reload register CNT counter +/- Capture/compare 1 register TI1FP1   IC1 REP register Repetition counter DTG registers DTG   Output control CK_PSC   CK_CNT IC1PS Stop, clear or up/down OC1REF CC1I C1I U UI U OC1 OC1N TIMx_CH1 TIMx_CH1N Input filter & edge detector U Notes: Reg   Preload registers transferred to active registers on U event according to control bit Event Interrupt & DMA output PSC prescaler Prescaler Internal sources   SBIF Break circuitry   (2) BIF   BRK request TI1[1..15] TI1[0] To other timers for cross- trigerring   (1)

RM0490 Rev 5   547/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.4   TIM15/TIM16/TIM17 functional description 20.4.1   Time-base unit  The main block of the programmable advanced-control timer is a 16-bit upcounter with its related auto-reload register. The counter clock can be divided by a prescaler. The counter, the auto-reload register and the prescaler register can be written or read by software. This is true even when the counter is running. The time-base unit includes:  •   Counter register (TIMx_CNT)  •   Prescaler register (TIMx_PSC)  •   Auto-reload register (TIMx_ARR)  •   Repetition counter register (TIMx_RCR) The auto-reload register is preloaded. Writing to or reading from the auto-reload register accesses the preload register. The content of the preload register are transferred into the shadow register permanently or at each update event (UEV), depending on the auto-reload preload enable bit (ARPE) in TIMx_CR1 register. The update event is sent when the counter reaches the overflow and if the UDIS bit equals 0 in the TIMx_CR1 register. It can also be generated by software. The generation of the update event is described in detailed for each configuration. The counter is clocked by the prescaler output CK_CNT, which is enabled only when the counter enable bit (CEN) in TIMx_CR1 register is set (refer also to the slave mode controller description to get more details on counter enabling). Note that the counter starts counting 1 clock cycle after setting the CEN bit in the TIMx_CR1 register.  Prescaler description  The prescaler can divide the counter clock frequency by any factor between 1 and 65536. It is based on a 16-bit counter controlled through a 16-bit register (in the TIMx_PSC register). It can be changed on the fly as this control register is buffered. The new prescaler ratio is taken into account at the next update event.  Figure 184   and   Figure 185   give some examples of the counter behavior when the prescaler ratio is changed on the fly:

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  548/1027   RM0490 Rev 5  Figure 184. Counter timing diagram with prescaler division change from 1 to 2 Figure 185. Counter timing diagram with prescaler division change from 1 to 4  CK_PSC 00 CEN Timerclock = CK_CNT Counter register Update event (UEV) 0 Prescaler control register   1 0 Write a new value in TIMx_PSC Prescaler buffer   1 0 Prescaler counter   0   1   0   1   0   1   0   1 01   02   03 FA   FB F7   F8   F9   FC MS31076V2  0 3 0 0   1   2   3   0   1   2   3 MS31077V2 CK_PSC CEN Timerclock = CK_CNT Counter register Update event (UEV) Prescaler control register Write a new value in TIMx_PSC Prescaler buffer Prescaler counter 00   01 FA   FB F7   F8   F9   FC 3 0

RM0490 Rev 5   549/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.4.2   Counter modes Upcounting mode  In upcounting mode, the counter counts from 0 to the auto-reload value (content of the TIMx_ARR register), then restarts from 0 and generates a counter overflow event. If the repetition counter is used, the update event (UEV) is generated after upcounting is repeated for the number of times programmed in the repetition counter register (TIMx_RCR). Else the update event is generated at each counter overflow. Setting the UG bit in the TIMx_EGR register (by software or by using the slave mode controller) also generates an update event. The UEV event can be disabled by software by setting the UDIS bit in the TIMx_CR1 register. This is to avoid updating the shadow registers while writing new values in the preload registers. Then no update event occurs until the UDIS bit has been written to 0. However, the counter restarts from 0, as well as the counter of the prescaler (but the prescale rate does not change). In addition, if the URS bit (update request selection) in TIMx_CR1 register is set, setting the UG bit generates an update event UEV but without setting the UIF flag (thus no interrupt or DMA request is sent). This is to avoid generating both update and capture interrupts when clearing the counter on the capture event. When an update event occurs, all the registers are updated and the update flag (UIF bit in TIMx_SR register) is set (depending on the URS bit):  •   The repetition counter is reloaded with the content of TIMx_RCR register,  •   The auto-reload shadow register is updated with the preload value (TIMx_ARR),  •   The buffer of the prescaler is reloaded with the preload value (content of the TIMx_PSC register). The following figures show some examples of the counter behavior for different clock frequencies when TIMx_ARR=0x36.

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  550/1027   RM0490 Rev 5  Figure 186. Counter timing diagram, internal clock divided by 1 Figure 187. Counter timing diagram, internal clock divided by 2  00   02   03   04   05   06   07 32   33   34   35   36 31 MS31078V2 CK_PSC CNT_EN Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 01  MS31079V2 CK_PSC CNT_EN Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 0034   0035   0036   0000   0001   0002   0003

RM0490 Rev 5   551/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Figure 188. Counter timing diagram, internal clock divided by 4 Figure 189. Counter timing diagram, internal clock divided by N  0000   0001 0035   0036 MS31080V2 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) CNT_EN  00 1F   20 MS31081V2 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF)

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  552/1027   RM0490 Rev 5  Figure 190. Counter timing diagram, update event when ARPE=0 (TIMx_ARR not preloaded) Figure 191. Counter timing diagram, update event when ARPE=1 (TIMx_ARR preloaded)  FF   36 MS31082V2 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 00   02   03   04   05   06   07 32   33   34   35   36 31   01 CEN Auto-reload preload register Write a new value in TIMx_ARR  MS31083V2 F5   36 CK_PSC Timerclock = CK_CNT Counter register Update event (UEV) Counter overflow Update interrupt flag (UIF) 00   02   03   04   05   06   07 F1   F2   F3   F4   F5 F0   01 CEN Auto-reload preload register Write a new value in TIMx_ARR Auto-reload shadow register   F5   36

RM0490 Rev 5   553/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.4.3   Repetition counter  Section 20.4.1: Time-base unit   describes how the update event (UEV) is generated with respect to the counter overflows. It is actually generated only when the repetition counter has reached zero. This can be useful when generating PWM signals. This means that data are transferred from the preload registers to the shadow registers (TIMx_ARR auto-reload register, TIMx_PSC prescaler register, but also TIMx_CCRx capture/compare registers in compare mode) every N counter overflows, where N is the value in the TIMx_RCR repetition counter register. The repetition counter is decremented at each counter overflow. The repetition counter is an auto-reload type; the repetition rate is maintained as defined by the TIMx_RCR register value (refer to   Figure 192 ). When the update event is generated by software (by setting the UG bit in TIMx_EGR register) or by hardware through the slave mode controller, it occurs immediately whatever the value of the repetition counter is and the repetition counter is reloaded with the content of the TIMx_RCR register.

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  554/1027   RM0490 Rev 5  Figure 192. Update rate examples depending on mode and TIMx_RCR register settings 20.4.4   Clock selection  The counter clock can be provided by the following clock sources:  •   Internal clock (CK_INT)  •   External clock mode1: external input pin  •   Internal trigger inputs (ITRx) (only for TIM15): using one timer as the prescaler for another timer, for example, TIM1 can be configured to act as a prescaler for TIM15. Refer to   Using one timer as prescaler for another timer on page 482   for more details.  Internal clock source (CK_INT)  If the slave mode controller is disabled (SMS=000), then the CEN (in the TIMx_CR1 register) and UG bits (in the TIMx_EGR register) are actual control bits and can be changed  Edge-aligned mode UEV   Update Event: preload registers transferred to active registers and update interrupt generated. Counter TIMx_CNT TIMx_RCR = 0   UEV TIMx_RCR = 1   UEV TIMx_RCR = 2   UEV TIMx_RCR = 3   UEV TIMx_RCR = 3 and re-synchronization UEV (by SW) Upcounting MS31084V2

RM0490 Rev 5   555/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  only by software (except UG which remains cleared automatically). As soon as the CEN bit is written to 1, the prescaler is clocked by the internal clock CK_INT.  Figure 193   shows the behavior of the control circuit and the upcounter in normal mode, without prescaler.  Figure 193. Control circuit in normal mode, internal clock divided by 1 External clock source mode 1  This mode is selected when SMS=111 in the TIMx_SMCR register.   The counter can count at each rising or falling edge on a selected input.  Figure 194. TI2 external clock connection example  For example, to configure the upcounter to count in response to a rising edge on the TI2 input, use the following procedure:  MSv31085V3 Internal clock Counter clock = CK_CNT = CK_PSC Counter register CEN=CNT_EN UG Counter initialization (internal) 00   02   03   04   05   06   07 3 2   33   34   35   36 31   01  MSv40935V1 External clock mode 1 Internal clock mode TRGI CK_INT CK_PSC TIMx_SMCR SMS[2:0] ITRx TI1_ED TI1FP1 TI2FP2 TIMx_SMCR 0 1 TIMx_CCER CC2P TI2F_Rising TI2F_Falling 00110 000xx 00100 00101 Edge detector TS[4:0] (internal clock) TI2[1..15] TI2[0] TIMx_CCMR1 ICF[3:0] Filter

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  556/1027   RM0490 Rev 5  1.   Select the proper TI2[x] source (internal or external) with the TI2SEL[3:0] bits in the TIMx_TISEL register. 2.   Configure channel 2 to detect rising edges on the TI2 input by writing CC2S = ‘01’ in the TIMx_CCMR1 register. 3.   Configure the input filter duration by writing the IC2F[3:0] bits in the TIMx_CCMR1 register (if no filter is needed, keep IC2F=0000). 4.   Select rising edge polarity by writing CC2P=0 in the TIMx_CCER register. 5.   Configure the timer in external clock mode 1 by writing SMS=111 in the TIMx_SMCR register. 6.   Select TI2 as the trigger input source by writing TS=00110 in the TIMx_SMCR register. 7.   Enable the counter by writing CEN=1 in the TIMx_CR1 register.  Note:   The capture prescaler is not used for triggering, so it does not need to be configured.  When a rising edge occurs on TI2, the counter counts once and the TIF flag is set. The delay between the rising edge on TI2 and the actual clock of the counter is due to the resynchronization circuit on TI2 input.  Figure 195. Control circuit in external clock mode 1 20.4.5   Capture/compare channels  Each Capture/Compare channel is built around a capture/compare register (including a shadow register), a input stage for capture (with digital filter, multiplexing and prescaler) and an output stage (with comparator and output control).  Figure 196   to   Figure 199   give an overview of one Capture/Compare channel. The input stage samples the corresponding TIx input to generate a filtered signal TIxF. Then, an edge detector with polarity selection generates a signal (TIxFPx) which can be used as trigger input by the slave mode controller or as the capture command. It is prescaled before the capture register (ICxPS).  Counter clock = CK_CNT = CK_PSC Counter register   35   36 34 TI2 CNT_EN TIF Write TIF=0 MS31087V2

RM0490 Rev 5   557/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Figure 196. Capture/compare channel (example: channel 1 input stage)  The output stage generates an intermediate waveform which is then used for reference: OCxRef (active high). The polarity acts at the end of the chain.  Figure 197. Capture/compare channel 1 main circuit  MSv40936V1 0 1 Divider /1, /2, /4, /8 ICPS[1:0] TI1F_ED To the slave mode controller TI1FP1 11 01 CC1S[1:0] IC1 TI2FP1 TRC (from slave mode controller) 10 IC1PS 0 1   TIMx_CCER CC1P TIMx_CCMR1 TI1F_Rising TI1F_Falling ICF[3:0] Edge detector TIMx_CCMR1 TIMx_CCER TI2F_Rising (from channel 2) TI2F_Falling (from channel 2) CC1E f DTS Filter downcounter TI1[1..15] TI1[0]  MSv63030V1 CC1E compare shadow register Comparator Capture/compare preload register Counter IC1PS CC1S[0] CC1S[1] Capture Input mode CC1S[0] CC1S[1] Output mode UEV OC1PE (from time base unit) Compare transfer APB Bus 16/32-bit MCU-peripheral interface TIMx_CCMR1 OC1PE CNT>CCR1 CNT=CCR1 TIMx_EGR CC1G

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  558/1027   RM0490 Rev 5  Figure 198. Output stage of capture/compare channel (channel 1) Figure 199. Output stage of capture/compare channel (channel 2 for TIM15)  The capture/compare block is made of one preload register and one shadow register. Write and read always access the preload register. In capture mode, captures are actually done in the shadow register, which is copied into the preload register. In compare mode, the content of the preload register is copied into the shadow register which is compared to the counter.  20.4.6   Input capture mode  In Input capture mode, the Capture/Compare registers (TIMx_CCRx) are used to latch the value of the counter after a transition detected by the corresponding ICx signal. When a capture occurs, the corresponding CCXIF flag (TIMx_SR register) is set and an interrupt or a DMA request can be sent if they are enabled. If a capture occurs while the CCxIF flag was  MSv65226V1 OC1M[3:0] Output mode controller CNT>CCR1 CNT=CCR1 TIMx_CCMR1 OC1REF Dead-time generator OC1_DT OC1N_DT DTG[7:0] TIMx_BDTR ‘0’ ‘0’ CC1E TIMx_CCER CC1NE 0 1 CC1P TIM1_CCER 0 1 CC1NP TIMx_CCER OC1 Output enable circuit OC1N CC1E TIMx_CCER CC1NE OSSI TIMx_BDTR MOE   OSSR 0x 10 11 11 01 x0 Output selector OC2REF OC1REFC To the master mode controller Output enable circuit OIS1   OIS1N   TIMx_CR2  MSv65242V1 Output mode controller CNT > CCR2 CNT = CCR2 TIMx_CCMR1 0 1 CC2P TIMx_CCER Output enable circuit OC2 CC2E   TIMx_CCER To the master mode controller OC2REF Output selector OC1REF 0 1 CC2E TIMx_CCER OC2REFC OC2M[3:0] ‘0’ OIS2   TIMx_CR2

RM0490 Rev 5   559/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  already high, then the over-capture flag CCxOF (TIMx_SR register) is set. CCxIF can be cleared by software by writing it to ‘0’ or by reading the captured data stored in the TIMx_CCRx register. CCxOF is cleared when it is written with 0. The following example shows how to capture the counter value in TIMx_CCR1 when TI1 input rises. To do this, use the following procedure: 1.   Select the proper TI1x source (internal or external) with the TI1SEL[3:0] bits in the TIMx_TISEL register. 2.   Select the active input: TIMx_CCR1 must be linked to the TI1 input, so write the CC1S bits to 01 in the TIMx_CCMR1 register. As soon as CC1S becomes different from 00, the channel is configured in input and the TIMx_CCR1 register becomes read-only. 3.   Program the appropriate input filter duration in relation with the signal connected to the timer (when the input is one of the TIx (ICxF bits in the TIMx_CCMRx register). Let’s imagine that, when toggling, the input signal is not stable during at least 5 internal clock cycles. We must program a filter duration longer than these 5 clock cycles. We can validate a transition on TI1 when 8 consecutive samples with the new level have been detected (sampled at f   DTS   frequency). Then write IC1F bits to 0011 in the TIMx_CCMR1 register. 4.   Select the edge of the active transition on the TI1 channel by writing CC1P bit to 0 in the TIMx_CCER register (rising edge in this case). 5.   Program the input prescaler. In our example, we wish the capture to be performed at each valid transition, so the prescaler is disabled (write IC1PS bits to ‘00’ in the TIMx_CCMR1 register). 6.   Enable capture from the counter into the capture register by setting the CC1E bit in the TIMx_CCER register. 7.   If needed, enable the related interrupt request by setting the CC1IE bit in the TIMx_DIER register, and/or the DMA request by setting the CC1DE bit in the TIMx_DIER register. When an input capture occurs:  •   The TIMx_CCR1 register gets the value of the counter on the active transition.  •   CC1IF flag is set (interrupt flag). CC1OF is also set if at least two consecutive captures occurred whereas the flag was not cleared.  •   An interrupt is generated depending on the CC1IE bit.  •   A DMA request is generated depending on the CC1DE bit. In order to handle the overcapture, it is recommended to read the data before the overcapture flag. This is to avoid missing an overcapture which could happen after reading the flag and before reading the data.  Note:   IC interrupt and/or DMA requests can be generated by software by setting the corresponding CCxG bit in the TIMx_EGR register.  20.4.7   PWM input mode (only for TIM15)  This mode is a particular case of input capture mode. The procedure is the same except:  •   Two ICx signals are mapped on the same TIx input.  •   These 2 ICx signals are active on edges with opposite polarity.  •   One of the two TIxFP signals is selected as trigger input and the slave mode controller is configured in reset mode.

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  560/1027   RM0490 Rev 5  For example, one can measure the period (in TIMx_CCR1 register) and the duty cycle (in TIMx_CCR2 register) of the PWM applied on TI1 using the following procedure (depending on CK_INT frequency and prescaler value): 1.   Select the proper TI1[x] source (internal or external) with the TI1SEL[3:0] bits in the TIMx_TISEL register. 2.   Select the active input for TIMx_CCR1: write the CC1S bits to 01 in the TIMx_CCMR1 register (TI1 selected). 3.   Select the active polarity for TI1FP1 (used both for capture in TIMx_CCR1 and counter clear): write the CC1P and CC1NP bits to ‘0’ (active on rising edge). 4.   Select the active input for TIMx_CCR2: write the CC2S bits to 10 in the TIMx_CCMR1 register (TI1 selected). 5.   Select the active polarity for TI1FP2 (used for capture in TIMx_CCR2): write the CC2P and CC2NP bits to ‘10’ (active on falling edge). 6.   Select the valid trigger input: write the TS bits to 00101 in the TIMx_SMCR register (TI1FP1 selected). 7.   Configure the slave mode controller in reset mode: write the SMS bits to 100 in the TIMx_SMCR register. 8.   Enable the captures: write the CC1E and CC2E bits to ‘1’ in the TIMx_CCER register.  Figure 200. PWM input mode timing  1.   The PWM input mode can be used only with the TIMx_CH1/TIMx_CH2 signals due to the fact that only TI1FP1 and TI2FP2 are connected to the slave mode controller.  20.4.8   Forced output mode  In output mode (CCxS bits = 00 in the TIMx_CCMRx register), each output compare signal (OCxREF and then OCx/OCxN) can be forced to active or inactive level directly by software, independently of any comparison between the output compare register and the counter. To force an output compare signal (OCXREF/OCx) to its active level, one just needs to write 101 in the OCxM bits in the corresponding TIMx_CCMRx register. Thus OCXREF is forced high (OCxREF is always active high) and OCx get opposite value to CCxP polarity bit. For example: CCxP=0 (OCx active high) => OCx is forced to high level. The OCxREF signal can be forced low by writing the OCxM bits to 100 in the TIMx_CCMRx register.

RM0490 Rev 5   561/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Anyway, the comparison between the TIMx_CCRx shadow register and the counter is still performed and allows the flag to be set. Interrupt and DMA requests can be sent accordingly. This is described in the output compare mode section below.  20.4.9   Output compare mode  This function is used to control an output waveform or indicating when a period of time has elapsed. When a match is found between the capture/compare register and the counter, the output compare function:  •   Assigns the corresponding output pin to a programmable value defined by the output compare mode (OCxM bits in the TIMx_CCMRx register) and the output polarity (CCxP bit in the TIMx_CCER register). The output pin can keep its level (OCXM=000), be set active (OCxM=001), be set inactive (OCxM=010) or can toggle (OCxM=011) on match.  •   Sets a flag in the interrupt status register (CCxIF bit in the TIMx_SR register).  •   Generates an interrupt if the corresponding interrupt mask is set (CCXIE bit in the TIMx_DIER register).  •   Sends a DMA request if the corresponding enable bit is set (CCxDE bit in the TIMx_DIER register, CCDS bit in the TIMx_CR2 register for the DMA request selection). The TIMx_CCRx registers can be programmed with or without preload registers using the OCxPE bit in the TIMx_CCMRx register. In output compare mode, the update event UEV has no effect on OCxREF and OCx output. The timing resolution is one count of the counter. Output compare mode can also be used to output a single pulse (in One-pulse mode).  Procedure  1.   Select the counter clock (internal, external, prescaler). 2.   Write the desired data in the TIMx_ARR and TIMx_CCRx registers. 3.   Set the CCxIE bit if an interrupt request is to be generated. 4.   Select the output mode. For example: –   Write OCxM = 011 to toggle OCx output pin when CNT matches CCRx –   Write OCxPE = 0 to disable preload register –   Write CCxP = 0 to select active high polarity –   Write CCxE = 1 to enable the output 5.   Enable the counter by setting the CEN bit in the TIMx_CR1 register. The TIMx_CCRx register can be updated at any time by software to control the output waveform, provided that the preload register is not enabled (OCxPE=’0’, else TIMx_CCRx shadow register is updated only at the next update event UEV). An example is given in  Figure 201 .

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  562/1027   RM0490 Rev 5  Figure 201. Output compare mode, toggle on OC1 20.4.10   PWM mode  Pulse Width Modulation mode allows a signal to be generated with a frequency determined by the value of the TIMx_ARR register and a duty cycle determined by the value of the TIMx_CCRx register. The PWM mode can be selected independently on each channel (one PWM per OCx output) by writing ‘110’ (PWM mode 1) or ‘111’ (PWM mode 2) in the OCxM bits in the TIMx_CCMRx register. The corresponding preload register must be enabled by setting the OCxPE bit in the TIMx_CCMRx register, and eventually the auto-reload preload register (in upcounting or center-aligned modes) by setting the ARPE bit in the TIMx_CR1 register. As the preload registers are transferred to the shadow registers only when an update event occurs, before starting the counter, all registers must be initialized by setting the UG bit in the TIMx_EGR register. OCx polarity is software programmable using the CCxP bit in the TIMx_CCER register. It can be programmed as active high or active low. OCx output is enabled by a combination of the CCxE, CCxNE, MOE, OSSI and OSSR bits (TIMx_CCER and TIMx_BDTR registers). Refer to the TIMx_CCER register description for more details. In PWM mode (1 or 2), TIMx_CNT and TIMx_CCRx are always compared to determine whether TIMx_CCRx   ≤   TIMx_CNT or TIMx_CNT   ≤   TIMx_CCRx (depending on the direction of the counter). The TIM15/TIM16/TIM17 are capable of upcounting only. Refer to   Upcounting mode on page 549 . In the following example, we consider PWM mode 1. The reference PWM signal OCxREF is high as long as TIMx_CNT < TIMx_CCRx else it becomes low. If the compare value in TIMx_CCRx is greater than the auto-reload value (in TIMx_ARR) then OCxREF is held at  MS31092V1 OC1REF= OC1 TIM1_CNT   B200   B201 0039 TIM1_CCR1   003A Write B201h in the CC1R register Match detected on CCR1 Interrupt generated if enabled 003B B201 003A

RM0490 Rev 5   563/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  ‘1’. If the compare value is 0 then OCxRef is held at ‘0’.   Figure 202   shows some edge- aligned PWM waveforms in an example where TIMx_ARR=8.  Figure 202. Edge-aligned PWM waveforms (ARR=8) 20.4.11   Combined PWM mode (TIM15 only)  Combined PWM mode allows two edge or center-aligned PWM signals to be generated with programmable delay and phase shift between respective pulses. While the frequency is determined by the value of the TIMx_ARR register, the duty cycle and delay are determined by the two TIMx_CCRx registers. The resulting signals, OCxREFC, are made of an OR or AND logical combination of two reference PWMs:  •   OC1REFC (or OC2REFC) is controlled by the TIMx_CCR1 and TIMx_CCR2 registers Combined PWM mode can be selected independently on two channels (one OCx output per pair of CCR registers) by writing ‘1100’ (Combined PWM mode 1) or ‘1101’ (Combined PWM mode 2) in the OCxM bits in the TIMx_CCMRx register. When a given channel is used as a combined PWM channel, its complementary channel must be configured in the opposite PWM mode (for instance, one in Combined PWM mode 1 and the other in Combined PWM mode 2).  Note:   The OCxM[3:0] bit field is split into two parts for compatibility reasons, the most significant bit is not contiguous with the 3 least significant ones. Figure 203   represents an example of signals that can be generated using Asymmetric PWM mode, obtained with the following configuration:  •   Channel 1 is configured in Combined PWM mode 2,  •   Channel 2 is configured in PWM mode 1,  MS31093V1 Counter register ‘1’ 0   1   2   3   4   5   6   7   8   0   1 OCXREF CCxIF OCXREF CCxIF OCXREF CCxIF OCXREF CCxIF CCRx=4 CCRx=8 CCRx>8 CCRx=0 ‘0’

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  564/1027   RM0490 Rev 5  Figure 203. Combined PWM mode on channel 1 and 2 20.4.12   Complementary outputs and dead-time insertion  The TIM15/TIM16/TIM17 general-purpose timers can output one complementary signal and manage the switching-off and switching-on of the outputs. This time is generally known as dead-time and it has to be adjusted depending on the devices that are connected to the outputs and their characteristics (intrinsic delays of level- shifters, delays due to power switches...) The polarity of the outputs (main output OCx or complementary OCxN) can be selected independently for each output. This is done by writing to the CCxP and CCxNP bits in the TIMx_CCER register. The complementary signals OCx and OCxN are activated by a combination of several control bits: the CCxE and CCxNE bits in the TIMx_CCER register and the MOE, OISx, OISxN, OSSI and OSSR bits in the TIMx_BDTR and TIMx_CR2 registers. Refer to  Table 93: Output control bits for complementary OCx and OCxN channels with break feature (TIM16/17) on page 618   for more details. In particular, the dead-time is activated when switching to the idle state (MOE falling down to 0). Dead-time insertion is enabled by setting both CCxE and CCxNE bits, and the MOE bit if the break circuit is present. There is one 10-bit dead-time generator for each channel. From a  MS31094V1 OC1REF OC2REF OC1REF’ OC2REF’ OC1REFC OC1REFC’ OC1REFC = OC1REF AND OC2REF OC1REFC’ = OC1REF’ OR OC2REF’ OC1 OC2 OC1’ OC2’

RM0490 Rev 5   565/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  reference waveform OCxREF, it generates 2 outputs OCx and OCxN. If OCx and OCxN are active high:  •   The OCx output signal is the same as the reference signal except for the rising edge, which is delayed relative to the reference rising edge.  •   The OCxN output signal is the opposite of the reference signal except for the rising edge, which is delayed relative to the reference falling edge. If the delay is greater than the width of the active output (OCx or OCxN) then the corresponding pulse is not generated. The following figures show the relationships between the output signals of the dead-time generator and the reference signal OCxREF. (we suppose CCxP=0, CCxNP=0, MOE=1, CCxE=1 and CCxNE=1 in these examples)  Figure 204. Complementary output with dead-time insertion. Figure 205. Dead-time waveforms with delay greater than the negative pulse.  delay delay OCxREF OCx OCxN MS31095V1  MS31096V1 delay OCxREF OCx OCxN

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  566/1027   RM0490 Rev 5  Figure 206. Dead-time waveforms with delay greater than the positive pulse.  The dead-time delay is the same for each of the channels and is programmable with the DTG bits in the TIMx_BDTR register. Refer to   Section 20.6.14: TIMx break and dead-time register (TIMx_BDTR)(x = 16 to 17) on page 621   for delay calculation.  Re-directing OCxREF to OCx or OCxN  In output mode (forced, output compare or PWM), OCxREF can be re-directed to the OCx output or to OCxN output by configuring the CCxE and CCxNE bits in the TIMx_CCER register. This allows a specific waveform to be sent (such as PWM or static active level) on one output while the complementary remains at its inactive level. Other alternative possibilities are to have both outputs at inactive level or both outputs active and complementary with dead-time.  Note:   When only OCxN is enabled (CCxE=0, CCxNE=1), it is not complemented and becomes active as soon as OCxREF is high. For example, if CCxNP=0 then OCxN=OCxRef. On the other hand, when both OCx and OCxN are enabled (CCxE=CCxNE=1) OCx becomes active when OCxREF is high whereas OCxN is complemented and becomes active when OCxREF is low.  20.4.13   Using the break function  The purpose of the break function is to protect power switches driven by PWM signals generated with the TIM15/TIM16/TIM17 timers. The break input is usually connected to fault outputs of power stages and 3-phase inverters. When activated, the break circuitry shuts down the PWM outputs and forces them to a predefined safe state. The break channel gathers both system-level fault (clock failure, parity error,...) and application fault from input pins. The break circuitry can force the outputs to a predefined level (either active or inactive) after a deadtime duration.  MS31097V1 delay OCxREF OCx OCxN

RM0490 Rev 5   567/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  The output enable signal and output levels during break are depending on several control bits:  •   the MOE bit in TIMx_BDTR register allows to enable /disable the outputs by software and is reset in case of break event.  •   the OSSI bit in the TIMx_BDTR register defines whether the timer controls the output in inactive state or releases the control to the GPIO controller (typically to have it in Hi-Z mode)  •   the OISx and OISxN bits in the TIMx_CR2 register which are setting the output shut- down level, either active or inactive. The OCx and OCxN outputs cannot be set both to active level at a given time, whatever the OISx and OISxN values. Refer to   Table 93: Output control bits for complementary OCx and OCxN channels with break feature (TIM16/17) on page 618   for more details. When exiting from reset, the break circuit is disabled and the MOE bit is low. The break function is enabled by setting the BKE bit in the TIMx_BDTR register. The break input polarity can be selected by configuring the BKP bit in the same register. BKE and BKP can be modified at the same time. When the BKE and BKP bits are written, a delay of 1 APB clock cycle is applied before the writing is effective. Consequently, it is necessary to wait 1 APB clock period to correctly read back the bit after the write operation. Because MOE falling edge can be asynchronous, a resynchronization circuit has been inserted between the actual signal (acting on the outputs) and the synchronous control bit (accessed in the TIMx_BDTR register). It results in some delays between the asynchronous and the synchronous signals. In particular, if MOE is set to 1 whereas it was low, a delay must be inserted (dummy instruction) before reading it correctly. This is because the write acts on the asynchronous signal whereas the read reflects the synchronous signal. A programmable filter (BKF[3:0] bits in the TIMx_BDTR register allows to filter out spurious events. The break can be generated from multiple sources which can be individually enabled and with programmable edge sensitivity, using the TIMx_AF1 register. The sources for break (BRK) channel are:  •   An external source connected to one of the BKIN pin (as per selection done in the GPIO alternate function registers), with polarity selection and optional digital filtering  •   An internal source: –   A system break: - the Cortex ® -M0+ LOCKUP output - the SRAM parity error signal - a clock failure event generated by the CSS detector

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  568/1027   RM0490 Rev 5  Figure 207. Break circuitry overview Caution:   An asynchronous (clockless) operation is only guaranteed when the programmable filter is disabled. If it is enabled, a fail safe clock mode (example, using the CSS) must be used to guarantee that break events are handled. When a break occurs (selected level on the break input):  •   The MOE bit is cleared asynchronously, putting the outputs in inactive state, idle state or even releasing the control to the GPIO (selected by the OSSI bit). This feature functions even if the MCU oscillator is off.  •   Each output channel is driven with the level programmed in the OISx bit in the TIMx_CR2 register as soon as MOE=0. If OSSI=0, the timer releases the output control (taken over by the GPIO) else the enable output remains high.  •   When complementary outputs are used: –   The outputs are first put in reset state inactive state (depending on the polarity). This is done asynchronously so that it works even if no clock is provided to the timer. –   If the timer clock is still present, then the dead-time generator is reactivated in order to drive the outputs with the level programmed in the OISx and OISxN bits after a dead-time. Even in this case, OCx and OCxN cannot be driven to their active level together. Note that because of the resynchronization on MOE, the dead-time duration is a bit longer than usual (around 2 ck_tim clock cycles). –   If OSSI=0 then the timer releases the enable outputs (taken over by the GPIO which forces a Hi-Z state) else the enable outputs remain or become high as soon as one of the CCxE or CCxNE bits is high.  •   The break status flag (BIF bit in the TIMx_SR register) is set. An interrupt can be generated if the BIE bit in the TIMx_DIER register is set.  •   If the AOE bit in the TIMx_BDTR register is set, the MOE bit is automatically set again at the next update event UEV. This can be used to perform a regulation, for instance.  MSv67590V1 BKCMP1P BKIN inputs from AF controller BKINE BKINP   BKF[3:0] Filter BKP Application break requests Parity LOCK Lockup LOCK RAM parity Error Core Lockup CSS SBIF flag System break requests Software break requests: BG BKE BRK request BIF flag

RM0490 Rev 5   569/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Else, MOE remains low until it is written with 1 again. In this case, it can be used for security and the break input can be connected to an alarm from power drivers, thermal sensors or any security components.  Note:   If the MOE is reset by the CPU while the AOE bit is set, the outputs are in idle state and forced to inactive level or Hi-Z depending on OSSI value. If both the MOE and AOE bits are reset by the CPU, the outputs are in disabled state and driven with the level programmed in the OISx bit in the TIMx_CR2 register. Note:   The break inputs is acting on level. Thus, the MOE cannot be set while the break input is active (neither automatically nor by software). In the meantime, the status flag BIF cannot be cleared.  The break can be generated by the BRK input which has a programmable polarity and an enable bit BKE in the TIMx_BDTR register. In addition to the break input and the output management, a write protection has been implemented inside the break circuit to safeguard the application. It allows the configuration of several parameters to be freezed (dead-time duration, OCx/OCxN polarities and state when disabled, OCxM configurations, break enable and polarity). The protection can be selected among 3 levels with the LOCK bits in the TIMx_BDTR register. Refer to  Section 20.6.14: TIMx break and dead-time register (TIMx_BDTR)(x = 16 to 17) on page 621 . The LOCK bits can be written only once after an MCU reset. The   Figure 208   shows an example of behavior of the outputs in response to a break.

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  570/1027   RM0490 Rev 5  Figure 208. Output behavior in response to a break  delay   delay   delay delay   delay   delay delay delay OCxREF OCx (OCxN not implemented, CCxP=0, OISx=1) OCx (OCxN not implemented, CCxP=0, OISx=0) OCx (OCxN not implemented, CCxP=1, OISx=1) OCx (OCxN not implemented, CCxP=1, OISx=0) OCx OCxN (CCxE=1, CCxP=0, OISx=0, CCxNE=1, CCxNP=0, OISxN=1) OCx OCxN (CCxE=1, CCxP=0, OISx=1, CCxNE=1, CCxNP=1, OISxN=1) OCx OCxN (CCxE=1, CCxP=0, OISx=0, CCxNE=0, CCxNP=0, OISxN=1) OCx OCxN (CCxE=1, CCxP=0, OISx=1, CCxNE=0, CCxNP=0, OISxN=0) OCx OCxN (CCxE=1, CCxP=0, CCxNE=0, CCxNP=0, OISx=OISxN=0 or OISx=OISxN=1) MS31098V1 BREAK (MOE   )

RM0490 Rev 5   571/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.4.14   Bidirectional break inputs  The TIM15/TIM16/TIM17 are featuring bidirectional break I/Os, as represented on  Figure 209 . They allow the following:  •   A board-level global break signal available for signaling faults to external MCUs or gate drivers, with a unique pin being both an input and an output status pin  •   Internal break sources and multiple external open drain comparator outputs ORed together to trigger a unique break event, when multiple internal and external break sources must be merged The break input is configured in bidirectional mode using the BKBID bit in the TIMxBDTR register. The BKBID programming bit can be locked in read-only mode using the LOCK bits in the TIMxBDTR register (in LOCK level 1 or above). The bidirectional mode requires the I/O to be configured in open-drain mode with active low polarity (using BKINP and BKP bits). Any break request coming either from system (e.g. CSS), from on-chip peripherals or from break inputs forces a low level on the break input to signal the fault event. The bidirectional mode is inhibited if the polarity bits are not correctly set (active high polarity), for safety purposes. The break software event (BG) also causes the break I/O to be forced to '0' to indicate to the external components that the timer has entered in break state. However, this is valid only if the break is enabled (BKE = 1). When a software break event is generated with BKE = 0, the outputs are put in safe state and the break flag is set, but there is no effect on the break I/O. A safe disarming mechanism prevents the system to be definitively locked-up (a low level on the break input triggers a break which enforces a low level on the same input). When the BKDSRM bit is set to 1, this releases the break output to clear a fault signal and to give the possibility to re-arm the system. At no point the break protection circuitry can be disabled:  •   The break input path is always active: a break event is active even if the BKDSRM bit is set and the open drain control is released. This prevents the PWM output to be re- started as long as the break condition is present.  •   The BKDSRM bit cannot disarm the break protection as long as the outputs are enabled (MOE bit is set) (see   Table 89 )  Arming and re-arming break circuitry  The break circuitry (in input or bidirectional mode) is armed by default (peripheral reset configuration).  Table 89. Break protection disarming conditions MOE   BKDIR   BKDSRM   Break protection state  0   0   X   Armed 0   1   0   Armed 0   1   1   Disarmed 1   X   X   Armed

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  572/1027   RM0490 Rev 5  The following procedure must be followed to re-arm the protection after a break event:  •   The BKDSRM bit must be set to release the output control  •   The software must wait until the system break condition disappears (if any) and clear the SBIF status flag (or clear it systematically before re-arming)  •   The software must poll the BKDSRM bit until it is cleared by hardware (when the application break condition disappears) From this point, the break circuitry is armed and active, and the MOE bit can be set to re- enable the PWM outputs.  Figure 209. Output redirection 20.4.15   6-step PWM generation  When complementary outputs are used on a channel, preload bits are available on the OCxM, CCxE and CCxNE bits. The preload bits are transferred to the shadow bits at the COM commutation event. Thus one can program in advance the configuration for the next step and change the configuration of all the channels at the same time. COM can be generated by software by setting the COM bit in the TIMx_EGR register or by hardware (on tim_trgi rising edge). A flag is set when the COM event occurs (COMIF bit in the TIMx_SR register), which can generate an interrupt (if the COMIE bit is set in the TIMx_DIER register) or a DMA request (if the COMDE bit is set in the TIMx_DIER register). The   Figure 210   describes the behavior of the tim_ocx and tim_ocxn outputs when a COM event occurs, in 3 different examples of programmed configurations.  MSv42028V2 BKIN inputs from AF controller BKF[3:0] Filter BKP BKE BRK request BIF flag SBIF flag System break request Peripheral break sources AF controller mode control logic MOE   BKBID   BKBDSRM BRK request System break request Bidirectional Break I/O Other break inputs Application break requests Vss Bidirectional AF input (active low) AF output (open drain) Software break requests: BG

RM0490 Rev 5   573/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Figure 210. 6-step generation, COM example (OSSR=1)  MSv62343V1 Example 1 Example 2 Example 3 tim_ocx tim_ocxn tim_ocx tim_ocxn tim_ocx tim_ocxn Counter (CNT) tim_ocxref COM event Write COM to 1 CCxE = 1 CCxNE = 0 OCxM = 0010 (forced inactive) Write OCxM to 0100   CCxE = 1 CCxNE = 0 OCxM = 0100 CCxE = 1 CCxNE = 0 OCxM = 0100 (forced inactive) Write CCxNE to 1 and OCxM to 0101   CCxE = 0 CCxNE = 1 OCxM = 0101 CCxE = 1 CCxNE = 0 OCxM = 0010 (forced inactive) Write CCxNE to 0 and OCxM to 0100 CCxE = 1 CCxNE = 1 OCxM = 0100

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  574/1027   RM0490 Rev 5  20.4.16   One-pulse mode  One-pulse mode (OPM) is a particular case of the previous modes. It allows the counter to be started in response to a stimulus and to generate a pulse with a programmable length after a programmable delay. Starting the counter can be controlled through the slave mode controller. Generating the waveform can be done in output compare mode or PWM mode. One-pulse mode is selected by setting the OPM bit in the TIMx_CR1 register. This makes the counter stop automatically at the next update event UEV. A pulse can be correctly generated only if the compare value is different from the counter initial value. Before starting (when the timer is waiting for the trigger), the configuration must be:  •   CNT < CCRx   ≤   ARR (in particular, 0 < CCRx)  Figure 211. Example of one pulse mode  For example one may want to generate a positive pulse on OC1 with a length of t PULSE   and after a delay of t   DELAY   as soon as a positive edge is detected on the TI2 input pin. Let’s use TI2FP2 as trigger 1: 1.   Select the proper TI2[x] source (internal or external) with the TI2SEL[3:0] bits in the TIMx_TISEL register. 2.   Map TI2FP2 to TI2 by writing CC2S=’01’ in the TIMx_CCMR1 register. 3.   TI2FP2 must detect a rising edge, write CC2P=’0’ and CC2NP=’0’ in the TIMx_CCER register. 4.   Configure TI2FP2 as trigger for the slave mode controller (TRGI) by writing TS=’00110’ in the TIMx_SMCR register. 5.   TI2FP2 is used to start the counter by writing SMS to ‘110’ in the TIMx_SMCR register (trigger mode).  MS31099V1 TI2 OC1REF Counter t 0 TIM1_ARR TIM1_CCR1 OC1 t   DELAY   t   PULSE

RM0490 Rev 5   575/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  The OPM waveform is defined by writing the compare registers (taking into account the clock frequency and the counter prescaler).  •   The t DELAY   is defined by the value written in the TIMx_CCR1 register.  •   The t PULSE   is defined by the difference between the auto-reload value and the compare value (TIMx_ARR - TIMx_CCR1).  •   Let’s say one want to build a waveform with a transition from ‘0’ to ‘1’ when a compare match occurs and a transition from ‘1’ to ‘0’ when the counter reaches the auto-reload value. To do this PWM mode 2 must be enabled by writing OC1M=111 in the TIMx_CCMR1 register. Optionally the preload registers can be enabled by writing OC1PE=’1’ in the TIMx_CCMR1 register and ARPE in the TIMx_CR1 register. In this case one has to write the compare value in the TIMx_CCR1 register, the auto-reload value in the TIMx_ARR register, generate an update by setting the UG bit and wait for external trigger event on TI2. CC1P is written to ‘0’ in this example. Since only 1 pulse is needed, a 1 must be written in the OPM bit in the TIMx_CR1 register to stop the counter at the next update event (when the counter rolls over from the auto-reload value back to 0). Particular case: OCx fast enable In One-pulse mode, the edge detection on TIx input set the CEN bit which enables the counter. Then the comparison between the counter and the compare value makes the output toggle. But several clock cycles are needed for these operations and it limits the minimum delay t   DELAY   min we can get. If one wants to output a waveform with the minimum delay, the OCxFE bit can be set in the TIMx_CCMRx register. Then OCxRef (and OCx) are forced in response to the stimulus, without taking in account the comparison. Its new level is the same as if a compare match had occurred. OCxFE acts only if the channel is configured in PWM1 or PWM2 mode.  20.4.17   Retriggerable one pulse mode (TIM15 only)  This mode allows the counter to be started in response to a stimulus and to generate a pulse with a programmable length, but with the following differences with Non-retriggerable one pulse mode described in   Section 20.4.16 : –   The pulse starts as soon as the trigger occurs (no programmable delay) –   The pulse is extended if a new trigger occurs before the previous one is completed The timer must be in Slave mode, with the bits SMS[3:0] = ‘1000’ (Combined Reset + trigger mode) in the TIMx_SMCR register, and the OCxM[3:0] bits set to ‘1000’ or ‘1001’ for Retrigerrable OPM mode 1 or 2. If the timer is configured in Up-counting mode, the corresponding CCRx must be set to 0 (the ARR register sets the pulse length). If the timer is configured in Down-counting mode, CCRx must be above or equal to ARR.  Note:   The OCxM[3:0] and SMS[3:0] bit fields are split into two parts for compatibility reasons, the most significant bit are not contiguous with the 3 least significant ones. This mode must not be used with center-aligned PWM modes. It is mandatory to have CMS[1:0] = 00 in TIMx_CR1.

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  576/1027   RM0490 Rev 5  Figure 212. Retriggerable one pulse mode 20.4.18   UIF bit remapping  The IUFREMAP bit in the TIMx_CR1 register forces a continuous copy of the Update Interrupt Flag UIF into bit 31 of the timer counter register (TIMxCNT[31]). This allows both the counter value and a potential roll-over condition signaled by the UIFCPY flag, to be atomically read. In particular cases, it can ease the calculations by avoiding race conditions caused for instance by a processing shared between a background task (counter reading) and an interrupt (Update Interrupt). There is no latency between the assertions of the UIF and UIFCPY flags.  MS33106V2 TRGI Counter Output

RM0490 Rev 5   577/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.4.19   Timer input XOR function (TIM15 only)  The TI1S bit in the TIMx_CR2 register, allows the input filter of channel 1 to be connected to the output of a XOR gate, combining the two input pins TIMx_CH1 and TIMx_CH2. The XOR output can be used with all the timer input functions such as trigger or input capture. It is useful for measuring the interval between the edges on two input signals, as shown in   Figure 213 .  Figure 213. Measuring time interval between edges on 2 signals  MS31400V1 TI1 TI2 TI1 XOR TI2 Counter

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  578/1027   RM0490 Rev 5  20.4.20   External trigger synchronization (TIM15 only)  The TIM timers are linked together internally for timer synchronization or chaining. The TIM15 timer can be synchronized with an external trigger in several modes: Reset mode, Gated mode and Trigger mode.  Slave mode: Reset mode  The counter and its prescaler can be reinitialized in response to an event on a trigger input. Moreover, if the URS bit from the TIMx_CR1 register is low, an update event UEV is generated. Then all the preloaded registers (TIMx_ARR, TIMx_CCRx) are updated. In the following example, the upcounter is cleared in response to a rising edge on TI1 input: 1.   Configure the channel 1 to detect rising edges on TI1. Configure the input filter duration (in this example, we do not need any filter, so we keep IC1F=0000). The capture prescaler is not used for triggering, so it does not need to be configured. The CC1S bits select the input capture source only, CC1S = 01 in the TIMx_CCMR1 register. Write CC1P=’0’ and CC1NP=’0’ in the TIMx_CCER register to validate the polarity (and detect rising edges only). 2.   Configure the timer in reset mode by writing SMS=100 in TIMx_SMCR register. Select TI1 as the input source by writing TS=00101 in TIMx_SMCR register. 3.   Start the counter by writing CEN=1 in the TIMx_CR1 register. The counter starts counting on the internal clock, then behaves normally until TI1 rising edge. When TI1 rises, the counter is cleared and restarts from 0. In the meantime, the trigger flag is set (TIF bit in the TIMx_SR register) and an interrupt request, or a DMA request can be sent if enabled (depending on the TIE and TDE bits in TIMx_DIER register). The following figure shows this behavior when the auto-reload register TIMx_ARR=0x36. The delay between the rising edge on TI1 and the actual reset of the counter is due to the resynchronization circuit on TI1 input.  Figure 214. Control circuit in reset mode  MS31401V1 00 Counter clock = ck_cnt = ck_psc Counter register   01   02   03   00   01   02   03 32   33   34   35   36 UG TI1 31 30 TIF

RM0490 Rev 5   579/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Slave mode: Gated mode  The counter can be enabled depending on the level of a selected input. In the following example, the upcounter counts only when TI1 input is low: 1.   Configure the channel 1 to detect low levels on TI1. Configure the input filter duration (in this example, we do not need any filter, so we keep IC1F=0000). The capture prescaler is not used for triggering, so it does not need to be configured. The CC1S bits select the input capture source only, CC1S=01 in TIMx_CCMR1 register. Write CC1P=1 and CC1NP = ‘0’ in the TIMx_CCER register to validate the polarity (and detect low level only). 2.   Configure the timer in gated mode by writing SMS=101 in TIMx_SMCR register. Select TI1 as the input source by writing TS=00101 in TIMx_SMCR register. 3.   Enable the counter by writing CEN=1 in the TIMx_CR1 register (in gated mode, the counter doesn’t start if CEN=0, whatever is the trigger input level). The counter starts counting on the internal clock as long as TI1 is low and stops as soon as TI1 becomes high. The TIF flag in the TIMx_SR register is set both when the counter starts or stops. The delay between the rising edge on TI1 and the actual stop of the counter is due to the resynchronization circuit on TI1 input.  Figure 215. Control circuit in gated mode  MS31402V1 TI1 cnt_en Write TIF=0 37 Counter clock = ck_cnt = ck_psc Counter register   38 32   33   34   35   36 31 30 TIF

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  580/1027   RM0490 Rev 5  Slave mode: Trigger mode  The counter can start in response to an event on a selected input. In the following example, the upcounter starts in response to a rising edge on TI2 input: 1.   Configure the channel 2 to detect rising edges on TI2. Configure the input filter duration (in this example, we do not need any filter, so we keep IC2F=0000). The capture prescaler is not used for triggering, so it does not need to be configured. The CC2S bits are configured to select the input capture source only, CC2S=01 in TIMx_CCMR1 register. Write CC2P=’1’ and CC2NP=’0’ in the TIMx_CCER register to validate the polarity (and detect low level only). 2.   Configure the timer in trigger mode by writing SMS=110 in the TIMx_SMCR register. Select TI2 as the input source by writing TS=00110 in the TIMx_SMCR register. When a rising edge occurs on TI2, the counter starts counting on the internal clock and the TIF flag is set. The delay between the rising edge on TI2 and the actual start of the counter is due to the resynchronization circuit on TI2 input.  Figure 216. Control circuit in trigger mode 20.4.21   Slave mode – combined reset + trigger mode  In this case, a rising edge of the selected trigger input (TRGI) reinitializes the counter, generates an update of the registers, and starts the counter. This mode is used for one-pulse mode.  20.4.22   DMA burst mode  The TIMx timers have the capability to generate multiple DMA requests on a single event. The main purpose is to be able to re-program several timer registers multiple times without software overhead, but it can also be used to read several registers in a row, at regular intervals. The DMA controller destination is unique and must point to the virtual register TIMx_DMAR. On a given timer event, the timer launches a sequence of DMA requests (burst). Each write into the TIMx_DMAR register is actually redirected to one of the timer registers.  MS31403V1 TI2 cnt_en 37 Counter clock = ck_cnt = ck_psc Counter register   38 34   35   36 TIF

RM0490 Rev 5   581/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  The DBL[4:0] bits in the TIMx_DCR register set the DMA burst length. The timer recognizes a burst transfer when a read or a write access is done to the TIMx_DMAR address), i.e. the number of transfers (either in half-words or in bytes). The DBA[4:0] bits in the TIMx_DCR registers define the DMA base address for DMA transfers (when read/write access are done through the TIMx_DMAR address). DBA is defined as an offset starting from the address of the TIMx_CR1 register. Example: 00000: TIMx_CR1, 00001: TIMx_CR2, 00010: TIMx_SMCR, For example, the timer DMA burst feature could be used to update the contents of the CCRx registers (x = 2, 3, 4) on an update event, with the DMA transferring half words into the CCRx registers. This is done in the following steps: 1.   Configure the corresponding DMA channel as follows: –   DMA channel peripheral address is the DMAR register address –   DMA channel memory address is the address of the buffer in the RAM containing the data to be transferred by DMA into the CCRx registers. –   Number of data to transfer = 3 (See note below). –   Circular mode disabled. 2.   Configure the DCR register by configuring the DBA and DBL bit fields as follows: DBL = 3 transfers, DBA = 0xE. 3.   Enable the TIMx update DMA request (set the UDE bit in the DIER register). 4.   Enable TIMx 5.   Enable the DMA channel This example is for the case where every CCRx register is to be updated once. If every CCRx register is to be updated twice for example, the number of data to transfer should be 6. Let's take the example of a buffer in the RAM containing data1, data2, data3, data4, data5 and data6. The data is transferred to the CCRx registers as follows: on the first update DMA request, data1 is transferred to CCR2, data2 is transferred to CCR3, data3 is transferred to CCR4 and on the second update DMA request, data4 is transferred to CCR2, data5 is transferred to CCR3 and data6 is transferred to CCR4.  Note:   A null value can be written to the reserved registers.

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  582/1027   RM0490 Rev 5  20.4.23   Timer synchronization (TIM15)  The TIMx timers are linked together internally for timer synchronization or chaining. Refer to  Section 18.3.19: Timer synchronization   for details.  Note:   The clock of the slave peripherals (timer, ADC, ...) receiving the TRGO or the TRGO2 signals must be enabled prior to receive events from the master timer, and the clock frequency (prescaler) must not be changed on-the-fly while triggers are received from the master timer.  20.4.24   Using timer output as trigger for other timers (TIM16/TIM17)  The timers with one channel only do not feature a master mode. However, the OC1 output signal can be used to trigger some other timers (including timers described in other sections of this document). Check the “TIMx internal trigger connection” table of any TIMx_SMCR register on the device to identify which timers can be targeted as slave. The OC1 signal pulse width must be programmed to be at least 2 clock cycles of the destination timer, to make sure the slave timer detects the trigger. For instance, if the destination's timer CK_INT clock is 4 times slower than the source timer, the OC1 pulse width must be 8 clock cycles.  20.4.25   Debug mode  When the microcontroller enters debug mode (Cortex   ® -M0+ core halted), the TIMx counter either continues to work normally or stops, depending on DBG_TIMx_STOP configuration bit in DBG module. For more details, refer to   Section 30.9.2: Debug support for timers, watchdog, and I2C . For safety purposes, when the counter is stopped (DBG_TIMx_STOP = 1), the outputs are disabled (as if the MOE bit was reset). The outputs can either be forced to an inactive state (OSSI bit = 1), or have their control taken over by the GPIO controller (OSSI bit = 0) to force them to Hi-Z.

RM0490 Rev 5   583/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.5   TIM15 registers  Refer to   Section 1.2   for a list of abbreviations used in register descriptions. The peripheral registers can be accessed by half-words (16-bit) or words (32-bit).  20.5.1   TIM15 control register 1 (TIM15_CR1)  Address offset: 0x00 Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   UIFRE MAP   Res.   CKD[1:0]   ARPE   Res.   Res.   Res.   OPM   URS   UDIS   CEN rw   rw   rw   rw   rw   rw   rw   rw Bits 15:12   Reserved, must be kept at reset value. Bit 11   UIFREMAP : UIF status bit remapping 0: No remapping. UIF status bit is not copied to TIMx_CNT register bit 31. 1: Remapping enabled. UIF status bit is copied to TIMx_CNT register bit 31. Bit 10   Reserved, must be kept at reset value. Bits 9:8   CKD[1:0] : Clock division This bitfield indicates the division ratio between the timer clock (CK_INT) frequency and the dead-time and sampling clock (t   DTS   ) used by the dead-time generators and the digital filters (TIx) 00: t DTS   = t   CK_INT 01: t DTS   = 2 * t   CK_INT 10: t DTS   = 4 * t   CK_INT 11: Reserved, do not program this value Bit 7   ARPE : Auto-reload preload enable 0: TIMx_ARR register is not buffered 1: TIMx_ARR register is buffered Bits 6:4   Reserved, must be kept at reset value. Bit 3   OPM : One-pulse mode 0: Counter is not stopped at update event 1: Counter stops counting at the next update event (clearing the bit CEN)

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  584/1027   RM0490 Rev 5  20.5.2   TIM15 control register 2 (TIM15_CR2)  Address offset: 0x04 Reset value: 0x0000 Bit 2   URS :   Update request source This bit is set and cleared by software to select the UEV event sources. 0: Any of the following events generate an update interrupt if enabled. These events can be: –   Counter overflow/underflow –   Setting the UG bit –   Update generation through the slave mode controller 1: Only counter overflow/underflow generates an update interrupt if enabled Bit 1   UDIS :   Update disable This bit is set and cleared by software to enable/disable UEV event generation. 0: UEV enabled. The Update (UEV) event is generated by one of the following events: –   Counter overflow/underflow –   Setting the UG bit –   Update generation through the slave mode controller Buffered registers are then loaded with their preload values. 1: UEV disabled. The Update event is not generated, shadow registers keep their value (ARR, PSC, CCRx). However the counter and the prescaler are reinitialized if the UG bit is set or if a hardware reset is received from the slave mode controller. Bit 0   CEN : Counter enable 0: Counter disabled 1: Counter enabled  Note:   External clock and gated mode can work only if the CEN bit has been previously set by software. However trigger mode can set the CEN bit automatically by hardware.  15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   OIS2   OIS1N   OIS1   TI1S   MMS[2:0]   CCDS   CCUS   Res.   CCPC rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:11   Reserved, must be kept at reset value. Bit 10   OIS2:   Output idle state 2 (OC2 output) 0: OC2=0 when MOE=0 1: OC2=1 when MOE=0  Note:   This bit cannot be modified as long as LOCK level 1, 2 or 3 has been programmed (LOCK bits in the TIM15_BDTR register).  Bit 9   OIS1N : Output Idle state 1 (OC1N output) 0: OC1N=0 after a dead-time when MOE=0 1: OC1N=1 after a dead-time when MOE=0  Note:   This bit can not be modified as long as LOCK level 1, 2 or 3 has been programmed (LOCK bits in TIM15_BDTR register).  Bit 8   OIS1 : Output Idle state 1 (OC1 output) 0: OC1=0 (after a dead-time if OC1N is implemented) when MOE=0 1: OC1=1 (after a dead-time if OC1N is implemented) when MOE=0  Note:   This bit can not be modified as long as LOCK level 1, 2 or 3 has been programmed (LOCK bits in TIM15_BDTR register).

RM0490 Rev 5   585/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Bit 7   TI1S : TI1 selection 0: The TIMx_CH1 pin is connected to TI1 input 1: The TIMx_CH1, CH2 pins are connected to the TI1 input (XOR combination) Bits 6:4   MMS[2:0] : Master mode selection These bits allow to select the information to be sent in master mode to slave timers for synchronization (TRGO). The combination is as follows: 000:   Reset   - the UG bit from the TIMx_EGR register is used as trigger output (TRGO). If the reset is generated by the trigger input (slave mode controller configured in reset mode) then the signal on TRGO is delayed compared to the actual reset. 001:   Enable   - the Counter Enable signal CNT_EN is used as trigger output (TRGO). It is useful to start several timers at the same time or to control a window in which a slave timer is enable. The Counter Enable signal is generated by a logic AND between CEN control bit and the trigger input when configured in gated mode. When the Counter Enable signal is controlled by the trigger input, there is a delay on TRGO, except if the master/slave mode is selected (see the MSM bit description in TIMx_SMCR register). 010:   Update   - The update event is selected as trigger output (TRGO). For instance a master timer can then be used as a prescaler for a slave timer. 011:   Compare Pulse   - The trigger output send a positive pulse when the CC1IF flag is to be set (even if it was already high), as soon as a capture or a compare match occurred. (TRGO). 100:   Compare   - OC1REFC signal is used as trigger output (TRGO). 101:   Compare   - OC2REFC signal is used as trigger output (TRGO). Bit 3   CCDS : Capture/compare DMA selection 0: CCx DMA request sent when CCx event occurs 1: CCx DMA requests sent when update event occurs Bit 2   CCUS :   Capture/compare control update selection 0: When capture/compare control bits are preloaded (CCPC=1), they are updated by setting the COMG bit only. 1: When capture/compare control bits are preloaded (CCPC=1), they are updated by setting the COMG bit or when an rising edge occurs on TRGI.  Note:   This bit acts only on channels that have a complementary output.  Bit 1   Reserved, must be kept at reset value. Bit 0   CCPC : Capture/compare preloaded control 0: CCxE, CCxNE and OCxM bits are not preloaded 1: CCxE, CCxNE and OCxM bits are preloaded, after having been written, they are updated only when a commutation event (COM) occurs (COMG bit set or rising edge detected on TRGI, depending on the CCUS bit).  Note:   This bit acts only on channels that have a complementary output.

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  586/1027   RM0490 Rev 5  20.5.3   TIM15 slave mode control register (TIM15_SMCR)  Address offset: 0x08 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TS[4:3]   Res.   Res.   Res.   SMS[3] rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   MSM   TS[2:0]   Res.   SMS[2:0] rw   rw   rw   rw   rw   rw   rw Bits 31:22   Reserved, must be kept at reset value. Bits 19:17   Reserved, must be kept at reset value. Bits 15:8   Reserved, must be kept at reset value. Bit 7   MSM:   Master/slave mode 0: No action 1: The effect of an event on the trigger input (TRGI) is delayed to allow a perfect synchronization between the current timer and its slaves (through TRGO). It is useful if we want to synchronize several timers on a single external event. Bits 21, 20, 6, 5, 4   TS[4:0]:   Trigger selection This bit field selects the trigger input to be used to synchronize the counter. 00000: Internal Trigger 0 (ITR0) 00001: Internal Trigger 1 (ITR1) 00010: Internal Trigger 2 (ITR2) 00011: Internal Trigger 3 (ITR3) 00100: TI1 Edge Detector (TI1F_ED) 00101: Filtered Timer Input 1 (TI1FP1) 00110: Filtered Timer Input 2 (TI2FP2) Other: Reserved See   Table 90: TIMx Internal trigger connection on page 587   for more details on ITRx meaning for each Timer.  Note:   These bits must be changed only when they are not used (e.g. when SMS=000) to avoid wrong edge detections at the transition.  Bit 3   Reserved, must be kept at reset value.

RM0490 Rev 5   587/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.5.4   TIM15 DMA/interrupt enable register (TIM15_DIER)  Address offset: 0x0C Reset value: 0x0000 Bits 16, 2, 1, 0   SMS[3:0]:   Slave mode selection When external signals are selected the active edge of the trigger signal (TRGI) is linked to the polarity selected on the external input (refer to ETP bit in TIMx_SMCR for tim_etr_in and CCxP/CCxNP bits in TIMx_CCER register for tim_ti1fp1 and tim_ti2fp2). 0000: Slave mode disabled - if CEN = ‘1’ then the prescaler is clocked directly by the internal clock. 0001: Reserved 0010: Reserved 0011: Reserved 0100: Reset Mode - Rising edge of the selected trigger input (TRGI) reinitializes the counter and generates an update of the registers. 0101: Gated Mode - The counter clock is enabled when the trigger input (TRGI) is high. The counter stops (but is not reset) as soon as the trigger becomes low. Both start and stop of the counter are controlled. 0110: Trigger Mode - The counter starts at a rising edge of the trigger TRGI (but it is not reset). Only the start of the counter is controlled. 0111: External Clock Mode 1 - Rising edges of the selected trigger (TRGI) clock the counter. 1000: Combined reset + trigger mode - Rising edge of the selected trigger input (TRGI) reinitializes the counter, generates an update of the registers and starts the counter. Other codes: reserved.  Note:   The gated mode must not be used if TI1F_ED is selected as the trigger input (TS=’00100’). Indeed, TI1F_ED outputs 1 pulse for each transition on TI1F, whereas the gated mode checks the level of the trigger signal. Note:   The clock of the slave peripherals (timer, ADC, ...) receiving the TRGO or the TRGO2 signals must be enabled prior to receive events from the master timer, and the clock frequency (prescaler) must not be changed on-the-fly while triggers are received from the master timer.  Table 90. TIMx Internal trigger connection Slave TIM   ITR0 (TS = 00000)   ITR1 (TS = 00001)   ITR2 (TS = 00010)   ITR3 (TS = 00011)  TIM15   TIM2   TIM3   TIM16_OC1   TIM17_OC1 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   TDE   COMD E   Res.   Res.   Res.   CC1DE   UDE   BIE   TIE   COMIE   Res.   Res.   CC2IE   CC1IE   UIE rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 15   Reserved, must be kept at reset value. Bit 14   TDE : Trigger DMA request enable 0: Trigger DMA request disabled 1: Trigger DMA request enabled Bit 13   COMDE : COM DMA request enable 0: COM DMA request disabled 1: COM DMA request enabled

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  588/1027   RM0490 Rev 5  20.5.5   TIM15 status register (TIM15_SR)  Address offset: 0x10 Reset value: 0x0000 Bits 12:10   Reserved, must be kept at reset value. Bit 9   CC1DE : Capture/Compare 1 DMA request enable 0: CC1 DMA request disabled 1: CC1 DMA request enabled Bit 8   UDE : Update DMA request enable 0: Update DMA request disabled 1: Update DMA request enabled Bit 7   BIE : Break interrupt enable 0: Break interrupt disabled 1: Break interrupt enabled Bit 6   TIE : Trigger interrupt enable 0: Trigger interrupt disabled 1: Trigger interrupt enabled Bit 5   COMIE:   COM interrupt enable 0: COM interrupt disabled 1: COM interrupt enabled Bits 4:3   Reserved, must be kept at reset value. Bit 2   CC2IE : Capture/Compare 2 interrupt enable 0: CC2 interrupt disabled 1: CC2 interrupt enabled Bit 1   CC1IE : Capture/Compare 1 interrupt enable 0: CC1 interrupt disabled 1: CC1 interrupt enabled Bit 0   UIE : Update interrupt enable 0: Update interrupt disabled 1: Update interrupt enabled 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   CC2OF   CC1OF   Res.   BIF   TIF   COMIF   Res.   Res.   CC2IF   CC1IF   UIF rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0 Bits 15:11   Reserved, must be kept at reset value. Bit 10   CC2OF : Capture/Compare 2 overcapture flag Refer to CC1OF description Bit 9   CC1OF : Capture/Compare 1 overcapture flag This flag is set by hardware only when the corresponding channel is configured in input capture mode. It is cleared by software by writing it to ‘0’. 0: No overcapture has been detected 1: The counter value has been captured in TIMx_CCR1 register while CC1IF flag was already set Bit 8   Reserved, must be kept at reset value.

RM0490 Rev 5   589/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Bit 7   BIF : Break interrupt flag This flag is set by hardware as soon as the break input goes active. It can be cleared by software if the break input is not active. 0: No break event occurred 1: An active level has been detected on the break input Bit 6   TIF : Trigger interrupt flag This flag is set by hardware on the TRG trigger event (active edge detected on TRGI input when the slave mode controller is enabled in all modes but gated mode, both edges in case gated mode is selected). It is set when the counter starts or stops when gated mode is selected. It is cleared by software. 0: No trigger event occurred 1: Trigger interrupt pending Bit 5   COMIF:   COM interrupt flag This flag is set by hardware on a COM event (once the capture/compare control bits –CCxE, CCxNE, OCxM– have been updated). It is cleared by software. 0: No COM event occurred 1: COM interrupt pending Bits 4:3   Reserved, must be kept at reset value. Bit 2   CC2IF : Capture/Compare 2 interrupt flag refer to CC1IF description Bit 1   CC1IF : Capture/Compare 1 interrupt flag This flag is set by hardware. It is cleared by software (input capture or output compare mode) or by reading the TIMx_CCR1 register (input capture mode only). 0: No compare match / No input capture occurred 1: A compare match or an input capture occurred  If channel CC1 is configured as output : this flag is set when the content of the counter TIMx_CNT matches the content of the TIMx_CCR1 register. When the content of TIMx_CCR1 is greater than the content of TIMx_ARR, the CC1IF bit goes high on the counter overflow (in up-counting and up/down-counting modes) or underflow (in down- counting mode). There are 3 possible options for flag setting in center-aligned mode, refer to the CMS bits in the TIMx_CR1 register for the full description.  If channel CC1 is configured as input : this bit is set when counter value has been captured in TIMx_CCR1 register (an edge has been detected on IC1, as per the edge sensitivity defined with the CC1P and CC1NP bits setting, in TIMx_CCER). Bit 0   UIF : Update interrupt flag This bit is set by hardware on an update event. It is cleared by software. 0: No update occurred. 1: Update interrupt pending. This bit is set by hardware when the registers are updated: – At overflow regarding the repetition counter value (update if repetition counter = 0) and if the UDIS=0 in the TIMx_CR1 register. – When CNT is reinitialized by software using the UG bit in TIMx_EGR register, if URS=0 and UDIS=0 in the TIMx_CR1 register. – When CNT is reinitialized by a trigger event (refer to   Section 20.5.3: TIM15 slave mode control register (TIM15_SMCR) ), if URS=0 and UDIS=0 in the TIMx_CR1 register.

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  590/1027   RM0490 Rev 5  20.5.6   TIM15 event generation register (TIM15_EGR)  Address offset: 0x14 Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   BG   TG   COMG   Res.   Res.   CC2G   CC1G   UG w   w   rw   w   w   w Bits 15:8   Reserved, must be kept at reset value. Bit 7   BG : Break generation This bit is set by software in order to generate an event, it is automatically cleared by hardware. 0: No action 1: A break event is generated. MOE bit is cleared and BIF flag is set. Related interrupt or DMA transfer can occur if enabled. Bit 6   TG : Trigger generation This bit is set by software in order to generate an event, it is automatically cleared by hardware. 0: No action 1: The TIF flag is set in TIMx_SR register. Related interrupt or DMA transfer can occur if enabled Bit 5   COMG:   Capture/Compare control update generation This bit can be set by software, it is automatically cleared by hardware. 0: No action 1: When the CCPC bit is set, it is possible to update the CCxE, CCxNE and OCxM bits  Note:   This bit acts only on channels that have a complementary output.  Bits 4:3   Reserved, must be kept at reset value. Bit 2   CC2G : Capture/Compare 2 generation Refer to CC1G description Bit 1   CC1G : Capture/Compare 1 generation This bit is set by software in order to generate an event, it is automatically cleared by hardware. 0: No action 1: A capture/compare event is generated on channel 1:  If channel CC1 is configured as output:  CC1IF flag is set, Corresponding interrupt or DMA request is sent if enabled.  If channel CC1 is configured as input:  The current value of the counter is captured in TIMx_CCR1 register. The CC1IF flag is set, the corresponding interrupt or DMA request is sent if enabled. The CC1OF flag is set if the CC1IF flag was already high. Bit 0   UG : Update generation This bit can be set by software, it is automatically cleared by hardware. 0: No action 1: Reinitialize the counter and generates an update of the registers. Note that the prescaler counter is cleared too (anyway the prescaler ratio is not affected).

RM0490 Rev 5   591/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.5.7   TIM15 capture/compare mode register 1 (TIM15_CCMR1)  Address offset: 0x18 Reset value: 0x0000 0000 The same register can be used for input capture mode (this section) or for output compare mode (next section). The direction of a channel is defined by configuring the corresponding CCxS bits. All the other bits of this register have a different function in input and in output mode.  Input capture mode:  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 IC2F[3:0]   IC2PSC[1:0]   CC2S[1:0]   IC1F[3:0]   IC1PSC[1:0]   CC1S[1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:12   IC2F[3:0] :   Input capture 2 filter Bits 11:10   IC2PSC[1:0] : Input capture 2 prescaler Bits 9:8   CC2S[1:0] : Capture/Compare 2 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC2 channel is configured as output 01: CC2 channel is configured as input, IC2 is mapped on TI2 10: CC2 channel is configured as input, IC2 is mapped on TI1 11: CC2 channel is configured as input, IC2 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC2S bits are writable only when the channel is OFF (CC2E = ‘0’ in TIMx_CCER).

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  592/1027   RM0490 Rev 5  20.5.8   TIM15 capture/compare mode register 1 [alternate] (TIM15_CCMR1)  Address offset: 0x18 Reset value: 0x0000 0000 The same register can be used for output compare mode (this section) or for input capture mode (previous section). The direction of a channel is defined by configuring the corresponding CCxS bits. All the other bits of this register have a different function in input and in output mode.  Output compare mode:  Bits 7:4   IC1F[3:0] :   Input capture 1 filter This bit-field defines the frequency used to sample TI1 input and the length of the digital filter applied to TI1. The digital filter is made of an event counter in which N consecutive events are needed to validate a transition on the output: 0000: No filter, sampling is done at f   DTS 0001: f   SAMPLING =f CK_INT , N=2 0010: f   SAMPLING =f CK_INT , N=4 0011: f   SAMPLING =f   CK_INT , N=8 0100: f   SAMPLING =f DTS /2, N=6 0101: f   SAMPLING =f DTS /2, N=8 0110: f   SAMPLING =f   DTS /4, N=6 0111: f   SAMPLING =f   DTS /4, N=8 1000: f   SAMPLING =f DTS /8, N=6 1001: f   SAMPLING =f DTS /8, N=8 1010: f   SAMPLING =f DTS /16, N=5 1011: f   SAMPLING =f   DTS /16, N=6 1100: f   SAMPLING =f   DTS /16, N=8 1101: f   SAMPLING =f   DTS /32, N=5 1110: f   SAMPLING =f   DTS /32, N=6 1111: f   SAMPLING =f   DTS /32, N=8 Bits 3:2   IC1PSC[1:0] :   Input capture 1 prescaler This bit-field defines the ratio of the prescaler acting on CC1 input (IC1). The prescaler is reset as soon as CC1E=’0’ (TIMx_CCER register). 00: no prescaler, capture is done each time an edge is detected on the capture input 01: capture is done once every 2 events 10: capture is done once every 4 events 11: capture is done once every 8 events Bits 1:0   CC1S[1:0] : Capture/Compare 1 Selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC1 channel is configured as output 01: CC1 channel is configured as input, IC1 is mapped on TI1 10: CC1 channel is configured as input, IC1 is mapped on TI2 11: CC1 channel is configured as input, IC1 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC1S bits are writable only when the channel is OFF (CC1E = ‘0’ in TIMx_CCER).

RM0490 Rev 5   593/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC2M [3]   Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC1M [3] rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   OC2M[2:0]   OC2 PE OC2 FE   CC2S[1:0]   Res.   OC1M[2:0]   OC1 PE OC1 FE   CC1S[1:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:25   Reserved, must be kept at reset value. Bits 23:17   Reserved, must be kept at reset value. Bit 15   Reserved, must be kept at reset value. Bits 24, 14:12   OC2M[3:0] : Output Compare 2 mode Bit 11   OC2PE : Output Compare 2 preload enable Bit 10   OC2FE : Output Compare 2 fast enable Bits 9:8   CC2S[1:0] : Capture/Compare 2 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC2 channel is configured as output. 01: CC2 channel is configured as input, IC2 is mapped on TI2. 10: CC2 channel is configured as input, IC2 is mapped on TI1. 11: CC2 channel is configured as input, IC2 is mapped on TRC. This mode is working only if an internal trigger input is selected through the TS bit (TIMx_SMCR register)  Note:   CC2S bits are writable only when the channel is OFF (CC2E = ‘0’ in TIMx_CCER).  Bit 7   Reserved, must be kept at reset value.

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  594/1027   RM0490 Rev 5  Bits 16, 6:4   OC1M[3:0] : Output Compare 1 mode These bits define the behavior of the output reference signal OC1REF from which OC1 and OC1N are derived. OC1REF is active high whereas OC1 and OC1N active level depends on CC1P and CC1NP bits. 0000: Frozen - The comparison between the output compare register TIMx_CCR1 and the counter TIMx_CNT has no effect on the outputs. 0001: Set channel 1 to active level on match. OC1REF signal is forced high when the counter TIMx_CNT matches the capture/compare register 1 (TIMx_CCR1). 0010: Set channel 1 to inactive level on match. OC1REF signal is forced low when the counter TIMx_CNT matches the capture/compare register 1 (TIMx_CCR1). 0011: Toggle - OC1REF toggles when TIMx_CNT=TIMx_CCR1. 0100: Force inactive level - OC1REF is forced low. 0101: Force active level - OC1REF is forced high. 0110: PWM mode 1 - Channel 1 is active as long as TIMx_CNT<TIMx_CCR1 else inactive. 0111: PWM mode 2 - Channel 1 is inactive as long as TIMx_CNT<TIMx_CCR1 else active. 1000: Retrigerrable   OPM mode 1 - In up-counting mode, the channel is active until a trigger event is detected (on TRGI signal). Then, a comparison is performed as in PWM mode 1 and the channels becomes active again at the next update. In down-counting mode, the channel is inactive until a trigger event is detected (on TRGI signal). Then, a comparison is performed as in PWM mode 1 and the channels becomes inactive again at the next update. 1001: Retrigerrable   OPM mode 2 - In up-counting mode, the channel is inactive until a trigger event is detected (on TRGI signal). Then, a comparison is performed as in PWM mode 2 and the channels becomes inactive again at the next update. In down- counting mode, the channel is active until a trigger event is detected (on TRGI signal). Then, a comparison is performed as in PWM mode 1 and the channels becomes active again at the next update. 1010: Reserved 1011: Reserved 1100: Combined PWM mode 1 - OC1REF has the same behavior as in PWM mode 1. OC1REFC is the logical OR between OC1REF and OC2REF. 1101: Combined PWM mode 2 - OC1REF has the same behavior as in PWM mode 2. OC1REFC is the logical AND between OC1REF and OC2REF. 1110: Reserved, 1111: Reserved,  Note:   These bits can not be modified as long as LOCK level 3 has been programmed (LOCK bits in TIMx_BDTR register) and CC1S=’00’ (the channel is configured in output). In PWM mode, the OCREF level changes only when the result of the comparison changes or when the output compare mode switches from “frozen” mode to “PWM” mode. On channels that have a complementary output, this bit field is preloaded. If the CCPC bit is set in the TIMx_CR2 register then the OC1M active bits take the new value from the preloaded bits only when a COM event is generated. The OC1M[3] bit is not contiguous, located in bit 16.

RM0490 Rev 5   595/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.5.9   TIM15 capture/compare enable register (TIM15_CCER)  Address offset: 0x20 Reset value: 0x0000 Bit 3   OC1PE : Output Compare 1 preload enable 0: Preload register on TIMx_CCR1 disabled. TIMx_CCR1 can be written at anytime, the new value is taken in account immediately. 1: Preload register on TIMx_CCR1 enabled. Read/Write operations access the preload register. TIMx_CCR1 preload value is loaded in the active register at each update event.  Note:   These bits can not be modified as long as LOCK level 3 has been programmed (LOCK bits in TIMx_BDTR register) and CC1S=’00’ (the channel is configured in output).  Bit 2   OC1FE : Output Compare 1 fast enable This bit decreases the latency between a trigger event and a transition on the timer output. It must be used in one-pulse mode (OPM bit set in TIMx_CR1 register), to have the output pulse starting as soon as possible after the starting trigger. 0: CC1 behaves normally depending on counter and CCR1 values even when the trigger is ON. The minimum delay to activate CC1 output when an edge occurs on the trigger input is 5 clock cycles. 1: An active edge on the trigger input acts like a compare match on CC1 output. Then, OC is set to the compare level independently of the result of the comparison. Delay to sample the trigger input and to activate CC1 output is reduced to 3 clock cycles. OCFE acts only if the channel is configured in PWM1 or PWM2 mode. Bits 1:0   CC1S[1:0] : Capture/Compare 1 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC1 channel is configured as output. 01: CC1 channel is configured as input, IC1 is mapped on TI1. 10: CC1 channel is configured as input, IC1 is mapped on TI2. 11: CC1 channel is configured as input, IC1 is mapped on TRC. This mode is working only if an internal trigger input is selected through TS bit (TIMx_SMCR register)  Note:   CC1S bits are writable only when the channel is OFF (CC1E = ‘0’ in TIMx_CCER).  15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CC2NP   Res.   CC2P   CC2E   CC1NP   CC1NE   CC1P   CC1E rw   rw   rw   rw   rw   rw   rw Bits 15:8   Reserved, must be kept at reset value. Bit 7   CC2NP : Capture/Compare 2 complementary output polarity Refer to CC1NP description Bit 6   Reserved, must be kept at reset value. Bit 5   CC2P : Capture/Compare 2 output polarity Refer to CC1P description Bit 4   CC2E : Capture/Compare 2 output enable Refer to CC1E description

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  596/1027   RM0490 Rev 5  Bit 3   CC1NP : Capture/Compare 1 complementary output polarity CC1 channel configured as output: 0: OC1N active high 1: OC1N active low CC1 channel configured as input: This bit is used in conjunction with CC1P to define the polarity of TI1FP1 and TI2FP1. Refer to CC1P description.  Note:   This bit is not writable as soon as LOCK level 2 or 3 has been programmed (LOCK bits in TIMx_BDTR register) and CC1S=”00” (the channel is configured in output). On channels that have a complementary output, this bit is preloaded. If the CCPC bit is set in the TIMx_CR2 register then the CC1NP active bit takes the new value from the preloaded bit only when a Commutation event is generated.  Bit 2   CC1NE : Capture/Compare 1 complementary output enable 0: Off - OC1N is not active. OC1N level is then function of MOE, OSSI, OSSR, OIS1, OIS1N and CC1E bits. 1: On - OC1N signal is output on the corresponding output pin depending on MOE, OSSI, OSSR, OIS1, OIS1N and CC1E bits. Bit 1   CC1P : Capture/Compare 1 output polarity 0: OC1 active high (output mode) / Edge sensitivity selection (input mode, see below) 1: OC1 active low (output mode) / Edge sensitivity selection (input mode, see below)  When CC1 channel is configured as input , both CC1NP/CC1P bits select the active polarity of TI1FP1 and TI2FP1 for trigger or capture operations. CC1NP=0, CC1P=0: non-inverted/rising edge. The circuit is sensitive to TIxFP1 rising edge (capture or trigger operations in reset, external clock or trigger mode), TIxFP1 is not inverted (trigger operation in gated mode or encoder mode). CC1NP=0, CC1P=1: inverted/falling edge. The circuit is sensitive to TIxFP1 falling edge (capture or trigger operations in reset, external clock or trigger mode), TIxFP1 is inverted (trigger operation in gated mode or encoder mode). CC1NP=1, CC1P=1: non-inverted/both edges/ The circuit is sensitive to both TIxFP1 rising and falling edges (capture or trigger operations in reset, external clock or trigger mode), TIxFP1is not inverted (trigger operation in gated mode). This configuration must not be used in encoder mode. CC1NP=1, CC1P=0: this configuration is reserved, it must not be used.  Note:   This bit is not writable as soon as LOCK level 2 or 3 has been programmed (LOCK bits in TIMx_BDTR register). On channels that have a complementary output, this bit is preloaded. If the CCPC bit is set in the TIMx_CR2 register then the CC1P active bit takes the new value from the preloaded bit only when a Commutation event is generated.  Bit 0   CC1E : Capture/Compare 1 output enable 0: Capture mode disabled / OC1 is not active (see below) 1: Capture mode enabled / OC1 signal is output on the corresponding output pin  When CC1 channel is configured as output,   the OC1 level depends on MOE, OSSI, OSSR, OIS1, OIS1N and CC1NE bits, regardless of the CC1E bits state. Refer to   Table 91  for details.

RM0490 Rev 5   597/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Note:   The state of the external I/O pins connected to the complementary OCx and OCxN channels depends on the OCx and OCxN channel state and GPIO control and alternate function registers.  Table 91. Output control bits for complementary OCx and OCxN channels with break feature (TIM15)  Control bits   Output states   (1) MOE bit   OSSI bit   OSSR bit   CCxE bit   CCxNE bit   OCx output state   OCxN output state 1   X X   0   0 Output Disabled (not driven by the timer: Hi-Z) OCx=0 OCxN=0, OCxN_EN=0 0   0   1 Output Disabled (not driven by the timer: Hi-Z) OCx=0 OCxREF + Polarity OCxN=OCxREF XOR CCxNP 0   1   0   OCxREF + Polarity OCx=OCxREF XOR CCxP Output Disabled (not driven by the timer: Hi-Z) OCxN=0 X   1   1   OCREF + Polarity + dead- time Complementary to OCREF (not OCREF) + Polarity + dead-time 1   0   1 Off-State (output enabled with inactive state) OCx=CCxP OCxREF + Polarity OCxN=OCxREF XOR CCxNP 1   1   0 OCxREF + Polarity OCx=OCxREF xor CCxP, OCx_EN=1 Off-State (output enabled with inactive state) OCxN=CCxNP, OCxN_EN=1 0 0 X X   X   Output disabled (not driven by the timer: Hi-Z) 1 0   0 0   1   Off-State (output enabled with inactive state) Asynchronously: OCx=CCxP, OCxN=CCxNP Then if the clock is present: OCx=OISx and OCxN=OISxN after a dead-time, assuming that OISx and OISxN do not correspond to OCX and OCxN both in active state 1   0 1   1 1.   When both outputs of a channel are not used (control taken over by GPIO controller), the OISx, OISxN, CCxP and CCxNP bits must be kept cleared.

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  598/1027   RM0490 Rev 5  20.5.10   TIM15 counter (TIM15_CNT)  Address offset: 0x24 Reset value: 0x0000 0000  20.5.11   TIM15 prescaler (TIM15_PSC)  Address offset: 0x28 Reset value: 0x0000  20.5.12   TIM15 auto-reload register (TIM15_ARR)  Address offset: 0x2C Reset value: 0xFFFF 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 UIF CPY   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CNT[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 31   UIFCPY : UIF Copy This bit is a read-only copy of the UIF bit in the TIMx_ISR register. Bits 30:16   Reserved, must be kept at reset value. Bits 15:0   CNT[15:0] : Counter value 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 PSC[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   PSC[15:0] : Prescaler value The counter clock frequency (CK_CNT) is equal to f CK_PSC   / (PSC[15:0] + 1). PSC contains the value to be loaded in the active prescaler register at each update event (including when the counter is cleared through UG bit of TIMx_EGR register or through trigger controller when configured in “reset mode”). 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ARR[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   ARR[15:0] : Auto-reload value ARR is the value to be loaded in the actual auto-reload register. Refer to the   Section 20.4.1: Time-base unit on page 547   for more details about ARR update and behavior. The counter is blocked while the auto-reload value is null.

RM0490 Rev 5   599/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.5.13   TIM15 repetition counter register (TIM15_RCR)  Address offset: 0x30 Reset value: 0x0000  20.5.14   TIM15 capture/compare register 1 (TIM15_CCR1)  Address offset: 0x34 Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   REP[7:0] rw   rw   rw   rw   rw   rw   rw   rw Bits 15:8   Reserved, must be kept at reset value. Bits 7:0   REP[7:0] : Repetition counter value These bits allow the user to set-up the update rate of the compare registers (i.e. periodic transfers from preload to active registers) when preload registers are enable, as well as the update interrupt generation rate, if this interrupt is enable. Each time the REP_CNT related downcounter reaches zero, an update event is generated and it restarts counting from REP value. As REP_CNT is reloaded with REP value only at the repetition update event U_RC, any write to the TIMx_RCR register is not taken in account until the next repetition update event. It means in PWM mode (REP+1) corresponds to the number of PWM periods in edge- aligned mode. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CCR1[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   CCR1[15:0] : Capture/Compare 1 value  If channel CC1 is configured as output : CCR1 is the value to be loaded in the actual capture/compare 1 register (preload value). It is loaded permanently if the preload feature is not selected in the TIMx_CCMR1 register (bit OC1PE). Else the preload value is copied in the active capture/compare 1 register when an update event occurs. The active capture/compare register contains the value to be compared to the counter TIMx_CNT and signaled on OC1 output.  If channel CC1 is configured as input : CCR1 is the counter value transferred by the last input capture 1 event (IC1).

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  600/1027   RM0490 Rev 5  20.5.15   TIM15 capture/compare register 2 (TIM15_CCR2)  Address offset: 0x38 Reset value: 0x0000  20.5.16   TIM15 break and dead-time register (TIM15_BDTR)  Address offset: 0x44 Reset value: 0x0000 0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CCR2[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   CCR2[15:0] : Capture/Compare 2 value  If channel CC2 is configured as output : CCR2 is the value to be loaded in the actual capture/compare 2 register (preload value). It is loaded permanently if the preload feature is not selected in the TIMx_CCMR2 register (bit OC2PE). Else the preload value is copied in the active capture/compare 2 register when an update event occurs. The active capture/compare register contains the value to be compared to the counter TIMx_CNT and signalled on OC2 output.  If channel CC2 is configured as input : CCR2 is the counter value transferred by the last input capture 2 event (IC2). 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   BKBID   Res.   BK DSRM   Res.   Res.   Res.   Res.   Res.   Res.   BKF[3:0] rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 MOE   AOE   BKP   BKE   OSSR   OSSI   LOCK[1:0]   DTG[7:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Note:   As the BKBID, BKDSRM, BKF[3:0], AOE, BKP, BKE, OSSI, OSSR and DTG[7:0] bits may be write-locked depending on the LOCK configuration, it may be necessary to configure all of them during the first write access to the TIMx_BDTR register.  Bits 31:29   Reserved, must be kept at reset value. Bit 28   BKBID : Break Bidirectional 0: Break input BRK in input mode 1: Break input BRK in bidirectional mode In the bidirectional mode (BKBID bit set to 1), the break input is configured both in input mode and in open drain output mode. Any active break event asserts a low logic level on the Break input to indicate an internal break event to external devices.  Note:   This bit cannot be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register). Note:   Any write operation to this bit takes a delay of 1 APB clock cycle to become effective.

RM0490 Rev 5   601/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Bit 27   Reserved, must be kept at reset value. Bit 26   BKDSRM : Break Disarm 0: Break input BRK is armed 1: Break input BRK is disarmed This bit is cleared by hardware when no break source is active. The BKDSRM bit must be set by software to release the bidirectional output control (open- drain output in Hi-Z state) and then be polled it until it is reset by hardware, indicating that the fault condition has disappeared.  Note:   Any write operation to this bit takes a delay of 1 APB clock cycle to become effective.  Bits 25:20   Reserved, must be kept at reset value. Bits 19:16   BKF[3:0] :   Break filter This bit-field defines the frequency used to sample the BRK input signal and the length of the digital filter applied to BRK. The digital filter is made of an event counter in which N events are needed to validate a transition on the output: 0000: No filter, BRK acts asynchronously 0001: f   SAMPLING =f   CK_INT , N=2 0010: f   SAMPLING =f   CK_INT , N=4 0011: f   SAMPLING =f   CK_INT , N=8 0100: f   SAMPLING =f   DTS /2, N=6 0101: f   SAMPLING =f   DTS /2, N=8 0110: f   SAMPLING =f   DTS /4, N=6 0111: f   SAMPLING =f   DTS /4, N=8 1000: f   SAMPLING =f   DTS /8, N=6 1001: f   SAMPLING =f   DTS /8, N=8 1010: f   SAMPLING =f   DTS /16, N=5 1011: f   SAMPLING =f   DTS /16, N=6 1100: f   SAMPLING =f   DTS /16, N=8 1101: f   SAMPLING =f   DTS /32, N=5 1110: f   SAMPLING =f   DTS /32, N=6 1111: f   SAMPLING =f   DTS /32, N=8  Note:   This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).  Bit 15   MOE : Main output enable This bit is cleared asynchronously by hardware as soon as the break input is active. It is set by software or automatically depending on the AOE bit. It is acting only on the channels which are configured in output. 0: OC and OCN outputs are disabled or forced to idle state depending on the OSSI bit. 1: OC and OCN outputs are enabled if their respective enable bits are set (CCxE, CCxNE in TIMx_CCER register) See OC/OCN enable description for more details ( Section 20.5.9: TIM15 capture/compare enable register (TIM15_CCER) on page 595 ). Bit 14   AOE : Automatic output enable 0: MOE can be set only by software 1: MOE can be set by software or automatically at the next update event (if the break input is not be active)  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  602/1027   RM0490 Rev 5  Bit 13   BKP : Break polarity 0: Break input BRK is active low 1: Break input BRK is active high  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register). Any write operation to this bit takes a delay of 1 APB clock cycle to become effective.  Bit 12   BKE : Break enable 0: Break inputs (BRK and CCS clock failure event) disabled 1; Break inputs (BRK and CCS clock failure event) enabled This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).  Note:   Any write operation to this bit takes a delay of 1 APB clock cycle to become effective.  Bit 11   OSSR :   Off-state selection for Run mode This bit is used when MOE=1 on channels that have a complementary output which are configured as outputs. OSSR is not implemented if no complementary output is implemented in the timer. See OC/OCN enable description for more details ( Section 20.5.9: TIM15 capture/compare enable register (TIM15_CCER) on page 595 ). 0: When inactive, OC/OCN outputs are disabled (the timer releases the output control which is taken over by the GPIO, which forces a Hi-Z state) 1: When inactive, OC/OCN outputs are enabled with their inactive level as soon as CCxE=1 or CCxNE=1 (the output is still controlled by the timer).  Note:   This bit can not be modified as soon as the LOCK level 2 has been programmed (LOCK bits in TIMx_BDTR register).  Bit 10   OSSI :   Off-state selection for Idle mode This bit is used when MOE=0 on channels configured as outputs. See OC/OCN enable description for more details ( Section 20.5.9: TIM15 capture/compare enable register (TIM15_CCER) on page 595 ). 0: When inactive, OC/OCN outputs are disabled (OC/OCN enable output signal=0) 1: When inactive, OC/OCN outputs are forced first with their idle level as soon as CCxE=1 or CCxNE=1. OC/OCN enable output signal=1)  Note:   This bit can not be modified as soon as the LOCK level 2 has been programmed (LOCK bits in TIMx_BDTR register).  Bits 9:8   LOCK[1:0] : Lock configuration These bits offer a write protection against software errors. 00: LOCK OFF - No bit is write protected 01: LOCK Level 1 = DTG bits in TIMx_BDTR register, OISx and OISxN bits in TIMx_CR2 register and BKE/BKP/AOE bits in TIMx_BDTR register can no longer be written 10: LOCK Level 2 = LOCK Level 1 + CC Polarity bits (CCxP/CCxNP bits in TIMx_CCER register, as long as the related channel is configured in output through the CCxS bits) as well as OSSR and OSSI bits can no longer be written. 11: LOCK Level 3 = LOCK Level 2 + CC Control bits (OCxM and OCxPE bits in TIMx_CCMRx registers, as long as the related channel is configured in output through the CCxS bits) can no longer be written.  Note:   The LOCK bits can be written only once after the reset. Once the TIMx_BDTR register has been written, their content is frozen until the next reset.

RM0490 Rev 5   603/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.5.17   TIM15 DMA control register (TIM15_DCR)  Address offset: 0x48 Reset value: 0x0000  20.5.18   TIM15 DMA address for full transfer (TIM15_DMAR)  Address offset: 0x4C Reset value: 0x0000 Bits 7:0   DTG[7:0] : Dead-time generator setup This bit-field defines the duration of the dead-time inserted between the complementary outputs. DT correspond to this duration. DTG[7:5] = 0xx => DT = DTG[7:0] x t dtg   with t   dtg   = t   DTS DTG[7:5] = 10x => DT = (64+DTG[5:0]) x t   dtg   with t   dtg   = 2 x t DTS DTG[7:5] = 110 => DT = (32+DTG[4:0]) x t   dtg   with t   dtg   = 8 x t   DTS DTG[7:5] = 111 => DT = (32+DTG[4:0]) x t dtg   with t   dtg   = 16 x t   DTS Example if t DTS   = 125 ns (8 MHz), dead-time possible values are: 0 to 15875 ns by 125 ns steps, 16 μs to 31750 ns by 250 ns steps, 32 μs to 63 μs by 1 μs steps, 64 μs to 126 μs by 2 μs steps  Note:   This bit-field can not be modified as long as LOCK level 1, 2 or 3 has been programmed (LOCK bits in TIMx_BDTR register).  15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   DBL[4:0]   Res.   Res.   Res.   DBA[4:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:13   Reserved, must be kept at reset value. Bits 12:8   DBL[4:0] : DMA burst length This 5-bit field defines the length of DMA transfers (the timer recognizes a burst transfer when a read or a write access is done to the TIMx_DMAR address). 00000: 1 transfer, 00001: 2 transfers, 00010: 3 transfers, ... 10001: 18 transfers. Bits 7:5   Reserved, must be kept at reset value. Bits 4:0   DBA[4:0] : DMA base address This 5-bit field defines the base-address for DMA transfers (when read/write access are done through the TIMx_DMAR address). DBA is defined as an offset starting from the address of the TIMx_CR1 register. Example: 00000: TIMx_CR1, 00001: TIMx_CR2, 00010: TIMx_SMCR, ... 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 DMAB[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  604/1027   RM0490 Rev 5  20.5.19   TIM15 alternate register 1 (TIM15_AF1)  Address offset: 0x60 Reset value: 0x0000 0001  20.5.20   TIM15 input selection register (TIM15_TISEL)  Address offset: 0x68 Reset value: 0x0000 0000 Bits 15:0   DMAB[15:0] : DMA register for burst accesses A read or write operation to the DMAR register accesses the register located at the address (TIMx_CR1 address) + (DBA + DMA index) x 4 where TIMx_CR1 address is the address of the control register 1, DBA is the DMA base address configured in TIMx_DCR register, DMA index is automatically controlled by the DMA transfer, and ranges from 0 to DBL (DBL configured in TIMx_DCR). 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   BKINP   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   BKINE rw   rw Bits 31:10   Reserved, must be kept at reset value. Bit 9   BKINP : BRK BKIN input polarity This bit selects the BKIN alternate function input sensitivity. It must be programmed together with the BKP polarity bit. 0: BKIN input is active low 1: BKIN input is active high  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).  Bits 8:1   Reserved, must be kept at reset value. Bit 0   BKINE : BRK BKIN input enable This bit enables the BKIN alternate function input for the timer’s BRK input. BKIN input is ‘ORed’ with the other BRK sources. 0: BKIN input disabled 1: BKIN input enabled  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   TI2SEL[3:0]   Res.   Res.   Res.   Res.   TI1SEL[3:0] rw   rw   rw   rw   rw   rw   rw   rw Bits 31:12   Reserved, must be kept at reset value.

RM0490 Rev 5   605/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.5.21   TIM15 register map  TIM15 registers are mapped as 16-bit addressable registers as described in the table below: Bits 11:8   TI2SEL[3:0] : selects TI2[0] to TI2[15] input 0000: TIM15_CH2 input 0001: TIM2_IC2 0010: TIM3_IC2 Others: Reserved Bits 7:4   Reserved, must be kept at reset value. Bits 3:0   TI1SEL[3:0] : selects TI1[0] to TI1[15] input 0000: TIM15_CH1 input 0001: TIM2_IC1 0010: TIM3_IC1 Others: Reserved  Table 92. TIM15 register map and reset values Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00  TIM15_CR1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. UIFREMA Res.   CKD [1:0] ARPE Res. Res. Res. OPM URS UDIS CEN Reset value   0   0   0   0   0   0   0   0 0x04  TIM15_CR2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. OIS2 OIS1N OIS1 TI1S MMS[2:0] CCDS CCUS Res. CCPC Reset value   0   0   0   0   0   0   0   0   0   0 0x08  TIM15_SMCR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res.   TS [4:3] Res. Res. Res. SMS[3] Res. Res. Res. Res. Res. Res. Res. Res. MSM TS[2:0] Res. SMS[2:0] Reset value   0   0   0   0   0   0   0   0   0   0 0x0C  TIM15_DIER  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TDE COMDE Res. Res. Res. CC1DE UDE BIE TIE COMIE Res. Res. CC2IE CC1IE UIE Reset value   0   0   0   0   0   0   0   0   0   0 0x10  TIM15_SR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CC2OF CC1OF Res. BIF TIF COMIF Res. Res. CC2IF CC1IF UIF Reset value   0   0   0   0   0   0   0   0 0x14  TIM15_EGR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. BG TG COMG Res. Res. CC2G CC1G UG Reset value   0   0   0   0   0   0

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  606/1027   RM0490 Rev 5  0x18  TIM15_CCMR1  Output Compare mode Res. Res. Res. Res. Res. Res. Res. OC2M[3] Res. Res. Res. Res. Res. Res. Res. OC1M[3] Res.   OC2M [2:0] OC2PE OC2FE CC2S [1:0] Res.   OC1M [2:0] OC1PE OC1FE CC1S [1:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0  TIM15_CCMR1  Input Capture mode Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. IC2F[3:0] IC2 PSC [1:0] CC2S [1:0]   IC1F[3:0] IC1 PSC [1:0] CC1S [1:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x20  TIM15_CCER  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CC2NP Res. CC2P CC2E CC1NP CC1NE CC1P CC1E Reset value   0   0   0   0   0   0   0 0x24  TIM15_CNT  UIFCPY or Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CNT[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x28  TIM15_PSC  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PSC[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x2C  TIM15_ARR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. ARR[15:0] Reset value   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 0x30  TIM15_RCR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. REP[7:0] Reset value   0   0   0   0   0   0   0   0 0x34  TIM15_CCR1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CCR1[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x38  TIM15_CCR2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CCR2[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x44  TIM15_BDTR  Res. Res. Res. BKBID Res. BKDSRM Res. Res. Res. Res. Res. Res. BKF[3:0] MOE AOE BKP BKE OSSR OSSI   LOCK [1:0]   DTG[7:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x48  TIM15_DCR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DBL[4:0] Res. Res. Res. DBA[4:0] Reset value   0   0   0   0   0   0   0   0   0   0  Table 92. TIM15 register map and reset values (continued) Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

RM0490 Rev 5   607/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Refer to   Section 2.2 on page 45   for the register boundary addresses. 0x4C  TIM15_DMAR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DMAB[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x60  TIM15_AF1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. BKINP Res. Res. Res. Res. Res. Res. Res. Res. BKINE Reset value   0   1 0x68  TIM15_TISEL  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TI2SEL[3:0] Res. Res. Res. Res. TI1SEL[3:0] Reset value   0   0   0   0   0   0   0   0  Table 92. TIM15 register map and reset values (continued) Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  608/1027   RM0490 Rev 5  20.6   TIM16/TIM17 registers  Refer to   Section 1.2   for a list of abbreviations used in register descriptions. The peripheral registers can be accessed by half-words (16-bit) or words (32-bit).  20.6.1   TIMx control register 1 (TIMx_CR1)(x = 16 to 17)  Address offset: 0x00 Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   UIFRE MAP   Res.   CKD[1:0]   ARPE   Res.   Res.   Res.   OPM   URS   UDIS   CEN rw   rw   rw   rw   rw   rw   rw   rw Bits 15:12   Reserved, must be kept at reset value. Bit 11   UIFREMAP : UIF status bit remapping 0: No remapping. UIF status bit is not copied to TIMx_CNT register bit 31. 1: Remapping enabled. UIF status bit is copied to TIMx_CNT register bit 31. Bit 10   Reserved, must be kept at reset value. Bits 9:8   CKD[1:0] : Clock division This bit-field indicates the division ratio between the timer clock (CK_INT) frequency and the dead-time and sampling clock (t DTS )used by the dead-time generators and the digital filters (TIx), 00: t DTS   = t   CK_INT 01: t DTS   = 2 * t   CK_INT 10: t DTS   = 4 * t   CK_INT 11: Reserved, do not program this value Bit 7   ARPE : Auto-reload preload enable 0: TIMx_ARR register is not buffered 1: TIMx_ARR register is buffered Bits 6:4   Reserved, must be kept at reset value. Bit 3   OPM : One pulse mode 0: Counter is not stopped at update event 1: Counter stops counting at the next update event (clearing the bit CEN) Bit 2   URS :   Update request source This bit is set and cleared by software to select the UEV event sources. 0: Any of the following events generate an update interrupt or DMA request if enabled. These events can be: –   Counter overflow/underflow –   Setting the UG bit –   Update generation through the slave mode controller 1: Only counter overflow/underflow generates an update interrupt or DMA request if enabled.

RM0490 Rev 5   609/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.6.2   TIMx control register 2 (TIMx_CR2)(x = 16 to 17)  Address offset: 0x04 Reset value: 0x0000 Bit 1   UDIS :   Update disable This bit is set and cleared by software to enable/disable UEV event generation. 0: UEV enabled. The Update (UEV) event is generated by one of the following events: –   Counter overflow/underflow –   Setting the UG bit –   Update generation through the slave mode controller Buffered registers are then loaded with their preload values. 1: UEV disabled. The Update event is not generated, shadow registers keep their value (ARR, PSC, CCRx). However the counter and the prescaler are reinitialized if the UG bit is set or if a hardware reset is received from the slave mode controller. Bit 0   CEN : Counter enable 0: Counter disabled 1: Counter enabled  Note:   External clock and gated mode can work only if the CEN bit has been previously set by software. However trigger mode can set the CEN bit automatically by hardware.  15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   OIS1N   OIS1   Res.   Res.   Res.   Res.   CCDS   CCUS   Res.   CCPC rw   rw   rw   rw   rw Bits 15:10   Reserved, must be kept at reset value. Bit 9   OIS1N : Output Idle state 1 (OC1N output) 0: OC1N=0 after a dead-time when MOE=0 1: OC1N=1 after a dead-time when MOE=0  Note:   This bit can not be modified as long as LOCK level 1, 2 or 3 has been programmed (LOCK bits in TIMx_BDTR register).  Bit 8   OIS1 : Output Idle state 1 (OC1 output) 0: OC1=0 (after a dead-time if OC1N is implemented) when MOE=0 1: OC1=1 (after a dead-time if OC1N is implemented) when MOE=0  Note:   This bit can not be modified as long as LOCK level 1, 2 or 3 has been programmed (LOCK bits in TIMx_BDTR register).  Bits 7:4   Reserved, must be kept at reset value. Bit 3   CCDS : Capture/compare DMA selection 0: CCx DMA request sent when CCx event occurs 1: CCx DMA requests sent when update event occurs Bit 2   CCUS :   Capture/compare control update selection 0: When capture/compare control bits are preloaded (CCPC=1), they are updated by setting the COMG bit only. 1: When capture/compare control bits are preloaded (CCPC=1), they are updated by setting the COMG bit or when an rising edge occurs on TRGI.  Note:   This bit acts only on channels that have a complementary output.  Bit 1   Reserved, must be kept at reset value.

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  610/1027   RM0490 Rev 5  20.6.3   TIMx DMA/interrupt enable register (TIMx_DIER)(x = 16 to 17)  Address offset: 0x0C Reset value: 0x0000 Bit 0   CCPC : Capture/compare preloaded control 0: CCxE, CCxNE and OCxM bits are not preloaded 1: CCxE, CCxNE and OCxM bits are preloaded, after having been written, they are updated only when COM bit is set.  Note:   This bit acts only on channels that have a complementary output.  15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   CC1DE   UDE   BIE   Res.   COMIE   Res.   Res.   Res.   CC1IE   UIE rw   rw   rw   rw   rw   rw Bits 15:10   Reserved, must be kept at reset value. Bit 9   CC1DE : Capture/Compare 1 DMA request enable 0: CC1 DMA request disabled 1: CC1 DMA request enabled Bit 8   UDE : Update DMA request enable 0: Update DMA request disabled 1: Update DMA request enabled Bit 7   BIE : Break interrupt enable 0: Break interrupt disabled 1: Break interrupt enabled Bit 6   Reserved, must be kept at reset value. Bit 5   COMIE:   COM interrupt enable 0: COM interrupt disabled 1: COM interrupt enabled Bits 4:2   Reserved, must be kept at reset value. Bit 1   CC1IE : Capture/Compare 1 interrupt enable 0: CC1 interrupt disabled 1: CC1 interrupt enabled Bit 0   UIE : Update interrupt enable 0: Update interrupt disabled 1: Update interrupt enabled

RM0490 Rev 5   611/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.6.4   TIMx status register (TIMx_SR)(x = 16 to 17)  Address offset: 0x10 Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   CC1OF   Res.   BIF   Res.   COMIF   Res.   Res.   Res.   CC1IF   UIF rc_w0   rc_w0   rc_w0   rc_w0   rc_w0 Bits 15:10   Reserved, must be kept at reset value. Bit 9   CC1OF : Capture/Compare 1 overcapture flag This flag is set by hardware only when the corresponding channel is configured in input capture mode. It is cleared by software by writing it to ‘0’. 0: No overcapture has been detected 1: The counter value has been captured in TIMx_CCR1 register while CC1IF flag was already set Bit 8   Reserved, must be kept at reset value. Bit 7   BIF : Break interrupt flag This flag is set by hardware as soon as the break input goes active. It can be cleared by software if the break input is not active. 0: No break event occurred 1: An active level has been detected on the break input Bit 6   Reserved, must be kept at reset value. Bit 5   COMIF:   COM interrupt flag This flag is set by hardware on a COM event (once the capture/compare control bits –CCxE, CCxNE, OCxM– have been updated). It is cleared by software. 0: No COM event occurred 1: COM interrupt pending Bits 4:2   Reserved, must be kept at reset value. Bit 1   CC1IF : Capture/Compare 1 interrupt flag This flag is set by hardware. It is cleared by software (input capture or output compare mode) or by reading the TIMx_CCR1 register (input capture mode only). 0: No compare match / No input capture occurred 1: A compare match or an input capture occurred  If channel CC1 is configured as output : this flag is set when the content of the counter TIMx_CNT matches the content of the TIMx_CCR1 register. When the content of TIMx_CCR1 is greater than the content of TIMx_ARR, the CC1IF bit goes high on the counter overflow (in up-counting and up/down-counting modes) or underflow (in down- counting mode). There are 3 possible options for flag setting in center-aligned mode, refer to the CMS bits in the TIMx_CR1 register for the full description.  If channel CC1 is configured as input : this bit is set when counter value has been captured in TIMx_CCR1 register (an edge has been detected on IC1, as per the edge sensitivity defined with the CC1P and CC1NP bits setting, in TIMx_CCER).

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  612/1027   RM0490 Rev 5  20.6.5   TIMx event generation register (TIMx_EGR)(x = 16 to 17)  Address offset: 0x14 Reset value: 0x0000 Bit 0   UIF : Update interrupt flag This bit is set by hardware on an update event. It is cleared by software. 0: No update occurred. 1: Update interrupt pending. This bit is set by hardware when the registers are updated: –   At overflow regarding the repetition counter value (update if repetition counter = 0) and if the UDIS=0 in the TIMx_CR1 register. –   When CNT is reinitialized by software using the UG bit in TIMx_EGR register, if URS=0 and UDIS=0 in the TIMx_CR1 register. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   BG   Res.   COMG   Res.   Res.   Res.   CC1G   UG w   w   w   w Bits 15:8   Reserved, must be kept at reset value. Bit 7   BG : Break generation This bit is set by software in order to generate an event, it is automatically cleared by hardware. 0: No action. 1: A break event is generated. MOE bit is cleared and BIF flag is set. Related interrupt or DMA transfer can occur if enabled. Bit 6   Reserved, must be kept at reset value. Bit 5   COMG:   Capture/Compare control update generation This bit can be set by software, it is automatically cleared by hardware. 0: No action 1: When the CCPC bit is set, it is possible to update the CCxE, CCxNE and OCxM bits  Note:   This bit acts only on channels that have a complementary output.  Bits 4:2   Reserved, must be kept at reset value. Bit 1   CC1G : Capture/Compare 1 generation This bit is set by software in order to generate an event, it is automatically cleared by hardware. 0: No action. 1: A capture/compare event is generated on channel 1:  If channel CC1 is configured as output:  CC1IF flag is set, Corresponding interrupt or DMA request is sent if enabled.  If channel CC1 is configured as input:  The current value of the counter is captured in TIMx_CCR1 register. The CC1IF flag is set, the corresponding interrupt or DMA request is sent if enabled. The CC1OF flag is set if the CC1IF flag was already high. Bit 0   UG : Update generation This bit can be set by software, it is automatically cleared by hardware. 0: No action. 1: Reinitialize the counter and generates an update of the registers. Note that the prescaler counter is cleared too (anyway the prescaler ratio is not affected).

RM0490 Rev 5   613/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.6.6   TIMx capture/compare mode register 1 (TIMx_CCMR1)(x = 16 to 17)  Address offset: 0x18 Reset value: 0x0000 0000 The same register can be used for input capture mode (this section) or for output compare mode (next section). The direction of a channel is defined by configuring the corresponding CCxS bits. All the other bits of this register have a different function in input and in output mode.  Input capture mode:  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   IC1F[3:0]   IC1PSC[1:0]   CC1S[1:0] rw   rw   rw   rw   rw   rw   rw   rw Bits 31:8   Reserved, must be kept at reset value. Bits 7:4   IC1F[3:0] :   Input capture 1 filter This bit-field defines the frequency used to sample TI1 input and the length of the digital filter applied to TI1. The digital filter is made of an event counter in which N consecutive events are needed to validate a transition on the output: 0000: No filter, sampling is done at f DTS 0001: f SAMPLING   =f   CK_INT   , N=2 0010: f SAMPLING   =f   CK_INT   , N=4 0011: f SAMPLING =f   CK_INT   , N=8 0100: f SAMPLING   =f   DTS   /2, N= 0101: f SAMPLING   =f   DTS   /2, N=8 0110: f SAMPLING =f   DTS   /4, N=6 0111: f SAMPLING =f DTS   /4, N=8 1000: f SAMPLING   =f   DTS   /8, N=6 1001: f SAMPLING   =f   DTS   /8, N=8 1010: f SAMPLING   =f   DTS   /16, N=5 1011: f SAMPLING =f   DTS   /16, N=6 1100: f SAMPLING =f   DTS   /16, N=8 1101: f SAMPLING =f   DTS   /32, N=5 1110: f SAMPLING =f DTS   /32, N=6 1111: f SAMPLING =f DTS /32, N=8 Bits 3:2   IC1PSC[1:0] :   Input capture 1 prescaler This bit-field defines the ratio of the prescaler acting on CC1 input (IC1). The prescaler is reset as soon as CC1E=’0’ (TIMx_CCER register). 00: no prescaler, capture is done each time an edge is detected on the capture input. 01: capture is done once every 2 events 10: capture is done once every 4 events 11: capture is done once every 8 events

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  614/1027   RM0490 Rev 5  20.6.7   TIMx capture/compare mode register 1 [alternate] (TIMx_CCMR1)(x = 16 to 17)  Address offset: 0x18 Reset value: 0x0000 0000 The same register can be used for output compare mode (this section) or for input capture mode (previous section). The direction of a channel is defined by configuring the corresponding CCxS bits. All the other bits of this register have a different function in input and in output mode.  Output compare mode:  Bits 1:0   CC1S[1:0] : Capture/Compare 1 Selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC1 channel is configured as output 01: CC1 channel is configured as input, IC1 is mapped on TI1 Others: Reserved  Note:   CC1S bits are writable only when the channel is OFF (CC1E = ‘0’ in TIMx_CCER).  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC1M [3] rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   OC1M[2:0]   OC1PE   OC1FE   CC1S[1:0] rw   rw   rw   rw   rw   rw   rw Bits 31:17   Reserved, must be kept at reset value. Bits 15:7   Reserved, must be kept at reset value.

RM0490 Rev 5   615/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Bits 16, 6:4   OC1M[3:0] : Output Compare 1 mode These bits define the behavior of the output reference signal OC1REF from which OC1 and OC1N are derived. OC1REF is active high whereas OC1 and OC1N active level depends on CC1P and CC1NP bits. 0000: Frozen - The comparison between the output compare register TIMx_CCR1 and the counter TIMx_CNT has no effect on the outputs. This mode can be used when the timer serves as a software timebase. When the frozen mode is enabled during timer operation, the output keeps the state (active or inactive) it had before entering the frozen state. 0001: Set channel 1 to active level on match. OC1REF signal is forced high when the counter TIMx_CNT matches the capture/compare register 1 (TIMx_CCR1). 0010: Set channel 1 to inactive level on match. OC1REF signal is forced low when the counter TIMx_CNT matches the capture/compare register 1 (TIMx_CCR1). 0011: Toggle - OC1REF toggles when TIMx_CNT=TIMx_CCR1. 0100: Force inactive level - OC1REF is forced low. 0101: Force active level - OC1REF is forced high. 0110: PWM mode 1 - Channel 1 is active as long as TIMx_CNT<TIMx_CCR1 else inactive. 0111: PWM mode 2 - Channel 1 is inactive as long as TIMx_CNT<TIMx_CCR1 else active. All other values: Reserved  Note:   These bits can not be modified as long as LOCK level 3 has been programmed (LOCK bits in TIMx_BDTR register) and CC1S=’00’ (the channel is configured in output). In PWM mode 1 or 2, the OCREF level changes only when the result of the comparison changes or when the output compare mode switches from “frozen” mode to “PWM” mode. The OC1M[3] bit is not contiguous, located in bit 16.  Bit 3   OC1PE : Output Compare 1 preload enable 0: Preload register on TIMx_CCR1 disabled. TIMx_CCR1 can be written at anytime, the new value is taken in account immediately. 1: Preload register on TIMx_CCR1 enabled. Read/Write operations access the preload register. TIMx_CCR1 preload value is loaded in the active register at each update event.  Note:   These bits can not be modified as long as LOCK level 3 has been programmed (LOCK bits in TIMx_BDTR register) and CC1S=’00’ (the channel is configured in output).  Bit 2   OC1FE : Output Compare 1 fast enable This bit decreases the latency between a trigger event and a transition on the timer output. It must be used in one-pulse mode (OPM bit set in TIMx_CR1 register), to have the output pulse starting as soon as possible after the starting trigger. 0: CC1 behaves normally depending on counter and CCR1 values even when the trigger is ON. The minimum delay to activate CC1 output when an edge occurs on the trigger input is 5 clock cycles. 1: An active edge on the trigger input acts like a compare match on CC1 output. Then, OC is set to the compare level independently of the result of the comparison. Delay to sample the trigger input and to activate CC1 output is reduced to 3 clock cycles. OC1FE acts only if the channel is configured in PWM1 or PWM2 mode. Bits 1:0   CC1S[1:0] : Capture/Compare 1 selection This bit-field defines the direction of the channel (input/output) as well as the used input. 00: CC1 channel is configured as output 01: CC1 channel is configured as input, IC1 is mapped on TI1 Others: Reserved  Note:   CC1S bits are writable only when the channel is OFF (CC1E = ‘0’ in TIMx_CCER).

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  616/1027   RM0490 Rev 5  20.6.8   TIMx capture/compare enable register (TIMx_CCER)(x = 16 to 17)  Address offset: 0x20 Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CC1NP   CC1NE   CC1P   CC1E rw   rw   rw   rw Bits 15:4   Reserved, must be kept at reset value. Bit 3   CC1NP : Capture/Compare 1 complementary output polarity CC1 channel configured as output: 0: OC1N active high 1: OC1N active low CC1 channel configured as input: This bit is used in conjunction with CC1P to define the polarity of TI1FP1 and TI2FP1. Refer to the description of CC1P.  Note:   This bit is not writable as soon as LOCK level 2 or 3 has been programmed (LOCK bits in TIMx_BDTR register) and CC1S=”00” (the channel is configured in output). On channels that have a complementary output, this bit is preloaded. If the CCPC bit is set in the TIMx_CR2 register then the CC1NP active bit takes the new value from the preloaded bit only when a commutation event is generated.

RM0490 Rev 5   617/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Bit 2   CC1NE : Capture/Compare 1 complementary output enable 0: Off - OC1N is not active. OC1N level is then function of MOE, OSSI, OSSR, OIS1, OIS1N and CC1E bits. 1: On - OC1N signal is output on the corresponding output pin depending on MOE, OSSI, OSSR, OIS1, OIS1N and CC1E bits. Bit 1   CC1P : Capture/Compare 1 output polarity 0: OC1 active high (output mode) / Edge sensitivity selection (input mode, see below) 1: OC1 active low (output mode) / Edge sensitivity selection (input mode, see below)  When CC1 channel is configured as input , both CC1NP/CC1P bits select the active polarity of TI1FP1 and TI2FP1 for trigger or capture operations. CC1NP=0, CC1P=0: non-inverted/rising edge. The circuit is sensitive to TIxFP1 rising edge (capture or trigger operations in reset, external clock or trigger mode), TIxFP1 is not inverted (trigger operation in gated mode or encoder mode). CC1NP=0, CC1P=1: inverted/falling edge. The circuit is sensitive to TIxFP1 falling edge (capture or trigger operations in reset, external clock or trigger mode), TIxFP1 is inverted (trigger operation in gated mode or encoder mode). CC1NP=1, CC1P=1: non-inverted/both edges/ The circuit is sensitive to both TIxFP1 rising and falling edges (capture or trigger operations in reset, external clock or trigger mode), TIxFP1is not inverted (trigger operation in gated mode). This configuration must not be used in encoder mode. CC1NP=1, CC1P=0: this configuration is reserved, it must not be used.  Note:   This bit is not writable as soon as LOCK level 2 or 3 has been programmed (LOCK bits in TIMx_BDTR register). On channels that have a complementary output, this bit is preloaded. If the CCPC bit is set in the TIMx_CR2 register then the CC1P active bit takes the new value from the preloaded bit only when a Commutation event is generated.  Bit 0   CC1E : Capture/Compare 1 output enable 0: Capture mode disabled / OC1 is not active (see below) 1: Capture mode enabled / OC1 signal is output on the corresponding output pin  When CC1 channel is configured as output , the OC1 level depends on MOE, OSSI, OSSR, OIS1, OIS1N and CC1NE bits, regardless of the CC1E bits state. Refer to   Table 93  for details.

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  618/1027   RM0490 Rev 5  Note:   The state of the external I/O pins connected to the complementary OCx and OCxN channels depends on the OCx and OCxN channel state and GPIO control and alternate function registers.  20.6.9   TIMx counter (TIMx_CNT)(x = 16 to 17)  Address offset: 0x24  Table 93. Output control bits for complementary OCx and OCxN channels with break feature (TIM16/17) Control bits   Output states   (1) MOE bit OSSI bit OSSR bit CCxE bit CCxNE bit   OCx output state   OCxN output state  1   X X   0   0 Output Disabled (not driven by the timer: Hi-Z) OCx=0 OCxN=0, OCxN_EN=0 0   0   1 Output Disabled (not driven by the timer: Hi-Z) OCx=0 OCxREF + Polarity OCxN=OCxREF XOR CCxNP 0   1   0   OCxREF + Polarity OCx=OCxREF XOR CCxP Output Disabled (not driven by the timer: Hi-Z) OCxN=0 X   1   1   OCREF + Polarity + dead- time Complementary to OCREF (not OCREF) + Polarity + dead-time 1   0   1 Off-State (output enabled with inactive state) OCx=CCxP OCxREF + Polarity OCxN=OCxREF XOR CCxNP 1   1   0 OCxREF + Polarity OCx=OCxREF XOR CCxP, OCx_EN=1 Off-State (output enabled with inactive state) OCxN=CCxNP, OCxN_EN=1 0 0 X X   X   Output disabled (not driven by the timer: Hi-Z). 1 0   0 0   1   Off-State (output enabled with inactive state) Asynchronously: OCx=CCxP, OCxN=CCxNP Then if the clock is present: OCx=OISx and OCxN=OISxN after a dead-time, assuming that OISx and OISxN do not correspond to OCX and OCxN both in active state 1   0 1   1 1.   When both outputs of a channel are not used (control taken over by GPIO controller), the OISx, OISxN, CCxP and CCxNP bits must be kept cleared.

RM0490 Rev 5   619/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Reset value: 0x0000 0000  20.6.10   TIMx prescaler (TIMx_PSC)(x = 16 to 17)  Address offset: 0x28 Reset value: 0x0000  20.6.11   TIMx auto-reload register (TIMx_ARR)(x = 16 to 17)  Address offset: 0x2C Reset value: 0xFFFF 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 UIF CPY   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CNT[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 31   UIFCPY : UIF Copy This bit is a read-only copy of the UIF bit of the TIMx_ISR register. If the UIFREMAP bit in TIMx_CR1 is reset, bit 31 is reserved and read as 0. Bits 30:16   Reserved, must be kept at reset value. Bits 15:0   CNT[15:0] : Counter value 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 PSC[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   PSC[15:0] : Prescaler value The counter clock frequency (CK_CNT) is equal to f CK_PSC   / (PSC[15:0] + 1). PSC contains the value to be loaded in the active prescaler register at each update event (including when the counter is cleared through UG bit of TIMx_EGR register or through trigger controller when configured in “reset mode”). 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ARR[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   ARR[15:0] : Auto-reload value ARR is the value to be loaded in the actual auto-reload register. Refer to the   Section 20.4.1: Time-base unit on page 547   for more details about ARR update and behavior. The counter is blocked while the auto-reload value is null.

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  620/1027   RM0490 Rev 5  20.6.12   TIMx repetition counter register (TIMx_RCR)(x = 16 to 17)  Address offset: 0x30 Reset value: 0x0000  20.6.13   TIMx capture/compare register 1 (TIMx_CCR1)(x = 16 to 17)  Address offset: 0x34 Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   REP[7:0] rw   rw   rw   rw   rw   rw   rw   rw Bits 15:8   Reserved, must be kept at reset value. Bits 7:0   REP[7:0] : Repetition counter value These bits allow the user to set-up the update rate of the compare registers (i.e. periodic transfers from preload to active registers) when preload registers are enable, as well as the update interrupt generation rate, if this interrupt is enable. Each time the REP_CNT related downcounter reaches zero, an update event is generated and it restarts counting from REP value. As REP_CNT is reloaded with REP value only at the repetition update event U_RC, any write to the TIMx_RCR register is not taken in account until the next repetition update event. It means in PWM mode (REP+1) corresponds to the number of PWM periods in edge- aligned mode. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CCR1[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   CCR1[15:0] : Capture/Compare 1 value  If channel CC1 is configured as output : CCR1 is the value to be loaded in the actual capture/compare 1 register (preload value). It is loaded permanently if the preload feature is not selected in the TIMx_CCMR1 register (bit OC1PE). Else the preload value is copied in the active capture/compare 1 register when an update event occurs. The active capture/compare register contains the value to be compared to the counter TIMx_CNT and signaled on OC1 output.  If channel CC1 is configured as input : CCR1 is the counter value transferred by the last input capture 1 event (IC1).

RM0490 Rev 5   621/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.6.14   TIMx break and dead-time register (TIMx_BDTR)(x = 16 to 17)  Address offset: 0x44 Reset value: 0x0000 0000  Note:   As the BKBID, BKDSRM, BKF[3:0], AOE, BKP, BKE, OSSI, OSSR and DTG[7:0] bits may be write-locked depending on the LOCK configuration, it may be necessary to configure all of them during the first write access to the TIMx_BDTR register.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   BKBID   Res.   BK DSRM   Res.   Res.   Res.   Res.   Res.   Res.   BKF[3:0] rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 MOE   AOE   BKP   BKE   OSSR   OSSI   LOCK[1:0]   DTG[7:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:29   Reserved, must be kept at reset value. Bit 28   BKBID : Break Bidirectional 0: Break input BRK in input mode 1: Break input BRK in bidirectional mode In the bidirectional mode (BKBID bit set to 1), the break input is configured both in input mode and in open drain output mode. Any active break event asserts a low logic level on the Break input to indicate an internal break event to external devices.  Note:   This bit cannot be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register). Note:   Any write operation to this bit takes a delay of 1 APB clock cycle to become effective.  Bit 27   Reserved, must be kept at reset value. Bit 26   BKDSRM : Break Disarm 0: Break input BRK is armed 1: Break input BRK is disarmed This bit is cleared by hardware when no break source is active. The BKDSRM bit must be set by software to release the bidirectional output control (open- drain output in Hi-Z state) and then be polled it until it is reset by hardware, indicating that the fault condition has disappeared.  Note:   Any write operation to this bit takes a delay of 1 APB clock cycle to become effective.

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  622/1027   RM0490 Rev 5  Bits 25:20   Reserved, must be kept at reset value. Bits 19:16   BKF[3:0] :   Break filter This bit-field defines the frequency used to sample BRK input and the length of the digital filter applied to BRK. The digital filter is made of an event counter in which N events are needed to validate a transition on the output: 0000: No filter, BRK acts asynchronously 0001: f SAMPLING =f CK_INT , N=2 0010: f SAMPLING =f CK_INT , N=4 0011: f   SAMPLING =f CK_INT , N=8 0100: f SAMPLING =f DTS /2, N=6 0101: f SAMPLING =f DTS /2, N=8 0110: f   SAMPLING =f DTS /4, N=6 0111: f SAMPLING   =f DTS /4, N=8 1000: f SAMPLING =f DTS /8, N=6 1001: f SAMPLING =f DTS /8, N=8 1010: f SAMPLING =f DTS /16, N=5 1011: f   SAMPLING =f DTS /16, N=6 1100: f   SAMPLING =f DTS /16, N=8 1101: f   SAMPLING =f DTS /32, N=5 1110: f SAMPLING   =f DTS /32, N=6 1111: f SAMPLING =f   DTS /32, N=8 This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register). Bit 15   MOE : Main output enable This bit is cleared asynchronously by hardware as soon as the break input is active. It is set by software or automatically depending on the AOE bit. It is acting only on the channels which are configured in output. 0: OC and OCN outputs are disabled or forced to idle state depending on the OSSI bit. 1: OC and OCN outputs are enabled if their respective enable bits are set (CCxE, CCxNE in TIMx_CCER register) See OC/OCN enable description for more details ( Section 20.6.8: TIMx capture/compare enable register (TIMx_CCER)(x = 16 to 17) on page 616 ). Bit 14   AOE : Automatic output enable 0: MOE can be set only by software 1: MOE can be set by software or automatically at the next update event (if the break input is not be active)  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).  Bit 13   BKP : Break polarity 0: Break input BRK is active low 1: Break input BRK is active high  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register). Any write operation to this bit takes a delay of 1 APB clock cycle to become effective.  Bit 12   BKE : Break enable 0: Break inputs (BRK and CCS clock failure event) disabled 1; Break inputs (BRK and CCS clock failure event) enabled  Note:   This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register). Any write operation to this bit takes a delay of 1 APB clock cycle to become effective.

RM0490 Rev 5   623/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Bit 11   OSSR :   Off-state selection for Run mode This bit is used when MOE=1 on channels that have a complementary output which are configured as outputs. OSSR is not implemented if no complementary output is implemented in the timer. See OC/OCN enable description for more details ( Section 20.6.8: TIMx capture/compare enable register (TIMx_CCER)(x = 16 to 17) on page 616 ). 0: When inactive, OC/OCN outputs are disabled (the timer releases the output control which is taken over by the GPIO, which forces a Hi-Z state) 1: When inactive, OC/OCN outputs are enabled with their inactive level as soon as CCxE=1 or CCxNE=1 (the output is still controlled by the timer).  Note:   This bit can not be modified as soon as the LOCK level 2 has been programmed (LOCK bits in TIMx_BDTR register).  Bit 10   OSSI :   Off-state selection for Idle mode This bit is used when MOE=0 on channels configured as outputs. See OC/OCN enable description for more details ( Section 20.6.8: TIMx capture/compare enable register (TIMx_CCER)(x = 16 to 17) on page 616 ). 0: When inactive, OC/OCN outputs are disabled (OC/OCN enable output signal=0) 1: When inactive, OC/OCN outputs are forced first with their idle level as soon as CCxE=1 or CCxNE=1. OC/OCN enable output signal=1)  Note:   This bit can not be modified as soon as the LOCK level 2 has been programmed (LOCK bits in TIMx_BDTR register).  Bits 9:8   LOCK[1:0] : Lock configuration These bits offer a write protection against software errors. 00: LOCK OFF - No bit is write protected 01: LOCK Level 1 = DTG bits in TIMx_BDTR register, OISx and OISxN bits in TIMx_CR2 register and BKE/BKP/AOE bits in TIMx_BDTR register can no longer be written. 10: LOCK Level 2 = LOCK Level 1 + CC Polarity bits (CCxP/CCxNP bits in TIMx_CCER register, as long as the related channel is configured in output through the CCxS bits) as well as OSSR and OSSI bits can no longer be written. 11: LOCK Level 3 = LOCK Level 2 + CC Control bits (OCxM and OCxPE bits in TIMx_CCMRx registers, as long as the related channel is configured in output through the CCxS bits) can no longer be written.  Note:   The LOCK bits can be written only once after the reset. Once the TIMx_BDTR register has been written, their content is frozen until the next reset.  Bits 7:0   DTG[7:0] : Dead-time generator setup This bit-field defines the duration of the dead-time inserted between the complementary outputs. DT correspond to this duration. DTG[7:5] = 0xx => DT = DTG[7:0] x t   dtg   with t   dtg   = t   DTS DTG[7:5] = 10x => DT = (64 + DTG[5:0]) x t dtg   with t dtg   = 2 x t   DTS DTG[7:5] = 110 => DT = (32 + DTG[4:0]) x t dtg   with t   dtg   = 8 x t DTS DTG[7:5] = 111 => DT = (32 + DTG[4:0]) x t dtg   with t dtg   = 16 x t   DTS Example if t DTS   = 125 ns (8 MHz), dead-time possible values are: 0 to 15875 ns by 125 ns steps, 16 μs to 31750 ns by 250 ns steps, 32 μs to 63 μs by 1 μs steps, 64 μs to 126 μs by 2 μs steps  Note:   This bit-field can not be modified as long as LOCK level 1, 2 or 3 has been programmed (LOCK bits in TIMx_BDTR register).

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  624/1027   RM0490 Rev 5  20.6.15   TIMx DMA control register (TIMx_DCR)(x = 16 to 17)  Address offset: 0x48 Reset value: 0x0000  20.6.16   TIMx DMA address for full transfer (TIMx_DMAR)(x = 16 to 17)  Address offset: 0x4C Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   DBL[4:0]   Res.   Res.   Res.   DBA[4:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:13   Reserved, must be kept at reset value. Bits 12:8   DBL[4:0] : DMA burst length This 5-bit field defines the length of DMA transfers (the timer recognizes a burst transfer when a read or a write access is done to the TIMx_DMAR address), i.e. the number of transfers. Transfers can be in half-words or in bytes (see example below). 00000: 1 transfer, 00001: 2 transfers, 00010: 3 transfers, ... 10001: 18 transfers. Bits 7:5   Reserved, must be kept at reset value. Bits 4:0   DBA[4:0] : DMA base address This 5-bit field defines the base-address for DMA transfers (when read/write access are done through the TIMx_DMAR address). DBA is defined as an offset starting from the address of the TIMx_CR1 register. Example: 00000: TIMx_CR1, 00001: TIMx_CR2, 00010: TIMx_SMCR, ...  Example:   Let us consider the following transfer: DBL = 7 transfers and DBA = TIMx_CR1. In this case the transfer is done to/from 7 registers starting from the TIMx_CR1 address. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 DMAB[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   DMAB[15:0] : DMA register for burst accesses A read or write operation to the DMAR register accesses the register located at the address (TIMx_CR1 address) + (DBA + DMA index) x 4 where TIMx_CR1 address is the address of the control register 1, DBA is the DMA base address configured in TIMx_DCR register, DMA index is automatically controlled by the DMA transfer, and ranges from 0 to DBL (DBL configured in TIMx_DCR).

RM0490 Rev 5   625/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  20.6.17   TIM16 alternate function register 1 (TIM16_AF1)  Address offset: 0x60 Reset value: 0x0000 0001  20.6.18   TIM16 input selection register (TIM16_TISEL)  Address offset: 0x68 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   BKINP   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   BKINE rw   rw Bits 31:10   Reserved, must be kept at reset value. Bit 9   BKINP : BRK BKIN input polarity This bit selects the BKIN alternate function input sensitivity. It must be programmed together with the BKP polarity bit. 0: BKIN input is active low 1: BKIN input is active high  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).  Bits 8:1   Reserved, must be kept at reset value. Bit 0   BKINE : BRK BKIN input enable This bit enables the BKIN alternate function input for the timer’s BRK input. BKIN input is ‘ORed’ with the other BRK sources. 0: BKIN input disabled 1: BKIN input enabled  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TI1SEL[3:0] rw   rw   rw   rw Bits 31:4   Reserved, must be kept at reset value.

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  626/1027   RM0490 Rev 5  20.6.19   TIM17 alternate function register 1 (TIM17_AF1)  Address offset: 0x60 Reset value: 0x0000 0001  20.6.20   TIM17 input selection register (TIM17_TISEL)  Address offset: 0x68 Reset value: 0x0000 0000 Bits 3:0   TI1SEL[3:0] : selects TI1[0] to TI1[15] input 0000: TIM16_CH1 input 0001: LSI 0010: LSE 0011: Reserved 0100: MCO2 Others: Reserved 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   BKINP   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   BKINE rw   rw Bits 31:10   Reserved, must be kept at reset value. Bit 9   BKINP : BRK BKIN input polarity This bit selects the BKIN alternate function input sensitivity. It must be programmed together with the BKP polarity bit. 0: BKIN input is active low 1: BKIN input is active high  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).  Bits 8:1   Reserved, must be kept at reset value. Bit 0   BKINE : BRK BKIN input enable This bit enables the BKIN alternate function input for the timer’s BRK input. BKIN input is ‘ORed’ with the other BRK sources. 0: BKIN input disabled 1: BKIN input enabled  Note:   This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits in TIMx_BDTR register).  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TI1SEL[3:0] rw   rw   rw   rw

RM0490 Rev 5   627/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Bits 31:4   Reserved, must be kept at reset value. Bits 3:0   TI1SEL[3:0] : selects TI1[0] to TI1[15] input 0000: TIM17_CH1 input 0001: HSIUSB/256 on STM32C071xx, reserved on other devices 0010: HSE/32 0011: MCO 0100: MCO2 Others: Reserved

General-purpose timers (TIM15/TIM16/TIM17)   RM0490  628/1027   RM0490 Rev 5  20.6.21   TIM16/TIM17 register map  TIM16/TIM17 registers are mapped as 16-bit addressable registers as described in the table below:  Table 94. TIM16/TIM17 register map and reset values Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00  TIMx_CR1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. UIFREMA Res.   CKD [1:0] ARPE Res. Res. Res. OPM URS UDIS CEN Reset value   0   0   0   0   0   0   0   0 0x04  TIMx_CR2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. OIS1N OIS1 Res. Res. Res. Res. CCDS CCUS Res. CCPC Reset value   0   0   0   0   0 0x0C  TIMx_DIER  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CC1DE UDE BIE Res. COMIE Res. Res. Res. CC1IE UIE Reset value   0   0   0   0   0   0 0x10  TIMx_SR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CC1OF Res. BIF Res. COMIF Res. Res. Res. CC1IF UIF Reset value   0   0   0   0   0 0x14  TIMx_EGR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. BG Res. COMG Res. Res. Res. CC1G UG Reset value   0   0   0   0 0x18  TIMx_CCMR1  Output Compare mode Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. OC1M[3] Res. Res. Res. Res. Res. Res. Res. Res. Res.   OC1M [2:0] OC1PE OC1FE   CC1 S [1:0] Reset value   0   0   0   0   0   0   0   0  TIMx_CCMR1  Input Capture mode Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. IC1F[3:0] IC1 PSC [1:0] CC1 S [1:0] Reset value   0   0   0   0   0   0   0   0 0x20  TIMx_CCER  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CC1NP CC1NE CC1P CC1E Reset value   0   0   0   0 0x24  TIMx_CNT  UIFCPY or Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CNT[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x28  TIMx_PSC  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PSC[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x2C  TIMx_ARR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. ARR[15:0] Reset value   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1

RM0490 Rev 5   629/1027  RM0490   General-purpose timers (TIM15/TIM16/TIM17)  629  Refer to   Section 2.2 on page 45   for the register boundary addresses. 0x30  TIMx_RCR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. REP[7:0] Reset value   0   0   0   0   0   0   0   0 0x34  TIMx_CCR1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CCR1[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x44  TIMx_BDTR  Res. Res. Res. BKBID Res. BKDSRM Res. Res. Res. Res. Res. Res. BKF[3:0] MOE AOE BKP BKE OSSR OSSI   LOC K [1:0] DTG[7:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x48  TIMx_DCR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DBL[4:0] Res. Res. Res. DBA[4:0] Reset value   0   0   0   0   0   0   0   0   0   0 0x4C  TIMx_DMAR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DMAB[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x60  TIM16_AF1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. BKINP Res. Res. Res. Res. Res. Res. Res. Res. BKINE Reset value   0   1 0x60  TIM17_AF1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. BKINP Res. Res. Res. Res. Res. Res. Res. Res. BKINE Reset value   0   1 0x68  TIM16_TISEL  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TI1SEL[3:0] Reset value   0   0   0   0 0x68  TIM17_TISEL  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TI1SEL[3:0] Reset value   0   0   0   0  Table 94. TIM16/TIM17 register map and reset values (continued) Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

Infrared interface (IRTIM)   RM0490  630/1027   RM0490 Rev 5  21   Infrared interface (IRTIM)  An infrared interface (IRTIM) for remote control is available on the device. It can be used with an infrared LED to perform remote control functions. It uses internal connections with USART1, USART2, TIM16, and TIM17 as shown in  Figure 217 . To generate the infrared remote control signals, the IR interface must be enabled and TIM16 channel 1 (TIM16_OC1) and TIM17 channel 1 (TIM17_OC1) must be properly configured to generate correct waveforms. The infrared receiver can be implemented easily through a basic input capture mode.  Figure 217. IRTIM internal hardware connections with TIM16 and TIM17   .  All standard IR pulse modulation modes can be obtained by programming the two timer output compare channels. TIM17 is used to generate the high frequency carrier signal, while TIM16 or alternatively USART1 or USART42 generates the modulation envelope according to the setting of the IR_MOD[1:0] bits in the SYSCFG_CFGR1 register. The polarity of the output signal from IRTIM is controlled by the IR_POL bit in the SYSCFG_CFGR1 register and can be inverted by setting of this bit. The infrared function is output on the IR_OUT pin. The activation of this function is done through the GPIOx_AFRx register by enabling the related alternate function bit. The high sink LED driver capability (only available on the PB9 and PC14 pins) can be activated through the I2C_PB9_FMP bit and/or I2C_PC14_FMP bit in the SYSCFG_CFGR1 register and used to sink the high current needed to directly control an infrared LED.  MSv69040V1 TIM17_CH1 TIM16_CH1 IRTIM IR_OUT USART1 USART2 IR_MOD[1:0]   IR_POL

RM0490 Rev 5   631/1027  RM0490   Independent watchdog (IWDG)  639  22   Independent watchdog (IWDG) 22.1   Introduction  The devices feature an embedded watchdog peripheral (IWDG) that offers a combination of high safety level, timing accuracy, and flexibility of use. This peripheral detects and solves malfunctions due to software failure, and triggers a system reset when the counter reaches a given timeout value. The independent watchdog is clocked by its own dedicated low-speed clock (LSI), and stays active even if the main clock fails. The IWDG is best suited for applications that require the watchdog to run as a totally independent process outside the main application, but have lower timing accuracy constraints. For further information on the window watchdog, refer to   Section 23: System window watchdog (WWDG) .  22.2   IWDG main features  •   Free-running downcounter  •   Clocked from an independent RC oscillator (can operate in Standby and Stop modes)  •   Conditional reset –   Reset (if watchdog is activated) when the downcounter value becomes lower than 0x000 –   Reset (if watchdog is activated) if the downcounter is reloaded outside the window  22.3   IWDG functional description 22.3.1   IWDG block diagram  Figure 218   shows the functional blocks of the independent watchdog module.  Figure 218. Independent watchdog block diagram  1.   The register interface is located in the V DD   voltage domain. The watchdog function is located in the V   DD voltage domain, still functional in Stop and Standby modes.  MSv37838V2 IWDG reset LSI V DD V DD   voltage domain Prescaler register IWDG_PR Status register IWDG_SR Reload register IWDG_RLR Key register IWDG_KR 12-bit reload value 12-bit downcounter 8-bit prescaler

Independent watchdog (IWDG)   RM0490  632/1027   RM0490 Rev 5  When the independent watchdog is started by writing the value 0x0000 CCCC in the   IWDG key register (IWDG_KR) , the counter starts counting down from the reset value of 0xFFF. When it reaches the end of count value (0x000), a reset signal is generated (IWDG reset). Whenever the key value 0x0000 AAAA is written in the   IWDG key register (IWDG_KR) , the IWDG_RLR value is reloaded in the counter, and the watchdog reset is prevented. Once running, the IWDG cannot be stopped.  22.3.2   Window option  The IWDG can also work as a window watchdog by setting the appropriate window in the  IWDG window register (IWDG_WINR) . If the reload operation is performed while the counter is greater than the value stored in the  IWDG window register (IWDG_WINR) , a reset is provided. The default value of the   IWDG window register (IWDG_WINR)   is 0x0000 0FFF, so if it is not updated, the window option is disabled. As soon as the window value is changed, a reload operation is performed to reset the downcounter to the   IWDG reload register (IWDG_RLR)   value, and to ease the cycle number calculation to generate the next reload.  Configuring the IWDG when the window option is enabled  1.   Enable the IWDG by writing 0x0000 CCCC in the   IWDG key register (IWDG_KR) . 2.   Enable register access by writing 0x0000 5555 in the   IWDG key register (IWDG_KR) . 3.   Write the IWDG prescaler by programming   IWDG prescaler register (IWDG_PR)   from 0 to 7. 4.   Write the   IWDG reload register (IWDG_RLR) . 5.   Wait for the registers to be updated (IWDG_SR = 0x0000 0000). 6.   Write to the   IWDG window register (IWDG_WINR) . This automatically refreshes the counter value in the   IWDG reload register (IWDG_RLR) .  Note:   Writing the window value allows the counter value to be refreshed by the RLR when the IWDG status register (IWDG_SR) is set to 0x0000 0000.  Configuring the IWDG when the window option is disabled  When the window option is not used, the IWDG can be configured as follows: 1.   Enable the IWDG by writing 0x0000 CCCC in the   IWDG key register (IWDG_KR) . 2.   Enable register access by writing 0x0000 5555 in the   IWDG key register (IWDG_KR) . 3.   Write the prescaler by programming the   IWDG prescaler register (IWDG_PR)   from 0 to 7. 4.   Write the   IWDG reload register (IWDG_RLR) . 5.   Wait for the registers to be updated (IWDG_SR = 0x0000 0000). 6.   Refresh the counter value with IWDG_RLR (IWDG_KR = 0x0000 AAAA).

RM0490 Rev 5   633/1027  RM0490   Independent watchdog (IWDG)  639  22.3.3   Hardware watchdog  If this feature is enabled through the device option bits, the watchdog is automatically enabled at power-on, and generates a reset unless the   IWDG key register (IWDG_KR)   is written by the software before the counter reaches the end of count, and if the downcounter is lower than the window value (WIN[11:0]).  22.3.4   Register access protection  Write access to   IWDG prescaler register (IWDG_PR) ,   IWDG reload register (IWDG_RLR) , and   IWDG window register (IWDG_WINR)   is protected. To modify them, first write the code 0x0000 5555 in the   IWDG key register (IWDG_KR) . A write access to this register with a different value breaks the sequence, and register access is protected again. This is the case of the reload operation (writing 0x0000 AAAA). A status register is available to indicate that an update of the prescaler, or of the downcounter reload value, or of the window value, is ongoing.  22.3.5   Debug mode  When the device enters Debug mode (core halted), the IWDG counter either continues to work normally or stops, depending on the configuration of the corresponding bit in DBGMCU freeze register.

Independent watchdog (IWDG)   RM0490  634/1027   RM0490 Rev 5  22.4   IWDG registers  Refer to   Section 1.2 on page 41   for a list of abbreviations used in register descriptions. The peripheral registers can be accessed by half-words (16-bit) or words (32-bit).  22.4.1   IWDG key register (IWDG_KR)  Address offset: 0x00 Reset value: 0x0000 0000 (reset by Standby mode) 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 KEY[15:0] w   w   w   w   w   w   w   w   w   w   w   w   w   w   w   w Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   KEY[15:0]:   Key value (write only, read 0x0000) These bits must be written by software at regular intervals with the key value 0xAAAA, otherwise the watchdog generates a reset when the counter reaches 0. Writing the key value 0x5555 to enable access to the IWDG_PR, IWDG_RLR and IWDG_WINR registers (see   Section 22.3.4: Register access protection ) Writing the key value 0xCCCC starts the watchdog (except if the hardware watchdog option is selected)

RM0490 Rev 5   635/1027  RM0490   Independent watchdog (IWDG)  639  22.4.2   IWDG prescaler register (IWDG_PR)  Address offset: 0x04 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   PR[2:0] rw   rw   rw Bits 31:3   Reserved, must be kept at reset value. Bits 2:0   PR[2:0]:   Prescaler divider These bits are write access protected see   Section 22.3.4: Register access protection . They are written by software to select the prescaler divider feeding the counter clock. PVU bit of the   IWDG status register (IWDG_SR)   must be reset in order to be able to change the prescaler divider. 000: divider /4 001: divider /8 010: divider /16 011: divider /32 100: divider /64 101: divider /128 110: divider /256 111: divider /256  Note:   Reading this register returns the prescaler value from the V DD   voltage domain. This value may not be up to date/valid if a write operation to this register is ongoing. For this reason the value read from this register is valid only when the PVU bit in the IWDG status register (IWDG_SR) is reset.

Independent watchdog (IWDG)   RM0490  636/1027   RM0490 Rev 5  22.4.3   IWDG reload register (IWDG_RLR)  Address offset: 0x08 Reset value: 0x0000 0FFF (reset by Standby mode) 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   RL[11:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:12   Reserved, must be kept at reset value. Bits 11:0   RL[11:0]:   Watchdog counter reload value These bits are write access protected see   Register access protection . They are written by software to define the value to be loaded in the watchdog counter each time the value 0xAAAA is written in the   IWDG key register (IWDG_KR) . The watchdog counter counts down from this value. The timeout period is a function of this value and the clock prescaler. Refer to the datasheet for the timeout information. The RVU bit in the   IWDG status register (IWDG_SR)   must be reset to be able to change the reload value.  Note:   Reading this register returns the reload value from the V   DD   voltage domain. This value may not be up to date/valid if a write operation to this register is ongoing on it. For this reason the value read from this register is valid only when the RVU bit in the IWDG status register (IWDG_SR) is reset.

RM0490 Rev 5   637/1027  RM0490   Independent watchdog (IWDG)  639  22.4.4   IWDG status register (IWDG_SR)  Address offset: 0x0C Reset value: 0x0000 0000 (not reset by Standby mode)  Note:   If several reload, prescaler, or window values are used by the application, it is mandatory to wait until RVU bit is reset before changing the reload value, to wait until PVU bit is reset before changing the prescaler value, and to wait until WVU bit is reset before changing the window value. However, after updating the prescaler and/or the reload/window value it is not necessary to wait until RVU or PVU or WVU is reset before continuing code execution except in case of low-power mode entry.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   WVU   RVU   PVU r   r   r Bits 31:3   Reserved, must be kept at reset value. Bit 2   WVU:   Watchdog counter window value update This bit is set by hardware to indicate that an update of the window value is ongoing. It is reset by hardware when the reload value update operation is completed in the V   DD   voltage domain (takes up to five prescaled clock cycles). Window value can be updated only when WVU bit is reset. Bit 1   RVU:   Watchdog counter reload value update This bit is set by hardware to indicate that an update of the reload value is ongoing. It is reset by hardware when the reload value update operation is completed in the V   DD   voltage domain (takes up to five prescaled clock cycles). Reload value can be updated only when RVU bit is reset. Bit 0   PVU:   Watchdog prescaler value update This bit is set by hardware to indicate that an update of the prescaler value is ongoing. It is reset by hardware when the prescaler update operation is completed in the V   DD   voltage domain (takes up to five LSI clock cycles). Prescaler value can be updated only when PVU bit is reset.

Independent watchdog (IWDG)   RM0490  638/1027   RM0490 Rev 5  22.4.5   IWDG window register (IWDG_WINR)  Address offset: 0x10 Reset value: 0x0000 0FFF (reset by Standby mode) 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   WIN[11:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:12   Reserved, must be kept at reset value. Bits 11:0   WIN[11:0]:   Watchdog counter window value These bits are write access protected, see   Section 22.3.4 , they contain the high limit of the window value to be compared with the downcounter. To prevent a reset, the downcounter must be reloaded when its value is lower than the window register value and greater than 0x0 The WVU bit in the   IWDG status register (IWDG_SR)   must be reset in order to be able to change the reload value.  Note:   Reading this register returns the reload value from the V   DD   voltage domain. This value may not be valid if a write operation to this register is ongoing. For this reason the value read from this register is valid only when the WVU bit in the IWDG status register (IWDG_SR) is reset.

RM0490 Rev 5   639/1027  RM0490   Independent watchdog (IWDG)  639  22.4.6   IWDG register map  The following table gives the IWDG register map and reset values. Refer to   Section 2.2 on page 45   for the register boundary addresses.  Table 95. IWDG register map and reset values Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00  IWDG_KR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. KEY[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x04  IWDG_PR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PR[2:0] Reset value   0   0   0 0x08  IWDG_RLR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. RL[11:0] Reset value   1   1   1   1   1   1   1   1   1   1   1   1 0x0C  IWDG_SR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. WVU RVU PVU Reset value   0   0   0 0x10  IWDG_WINR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. WIN[11:0] Reset value   1   1   1   1   1   1   1   1   1   1   1   1

System window watchdog (WWDG)   RM0490  640/1027   RM0490 Rev 5  23   System window watchdog (WWDG) 23.1   Introduction  The system window watchdog (WWDG) is used to detect the occurrence of a software fault, usually generated by external interference or by unforeseen logical conditions, which causes the application program to abandon its normal sequence. The watchdog circuit generates an MCU reset on expiry of a programmed time period, unless the program refreshes the contents of the down-counter before the T6 bit is cleared. An MCU reset is also generated if the 7-bit down-counter value (in the control register) is refreshed before the down-counter reaches the window register value. This implies that the counter must be refreshed in a limited window. The WWDG clock is prescaled from the APB clock and has a configurable time window that can be programmed to detect abnormally late or early application behavior. The WWDG is best suited for applications requiring the watchdog to react within an accurate timing window.  23.2   WWDG main features  •   Programmable free-running down-counter  •   Conditional reset –   Reset (if watchdog activated) when the down-counter value becomes lower than 0x40 –   Reset (if watchdog activated) if the down-counter is reloaded outside the window (see   Figure 220 )  •   Early wake-up interrupt (EWI): triggered (if enabled and the watchdog activated) when the down-counter is equal to 0x40  23.3   WWDG functional description  If the watchdog is activated (the WDGA bit is set in the WWDG_CR register), and when the 7-bit down-counter (T[6:0] bits) is decremented from 0x40 to 0x3F (T6 becomes cleared), it initiates a reset. If the software reloads the counter while the counter is greater than the value stored in the window register, then a reset is generated. The application program must write in the WWDG_CR register at regular intervals during normal operation to prevent an MCU reset. This operation can take place only when the counter value is lower than or equal to the window register value, and higher than 0x3F. The value to be stored in the WWDG_CR register must be between 0xFF and 0xC0. Refer to   Figure 219   for the WWDG block diagram.

RM0490 Rev 5   641/1027  RM0490   System window watchdog (WWDG)  645  23.3.1   WWDG block diagram Figure 219. Watchdog block diagram 23.3.2   Enabling the watchdog  When the user option WWDG_SW selects “Software window watchdog”, the watchdog is always disabled after a reset. It is enabled by setting the WDGA bit in the WWDG_CR register, then it cannot be disabled again, except by a reset. When the user option WWDG_SW selects “Hardware window watchdog”, the watchdog is always enabled after a reset, it cannot be disabled.  23.3.3   Controlling the down-counter  This down-counter is free-running, counting down even if the watchdog is disabled. When the watchdog is enabled, the T6 bit must be set to prevent generating an immediate reset. The T[5:0] bits contain the number of increments that represent the time delay before the watchdog produces a reset. The timing varies between a minimum and a maximum value, due to the unknown status of the prescaler when writing to the WWDG_CR register (see  Figure 220 ). The   WWDG configuration register (WWDG_CFR)   contains the high limit of the window: to prevent a reset, the down-counter must be reloaded when its value is lower than or equal to the window register value, and greater than 0x3F.   Figure 220   describes the window watchdog process.  Note:   The T6 bit can be used to generate a software reset (the WDGA bit is set and the T6 bit is cleared).  23.3.4   How to program the watchdog timeout  Use the formula in   Figure 220   to calculate the WWDG timeout.  MS47214V2 WWDG 7-bit down-counter (CNT)  pclk   APB bus  ÷ 4096   ÷ 2 WDGTB  Write to WWDG_CR CMP = 1 when T[6:0] > W[6:0]  CMP  preload  WWDG_CR wwdg_out_rst wwdg_it = 0x40 ?  readback  WWDG_CFR   W[6:0] cnt_out  Register interface WWDG_SR  T6 T[6:0] WDGA EWI  Logic  EWIF

System window watchdog (WWDG)   RM0490  642/1027   RM0490 Rev 5  Warning:   When writing to the WWDG_CR register, always write 1 in the T6 bit to avoid generating an immediate reset. Figure 220. Window watchdog timing diagram  The formula to calculate the timeout value is given by: where:  •   t WWDG : WWDG timeout  •   t PCLK : APB clock period measured in ms  •   4096: value corresponding to internal divider As an example, if APB frequency is 48 MHz, WDGTB[2:0] is set to 3, and T[5:0] is set to 63: Refer to the datasheet for the minimum and maximum values of t WWDG .  MS47266V1 W[6:0] 0x3F 0x41 0x40 0x3F wwdg_ewit wwdg_rst Refresh not allowed   Refresh allowed Time T[6:0] T pclk   x 4096 x 2   WDGTB CNT down-counter T6 bit EWIF = 0  t WWDG   t PCLK   4096   2 WDGTB[2:0]   T 5:0 [   ]   1 + (   ) × × × =   ms (   )  t WWDG   1   48000 ⁄ (   )   4096   2 3  × ×   63   1 + (   ) ×   43.69ms =   =

RM0490 Rev 5   643/1027  RM0490   System window watchdog (WWDG)  645  23.3.5   Debug mode  When the device enters debug mode (processor halted), the WWDG counter either continues to work normally or stops, depending on the configuration bit in DBG module. For more details, refer to   Section 30: Debug support (DBG) .  23.4   WWDG interrupts  The early wake-up interrupt (EWI) can be used if specific safety operations or data logging must be performed before the reset is generated. To enable the early wake-up interrupt, the application must:  •   Write EWIF bit of WWDG_SR register to 0, to clear unwanted pending interrupt  •   Write EWI bit of WWDG_CFR register to 1, to enable interrupt When the down-counter reaches the value 0x40, a watchdog interrupt is generated, and the corresponding interrupt service routine (ISR) can be used to trigger specific actions (such as communications or data logging), before resetting the device. In some applications, the EWI interrupt can be used to manage a software system check and/or system recovery/graceful degradation, without generating a WWDG reset. In this case the corresponding ISR must reload the WWDG counter to avoid the WWDG reset, then trigger the required actions. The watchdog interrupt is cleared by writing 0 to the EWIF bit in the WWDG_SR register.  Note:   When the watchdog interrupt cannot be served (for example due to a system lock in a higher priority task), the WWDG reset is eventually generated.  23.5   WWDG registers  Refer to   Section 1.2: List of abbreviations for registers   for a list of abbreviations used in register descriptions. The peripheral registers can be accessed by halfwords (16-bit) or words (32-bit).  23.5.1   WWDG control register (WWDG_CR)  Address offset: 0x000 Reset value: 0x0000 007F 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   WDGA   T[6:0] rs   rw   rw   rw   rw   rw   rw   rw Bits 31:8   Reserved, must be kept at reset value.

System window watchdog (WWDG)   RM0490  644/1027   RM0490 Rev 5  23.5.2   WWDG configuration register (WWDG_CFR)  Address offset: 0x004 Reset value: 0x0000 007F Bit 7   WDGA:   Activation bit This bit is set by software and only cleared by hardware after a reset. When WDGA = 1, the watchdog can generate a reset. 0: Watchdog disabled 1: Watchdog enabled Bits 6:0   T[6:0]:   7-bit counter (MSB to LSB) These bits contain the value of the watchdog counter, decremented every (4096 x 2 WDGTB [2:0]   ) PCLK cycles. A reset is produced when it is decremented from 0x40 to 0x3F (T6 becomes cleared). 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   WDGTB[2:0]   Res.   EWI   Res.   Res.   W[6:0] rw   rw   rw   rs   rw   rw   rw   rw   rw   rw   rw Bits 31:14   Reserved, must be kept at reset value. Bits 13:11   WDGTB[2:0]:   Timer base The timebase of the prescaler can be modified as follows: 000: CK counter clock (PCLK div 4096) div 1 001: CK counter clock (PCLK div 4096) div 2 010: CK counter clock (PCLK div 4096) div 4 011: CK counter clock (PCLK div 4096) div 8 100: CK counter clock (PCLK div 4096) div 16 101: CK counter clock (PCLK div 4096) div 32 110: CK counter clock (PCLK div 4096) div 64 111: CK counter clock (PCLK div 4096) div 128 Bit 10   Reserved, must be kept at reset value. Bit 9   EWI:   Early wake-up interrupt enable Set by software and cleared by hardware after a reset. When set, an interrupt occurs whenever the counter reaches the value 0x40. Bits 8:7   Reserved, must be kept at reset value. Bits 6:0   W[6:0]:   7-bit window value These bits contain the window value to be compared with the down-counter.

RM0490 Rev 5   645/1027  RM0490   System window watchdog (WWDG)  645  23.5.3   WWDG status register (WWDG_SR)  Address offset: 0x008 Reset value: 0x0000 0000  23.5.4   WWDG register map  The following table gives the WWDG register map and reset values. Refer to   Section 2.2   for the register boundary addresses. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   EWIF rc_w0 Bits 31:1   Reserved, must be kept at reset value. Bit 0   EWIF:   Early wake-up interrupt flag This bit is set by hardware when the counter has reached the value 0x40. It must be cleared by software by writing 0. Writing 1 has no effect. This bit is also set if the interrupt is not enabled.  Table 96. WWDG register map and reset values Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x000   WWDG_CR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. WDGA T[6:0] Reset value   0   1   1   1   1   1   1   1 0x004   WWDG_CFR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res.   WDGTB [2:0] Res. EWI Res. Res. W[6:0] Reset value   0   0   0   0   1   1   1   1   1   1   1 0x008   WWDG_SR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. EWIF Reset value   0

Real-time clock (RTC)   RM0490  646/1027   RM0490 Rev 5  24   Real-time clock (RTC) 24.1   Introduction  The RTC provides an automatic wake-up to manage all low-power modes. The real-time clock (RTC) is an independent BCD timer/counter. The RTC provides a time- of-day clock/calendar with programmable alarm interrupts. As long as the supply voltage remains in the operating range, the RTC never stops, regardless of the device status (Run mode, low-power mode or under reset).  24.2   RTC main features  The RTC supports the following features (see   Figure 221: RTC block diagram ):  •   Calendar with subsecond, seconds, minutes, hours (12 or 24 format), week day, date, month, year, in BCD (binary-coded decimal) format.  •   Automatic correction for 28, 29 (leap year), 30, and 31 days of the month.  •   One programmable alarm.  •   On-the-fly correction from 1 to 32767 RTC clock pulses. This can be used to synchronize it with a master clock.  •   Reference clock detection: a more precise second source clock (50 or 60 Hz) can be used to enhance the calendar precision.  •   Digital calibration circuit with 0.95 ppm resolution, to compensate for quartz crystal inaccuracy.  •   Timestamp feature which can be used to save the calendar content. This function can be triggered by an event on the timestamp pin. The RTC clock sources can be:  •   A 32.768 kHz external crystal (LSE)  •   An external resonator or oscillator (LSE)  •   The internal low power RC oscillator (LSI, with typical frequency of 32 kHz)  •   The high-speed external clock (HSE), divided by a prescaler in the RCC. The RTC is functional in all low-power modes except Standby and Shutdown when it is clocked by the LSE or LSI. All RTC events (Alarm, Timestamp) can generate an interrupt and wake-up the device from the low-power modes.

RM0490 Rev 5   647/1027  RM0490   Real-time clock (RTC)  676  24.3   RTC functional description 24.3.1   RTC block diagram Figure 221. RTC block diagram  MSv67530V1 rtc_pclk clock domain Registers interface rtc_pclk IRQ interface rtc_it Alarm A RTC_ALRMAR RTC_ALRMASSR =   rtc_alra_trg Shadow registers RTC_TR, RTC_DR Output control RTC_OUT1 RTC_OUT2 Shadow register RTC_SSR Calendar Synchronous prescaler (default = 256) RTC_PRER CALIB OSEL[1:0] ck_apre ALARM= TAMPALARM RTC_REFIN RTC_TS Time stamp registers RTC_TSTR RTC_TSDR RTC_TSSR Time stamp detection rtc_ker_ck   ck_spre Smooth calibration RTC_CALR Asynchronous prescaler (default = 128) RTC_PRER TSF ck_apre clock domain ALRAF rtc_ker_ck clock domain

Real-time clock (RTC)   RM0490  648/1027   RM0490 Rev 5  24.3.2   RTC pins and internal signals  •   RTC_OUT1 and RTC_OUT2 which selects one of the following two outputs: –   CALIB: 512 Hz or 1 Hz clock output (with an LSE frequency of 32.768 kHz). This output is enabled by setting the COE bit in the RTC_CR register. –   TAMPALRM: This output is the ALARM output. ALARM is enabled by configuring the OSEL[1:0] bits in the RTC_CR register which select the alarm A output. The RTC kernel clock is usually the LSE at 32.768 kHz although it is possible to select other clock sources in the RCC (refer to RCC for more details). The triggers outputs can be used as triggers for other peripherals.  24.3.3   GPIO controlled by the RTC  RTC_OUT1 and RTC_TS are mapped on the same pin. This pin output mechanism follows the priority order shown in   Table 99 .  Table 97. RTC input/output pins Pin name   Signal type   Description  RTC_TS   Input   RTC timestamp input RTC_REFIN   Input   RTC 50 or 60 Hz reference clock input RTC_OUT1   Output   RTC output 1 RTC_OUT2   Output   RTC output 2  Table 98. RTC internal input/output signals Internal signal name   Signal type   Description  rtc_ker_ck   Input   RTC kernel clock, also named RTCCLK in this document rtc_pclk   Input   RTC APB clock rtc_it   Output   RTC interrupts (refer to   Section 24.5: RTC interrupts   for details) rtc_alra_trg   Output   RTC alarm A event detection trigger

RM0490 Rev 5   649/1027  RM0490   Real-time clock (RTC)  676  In addition, it is possible to output RTC_OUT2 thanks to OUT2EN bit. The different functions are mapped on RTC_OUT1 or on RTC_OUT2 depending on OSEL, COE and OUT2EN configuration, as show in table   Table 100 .  Table 99. Pin configuration (1)  1.   OD: open drain; PP: push-pull.  Pin function OSEL[1:0] (ALARM output enable) COE (CALIB output enable) OUT2EN TAMPALRM_TYPE TAMPALRM_PU TSE (RTC_TS input enable)  TAMPALRM output Push-Pull   01   Don’t care Don’t care   0   0   Don’t care TAMPALRM output Open-Drain   (2) 2.   In this configuration the GPIO must be configured in input. No pull   01   Don’t care Don’t care   1   0   Don’t care Internal pull-up   01   Don’t care Don’t care   1   1   Don’t care CALIB output PP   00   1   0   Don’t care Don’t care Don’t care RTC_TS input floating 00   0   Don’t care Don’t care Don’t care   1 00   1 1 Don’t care   0 Wake-up pin or Standard GPIO 00   0   Don’t care Don’t care Don’t care   0 00   1 1 Don’t care   0

Real-time clock (RTC)   RM0490  650/1027   RM0490 Rev 5  24.3.4   Clock and prescalers  The RTC clocks must respect this ratio: frequency(PCLK)   ≥   2 × frequency(RTCCLK). The RTC clock source (RTCCLK) is selected through the clock controller among the LSE clock, the LSI oscillator clock, and the HSE clock. For more information on the RTC clock source configuration, refer to   Section 6: Reset and clock control (RCC) . A programmable prescaler stage generates a 1 Hz clock which is used to update the calendar. To minimize power consumption, the prescaler is split into 2 programmable prescalers (see   Figure 221: RTC block diagram ):  •   A 7-bit asynchronous prescaler configured through the PREDIV_A bits of the RTC_PRER register.  •   A 15-bit synchronous prescaler configured through the PREDIV_S bits of the RTC_PRER register.  Note:   When both prescalers are used, it is recommended to configure the asynchronous prescaler to a high value to minimize consumption.  The asynchronous prescaler division factor is set to 128, and the synchronous division factor to 256, to obtain an internal clock frequency of 1 Hz (ck_spre) with an LSE frequency of 32.768 kHz. The minimum division factor is 1 and the maximum division factor is 2 22   . This corresponds to a maximum input frequency of around 4 MHz. f ck_apre   is given by the following formula: The ck_apre clock is used to clock the binary RTC_SSR subseconds downcounter. When it reaches 0, RTC_SSR is reloaded with the content of PREDIV_S.  Table 100. RTC_OUT mapping OSEL[1:0] bits ALARM output enable) COE bit (CALIB output enable) OUT2EN bit   RTC_OUT1   RTC_OUT2  00   0 0 -   - 00   1   CALIB   - 01 or 10 or 11   Don’t care   TAMPALRM   - 00   0 1 -   - 00   1   -   CALIB 01 or 10 or 11   0   -   TAMPALRM 01 or 10 or 11   1   TAMPALRM   CALIB f   CK_APRE f   RTCCLK PREDIV_A   1 + -------------------------------------- - =

RM0490 Rev 5   651/1027  RM0490   Real-time clock (RTC)  676  f ck_spre   is given by the following formula:  24.3.5   Real-time clock and calendar  The RTC calendar time and date registers are accessed through shadow registers which are synchronized with PCLK (APB clock). They can also be accessed directly in order to avoid waiting for the synchronization duration.  •   RTC_SSR for the subseconds  •   RTC_TR for the time  •   RTC_DR for the date Every RTCCLK periods, the current calendar value is copied into the shadow registers, and the RSF bit of RTC_ICSR register is set (see   Section 24.6.9: RTC shift control register (RTC_SHIFTR) ). The copy is not performed in Stop and Standby mode. When exiting these modes, the shadow registers are updated after up to 4 RTCCLK periods. When the application reads the calendar registers, it accesses the content of the shadow registers. It is possible to make a direct access to the calendar registers by setting the BYPSHAD control bit in the RTC_CR register. By default, this bit is cleared, and the user accesses the shadow registers. When reading the RTC_SSR, RTC_TR or RTC_DR registers in BYPSHAD = 0 mode, the frequency of the APB clock (f   APB   ) must be at least 7 times the frequency of the RTC clock (f   RTCCLK   ). The shadow registers are reset by system reset.  24.3.6   Programmable alarms  The RTC unit provides programmable alarm: alarm A. The programmable alarm function is enabled through the ALRAE bit in the RTC_CR register. The ALRAF is set to 1 if the calendar subseconds, seconds, minutes, hours, date or day match the values programmed in the alarm registers RTC_ALRMASSR and RTC_ALRMAR. Each calendar field can be independently selected through the MSKx bits of the RTC_ALRMAR register, and through the MASKSSx bits of the RTC_ALRMASSR register. The alarm interrupt is enabled through the ALRAIE bit in the RTC_CR register.  Caution:   If the seconds field is selected (MSK1 bit reset in RTC_ALRMAR), the synchronous prescaler division factor set in the RTC_PRER register must be at least 3 to ensure correct behavior. Alarm A (if enabled by bits OSEL[1:0] in RTC_CR register) can be routed to the TAMPALRM output. TAMPALRM output polarity can be configured through bit POL the RTC_CR register. f   CK_SPRE f   RTCCLK PREDIV_S   1 + (   )   PREDIV_A   1 + (   ) ×  ----------------------------------------------------------------------------------------------- =

Real-time clock (RTC)   RM0490  652/1027   RM0490 Rev 5  24.3.7   RTC initialization and configuration RTC register access  The RTC registers are 32-bit registers. The APB interface introduces two wait states in RTC register accesses except on read accesses to calendar shadow registers when BYPSHAD = 0.  RTC register write protection  After Power-on reset, some of the RTC registers are write-protected. Writing to the protected RTC registers is enabled by writing a key into the Write Protection register, RTC_WPR. The following steps are required to unlock the write protection on the protected RTC registers. 1.   Write 0xCA into the RTC_WPR register. 2.   Write 0x53 into the RTC_WPR register. Writing a wrong key reactivates the write protection. The protection mechanism is not affected by system reset.  Calendar initialization and configuration  To program the initial time and date calendar values, including the time format and the prescaler configuration, the following sequence is required: 1.   Set INIT bit to 1 in the RTC_ICSR register to enter initialization mode. In this mode, the calendar counter is stopped and its value can be updated. 2.   Poll INITF bit of in the RTC_ICSR register. The initialization phase mode is entered when INITF is set to 1. It takes around 2 RTCCLK clock cycles (due to clock synchronization). 3.   To generate a 1 Hz clock for the calendar counter, program both the prescaler factors in RTC_PRER register. 4.   Load the initial time and date values in the shadow registers (RTC_TR and RTC_DR), and configure the time format (12 or 24 hours) through the FMT bit in the RTC_CR register. 5.   Exit the initialization mode by clearing the INIT bit. The actual calendar counter value is then automatically loaded and the counting restarts after 4 RTCCLK clock cycles. When the initialization sequence is complete, the calendar starts counting.  Note:   After a system reset, the application can read the INITS flag in the RTC_ICSR register to check if the calendar has been initialized or not. If this flag equals 0, the calendar has not been initialized since the year field is set at its Power-on reset default value (0x00). To read the calendar after initialization, the software must first check that the RSF flag is set in the RTC_ICSR register.  Daylight saving time  The daylight saving time management is performed through bits SUB1H, ADD1H, and BKP of the RTC_CR register.

RM0490 Rev 5   653/1027  RM0490   Real-time clock (RTC)  676  Using SUB1H or ADD1H, the software can subtract or add one hour to the calendar in one single operation without going through the initialization procedure. In addition, the software can use the BKP bit to memorize this operation.  Programming the alarm  A similar procedure must be followed to program or update the programmable alarms. The procedure below is given for alarm A. 1.   Clear ALRAE in RTC_CR to disable alarm A. 2.   Program the alarm A registers (RTC_ALRMASSR/RTC_ALRMAR). 3.   Set ALRAE in the RTC_CR register to enable alarm A again.  Note:   Each change of the RTC_CR register is taken into account after around 2 RTCCLK clock cycles due to clock synchronization.  24.3.8   Reading the calendar When BYPSHAD control bit is cleared in the RTC_CR register  To read the RTC calendar registers (RTC_SSR, RTC_TR and RTC_DR) properly, the APB1 clock frequency (f   PCLK   ) must be equal to or greater than seven times the RTC clock frequency (f   RTCCLK ). This ensures a secure behavior of the synchronization mechanism. If the APB1 clock frequency is less than seven times the RTC clock frequency, the software must read the calendar time and date registers twice. If the second read of the RTC_TR gives the same result as the first read, this ensures that the data is correct. Otherwise a third read access must be done. In any case the APB1 clock frequency must never be lower than the RTC clock frequency. The RSF bit is set in RTC_ICSR register each time the calendar registers are copied into the RTC_SSR, RTC_TR and RTC_DR shadow registers. The copy is performed every RTCCLK cycles. To ensure consistency between the 3 values, reading either RTC_SSR or RTC_TR locks the values in the higher-order calendar shadow registers until RTC_DR is read. In case the software makes read accesses to the calendar in a time interval smaller than 1 RTCCLK periods: RSF must be cleared by software after the first calendar read, and then the software must wait until RSF is set before reading again the RTC_SSR, RTC_TR and RTC_DR registers. After waking up from low-power mode (Stop or Standby), RSF must be cleared by software. The software must then wait until it is set again before reading the RTC_SSR, RTC_TR and RTC_DR registers. The RSF bit must be cleared after wake-up and not before entering low-power mode. After a system reset, the software must wait until RSF is set before reading the RTC_SSR, RTC_TR and RTC_DR registers. Indeed, a system reset resets the shadow registers to their default values. After an initialization (refer to   Calendar initialization and configuration on page 652 ): the software must wait until RSF is set before reading the RTC_SSR, RTC_TR and RTC_DR registers. After synchronization (refer to   Section 24.3.10: RTC synchronization ): the software must wait until RSF is set before reading the RTC_SSR, RTC_TR and RTC_DR registers.

Real-time clock (RTC)   RM0490  654/1027   RM0490 Rev 5  When the BYPSHAD control bit is set in the RTC_CR register (bypass shadow registers)  Reading the calendar registers gives the values from the calendar counters directly, thus eliminating the need to wait for the RSF bit to be set. This is especially useful after exiting from low-power modes (Stop or Standby), since the shadow registers are not updated during these modes. When the BYPSHAD bit is set to 1, the results of the different registers might not be coherent with each other if an RTCCLK edge occurs between two read accesses to the registers. Additionally, the value of one of the registers may be incorrect if an RTCCLK edge occurs during the read operation. The software must read all the registers twice, and then compare the results to confirm that the data is coherent and correct. Alternatively, the software can just compare the two results of the least-significant calendar register.  Note:   While BYPSHAD = 1, instructions which read the calendar registers require one extra APB cycle to complete.  24.3.9   Resetting the RTC  The calendar shadow registers (RTC_SSR, RTC_TR and RTC_DR) and some bits of the RTC status register (RTC_ICSR) are reset to their default values by all available system reset sources. On the contrary, the following registers are reset to their default values by a Power-on reset and are not affected by a system reset: the RTC current calendar registers, the RTC control register (RTC_CR), the prescaler register (RTC_PRER), the RTC calibration register (RTC_CALR), the RTC shift register (RTC_SHIFTR), the RTC timestamp registers (RTC_TSSSR, RTC_TSTR and RTC_TSDR) and the alarm A registers (RTC_ALRMASSR/RTC_ALRMAR. In addition, when clocked by LSE, the RTC keeps on running under system reset if the reset source is different from the Power-on reset one (refer to RCC for details about RTC clock sources not affected by system reset). When a Power-on reset occurs, the RTC is stopped and all the RTC registers are set to their reset values.  24.3.10   RTC synchronization  The RTC can be synchronized to a remote clock with a high degree of precision. After reading the sub-second field (RTC_SSR or RTC_TSSSR), a calculation can be made of the precise offset between the times being maintained by the remote clock and the RTC. The RTC can then be adjusted to eliminate this offset by “shifting” its clock by a fraction of a second using RTC_SHIFTR. RTC_SSR contains the value of the synchronous prescaler counter. This allows one to calculate the exact time being maintained by the RTC down to a resolution of 1 / (PREDIV_S + 1) seconds. As a consequence, the resolution can be improved by increasing the synchronous prescaler value (PREDIV_S[14:0]. The maximum resolution allowed (30.52 μs with a 32768 Hz clock) is obtained with PREDIV_S set to 0x7FFF. However, increasing PREDIV_S means that PREDIV_A must be decreased in order to maintain the synchronous prescaler output at 1 Hz. In this way, the frequency of the asynchronous prescaler output increases, which may increase the RTC dynamic consumption.

RM0490 Rev 5   655/1027  RM0490   Real-time clock (RTC)  676  The RTC can be finely adjusted using the RTC shift control register (RTC_SHIFTR). Writing to RTC_SHIFTR can shift (either delay or advance) the clock by up to a second with a resolution of 1 / (PREDIV_S + 1) seconds. The shift operation consists of adding the SUBFS[14:0] value to the synchronous prescaler counter SS[15:0]: this will delay the clock. If at the same time the ADD1S bit is set, this results in adding one second and at the same time subtracting a fraction of second, so this will advance the clock.  Caution:   Before initiating a shift operation, the user must check that SS[15] = 0 in order to ensure that no overflow will occur. As soon as a shift operation is initiated by a write to the RTC_SHIFTR register, the SHPF flag is set by hardware to indicate that a shift operation is pending. This bit is cleared by hardware as soon as the shift operation has completed.  Caution:   This synchronization feature is not compatible with the reference clock detection feature: firmware must not write to RTC_SHIFTR when REFCKON = 1.  24.3.11   RTC reference clock detection  The update of the RTC calendar can be synchronized to a reference clock, RTC_REFIN, which is usually the mains frequency (50 or 60 Hz). The precision of the RTC_REFIN reference clock should be higher than the 32.768 kHz LSE clock. When the RTC_REFIN detection is enabled (REFCKON bit of RTC_CR set to 1), the calendar is still clocked by the LSE, and RTC_REFIN is used to compensate for the imprecision of the calendar update frequency (1 Hz). Each 1 Hz clock edge is compared to the nearest RTC_REFIN clock edge (if one is found within a given time window). In most cases, the two clock edges are properly aligned. When the 1 Hz clock becomes misaligned due to the imprecision of the LSE clock, the RTC shifts the 1 Hz clock a bit so that future 1 Hz clock edges are aligned. Thanks to this mechanism, the calendar becomes as precise as the reference clock. The RTC detects if the reference clock source is present by using the 256 Hz clock (ck_apre) generated from the 32.768 kHz quartz. The detection is performed during a time window around each of the calendar updates (every 1 s). The window equals 7 ck_apre periods when detecting the first reference clock edge. A smaller window of 3 ck_apre periods is used for subsequent calendar updates. Each time the reference clock is detected in the window, the asynchronous prescaler which outputs the ck_spre clock is forced to reload. This has no effect when the reference clock and the 1 Hz clock are aligned because the prescaler is being reloaded at the same moment. When the clocks are not aligned, the reload shifts future 1 Hz clock edges a little for them to be aligned with the reference clock. If the reference clock halts (no reference clock edge occurred during the 3 ck_apre window), the calendar is updated continuously based solely on the LSE clock. The RTC then waits for the reference clock using a large 7 ck_apre period detection window centered on the ck_spre edge. When the RTC_REFIN detection is enabled, PREDIV_A and PREDIV_S must be set to their default values:  •   PREDIV_A = 0x007F  •   PREVID_S = 0x00FF  Note:   RTC_REFIN clock detection is not available in Standby mode.

Real-time clock (RTC)   RM0490  656/1027   RM0490 Rev 5  24.3.12   RTC smooth digital calibration  The RTC frequency can be digitally calibrated with a resolution of about 0.954 ppm with a range from -487.1 ppm to +488.5 ppm. The correction of the frequency is performed using series of small adjustments (adding and/or subtracting individual RTCCLK pulses). These adjustments are fairly well distributed so that the RTC is well calibrated even when observed over short durations of time. The smooth digital calibration is performed during a calibration cycle of about 2   20   RTCCLK pulses, or 32 seconds when the input frequency is 32768 Hz. This cycle is maintained by a 20-bit counter, cal_cnt[19:0], clocked by RTCCLK. The smooth calibration register (RTC_CALR) specifies the number of RTCCLK clock cycles to be masked during the calibration cycle:  •   Setting the bit CALM[0] to 1 causes exactly one pulse to be masked during the calibration cycle.  •   Setting CALM[1] to 1 causes two additional cycles to be masked  •   Setting CALM[2] to 1 causes four additional cycles to be masked  •   and so on up to CALM[8] set to 1 which causes 256 clocks to be masked.  Note:   CALM[8:0] (RTC_CALR) specifies the number of RTCCLK pulses to be masked during the calibration cycle. Setting the bit CALM[0] to 1 causes exactly one pulse to be masked during the calibration cycle at the moment when cal_cnt[19:0] is 0x80000; CALM[1] = 1 causes two other cycles to be masked (when cal_cnt is 0x40000 and 0xC0000); CALM[2] = 1 causes four other cycles to be masked (cal_cnt = 0x20000/0x60000/0xA0000/ 0xE0000); and so on up to CALM[8] = 1 which causes 256 clocks to be masked (cal_cnt = 0xXX800).  While CALM allows the RTC frequency to be reduced by up to 487.1 ppm with fine resolution, the bit CALP can be used to increase the frequency by 488.5 ppm. Setting CALP to 1 effectively inserts an extra RTCCLK pulse every 2   11   RTCCLK cycles, which means that 512 clocks are added during every calibration cycle. Using CALM together with CALP, an offset ranging from -511 to +512 RTCCLK cycles can be added during the calibration cycle, which translates to a calibration range of -487.1 ppm to +488.5 ppm with a resolution of about 0.954 ppm. The formula to calculate the effective calibrated frequency (F CAL   ) given the input frequency (F   RTCCLK   ) is as follows: F CAL   = F RTCCLK   x [1 + (CALP x 512 - CALM) / (2 20   + CALM - CALP x 512)]  Calibration when PREDIV_A < 3  The CALP bit can not be set to 1 when the asynchronous prescaler value (PREDIV_A bits in RTC_PRER register) is less than 3. If CALP was already set to 1 and PREDIV_A bits are set to a value less than 3, CALP is ignored and the calibration operates as if CALP was equal to 0. To perform a calibration with PREDIV_A less than 3, the synchronous prescaler value (PREDIV_S) should be reduced so that each second is accelerated by 8 RTCCLK clock cycles, which is equivalent to adding 256 clock cycles every calibration cycle. As a result, between 255 and 256 clock pulses (corresponding to a calibration range from 243.3 to 244.1 ppm) can effectively be added during each calibration cycle using only the CALM bits. With a nominal RTCCLK frequency of 32768 Hz, when PREDIV_A equals 1 (division factor of 2), PREDIV_S should be set to 16379 rather than 16383 (4 less). The only other

RM0490 Rev 5   657/1027  RM0490   Real-time clock (RTC)  676  interesting case is when PREDIV_A equals 0, PREDIV_S should be set to 32759 rather than 32767 (8 less). If PREDIV_S is reduced in this way, the formula given the effective frequency of the calibrated input clock is as follows: F   CAL   = F   RTCCLK   x [1 + (256 - CALM) / (2   20   + CALM - 256)] In this case, CALM[7:0] equals 0x100 (the midpoint of the CALM range) is the correct setting if RTCCLK is exactly 32768.00 Hz.  Verifying the RTC calibration  RTC precision is ensured by measuring the precise frequency of RTCCLK and calculating the correct CALM value and CALP values. An optional 1 Hz output is provided to allow applications to measure and verify the RTC precision. Measuring the precise frequency of the RTC over a limited interval can result in a measurement error of up to 2 RTCCLK clock cycles over the measurement period, depending on how the digital calibration cycle is aligned with the measurement period. However, this measurement error can be eliminated if the measurement period is the same length as the calibration cycle period. In this case, the only error observed is the error due to the resolution of the digital calibration.  •   By default, the calibration cycle period is 32 seconds. Using this mode and measuring the accuracy of the 1 Hz output over exactly 32 seconds guarantees that the measure is within 0.477 ppm (0.5 RTCCLK cycles over 32 seconds, due to the limitation of the calibration resolution).  •   CALW16 bit of the RTC_CALR register can be set to 1 to force a 16- second calibration cycle period. In this case, the RTC precision can be measured during 16 seconds with a maximum error of 0.954 ppm (0.5 RTCCLK cycles over 16 seconds). However, since the calibration resolution is reduced, the long term RTC precision is also reduced to 0.954 ppm: CALM[0] bit is stuck at 0 when CALW16 is set to 1.  •   CALW8 bit of the RTC_CALR register can be set to 1 to force a 8-second calibration cycle period. In this case, the RTC precision can be measured during 8 seconds with a maximum error of 1.907 ppm (0.5 RTCCLK cycles over 8 s). The long term RTC precision is also reduced to 1.907 ppm: CALM[1:0] bits are stuck at 00 when CALW8 is set to 1.  Re-calibration on-the-fly  The calibration register (RTC_CALR) can be updated on-the-fly while RTC_ICSR/INITF = 0, by using the follow process: 1.   Poll the RTC_ICSR/RECALPF (re-calibration pending flag). 2.   If it is set to 0, write a new value to RTC_CALR, if necessary. RECALPF is then automatically set to 1 3.   Within three ck_apre cycles after the write operation to RTC_CALR, the new calibration settings take effect.  24.3.13   Timestamp function  Timestamp is enabled by setting the TSE or ITSE bits of   RTC_CR register to 1.

Real-time clock (RTC)   RM0490  658/1027   RM0490 Rev 5  When TSE is set: The calendar is saved in the timestamp registers (RTC_TSSSR, RTC_TSTR, RTC_TSDR) when a timestamp event is detected on the RTC_TS pin. When a timestamp event occurs, the timestamp flag bit (TSF) in RTC_SR register is set. By setting the TSIE bit in the RTC_CR register, an interrupt is generated when a timestamp event occurs. If a new timestamp event is detected while the timestamp flag (TSF) is already set, the timestamp overflow flag (TSOVF) flag is set and the timestamp registers (RTC_TSTR and RTC_TSDR) maintain the results of the previous event.  Note:   TSF is set 2 ck_apre cycles after the timestamp event occurs due to synchronization process. There is no delay in the setting of TSOVF. This means that if two timestamp events are close together, TSOVF can be seen as '1' while TSF is still '0'. As a consequence, it is recommended to poll TSOVF only after TSF has been set.  Caution:   If a timestamp event occurs immediately after the TSF bit is supposed to be cleared, then both TSF and TSOVF bits are set. To avoid masking a timestamp event occurring at the same moment, the application must not write 0 into TSF bit unless it has already read it to 1.  24.3.14   Calibration clock output  When the COE bit is set to 1 in the RTC_CR register, a reference clock is provided on the CALIB device output. If the COSEL bit in the RTC_CR register is reset and PREDIV_A = 0x7F, the CALIB frequency is f   RTCCLK /64   . This corresponds to a calibration output at 512 Hz for an RTCCLK frequency at 32.768 kHz. The CALIB duty cycle is irregular: there is a light jitter on falling edges. It is therefore recommended to use rising edges. When COSEL is set and “PREDIV_S+1” is a non-zero multiple of 256 (i.e: PREDIV_S[7:0] = 0xFF), the CALIB frequency is f   RTCCLK   /(256 * (PREDIV_A+1)). This corresponds to a calibration output at 1 Hz for prescaler default values (PREDIV_A = Ox7F, PREDIV_S = 0xFF), with an RTCCLK frequency at 32.768 kHz.  Note:   When COSEL is cleared, the CALIB output is the output of the 6 th   stage of the asynchronous prescaler. When COSEL is set, the CALIB output is the output of the 8 th   stage of the synchronous prescaler.  24.3.15   Alarm output  The OSEL[1:0] control bits in the RTC_CR register are used to activate the alarm output TAMPALRM, and to select the function which is output. These functions reflect the contents of the corresponding flag in the RTC_SR register. The polarity of the TAMPALRM output is determined by the POL control bit in RTC_CR so that the opposite of the selected flags bit is output when POL is set to 1.

RM0490 Rev 5   659/1027  RM0490   Real-time clock (RTC)  676  TAMPALRM output  The TAMPALRM pin can be configured in output open drain or output push-pull using the control bit TAMPALRM_TYPE in the RTC_CR register. It is possible to apply the internal pull-up in output mode thanks to TAMPALRM_PU in the RTC_CR.  Note:   Once the   TAMPALRM   output is enabled, it has priority over CALIB on RTC_OUT1.  24.4   RTC low-power modes  The table below summarizes the RTC pins and functions capability in all modes.  24.5   RTC interrupts  The interrupt channel is set in the masked interrupt status register. The interrupt output is also activated.  Table 101. Effect of low-power modes on RTC Mode   Description  Sleep   No effect RTC interrupts cause the device to exit the Sleep mode. Stop   The RTC remains active when the RTC clock source is LSE or LSI. RTC interrupts cause the device to exit the Stop mode. Standby   The RTC is powered down and must be re-initialized after exiting Standby mode. Shutdown   The RTC is powered down and must be re-initialized after exiting Shutdown mode.  Table 102. RTC pins functionality over modes Functions Functional in all low-power modes except Standby and Shutdown modes Functional in Standby and Shutdown mode  RTC_TS   Yes   No RTC_REFIN   Yes   No RTC_OUT1   Yes   No RTC_OUT2   Yes   No  Table 103. Interrupt requests Interrupt acronym   Interrupt event   Event flag (1) Enable control bit (2) Interrupt clear method Exit from Sleep mode Exit from Stop mode Exit from Standby and Shutdown mode  RTC Alarm A   ALRAF   ALRAIE   write 1 in CALRAF   Yes   Yes   (3)   No Timestamp   TSF   TSIE   write 1 in CTSF   Yes   Yes   (3)   No

Real-time clock (RTC)   RM0490  660/1027   RM0490 Rev 5  24.6   RTC registers  Refer to   Section 1.2 on page 41   of the reference manual for a list of abbreviations used in register descriptions. The peripheral registers can be accessed by words (32-bit).  24.6.1   RTC time register (RTC_TR)  The RTC_TR is the calendar time shadow register. This register must be written in initialization mode only. Refer to   Calendar initialization and configuration on page 652   and  Reading the calendar on page 653 . This register is write protected. The write access procedure is described in   RTC register write protection on page 652 . Address offset: 0x00 Power-on reset value: 0x0000 0000 System reset value: 0x0000 0000 (when BYPSHAD = 0, not affected when BYPSHAD = 1) 1.   The event flags are in the RTC_SR register. 2.   The interrupt masked flags (resulting from event flags AND enable control bits) are in the RTC_MISR register. 3.   Wake-up from Stop mode is possible only when the RTC clock source is LSE or LSI. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   PM   HT[1:0]   HU[3:0] rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   MNT[2:0]   MNU[3:0]   Res.   ST[2:0]   SU[3:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:23   Reserved, must be kept at reset value. Bit 22   PM :   AM/PM notation 0: AM or 24-hour format 1: PM Bits 21:20   HT[1:0] : Hour tens in BCD format Bits 19:16   HU[3:0] : Hour units in BCD format Bit 15   Reserved, must be kept at reset value. Bits 14:12   MNT[2:0] : Minute tens in BCD format Bits 11:8   MNU[3:0] : Minute units in BCD format Bit 7   Reserved, must be kept at reset value. Bits 6:4   ST[2:0] : Second tens in BCD format Bits 3:0   SU[3:0] : Second units in BCD format

RM0490 Rev 5   661/1027  RM0490   Real-time clock (RTC)  676  24.6.2   RTC date register (RTC_DR)  The RTC_DR is the calendar date shadow register. This register must be written in initialization mode only. Refer to   Calendar initialization and configuration on page 652   and  Reading the calendar on page 653 . This register is write protected. The write access procedure is described in   RTC register write protection on page 652 . Address offset: 0x04 Power-on reset value: 0x0000 2101 System reset value: 0x0000 2101 (when BYPSHAD = 0, not affected when BYPSHAD = 1)  Note:   The calendar is frozen when reaching the maximum value, and can’t roll over.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   YT[3:0]   YU[3:0] rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 WDU[2:0]   MT   MU[3:0]   Res.   Res.   DT[1:0]   DU[3:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:24   Reserved, must be kept at reset value. Bits 23:20   YT[3:0] : Year tens in BCD format Bits 19:16   YU[3:0] : Year units in BCD format Bits 15:13   WDU[2:0] : Week day units 000: forbidden 001: Monday ... 111: Sunday Bit 12   MT : Month tens in BCD format Bits 11:8   MU[3:0] : Month units in BCD format Bits 7:6   Reserved, must be kept at reset value. Bits 5:4   DT[1:0] : Date tens in BCD format Bits 3:0   DU[3:0] : Date units in BCD format

Real-time clock (RTC)   RM0490  662/1027   RM0490 Rev 5  24.6.3   RTC sub second register (RTC_SSR)  Address offset: 0x08 Power-on reset value: 0x0000 0000 System reset value: 0x0000 0000 (when BYPSHAD = 0, not affected when BYPSHAD = 1)  24.6.4   RTC initialization control and status register (RTC_ICSR)  This register is write protected. The write access procedure is described in   RTC register write protection on page 652 . Address offset: 0x0C Power-on reset value: 0x0000 0007 System reset value: 0bxxxx xxxx xxxx xxxx xxxx xxxx 000x xxxx (not affected, except INIT, INITF, and RSF bits which are cleared to 0) 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 SS[15:0] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   SS[15:0] : Sub second value SS[15:0] is the value in the synchronous prescaler counter. The fraction of a second is given by the formula below: Second fraction = (PREDIV_S - SS) / (PREDIV_S + 1)  Note:   SS can be larger than PREDIV_S only after a shift operation. In that case, the correct time/date is one second less than as indicated by RTC_TR/RTC_DR.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   RECAL PF r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   INIT   INITF   RSF   INITS   SHPF   Res.   Res.   ALRAW F rw   r   rc_w0   r   r   r Bits 31:17   Reserved, must be kept at reset value. Bit 16   RECALPF : Recalibration pending Flag The RECALPF status flag is automatically set to 1 when software writes to the RTC_CALR register, indicating that the RTC_CALR register is blocked. When the new calibration settings are taken into account, this bit returns to 0. Refer to   Re-calibration on-the-fly . Bits 15:8   Reserved, must be kept at reset value.

RM0490 Rev 5   663/1027  RM0490   Real-time clock (RTC)  676  Bit 7   INIT : Initialization mode 0: Free running mode 1: Initialization mode used to program time and date register (RTC_TR and RTC_DR), and prescaler register (RTC_PRER). Counters are stopped and start counting from the new value when INIT is reset. Bit 6   INITF : Initialization flag When this bit is set to 1, the RTC is in initialization state, and the time, date and prescaler registers can be updated. 0: Calendar registers update is not allowed 1: Calendar registers update is allowed Bit 5   RSF : Registers synchronization flag This bit is set by hardware each time the calendar registers are copied into the shadow registers (RTC_SSR, RTC_TR and RTC_DR). This bit is cleared by hardware in initialization mode, while a shift operation is pending (SHPF = 1), or when in bypass shadow register mode (BYPSHAD = 1). This bit can also be cleared by software. It is cleared either by software or by hardware in initialization mode. 0: Calendar shadow registers not yet synchronized 1: Calendar shadow registers synchronized Bit 4   INITS : Initialization status flag This bit is set by hardware when the calendar year field is different from 0 (Power-on reset state). 0: Calendar has not been initialized 1: Calendar has been initialized Bit 3   SHPF : Shift operation pending This flag is set by hardware as soon as a shift operation is initiated by a write to the RTC_SHIFTR register. It is cleared by hardware when the corresponding shift operation has been executed. Writing to the SHPF bit has no effect. 0: No shift operation is pending 1: A shift operation is pending Bits 2:1   Reserved, must be kept at reset value. Bit 0   ALRAWF : Alarm A write flag This bit is set by hardware when alarm A values can be changed, after the ALRAE bit has been set to 0 in RTC_CR. It is cleared by hardware in initialization mode. 0: Alarm A update not allowed 1: Alarm A update allowed

Real-time clock (RTC)   RM0490  664/1027   RM0490 Rev 5  24.6.5   RTC prescaler register (RTC_PRER)  This register must be written in initialization mode only. The initialization must be performed in two separate write accesses. Refer to   Calendar initialization and configuration on page 652 . This register is write protected. The write access procedure is described in   RTC register write protection on page 652 . Address offset: 0x10 Power-on reset value: 0x007F 00FF System reset: not affected  24.6.6   RTC control register (RTC_CR)  This register is write protected. The write access procedure is described in RTC register write protection on page 652.  Address offset: 0x18 Power-on reset value: 0x0000 0000 System reset: not affected 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   PREDIV_A[6:0] rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   PREDIV_S[14:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:23   Reserved, must be kept at reset value. Bits 22:16   PREDIV_A[6:0] : Asynchronous prescaler factor This is the asynchronous division factor: ck_apre frequency = RTCCLK frequency/(PREDIV_A+1) Bit 15   Reserved, must be kept at reset value. Bits 14:0   PREDIV_S[14:0] : Synchronous prescaler factor This is the synchronous division factor: ck_spre frequency = ck_apre frequency/(PREDIV_S+1) 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 OUT2 EN TAMP ALRM_ TYPE TAMP ALRM_ PU Res.   Res.   Res.   Res.   Res.   COE   OSEL[1:0]   POL   COSEL   BKP   SUB1H   ADD1H rw   rw   rw   rw   rw   rw   rw   rw   rw   w   w 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 TSIE   Res.   Res.   ALRA IE   TSE   Res.   Res.   ALRAE   Res.   FMT   BYP SHAD REFCK ON TS EDGE   Res.   Res.   Res. rw   rw   rw   rw   rw   rw   rw   rw

RM0490 Rev 5   665/1027  RM0490   Real-time clock (RTC)  676  Bit 31   OUT2EN : RTC_OUT2 output enable Setting this bit allows to remap the RTC outputs on RTC_OUT2 as follows:  OUT2EN = 0:   RTC output 2 disable If OSEL   ≠   00 or TAMPOE = 1: TAMPALRM is output on RTC_OUT1 If OSEL = 00 and TAMPOE = 0 and COE = 1: CALIB is output on RTC_OUT1  OUT2EN = 1:   RTC output 2 enable If (OSEL   ≠   00 or TAMPOE = 1) and COE = 0: TAMPALRM is output on RTC_OUT2 If OSEL = 00 and TAMPOE = 0 and COE = 1: CALIB is output on RTC_OUT2 If (OSEL ≠   00 or TAMPOE = 1) and COE = 1: CALIB is output on RTC_OUT2 and TAMPALRM is output on RTC_OUT1. Bit 30   TAMPALRM_TYPE : TAMPALRM output type 0: TAMPALRM is push-pull output 1: TAMPALRM is open-drain output Bit 29   TAMPALRM_PU : TAMPALRM pull-up enable 0: No pull-up is applied on TAMPALRM output 1: A pull-up is applied on TAMPALRM output Bits 28:24   Reserved, must be kept at reset value. Bit 23   COE : Calibration output enable This bit enables the CALIB output 0: Calibration output disabled 1: Calibration output enabled Bits 22:21   OSEL[1:0] : Output selection These bits are used to select the flag to be routed to TAMPALRM output. 00: Output disabled 01: Alarm A output enabled 10: Reserved 11: Reserved Bit 20   POL : Output polarity This bit is used to configure the polarity of TAMPALRM output. 0: The pin is high when ALRAF is asserted (depending on OSEL[1:0]). 1: The pin is low when ALRAF is asserted (depending on OSEL[1:0]). Bit 19   COSEL : Calibration output selection When COE = 1, this bit selects which signal is output on CALIB. 0: Calibration output is 512 Hz 1: Calibration output is 1 Hz These frequencies are valid for RTCCLK at 32.768 kHz and prescalers at their default values (PREDIV_A = 127 and PREDIV_S = 255). Refer to   Section 24.3.14: Calibration clock output . Bit 18   BKP : Backup This bit can be written by the user to memorize whether the daylight saving time change has been performed or not. Bit 17   SUB1H :   S ubtract 1 hour (winter time change) When this bit is set outside initialization mode, 1 hour is subtracted to the calendar time if the current hour is not 0. This bit is always read as 0. Setting this bit has no effect when current hour is 0. 0: No effect 1: Subtracts 1 hour to the current time. This can be used for winter time change.

Real-time clock (RTC)   RM0490  666/1027   RM0490 Rev 5  Note:   Bits 6 and 4 of this register can be written in initialization mode only (RTC_ICSR/INITF = 1). It is recommended not to change the hour during the calendar hour increment as it could mask the incrementation of the calendar hour. ADD1H and SUB1H changes are effective in the next second.  Bit 16   ADD1H : Add 1 hour (summer time change) When this bit is set outside initialization mode, 1 hour is added to the calendar time. This bit is always read as 0. 0: No effect 1: Adds 1 hour to the current time. This can be used for summer time change Bit 15   TSIE : Timestamp interrupt enable 0: Timestamp interrupt disable 1: Timestamp interrupt enable Bits 14:13   Reserved, must be kept at reset value. Bit 12   ALRAIE : Alarm A interrupt enable 0: Alarm A interrupt disabled 1: Alarm A interrupt enabled Bit 11   TSE : timestamp enable 0: timestamp disable 1: timestamp enable Bits 10:9   Reserved, must be kept at reset value. Bit 8   ALRAE :   Alarm A enable 0: Alarm A disabled 1: Alarm A enabled Bit 7   Reserved, must be kept at reset value. Bit 6   FMT : Hour format 0: 24 hour/day format 1: AM/PM hour format Bit 5   BYPSHAD : Bypass the shadow registers 0: Calendar values (when reading from RTC_SSR, RTC_TR, and RTC_DR) are taken from the shadow registers, which are updated once every two RTCCLK cycles. 1: Calendar values (when reading from RTC_SSR, RTC_TR, and RTC_DR) are taken directly from the calendar counters.  Note:   If the frequency of the APB1 clock is less than seven times the frequency of RTCCLK, BYPSHAD must be set to 1.  Bit 4   REFCKON : RTC_REFIN reference clock detection enable (50 or 60 Hz) 0: RTC_REFIN detection disabled 1: RTC_REFIN detection enabled  Note:   PREDIV_S must be 0x00FF.  Bit 3   TSEDGE : Timestamp event active edge 0: RTC_TS input rising edge generates a timestamp event 1: RTC_TS input falling edge generates a timestamp event TSE must be reset when TSEDGE is changed to avoid unwanted TSF setting. Bits 2:0   Reserved, must be kept at reset value.

RM0490 Rev 5   667/1027  RM0490   Real-time clock (RTC)  676  24.6.7   RTC write protection register (RTC_WPR)  Address offset: 0x24 Reset value: 0x0000 0000  24.6.8   RTC calibration register (RTC_CALR)  This register is write protected. The write access procedure is described in   RTC register write protection on page 652 . Address offset: 0x28 Power-on reset value: 0x0000 0000 System reset: not affected 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   KEY[7:0] w   w   w   w   w   w   w   w Bits 31:8   Reserved, must be kept at reset value. Bits 7:0   KEY[7:0] : Write protection key This byte is written by software. Reading this byte always returns 0x00. Refer to   RTC register write protection   for a description of how to unlock RTC register write protection. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CALP   CALW8   CALW 16   Res.   Res.   Res.   Res.   CALM[8:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

Real-time clock (RTC)   RM0490  668/1027   RM0490 Rev 5  24.6.9   RTC shift control register (RTC_SHIFTR)  This register is write protected. The write access procedure is described in   RTC register write protection on page 652 . Address offset: 0x2C Power-on reset value: 0x0000 0000 System reset: not affected Bits 31:16   Reserved, must be kept at reset value. Bit 15   CALP : Increase frequency of RTC by 488.5 ppm 0: No RTCCLK pulses are added. 1: One RTCCLK pulse is effectively inserted every 2 11   pulses (frequency increased by 488.5 ppm). This feature is intended to be used in conjunction with CALM, which lowers the frequency of the calendar with a fine resolution. if the input frequency is 32768 Hz, the number of RTCCLK pulses added during a 32-second window is calculated as follows: (512 × CALP) - CALM. Refer to   Section 24.3.12: RTC smooth digital calibration . Bit 14   CALW8 : Use an 8-second calibration cycle period When CALW8 is set to 1, the 8-second calibration cycle period is selected.  Note:   CALM[1:0] are stuck at 00 when CALW8 = 1. Refer to Section 24.3.12: RTC smooth digital calibration.  Bit 13   CALW16 : Use a 16-second calibration cycle period When CALW16 is set to 1, the 16-second calibration cycle period is selected. This bit must not be set to 1 if CALW8 = 1.  Note:   CALM[0] is stuck at 0 when CALW16 = 1. Refer to Section 24.3.12: RTC smooth digital calibration.  Bits 12:9   Reserved, must be kept at reset value. Bits 8:0   CALM[8:0] : Calibration minus The frequency of the calendar is reduced by masking CALM out of 2 20   RTCCLK pulses (32 seconds if the input frequency is 32768 Hz). This decreases the frequency of the calendar with a resolution of 0.9537 ppm. To increase the frequency of the calendar, this feature should be used in conjunction with CALP. See   Section 24.3.12: RTC smooth digital calibration on page 656 . 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 ADD1S   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. w 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   SUBFS[14:0] w   w   w   w   w   w   w   w   w   w   w   w   w   w   w

RM0490 Rev 5   669/1027  RM0490   Real-time clock (RTC)  676  24.6.10   RTC timestamp time register (RTC_TSTR)  The content of this register is valid only when TSF is set to 1 in RTC_SR. It is cleared when TSF bit is reset. Address offset: 0x30 Power-on reset value: 0x0000 0000 System reset: not affected Bit 31   ADD1S : Add one second 0: No effect 1: Add one second to the clock/calendar This bit is write only and is always read as zero. Writing to this bit has no effect when a shift operation is pending (when SHPF = 1, in RTC_ICSR). This function is intended to be used with SUBFS (see description below) in order to effectively add a fraction of a second to the clock in an atomic operation. Bits 30:15   Reserved, must be kept at reset value. Bits 14:0   SUBFS[14:0] : Subtract a fraction of a second These bits are write only and is always read as zero. Writing to this bit has no effect when a shift operation is pending (when SHPF = 1, in RTC_ICSR). The value which is written to SUBFS is added to the synchronous prescaler counter. Since this counter counts down, this operation effectively subtracts from (delays) the clock by: Delay (seconds) = SUBFS / (PREDIV_S + 1) A fraction of a second can effectively be added to the clock (advancing the clock) when the ADD1S function is used in conjunction with SUBFS, effectively advancing the clock by: Advance (seconds) = (1 - (SUBFS / (PREDIV_S + 1))).  Note:   Writing to SUBFS causes RSF to be cleared. Software can then wait until RSF = 1 to be sure that the shadow registers have been updated with the shifted time.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   PM   HT[1:0]   HU[3:0] r   r   r   r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   MNT[2:0]   MNU[3:0]   Res.   ST[2:0]   SU[3:0] r   r   r   r   r   r   r   r   r   r   r   r   r   r Bits 31:23   Reserved, must be kept at reset value. Bit 22   PM :   AM/PM notation 0: AM or 24-hour format 1: PM Bits 21:20   HT[1:0] : Hour tens in BCD format. Bits 19:16   HU[3:0] : Hour units in BCD format. Bit 15   Reserved, must be kept at reset value. Bits 14:12   MNT[2:0] : Minute tens in BCD format. Bits 11:8   MNU[3:0] : Minute units in BCD format.

Real-time clock (RTC)   RM0490  670/1027   RM0490 Rev 5  24.6.11   RTC timestamp date register (RTC_TSDR)  The content of this register is valid only when TSF is set to 1 in RTC_SR. It is cleared when TSF bit is reset. Address offset: 0x34 Power-on reset value: 0x0000 0000 System reset: not affected  24.6.12   RTC timestamp sub second register (RTC_TSSSR)  The content of this register is valid only when TSF is set to 1 in RTC_SR. It is cleared when the TSF bit is reset. Address offset: 0x38 Power-on reset value: 0x0000 0000 System reset: not affected Bit 7   Reserved, must be kept at reset value. Bits 6:4   ST[2:0] : Second tens in BCD format. Bits 3:0   SU[3:0] : Second units in BCD format. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 WDU[2:0]   MT   MU[3:0]   Res.   Res.   DT[1:0]   DU[3:0] r   r   r   r   r   r   r   r   r   r   r   r   r   r Bits 31:16   Reserved, must be kept at reset value. Bits 15:13   WDU[2:0] : Week day units Bit 12   MT : Month tens in BCD format Bits 11:8   MU[3:0] : Month units in BCD format Bits 7:6   Reserved, must be kept at reset value. Bits 5:4   DT[1:0] : Date tens in BCD format Bits 3:0   DU[3:0] : Date units in BCD format 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 SS[15:0] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r

RM0490 Rev 5   671/1027  RM0490   Real-time clock (RTC)  676  24.6.13   RTC alarm A register (RTC_ALRMAR)  This register can be written only when ALRAWF is set to 1 in RTC_ICSR, or in initialization mode. This register is write protected. The write access procedure is described in   RTC register write protection on page 652 . Address offset: 0x40 Power-on reset value: 0x0000 0000 System reset: not affected Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   SS[15:0]: Sub second value SS[15:0] is the value of the synchronous prescaler counter when the timestamp event occurred. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 MSK4   WD SEL   DT[1:0]   DU[3:0]   MSK3   PM   HT[1:0]   HU[3:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 MSK2   MNT[2:0]   MNU[3:0]   MSK1   ST[2:0]   SU[3:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 31   MSK4 : Alarm A date mask 0: Alarm A set if the date/day match 1: Date/day don’t care in alarm A comparison Bit 30   WDSEL : Week day selection 0: DU[3:0] represents the date units 1: DU[3:0] represents the week day. DT[1:0] is don’t care. Bits 29:28   DT[1:0] : Date tens in BCD format Bits 27:24   DU[3:0] : Date units or day in BCD format Bit 23   MSK3 : Alarm A hours mask 0: Alarm A set if the hours match 1: Hours don’t care in alarm A comparison Bit 22   PM :   AM/PM notation 0: AM or 24-hour format 1: PM Bits 21:20   HT[1:0] : Hour tens in BCD format Bits 19:16   HU[3:0] : Hour units in BCD format Bit 15   MSK2 : Alarm A minutes mask 0: Alarm A set if the minutes match 1: Minutes don’t care in alarm A comparison Bits 14:12   MNT[2:0] : Minute tens in BCD format Bits 11:8   MNU[3:0] : Minute units in BCD format

Real-time clock (RTC)   RM0490  672/1027   RM0490 Rev 5  24.6.14   RTC alarm A sub second register (RTC_ALRMASSR)  This register can be written only when ALRAWF is set to 1 in RTC_ICSR, or in initialization mode. This register is write protected. The write access procedure is described in   RTC register write protection on page 652 . Address offset: 0x44 Power-on reset value: 0x0000 0000 System reset: not affected  24.6.15   RTC status register (RTC_SR)  Address offset: 0x50 Bit 7   MSK1 : Alarm A seconds mask 0: Alarm A set if the seconds match 1: Seconds don’t care in alarm A comparison Bits 6:4   ST[2:0] : Second tens in BCD format. Bits 3:0   SU[3:0] : Second units in BCD format. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   MASKSS[3:0]   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   SS[14:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   w   rw   rw Bits 31:28   Reserved, must be kept at reset value. Bits 27:24   MASKSS[3:0] : Mask the most-significant bits starting at this bit 0: No comparison on sub seconds for alarm A. The alarm is set when the seconds unit is incremented (assuming that the rest of the fields match). 1: SS[14:1] are don’t care in alarm A comparison. Only SS[0] is compared. 2: SS[14:2] are don’t care in alarm A comparison. Only SS[1:0] are compared. 3: SS[14:3] are don’t care in alarm A comparison. Only SS[2:0] are compared. ... 12:SS[14:12] are don’t care in alarm A comparison. SS[11:0] are compared. 13:SS[14:13] are don’t care in alarm A comparison. SS[12:0] are compared. 14:SS[14] is don’t care in alarm A comparison. SS[13:0] are compared. 15:All 15 SS bits are compared and must match to activate alarm. The overflow bits of the synchronous counter (bits 15) is never compared. This bit can be different from 0 only after a shift operation.  Note:   The overflow bits of the synchronous counter (bits 15) is never compared. This bit can be different from 0 only after a shift operation.  Bits 23:15   Reserved, must be kept at reset value. Bits 14:0   SS[14:0] :   Sub seconds value This value is compared with the contents of the synchronous prescaler counter to determine if alarm A is to be activated. Only bits 0 up MASKSS-1 are compared.

RM0490 Rev 5   673/1027  RM0490   Real-time clock (RTC)  676  Power-on reset value: 0x0000 0000 System reset: not affected  Note:   The bits of this register are cleared few APB clock cycles after setting their corresponding clear bit in the RTC_SCR register. After clearing the flag, read it until it is read at 0 before leaving the interrupt routine.  24.6.16   RTC masked interrupt status register (RTC_MISR)  Address offset: 0x54 Power-on reset value: 0x0000 0000 System reset: not affected 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TSOVF   TSF   Res.   Res.   ALRAF r   r   r Bits 31:5   Reserved, must be kept at reset value. Bit 4   TSOVF : Timestamp overflow flag This flag is set by hardware when a timestamp event occurs while TSF is already set. It is recommended to check and then clear TSOVF only after clearing the TSF bit. Otherwise, an overflow might not be noticed if a timestamp event occurs immediately before the TSF bit is cleared. Bit 3   TSF : Timestamp flag This flag is set by hardware when a timestamp event occurs. Bits 2:1   Reserved, must be kept at reset value. Bit 0   ALRAF : Alarm A flag This flag is set by hardware when the time/date registers (RTC_TR and RTC_DR) match the alarm A register (RTC_ALRMAR). 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TSOV MF TS MF   Res.   Res.   ALRA MF r   r   r

Real-time clock (RTC)   RM0490  674/1027   RM0490 Rev 5  Note:   The bits of this register are cleared few APB clock cycles after setting their corresponding clear bit in the RTC_SCR register. After clearing the flag, read it until it is read at 0 before leaving the interrupt routine.  24.6.17   RTC status clear register (RTC_SCR)  Address offset: 0x5C Power-on reset value: 0x0000 0000 System reset: not affected Bits 31:5   Reserved, must be kept at reset value. Bit 4   TSOVMF : Timestamp overflow masked flag This flag is set by hardware when a timestamp interrupt occurs while TSMF is already set. It is recommended to check and then clear TSOVF only after clearing the TSF bit. Otherwise, an overflow might not be noticed if a timestamp event occurs immediately before the TSF bit is cleared. Bit 3   TSMF : Timestamp masked flag This flag is set by hardware when a timestamp interrupt occurs. Bits 2:1   Reserved, must be kept at reset value. Bit 0   ALRAMF : Alarm A masked flag This flag is set by hardware when the alarm A interrupt occurs. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CTSOV F CTS F   Res.   Res.   CALRA F w   w   w Bits 31:5   Reserved, must be kept at reset value. Bit 4   CTSOVF : Clear timestamp overflow flag Writing 1 in this bit clears the TSOVF bit in the RTC_SR register. It is recommended to check and then clear TSOVF only after clearing the TSF bit. Otherwise, an overflow might not be noticed if a timestamp event occurs immediately before the TSF bit is cleared. Bit 3   CTSF : Clear timestamp flag Writing 1 in this bit clears the TSOVF bit in the RTC_SR register. Bits 2:1   Reserved, must be kept at reset value. Bit 0   CALRAF : Clear alarm A flag Writing 1 in this bit clears the ALRAF bit in the RTC_SR register.

RM0490 Rev 5   675/1027  RM0490   Real-time clock (RTC)  676  24.6.18   RTC register map  Table 104. RTC register map and reset values Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00   RTC_TR  Res. Res. Res. Res. Res. Res. Res. Res. Res. PM   HT [1:0]   HU[3:0] Res. MNT[2:0]   MNU[3:0] Res. ST[2:0]   SU[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x04   RTC_DR  Res. Res. Res. Res. Res. Res. Res. Res. YT[3:0]   YU[3:0]   WDU[2:0] MT MU[3:0] Res. Res.   DT [1:0]   DU[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   1   0   0   0   0   1   0   0   0   0   0   1 0x08   RTC_SSR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. SS[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x0C   RTC_ICSR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. RECALPF Res. Res. Res. Res. Res. Res. Res. Res. INIT INITF RSF INITS SHPF Res. Res. ALRAWF Reset value   0   0   0   0   0   0   1 0x10   RTC_PRER  Res. Res. Res. Res. Res. Res. Res. Res. Res. PREDIV_A[6:0]   PREDIV_S[14:0] Reset value   1   1   1   1   1   1   1   0   0   0   0   0   0   0   0   1   1   1   1   1   1   1   1 0x14   Reserved   Res. 0x18   RTC_CR  OUT2EN TAMPALRM_TYPE TAMPALRM_PU Res. Res. Res. Res. Res. COE   O SEL [1:0] POL COSEL BKP SUB1H ADD1H TSIE Res. Res. ALRAIE TSE Res. Res. ALRAE Res. FMT BYPSHAD REFCKON TSEDGE Res. Res. Res. Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x20   Reserved   Res. 0x24   RTC_WPR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. KEY[7:0] Reset value   0   0   0   0   0   0   0   0 0x28   RTC_ CALR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CALP CALW8 CALW16 Res. Res. Res. Res. CALM[8:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0 0x2C   RTC_SHIFTR  ADD1S Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. SUBFS[14:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x30   RTC_TSTR  Res. Res. Res. Res. Res. Res. Res. Res. Res. PM HT[1:0] HU[3:0] Res. MNT[2:0] MNU[3:0] Res. ST[2:0]   SU[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x34   RTC_TSDR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. WDU[1:0] MT MU[3:0] Res. Res.   DT [1:0]   DU[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x38   RTC_TSSSR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. SS[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0

Real-time clock (RTC)   RM0490  676/1027   RM0490 Rev 5  Refer to   Section 2.2 on page 45   for the register boundary addresses. 0x40   RTC_ALRMAR  MSK4 WDSEL DT [1:0]   DU[3:0] MSK3 PM   HT [1:0]   HU[3:0] MSK2 MNT[2:0]   MNU[3:0] MSK1 ST[2:0]   SU[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x44  RTC_ ALRMASSR  Res. Res. Res. Res.   MASKSS [3:0] Res. Res. Res. Res. Res. Res. Res. Res. Res. SS[14:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x48 - 0x4C   Reserved   Res. 0x50   RTC_SR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TSOVF TSF Res. Res. ALRAF Reset value   0   0   0 0x54   RTC_MISR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TSOVMF TSMF Res. Res. ALRAMF Reset value   0   0   0 0x58   Reserved   Res. 0x5C   RTC_SCR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CTSOVF CTSF Res. Res. CALRAF Reset value   0   0   0  Table 104. RTC register map and reset values (continued) Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

RM0490 Rev 5   677/1027  RM0490   Inter-integrated circuit interface (I2C)  741  25   Inter-integrated circuit interface (I2C) 25.1   Introduction  The I2C peripheral handles the interface between the device and the serial I²C (inter- integrated circuit) bus. It provides multicontroller capability, and controls all I²C-bus-specific sequencing, protocol, arbitration and timing. It supports Standard-mode (Sm), Fast-mode (Fm) and Fast-mode Plus (Fm+). The I2C peripheral is also SMBus (system management bus) and PMBus   ®   (power management bus) compatible. It can use DMA to reduce the CPU load.  25.2   I2C   main features  •   I²C-bus specification rev03 compatibility: –   Target and controller modes –   Multicontroller capability –   Standard-mode (up to 100 kHz) –   Fast-mode (up to 400 kHz) –   Fast-mode Plus (up to 1 MHz) –   7-bit and 10-bit addressing mode –   Multiple 7-bit target addresses (2 addresses, 1 with configurable mask) –   All 7-bit-addresses acknowledge mode –   General call –   Programmable setup and hold times –   Easy-to-use event management –   Clock stretching (optional)  •   1-byte buffer with DMA capability  •   Programmable analog and digital noise filters  •   SMBus specification rev 3.0 compatibility (a) : –   Hardware PEC (packet error checking) generation and verification with ACK control –   Command and data acknowledge control –   Address resolution protocol (ARP) support –   Host and device support –   SMBus alert –   Timeouts and idle condition detection  •   PMBus rev 1.3 standard compatibility  •   Independent clock a.   To check the compliance of the GPIOs selected for SMBus with the specified logical levels, refer to the product datasheet.

Inter-integrated circuit interface (I2C)   RM0490  678/1027   RM0490 Rev 5  •   Wake-up from Stop mode on address match For information on I2C instantiation, refer to   Section 25.3: I2C implementation .  25.3   I2C   implementation  This section provides an implementation overview with respect to the I2C instantiation.  25.4   I2C   functional description  In addition to receiving and transmitting data, the peripheral converts them from serial to parallel format and vice versa. The interrupts are enabled or disabled by software. The peripheral is connected to the I²C-bus through a data pin (SDA) and a clock pin (SCL). It supports Standard-mode (up to 100 kHz), Fast-mode (up to 400 kHz), and Fast-mode Plus (up to 1 MHz) I²C-bus. The independent clock function allows the I2C communication speed to be independent of the PCLK frequency. For I2C I/Os supporting 20 mA output current drive for Fast-mode Plus operation, the driving capability is enabled through control bits in the system configuration block(SYSCFG) .  Table 105. I2C implementation I2C features (1)  1.   X = supported.  I2C1   I2C2   (2)  2.   I2C2 is only available on STM32C051xx/071xx/091xx/092xx devices. 7-bit addressing mode   X   X 10-bit addressing mode   X   X Standard-mode (up to 100 kbit/s)   X   X Fast-mode (up to 400 kbit/s)   X   X Fast-mode Plus with 20 mA output drive I/Os (up to 1 Mbit/s)   X   X Independent clock   X   - Wake-up from Stop mode   X   - SMBus/PMBus   X   - The peripheral can also be connected to an SMBus, through the data pin (SDA), the clock pin (SCL), and an optional SMBus alert pin (SMBA). Refer to   Section 25.3: I2C implementation   for the relevant I2C instances.

RM0490 Rev 5   679/1027  RM0490   Inter-integrated circuit interface (I2C)  741  25.4.1   I2C block diagram Figure 222. Block diagram  The block diagram shows a functional superset. Refer to   Section 25.3: I2C implementation  for information relative to different instances of the I2C peripheral. The instances not supporting features such as SMBus and wake-up from Stop mode do not include the corresponding blocks. The instances not supporting the independent clock function use PCLK for clocking both the kernel and the registers.  MSv46198V4 I2CCLK Wake-up on address match SMBUS PEC generation/ check Shift register Data control SMBus timeout check Clock control Controller clock generation Target clock stretching SMBus alert control/status Digital noise filter   I2C_SCL I2C_SMBA Registers APB bus GPIO logic Analog noise filter Digital noise filter   I2C_SDA GPIO logic Analog noise filter i2c_pclk i2c_ker_ck PCLK

Inter-integrated circuit interface (I2C)   RM0490  680/1027   RM0490 Rev 5  25.4.2   I2C pins and internal signals 25.4.3   I2C clock requirements  The I2C kernel is clocked by I2CCLK. The I2CCLK period t I2CCLK   must respect the following conditions:  t I2CCLK   < ( t LOW   -   t   filters ) / 4  t I2CCLK   <   t HIGH  where   t LOW   is the SCL low time,   t   HIGH   is the SCL high time, and   t filters   is the sum of the analog and digital filter delays (when enabled). The digital filter delay is DNF[3:0] x   t   I2CCLK . The PCLK clock period   t PCLK   must respect the condition   t PCLK   < 4/3   t SCL , where   t SCL   is the SCL period.  Caution:   When the I2C kernel is clocked by PCLK, this clock must respect the conditions for   t   I2CCLK .  25.4.4   I2C mode selection  The peripheral can operate as:  •   Target transmitter  •   Target receiver  •   Controller transmitter  •   Controller receiver By default, the peripheral operates in target mode. It automatically switches from target to controller mode upon generating START condition, and from controller to target mode upon arbitration loss or upon generating STOP condition. This allows the use of the I2C peripheral   in a multicontroller I²C-bus environment.  Table 106. I2C input/output pins Pin name   Signal type   Description  I2C_SDA   Bidirectional   I²C-bus data I2C_SCL   Bidirectional   I²C-bus clock I2C_SMBA   Bidirectional   SMBus alert  Table 107. I2C internal input/output signals Internal signal name   Signal type   Description  i2c_ker_ck   Input   I2C kernel clock, also named I2CCLK in this document i2c_pclk   Input   I2C APB clock i2c_it   Output   I2C interrupts, refer to   Table 121   for the list of interrupt sources i2c_rx_dma   Output   I2C receive data DMA request (I2C_RX) i2c_tx_dma   Output   I2C transmit data DMA request (I2C_TX)

RM0490 Rev 5   681/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Communication flow  In controller mode, the I2C peripheral initiates a data transfer and generates the clock signal. Serial data transfers always begin with a START condition and end with a STOP condition. Both START and STOP conditions are generated in controller mode by software. In target mode, the peripheral recognizes its own 7-bit or 10-bit address, and the general call address. The general call address detection can be enabled or disabled by software. The reserved SMBus addresses can also be enabled by software. Data and addresses are transferred as 8-bit bytes, MSB first. The address is contained in the first byte (7-bit addressing) or in the first two bytes (10-bit addressing) following the START condition. The address is always transmitted in controller mode. The following figure shows the transmission of a single byte. The controller generates nine SCL pulses. The transmitter sends the eight data bits to the receiver with the SCL pulses 1 to 8. Then the receiver sends the acknowledge bit to the transmitter with the ninth SCL pulse.  Figure 223. I²C-bus protocol  The acknowledge can be enabled or disabled by software. The own addresses of the I2C peripheral can be selected by software.  25.4.5   I2C initialization Enabling and disabling the peripheral  Before enabling the I2C peripheral, configure and enable its clock through the RCC, and initialize its control registers. The I2C peripheral can then be enabled by setting the PE bit of the I2C_CR1 register. Disabling the I2C peripheral by clearing the PE bit resets the I2C peripheral. Refer to  Section 25.4.6   for more details.  Noise filters  Before enabling the I2C peripheral by setting the PE bit of the I2C_CR1 register, the user must configure the analog and/or digital noise filters, as required.  MS19854V1 SDA SCL Start condition Stop condition MSB   ACK 1   2   8   9

Inter-integrated circuit interface (I2C)   RM0490  682/1027   RM0490 Rev 5  The analog noise filter on the SDA and SCL inputs complies with the I²C-bus specification which requires, in Fast-mode and Fast-mode Plus, the suppression of spikes shorter than 50 ns. Enabled by default, it can be disabled by setting the ANFOFF bit. The digital filter is controlled through the DNF[3:0] bitfield of the I2C_CR1 register. When it is enabled, the internal SCL and SDA signals only take the level of their corresponding I²C-bus line when remaining stable for more than DNF[3:0] periods of I2CCLK. This allows suppressing spikes shorter than the filtering capacity period programmable from one to fifteen I2CCLK periods. The following table compares the two filters.  Caution:   The filter configuration cannot be changed when the I2C peripheral is enabled.  I2C timings  To ensure correct data hold and setup times, the corresponding timings must be configured through the PRESC[3:0], SCLDEL[3:0], and SDADEL[3:0] bitfields of the I2C_TIMINGR register. The STM32CubeMX tool calculates and provides the I2C_TIMINGR content in the   I2C configuration   window.  Table 108. Comparison of analog and digital filters  Item   Analog filter   Digital filter  Filtering capacity   (1) 1.   Maximum duration of spikes that the filter can suppress  ≥   50 ns   One to fifteen I2CCLK periods Benefits   Available in Stop mode – Programmable filtering capacity – Extra filtering capability versus I²C-bus specification requirements – Stable filtering capacity Drawbacks Filtering capacity variation with temperature, voltage, and silicon process Wake-up from Stop mode on address match not supported when the digital filter is enabled

RM0490 Rev 5   683/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Figure 224. Setup and hold timings  When the SCL falling edge is internally detected, the delay   t   SDADEL   (impacting the hold time t   HD;DAT ) is inserted before sending SDA output: t   SDADEL   = SDADEL x t PRESC   + t I2CCLK   , where   t   PRESC   = (PRESC + 1) x t   I2CCLK   . The total SDA output delay is: t   SYNC1   + {[SDADEL x (PRESC + 1) + 1] x t I2CCLK } The t   SYNC1   duration depends upon:  •   SCL falling slope  •   input delay t   AF(min)   < t AF   < t   AF(max)   introduced by the analog filter (if enabled)  •   input delay t   DNF   = DNF   x   t I2CCLK   introduced by the digital filter (if enabled)  •   delay due to SCL synchronization to I2CCLK clock (two to three I2CCLK periods) To bridge the undefined region of the SCL falling edge, the user must set SDADEL[3:0] so as to fulfill the following condition: {t   f(max)   + t   HD;DAT(min)   - t   AF(min)   - [(DNF + 3) x t   I2CCLK ]} / {(PRESC + 1) x t   I2CCLK }   ≤   SDADEL SDADEL   ≤   {t   HD;DAT (max)   - t AF(max)   - [(DNF + 4) x t   I2CCLK   ]} / {(PRESC + 1) x t I2CCLK }  MSv40108V1 t SYNC1 SCL falling edge internal detection SDADEL: SCL stretched low by the I2C SDA output delay SCL SDA  DATA HOLD TIME  t HD;DAT SCLDEL SCL stretched low by the I2C SCL SDA  DATA SETUP TIME  t SU;STA Data hold time: in case of transmission, the data is sent on SDA output after the SDADEL delay, if it is already available in I2C_TXDR. Data setup time: in case of transmission, the SCLDEL counter starts when the data is sent on SDA output.

Inter-integrated circuit interface (I2C)   RM0490  684/1027   RM0490 Rev 5  Note:   t AF(min)   and t AF(max)   are only part of the condition when the analog filter is enabled. Refer to the device datasheet for t   AF   values.  The t   HD;DAT   time can at maximum be 3.45 μs for Standard-mode, 0.9 μs for Fast-mode, and 0.45 μs for Fast-mode Plus. It must be lower than the maximum of t   VD;DAT   by a transition time. This maximum must only be met if the device does not stretch the LOW period (t LOW   ) of the SCL signal. When it stretches SCL, the data must be valid by the set-up time before it releases the clock. The SDA rising edge is usually the worst case. The previous condition then becomes: SDADEL   ≤   {t   VD;DAT (max)   - t   r (max)   - t AF (max)   - [(DNF + 4) x t I2CCLK ]} / {(PRESC + 1) x t I2CCLK   }  Note:   This condition can be violated when NOSTRETCH = 0, because the device stretches SCL low to guarantee the set-up time, according to the SCLDEL[3:0] value.  After t   SDADEL , or after sending SDA output when the target had to stretch the clock because the data was not yet written in I2C_TXDR register, the SCL line is kept at low level during the setup time. This setup time is   t   SCLDEL   = (SCLDEL + 1) x t PRESC , where t   PRESC   = (PRESC + 1) x t I2CCLK . t   SCLDEL   impacts the setup time   t SU;DAT   . To bridge the undefined region of the SDA transition (rising edge usually worst case), the user must program SCLDEL[3:0] so as to fulfill the following condition: {[t   r (max)   + t   SU;DAT (min) ] / [(PRESC + 1) x t   I2CCLK ]} - 1   ≤   SCLDEL Refer to the following table for t   f   , t r , t   HD;DAT   , t   VD;DAT   , and t SU;DAT   standard values. Use the SDA and SCL real transition time values measured in the application to widen the scope of allowed SDADEL[3:0] and SCLDEL[3:0] values. Use the maximum SDA and SCL transition time values defined in the standard to make the device work reliably regardless of the application.  Note:   At every clock pulse, after SCL falling edge detection, I2C operating as controller or target stretches SCL low during at least   [(SDADEL + SCLDEL + 1) x (PRESC + 1) + 1] x t I2CCLK , in both transmission and reception modes. In transmission mode, if the data is not yet written in I2C_TXDR when SDA delay elapses, the I2C peripheral keeps stretching SCL low until the next data is written. Then new data MSB is sent on SDA output, and SCLDEL counter starts, continuing stretching SCL low to guarantee the data setup time.  When the NOSTRETCH bit is set in target mode, the SCL is not stretched. The SDADEL[3:0] must then be programmed so that it ensures a sufficient setup time.  Table 109. I²C-bus and SMBus specification data setup and hold times Symbol   Parameter Standard-mode (Sm) Fast-mode (Fm) Fast-mode Plus (Fm+)   SMBus Unit Min   Max   Min   Max   Min   Max   Min   Max  t HD;DAT   Data hold time   0   -   0   -   0   -   0.3   -   μs t VD;DAT   Data valid time   -   3.45   -   0.9   -   0.45   -   - t SU;DAT   Data setup time   250   -   100   -   50   -   250   - ns t   r Rise time of both SDA and SCL signals   -   1000   -   300   -   120   -   1000 t   f Fall time of both SDA and SCL signals   -   300   -   300   -   120   -   300

RM0490 Rev 5   685/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Additionally, in controller mode, the SCL clock high and low levels must be configured by programming the PRESC[3:0], SCLH[7:0], and SCLL[7:0] bitfields of the I2C_TIMINGR register. When the SCL falling edge is internally detected, the I2C peripheral releasing the SCL output after the delay   t SCLL   = (SCLL + 1) x t PRESC   , where   t   PRESC   = (PRESC + 1) x t I2CCLK   . The t   SCLL   delay impacts the SCL low time   t   LOW . When the SCL rising edge is internally detected, the I2C peripheral forces the SCL output to low level after the delay   t   SCLH   = (SCLH + 1) x t PRESC   , where   t   PRESC   = (PRESC + 1) x t   I2CCLK   . The t   SCLH   impacts the SCL high time   t   HIGH . Refer to   I2C controller initialization   for more details.  Caution:   Changing the timing configuration and the NOSTRETCH configuration is not allowed when the I2C peripheral is enabled. Like the timing settings, the target NOSTRETCH settings must also be done before enabling the peripheral. Refer to   I2C target initialization   for more details.  Figure 225. I2C initialization flow 25.4.6   I2C reset  The reset of the I2C peripheral is performed by clearing the PE bit of the I2C_CR1 register. It has the effect of releasing the SCL and SDA lines. Internal state machines are reset and the communication control bits and the status bits revert to their reset values. This reset does not impact the configuration registers. The impacted register bits are: 1.   I2C_CR2 register: START, STOP, PECBYTE, and NACK 2.   I2C_ISR register: BUSY, TXE, TXIS, RXNE, ADDR, NACKF, TCR, TC, STOPF, BERR, ARLO, PECERR, TIMEOUT, ALERT, and OVR  MS19847V3 Clear PE bit in I2C_CR1 Initial settings Configure ANFOFF and DNF[3:0] in I2C_CR1 Configure PRESC[3:0], SDADEL[3:0], SCLDEL[3:0], SCLH[7:0], and SCLL[7:0] in I2C_TIMINGR Configure NOSTRETCH in I2C_CR1 Set PE bit in I2C_CR1 End

Inter-integrated circuit interface (I2C)   RM0490  686/1027   RM0490 Rev 5  Note:   The PECBYTE, PECERR, TIMOUT, and ALERT bits only apply to I2C instances supporting SMBus.  PE must be kept low during at least three APB clock cycles to perform the I2C reset. To ensure this, perform the following software sequence: 1.   Write PE = 0 2.   Check PE = 0 3.   Write PE = 1  25.4.7   I2C data transfer  The data transfer is managed through transmit and receive data registers and a shift register.  Reception  The SDA input fills the shift register. After the eighth SCL pulse (when the complete data byte is received), the shift register is copied into the I2C_RXDR register if it is empty (RXNE = 0). If RXNE = 1, which means that the previous received data byte has not yet been read, the SCL line is stretched low until I2C_RXDR is read. The stretch occurs between the eighth and the ninth SCL pulse (before the acknowledge pulse).  Figure 226. Data reception  xx Shift register   data1 data1 xx   data2 RXNE ACK pulse data0   data2 ACK pulse xx I2C_RXDR rd data1 rd data0 SCL legend: SCL stretch MS19848V1

RM0490 Rev 5   687/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Transmission  If the I2C_TXDR register is not empty (TXE = 0), its content is copied into the shift register after the ninth SCL pulse (the acknowledge pulse). Then the shift register content is shifted out on the SDA line. If TXE = 1, which means that no data is written yet in I2C_TXDR, the SCL line is stretched low until I2C_TXDR is written. The stretch starts after the ninth SCL pulse.  Figure 227. Data transmission Hardware transfer management  The I2C features an embedded byte counter to manage byte transfer and to close the communication in various modes, such as: –   NACK, STOP and ReSTART generation in controller mode –   ACK control in target receiver mode –   PEC generation/checking, on I2C instances supporting SMBus In controller mode, the byte counter is always used. By default, it is disabled in target mode. It can be enabled by software, by setting the SBC (target byte control) bit of the I2C_CR1 register. The number of bytes to transfer is programmed in the NBYTES[7:0] bitfield of the I2C_CR2 register. If this number is greater than 255, or if a receiver wants to control the acknowledge value of a received data byte, the reload mode must be selected, by setting the RELOAD bit of the I2C_CR2 register. In this mode, the TCR flag is set when the number of bytes programmed in NBYTES[7:0] is transferred (when the associated counter reaches zero), and an interrupt is generated if TCIE is set. SCL is stretched as long as the TCR flag is set. TCR is cleared by software when NBYTES[7:0] is written to a non-zero value. When NBYTES[7:0] is reloaded with the last number of bytes to transfer, the RELOAD bit must be cleared.  MS19849V1 xx Shift register data1 data1 xx data2 TXE ACK pulse data0   data2 ACK pulse xx I2C_TXDR wr data1   wr data2 SCL   legend: SCL stretch

Inter-integrated circuit interface (I2C)   RM0490  688/1027   RM0490 Rev 5  When RELOAD = 0 in controller mode, the counter can be used in two modes:  •   Automatic end   (AUTOEND = 1 in the I2C_CR2 register). In this mode, the controller automatically sends a STOP condition once the number of bytes programmed in the NBYTES[7:0] bitfield is transferred.  •   Software end   (AUTOEND = 0 in the I2C_CR2 register). In this mode, a software action is expected once the number of bytes programmed in the NBYTES[7:0] bitfield is transferred; the TC flag is set and an interrupt is generated if the TCIE bit is set. The SCL signal is stretched as long as the TC flag is set. The TC flag is cleared by software when the START or STOP bit of the I2C_CR2 register is set. This mode must be used when the controller wants to send a RESTART condition.  Caution:   The AUTOEND bit has no effect when the RELOAD bit is set.  25.4.8   I2C target mode I2C target initialization  To work in target mode, the user must enable at least one target address. The I2C_OAR1 and I2C_OAR2 registers are available to program the target own addresses OA1 and OA2, respectively. OA1 can be configured either in 7-bit (default) or in 10-bit addressing mode, by setting the OA1MODE bit of the I2C_OAR1 register. OA1 is enabled by setting the OA1EN bit of the I2C_OAR1 register. If an additional target addresses are required, the second target address OA2 can be configured. Up to seven OA2 LSBs can be masked, by configuring the OA2MSK[2:0] bitfield of the I2C_OAR2 register. Therefore, for OA2MSK[2:0] configured from 1 to 6, only OA2[7:2], OA2[7:3], OA2[7:4], OA2[7:5], OA2[7:6], or OA2[7] are compared with the received address. When OA2MSK[2:0] is other than 0, the address comparator for OA2 excludes the I2C reserved addresses (0000 XXX and 1111 XXX) and they are not acknowledged. If OA2MSK[2:0] = 7, all received 7-bit addresses are acknowledged (except reserved addresses). OA2 is always a 7-bit address. When enabled through the specific bit, the reserved addresses can be acknowledged if they are programmed in the I2C_OAR1 or I2C_OAR2 register with OA2MSK[2:0] = 0. OA2 is enabled by setting the OA2EN bit of the I2C_OAR2 register. The general call address is enabled by setting the GCEN bit of the I2C_CR1 register. When the I2C peripheral is selected by one of its enabled addresses, the ADDR interrupt status flag is set, and an interrupt is generated if the ADDRIE bit is set. By default, the target uses its clock stretching capability, which means that it stretches the SCL signal at low level when required, to perform software actions. If the controller does not  Table 110. I2C configuration Function   SBC bit   RELOAD bit   AUTOEND bit  Controller Tx/Rx NBYTES + STOP   X   0   1 Controller Tx/Rx + NBYTES + RESTART   X   0   0 Target Tx/Rx, all received bytes ACKed   0   X   X Target Rx with ACK control   1   1   X

RM0490 Rev 5   689/1027  RM0490   Inter-integrated circuit interface (I2C)  741  support clock stretching, I2C must be configured with NOSTRETCH = 1 in the I2C_CR1 register. After receiving an ADDR interrupt, if several addresses are enabled, the user must read the ADDCODE[6:0] bitfield of the I2C_ISR register to check which address matched. The DIR flag must also be checked to know the transfer direction.  Target with clock stretching  As long as the NOSTRETCH bit of the I2C_CR1 register is zero (default), the I2C peripheral operating as an I²C-bus target stretches the SCL signal in the following situations:  •   The ADDR flag is set and the received address matches with one of the enabled target addresses. The stretch is released when the software clears the ADDR flag by setting the ADDRCF bit.  •   In transmission, the previous data transmission is completed and no new data is written in I2C_TXDR register, or the first data byte is not written when the ADDR flag is cleared (TXE = 1). The stretch is released when the data is written to the I2C_TXDR register.  •   In reception, the I2C_RXDR register is not read yet and a new data reception is completed. The stretch is released when I2C_RXDR is read.  •   In target byte control mode (SBC bit set) with reload (RELOAD bit set), the last data byte transfer is finished (TCR bit set). The stretch is released when then TCR is cleared by writing a non-zero value in the NBYTES[7:0] bitfield.  •   After SCL falling edge detection. The stretch is released after [(SDADEL + SCLDEL + 1) x (PRESC+ 1) + 1] x t   I2CCLK period.  Target without clock stretching  As long as the NOSTRETCH bit of the I2C_CR1 register is set, the I2C peripheral operating as an I²C-bus target does not stretch the SCL signal. The SCL clock is not stretched while the ADDR flag is set. In transmission, the data must be written in the I2C_TXDR register before the first SCL pulse corresponding to its transfer occurs. If not, an underrun occurs, the OVR flag is set in the I2C_ISR register and an interrupt is generated if the ERRIE bit of the I2C_CR1 register is set. The OVR flag is also set when the first data transmission starts and the STOPF bit is still set (has not been cleared). Therefore, if the user clears the STOPF flag of the previous transfer only after writing the first data to be transmitted in the next transfer, it ensures that the OVR status is provided, even for the first data to be transmitted. In reception, the data must be read from the I2C_RXDR register before the ninth SCL pulse (ACK pulse) of the next data byte occurs. If not, an overrun occurs, the OVR flag is set in the I2C_ISR register, and an interrupt is generated if the ERRIE bit of the I2C_CR1 register is set.

Inter-integrated circuit interface (I2C)   RM0490  690/1027   RM0490 Rev 5  Target byte control mode  To allow byte ACK control in target reception mode, the target byte control mode must be enabled, by setting the SBC bit of the I2C_CR1 register. This is required to comply with SMBus standards. The reload mode must be selected to allow byte ACK control in target reception mode (RELOAD = 1). To get control of each byte, NBYTES[7:0] must be initialized to 0x1 in the ADDR interrupt subroutine, and reloaded to 0x1 after each received byte. When the byte is received, the TCR bit is set, stretching the SCL signal low between the eighth and the ninth SCL pulse. The user can read the data from the I2C_RXDR register, and then decide to acknowledge it or not by configuring the ACK bit of the I2C_CR2 register. The SCL stretch is released by programming NBYTES to a non-zero value: the acknowledge or not-acknowledge is sent and the next byte can be received. NBYTES[7:0] can be loaded with a value greater than 0x1. Receiving then continues until the corresponding number of bytes are received.  Note:   The SBC bit must be configured when the I2C peripheral is disabled, when the target is not addressed, or when ADDR = 1. The RELOAD bit value can be changed when ADDR = 1, or when TCR = 1.  Caution:   The target byte control mode is not compatible with NOSTRETCH mode. Setting SBC when NOSTRETCH = 1 is not allowed.  Figure 228. Target initialization flow  1.   SBC must be set to support SMBus features.  MSv19850V4 Initial settings Target initialization Clear OA1EN and OA2EN in I2C_OAR1/I2C_OAR2 Configure OA1[9:0], OA1MODE, OA1EN, OA2[6:0], OA2MSK[2:0], OA2EN, and GCEN Optional: Configure SBC in I2C_CR1   (1) Enable interrupts and/or DMA in I2C_CR1 End

RM0490 Rev 5   691/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Target transmitter  A transmit interrupt status (TXIS) flag is generated when the I2C_TXDR register becomes empty. An interrupt is generated if the TXIE bit of the I2C_CR1 register is set. The TXIS flag is cleared when the I2C_TXDR register is written with the next data byte to transmit. When NACK is received, the NACKF flag is set in the I2C_ISR register and an interrupt is generated if the NACKIE bit of the I2C_CR1 register is set. The target automatically releases the SCL and SDA lines to let the controller perform a STOP or a RESTART condition. The TXIS bit is not set when a NACK is received. When STOP is received and the STOPIE bit of the I2C_CR1 register is set, the STOPF flag of the I2C_ISR register is set and an interrupt is generated. In most applications, the SBC bit is usually programmed to 0. In this case, if TXE = 0 when the target address is received (ADDR = 1), the user can choose either to send the content of the I2C_TXDR register as the first data byte, or to flush the I2C_TXDR register, by setting the TXE bit in order to program a new data byte. In target byte control mode (SBC = 1), the number of bytes to transmit must be programmed in NBYTES[7:0] in the address match interrupt subroutine (ADDR = 1). In this case, the number of TXIS events during the transfer corresponds to the value programmed in NBYTES[7:0].  Caution:   When NOSTRETCH = 1, the SCL clock is not stretched while the ADDR flag is set, so the user cannot flush the I2C_TXDR register content in the ADDR subroutine to program the first data byte. The first data byte to send must be previously programmed in the I2C_TXDR register:  •   This data can be the one written in the last TXIS event of the previous transmission message.  •   If this data byte is not the one to send, the I2C_TXDR register can be flushed, by setting the TXE bit, to program a new data byte. The STOPF bit must be cleared only after these actions. This guarantees that they are executed before the first data transmission starts, following the address acknowledge. If STOPF is still set when the first data transmission starts, an underrun error is generated (the OVR flag is set). If a TXIS event (transmit interrupt or transmit DMA request) is required, the user must set the TXIS bit in addition to the TXE bit, to generate the event.

Inter-integrated circuit interface (I2C)   RM0490  692/1027   RM0490 Rev 5  Figure 229. Transfer sequence flow for I2C target transmitter, NOSTRETCH = 0  MSv19851V3 Target initialization Target transmission Read ADDCODE and DIR in I2C_ISR Optional: Set I2C_ISR.TXE = 1 Set I2C_ICR.ADDRCF Write I2C_TXDR.TXDATA I2C_ISR.ADDR =1? No Yes I2C_ISR.TXIS =1? Yes No SCL stretched

RM0490 Rev 5   693/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Figure 230. Transfer sequence flow for I2C target transmitter, NOSTRETCH = 1  MSv19852V3 Target initialization Target transmission Optional: Set I2C_ISR.TXE = 1 and I2C_ISR.TXIS=1 Write I2C_TXDR.TXDATA I2C_ISR.STOPF =1? No Yes I2C_ISR.TXIS =1? Yes No Set I2C_ICR.STOPCF

Inter-integrated circuit interface (I2C)   RM0490  694/1027   RM0490 Rev 5  Figure 231. Transfer bus diagrams for I2C target transmitter (mandatory events only)  MSv19853V3 Example I2C   transmitter 3 bytes with 1st data flushed, NOSTRETCH=0: EV1: ADDR ISR: check ADDCODE and DIR, set TXE, set ADDRCF EV2: TXIS ISR: wr data1 EV3: TXIS ISR: wr data2 EV4: TXIS ISR: wr data3 EV5: TXIS ISR: wr data4 (not sent) ADDR A TXIS A TXIS NA TXIS TXE P legend: transmission reception SCL stretch EV1   EV2   EV4 EV5 Example I2C   transmitter 3 bytes, NOSTRETCH=1: EV1: wr data1 EV2: TXIS ISR: wr data2 EV3: TXIS ISR: wr data3 EV4: TXIS ISR: wr data4 (not sent) EV5: STOPF ISR: (optional: set TXE and TXIS), set STOPCF A TXIS   TXIS TXE legend: transmission reception SCL stretch EV2   EV3   EV4 TXIS EV1 STOPF EV5 Example I2C   transmitter 3 bytes without 1st data flush, NOSTRETCH=0: EV1: ADDR ISR: check ADDCODE and DIR, set ADDRCF EV2: TXIS ISR: wr data2 EV3: TXIS ISR: wr data3 EV4: TXIS ISR: wr data4 (not sent) ADDR   TXIS   TXIS   TXIS TXE legend : transmission reception SCL stretch EV1   EV2   EV3   EV4 TXIS EV3 S   Address   data1   A   data2   data3 A   NA   P S   Address   A   data1   A   data2   A   data3   NA   P A   data3 data2 data1 S   Address target target target

RM0490 Rev 5   695/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Target receiver  The RXNE bit of the I2C_ISR register is set when the I2C_RXDR is full, which generates an interrupt if the RXIE bit of the I2C_CR1 register is set. RXNE is cleared when I2C_RXDR is read. When STOP condition is received and the STOPIE bit of the I2C_CR1 register is set, the STOPF flag in the I2C_ISR register is set and an interrupt is generated.  Figure 232. Transfer sequence flow for I2C target receiver, NOSTRETCH = 0  MSv19855V3 Target initialization Target reception Read ADDCODE and DIR in I2C_ISR Set I2C_ICR.ADDRCF Write I2C_RXDR.RXDATA I2C_ISR.ADDR =1? No Yes I2C_ISR.RXNE =1? Yes No SCL stretched

Inter-integrated circuit interface (I2C)   RM0490  696/1027   RM0490 Rev 5  Figure 233. Transfer sequence flow for I2C target receiver, NOSTRETCH = 1 Figure 234. Transfer bus diagrams for I2C target receiver (mandatory events only)  MSv19856V3 Target initialization Target reception Read I2C_RXDR.RXDATA I2C_ISR.STOPF =1? No Yes I2C_ISR.RXNE =1? Yes No Set I2C_ICR.STOPCF  MSv19857V5 A ADDR A   A RXNE A RXNE RXNE EV1   EV2   EV3 A   A   A   A RXNE RXNE EV4 Example I2C target receiver 3 bytes, NOSTRETCH = 1: S   Address   data 1   data 2   data 3   P Example I2C target receiver 3 bytes, NOSTRETCH = 0: S   Address   data1   data2   data3 EV3 EV2 EV1 RXNE   RXNE   RXNE EV2: RXNE ISR: rd data1 EV4: RXNE ISR: rd data3 EV1: ADDR ISR: check ADDCODE and DIR, set ADDRCF EV3: RXNE ISR: rd data2 EV1: RXNE ISR: rd data1 EV3: RXNE ISR: rd data3 EV2: RXNE ISR: rd data2 Transmission Reception SCL stretch Legend Legend Transmission Reception SCL stretch

RM0490 Rev 5   697/1027  RM0490   Inter-integrated circuit interface (I2C)  741  25.4.9   I2C controller mode I2C controller initialization  Before enabling the peripheral, the I2C controller clock must be configured, by setting the SCLH and SCLL bits in the I2C_TIMINGR register. The STM32CubeMX tool calculates and provides the I2C_TIMINGR content in the   I2C Configuration   window. A clock synchronization mechanism is implemented in order to support multicontroller environment and target clock stretching. In order to allow clock synchronization:  •   The low level of the clock is counted using the SCLL counter, starting from the SCL low level internal detection.  •   The high level of the clock is counted using the SCLH counter, starting from the SCL high level internal detection. I2C detects its own SCL low level after a   t   SYNC1   delay   depending on the SCL falling edge, SCL input noise filters (analog and digital), and SCL synchronization to the I2CxCLK clock. I2C releases SCL to high level once the SCLL counter reaches the value programmed in the SCLL[7:0] bitfield of the I2C_TIMINGR register. I2C detects its own SCL high level after a   t   SYNC2   delay depending on the SCL rising edge, SCL input noise filters (analog and digital), and SCL synchronization to the I2CxCLK clock. I2C ties SCL to low level once the SCLH counter reaches the value programmed in the SCLH[7:0] bitfield of the I2C_TIMINGR register. Consequently the controller clock period is: t SCL =   t SYNC1   + t SYNC2 +   {[(SCLH+ 1) + (SCLL+ 1)] x (PRESC+ 1) x t   I2CCLK   } The duration of t SYNC1   depends upon:  •   SCL falling slope  •   input delay induced by the analog filter (when enabled)  •   input delay induced by the digital filter (when enabled): DNF[3:0]   x t   I2CCLK  •   delay due to SCL synchronization with the I2CCLK clock (two to three I2CCLK periods) The duration of t SYNC2   depends upon:  •   SCL rising slope  •   input delay induced by the analog filter (when enabled)  •   input delay induced by the digital filter (when enabled): DNF[3:0]   x t   I2CCLK  •   delay due to SCL synchronization with the I2CCLK clock (two to three I2CCLK periods)

Inter-integrated circuit interface (I2C)   RM0490  698/1027   RM0490 Rev 5  Figure 235. Controller clock generation  MSv19858V2 t SYNC1 SCL high level detected SCLH counter starts SCLH SCL  SCL controller clock generation  SCL released   SCL low level detected SCLL counter starts SCL driven low SCLL t SYNC2  SCL controller clock synchronization  SCLL SCL driven low by another device SCL low level detected SCLL counter starts   SCL released SCLH SCLH SCL high level detected SCLH counter starts   SCL high level detected SCLH counter starts SCL low level detected SCLL counter starts SCLL SCL driven low by another device SCLH SCL high level detected SCLH counter starts

RM0490 Rev 5   699/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Caution:   For compliance with the I²C-bus or SMBus specification, the controller clock must respect the timings in the following table.  Note:   The SCLL[7:0] bitfield also determines the   t   BUF   and   t   SU:STA   timings and SCLH[7:0] the t   HD:STA   and   t   SU:STO   timings   .  Refer to   Section 25.4.10   for examples of I2C_TIMINGR settings versus the I2CCLK frequency.  Controller communication initialization (address phase)  To initiate the communication with a target to address, set the following bitfields of the I2C_CR2 register:  •   ADD10: addressing mode (7-bit or 10-bit)  •   SADD[9:0]: target address to send  •   RD_WRN: transfer direction  •   HEAD10R: in case of 10-bit address read, this bit determines whether the header only (for direction change) or the complete address sequence is sent.  •   NBYTES[7:0]: the number of bytes to transfer; if equal to or greater than 255 bytes, the bitfield must initially be set to 0xFF.  Note:   Changing these bitfields is not allowed as long as the START bit is set.  Before launching the communication, make sure that the I²C-bus is idle. This can be checked using the bus idle detection function or by verifying that the IDR bits of the GPIOs selected as SDA and SCL are set. Any low-level incident on the I²C-bus lines that coincides with the START condition asserted by the I2C peripheral may cause its deadlock if not filtered out by the input filters. If such incidents cannot be prevented, design the software so that it restores the normal operation of the I2C peripheral in case of a deadlock, by toggling the PE bit of the I2C_CR1 register.  Table 111. I²C-bus and SMBus specification clock timings Symbol   Parameter Standard- mode (Sm) Fast-mode (Fm) Fast-mode Plus (Fm+)   SMBus Unit Min   Max   Min   Max   Min   Max   Min   Max  f   SCL   SCL clock frequency   -   100   -   400   -   1000   -   100   kHz t   HD:STA   Hold time (repeated) START condition   4.0   -   0.6   -   0.26   -   4.0   - μs t SU:STA Set-up time for a repeated START condition   4.7   -   0.6   -   0.26   -   4.7   - t SU:STO   Set-up time for STOP condition   4.0   -   0.6   -   0.26   -   4.0   - t BUF Bus free time between a STOP and START condition   4.7   -   1.3   -   0.5   -   4.7   - t   LOW   Low period of the SCL clock   4.7   -   1.3   -   0.5   -   4.7   - t HIGH   High period of the SCL clock   4.0   -   0.6   -   0.26   -   4.0   50 t r   Rise time of both SDA and SCL signals   -   1000   -   300   -   120   -   1000   ns t f   Fall time of both SDA and SCL signals   -   300   -   300   -   120   -   300

Inter-integrated circuit interface (I2C)   RM0490  700/1027   RM0490 Rev 5  To launch the communication, set the START bit of the I2C_CR2 register. The controller then automatically sends a START condition followed by the target address, either immediately if the BUSY flag is low, or t BUF   time after the BUSY flag transits from high to low state. The BUSY flag is set upon sending the START condition. In case of an arbitration loss, the controller automatically switches back to target mode and can acknowledge its own address if it is addressed as a target.  Note:   The START bit is reset by hardware when the target address is sent on the bus, whatever the received acknowledge value. The START bit is also reset by hardware upon arbitration loss. In 10-bit addressing mode, the controller automatically keeps resending the target address in a loop until the first address byte (first seven address bits) is acknowledged by the target. Setting the ADDRCF bit makes I2C quit that loop. If the I2C peripheral is addressed as a target (ADDR = 1) while the START bit is set, the I2C peripheral switches to target mode and the START bit is cleared. Note:   The same procedure is applied for a repeated START condition. In this case, BUSY = 1.  Figure 236. Controller initialization flow Initialization of a controller receiver addressing a 10-bit address target  If the target address is in 10-bit format, the user can choose to send the complete read sequence, by clearing the HEAD10R bit of the I2C_CR2 register. In this case, the controller automatically sends the following complete sequence after the START bit is set: (RE)START + Target address 10-bit header Write + Target address second byte + (RE)START + Target address 10-bit header Read.  Figure 237. 10-bit address read access with HEAD10R = 0  MSv19859V3 Initial settings Controller initialization Enable interrupts and/or DMA in I2C_CR1 End  MSv41066V2 DATA   A   P A DATA Target address 2nd byte Target address 1st 7 bits Sr A2 A1   R/W R/W Target address 1st 7 bits S   A3 1 1 1 1 0 X X   1 1 1 1 1 0 X X   0 Write   Read

RM0490 Rev 5   701/1027  RM0490   Inter-integrated circuit interface (I2C)  741  If the controller addresses a 10-bit address target, transmits data to this target and then reads data from the same target, a controller transmission flow must be done first. Then a repeated START is set with the 10-bit target address configured with HEAD10R = 1. In this case, the controller sends this sequence: RESTART + Target address 10-bit header Read.  Figure 238. 10-bit address read access with HEAD10R = 1 Controller transmitter  In the case of a write transfer, the TXIS flag is set after each byte transmission, after the ninth SCL pulse when an ACK is received. A TXIS event generates an interrupt if the TXIE bit of the I2C_CR1 register is set. The flag is cleared when the I2C_TXDR register is written with the next data byte to transmit. The number of TXIS events during the transfer corresponds to the value programmed in NBYTES[7:0]. If the total number of data bytes to transmit is greater than 255, the reload mode must be selected by setting the RELOAD bit in the I2C_CR2 register. In this case, when the NBYTES[7:0] number of data bytes is transferred, the TCR flag is set and the SCL line is stretched low until NBYTES[7:0] is written with a non-zero value. When RELOAD = 0 and the number of data bytes defined in NBYTES[7:0] is transferred:  •   In automatic end mode (AUTOEND = 1), a STOP condition is automatically sent.  •   In software end mode (AUTOEND = 0), the TC flag is set and the SCL line is stretched low, to perform software actions: –   A RESTART condition can be requested by setting the START bit of the I2C_CR2 register with the proper target address configuration and the number of bytes to transfer. Setting the START bit clears the TC flag and sends the START condition on the bus. –   A STOP condition can be requested by setting the STOP bit of the I2C_CR2 register. This clears the TC flag and sends a STOP condition on the bus. When a NACK is received, the TXIS flag is not set and a STOP condition is automatically sent. The NACKF flag of the I2C_ISR register is set. An interrupt is generated if the NACKIE bit is set.  MSv19823V2 DATA DATA Target address 2nd byte Target address 1st 7 bits Sr A A R/W Target address 1st 7 bits S   A 1 1 1 1 0 X X   1 1 1 1 1 0 X X   0 Write Read DATA   A   P A DATA A A/A R/W

Inter-integrated circuit interface (I2C)   RM0490  702/1027   RM0490 Rev 5  Figure 239. Transfer sequence flow for I2C controller transmitter, N   ≤   255 bytes  MSv19860V3 Controller initialization Controller transmission Write I2C_TXDR I2C_ISR.TXIS =1? No Yes I2C_ISR.NACKF = 1? Yes No NBYTES = N AUTOEND = 0 for RESTART; 1 for STOP Configure target address Set I2C_CR2.START End NBYTES transmitted? I2C_ISR.TC = 1? Yes End No Yes No   Set I2C_CR2.START with target address NBYTES ...

RM0490 Rev 5   703/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Figure 240. Transfer sequence flow for I2C controller transmitter, N > 255 bytes  MSv19861V4 Controller initialization Controller transmission Write I2C_TXDR I2C_ISR.TXIS =1? No Yes I2C_ISR.NACKF = 1? Yes No NBYTES = 0xFF; N=N-255 RELOAD = 1 Configure target address Set I2C_CR2.START End NBYTES transmitted? I2C_ISR.TC = 1? Yes End No Yes No Set I2C_CR2.START with target address NBYTES ... I2C_ISR.TCR = 1? Yes IF N< 256 NBYTES = N; N = 0; RELOAD = 0 AUTOEND = 0 for RESTART; 1 for STOP ELSE NBYTES = 0xFF; N = N-255 RELOAD = 1

Inter-integrated circuit interface (I2C)   RM0490  704/1027   RM0490 Rev 5  Figure 241. Transfer bus diagrams for I2C controller transmitter (mandatory events only)  MSv19862V3 Example I2C controller transmitter 2 bytes, automatic end mode (STOP) INIT: program   address, program NBYTES = 2, AUTOEND = 1, set START EV1: TXIS ISR: wr data1 EV2: TXIS ISR: wr data2 TXIS TXIS legend: transmission reception SCL stretch EV1 EV2 xx   2 INIT Example I2C controller transmitter 2 bytes, software end mode (RESTART) INIT: program   address, program NBYTES = 2, AUTOEND = 0, set START EV1: TXIS ISR: wr data1 EV2: TXIS ISR: wr data2 EV3: TC ISR: program   address, program NBYTES = N, set START TXIS TXIS   legend: transmission reception SCL stretch EV1   EV2 INIT TC TXE TXE EV3 NBYTES NBYTES   2 xx S   Address   A   data1   A   data2   ReS   Address A S   Address   A   data1   A   data2   A   P target target target

RM0490 Rev 5   705/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Controller receiver  In the case of a read transfer, the RXNE flag is set after each byte reception, after the eighth SCL pulse. An RXNE event generates an interrupt if the RXIE bit of the I2C_CR1 register is set. The flag is cleared when I2C_RXDR is read. If the total number of data bytes to receive is greater than 255, select the reload mode, by setting the RELOAD bit of the I2C_CR2 register. In this case, when the NBYTES[7:0] number of data bytes is transferred, the TCR flag is set and the SCL line is stretched low until NBYTES[7:0] is written with a non-zero value. When RELOAD = 0 and he number of data bytes defined in NBYTES[7:0] is transferred:  •   In automatic end mode (AUTOEND = 1), a NACK and a STOP are automatically sent after the last received byte.  •   In software end mode (AUTOEND = 0), a NACK is automatically sent after the last received byte. The TC flag is set and the SCL line is stretched low in order to allow software actions: –   A RESTART condition can be requested by setting the START bit of the I2C_CR2 register, with the proper target address configuration and the number of bytes to transfer. Setting the START bit clears the TC flag and sends the START condition and the target address on the bus. –   A STOP condition can be requested by setting the STOP bit of the I2C_CR2 register. This clears the TC flag and sends a STOP condition on the bus.

Inter-integrated circuit interface (I2C)   RM0490  706/1027   RM0490 Rev 5  Figure 242. Transfer sequence flow for I2C controller receiver, N   ≤   255 bytes  MSv19863V3 Controller initialization Controller reception Read I2C_RXDR I2C_ISR.RXNE =1? No Yes NBYTES = N AUTOEND = 0 for RESTART; 1 for STOP Configure target address Set I2C_CR2.START NBYTES received? I2C_ISR.TC = 1? Yes End No Yes No   Set I2C_CR2.START with target addess NBYTES ...

RM0490 Rev 5   707/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Figure 243. Transfer sequence flow for I2C controller receiver, N > 255 bytes  MSv19864V3 Controller initialization Controller reception Read I2C_RXDR I2C_ISR.RXNE =1? No Yes NBYTES = 0xFF; N=N-255 RELOAD =1 Configure target address Set I2C_CR2.START NBYTES received? I2C_ISR.TC = 1? Yes End No Yes No Set I2C_CR2.START with target address NBYTES ... I2C_ISR.TCR = 1? Yes IF N< 256 NBYTES =N; N=0;RELOAD=0 AUTOEND=0 for RESTART; 1 for STOP ELSE NBYTES =0xFF;N=N-255 RELOAD=1 No

Inter-integrated circuit interface (I2C)   RM0490  708/1027   RM0490 Rev 5  Figure 244. Transfer bus diagrams for I2C controller receiver (mandatory events only) 25.4.10   I2C_TIMINGR register configuration examples  The following tables provide examples of how to program the I2C_TIMINGR register to obtain timings compliant with the I²C-bus specification. To get more accurate configuration values, use the STM32CubeMX tool ( I2C Configuration   window).  MSv19865V2 Example I2C   receiver 2 bytes, automatic end mode (STOP) INIT: program   address, program NBYTES = 2, AUTOEND=1, set START EV1: RXNE ISR: rd data1 EV2: RXNE ISR: rd data2 A RXNE   RXNE NBYTES legend: transmission reception SCL stretch EV1 xx   2 INIT Example I2C   receiver 2 bytes, software end mode (RESTART) INIT: program   address, program NBYTES = 2, AUTOEND=0, set START EV1: RXNE ISR: rd data1 EV2: RXNE ISR: read data2 EV3: TC ISR: program   address, program NBYTES = N, set START A RXNE   RXNE NBYTES legend: transmission reception SCL stretch EV1   EV2 xx INIT N EV2 2 TC Address S   A   data1   data2   NA   ReS   Address S   Address   A   data1   data2   NA   P controller controller target target target

RM0490 Rev 5   709/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Table 112. Timing settings for   f   I2CCLK   of 8 MHz Parameter Standard-mode (Sm)   Fast-mode (Fm)   Fast-mode Plus (Fm+) 10 kHz   100 kHz   400 kHz   500 kHz  PRESC[3:0]   0x1   0x1   0x0   0x0 SCLL[7:0]   0xC7   0x13   0x9   0x6 t   SCLL   200 x 250 ns = 50 μs   20 x 250 ns = 5.0 μs   10 x 125 ns = 1250 ns   7 x 125 ns = 875 ns SCLH[7:0]   0xC3   0xF   0x3   0x3 t   SCLH   196 x 250 ns = 49 μs   16 x 250 ns = 4.0 μs   4 x 125 ns = 500 ns   4 x 125 ns = 500 ns t SCL (1)   ~100 μs   (2)   ~10 μs (2)   ~2.5 μs (3)   ~2.0 μs   (4) SDADEL[3:0]   0x2   0x2   0x1   0x0 t   SDADEL   2 x 250 ns = 500 ns   2 x 250 ns = 500 ns   1 x 125 ns = 125 ns   0 ns SCLDEL[3:0]   0x4   0x4   0x3   0x1 t   SCLDEL   5 x 250 ns = 1250 ns   5 x 250 ns = 1250 ns   4 x 125 ns = 500 ns   2 x 125 ns = 250 ns 1.   t   SCL   is greater than t   SCLL   + t   SCLH   due to SCL internal detection delay. Values provided for t   SCL   are examples only. 2.   t   SYNC1   +   t   SYNC2   minimum value is 4 x t I2CCLK   = 500 ns. Example with t   SYNC1   +   t   SYNC2   = 1000 ns. 3.   t   SYNC1   +   t   SYNC2   minimum value is 4 x t I2CCLK   = 500 ns. Example with t   SYNC1   +   t   SYNC2   = 750 ns. 4.   t   SYNC1   +   t   SYNC2   minimum value is 4 x t I2CCLK   = 500 ns. Example with t   SYNC1   + t SYNC2   = 655 ns.  Table 113. Timing settings for   f   I2CCLK   of 16 MHz Parameter Standard-mode (Sm)   Fast-mode (Fm)   Fast-mode Plus (Fm+) 10 kHz   100 kHz   400 kHz   1000 kHz  PRESC[3:0]   0x3   0x3   0x1   0x0 SCLL[7:0]   0xC7   0x13   0x9   0x4 t SCLL   200 x 250 ns = 50 μs   20 x 250 ns = 5.0 μs   10 x 125 ns = 1250 ns   5 x 62.5 ns = 312.5 ns SCLH[7:0]   0xC3   0xF   0x3   0x2 t SCLH   196 x 250 ns = 49 μs   16 x 250 ns = 4.0 μs   4 x 125 ns = 500 ns   3 x 62.5 ns = 187.5 ns t   SCL (1)   ~100 μs   (2)   ~10 μs   (2)   ~2.5 μs (3)   ~1.0 μs   (4) SDADEL[3:0]   0x2   0x2   0x2   0x0 t SDADEL   2 x 250 ns = 500 ns   2 x 250 ns = 500 ns   2 x 125 ns = 250 ns   0 ns SCLDEL[3:0]   0x4   0x4   0x3   0x2 t SCLDEL   5 x 250 ns = 1250 ns   5 x 250 ns = 1250 ns   4 x 125 ns = 500 ns   3 x 62.5 ns = 187.5 ns 1.   t   SCL   is greater than t   SCLL   + t   SCLH   due to SCL internal detection delay. Values provided for t   SCL   are examples only. 2.   t   SYNC1 +   t   SYNC2   minimum value is 4 x t   I2CCLK   = 250 ns. Example with t SYNC1 +   t   SYNC2   = 1000 ns. 3.   t   SYNC1 +   t   SYNC2   minimum value is 4 x t   I2CCLK   = 250 ns. Example with t SYNC1 +   t   SYNC2   = 750 ns. 4.   t   SYNC1 +   t   SYNC2   minimum value is 4 x t   I2CCLK   = 250 ns. Example with t SYNC1 +   t   SYNC2   = 500 ns.

Inter-integrated circuit interface (I2C)   RM0490  710/1027   RM0490 Rev 5  25.4.11   SMBus specific features  Introduction  The system management bus (SMBus) is a two-wire interface through which various devices can communicate with each other and with the rest of the system. It is based on operation principles of the I²C-bus. The SMBus provides a control bus for system and power management related tasks. The I2C peripheral is compatible with the SMBus specification (http://smbus.org). The system management bus specification refers to three types of devices:  •   Target   is a device that receives or responds to a command.  •   Controller   is a device that issues commands, generates clocks, and terminates the transfer.  •   Host   is a specialized controller that provides the main interface to the system CPU. A host must be a controller-target and must support the SMBus   host notify   protocol. Only one host is allowed in a system. The I2C peripheral can be configured as a controller or a target device, and also as a host.  Bus protocols  There are eleven possible command protocols for any given device. The device can use any or all of them to communicate. These are:   Quick Command ,   Send Byte ,   Receive Byte ,   Write  Table 114. Timing settings for   f   I2CCLK   of 48 MHz Parameter Standard-mode (Sm)   Fast-mode (Fm)   Fast-mode Plus (Fm+) 10 kHz   100 kHz   400 kHz   1000 kHz  PRESC[3:0]   0xB   0xB   0x5   0x5 SCLL[7:0]   0xC7   0x13   0x9   0x3 t   SCLL   200 x 250 ns = 50 μs   20 x 250 ns = 5.0 μs   10 x 125 ns = 1250 ns   4 x 125 ns = 500 ns SCLH[7:0]   0xC3   0xF   0x3   0x1 t   SCLH   196 x 250 ns = 49 μs   16 x 250 ns = 4.0 μs   4 x 125 ns = 500 ns   2 x 125 ns = 250 ns t   SCL (1)   ~100 μs   (2)   ~10 μs   (2)   ~2.5 μs   (3)   ~875 ns   (4) SDADEL[3:0]   0x2   0x2   0x3   0x0 t   SDADEL   2 x 250 ns = 500 ns   2 x 250 ns = 500 ns   3 x 125 ns = 375 ns   0 ns SCLDEL[3:0]   0x4   0x4   0x3   0x1 t   SCLDEL   5 x 250 ns = 1250 ns   5 x 250 ns = 1250 ns   4 x 125 ns = 500 ns   2 x 125 ns = 250 ns 1.   t   SCL   is greater than t   SCLL   + t   SCLH   due to the SCL internal detection delay. Values provided for t   SCL   are only examples. 2.   t   SYNC1 +   t   SYNC2   minimum value is 4x t   I2CCLK   = 83.3 ns. Example with t SYNC1 +   t   SYNC2   = 1000 ns 3.   t   SYNC1 +   t   SYNC2   minimum value is 4x t   I2CCLK   = 83.3 ns. Example with t SYNC1 +   t   SYNC2   = 750 ns 4.   t   SYNC1 +   t   SYNC2   minimum value is 4x t   I2CCLK   = 83.3 ns. Example with t SYNC1 +   t   SYNC2   = 250 ns This section pertains to the instances of the I2C peripheral supporting SMBus. Refer to  Section 25.3: I2C implementation .

RM0490 Rev 5   711/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Byte ,   Write Word ,   Read Byte ,   Read Word ,   Process Call ,   Block Read ,   Block Write , and   Block Write-Block Read Process Call . The protocols must be implemented by the user software. For more details on these protocols, refer to the SMBus specification (http://smbus.org).  Address resolution protocol (ARP)  SMBus target address conflicts can be resolved by dynamically assigning a new unique address to each target device. To provide a mechanism to isolate each device for the purpose of address assignment, each device must implement a unique 128-bit device identifier (UDID). In the I2C peripheral, it is implemented by software. The I2C peripheral supports the Address resolution protocol (ARP). The SMBus device default address (0b1100 001) is enabled by setting the SMBDEN bit of the I2C_CR1 register. The ARP commands must be implemented by the user software. Arbitration is also performed in target mode for ARP support. For more details on the SMBus address resolution protocol, refer to the SMBus specification (http://smbus.org).  Received command and data acknowledge control  An SMBus receiver must be able to NACK each received command or data. In order to allow the ACK control in target mode, the target byte control mode must be enabled, by setting the SBC bit of the I2C_CR1 register. Refer to   Target byte control mode   for more details.  Host notify protocol  To enable the host notify protocol, set the SMBHEN bit of the I2C_CR1 register. The I2C peripheral then acknowledges the SMBus host address (0b0001 000). When this protocol is used, the device acts as a controller and the host as a target.  SMBus alert  The I2C peripheral supports the SMBALERT# optional signal through the SMBA pin. With the SMBALERT# signal, an SMBus target device can signal to the SMBus host that it wants to talk. The host processes the interrupt and simultaneously accesses all SMBALERT# devices through the alert response address (0b0001 100). Only the device/devices which pulled SMBALERT# low acknowledges/acknowledge the alert response address. When the I2C peripheral is configured as an SMBus target device (SMBHEN = 0), the SMBA pin is pulled low by setting the ALERTEN bit of the I2C_CR1 register. The alert response address is enabled at the same time. When the I2C peripheral is configured as an SMBus host (SMBHEN = 1), the ALERT flag of the I2C_ISR register is set when a falling edge is detected on the SMBA pin and ALERTEN = 1. An interrupt is generated if the ERRIE bit of the I2C_CR1 register is set. When ALERTEN = 0, the alert line is considered high even if the external SMBA pin is low.  Note:   If the SMBus alert pin is not required, keep the ALERTEN bit cleared. The SMBA pin can then be used as a standard GPIO.  STM32CubeMX implements an SMBus stack thanks to X-CUBE-SMBUS, a downloadable software pack that allows basic SMBus configuration per I2C instance supporting SMBus.

Inter-integrated circuit interface (I2C)   RM0490  712/1027   RM0490 Rev 5  Packet error checking  A packet error checking mechanism introduced in the SMBus specification improves reliability and communication robustness. The packet error checking is implemented by appending a packet error code (PEC) at the end of each message transfer. The PEC is calculated by using the C(x) = x   8   + x 2   + x + 1 CRC-8 polynomial on all the message bytes (including addresses and read/write bits). The I2C peripheral embeds a hardware PEC calculator and allows a not acknowledge to be sent automatically when the received byte does not match the hardware calculated PEC.  Timeouts  To comply with the SMBus timeout specifications, the I2C peripheral embeds hardware timers.  Table 115. SMBus timeout specifications Symbol   Parameter Limits Unit Min   Max  t TIMEOUT   Detect clock low timeout   25   35 ms t LOW:SEXT (1) 1.   t   LOW:SEXT   is the cumulative time a given target device is allowed to extend the clock cycles in one message from the initial START to the STOP. It is possible that another target device or the controller also extends the clock causing the combined clock low extend time to be greater than t   LOW:SEXT   . The value provided applies to a single target device connected to a full-target controller. Cumulative clock low extend time (target device)   -   25 t LOW:MEXT (2) 2.   t   LOW:MEXT   is the cumulative time a controller device is allowed to extend its clock cycles within each byte of a message as defined from START-to-ACK, ACK-to-ACK, or ACK-to-STOP. It is possible that a target device or another controller also extends the clock, causing the combined clock low time to be greater than t   LOW:MEXT   on a given byte. The value provided applies to a single target device connected to a full-target controller. Cumulative clock low extend time (controller device)   -   10

RM0490 Rev 5   713/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Figure 245. Timeout intervals for t   LOW:SEXT , t LOW:MEXT Bus idle detection  A controller can assume that the bus is free if it detects that the clock and data signals have been high for   t IDLE   > t HIGH   (max) (refer to the table in   Section 25.4.9 ). This timing parameter covers the condition where a controller is dynamically added to the bus, and may not have detected a state transition on the SMBCLK or SMBDAT lines. In this case, the controller must wait long enough to ensure that a transfer is not currently in progress. The I2C peripheral supports a hardware bus idle detection.  25.4.12   SMBus initialization  In addition to the I2C initialization for the I²C-bus, the use of the peripheral for the SMBus communication requires some extra initialization steps.  Received command and data acknowledge control (target mode)  An SMBus receiver must be able to NACK each received command or data. To allow ACK control in target mode, the target byte control mode must be enabled, by setting the SBC bit of the I2C_CR1 register. Refer to   Target byte control mode   for more details.  Specific addresses (target mode)  The specific SMBus addresses must be enabled if required. Refer to   Bus idle detection   for more details. The SMBus device default address (0b1100 001) is enabled by setting the SMBDEN bit of the I2C_CR1 register. The SMBus host address (0b0001 000) is enabled by setting the SMBHEN bit of the I2C_CR1 register.  MS19866V1 Start   Stop t LOW:SEXT t LOW:MEXT   t LOW:MEXT   t LOW:MEXT Clk   Ack   Clk   Ack SMBCLK SMBDAT  This section pertains to the instances of the I2C peripheral supporting SMBus. Refer to  Section 25.3: I2C implementation .

Inter-integrated circuit interface (I2C)   RM0490  714/1027   RM0490 Rev 5  The alert response address (0b0001100)   is enabled by setting the ALERTEN bit of the I2C_CR1 register.  Packet error checking  PEC calculation is enabled by setting the PECEN bit of the I2C_CR1 register. Then the PEC transfer is managed with the help of the hardware byte counter associated with the NBYTES[7:0] bitfield of the I2C_CR2 register. The PECEN bit must be configured before enabling the I2C. The PEC transfer is managed with the hardware byte counter, so the SBC bit must be set when interfacing the SMBus in target mode. The PEC is transferred after transferring NBYTES[7:0] - 1 data bytes, if the PECBYTE bit is set and the RELOAD bit is cleared. If RELOAD is set, PECBYTE has no effect.  Caution:   Changing the PECEN configuration is not allowed when the I2C peripheral is enabled.  Timeout detection  The timeout detection is enabled by setting the TIMOUTEN and TEXTEN bits of the I2C_TIMEOUTR register. The timers must be programmed in such a way that they detect a timeout before the maximum time given in the SMBus specification.  t   TIMEOUT   check  To check the t TIMEOUT   parameter, load the 12-bit TIMEOUTA[11:0] bitfield with the timer reload value. Keep the TIDLE bit at 0 to detect the SCL low level timeout. Then set the TIMOUTEN bit of the I2C_TIMEOUTR register, to enable the timer. If SCL is tied low for longer than the (TIMEOUTA + 1) x 2048 x   t I2CCLK   period, the TIMEOUT flag of the I2C_ISR register is set. Refer to   Table 117 .  Caution:   Changing the TIMEOUTA[11:0] bitfield and the TIDLE bit values is not allowed when the TIMEOUTEN bit is set.  t   LOW:SEXT   and   t   LOW:MEXT   check  A 12-bit timer associated with the TIMEOUTB[11:0] bitfield allows checking t   LOW:SEXT   for the I2C peripheral operating as a target, or t   LOW:MEXT   when it operates as a controller. As the standard only specifies a maximum, the user can choose the same value for both. The timer is then enabled by setting the TEXTEN bit in the I2C_TIMEOUTR register. If the SMBus peripheral performs a cumulative SCL stretch for longer than the (TIMEOUTB + 1) x 2048 x t I2CCLK   period, and within the timeout interval described in   Bus idle detection  section, the TIMEOUT flag of the I2C_ISR register is set. Refer to   Table 118 .  Table 116. SMBus with PEC configuration Mode   SBC bit   RELOAD bit   AUTOEND bit   PECBYTE bit  Controller Tx/Rx NBYTES + PEC+ STOP   X   0   1   1 Controller Tx/Rx NBYTES + PEC + ReSTART   X   0   0   1 Target Tx/Rx with PEC   1   0   X   1

RM0490 Rev 5   715/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Caution:   Changing the TIMEOUTB[11:0] bitfield value is not allowed when the TEXTEN bit is set.  Bus idle detection  To check the   t IDLE   period, the TIMEOUTA[11:0] bitfield associated with 12-bit timer must be loaded with the timer reload value. Keep the TIDLE bit at 1 to detect both SCL and SDA high level timeout. Then set the TIMOUTEN bit of the I2C_TIMEOUTR register to enable the timer. If both the SCL and SDA lines remain high for longer than the (TIMEOUTA + 1) x 4 x t I2CCLK   period, the TIMEOUT flag of the I2C_ISR register is set. Refer to   Table 119 .  Caution:   Changing the TIMEOUTA[11:0] bitfield and the TIDLE bit values is not allowed when the TIMEOUTEN bit is set.  25.4.13   SMBus I2C_TIMEOUTR register configuration examples  The following tables provide examples of settings to reach desired t   TIMEOUT , t LOW:SEXT   , t LOW:MEXT   , and t   IDLE   timings at different f   I2CCLK   frequencies. This section pertains to the instances of the I2C peripheral supporting SMBus. Refer to  Section 25.3: I2C implementation .  Table 117. TIMEOUTA[11:0] for maximum t   TIMEOUT   of 25 ms f I2CCLK   TIMEOUTA[11:0]   TIDLE   TIMEOUTEN   t TIMEOUT  8 MHz   0x61   0   1   98 x 2048 x 125 ns = 25 ms 16 MHz   0xC3   0   1   196 x 2048 x 62.5 ns = 25 ms 48 MHz   0x249   0   1   586 x 2048 x 20.08 ns = 25 ms  Table 118. TIMEOUTB[11:0] for maximum t   LOW:SEXT   and t   LOW:MEXT   of 8 ms f   I2CCLK   TIMEOUTB[11:0]   TEXTEN   t LOW:SEXT t   LOW:MEXT  8 MHz   0x1F   1   32 x 2048 x 125 ns = 8 ms 16 MHz   0x3F   1   64 x 2048 x 62.5 ns = 8 ms 48 MHz   0xBB   1   188 x 2048 x 20.08 ns = 8 ms  Table 119. TIMEOUTA[11:0] for maximum t   IDLE   of 50 μs f   I2CCLK   TIMEOUTA[11:0]   TIDLE   TIMEOUTEN   t IDLE  8 MHz   0x63   1   1   100 x 4 x 125 ns = 50 μs 16 MHz   0xC7   1   1   200 x 4 x 62.5 ns = 50 μs 48 MHz   0x257   1   1   600 x 4 x 20.08 ns = 50 μs

Inter-integrated circuit interface (I2C)   RM0490  716/1027   RM0490 Rev 5  25.4.14   SMBus target mode  In addition to I2C target transfer management (refer to   Section 25.4.8: I2C target mode ), this section provides extra software flowcharts to support SMBus.  SMBus target transmitter  When using the I2C peripheral in SMBus mode, set the SBC bit to enable the PEC transmission at the end of the programmed number of data bytes. When the PECBYTE bit is set, the number of bytes programmed in NBYTES[7:0] includes the PEC transmission. In that case, the total number of TXIS interrupts is NBYTES[7:0] - 1, and the content of the I2C_PECR register is automatically transmitted if the controller requests an extra byte after the transfer of the NBYTES[7:0] - 1 data bytes.  Caution:   The PECBYTE bit has no effect when the RELOAD bit is set.  Figure 246. Transfer sequence flow for SMBus target transmitter N bytes + PEC  This section pertains to the instances of the I2C peripheral supporting SMBus. Refer to  Section 25.3: I2C implementation .  MSv19867V3 Target initialization SMBus target transmission Write I2C_TXDR.TXDATA I2C_ISR.TXIS = 1? No Yes I2C_ISR.ADDR = 1? Yes No Read ADDCODE and DIR in I2C_ISR I2C_CR2.NBYTES = N + 1 PECBYTE = 1 Set I2C_ICR.ADDRCF SCL stretched

RM0490 Rev 5   717/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Figure 247. Transfer bus diagram for SMBus target transmitter (SBC = 1) SMBus target receiver  When using the I2C peripheral in SMBus mode, set the SBC bit to enable the PEC checking at the end of the programmed number of data bytes. To allow the ACK control of each byte, the reload mode must be selected (RELOAD = 1). Refer to   Target byte control mode   for more details. To check the PEC byte, the RELOAD bit must be cleared and the PECBYTE bit must be set. In this case, after the receipt of NBYTES[7:0] - 1 data bytes, the next received byte is compared with the internal I2C_PECR register content. A NACK is automatically generated if the comparison does not match, and an ACK is automatically generated if the comparison matches, whatever the ACK bit value. Once the PEC byte is received, it is copied into the I2C_RXDR register like any other data, and the RXNE flag is set. Upon a PEC mismatch, the PECERR flag is set and an interrupt is generated if the ERRIE bit of the I2C_CR1 register is set. If no ACK software control is required, the user can set the PECBYTE bit and, in the same write operation, load NBYTES[7:0] with the number of bytes to receive in a continuous flow. After the receipt of NBYTES[7:0] - 1 bytes, the next received byte is checked as being the PEC.  Caution:   The PECBYTE bit has no effect when the RELOAD bit is set.  MSv19869V3 Example SMBus   transmitter 2 bytes + PEC EV1: ADDR ISR: check ADDCODE, program NBYTES = 3, set PECBYTE, set ADDRCF EV2: TXIS ISR: wr data1 EV3: TXIS ISR: wr data2 ADDR legend: transmission reception SCL stretch EV1   EV2 TXIS   TXIS EV3 NBYTES   3 S   Address   A   A data1   data2   PEC A   NA   P target

Inter-integrated circuit interface (I2C)   RM0490  718/1027   RM0490 Rev 5  Figure 248. Transfer sequence flow for SMBus target receiver N bytes + PEC  MSv19868V3 Target initialization SMBus target reception Read I2C_RXDR.RXDATA I2C_ISR.RXNE =1? I2C_ISR.TCR = 1? No Yes I2C_ISR.ADDR = 1? Yes No Read ADDCODE and DIR in I2C_ISR I2C_CR2.NBYTES = 1, RELOAD = 1 PECBYTE = 1 Set I2C_ICR.ADDRCF SCL stretched Read I2C_RXDR.RXDATA Program I2C_CR2.NACK = 0 I2C_CR2.NBYTES = 1 N = N - 1 N = 1? Read I2C_RXDR.RXDATA Program RELOAD = 0 NACK = 0 and NBYTES = 1 I2C_ISR.RXNE = 1? No End No Yes Yes

RM0490 Rev 5   719/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Figure 249. Bus transfer diagrams for SMBus target receiver (SBC = 1) 25.4.15   SMBus controller mode  In addition to I2C controller transfer management (refer to   Section 25.4.9: I2C controller mode ), this section provides extra software flowcharts to support SMBus.  SMBus controller transmitter  When the SMBus controller wants to transmit the PEC, the PECBYTE bit must be set and the number of bytes must be loaded in the NBYTES[7:0] bitfield, before setting the START bit. In this case, the total number of TXIS interrupts is NBYTES[7:0] - 1. So if the PECBYTE bit is set when NBYTES[7:0] = 0x1, the content of the I2C_PECR register is automatically transmitted.  MSv19870V3 Example SMBus   receiver 2 bytes + PEC Address S EV1: ADDR ISR: check ADDCODE and DIR, program NBYTES = 3, PECBYTE =1, RELOAD = 0, set ADDRCF EV2: RXNE ISR: rd data1 EV3: RXNE ISR: rd data2 EV4: RXNE ISR: rd PEC A   data1   A   data2   A RXNE PEC   A RXNE P legend: transmission reception SCL stretch EV1   EV2   EV3   EV4 ADDR   RXNE NBYTES Example SMBus   receiver 2 bytes + PEC, with ACK control (RELOAD = 1/0) Address S EV1: ADDR ISR: check ADDCODE and DIR, program NBYTES = 1, PECBYTE = 1, RELOAD = 1, set ADDRCF EV2: RXNE-TCR ISR: rd data1, program NACK=0 and NBYTES = 1 EV3: RXNE-TCR ISR: rd data2, program NACK=0, NBYTES = 1 and RELOAD = 0 EV4: RXNE-TCR ISR: rd PEC A ADDR data1   A   data2   A RXNE,TCR PEC   A RXNE,TCR P legend : transmission reception SCL stretch 3 V E 2 V E 1 V E RXNE EV4 NBYTES   1 3 target target  This section pertains to the instances of the I2C peripheral supporting SMBus. Refer to  Section 25.3: I2C implementation .

Inter-integrated circuit interface (I2C)   RM0490  720/1027   RM0490 Rev 5  If the SMBus controller wants to send a STOP condition after the PEC, the automatic end mode must be selected (AUTOEND = 1). In this case, the STOP condition automatically follows the PEC transmission. When the SMBus controller wants to send a RESTART condition after the PEC, the software mode must be selected (AUTOEND = 0). In this case, once NBYTES[7:0] - 1 are transmitted, the I2C_PECR register content is transmitted. The TC flag is set after the PEC transmission, stretching the SCL line low. The RESTART condition must be programmed in the TC interrupt subroutine.  Caution:   The PECBYTE bit has no effect when the RELOAD bit is set.  Figure 250. Bus transfer diagrams for SMBus controller transmitter  MSv19871V3 Example SMBus controller transmitter 2 bytes + PEC, automatic end mode (STOP) Address S INIT: program target address, program NBYTES = 3, AUTOEND=1, set PECBYTE, set START EV1: TXIS ISR: wr data1 EV2: TXIS ISR: wr data2 A   data1   A TXIS TXIS data2   A NBYTES A legend: transmission reception SCL stretch EV1 xx   3 INIT Example SMBus controller transmitter 2 bytes + PEC, software end mode (RESTART) INIT: program target address, program NBYTES = 3, AUTOEND=0, set PECBYTE, set START EV1: TXIS ISR: wr data1 EV2: TXIS ISR: wr data2 EV3: TC ISR: program target address, program NBYTES = N, set START NBYTES Rstart legend: transmission reception SCL stretch xx Address N PEC   P EV2 A 3 TXE Address S   A   data1   A TXIS   TXIS data2   A EV1 INIT PEC EV2 TC EV3

RM0490 Rev 5   721/1027  RM0490   Inter-integrated circuit interface (I2C)  741  SMBus controller receiver  When the SMBus controller wants to receive, at the end of the transfer, the PEC followed by a STOP condition, the automatic end mode can be selected (AUTOEND = 1). The PECBYTE bit must be set and the target address programmed before setting the START bit. In this case, after the receipt of NBYTES[7:0] - 1 data bytes, the next received byte is automatically checked versus the I2C_PECR register content. A NACK response is given to the PEC byte, followed by a STOP condition. When the SMBus controller receiver wants to receive, at the end of the transfer, the PEC byte followed by a RESTART condition, the software mode must be selected (AUTOEND = 0). The PECBYTE bit must be set and the target address programmed before setting the START bit. In this case, after the receipt of NBYTES[7:0] - 1 data bytes, the next received byte is automatically checked versus the I2C_PECR register content. The TC flag is set after the PEC byte reception, stretching the SCL line low. The RESTART condition can be programmed in the TC interrupt subroutine.  Caution:   The PECBYTE bit has no effect when the RELOAD bit is set.

Inter-integrated circuit interface (I2C)   RM0490  722/1027   RM0490 Rev 5  Figure 251. Bus transfer diagrams for SMBus controller receiver 25.4.16   Wake-up from Stop mode on address match  The I2C peripheral is able to wake up the device from Stop mode (APB clock is off), when the device is addressed. All addressing modes are supported. The wake-up from Stop mode is enabled by setting the WUPEN bit of the I2C_CR1 register. The HSI48 oscillator must be selected as the clock source for I2CCLK to allow the wake-up from Stop mode. In Stop mode, the HSI48 oscillator is stopped. Upon detecting START condition, the I2C interface starts the HSI48 oscillator and stretches SCL low until the oscillator wakes up. HSI48 is then used for the address reception.  MSv19872V3 Example SMBus controller receiver 2 bytes + PEC, automatic end mode (STOP) Address S INIT: program target address, program NBYTES = 3, AUTOEND=1, set PECBYTE, set START EV1: RXNE ISR: rd data1 EV2: RXNE ISR: rd data2 EV3: RXNE ISR: rd PEC A   data1   A RXNE   RXNE data2   A NBYTES NA legend: transmission reception SCL stretch 3 V E 1 V E xx   3 INIT Example SMBus controller receiver 2 bytes + PEC, software end mode (RESTART) Address S INIT: program target address, program NBYTES = 3, AUTOEND = 0, set PECBYTE, set START EV1: RXNE ISR: rd data1 EV2: RXNE ISR: rd data2 EV3: RXNE ISR: read PEC EV4: TC ISR: program target address, program NBYTES = N, set START A   data1   A RXNE   RXNE data2   A NBYTES Restart legend: transmission reception SCL stretch EV1   EV2 xx INIT Address N PEC   P RXNE EV2 NA PEC RXNE 3 EV3 TC EV4  This section pertains to I2C instances supporting the wake-up from Stop mode feature (refer to   Section 25.3) .

RM0490 Rev 5   723/1027  RM0490   Inter-integrated circuit interface (I2C)  741  If the received address matches the device own address, I2C stretches SCL low until the device wakes up. The stretch is released when the ADDR flag is cleared by software. Then the transfer goes on normally. If the address does not match, the HSI48 oscillator is stopped again and the device does not wake up.  Note:   When the system clock is used as I2C clock, or when WUPEN = 0,   the HSI48 oscillator does not start upon receiving START condition. Only an ADDR interrupt can wake the device up. Therefore, do not enter Stop mode when I2C is performing a transfer, either as a controller or as an addressed target after the ADDR flag is set. This can be managed by clearing the SLEEPDEEP bit in the ADDR interrupt routine and setting it again only after the STOPF flag is set.  Caution:   The digital filter is not compatible with the wake-up from Stop mode feature. Before entering Stop mode with the WUPEN bit set, deactivate the digital filter, by writing zero to the DNF[3:0] bitfield.  Caution:   The feature is only available when the HSI48 oscillator is selected as the I2C clock.  Caution:   Clock stretching must be enabled (NOSTRETCH = 0) to ensure proper operation of the wake-up from Stop mode feature.  Caution:   If the wake-up from Stop mode is disabled (WUPEN = 0), the I2C peripheral must be disabled before entering Stop mode (PE = 0).  25.4.17   Error conditions  The following errors are the conditions that can cause the communication to fail.  Bus error (BERR)  A bus error is detected when a START or a STOP condition is detected and is not located after a multiple of nine SCL clock pulses. START or STOP condition is detected when an SDA edge occurs while SCL is high. The bus error flag is set only if the I2C peripheral is involved in the transfer as controller or addressed target (that is, not during the address phase in target mode). In case of a misplaced START or RESTART detection in target mode, the I2C peripheral enters address recognition state like for a correct START condition. When a bus error is detected, the BERR flag of the I2C_ISR register is set, and an interrupt is generated if the ERRIE bit of the I2C_CR1 register is set.  Arbitration loss (ARLO)  An arbitration loss is detected when a high level is sent on the SDA line, but a low level is sampled on the SCL rising edge. In controller mode, arbitration loss is detected during the address phase, data phase and data acknowledge phase. In this case, the SDA and SCL lines are released, the START control bit is cleared by hardware and the controller switches automatically to target mode. In target mode, arbitration loss is detected during data phase and data acknowledge phase. In this case, the transfer is stopped and the SCL and SDA lines are released. When an arbitration loss is detected, the ARLO flag of the I2C_ISR register is set and an interrupt is generated if the ERRIE bit of the I2C_CR1 register is set.

Inter-integrated circuit interface (I2C)   RM0490  724/1027   RM0490 Rev 5  Overrun/underrun error (OVR)  An overrun or underrun error is detected in target mode when NOSTRETCH = 1 and:  •   In reception when a new byte is received and the RXDR register has not been read yet. The new received byte is lost, and a NACK is automatically sent as a response to the new byte.  •   In transmission: –   When STOPF = 1 and the first data byte must be sent. The content of the I2C_TXDR register is sent if TXE = 0, 0xFF if not. –   When a new byte must be sent and the I2C_TXDR register has not been written yet, 0xFF is sent. When an overrun or underrun error is detected, the OVR flag of the I2C_ISR register is set and an interrupt is generated if the ERRIE bit of the I2C_CR1 register is set.  Packet error checking error (PECERR)  A PEC error is detected when the received PEC byte does not match the I2C_PECR register content. A NACK is automatically sent after the wrong PEC reception. When a PEC error is detected, the PECERR flag of the I2C_ISR register is set and an interrupt is generated if the ERRIE bit of the I2C_CR1 register is set.  Timeout error (TIMEOUT)  A timeout error occurs for any of these conditions:  •   TIDLE = 0 and SCL remains low for the time defined in the TIMEOUTA[11:0] bitfield: this is used to detect an SMBus timeout.  •   TIDLE = 1 and both SDA and SCL remains high for the time defined in the TIMEOUTA [11:0] bitfield: this is used to detect a bus idle condition.  •   Controller cumulative clock low extend time reaches the time defined in the TIMEOUTB[11:0] bitfield (SMBus t   LOW:MEXT   parameter).  •   Target cumulative clock low extend time reaches the time defined in the TIMEOUTB[11:0] bitfield (SMBus t   LOW:SEXT   parameter). When a timeout violation is detected in controller mode, a STOP condition is automatically sent. When a timeout violation is detected in target mode, the SDA and SCL lines are automatically released. When a timeout error is detected, the TIMEOUT flag is set in the I2C_ISR register and an interrupt is generated if the ERRIE bit of the I2C_CR1 register is set.  Alert (ALERT)  This section pertains to the instances of the I2C peripheral supporting SMBus. Refer to  Section 25.3: I2C implementation . This section pertains to the instances of the I2C peripheral supporting SMBus. Refer to  Section 25.3: I2C implementation . This section pertains to the instances of the I2C peripheral supporting SMBus. Refer to  Section 25.3: I2C implementation .

RM0490 Rev 5   725/1027  RM0490   Inter-integrated circuit interface (I2C)  741  The ALERT flag is set when the I2C peripheral is configured as a host (SMBHEN = 1), the SMBALERT# signal detection is enabled (ALERTEN = 1), and a falling edge is detected on the SMBA pin. An interrupt is generated if the ERRIE bit of the I2C_CR1 register is set.  25.5   I2C in low-power modes  25.6   I2C interrupts  The following table gives the list of I2C interrupt requests.  Table 120. Effect of low-power modes to I2C Mode   Description  Sleep   No effect. I2C interrupts cause the device to exit the Sleep mode. Stop   (1) 1.   Refer to   Section 25.3: I2C implementation   for information about the Stop modes supported by each instance. If the wake-up from a specific stop mode is not supported, the instance must be disabled before entering that specific Stop mode. The contents of I2C registers are kept. – WUPEN = 1 and I2C is clocked by an internal oscillator (HSI48). The address recognition is functional. The I2C address match condition causes the device to exit the Stop mode. – WUPEN = 0: the I2C must be disabled before entering Stop mode. Standby   The I2C peripheral is powered down. It must be reinitialized after exiting Standby mode.  Table 121. I2C interrupt requests Interrupt acronym Interrupt event   Event flag   Enable control bit Interrupt clear method Exit Sleep mode Exit Stop modes Exit Standby modes  I2C_EV Receive buffer not empty   RXNE   RXIE   Read I2C_RXDR register Yes No No Transmit buffer interrupt status   TXIS   TXIE   Write I2C_TXDR register STOP detection interrupt flag   STOPF   STOPIE   Write STOPCF = 1 Transfer complete reload   TCR TCIE Write I2C_CR2 with NBYTES[7:0]   ≠   0 Transfer complete   TC   Write START = 1 or STOP = 1 Address matched   ADDR   ADDRIE   Write ADDRCF = 1   Yes   (1) NACK reception   NACKF   NACKIE   Write NACKCF = 1   No I2C_ERR Bus error   BERR ERRIE Write BERRCF = 1 Yes   No   No Arbitration loss   ARLO   Write ARLOCF = 1 Overrun/underrun   OVR   Write OVRCF = 1

Inter-integrated circuit interface (I2C)   RM0490  726/1027   RM0490 Rev 5  25.7   I2C DMA requests 25.7.1   Transmission using DMA  DMA (direct memory access) can be enabled for transmission by setting the TXDMAEN bit of the I2C_CR1 register. Data is loaded from an SRAM area configured through the DMA peripheral (see   Section 11: Direct memory access controller (DMA) ) to the I2C_TXDR register whenever the TXIS bit is set. Only the data are transferred with DMA. In controller mode, the initialization, the target address, direction, number of bytes and START bit are programmed by software (the transmitted target address cannot be transferred with DMA). When all data are transferred using DMA, DMA must be initialized before setting the START bit. The end of transfer is managed with the NBYTES counter. Refer to   Controller transmitter . In target mode:  •   With NOSTRETCH = 0, when all data are transferred using DMA, DMA must be initialized before the address match event, or in ADDR interrupt subroutine, before clearing ADDR.  •   With NOSTRETCH = 1, the DMA must be initialized before the address match event. The PEC transfer is managed with the counter associated to the NBYTES[7:0] bitfield. Refer to   SMBus target transmitter   and   SMBus controller transmitter . This applies to the instances of the I2C peripheral supporting SMBus.  Note:   If DMA is used for transmission, it is not required to set the TXIE bit.  25.7.2   Reception using DMA  DMA (direct memory access) can be enabled for reception by setting the RXDMAEN bit of the I2C_CR1 register. Data is loaded from the I2C_RXDR register to an SRAM area configured through the DMA peripheral (refer to   Section 11: Direct memory access controller (DMA) ) whenever the RXNE bit is set. Only the data (including PEC) are transferred with DMA. In controller mode, the initialization, the target address, direction, number of bytes and START bit are programmed by software. When all data are transferred using DMA, DMA must be initialized before setting the START bit. The end of transfer is managed with the NBYTES counter. I2C_ERR PEC error   PECERR ERRIE Write PECERRCF = 1 Yes   No   No Timeout/ t   LOW   error   TIMEOUT   Write TIMEOUTCF = 1 SMBus alert   ALERT   Write ALERTCF = 1 1.   The ADDR match event can wake up the device from Stop mode only if the I2C instance supports the wake-up from Stop mode feature. Refer to   Section 25.3: I2C implementation .  Table 121. I2C interrupt requests (continued) Interrupt acronym Interrupt event   Event flag   Enable control bit Interrupt clear method Exit Sleep mode Exit Stop modes Exit Standby modes

RM0490 Rev 5   727/1027  RM0490   Inter-integrated circuit interface (I2C)  741  In target mode with NOSTRETCH = 0, when all data are transferred using DMA, DMA must be initialized before the address match event, or in the ADDR interrupt subroutine, before clearing the ADDR flag. The PEC transfer is managed with the counter associated to the NBYTES[7:0] bitfield. Refer to   SMBus target receiver   and   SMBus controller receiver . This applies to the instances of the I2C peripheral supporting SMBus.  Note:   If DMA is used for reception, it is not required to set the RXIE bit.  25.8   I2C debug modes  When the device enters debug mode (core halted), the SMBus timeout either continues working normally or stops, depending on the DBG_I2C1_SMBUS_TIMEOUT bit in the DBG block.  25.9   I2C registers  Refer to   Section 1.2   for the list of abbreviations used in register descriptions. The registers are accessed by words (32-bit).  25.9.1   I2C control register 1 (I2C_CR1)  Address offset: 0x00 Reset value: 0x0000 0000 Access: no wait states, except if a write access occurs while a write access is ongoing. In this case, wait states are inserted in the second write access, until the previous one is completed. The latency of the second write access can be up to 2 x PCLK + 6 x I2CCLK. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   PECEN   ALERT EN SMBD EN SMBH EN   GCEN   WUPE N NOSTR ETCH   SBC rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 RXDM AEN TXDMA EN   Res.   ANF OFF   DNF[3:0]   ERRIE   TCIE   STOP IE NACKI E ADDRI E   RXIE   TXIE   PE rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:24   Reserved, must be kept at reset value. Bit 23   PECEN:   PEC enable 0: PEC calculation disabled 1: PEC calculation enabled On the instances of the I2C peripheral that do not support the SMBus feature, this bit is reserved and forced by hardware to 0. Refer to   Section 25.3 .

Inter-integrated circuit interface (I2C)   RM0490  728/1027   RM0490 Rev 5  Bit 22   ALERTEN : SMBus alert enable 0: The SMBALERT# signal on SMBA pin is not supported in host mode (SMBHEN = 1). In device mode (SMBHEN = 0), the SMBA pin is released and the alert response address header is disabled (0001100x followed by NACK). 1: The SMBALERT# signal on SMBA pin is supported in host mode (SMBHEN = 1). In device mode (SMBHEN = 0), the SMBA pin is driven low and the alert response address header is enabled (0001100x followed by ACK). On the instances of the I2C peripheral that do not support the SMBus feature, this bit is reserved and forced by hardware to 0. Refer to   Section 25.3 .  Note:   When ALERTEN = 0, the SMBA pin can be used as a standard GPIO.  Bit 21   SMBDEN : SMBus device default address enable 0: Device default address disabled. Address 0b1100001x is NACKed. 1: Device default address enabled. Address 0b1100001x is ACKed. On the instances of the I2C peripheral that do not support the SMBus feature, this bit is reserved and forced by hardware to 0. Refer to   Section 25.3 . Bit 20   SMBHEN : SMBus host address enable 0: Host address disabled. Address 0b0001000x is NACKed. 1: Host address enabled. Address 0b0001000x is ACKed. On the instances of the I2C peripheral that do not support the SMBus feature, this bit is reserved and forced by hardware to 0. Refer to   Section 25.3 . Bit 19   GCEN : General call enable 0: General call disabled. Address 0b00000000 is NACKed. 1: General call enabled. Address 0b00000000 is ACKed. Bit 18   WUPEN : Wake-up from Stop mode enable 0: Wake-up from Stop mode disabled. 1: Wake-up from Stop mode enabled. On the instances of the I2C peripheral that do not support the wake-up from Stop mode feature, this bit is reserved and forced by hardware to 0. Refer to   Section 25.3 .  Note:   WUPEN can be set only when DNF[3:0] = 0000.  Bit 17   NOSTRETCH : Clock stretching disable This bit is used to disable clock stretching in target mode. It must be kept cleared in controller mode. 0: Clock stretching enabled 1: Clock stretching disabled  Note:   This bit can be programmed only when the I2C peripheral is disabled (PE = 0).  Bit 16   SBC : Target byte control This bit is used to enable hardware byte control in target mode. 0: Target byte control disabled 1: Target byte control enabled Bit 15   RXDMAEN : DMA reception requests enable 0: DMA mode disabled for reception 1: DMA mode enabled for reception Bit 14   TXDMAEN : DMA transmission requests enable 0: DMA mode disabled for transmission 1: DMA mode enabled for transmission Bit 13   Reserved, must be kept at reset value.

RM0490 Rev 5   729/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Bit 12   ANFOFF:   Analog noise filter OFF 0: Analog noise filter enabled 1: Analog noise filter disabled  Note:   This bit can be programmed only when the I2C peripheral is disabled (PE = 0).  Bits 11:8   DNF[3:0] : Digital noise filter These bits are used to configure the digital noise filter on SDA and SCL input. The digital filter, filters spikes with a length of up to DNF[3:0]   *   t   I2CCLK 0000: Digital filter disabled 0001: Digital filter enabled and filtering capability up to one t   I2CCLK ... 1111: digital filter enabled and filtering capability up to fifteen t   I2CCLK  Note:   If the analog filter is enabled, the digital filter is added to it. This filter can be programmed only when the I2C peripheral is disabled (PE = 0).  Bit 7   ERRIE : Error interrupts enable 0: Error detection interrupts disabled 1: Error detection interrupts enabled  Note:   Any of these errors generates an interrupt: - arbitration loss (ARLO) - bus error detection (BERR) - overrun/underrun (OVR) - timeout detection (TIMEOUT) - PEC error detection (PECERR) - alert pin event detection (ALERT)  Bit 6   TCIE : Transfer complete interrupt enable 0: Transfer complete interrupt disabled 1: Transfer complete interrupt enabled  Note:   Any of these events generates an interrupt: Transfer complete (TC) Transfer complete reload (TCR)  Bit 5   STOPIE : STOP detection interrupt enable 0: STOP detection (STOPF) interrupt disabled 1: STOP detection (STOPF) interrupt enabled Bit 4   NACKIE : Not acknowledge received interrupt enable 0: Not acknowledge (NACKF) received interrupts disabled 1: Not acknowledge (NACKF) received interrupts enabled Bit 3   ADDRIE : Address match interrupt enable (target only) 0: Address match (ADDR) interrupts disabled 1: Address match (ADDR) interrupts enabled Bit 2   RXIE : RX interrupt enable 0: Receive (RXNE) interrupt disabled 1: Receive (RXNE) interrupt enabled Bit 1   TXIE : TX interrupt enable 0: Transmit (TXIS) interrupt disabled 1: Transmit (TXIS) interrupt enabled

Inter-integrated circuit interface (I2C)   RM0490  730/1027   RM0490 Rev 5  25.9.2   I2C control register 2 (I2C_CR2)  Address offset: 0x04 Reset value: 0x0000 0000 Access: no wait states, except if a write access occurs while a write access is ongoing. In this case, wait states are inserted in the second write access until the previous one is completed. The latency of the second write access can be up to 2 x PCLK + 6 x I2CCLK. Bit 0   PE : Peripheral enable 0: Peripheral disabled 1: Peripheral enabled  Note:   When PE = 0, the I2C SCL and SDA lines are released. Internal state machines and status bits are put back to their reset value. When cleared, PE must be kept low for at least three APB clock cycles.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   PECBY TE AUTOE ND RELOA D   NBYTES[7:0] rs   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 NACK   STOP   START   HEAD1 0R   ADD10   RD_W RN   SADD[9:0] rs   rs   rs   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:27   Reserved, must be kept at reset value. Bit 26   PECBYTE :   Packet error checking byte This bit is set by software, and cleared by hardware when the PEC is transferred, or when a STOP condition or an Address matched is received, also when PE = 0. 0: No PEC transfer 1: PEC transmission/reception is requested On the instances of the I2C peripheral that do not support the SMBus feature, this bit is reserved and forced by hardware to 0. Refer to   Section 25.3 .  Note:   Writing 0 to this bit has no effect. This bit has no effect when RELOAD is set, and in target mode when SBC = 0.  Bit 25   AUTOEND :   Automatic end mode (controller mode) This bit is set and cleared by software. 0: software end mode: TC flag is set when NBYTES data are transferred, stretching SCL low. 1: Automatic end mode: a STOP condition is automatically sent when NBYTES data are transferred.  Note:   This bit has no effect in target mode or when the RELOAD bit is set.  Bit 24   RELOAD :   NBYTES   reload mode This bit is set and cleared by software. 0: The transfer is completed after the NBYTES data transfer (STOP or RESTART follows). 1: The transfer is not completed after the NBYTES data transfer (NBYTES is reloaded). TCR flag is set when NBYTES data are transferred, stretching SCL low. Bits 23:16   NBYTES[7:0] :   Number of bytes The number of bytes to be transmitted/received is programmed there. This field is don’t care in target mode with SBC = 0.  Note:   Changing these bits when the START bit is set is not allowed.

RM0490 Rev 5   731/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Bit 15   NACK :   NACK generation (target mode) The bit is set by software, cleared by hardware when the NACK is sent, or when a STOP condition or an Address matched is received, or when PE = 0. 0: an ACK is sent after current received byte. 1: a NACK is sent after current received byte.  Note:   Writing 0 to this bit has no effect. This bit is used only in target mode: in controller receiver mode, NACK is automatically generated after last byte preceding STOP or RESTART condition, whatever the NACK bit value. When an overrun occurs in target receiver NOSTRETCH mode, a NACK is automatically generated, whatever the NACK bit value. When hardware PEC checking is enabled (PECBYTE = 1), the PEC acknowledge value does not depend on the NACK value.  Bit 14   STOP :   STOP condition generation This bit only pertains to controller mode. It is set by software and cleared by hardware when a STOP condition is detected or when PE = 0. 0: No STOP generation 1: STOP generation after current byte transfer  Note:   Writing 0 to this bit has no effect.  Bit 13   START : START condition generation This bit is set by software. It is cleared by hardware after the START condition followed by the address sequence is sent, by an arbitration loss, by an address matched in target mode, by a timeout error detection, or when PE = 0. 0: No START generation 1: RESTART/START generation: If the I2C is already in controller mode with AUTOEND = 0, setting this bit generates a repeated START condition when RELOAD = 0, after the end of the NBYTES transfer. Otherwise, setting this bit generates a START condition once the bus is free.  Note:   Writing 0 to this bit has no effect. The START bit can be set even if the bus is BUSY or I2C is in target mode. This bit has no effect when RELOAD is set.  Bit 12   HEAD10R :   10-bit address header only read direction (controller receiver mode) 0: The controller sends the complete 10-bit target address read sequence: START + 2 bytes 10-bit address in write direction + RESTART + first seven bits of the 10-bit address in read direction. 1: The controller sends only the first seven bits of the 10-bit address, followed by read direction.  Note:   Changing this bit when the START bit is set is not allowed.  Bit 11   ADD10 :   10-bit addressing mode (controller mode) 0: The controller operates in 7-bit addressing mode 1: The controller operates in 10-bit addressing mode  Note:   Changing this bit when the START bit is set is not allowed.  Bit 10   RD_WRN : Transfer direction (controller mode) 0: Controller requests a write transfer 1: Controller requests a read transfer  Note:   Changing this bit when the START bit is set is not allowed.

Inter-integrated circuit interface (I2C)   RM0490  732/1027   RM0490 Rev 5  25.9.3   I2C own address 1 register (I2C_OAR1)  Address offset: 0x08 Reset value: 0x0000 0000 Access: no wait states, except if a write access occurs while a write access is ongoing. In this case, wait states are inserted in the second write access until the previous one is completed. The latency of the second write access can be up to 2 x PCLK + 6 x I2CCLK. Bits 9:0   SADD[9:0] : Target address (controller mode)  Condition: In 7-bit addressing mode (ADD10 = 0) : SADD[7:1] must be written with the 7-bit target address to be sent. Bits SADD[9], SADD[8] and SADD[0] are don't care.  Condition: In 10-bit addressing mode (ADD10 = 1) : SADD[9:0] must be written with the 10-bit target address to be sent.  Note:   Changing these bits when the START bit is set is not allowed.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 OA1EN   Res.   Res.   Res.   Res.   OA1M ODE   OA1[9:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bit 15   OA1EN : Own address 1 enable 0: Own address 1 disabled. The received target address OA1 is NACKed. 1: Own address 1 enabled. The received target address OA1 is ACKed. Bits 14:11   Reserved, must be kept at reset value. Bit 10   OA1MODE : Own address 1 10-bit mode 0: Own address 1 is a 7-bit address. 1: Own address 1 is a 10-bit address.  Note:   This bit can be written only when OA1EN = 0.  Bits 9:0   OA1[9:0] : Interface own target address 7-bit addressing mode: OA1[7:1] contains the 7-bit own target address. Bits OA1[9], OA1[8] and OA1[0] are don't care. 10-bit addressing mode: OA1[9:0] contains the 10-bit own target address.  Note:   These bits can be written only when OA1EN = 0.

RM0490 Rev 5   733/1027  RM0490   Inter-integrated circuit interface (I2C)  741  25.9.4   I2C own address 2 register (I2C_OAR2)  Address offset: 0x0C Reset value: 0x0000 0000 Access: no wait states, except if a write access occurs while a write access is ongoing. In this case, wait states are inserted in the second write access, until the previous one is completed. The latency of the second write access can be up to 2x PCLK + 6 x I2CCLK. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 OA2EN   Res.   Res.   Res.   Res.   OA2MSK[2:0]   OA2[7:1]   Res. rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bit 15   OA2EN : Own address 2 enable 0: Own address 2 disabled. The received target address OA2 is NACKed. 1: Own address 2 enabled. The received target address OA2 is ACKed. Bits 14:11   Reserved, must be kept at reset value. Bits 10:8   OA2MSK[2:0] : Own address 2 masks 000: No mask 001: OA2[1] is masked and don’t care. Only OA2[7:2] are compared. 010: OA2[2:1] are masked and don’t care. Only OA2[7:3] are compared. 011: OA2[3:1] are masked and don’t care. Only OA2[7:4] are compared. 100: OA2[4:1] are masked and don’t care. Only OA2[7:5] are compared. 101: OA2[5:1] are masked and don’t care. Only OA2[7:6] are compared. 110: OA2[6:1] are masked and don’t care. Only OA2[7] is compared. 111: OA2[7:1] are masked and don’t care. No comparison is done, and all (except reserved) 7-bit received addresses are acknowledged.  Note:   These bits can be written only when OA2EN = 0. As soon as OA2MSK   ≠   0, the reserved I2C addresses (0b0000xxx and 0b1111xxx) are not acknowledged, even if the comparison matches.  Bits 7:1   OA2[7:1] : Interface address 7-bit addressing mode: 7-bit address  Note:   These bits can be written only when OA2EN = 0.  Bit 0   Reserved, must be kept at reset value.

Inter-integrated circuit interface (I2C)   RM0490  734/1027   RM0490 Rev 5  25.9.5   I2C timing register (I2C_TIMINGR)  Address offset: 0x10 Reset value: 0x0000 0000 Access: no wait states  Note:   This register must be configured when the I2C peripheral is disabled (PE = 0). Note:   The STM32CubeMX tool calculates and provides the I2C_TIMINGR content in the I2C Configuration window.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 PRESC[3:0]   Res.   Res.   Res.   Res.   SCLDEL[3:0]   SDADEL[3:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 SCLH[7:0]   SCLL[7:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:28   PRESC[3:0] : Timing prescaler This field is used to prescale I2CCLK to generate the clock period t   PRESC   used for data setup and hold counters (refer to section   I2C timings ), and for SCL high and low level counters (refer to section   I2C controller initialization ). t   PRESC   = (PRESC + 1) x t I2CCLK Bits 27:24   Reserved, must be kept at reset value. Bits 23:20   SCLDEL[3:0] : Data setup time This field is used to generate a delay t SCLDEL   = (SCLDEL + 1) x t PRESC   between SDA edge and SCL rising edge. In controller and in target modes with NOSTRETCH = 0, the SCL line is stretched low during t   SCLDEL .  Note:   t SCLDEL   is used to generate t   SU:DAT   timing.  Bits 19:16   SDADEL[3:0] : Data hold time This field is used to generate the delay t SDADEL   between SCL falling edge and SDA edge. In controller and in target modes with NOSTRETCH = 0, the SCL line is stretched low during t   SDADEL . t   SDADEL = SDADEL x t   PRESC  Note:   SDADEL is used to generate t   HD:DAT   timing.  Bits 15:8   SCLH[7:0] : SCL high period (controller mode) This field is used to generate the SCL high period in controller mode. t   SCLH   = (SCLH + 1) x t PRESC  Note:   SCLH is also used to generate t SU:STO   and t HD:STA   timing.  Bits 7:0   SCLL[7:0] : SCL low period (controller mode) This field is used to generate the SCL low period in controller mode. t   SCLL   = (SCLL + 1) x t   PRESC  Note:   SCLL is also used to generate t BUF   and t SU:STA   timings.

RM0490 Rev 5   735/1027  RM0490   Inter-integrated circuit interface (I2C)  741  25.9.6   I2C timeout register (I2C_TIMEOUTR)  Address offset: 0x14 Reset value: 0x0000 0000 Access: no wait states, except if a write access occurs while a write access is ongoing. In this case, wait states are inserted in the second write access until the previous one is completed. The latency of the second write access can be up to 2 x PCLK + 6 x I2CCLK. On the instances of the I2C peripheral that do not support the SMBus feature, this register is reserved, and its bits are forced by hardware to 0. Refer to   Section 25.3 . 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 TEXTE N   Res.   Res.   Res.   TIMEOUTB[11:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 TIMOU TEN   Res.   Res.   TIDLE   TIMEOUTA[11:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 31   TEXTEN : Extended clock timeout enable 0: Extended clock timeout detection is disabled 1: Extended clock timeout detection is enabled. When a cumulative SCL stretch for more than t LOW:EXT   is done by the I2C interface, a timeout error is detected (TIMEOUT = 1). Bits 30:28   Reserved, must be kept at reset value. Bits 27:16   TIMEOUTB[11:0] : Bus timeout B This field is used to configure the cumulative clock extension timeout: –   Controller mode: the controller cumulative clock low extend time (t   LOW:MEXT   ) is detected –   Target mode: the target cumulative clock low extend time (t   LOW:SEXT ) is detected t   LOW:EXT   = (TIMEOUTB + TIDLE = 01) x 2048 x t I2CCLK  Note:   These bits can be written only when TEXTEN = 0.  Bit 15   TIMOUTEN : Clock timeout enable 0: SCL timeout detection is disabled 1: SCL timeout detection is enabled. When SCL is low for more than t   TIMEOUT   (TIDLE = 0) or high for more than t IDLE   (TIDLE = 1), a timeout error is detected (TIMEOUT = 1). Bits 14:13   Reserved, must be kept at reset value. Bit 12   TIDLE : Idle clock timeout detection 0: TIMEOUTA is used to detect SCL low timeout 1: TIMEOUTA is used to detect both SCL and SDA high timeout (bus idle condition)  Note:   This bit can be written only when TIMOUTEN = 0.  Bits 11:0   TIMEOUTA[11:0] : Bus timeout A This field is used to configure: The SCL low timeout condition t   TIMEOUT   when TIDLE = 0 t   TIMEOUT = (TIMEOUTA + 1) x 2048 x t I2CCLK The bus idle condition (both SCL and SDA high) when TIDLE = 1 t   IDLE = (TIMEOUTA + 1) x 4 x t I2CCLK  Note:   These bits can be written only when TIMOUTEN = 0.

Inter-integrated circuit interface (I2C)   RM0490  736/1027   RM0490 Rev 5  25.9.7   I2C interrupt and status register (I2C_ISR)  Address offset: 0x18 Reset value: 0x0000 0001 Access: no wait states 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   ADDCODE[6:0]   DIR r   r   r   r   r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 BUSY   Res.   ALERT   TIMEO UT PECER R   OVR   ARLO   BERR   TCR   TC   STOPF   NACKF   ADDR   RXNE   TXIS   TXE r   r   r   r   r   r   r   r   r   r   r   r   r   rs   rs Bits 31:24   Reserved, must be kept at reset value. Bits 23:17   ADDCODE[6:0] : Address match code (target mode) These bits are updated with the received address when an address match event occurs (ADDR = 1). In the case of a 10-bit address, ADDCODE provides the 10-bit header followed by the two MSBs of the address. Bit 16   DIR :   Transfer direction (target mode) This flag is updated when an address match event occurs (ADDR = 1). 0: Write transfer, target enters receiver mode. 1: Read transfer, target enters transmitter mode. Bit 15   BUSY :   Bus busy This flag indicates that a communication is in progress on the bus. It is set by hardware when a START condition is detected, and cleared by hardware when a STOP condition is detected, or when PE = 0. Bit 14   Reserved, must be kept at reset value. Bit 13   ALERT : SMBus alert This flag is set by hardware when SMBHEN = 1 (SMBus host configuration), ALERTEN = 1 and an SMBALERT# event (falling edge) is detected on SMBA pin. It is cleared by software by setting the ALERTCF bit. On the instances of the I2C peripheral that do not support the SMBus feature, this bit is reserved and forced by hardware to 0. Refer to   Section 25.3 .  Note:   This bit is cleared by hardware when PE = 0.  Bit 12   TIMEOUT : Timeout or t   LOW   detection flag This flag is set by hardware when a timeout or extended clock timeout occurred. It is cleared by software by setting the TIMEOUTCF bit. On the instances of the I2C peripheral that do not support the SMBus feature, this bit is reserved and forced by hardware to 0. Refer to   Section 25.3 .  Note:   This bit is cleared by hardware when PE = 0.  Bit 11   PECERR : PEC error in reception This flag is set by hardware when the received PEC does not match with the PEC register content. A NACK is automatically sent after the wrong PEC reception. It is cleared by software by setting the PECCF bit. On the instances of the I2C peripheral that do not support the SMBus feature, this bit is reserved and forced by hardware to 0. Refer to   Section 25.3 .  Note:   This bit is cleared by hardware when PE = 0.

RM0490 Rev 5   737/1027  RM0490   Inter-integrated circuit interface (I2C)  741  Bit 10   OVR :   Overrun/underrun (target mode) This flag is set by hardware in target mode with NOSTRETCH = 1, when an overrun/underrun error occurs. It is cleared by software by setting the OVRCF bit . Note:   This bit is cleared by hardware when PE = 0.  Bit 9   ARLO :   Arbitration lost This flag is set by hardware in case of arbitration loss. It is cleared by software by setting the ARLOCF bit.  Note:   This bit is cleared by hardware when PE = 0.  Bit 8   BERR : Bus error This flag is set by hardware when a misplaced START or STOP condition is detected whereas the peripheral is involved in the transfer. The flag is not set during the address phase in target mode. It is cleared by software by setting the BERRCF bit.  Note:   This bit is cleared by hardware when PE = 0.  Bit 7   TCR :   Transfer complete reload This flag is set by hardware when RELOAD = 1 and NBYTES data have been transferred. It is cleared by software when NBYTES is written to a non-zero value . Note:   This bit is cleared by hardware when PE = 0. This flag is only for controller mode, or for target mode when the SBC bit is set.  Bit 6   TC :   Transfer complete (controller mode) This flag is set by hardware when RELOAD = 0, AUTOEND = 0 and NBYTES data have been transferred. It is cleared by software when START bit or STOP bit is set . Note:   This bit is cleared by hardware when PE = 0.  Bit 5   STOPF : STOP detection flag This flag is set by hardware when a STOP condition is detected on the bus and the peripheral is involved in this transfer: –   as a controller, provided that the STOP condition is generated by the peripheral. –   as a target, provided that the peripheral has been addressed previously during this transfer. It is cleared by software by setting the STOPCF bit.  Note:   This bit is cleared by hardware when PE = 0.  Bit 4   NACKF :   Not acknowledge received flag This flag is set by hardware when a NACK is received after a byte transmission. It is cleared by software by setting the NACKCF bit.  Note:   This bit is cleared by hardware when PE = 0.  Bit 3   ADDR :   Address matched (target mode) This bit is set by hardware as soon as the received target address matched with one of the enabled target addresses. It is cleared by software by setting   ADDRCF bit. Note:   This bit is cleared by hardware when PE = 0.  Bit 2   RXNE : Receive data register not empty (receivers) This bit is set by hardware when the received data is copied into the I2C_RXDR register, and is ready to be read. It is cleared when I2C_RXDR is read.  Note:   This bit is cleared by hardware when PE = 0.

Inter-integrated circuit interface (I2C)   RM0490  738/1027   RM0490 Rev 5  25.9.8   I2C interrupt clear register (I2C_ICR)  Address offset: 0x1C Reset value: 0x0000 0000 Access: no wait states Bit 1   TXIS : Transmit interrupt status (transmitters) This bit is set by hardware when the I2C_TXDR register is empty and the data to be transmitted must be written in the I2C_TXDR register. It is cleared when the next data to be sent is written in the I2C_TXDR register. This bit can be written to 1 by software only when NOSTRETCH = 1, to generate a TXIS event (interrupt if TXIE = 1 or DMA request if TXDMAEN = 1).  Note:   This bit is cleared by hardware when PE = 0.  Bit 0   TXE : Transmit data register empty (transmitters) This bit is set by hardware when the I2C_TXDR register is empty. It is cleared when the next data to be sent is written in the I2C_TXDR register. This bit can be written to 1 by software in order to flush the transmit data register I2C_TXDR.  Note:   This bit is set by hardware when PE = 0.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   ALERT CF TIMOU TCF   PECCF   OVRCF   ARLOC F BERRC F   Res.   Res.   STOPC F NACKC F ADDR CF   Res.   Res.   Res. w   w   w   w   w   w   w   w   w Bits 31:14   Reserved, must be kept at reset value. Bit 13   ALERTCF : Alert flag clear Writing 1 to this bit clears the ALERT flag in the I2C_ISR register. On the instances of the I2C peripheral that do not support the SMBus feature, this bit is reserved and forced by hardware to 0. Refer to   Section 25.3 . Bit 12   TIMOUTCF : Timeout detection flag clear Writing 1 to this bit clears the TIMEOUT flag in the I2C_ISR register. On the instances of the I2C peripheral that do not support the SMBus feature, this bit is reserved and forced by hardware to 0. Refer to   Section 25.3 . Bit 11   PECCF : PEC error flag clear Writing 1 to this bit clears the PECERR flag in the I2C_ISR register. On the instances of the I2C peripheral that do not support the SMBus feature, this bit is reserved and forced by hardware to 0. Refer to   Section 25.3 . Bit 10   OVRCF :   Overrun/underrun flag clear Writing 1 to this bit clears the OVR flag in the I2C_ISR register. Bit 9   ARLOCF :   Arbitration lost flag clear Writing 1 to this bit clears the ARLO flag in the I2C_ISR register. Bit 8   BERRCF : Bus error flag clear Writing 1 to this bit clears the BERRF flag in the I2C_ISR register. Bits 7:6   Reserved, must be kept at reset value.

RM0490 Rev 5   739/1027  RM0490   Inter-integrated circuit interface (I2C)  741  25.9.9   I2C PEC register (I2C_PECR)  Address offset: 0x20 Reset value: 0x0000 0000 Access: no wait states  25.9.10   I2C receive data register (I2C_RXDR)  Address offset: 0x24 Reset value: 0x0000 0000 Access: no wait states Bit 5   STOPCF : STOP detection flag clear Writing 1 to this bit clears the STOPF flag in the I2C_ISR register. Bit 4   NACKCF :   Not acknowledge flag clear Writing 1 to this bit clears the NACKF flag in I2C_ISR register. Bit 3   ADDRCF :   Address matched flag clear Writing 1 to this bit clears the ADDR flag in the I2C_ISR register. Writing 1 to this bit also clears the START bit in the I2C_CR2 register. Bits 2:0   Reserved, must be kept at reset value. On the instances of the I2C peripheral that do not support the SMBus feature, this register is reserved and its bits are forced by hardware to 0. Refer to   Section 25.3 . 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   PEC[7:0] r   r   r   r   r   r   r   r Bits 31:8   Reserved, must be kept at reset value. Bits 7:0   PEC[7:0]:   Packet error checking register This field contains the internal PEC when PECEN=1. The PEC is cleared by hardware when PE = 0. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   RXDATA[7:0] r   r   r   r   r   r   r   r Bits 31:8   Reserved, must be kept at reset value. Bits 7:0   RXDATA[7:0]:   8-bit receive data Data byte received from the I²C-bus.

Inter-integrated circuit interface (I2C)   RM0490  740/1027   RM0490 Rev 5  25.9.11   I2C transmit data register (I2C_TXDR)  Address offset: 0x28 Reset value: 0x0000 0000 Access: no wait states 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TXDATA[7:0] rw   rw   rw   rw   rw   rw   rw   rw Bits 31:8   Reserved, must be kept at reset value. Bits 7:0   TXDATA[7:0]:   8-bit transmit data Data byte to be transmitted to the I²C-bus  Note:   These bits can be written only when TXE = 1.

RM0490 Rev 5   741/1027  RM0490   Inter-integrated circuit interface (I2C)  741  25.9.12   I2C register map  The table below provides the I2C register map and the reset values. Refer to   Section 2.2   for the register boundary addresses.  Table 122. I2C register map and reset values Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00 I2C_CR1 Res. Res. Res. Res. Res. Res. Res. Res. PECEN ALERTEN SMBDEN SMBHEN GCEN WUPEN NOSTRETCH SBC RXDMAEN TXDMAEN Res. ANFOFF DNF[3:0] ERRIE TCIE STOPIE NACKIE ADDRIE RXIE TXIE PE Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x04 I2C_CR2 Res. Res. Res. Res. Res. PECBYTE AUTOEND RELOAD NBYTES[7:0] NACK STOP START HEAD10R ADD10 RD_WRN SADD[9:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x08 I2C_OAR1 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. OA1EN Res. Res. Res. Res. OA1MODE OA1[9:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0 0x0C I2C_OAR2 Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. OA2EN Res. Res. Res. Res.   OA2MS K [2:0]   OA2[7:1] Res. Reset value   0   0   0   0   0   0   0   0   0   0   0 0x10 I2C_ TIMINGR   PRESC[3:0] Res. Res. Res. Res.   SCLDEL [3:0] SDADEL [3:0]   SCLH[7:0]   SCLL[7:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x14 I2C_ TIMEOUTR TEXTEN Res. Res. Res. TIMEOUTB[11:0] TIMOUTEN Res. Res. TIDLE TIMEOUTA[11:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x18 I2C_ISR Res. Res. Res. Res. Res. Res. Res. Res. ADDCODE[6:0] DIR BUSY Res. ALERT TIMEOUT PECERR OVR ARLO BERR TCR TC STOPF NACKF ADDR RXNE TXIS TXE Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   1 0x1C I2C_ICR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. ALERTCF TIMOUTCF PECCF OVRCF ARLOCF BERRCF Res. Res. STOPCF NACKCF ADDRCF Res. Res. Res. Reset value   0   0   0   0   0   0   0   0   0 0x20 I2C_PECR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PEC[7:0] Reset value   0   0   0   0   0   0   0   0 0x24 I2C_RXDR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. RXDATA[7:0] Reset value   0   0   0   0   0   0   0   0 0x28 I2C_TXDR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TXDATA[7:0] Reset value   0   0   0   0   0   0   0   0

Universal synchronous receiver transmitter (USART)   RM0490  742/1027   RM0490 Rev 5  26   Universal synchronous receiver transmitter (USART)  This section describes the universal synchronous asynchronous receiver transmitter (USART).  26.1   USART introduction  The USART offers a flexible means to perform Full-duplex data exchange with external equipments requiring an industry standard NRZ asynchronous serial data format. A very wide range of baud rates can be achieved through a fractional baud rate generator. The USART supports both synchronous one-way and half-duplex single-wire communications, as well as LIN (local interconnection network), smartcard protocol, IrDA (infrared data association) SIR ENDEC specifications, and modem operations (CTS/RTS). Multiprocessor communications are also supported. High-speed data communications are possible by using the DMA (direct memory access) for multibuffer configuration.

RM0490 Rev 5   743/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  26.2   USART main features  •   Full-duplex asynchronous communication  •   NRZ standard format (mark/space)  •   Configurable oversampling method by 16 or 8 to achieve the best compromise between speed and clock tolerance  •   Baud rate generator systems  •   Two internal FIFOs for transmit and receive data Each FIFO can be enabled/disabled by software and come with a status flag.  •   A common programmable transmit and receive baud rate  •   Dual clock domain with dedicated kernel clock for peripherals independent from PCLK  •   Auto baud rate detection  •   Programmable data word length (7, 8 or 9 bits)  •   Programmable data order with MSB-first or LSB-first shifting  •   Configurable stop bits (1 or 2 stop bits)  •   Synchronous master/slave mode and clock output/input for synchronous communications  •   SPI slave transmission underrun error flag  •   Single-wire half-duplex communications  •   Continuous communications using DMA  •   Received/transmitted bytes are buffered in reserved SRAM using centralized DMA.  •   Separate enable bits for transmitter and receiver  •   Separate signal polarity control for transmission and reception  •   Swappable Tx/Rx pin configuration  •   Hardware flow control for modem and RS-485 transceiver  •   Communication control/error detection flags  •   Parity control: –   Transmits parity bit –   Checks parity of received data byte  •   Interrupt sources with flags  •   Multiprocessor communications: wake-up from mute mode by idle line detection or address mark detection  •   Wake-up from Stop mode

Universal synchronous receiver transmitter (USART)   RM0490  744/1027   RM0490 Rev 5  26.3   USART extended features  •   LIN master synchronous break send capability and LIN slave break detection capability –   13-bit break generation and 10/11 bit break detection when USART is hardware configured for LIN  •   IrDA SIR encoder decoder supporting 3/16 bit duration for normal mode  •   Smartcard mode –   Supports the T   =   0 and T   =   1 asynchronous protocols for smartcards as defined in the ISO/IEC 7816-3 standard –   0.5 and 1.5 stop bits for smartcard operation  •   Support for Modbus communication –   Timeout feature –   CR/LF character recognition  26.4   USART implementation  The table(s) below describe(s) USART implementation. It (they) also include(s) LPUART for comparison.  Table 123. Instance implementation on STM32C0 series USART instances   STM32C011/31/51/71xx   STM32C091/92xx  USART1   FULL   FULL USART2   BASIC   BASIC USART3   -   BASIC USART4   -   BASIC

RM0490 Rev 5   745/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Table 124. USART features USART modes/features   (1)  1.   X = supported.  Full feature set   Basic feature set  Hardware flow control for modem   X   X Continuous communication using DMA   X   X Multiprocessor communication   X   X Synchronous mode (Master/Slave)   X   X Smartcard mode   X   - Single-wire half-duplex communication   X   X IrDA SIR ENDEC block   X   - LIN mode   X   - Dual clock domain and wake-up from low-power mode   X   - Receiver timeout interrupt   X   - Modbus communication   X   - Auto baud rate detection   X   - Driver Enable   X   X USART data length   7, 8 and 9 bits Tx/Rx FIFO   X   - Tx/Rx FIFO size   8   - Prescaler   X   -

Universal synchronous receiver transmitter (USART)   RM0490  746/1027   RM0490 Rev 5  26.5   USART functional description 26.5.1   USART block diagram Figure 252. USART block diagram  The simplified block diagram given in   Figure 252   shows two fully-independent clock domains:  •   The   usart_pclk   clock domain The   usart_pclk   clock signal feeds the peripheral bus interface. It must be active when accesses to the USART registers are required.  •   The   usart_ker_ck   kernel clock domain. The   usart_ker_ck   is the USART clock source. It is independent from   usart_pclk   and delivered by the RCC. The USART registers can consequently be written/read even when the   usart_ker_ck   clock is stopped. When the dual clock domain feature is disabled, the   usart_ker_ck   clock is the same as the   usart_pclk   clock. There is no constraint between   usart_pclk   and   usart_ker_ck :   usart_ker_ck   can be faster or slower   than   usart_pclk . The only limitation is the software ability to manage the communication fast enough. When the USART operates in SPI slave mode, it handles data flow using the serial interface clock derived from the external CK signal provided by the external master SPI device. The  usart_ker_ck   clock   must be at least 3 times faster than the clock on the CK input.  MSv75370V1 USART_TDR USART_RDR USART_GTPR USART_BRR USART_CR3 USART_RQR USART_CR2 RX Shift Reg COM Controller RxFIFO usart_pclk clock domain  USART  TX RX usart_ker_ck 32-bit APB bus USART_ICR USART_ISR ... TX Shift Reg ... CTS/NSS RTS/DE/CK USART_CR1 USART_ RTOR   Baudrate generator & orversampling usart_ker_ck clock domain DMA Interface usart_pclk usart_tx_dma usart_rx_dma usart_it usart_wkup   IRQ Interface USART_ PRESC usart_ker_ck_pres Hardware flow control TxFIFO

RM0490 Rev 5   747/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  26.5.2   USART signals USART bidirectional communications  USART bidirectional communications require a minimum of two pins: Receive Data In (RX) and Transmit Data Out (TX):  •   RX   (Receive Data Input) RX is the serial data input. Oversampling techniques are used for data recovery. They discriminate between valid incoming data and noise.  •   TX   (Transmit Data Output) When the transmitter is disabled, the output pin returns to its I/O port configuration. When the transmitter is enabled and no data needs to be transmitted, the TX pin is High. In single-wire and smartcard modes, this I/O is used to transmit and receive data.  RS232 hardware flow control mode  The following pins are required in RS232 hardware flow control mode:  •   CTS   (Clear To Send) When driven high, this signal blocks the data transmission at the end of the current transfer.  •   RTS   (Request To Send) When it is low, this signal indicates that the USART is ready to receive data.  RS485 hardware flow control mode  The following pin is required in RS485 hardware control mode:  •   DE   (Driver Enable) This signal activates the transmission mode of the external transceiver.  Synchronous SPI master/slave mode and smartcard mode  The following pin is required in synchronous master/slave mode and smartcard mode:  •   CK  This pin acts as clock output in synchronous SPI master and smartcard modes. It acts as clock input in synchronous SPI slave mode. In synchronous master mode, this pin outputs the transmitter data clock for synchronous transmission corresponding to SPI master mode (no clock pulses on start bit and stop bit, and a software option to send a clock pulse on the last data bit). In parallel, data can be received synchronously on RX pin. This mechanism can be used to control peripherals featuring shift registers (e.g. LCD drivers). The clock phase and polarity are software programmable. In smartcard mode, CK output provides the clock to the smartcard.  •   NSS  This pin acts as slave Select input in synchronous slave mode. Refer to   Table 125   and   Table 126   for the list of USART input/output pins and internal signals.

Universal synchronous receiver transmitter (USART)   RM0490  748/1027   RM0490 Rev 5  Description of USART input/output signals  26.5.3   USART character description  The word length can be set to 7, 8 or 9 bits, by programming the M bits (M0: bit 12 and M1: bit 28) in the USART_CR1 register (see   Figure 253 ):  •   7-bit character length: M[1:0] = ‘10’  •   8-bit character length: M[1:0] = ‘00’  •   9-bit character length: M[1:0] = ‘01’  Note:   In 7-bit data length mode, the smartcard mode, LIN master mode and auto baud rate (0x7F and 0x55 frames detection) are not supported.  By default, the signal (TX or RX) is in low state during the start bit. It is in high state during the stop bit. These values can be inverted, separately for each signal, through polarity configuration control. An   Idle character   is interpreted as an entire frame of “1”s (the number of “1”s includes the number of stop bits).  Table 125. USART input/output pins Pin name   Signal type   Description  USART_RX   Input   Serial data receive input USART_TX   Output   Transmit data output USART_CTS (2)   Input   Clear to send USART_RTS (1)   Output   Request to send USART_DE   (1) 1.   USART_DE/USART_RTS/USART_CK share the same pin. Output   Driver enable USART_CK   (1)   Input/Output Clock input in synchronous slave mode. Clock output in synchronous master and smartcard modes. USART_NSS   (2) 2.   USART_CTS and USART_NSS share the same pin. Input   Slave select input in synchronous slave mode.  Table 126. USART internal input/output signals Pin name   Signal type   Description  usart_pclk   Input   APB clock usart_ker_ck   Input   USART kernel clock usart_wkup   Output   USART provides a wake-up interrupt usart_it   Output   USART global interrupt usart_tx_dma   Input/output   USART transmit DMA request usart_rx_dma   Input/output   USART receive DMA request

RM0490 Rev 5   749/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  A   Break character   is interpreted on receiving “0”s for a frame period. At the end of the break frame, the transmitter inserts 2 stop bits. Transmission and reception are driven by a common baud rate generator. The transmission and reception clock are generated when the enable bit is set for the transmitter and receiver, respectively. A detailed description of each block is given below.  Figure 253. Word length programming  MS33194V2 Bit0   Bit1   Bit2   Bit3   Bit4   Bit5   Bit6   Bit7   Bit8 Start bit Stop bit Next Start bit Idle frame  9-bit word length (M = 01 ), 1 Stop bit  Possible Parity bit Break frame Data frame Clock   ** Start bit Stop bit Start bit Stop bit Bit0   Bit1   Bit2   Bit3   Bit4   Bit5   Bit6   Bit7 Start bit Stop bit Next Start bit Idle frame  8-bit word length (M = 00 ), 1 Stop bit  Possible Parity bit Break frame Data frame Clock   ** Start bit Stop bit Start bit Stop bit Bit0   Bit1   Bit2   Bit3   Bit4   Bit5   Bit6 Start bit Stop bit Next Start bit Idle frame  7-bit word length (M = 10 ), 1 Stop bit  Possible Parity bit Break frame Data frame Clock ** LBCL bit controls last data clock pulse ** Start bit Stop bit Start bit Stop bit

Universal synchronous receiver transmitter (USART)   RM0490  750/1027   RM0490 Rev 5  26.5.4   USART FIFOs and thresholds  The USART can operate in FIFO mode. The USART comes with a Transmit FIFO (TXFIFO) and a Receive FIFO (RXFIFO). The FIFO mode is enabled by setting FIFOEN in USART_CR1 register (bit 29). This mode is supported only in UART, SPI and smartcard modes. Since the maximum data word length is 9 bits, the TXFIFO is 9-bit wide. However the RXFIFO default width is 12 bits. This is due to the fact that the receiver does not only store the data in the FIFO, but also the error flags associated to each character (Parity error, Noise error and Framing error flags).  Note:   The received data is stored in the RXFIFO together with the corresponding flags. However, only the data are read when reading the RDR. The status flags are available in the USART_ISR register.  It is possible to configure the TXFIFO and RXFIFO levels at which the Tx and RX interrupts are triggered. These thresholds are programmed through RXFTCFG and TXFTCFG bitfields in USART_CR3 control register. In this case:  •   The RXFT flag is set in the USART_ISR register and the corresponding interrupt (if enabled) is generated, when the number of received data in the RXFIFO reaches the threshold programmed in the RXFTCFG bits fields. This means that the RXFIFO is filled until the number of data in the RXFIFO is equal to the programmed threshold. RXFTCFG data have been received: one data in USART_RDR and (RXFTCFG - 1) data in the RXFIFO. As an example, when the RXFTCFG is programmed to ‘101’, the RXFT flag is set when a number of data corresponding to the FIFO size has been received (FIFO size -1 data in the RXFIFO and 1 data in the USART_RDR). As a result, the next received data is not set the overrun flag.  •   The TXFT flag is set in the USART_ISR register and the corresponding interrupt (if enabled) is generated when the number of empty locations in the TXFIFO reaches the threshold programmed in the TXFTCFG bits fields. This means that the TXFIFO is emptied until the number of empty locations in the TXFIFO is equal to the programmed threshold.  26.5.5   USART transmitter  The transmitter can send data words of either 7 or 8 or 9 bits, depending on the M bit status. The Transmit Enable bit (TE) must be set in order to activate the transmitter function. The data in the transmit shift register is output on the TX pin while the corresponding clock pulses are output on the CK pin.  Character transmission  During an USART transmission, data shifts out the least significant bit first (default configuration) on the TX pin. In this mode, the USART_TDR register consists of a buffer (TDR) between the internal bus and the transmit shift register. When FIFO mode is enabled, the data written to the transmit data register (USART_TDR) are queued in the TXFIFO.

RM0490 Rev 5   751/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Every character is preceded by a start bit which corresponds to a low logic level for one bit period. The character is terminated by a configurable number of stop bits. The number of stop bits can be configured to 0.5, 1, 1.5 or 2.  Note:   The TE bit must be set before writing the data to be transmitted to the USART_TDR. The TE bit should not be reset during data transmission. Resetting the TE bit during the transmission corrupts the data on the TX pin as the baud rate counters get frozen. The current data being transmitted are then lost. An idle frame is sent when the TE bit is enabled.  Configurable stop bits  The number of stop bits to be transmitted with every character can be programmed in USART_CR2, bits 13,12.  •   1 stop bit :   This is the default value of number of stop bits.  •   2 stop bits :   This is supported by normal USART, single-wire and modem modes.  •   1.5 stop bits :   To be used in smartcard mode. An idle frame transmission includes the stop bits. A break transmission features 10 low bits (when M[1:0] = ‘00’) or 11 low bits (when M[1:0] = ‘01’) or 9 low bits (when M[1:0] = ‘10’) followed by 2 stop bits (see   Figure 254 ). It is not possible to transmit long breaks (break of length greater than 9/10/11 low bits).  Figure 254. Configurable stop bits  MSv31887V1 ** LBCL bit controls last data clock pulse Bit7 Start bit   Stop bit Next start bit Possible parity bit Data frame   Next data frame CLOCK   ** Next data frame  8-bit data, 1 Stop bit 8-bit data, 1 1/2 Stop bits 8-bit data, 2 Stop bits  Bit6 Bit5 Bit4 Bit3 Bit2 Bit1 Bit0 Bit7 Start bit   1.5 Stop bits Next start bit Possible parity bit Data frame Bit6 Bit5 Bit4 Bit3 Bit2 Bit1 Bit0 Next data frame Bit7 Start bit   2 Stop bits Next start bit Possible parity bit Data frame Bit6 Bit5 Bit4 Bit3 Bit2 Bit1 Bit0

Universal synchronous receiver transmitter (USART)   RM0490  752/1027   RM0490 Rev 5  Character transmission procedure  To transmit a character, follow the sequence below: 1.   Program the M bits in USART_CR1 to define the word length. 2.   Select the desired baud rate using the USART_BRR register. 3.   Program the number of stop bits in USART_CR2. 4.   Enable the USART by writing the UE bit in USART_CR1 register to 1. 5.   Select DMA enable (DMAT) in USART_CR3 if multibuffer communication must take place. Configure the DMA register as explained in   Section 26.5.19: Continuous communication using USART and DMA . 6.   Set the TE bit in USART_CR1 to send an idle frame as first transmission. 7.   Write the data to send in the USART_TDR register. Repeat this for each data to be transmitted in case of single buffer. –   When FIFO mode is disabled, writing a data to the USART_TDR clears the TXE flag. –   When FIFO mode is enabled, writing a data to the USART_TDR adds one data to the TXFIFO. Write operations to the USART_TDR are performed when TXFNF flag is set. This flag remains set until the TXFIFO is full. 8.   When the last data is written to the USART_TDR register, wait until TC = 1. –   When FIFO mode is disabled, this indicates that the transmission of the last frame is complete. –   When FIFO mode is enabled, this indicates that both TXFIFO and shift register are empty. This check is required to avoid corrupting the last transmission when the USART is disabled or enters Halt mode.

RM0490 Rev 5   753/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Single byte communication  •   When FIFO mode is disabled Writing to the transmit data register always clears the TXE bit. The TXE flag is set by hardware. It indicates that: –   the data have been moved from the USART_TDR register to the shift register and the data transmission has started; –   the USART_TDR register is empty; –   the next data can be written to the USART_TDR register without overwriting the previous data. This flag generates an interrupt if the TXEIE bit is set. When a transmission is ongoing, a write instruction to the USART_TDR register stores the data in the TDR buffer. It is then copied in the shift register at the end of the current transmission. When no transmission is ongoing, a write instruction to the USART_TDR register places the data in the shift register, the data transmission starts, and the TXE bit is set.  •   When FIFO mode is enabled, the TXFNF (TXFIFO not full) flag is set by hardware to indicate that: –   the TXFIFO is not full; –   the USART_TDR register is empty; –   the next data can be written to the USART_TDR register without overwriting the previous data. When a transmission is ongoing, a write operation to the USART_TDR register stores the data in the TXFIFO. Data are copied from the TXFIFO to the shift register at the end of the current transmission. When the TXFIFO is not full, the TXFNF flag stays at ‘1’ even after a write operation to USART_TDR register. It is cleared when the TXFIFO is full. This flag generates an interrupt if the TXFNFIE bit is set. Alternatively, interrupts can be generated and data can be written to the FIFO when the TXFIFO threshold is reached. In this case, the CPU can write a block of data defined by the programmed trigger level. If a frame is transmitted (after the stop bit) and the TXE flag (TXFE in case of FIFO mode) is set, the TC flag goes high. An interrupt is generated if the TCIE bit is set in the USART_CR1 register. After writing the last data to the USART_TDR register, it is mandatory to wait until TC is set before disabling the USART or causing the device to enter the low-power mode (see  Figure 255: TC/TXE behavior when transmitting ).

Universal synchronous receiver transmitter (USART)   RM0490  754/1027   RM0490 Rev 5  Figure 255. TC/TXE behavior when transmitting  Note:   When FIFO management is enabled, the TXFNF flag is used for data transmission.  Break characters  Setting the SBKRQ bit transmits a break character. The break frame length depends on the M bit (see   Figure 253 ). If a ‘1’ is written to the SBKRQ bit, a break character is sent on the TX line after completing the current character transmission. The SBKF bit is set by the write operation and it is reset by hardware when the break character is completed (during the stop bits after the break character). The USART inserts a logic 1 signal (stop) for the duration of 2 bits at the end of the break frame to guarantee the recognition of the start bit of the next frame. When the SBKRQ bit is set, the break character is sent at the end of the current transmission. When FIFO mode is enabled, sending the break character has priority on sending data even if the TXFIFO is full.  Idle characters  Setting the TE bit drives the USART to send an idle frame before the first data frame.  26.5.6   USART receiver  The USART can receive data words of either 7 or 8 or 9 bits depending on the M bits in the USART_CR1 register.  Start bit detection  The start bit detection sequence is the same when oversampling by 16 or by 8. In the USART, the start bit is detected when a specific sequence of samples is recognized. This sequence is: 1 1 1 0 X 0 X 0X 0X 0 X 0X 0.  TX line USART_DR Frame 1 TXE flag F2 TC flag F3 Frame 2 Software waits until TXE=1 and writes F3 into DR TC is not set because TXE=0 Software waits until TC=1 Frame 3 TC is set because TXE=1 Set by hardware cleared by software Set by hardware cleared by software   Set by hardware Set by hardware Idle preamble F1 TC is not set because TXE=0 Software waits until TXE=1 and writes F1 into DR Software enables the USART Software waits until TXE=1 and writes F2 into DR ai17121b

RM0490 Rev 5   755/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Figure 256. Start bit detection when oversampling by 16 or 8  Note:   If the sequence is not complete, the start bit detection aborts and the receiver returns to the idle state (no flag is set), where it waits for a falling edge.  The start bit is confirmed (RXNE flag set and interrupt generated if RXNEIE = 1, or RXFNE flag set and interrupt generated if RXFNEIE = 1 if FIFO mode enabled) if the 3 sampled bits are at ‘0’ (first sampling on the 3rd, 5th and 7th bits finds the 3 bits at ‘0’ and second sampling on the 8th, 9th and 10th bits also finds the 3 bits at ‘0’). The start bit is validated but the NE noise flag is set if, a)   for both samplings, 2 out of the 3 sampled bits are at ‘0’ (sampling on the 3rd, 5th and 7th bits and sampling on the 8th, 9th and 10th bits) or b)   for one of the samplings (sampling on the 3rd, 5th and 7th bits or sampling on the 8th, 9th and 10th bits), 2 out of the 3 bits are found at ‘0’. If neither of the above conditions are met, the start detection aborts and the receiver returns to the idle state (no flag is set).  ai15471d 0 1   X   0   X   0   0   0   0   X   X   X   X   X   X Falling edge detection 1 1 1   2   3   4   5   6   7   8   9   10   11   12   13   14   15 16 X   X   X   X   X   X   X   X   9 6/16 7/16 7/16 X At least 2 bits out of 3 at 0   At least 2 bits out of 3 at 0 One-bit time Conditions to validate the start bit Real sample clock Ideal sample clock RX line RX state   Idle   Start bit Sampled values 10   11   12   13   14   15 16 0

Universal synchronous receiver transmitter (USART)   RM0490  756/1027   RM0490 Rev 5  Character reception  During an USART reception, data are shifted out least significant bit first (default configuration) through the RX pin.  Character reception procedure  To receive a character, follow the sequence below: 1.   Program the M bits in USART_CR1 to define the word length. 2.   Select the desired baud rate using the baud rate register USART_BRR 3.   Program the number of stop bits in USART_CR2. 4.   Enable the USART by writing the UE bit in USART_CR1 register to ‘1’. 5.   Select DMA enable (DMAR) in USART_CR3 if multibuffer communication is to take place. Configure the DMA register as explained in   Section 26.5.19: Continuous communication using USART and DMA . 6.   Set the RE bit USART_CR1. This enables the receiver which begins searching for a start bit. When a character is received:  •   When FIFO mode is disabled, the RXNE bit is set to indicate that the content of the shift register is transferred to the RDR. In other words, data have been received and can be read (as well as their associated error flags).  •   When FIFO mode is enabled, the RXFNE bit is set to indicate that the RXFIFO is not empty. Reading the USART_RDR returns the oldest data entered in the RXFIFO. When a data is received, it is stored in the RXFIFO together with the corresponding error bits.  •   An interrupt is generated if the RXNEIE (RXFNEIE when FIFO mode is enabled) bit is set.  •   The error flags can be set if a frame error, noise, parity or an overrun error was detected during reception.  •   In multibuffer communication mode: –   When FIFO mode is disabled, the RXNE flag is set after every byte reception. It is cleared when the DMA reads the Receive data Register. –   When FIFO mode is enabled, the RXFNE flag is set when the RXFIFO is not empty. After every DMA request, a data is retrieved from the RXFIFO. A DMA request is triggered when the RXFIFO is not empty i.e. when there are data to be read from the RXFIFO.  •   In single buffer mode: –   When FIFO mode is disabled, clearing the RXNE flag is done by performing a software read from the USART_RDR register. The RXNE flag can also be cleared by programming RXFRQ bit to ‘1’ in the USART_RQR register. The RXNE flag must be cleared before the end of the reception of the next character to avoid an overrun error. –   When FIFO mode is enabled, the RXFNE is set when the RXFIFO is not empty. After every read operation from USART_RDR, a data is retrieved from the RXFIFO. When the RXFIFO is empty, the RXFNE flag is cleared. The RXFNE flag can also be cleared by programming RXFRQ bit to ‘1’ in USART_RQR. When the RXFIFO is full, the first entry in the RXFIFO must be read before the end of the reception of the next character, to avoid an overrun error. The RXFNE flag generates an interrupt if the RXFNEIE bit is set. Alternatively, interrupts can be

RM0490 Rev 5   757/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  generated and data can be read from RXFIFO when the RXFIFO threshold is reached. In this case, the CPU can read a block of data defined by the programmed threshold.  Break character  When a break character is received, the USART handles it as a framing error.  Idle character  When an idle frame is detected, it is handled in the same way as a data character reception except that an interrupt is generated if the IDLEIE bit is set.  Overrun error  •   FIFO mode disabled An overrun error occurs if a character is received and RXNE has not been reset. Data can not be transferred from the shift register to the RDR register until the RXNE bit is cleared. The RXN E flag is set after every byte reception. An overrun error occurs if RXNE flag is set when the next data is received or the previous DMA request has not been serviced. When an overrun error occurs: –   the ORE bit is set; –   the RDR content is not lost. The previous data is available by reading the USART_RDR register. –   the shift register is overwritten. After that, any data received during overrun is lost. –   an interrupt is generated if either the RXNEIE or the EIE bit is set.  •   FIFO mode enabled An overrun error occurs when the shift register is ready to be transferred and the receive FIFO is full. Data can not be transferred from the shift register to the USART_RDR register until there is one free location in the RXFIFO. The RXFNE flag is set when the RXFIFO is not empty. An overrun error occurs if the RXFIFO is full and the shift register is ready to be transferred. When an overrun error occurs: –   The ORE bit is set. –   The first entry in the RXFIFO is not lost. It is available by reading the USART_RDR register. –   The shift register is overwritten. After that point, any data received during overrun is lost. –   An interrupt is generated if either the RXFNEIE or EIE bit is set. The ORE bit is reset by setting the ORECF bit in the USART_ICR register.  Note:   The ORE bit, when set, indicates that at least 1 data has been lost. When the FIFO mode is disabled, there are two possibilities  •   if RXNE = 1, then the last valid data is stored in the receive register (RDR) and can be read,  •   if RXNE = 0, the last valid data has already been read and there is nothing left to be read in the RDR register. This case can occur when the last valid data is read in the RDR register at the same time as the new (and lost) data is received.

Universal synchronous receiver transmitter (USART)   RM0490  758/1027   RM0490 Rev 5  Selecting the clock source and the appropriate oversampling method  The choice of the clock source is done through the Clock Control system (see Section   Reset and clock control (RCC) ). The clock source must be selected through the UE bit before enabling the USART. The clock source must be selected according to two criteria:  •   Possible use of the USART in low-power mode  •   Communication speed. The clock source frequency is usart_ker_ck. When the dual clock domain and the wake-up from low-power mode features are supported, the usart_ker_ck clock source can be configurable in the RCC (see Section   Reset and clock control (RCC) ). Otherwise the usart_ker_ck clock is the same as usart_pclk. The usart_ker_ck clock can be divided by a programmable factor, defined in the USART_PRESC register.  Figure 257. usart_ker_ck clock divider block diagram  Some usart_ker_ck sources enable the USART to receive data while the MCU is in low- power mode. Depending on the received data and wake-up mode selected, the USART wakes up the MCU, when needed, in order to transfer the received data, by performing a software read to the USART_RDR register or by DMA. For the other clock sources, the system must be active to enable USART communications. The communication speed range (specially the maximum communication speed) is also determined by the clock source. The receiver implements different user-configurable oversampling techniques (except in synchronous mode) for data recovery by discriminating between valid incoming data and noise. This enables obtaining the best a trade-off between the maximum communication speed and noise/clock inaccuracy immunity. The oversampling method can be selected by programming the OVER8 bit in the USART_CR1 register either to 16 or 8 times the baud rate clock (see   Figure 258   and  Figure 259 ). Depending on your application:  •   select oversampling by 8 (OVER8   =   1) to achieve higher speed (up to usart_ker_ck_pres/8). In this case the maximum receiver tolerance to clock deviation is reduced (refer to   Section 26.5.8: Tolerance of the USART receiver to clock deviation on page 762 )  •   select oversampling by 16 (OVER8   =   0) to increase the tolerance of the receiver to clock deviations. In this case, the maximum speed is limited to maximum  MSv40855V1 USARTx_PRESC[3:0]   USARTx_BRR register and oversampling usart_ker_ck_pres usart_ker_ck

RM0490 Rev 5   759/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  usart_ker_ck_pres/16 (where usart_ker_ck_pres is the USART input clock divided by a prescaler). Programming the ONEBIT bit in the USART_CR3 register selects the method used to evaluate the logic level. Two options are available:  •   The majority vote of the three samples in the center of the received bit. In this case, when the 3 samples used for the majority vote are not equal, the NE bit is set.  •   A single sample in the center of the received bit Depending on your application: –   select the three sample majority vote method (ONEBIT   =   0) when operating in a noisy environment and reject the data when a noise is detected (refer to  Figure 127 ) because this indicates that a glitch occurred during the sampling. –   select the single sample method (ONEBIT   =   1) when the line is noise-free to increase the receiver tolerance to clock deviations (see   Section 26.5.8: Tolerance of the USART receiver to clock deviation on page 762 ). In this case the NE bit is never set. When noise is detected in a frame:  •   The NE bit is set at the rising edge of the RXNE bit (RXFNE in case of FIFO mode enabled).  •   The invalid data is transferred from the Shift register to the USART_RDR register.  •   No interrupt is generated in case of single byte communication. However this bit rises at the same time as the RXNE bit (RXFNE in case of FIFO mode enabled) which itself generates an interrupt. In case of multibuffer communication an interrupt is issued if the EIE bit is set in the USART_CR3 register. The NE bit is reset by setting NECF bit in USART_ICR register.  Note:   Noise error is not supported in SPI and IrDA modes. Oversampling by 8 is not available in the smartcard, IrDA and LIN modes. In those modes, the OVER8 bit is forced to ‘0 ’ by hardware.  Figure 258. Data sampling when oversampling by 16  MSv31152V1 1   2   3   4   5   6   7   8   9   10   11   12   13   14   15   16 sampled values 6/16 7/16 7/16 One bit time Sample clock RX line

Universal synchronous receiver transmitter (USART)   RM0490  760/1027   RM0490 Rev 5  Figure 259. Data sampling when oversampling by 8  Framing error  A framing error is detected when the stop bit is not recognized on reception at the expected time, following either a de-synchronization or excessive noise. When the framing error is detected:  •   the FE bit is set by hardware;  •   the invalid data is transferred from the Shift register to the USART_RDR register (RXFIFO in case FIFO mode is enabled).  •   no interrupt is generated in case of single byte communication. However this bit rises at the same time as the RXNE bit (RXFNE in case FIFO mode is enabled) which itself generates an interrupt. In case of multibuffer communication an interrupt is issued if the EIE bit is set in the USART_CR3 register. The FE bit is reset by writing ‘1’ to the FECF in the USART_ICR register.  Note:   Framing error is not supported in SPI mode.  Table 127. Noise detection from sampled data Sampled value   NE status   Received bit value  000   0   0 001   1   0 010   1   0 011   1   1 100   1   0 101   1   1 110   1   1 111   0   1  MSv31153V1 1   2   3   4   5   6   7 sampled values 2/8 3/8 3/8 One bit time Sample clock (x8) RX line 8

RM0490 Rev 5   761/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Configurable stop bits during reception  The number of stop bits to be received can be configured through the control bits of USART_CR: it can be either 1 or 2 in normal mode and 0.5 or 1.5 in smartcard mode.  •   0.5 stop bit (reception in smartcard mode) : no sampling is done for 0.5 stop bit. As a consequence, no framing error and no break frame can be detected when 0.5 stop bit is selected.  •   1 stop bit : sampling for 1 stop bit is done on the 8th, 9th and 10th samples.  •   1.5 stop bits (smartcard mode) When transmitting in smartcard mode, the device must check that the data are correctly sent. The receiver block must consequently be enabled (RE = 1 in USART_CR1) and the stop bit is checked to test if the smartcard has detected a parity error. In the event of a parity error, the smartcard forces the data signal low during the sampling (NACK signal), which is flagged as a framing error. The FE flag is then set through RXNE flag (RXFNE if the FIFO mode is enabled) at the end of the 1.5 stop bit. Sampling for 1.5 stop bits is done on the 16th, 17th and 18th samples (1 baud clock period after the beginning of the stop bit). The 1.5 stop bit can be broken into 2 parts: one 0.5 baud clock period during which nothing happens, followed by 1 normal stop bit period during which sampling occurs halfway through (refer to   Section 26.5.16: USART receiver timeout on page 776   for more details).  •   2 stop bits Sampling for 2 stop bits is done on the 8th, 9th and 10th samples of the first stop bit. The framing error flag is set if a framing error is detected during the first stop bit. The second stop bit is not checked for framing error. The RXNE flag (RXFNE if the FIFO mode is enabled) is set at the end of the first stop bit.  26.5.7   USART baud rate generation  The baud rate for the receiver and transmitter (Rx and Tx) are both set to the value programmed in the USART_BRR register.  Equation 1: baud rate for standard USART (SPI mode included) (OVER8 = ‘0’ or ‘1’)  In case of oversampling by 16, the baud rate is given by the following formula: In case of oversampling by 8, the baud rate is given by the following formula:  Equation 2: baud rate in smartcard, LIN and IrDA modes (OVER8 = 0)  The baud rate is given by the following formula: Tx/Rx baud   usart_ker_ck_pres USARTDIV  -------------------------------------------------- - =  Tx/Rx baud   2   usart_ker_ck_pres ×  USARTDIV  ------------------------------------------------------------- =  Tx/Rx baud   usart_ker_ck_pres USARTDIV  -------------------------------------------------- - =

Universal synchronous receiver transmitter (USART)   RM0490  762/1027   RM0490 Rev 5  USARTDIV is an unsigned fixed point number that is coded on the USART_BRR register.  •   When OVER8 = 0, BRR = USARTDIV.  •   When OVER8 = 1 –   BRR[2:0] = USARTDIV[3:0] shifted 1 bit to the right. –   BRR[3] must be kept cleared. –   BRR[15:4] = USARTDIV[15:4]  Note:   The baud counters are updated to the new value in the baud registers after a write operation to USART_BRR. Hence the baud rate register value should not be changed during communication. In case of oversampling by 16 and 8, USARTDIV must be greater than or equal to 16.  How to derive USARTDIV from USART_BRR register values Example 1  To obtain 9600 baud with usart_ker_ck_pres = 8 MHz:  •   In case of oversampling by 16: USARTDIV = 8 000 000/9600 BRR = USARTDIV = 0d833 = 0x0341  •   In case of oversampling by 8: USARTDIV = 2 * 8 000 000/9600 USARTDIV = 1666,66 (0d1667 = 0x683) BRR[3:0] = 0x3 >> 1 = 0x1 BRR = 0x681  Example 2  To obtain 921.6 Kbaud with usart_ker_ck_pres = 48 MHz:  •   In case of oversampling by 16: USARTDIV = 48 000 000/921 600 BRR = USARTDIV = 0d52 = 0x34  •   In case of oversampling by 8: USARTDIV = 2 * 48 000 000/921 600 USARTDIV = 104 (0d104 = 0x68) BRR[3:0] = USARTDIV[3:0] >> 1 = 0x8 >> 1 = 0x4 BRR = 0x64  26.5.8   Tolerance of the USART receiver to clock deviation  The USART asynchronous receiver operates correctly only if the total clock system deviation is less than the tolerance of the USART receiver.

RM0490 Rev 5   763/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  The causes which contribute to the total deviation are:  •   DTRA: deviation due to the transmitter error (which also includes the deviation of the transmitter’s local oscillator)  •   DQUANT: error due to the baud rate quantization of the receiver  •   DREC: deviation of the receiver local oscillator  •   DTCL: deviation due to the transmission line (generally due to the transceivers which can introduce an asymmetry between the low-to-high transition timing and the high-to- low transition timing) where DWU is the error due to sampling point deviation when the wake-up from low- power mode is used. when M[1:0] = 01: when M[1:0] = 00: when M[1:0] = 10: t WUUSART   is the time between the detection of the start bit falling edge and the instant when the clock (requested by the peripheral) is ready and reaching the peripheral, and the regulator is ready. The USART receiver can receive data correctly at up to the maximum tolerated deviation specified in   Table 128 ,   Table 129 , depending on the following settings:  •   9-, 10- or 11-bit character length defined by the M bits in the USART_CR1 register  •   Oversampling by 8 or 16 defined by the OVER8 bit in the USART_CR1 register  •   Bits BRR[3:0] of USART_BRR register are equal to or different from 0000.  •   Use of 1 bit or 3 bits to sample the data, depending on the value of the ONEBIT bit in the USART_CR3 register.  Table 128. Tolerance of the USART receiver when BRR [3:0] = 0000 M bits OVER8 bit = 0   OVER8 bit = 1 ONEBIT = 0   ONEBIT = 1   ONEBIT = 0   ONEBIT = 1  00   3.75%   4.375%   2.50%   3.75% 01   3.41%   3.97%   2.27%   3.41% 10   4.16%   4.86%   2.77%   4.16% DTRA   DQUANT   DREC   DTCL   DWU +   +   +   +   USART receiver tolerance <  DWU   t   WUUSART 11   Tbit ×  -------------------------- - =  DWU   t   WUUSART 10   Tbit ×  -------------------------- - =  DWU   t   WUUSART 9   Tbit ×  -------------------------- - =

Universal synchronous receiver transmitter (USART)   RM0490  764/1027   RM0490 Rev 5  Note:   The data specified in Table 128   and   Table 129 may slightly differ in the special case when the received frames contain some Idle frames of exactly 10-bit times when M bits = 00 (11- bit times when M = 01 or 9- bit times when M = 10).  26.5.9   USART auto baud rate detection  The USART can detect and automatically set the USART_BRR register value based on the reception of one character. Automatic baud rate detection is useful under two circumstances:  •   The communication speed of the system is not known in advance.  •   The system is using a relatively low accuracy clock source and this mechanism enables the correct baud rate to be obtained without measuring the clock deviation. The clock source frequency must be compatible with the expected communication speed.  •   When oversampling by 16, the baud rate ranges from usart_ker_ck_pres/65535 and usart_ker_ck_pres/16.  •   When oversampling by 8, the baud rate ranges from usart_ker_ck_pres/65535 and usart_ker_ck_pres/8. Before activating the auto baud rate detection, the auto baud rate detection mode must be selected through the ABRMOD[1:0] field in the USART_CR2 register. There are four modes based on different character patterns. In these auto baud rate modes, the baud rate is measured several times during the synchronization data reception and each measurement is compared to the previous one.  Table 129. Tolerance of the USART receiver when BRR[3:0] is different from 0000 M bits OVER8 bit = 0   OVER8 bit = 1 ONEBIT = 0   ONEBIT = 1   ONEBIT = 0   ONEBIT = 1  00   3.33%   3.88%   2%   3% 01   3.03%   3.53%   1.82%   2.73% 10   3.7%   4.31%   2.22%   3.33%

RM0490 Rev 5   765/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  These modes are the following:  •   Mode 0 : Any character starting with a bit at ‘1’. In this case the USART measures the duration of the start bit (falling edge to rising edge).  •   Mode 1:   Any character starting with a 10xx bit pattern. In this case, the USART measures the duration of the Start and of the 1st data bit. The measurement is done falling edge to falling edge, to ensure a better accuracy in the case of slow signal slopes.  •   Mode 2 : A 0x7F character frame (it may be a 0x7F character in LSB first mode or a 0xFE in MSB first mode). In this case, the baud rate is updated first at the end of the start bit (BRs), then at the end of bit 6 (based on the measurement done from falling edge to falling edge: BR6). Bit0 to bit6 are sampled at BRs while further bits of the character are sampled at BR6.  •   Mode 3 : A 0x55 character frame. In this case, the baud rate is updated first at the end of the start bit (BRs), then at the end of bit0 (based on the measurement done from falling edge to falling edge: BR0), and finally at the end of bit6 (BR6). Bit 0 is sampled at BRs, bit 1 to bit 6 are sampled at BR0, and further bits of the character are sampled at BR6. In parallel, another check is performed for each intermediate RX line transition. An error is generated if the transitions on RX are not sufficiently synchronized with the receiver (the receiver being based on the baud rate calculated on bit 0). Prior to activating the auto baud rate detection, the USART_BRR register must be initialized by writing a non-zero baud rate value. The automatic baud rate detection is activated by setting the ABREN bit in the USART_CR2 register. The USART then waits for the first character on the RX line. The auto baud rate operation completion is indicated by the setting of the ABRF flag in the USART_ISR register. If the line is noisy, the correct baud rate detection cannot be guaranteed. In this case the BRR value may be corrupted and the ABRE error flag is set. This also happens if the communication speed is not compatible with the automatic baud rate detection range (bit duration not between 16 and 65536 clock periods (oversampling by 16) and not between 8 and 65536 clock periods (oversampling by 8)). The auto baud rate detection can be re-launched later by resetting the ABRF flag (by writing a ‘0’). When FIFO management is disabled and an auto baud rate error occurs, the ABRE flag is set through RXNE and FE bits. When FIFO management is enabled and an auto baud rate error occurs, the ABRE flag is set through RXFNE and FE bits. If the FIFO mode is enabled, the auto baud rate detection should be made using the data on the first RXFIFO location. So, prior to launching the auto baud rate detection, make sure that the RXFIFO is empty by checking the RXFNE flag in USART_ISR register.  Note:   The BRR value might be corrupted if the USART is disabled (UE = 0) during an auto baud rate operation.

Universal synchronous receiver transmitter (USART)   RM0490  766/1027   RM0490 Rev 5  26.5.10   USART multiprocessor communication  It is possible to perform USART multiprocessor communications (with several USARTs connected in a network). For instance one of the USARTs can be the master with its TX output connected to the RX inputs of the other USARTs, while the others are slaves with their respective TX outputs logically ANDed together and connected to the RX input of the master. In multiprocessor configurations, it is often desirable that only the intended message recipient actively receives the full message contents, thus reducing redundant USART service overhead for all non addressed receivers. The non-addressed devices can be placed in mute mode by means of the muting function. To use the mute mode feature, the MME bit must be set in the USART_CR1 register.  Note:   When FIFO management is enabled and MME is already set, MME bit must not be cleared and then set again quickly (within two usart_ker_ck cycles), otherwise mute mode might remain active.  When the mute mode is enabled:  •   none of the reception status bits can be set;  •   all the receive interrupts are inhibited;  •   the RWU bit in USART_ISR register is set to ‘1’. RWU can be controlled automatically by hardware or by software, through the MMRQ bit in the USART_RQR register, under certain conditions. The USART can enter or exit from mute mode using one of two methods, depending on the WAKE bit in the USART_CR1 register:  •   Idle Line detection if the WAKE bit is reset,  •   Address Mark detection if the WAKE bit is set.  Idle line detection (WAKE = 0)  The USART enters mute mode when the MMRQ bit is written to ‘1’ and the RWU is automatically set. The USART wakes up when an Idle frame is detected. The RWU bit is then cleared by hardware but the IDLE bit is not set in the USART_ISR register. An example of mute mode behavior using Idle line detection is given in   Figure 260 .

RM0490 Rev 5   767/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Figure 260. Mute mode using Idle line detection  Note:   If the MMRQ is set while the IDLE character has already elapsed, mute mode is not entered (RWU is not set). If the USART is activated while the line is IDLE, the idle state is detected after the duration of one IDLE frame (not only after the reception of one character frame).  4-bit/7-bit address mark detection (WAKE = 1)  In this mode, bytes are recognized as addresses if their MSB is a ‘1’, otherwise they are considered as data. In an address byte, the address of the targeted receiver is put in the 4 or 7 LSBs. The choice of 7 or 4 bit address detection is done using the ADDM7 bit. This 4- bit/7-bit word is compared by the receiver with its own address which is programmed in the ADD bits in the USART_CR2 register.  Note:   In 7-bit and 9-bit data modes, address detection is done on 6-bit and 8-bit addresses (ADD[5:0] and ADD[7:0]) respectively.  The USART enters mute mode when an address character is received which does not match its programmed address. In this case, the RWU bit is set by hardware. The RXNE flag is not set for this address byte and no interrupt or DMA request is issued when the USART enters mute mode. When FIFO management is enabled, the software should ensure that there is at least one empty location in the RXFIFO before entering mute mode. The USART also enters mute mode when the MMRQ bit is written to 1. The RWU bit is also automatically set in this case. The USART exits from mute mode when an address character is received which matches the programmed address. Then the RWU bit is cleared and subsequent bytes are received normally. The RXNE/RXFNE bit is set for the address character since the RWU bit has been cleared.  Note:   When FIFO management is enabled, when MMRQ is set while the receiver is sampling last bit of a data, this data may be received before effectively entering in mute mode  An example of mute mode behavior using address mark detection is given in   Figure 261 .  MSv31154V1 Data 1   Data 2   IDLE Data 3 Data 4   Data 6 Idle frame detected MMRQ written to 1 RWU RX Mute mode   Normal mode RXNE   RXNE Data 5

Universal synchronous receiver transmitter (USART)   RM0490  768/1027   RM0490 Rev 5  Figure 261. Mute mode using address mark detection 26.5.11   USART Modbus communication  The USART offers basic support for the implementation of Modbus/RTU and Modbus/ASCII protocols. Modbus/RTU is a half-duplex, block-transfer protocol. The control part of the protocol (address recognition, block integrity control and command interpretation) must be implemented in software. The USART offers basic support for the end of the block detection, without software overhead or other resources.  Modbus/RTU  In this mode, the end of one block is recognized by a “silence” (idle line) for more than 2 character times. This function is implemented through the programmable timeout function. The timeout function and interrupt must be activated, through the RTOEN bit in the USART_CR2 register and the RTOIE in the USART_CR1 register. The value corresponding to a timeout of 2 character times (for example 22 x bit time) must be programmed in the RTO register. When the receive line is idle for this duration, after the last stop bit is received, an interrupt is generated, informing the software that the current block reception is completed.  Modbus/ASCII  In this mode, the end of a block is recognized by a specific (CR/LF) character sequence. The USART manages this mechanism using the character match function. By programming the LF ASCII code in the ADD[7:0] field and by activating the character match interrupt (CMIE   =   1), the software is informed when a LF has been received and can check the CR/LF in the DMA buffer.  MSv31155V1 IDLE   Addr=0 Data 1 Data 2   IDLE   Addr=1 Data 3 Data 4 Addr=2 Data 5 In this example, the current address of the receiver is 1 (programmed in the USART_CR2 register)   RXNE Non-matching address Matching address Non-matching address MMRQ written to 1 (RXNE was cleared) RWU RX Mute mode   Mute mode Normal mode RXNE   RXNE

RM0490 Rev 5   769/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  26.5.12   USART parity control  Parity control (generation of parity bit in transmission and parity checking in reception) can be enabled by setting the PCE bit in the USART_CR1 register. Depending on the frame length defined by the M bits, the possible USART frame formats are as listed in   Table 130 .  Even parity  The parity bit is calculated to obtain an even number of “1s” inside the frame of the 6, 7 or 8 LSB bits (depending on M bit values) and the parity bit. As an example, if data   =   00110101 and 4 bits are set, the parity bit is equal to 0 if even parity is selected (PS bit in USART_CR1 = 0).  Odd parity  The parity bit is calculated to obtain an odd number of “1s” inside the frame made of the 6, 7 or 8 LSB bits (depending on M bit values) and the parity bit. As an example, if data   =   00110101 and 4 bits set, then the parity bit is equal to 1 if odd parity is selected (PS bit in USART_CR1 = 1).  Parity checking in reception  If the parity check fails, the PE flag is set in the USART_ISR register and an interrupt is generated if PEIE is set in the USART_CR1 register. The PE flag is cleared by software writing 1 to the PECF in the USART_ICR register.  Parity generation in transmission  If the PCE bit is set in USART_CR1, then the MSB bit of the data written in the data register is transmitted but is changed by the parity bit (even number of “1s” if even parity is selected (PS   =   0) or an odd number of “1s” if odd parity is selected (PS=1).  Table 130. USART frame formats M bits   PCE bit   USART frame   (1)  1.   Legends: SB: start bit, STB: stop bit, PB: parity bit. In the data register, the PB is always taking the MSB position (8th or 7th, depending on the M bit value). 00   0   | SB | 8 bit data | STB | 00   1   | SB | 7-bit data | PB | STB | 01   0   | SB | 9-bit data | STB | 01   1   | SB | 8-bit data PB | STB | 10   0   | SB | 7bit data | STB | 10   1   | SB | 6-bit data | PB | STB |

Universal synchronous receiver transmitter (USART)   RM0490  770/1027   RM0490 Rev 5  26.5.13   USART LIN (local interconnection network) mode  This section is relevant only when LIN mode is supported. Refer to   Section 26.4: USART implementation on page 744 . The LIN mode is selected by setting the LINEN bit in the USART_CR2 register. In LIN mode, the following bits must be kept cleared:  •   STOP[1:0] and CLKEN in the USART_CR2 register,  •   SCEN, HDSEL and IREN in the USART_CR3 register.  LIN transmission  The procedure described in   Section 26.5.4   has to be applied for LIN master transmission. It must be the same as for normal USART transmission with the following differences:  •   Clear the M bit to configure 8-bit word length.  •   Set the LINEN bit to enter LIN mode. In this case, setting the SBKRQ bit sends 13 ‘0 bits as a break character. Then two bits of value ‘1 are sent to enable the next start detection.  LIN reception  When LIN mode is enabled, the break detection circuit is activated. The detection is totally independent from the normal USART receiver. A break can be detected whenever it occurs, during Idle state or during a frame. When the receiver is enabled (RE   =   1 in USART_CR1), the circuit looks at the RX input for a start signal. The method for detecting start bits is the same when searching break characters or data. After a start bit has been detected, the circuit samples the next bits exactly like for the data (on the 8th, 9th and 10th samples). If 10 (when the LBDL = 0 in USART_CR2) or 11 (when LBDL   =   1 in USART_CR2) consecutive bits are detected as ‘0, and are followed by a delimiter character, the LBDF flag is set in USART_ISR. If the LBDIE bit   =   1, an interrupt is generated. Before validating the break, the delimiter is checked for as it signifies that the RX line has returned to a high level. If a ‘1 is sampled before the 10 or 11 have occurred, the break detection circuit cancels the current detection and searches for a start bit again. If the LIN mode is disabled (LINEN   =   0), the receiver continues working as normal USART, without taking into account the break detection. If the LIN mode is enabled (LINEN   =   1), as soon as a framing error occurs (i.e. stop bit detected at ‘0, which is the case for any break frame), the receiver stops until the break detection circuit receives either a ‘1, if the break word was not complete, or a delimiter character if a break has been detected. The behavior of the break detector state machine and the break flag is shown on the  Figure 262: Break detection in LIN mode (11-bit break length - LBDL bit is set) on page 771 . Examples of break frames are given on   Figure 263: Break detection in LIN mode vs. Framing error detection on page 772 .

RM0490 Rev 5   771/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Figure 262. Break detection in LIN mode (11-bit break length - LBDL bit is set)  MSv31156V1 Idle   Bit0   Bit1   Bit2   Bit3   Bit4   Bit5   Bit6   Bit7   Bit8   Bit9   Bit10   Idle 0   0   0   0   0   0   0   0   0   0   1  Case 1: break signal not long enough => break discarded, LBDF is not set  RX line Capture strobe Break state machine Read samples Idle   Bit0   Bit1   Bit2   Bit3   Bit4   Bit5   Bit6   Bit7   Bit8   Bit9 B10   Idle 0   0   0   0   0   0   0   0   0   0   0  Case 2: break signal just long enough => break detected, LBDF is set  RX line Capture strobe Break state machine Read samples Break frame Break frame Delimiter is immediate LBDF Idle   Bit0   Bit1   Bit2   Bit3   Bit4   Bit5   Bit6   Bit7   Bit8   Bit9   Bit10   Idle 0   0   0   0   0   0   0   0   0   0   0  Case 3: break signal long enough => break detected, LBDF is set  RX line Capture strobe Break state machine Read samples Break frame LBDF wait delimiter

Universal synchronous receiver transmitter (USART)   RM0490  772/1027   RM0490 Rev 5  Figure 263. Break detection in LIN mode vs. Framing error detection 26.5.14   USART synchronous mode Master mode  The synchronous master mode is selected by programming the CLKEN bit in the USART_CR2 register to ‘1’. In synchronous mode, the following bits must be kept cleared:  •   LINEN bit in the USART_CR2 register,  •   SCEN, HDSEL and IREN bits in the USART_CR3 register. In this mode, the USART can be used to control bidirectional synchronous serial communications in master mode. The CK pin is the output of the USART transmitter clock. No clock pulses are sent to the CK pin during start bit and stop bit. Depending on the state of the LBCL bit in the USART_CR2 register, clock pulses are, or are not, generated during the last valid data bit (address mark). The CPOL bit in the USART_CR2 register is used to select the clock polarity, and the CPHA bit in the USART_CR2 register is used to select the phase of the external clock (see   Figure 264 ,   Figure 265   and   Figure 266 ). During the Idle state, preamble and send break, the external CK clock is not activated. In synchronous master mode, the USART transmitter operates exactly like in asynchronous mode. However, since CK is synchronized with TX (according to CPOL and CPHA), the data on TX is synchronous. In synchronous master mode, the USART receiver operates in a different way compared to asynchronous mode. If RE is set to 1, the data are sampled on CK (rising or falling edge, depending on CPOL and CPHA), without any oversampling. A given setup and a hold time must be respected (which depends on the baud rate: 1/16 bit time).  MSv31157V1 data 1   IDLE   BREAK   data 2 (0x55)   data 3 (header) 1 data time   1 data time RX line RXNE /FE LBDF  Case 1: break occurring after an Idle  data 1   data2   BREAK   data 2 (0x55)   data 3 (header) 1 data time   1 data time RX line RXNE /FE LBDF  Case 2: break occurring while data is being received

RM0490 Rev 5   773/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Note:   In master mode, the CK pin operates in conjunction with the TX pin. Thus, the clock is provided only if the transmitter is enabled (TE = 1) and data are being transmitted (USART_TDR data register written). This means that it is not possible to receive synchronous data without transmitting data.  Figure 264. USART example of synchronous master transmission Figure 265. USART data clock timing diagram in synchronous master mode (M bits = 00)  MSv31158V2  USART   Synchronous device (slave SPI)  RX TX Data out Data in Clock CK  MSv34709V2 0   1   2   3   4   5   6   7 0   1   2   3   4   5   6   7 * * * * MSB MSB LSB LSB Start Start   Stop Idle or preceding transmission Idle or next transmission * *LBCL bit controls last data pulse Capture strobe Data on RX (from slave) Data on TX (from master) Clock (CPOL=1, CPHA=1) Clock (CPOL=1, CPHA=0) Clock (CPOL=0, CPHA=1) Clock (CPOL=0, CPHA=0) Stop M bits = 00 (8 data bits)

Universal synchronous receiver transmitter (USART)   RM0490  774/1027   RM0490 Rev 5  Figure 266. USART data clock timing diagram in synchronous master mode (M bits = 01) Slave mode  The synchronous slave mode is selected by programming the SLVEN bit in the USART_CR2 register to ‘1’. In synchronous slave mode, the following bits must be kept cleared:  •   LINEN and CLKEN bits in the USART_CR2 register,  •   SCEN, HDSEL and IREN bits in the USART_CR3 register. In this mode, the USART can be used to control bidirectional synchronous serial communications in slave mode. The CK pin is the input of the USART in slave mode.  Note:   When the peripheral is used in SPI slave mode, the frequency of peripheral clock source ( usart_ker_ck_pres ) must be greater than 3 times the CK input frequency.  The CPOL bit and the CPHA bit in the USART_CR2 register are used to select the clock polarity and the phase of the external clock, respectively (see   Figure 267 ). An underrun error flag is available in slave transmission mode. This flag is set when the first clock pulse for data transmission appears while the software has not yet loaded any value to USART_TDR. The slave supports the hardware and software NSS management.  MSv34710V1 0   1   2   3   4   5   6   8 0   1   2   3   4   5   6   8 * * * * MSB MSB LSB LSB Start Start   Stop Idle or preceding transmission Idle or next transmission * *LBCL bit controls last data pulse Capture strobe Data on RX (from slave) Data on TX (from master) Clock (CPOL=1, CPHA=1) Clock (CPOL=1, CPHA=0) Clock (CPOL=0, CPHA=1) Clock (CPOL=0, CPHA=0) Stop M bits =01 (9 data bits) 7 7

RM0490 Rev 5   775/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Figure 267. USART data clock timing diagram in synchronous slave mode (M bits = 00) Slave select (NSS) pin management  The hardware or software slave select management can be set through the DIS_NSS bit in the USART_CR2 register:  •   Software NSS management (DIS_NSS = 1) The SPI slave is always selected and NSS input pin is ignored. The external NSS pin remains free for other application uses.  •   Hardware NSS management (DIS_NSS = 0) The SPI slave selection depends on NSS input pin. The slave is selected when NSS is low and deselected when NSS is high.  Note:   The LBCL (used only on SPI master mode), CPOL and CPHA bits have to be selected when the USART is disabled (UE = 0) to ensure that the clock pulses function correctly. In SPI slave mode, the USART must be enabled before starting the master communications (or between frames while the clock is stable). Otherwise, if the USART slave is enabled while the master is in the middle of a frame, it becomes desynchronized with the master. The data register of the slave needs to be ready before the first edge of the communication clock or before the end of the ongoing communication, otherwise the SPI slave transmits zeros.  SPI slave underrun error  When an underrun error occurs, the UDR flag is set in the USART_ISR register, and the SPI slave goes on sending the last data until the underrrun error flag is cleared by software. The underrun flag is set at the beginning of the frame. An underrun error interrupt is triggered if EIE bit is set in the USART_CR3 register. The underrun error flag is cleared by setting bit   UDRCF   in the USART_ICR register.  MSv45359V1 0   1   2   3   4   5   6   7 0   1   2   3   4   5   6   7 MSB MSB LSB LSB Capture strobe Data on RX (from master) Data on TX (from slave) Clock (CPOL=1, CPHA=1) Clock (CPOL=1, CPHA=0) Clock (CPOL=0, CPHA=1) Clock (CPOL=0, CPHA=0) M bits = 00 (8 data bits) NSS (from Master)

Universal synchronous receiver transmitter (USART)   RM0490  776/1027   RM0490 Rev 5  In case of underrun error, it is still possible to write to the TDR register. Clearing the underrun error enables sending new data. If an underrun error occurred and there is no new data written in TDR, then the TC flag is set at the end of the frame.  Note:   An underrun error may occur if the moment the data is written to the USART_TDR is too close to the first CK transmission edge. To avoid this underrun error, the USART_TDR should be written 3   usart_ker_ck   cycles before the first CK edge.  26.5.15   USART single-wire half-duplex communication  Single-wire half-duplex mode is selected by setting the HDSEL bit in the USART_CR3 register. In this mode, the following bits must be kept cleared:  •   LINEN and CLKEN bits in the USART_CR2 register,  •   SCEN and IREN bits in the USART_CR3 register. The USART can be configured to follow a single-wire half-duplex protocol where the TX and RX lines are internally connected. The selection between half- and Full-duplex communication is made with a control bit HDSEL in USART_CR3. As soon as HDSEL is written to ‘1’:  •   The TX and RX lines are internally connected.  •   The RX pin is no longer used.  •   The TX pin is always released when no data is transmitted. Thus, it acts as a standard I/O in idle or in reception. It means that the I/O must be configured so that TX is configured as alternate function open-drain with an external pull-up. Apart from this, the communication protocol is similar to normal USART mode. Any conflict on the line must be managed by software (for instance by using a centralized arbiter). In particular, the transmission is never blocked by hardware and continues as soon as data are written in the data register while the TE bit is set.  26.5.16   USART receiver timeout  The receiver timeout feature is enabled by setting the RTOEN bit in the USART_CR2 control register. The timeout duration is programmed using the RTO bitfields in the USART_RTOR register. The receiver timeout counter starts counting:  •   from the end of the stop bit if STOP = ‘00’ or STOP = ‘11’  •   from the end of the second stop bit if STOP = ‘10’.  •   from the beginning of the stop bit if STOP = ‘01’. When the timeout duration has elapsed, the RTOF flag in the USART_ISR register is set. A timeout is generated if RTOIE bit in USART_CR1 register is set.

RM0490 Rev 5   777/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  26.5.17   USART smartcard mode  This section is relevant only when smartcard mode is supported. Refer to   Section 26.4: USART implementation on page 744 . Smartcard mode is selected by setting the SCEN bit in the USART_CR3 register. In smartcard mode, the following bits must be kept cleared:  •   LINEN bit in the USART_CR2 register,  •   HDSEL and IREN bits in the USART_CR3 register. The CLKEN bit can also be set to provide a clock to the smartcard. The smartcard interface is designed to support asynchronous smartcard protocol as defined in the ISO 7816-3 standard. Both T   =   0 (character mode) and T   =   1 (block mode) are supported. The USART should be configured as:  •   8 bits plus parity: M   =   1 and PCE   =   1 in the USART_CR1 register  •   1.5 stop bits when transmitting and receiving data: STOP   =   ’11’ in the USART_CR2 register. It is also possible to choose 0.5 stop bit for reception. In T   =   0 (character) mode, the parity error is indicated at the end of each character during the guard time period.  Figure 268   shows examples of what can be seen on the data line with and without parity error.  Figure 268. ISO 7816-3 asynchronous protocol  When connected to a smartcard, the TX output of the USART drives a bidirectional line that is also driven by the smartcard. The TX pin must be configured as open drain. Smartcard mode implements a single wire half duplex communication protocol.  •   Transmission of data from the transmit shift register is guaranteed to be delayed by a minimum of 1/2 baud clock. In normal operation a full transmit shift register starts shifting on the next baud clock edge. In smartcard mode this transmission is further delayed by a guaranteed 1/2 baud clock.  •   In transmission, if the smartcard detects a parity error, it signals this condition to the USART by driving the line low (NACK). This NACK signal (pulling transmit line low for 1 baud clock) causes a framing error on the transmitter side (configured with 1.5 stop bits). The USART can handle automatic re-sending of data according to the protocol.  MSv31162V1  Without Parity error  p 7 6 5 4 3 2 1 0 S Guard time  WithParity error  p 7 6 5 4 3 2 1 0 S Guard time Start bit Start bit   Line pulled low by receiver during stop in case of parity error

Universal synchronous receiver transmitter (USART)   RM0490  778/1027   RM0490 Rev 5  The number of retries is programmed in the SCARCNT bitfield. If the USART continues receiving the NACK after the programmed number of retries, it stops transmitting and signals the error as a framing error. The TXE bit (TXFNF bit in case FIFO mode is enabled) may be set using the TXFRQ bit in the USART_RQR register.  •   Smartcard auto-retry in transmission: A delay of 2.5 baud periods is inserted between the NACK detection by the USART and the start bit of the repeated character. The TC bit is set immediately at the end of reception of the last repeated character (no guardtime). If the software wants to repeat it again, it must insure the minimum 2 baud periods required by the standard.  •   If a parity error is detected during reception of a frame programmed with a 1.5 stop bit period, the transmit line is pulled low for a baud clock period after the completion of the receive frame. This is to indicate to the smartcard that the data transmitted to the USART has not been correctly received. A parity error is NACKed by the receiver if the NACK control bit is set, otherwise a NACK is not transmitted (to be used in T   =   1 mode). If the received character is erroneous, the RXNE (RXFNE in case FIFO mode is enabled)/receive DMA request is not activated. According to the protocol specification, the smartcard must resend the same character. If the received character is still erroneous after the maximum number of retries specified in the SCARCNT bitfield, the USART stops transmitting the NACK and signals the error as a parity error.  •   Smartcard auto-retry in reception: the BUSY flag remains set if the USART NACKs the card but the card doesn’t repeat the character.  •   In transmission, the USART inserts the Guard Time (as programmed in the Guard Time register) between two successive characters. As the Guard Time is measured after the stop bit of the previous character, the GT[7:0] register must be programmed to the desired CGT (Character Guard Time, as defined by the 7816-3 specification) minus 12 (the duration of one character).  •   The assertion of the TC flag can be delayed by programming the Guard Time register. In normal operation, TC is asserted when the transmit shift register is empty and no further transmit requests are outstanding. In smartcard mode an empty transmit shift register triggers the Guard Time counter to count up to the programmed value in the Guard Time register. TC is forced low during this time. When the Guard Time counter reaches the programmed value TC is asserted high. The TCBGT flag can be used to detect the end of data transfer without waiting for guard time completion. This flag is set just after the end of frame transmission and if no NACK has been received from the card.  •   The deassertion of TC flag is unaffected by smartcard mode.  •   If a framing error is detected on the transmitter end (due to a NACK from the receiver), the NACK is not detected as a start bit by the receive block of the transmitter. According to the ISO protocol, the duration of the received NACK can be 1 or 2 baud clock periods.  •   On the receiver side, if a parity error is detected and a NACK is transmitted the receiver does not detect the NACK as a start bit.  Note:   Break characters are not significant in smartcard mode. A 0x00 data with a framing error is treated as data and not as a break. No Idle frame is transmitted when toggling the TE bit. The Idle frame (as defined for the other configurations) is not defined by the ISO protocol. Figure 269   shows how the NACK signal is sampled by the USART. In this example the USART is transmitting data and is configured with 1.5 stop bits. The receiver part of the USART is enabled in order to check the integrity of the data and the NACK signal.

RM0490 Rev 5   779/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Figure 269. Parity error detection using the 1.5 stop bits  The USART can provide a clock to the smartcard through the CK output. In smartcard mode, CK is not associated to the communication but is simply derived from the internal peripheral input clock through a 5-bit prescaler. The division ratio is configured in the USART_GTPR register. CK frequency can be programmed from usart_ker_ck_pres/2 to usart_ker_ck_pres/62, where usart_ker_ck_pres is the peripheral input clock divided by a programmed prescaler.  Block mode (T = 1)  In T   =   1 (block) mode, the parity error transmission can be deactivated by clearing the NACK bit in the USART_CR3 register. When requesting a read from the smartcard, in block mode, the software must program the RTOR register to the BWT (block wait time) - 11 value. If no answer is received from the card before the expiration of this period, a timeout interrupt is generated. If the first character is received before the expiration of the period, it is signaled by the RXNE/RXFNE interrupt.  Note:   The RXNE/RXFNE interrupt must be enabled even when using the USART in DMA mode to read from the smartcard in block mode. In parallel, the DMA must be enabled only after the first received byte.  After the reception of the first character (RXNE/RXFNE interrupt), the RTO register must be programmed to the CWT (character wait time -11 value), in order to enable the automatic check of the maximum wait time between two consecutive characters. This time is expressed in baud time units. If the smartcard does not send a new character in less than the CWT period after the end of the previous character, the USART signals it to the software through the RTOF flag and interrupt (when RTOIE bit is set).  Note:   As in the smartcard protocol definition, the BWT/CWT values should be defined from the beginning (start bit) of the last character. The RTO register must be programmed to BWT - 11 or CWT -11, respectively, taking into account the length of the last character itself.  A block length counter is used to count all the characters received by the USART. This counter is reset when the USART is transmitting. The length of the block is communicated by the smartcard in the third byte of the block (prologue field). This value must be programmed to the BLEN field in the USART_RTOR register. When using DMA mode, before the start of the block, this register field must be programmed to the minimum value  MSv31163V1 Bit 7   Parity bit   1.5 Stop bit 1 bit time   1.5 bit time 0.5 bit time Sampling at 8th, 9th, 10th Sampling at 8th, 9th, 10th Sampling at 8th, 9th, 10th Sampling at 8th, 9th, 10th

Universal synchronous receiver transmitter (USART)   RM0490  780/1027   RM0490 Rev 5  (0x0). With this value, an interrupt is generated after the 4th received character. The software must read the LEN field (third byte), its value must be read from the receive buffer. In interrupt driven receive mode, the length of the block may be checked by software or by programming the BLEN value. However, before the start of the block, the maximum value of BLEN (0xFF) may be programmed. The real value is programmed after the reception of the third character. If the block is using the LRC longitudinal redundancy check (1 epilogue byte), the BLEN   =   LEN. If the block is using the CRC mechanism (2 epilog bytes), BLEN   =   LEN+1 must be programmed. The total block length (including prologue, epilogue and information fields) equals BLEN+4. The end of the block is signaled to the software through the EOBF flag and interrupt (when EOBIE bit is set). In case of an error in the block length, the end of the block is signaled by the RTO interrupt (Character Wait Time overflow).  Note:   The error checking code (LRC/CRC) must be computed/verified by software.  Direct and inverse convention  The smartcard protocol defines two conventions: direct and inverse. The direct convention is defined as: LSB first, logical bit value of 1 corresponds to a H state of the line and parity is even. In order to use this convention, the following control bits must be programmed: MSBFIRST   =   0, DATAINV   =   0 (default values). The inverse convention is defined as: MSB first, logical bit value 1 corresponds to an L state on the signal line and parity is even. In order to use this convention, the following control bits must be programmed: MSBFIRST   =   1, DATAINV   =   1.  Note:   When logical data values are inverted (0 = H, 1 = L), the parity bit is also inverted in the same way.  In order to recognize the card convention, the card sends the initial character, TS, as the first character of the ATR (Answer To Reset) frame. The two possible patterns for the TS are: LHHL LLL LLH and LHHL HHH LLH.  •   (H) LHHL LLL LLH sets up the inverse convention: state L encodes value 1 and moment 2 conveys the most significant bit (MSB first). When decoded by inverse convention, the conveyed byte is equal to '3F'.  •   (H) LHHL HHH LLH sets up the direct convention: state H encodes value 1 and moment 2 conveys the least significant bit (LSB first). When decoded by direct convention, the conveyed byte is equal to '3B'. Character parity is correct when there is an even number of bits set to 1 in the nine moments 2 to 10. As the USART does not know which convention is used by the card, it needs to be able to recognize either pattern and act accordingly. The pattern recognition is not done in hardware, but through a software sequence. Moreover, assuming that the USART is configured in direct convention (default) and the card answers with the inverse convention, TS = LHHL LLL LLH results in a USART received character of 03 and an odd parity.

RM0490 Rev 5   781/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Therefore, two methods are available for TS pattern recognition:  Method 1  The USART is programmed in standard smartcard mode/direct convention. In this case, the TS pattern reception generates a parity error interrupt and error signal to the card.  •   The parity error interrupt informs the software that the card did not answer correctly in direct convention. Software then reprograms the USART for inverse convention  •   In response to the error signal, the card retries the same TS character, and it is correctly received this time, by the reprogrammed USART. Alternatively, in answer to the parity error interrupt, the software may decide to reprogram the USART and to also generate a new reset command to the card, then wait again for the TS.  Method 2  The USART is programmed in 9-bit/no-parity mode, no bit inversion. In this mode it receives any of the two TS patterns as: (H) LHHL LLL LLH = 0x103: inverse convention to be chosen (H) LHHL HHH LLH = 0x13B: direct convention to be chosen The software checks the received character against these two patterns and, if any of them match, then programs the USART accordingly for the next character reception. If none of the two is recognized, a card reset may be generated in order to restart the negotiation.  26.5.18   USART IrDA SIR ENDEC block  This section is relevant only when IrDA mode is supported. Refer to   Section 26.4: USART implementation on page 744 . IrDA mode is selected by setting the IREN bit in the USART_CR3 register. In IrDA mode, the following bits must be kept cleared:  •   LINEN, STOP and CLKEN bits in the USART_CR2 register,  •   SCEN and HDSEL bits in the USART_CR3 register. The IrDA SIR physical layer specifies use of a Return to Zero, Inverted (RZI) modulation scheme that represents logic 0 as an infrared light pulse (see   Figure 270 ). The SIR Transmit encoder modulates the Non Return to Zero (NRZ) transmit bit stream output from USART. The output pulse stream is transmitted to an external output driver and infrared LED. USART supports only bit rates up to 115.2 kbaud for the SIR ENDEC. In normal mode the transmitted pulse width is specified as 3/16 of a bit period. The SIR receive decoder demodulates the return-to-zero bit stream from the infrared detector and outputs the received NRZ serial bit stream to the USART. The decoder input is normally high (marking state) in the Idle state. The transmit encoder output has the opposite polarity to the decoder input. A start bit is detected when the decoder input is low.  •   IrDA is a half duplex communication protocol. If the Transmitter is busy (when the USART is sending data to the IrDA encoder), any data on the IrDA receive line is ignored by the IrDA decoder and if the Receiver is busy (when the USART is receiving decoded data from the USART), data on the TX from the USART to IrDA is not

Universal synchronous receiver transmitter (USART)   RM0490  782/1027   RM0490 Rev 5  encoded. While receiving data, transmission should be avoided as the data to be transmitted could be corrupted.  •   A ‘0‘ is transmitted as a high pulse and a ‘1’ is transmitted as a ‘0’. The width of the pulse is specified as 3/16th of the selected bit period in normal mode (see   Figure 271 ).  •   The SIR decoder converts the IrDA compliant receive signal into a bit stream for USART.  •   The SIR receive logic interprets a high state as a logic one and low pulses as logic zeros.  •   The transmit encoder output has the opposite polarity to the decoder input. The SIR output is in low state when Idle.  •   The IrDA specification requires the acceptance of pulses greater than 1.41 μs. The acceptable pulse width is programmable. Glitch detection logic on the receiver end filters out pulses of width less than 2 PSC periods (PSC is the prescaler value programmed in the USART_GTPR). Pulses of width less than 1 PSC period are always rejected, but those of width greater than one and less than two periods may be accepted or rejected, those greater than two periods are accepted as a pulse. The IrDA encoder/decoder doesn’t work when PSC   =   0.  •   The receiver can communicate with a low-power transmitter.  •   In IrDA mode, the stop bits in the USART_CR2 register must be configured to ‘1 stop bit’.  IrDA low-power mode  •   Transmitter In low-power mode, the pulse width is not maintained at 3/16 of the bit period. Instead, the width of the pulse is 3 times the low-power baud rate which can be a minimum of 1.42 MHz. Generally, this value is 1.8432 MHz (1.42 MHz < PSC < 2.12 MHz). A low- power mode programmable divisor divides the system clock to achieve this value.  •   Receiver Receiving in low-power mode is similar to receiving in normal mode. For glitch detection the USART should discard pulses of duration shorter than 1/PSC. A valid low is accepted only if its duration is greater than 2 periods of the IrDA low-power Baud clock (PSC value in the USART_GTPR).  Note:   A pulse of width less than two and greater than one PSC period(s) may or may not be rejected. The receiver set up time should be managed by software. The IrDA physical layer specification specifies a minimum of 10 ms delay between transmission and reception (IrDA is a half duplex protocol).

RM0490 Rev 5   783/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Figure 270. IrDA SIR ENDEC block diagram Figure 271. IrDA data modulation (3/16) - normal mode  MSv31164V1 USART OR SIR Transmit Encoder SIR Receive DEcoder TX SIREN RX USART_RX IrDA_IN IrDA_OUT USART_TX  MSv31165V1 TX Start bit  0   1   0   1   0   0   1   1   0   1  Stop bit Bit period IrDA_OUT IrDA_IN RX 3/16  0   1   0   1   0   0   1   1   0   1

Universal synchronous receiver transmitter (USART)   RM0490  784/1027   RM0490 Rev 5  26.5.19   Continuous communication using USART and DMA  The USART is capable of performing continuous communications using the DMA. The DMA requests for Rx buffer and Tx buffer are generated independently.  Note:   Refer to Section 26.4: USART implementation on page 744 to determine if the DMA mode is supported. If DMA is not supported, use the USART as explained in Section 26.5.6. To perform continuous communications when the FIFO is disabled, clear the TXE/ RXNE flags in the USART_ISR register.  Transmission using DMA  DMA mode can be enabled for transmission by setting DMAT bit in the USART_CR3 register. Data are loaded from an SRAM area configured using the DMA peripheral (refer to the corresponding   Direct memory access controller   section) to the USART_TDR register whenever the TXE flag (TXFNF flag if FIFO mode is enabled) is set. To map a DMA channel for USART transmission, use the following procedure (x denotes the channel number): 1.   Write the USART_TDR register address in the DMA control register to configure it as the destination of the transfer. The data is moved to this address from memory after each TXE (or TXFNF if FIFO mode is enabled) event. 2.   Write the memory address in the DMA control register to configure it as the source of the transfer. The data is loaded into the USART_TDR register from this memory area after each TXE (or TXFNF if FIFO mode is enabled) event. 3.   Configure the total number of bytes to be transferred to the DMA control register. 4.   Configure the channel priority in the DMA   register 5.   Configure DMA interrupt generation after half/ full transfer as required by the application. 6.   Clear the TC flag in the USART_ISR register by setting the TCCF bit in the USART_ICR register. 7.   Activate the channel in the DMA register. When the number of data transfers programmed in the DMA Controller is reached, the DMA controller generates an interrupt on the DMA channel interrupt vector. In transmission mode, once the DMA has written all the data to be transmitted (the TCIF flag is set in the DMA_ISR register), the TC flag can be monitored to make sure that the USART communication is complete. This is required to avoid corrupting the last transmission before disabling the USART or before the system enters a low-power mode when the peripheral clock is disabled. Software must wait until TC   =   1. The TC flag remains cleared during all data transfers and it is set by hardware at the end of transmission of the last frame.

RM0490 Rev 5   785/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Figure 272. Transmission using DMA  Note:   When FIFO management is enabled, the DMA request is triggered by Transmit FIFO not full (i.e. TXFNF = 1).  Reception using DMA  DMA mode can be enabled for reception by setting the DMAR bit in USART_CR3 register. Data are loaded from the USART_RDR register to an SRAM area configured using the DMA peripheral (refer to the corresponding   Direct memory access controller   section) whenever a data byte is received. To map a DMA channel for USART reception, use the following procedure: 1.   Write the USART_RDR register address in the DMA control register to configure it as the source of the transfer. The data is moved from this address to the memory after each RXNE (RXFNE in case FIFO mode is enabled) event. 2.   Write the memory address in the DMA control register to configure it as the destination of the transfer. The data is loaded from USART_RDR to this memory area after each RXNE (RXFNE in case FIFO mode is enabled) event. 3.   Configure the total number of bytes to be transferred to the DMA control register. 4.   Configure the channel priority in the DMA control register 5.   Configure interrupt generation after half/ full transfer as required by the application. 6.   Activate the channel in the DMA control register. When the number of data transfers programmed in the DMA Controller is reached, the DMA controller generates an interrupt on the DMA channel interrupt vector.  ai17192d F2   F3 F1 The software configures DMA to send 3 data blocks and enables USART The DMA transfer is complete The DMA writes F2 into USART_TDR The DMA writes F3 into USART_TDR The DMA writes F1 into USART_TDR   The software waits until TC = 1 Set by hardware Cleared by software Set by hardware TX line TXE flag USART_TDR DMA request DMA writes to USART_TDR DMA transfer complete flag TC flag Frame 1   Frame 2   Frame 3 Idle preamble Set by hardware Cleared by DMA write Set by hardware Cleared by DMA write   Set by hardware Ignored by the DMA because the transfer is complete

Universal synchronous receiver transmitter (USART)   RM0490  786/1027   RM0490 Rev 5  Figure 273. Reception using DMA  Note:   When FIFO management is enabled, the DMA request is triggered by Receive FIFO not empty (i.e. RXFNE = 1).  Error flagging and interrupt generation in multibuffer communication  If any error occurs during a transaction in multibuffer communication mode, the error flag is asserted after the current byte. An interrupt is generated if the interrupt enable flag is set. For framing error, overrun error and noise flag which are asserted with RXNE (RXFNE in case FIFO mode is enabled) in single byte reception, there is a separate error flag interrupt enable bit (EIE bit in the USART_CR3 register), which, if set, enables an interrupt after the current byte if any of these errors occur.  26.5.20   RS232 hardware flow control and RS485 Driver Enable  It is possible to control the serial data flow between 2 devices by using the CTS input and the RTS output. The   Figure 274   shows how to connect 2 devices in this mode:  Figure 274. Hardware flow control between 2 USARTs  ai17193e RX line Frame 1 F2   F3 Set by hardware Cleared by DMA read F1 Frame 2   Frame 3 RXNE flag USART_RDR DMA request DMA reads USART_RDR DMA transfer complete flag   Set by hardware Cleared by software The software configures the DMA to receive 3 data blocks and enables the USART The DMA reads F3 from USART_RDR The DMA reads F2 from USART_RDR The DMA reads F1 from USART_RDR The DMA transfer is complete  MSv31169V2 TX circuit USART 1 TX RX circuit RX circuit USART 2 TX circuit TX CTS CTS RTS RX RTS RX

RM0490 Rev 5   787/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  RS232 RTS and CTS flow control can be enabled independently by writing the RTSE and CTSE bits to ‘1’ in the USART_CR3 register.  RS232 RTS flow control  If the RTS flow control is enabled (RTSE   =   1), then RTS is deasserted (tied low) as long as the USART receiver is ready to receive a new data. When the receive register is full, RTS is asserted, indicating that the transmission is expected to stop at the end of the current frame.  Figure 275   shows an example of communication with RTS flow control enabled.  Figure 275. RS232 RTS flow control  Note:   When FIFO mode is enabled, RTS is asserted only when RXFIFO is full.  RS232 CTS flow control  If the CTS flow control is enabled (CTSE   =   1), then the transmitter checks the CTS input before transmitting the next frame. If CTS is deasserted (tied low), then the next data is transmitted (assuming that data is to be transmitted, in other words, if TXE/TXFE   =   0), else the transmission does not occur. When CTS is asserted during a transmission, the current transmission is completed before the transmitter stops. When CTSE   =   1, the CTSIF status bit is automatically set by hardware as soon as the CTS input toggles. It indicates when the receiver becomes ready or not ready for communication. An interrupt is generated if the CTSIE bit in the USART_CR3 register is set.   Figure 276  shows an example of communication with CTS flow control enabled.  MSv68794V1 Start bit Start bit Stop bit   Idle   Stop bit RX RTS Data 1 read Data 2 can now be transmitted RXNE   RXNE Data 1   Data 2

Universal synchronous receiver transmitter (USART)   RM0490  788/1027   RM0490 Rev 5  Figure 276. RS232 CTS flow control  Note:   For correct behavior, CTS must be deasserted at least 3 USART clock source periods before the end of the current character. In addition it should be noted that the CTSCF flag may not be set for pulses shorter than 2 x PCLK periods.  RS485 driver enable  The driver enable feature is enabled by setting bit DEM in the USART_CR3 control register. This enables the user to activate the external transceiver control, through the DE (Driver Enable) signal. The assertion time is the time between the activation of the DE signal and the beginning of the start bit. It is programmed using the DEAT [4:0] bitfields in the USART_CR1 control register. The deassertion time is the time between the end of the last stop bit, in a transmitted message, and the de-activation of the DE signal. It is programmed using the DEDT [4:0] bitfields in the USART_CR1 control register. The polarity of the DE signal can be configured using the DEP bit in the USART_CR3 control register. In USART, the DEAT and DEDT are expressed in sample time units (1/8 or 1/16 bit time, depending on the oversampling rate).  MSv68793V1 Start bit Stop bit TX TDR CTS Data 1 Data 2 Stop bit   Idle  Start bit Data 2   Data 3 Data 3 empty   empty CTS CTS Transmit data register Writing data 3 in TDR   Transmission of Data 3 is delayed until CTS = 0

RM0490 Rev 5   789/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  26.5.21   USART low-power management  The USART has advanced low-power mode functions, that enables transferring properly data even when the usart_pclk clock is disabled. The USART is able to wake up the MCU from low-power mode when the UESM bit is set. When the usart_pclk is gated, the USART provides a wake-up interrupt ( usart_wkup ) if a specific action requiring the activation of the   usart_pclk   clock is needed:  •   If FIFO mode is disabled usart_pclk clock has to be activated to empty the USART data register. In this case, the usart_wkup interrupt source is RXNE set to ‘1’. The RXNEIE bit must be set before entering low-power mode.  •   If FIFO mode is enabled usart_pclk clock has to be activated to: –   to fill the TXFIFO –   or to empty the RXFIFO In this case, the usart_wkup interrupt source can be: –   RXFIFO not empty. In this case, the RXFNEIE bit must be set before entering low- power mode. –   RXFIFO full. In this case, the RXFFIE bit must be set before entering low-power mode, the number of received data corresponds to the RXFIFO size, and the RXFF flag is not set. –   TXFIFO empty. In this case, the TXFEIE bit must be set before entering low-power mode. This enables sending/receiving the data in the TXFIFO/RXFIFO during low-power mode. To avoid overrun/underrun errors and transmit/receive data in low-power mode, the usart_wkup interrupt source can be one of the following events: –   TXFIFO threshold reached. In this case, the TXFTIE bit must be set before entering low-power mode. –   RXFIFO threshold reached. In this case, the RXFTIE bit must be set before entering low-power mode. For example, the application can set the threshold to the maximum RXFIFO size if the wake-up time is less than the time required to receive a single byte across the line. Using the RXFIFO full, TXFIFO empty, RXFIFO not empty and RXFIFO/TXFIFO threshold interrupts to wake up the MCU from low-power mode enables doing as many USART transfers as possible during low-power mode with the benefit of optimizing consumption. Alternatively, a specific   usart_wkup   interrupt can be selected through the WUS bitfields. When the wake-up event is detected, the WUF flag is set by hardware and a   usart_wkup  interrupt is generated if the WUFIE bit is set.

Universal synchronous receiver transmitter (USART)   RM0490  790/1027   RM0490 Rev 5  Note:   Before entering low-power mode, make sure that no USART transfers are ongoing. Checking the BUSY flag cannot ensure that low-power mode is never entered when data reception is ongoing. The WUF flag is set when a wake-up event is detected, independently of whether the MCU is in low-power or active mode. When entering low-power mode just after having initialized and enabled the receiver, the REACK bit must be checked to make sure the USART is enabled. When DMA is used for reception, it must be disabled before entering low-power mode and re-enabled when exiting from low-power mode. When the FIFO is enabled, waking up from low-power mode on address match is only possible when mute mode is enabled.  Using mute mode with low-power mode  If the USART is put into mute mode before entering low-power mode:  •   Wake-up from mute mode on idle detection must not be used, because idle detection cannot work in low-power mode.  •   If the wake-up from mute mode on address match is used, then the low-power mode wake-up source must also be the address match. If the RXNE flag was set when entering the low-power mode, the interface remains in mute mode upon address match and wake up from low-power mode.  Note:   When FIFO management is enabled, mute mode can be used with wake-up from low-power mode without any constraints (i.e.the two points mentioned above about mute and low- power mode are valid only when FIFO management is disabled).  Wake-up from low-power mode when USART kernel clock (usart_ker_ck) is OFF in low-power mode  If during low-power mode, the usart_ker_ck clock is switched OFF when a falling edge on the USART receive line is detected, the USART interface requests the usart_ker_ck clock to be switched ON thanks to the usart_ker_ck_req signal. usart_ker_ck is then used for the frame reception. If the wake-up event is verified, the MCU wakes up from low-power mode and data reception goes on normally. If the wake-up event is not verified, usart_ker_ck is switched OFF again, the MCU is not woken up and remains in low-power mode, and the kernel clock request is released. The example below shows the case of a wake-up event programmed to “address match detection” and FIFO management disabled.

RM0490 Rev 5   791/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Figure 277   shows the USART behavior when the wake-up event is verified.  Figure 277. Wake-up event verified (wake-up event = address match, FIFO disabled)  Figure 278   shows the USART behavior when the wake-up event is not verified.  Figure 278. Wake-up event not verified (wake-up event = address match, FIFO disabled)  Note:   The figures above are valid when address match or any received frame is used as wake-up event. If the wake-up event is the start bit detection, the USART sends the wake-up event to the MCU at the end of the start bit.  MSv40856V2 usart_ker_ck RX line Idle Start bit Rx data 1   Rx data 2 Start bit Stop bit Stop bit OFF   ON Low-power mode Startup time Run mode Address match event WUF =’1' USART sends a wakeup event to the MCU Data reception goes on  MSv40857V2 usart_ker_ck RX line Idle Start bit Rx data 1 Stop bit OFF   ON Low-power mode Address does not match Idle OFF Startup time

Universal synchronous receiver transmitter (USART)   RM0490  792/1027   RM0490 Rev 5  Determining the maximum USART baud rate that enables to correctly wake up the device from low-power mode  The maximum baud rate that enables to correctly wake up the device from low-power mode depends on the wake-up time parameter (refer to the device datasheet) and on the USART receiver tolerance (see   Section 26.5.8: Tolerance of the USART receiver to clock deviation ). Let us take the example of OVER8 = 0, M bits = ‘01’, ONEBIT = 0 and BRR [3:0] = 0000. In these conditions, according to   Table 128: Tolerance of the USART receiver when BRR [3:0] = 0000 , the USART receiver tolerance equals 3.41%. DTRA + DQUANT + DREC + DTCL + DWU < USART receiver tolerance D   WUmax   = t WUUSART / (11 x T   bit Min ) T bit Min   = t WUUSART   / (11 x D   WUmax   ) where t WUUSART   is the wake-up time from low-power mode. If we consider the ideal case where DTRA, DQUANT, DREC and DTCL parameters are at 0%, the maximum value of DWU is 3.41%. In reality, we need to consider at least the usart_ker_ck inaccuracy. For example, if HSI48 is used as usart_ker_ck, and the HSI48 inaccuracy is of 1%, then we obtain: t WUUSART   = 3 μs (values provided only as examples; for correct values, refer to the device datasheet). D   WUmax   = 3.41% - 1% = 2.41% T bit min   = 3 μs/ (11 x 2.41%) = 11.32 μs. As a result, the maximum baud rate that enables to wake up correctly from low-power mode is: 1/11.32 μs = 88.36 Kbaud.  26.6   USART in low-power modes  Table 131. Effect of low-power modes on the USART Mode   Description  Sleep   No effect. USART interrupts cause the device to exit Sleep mode. Stop (1) 1.   Refer to   Section 26.4: USART implementation   to know if the wake-up from Stop mode is supported for a given peripheral instance. If an instance is not functional in a given Stop mode, it must be disabled before entering this Stop mode. The content of the USART registers is kept. The USART is able to wake up the microcontroller from Stop mode when the USART is clocked by an oscillator available in Stop mode. Standby   The USART peripheral is powered down and must be reinitialized after exiting Standby mode.

RM0490 Rev 5   793/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  26.7   USART interrupts  Refer to   Table 132   for a detailed description of all USART interrupt requests.  Table 132. USART interrupt requests Interrupt vector   Interrupt event   Event flag Enable Control bit Interrupt clear method Exit from Sleep mode Exit from Stop   (1) modes Exit from Standby mode  USART or UART Transmit data register empty   TXE   TXEIE   Write TDR Yes No No Transmit FIFO not Full   TXFNF   TXFNFIE   TXFIFO full   No Transmit FIFO Empty   TXFE   TXFEIE   Write TDR or write 1 in TXFRQ   Yes Transmit FIFO threshold reached   TXFT   TXFTIE   Write TDR   Yes CTS interrupt   CTSIF   CTSIE   Write 1 in CTSCF   No Transmission Complete   TC   TCIE   Write TDR or write 1 in TCCF   No Transmission Complete Before Guard Time   TCBGT   TCBGTIE   Write TDR or write 1 in TCBGT   No USART or UART Receive data register not empty (data ready to be read)   RXNE   RXNEIE   Read RDR or write 1 in RXFRQ Yes Yes No Receive FIFO Not Empty   RXFNE   RXFNEIE Read RDR until RXFIFO empty or write 1 in RXFRQ Yes Receive FIFO Full   RXFF   (2)   RXFFIE   Read RDR   Yes Receive FIFO threshold reached   RXFT   RXFTIE   Read RDR   Yes Overrun error detected   ORE   RXNEIE/ RXFNEIE   Write 1 in ORECF   No Idle line detected   IDLE   IDLEIE   Write 1 in IDLECF   No Parity error   PE   PEIE   Write 1 in PECF   No LIN break   LBDF   LBDIE   Write 1 in LBDCF   No Noise error in multibuffer communication   NE EIE Write 1 in NFCF   No Overrun error in multibuffer communication   ORE   (3)   Write 1 in ORECF   No Framing Error in multibuffer communication   FE   Write 1 in FECF   No Character match   CMF   CMIE   Write 1 in CMCF   No Receiver timeout   RTOF   RTOFIE   Write 1 in RTOCCF   No End of Block   EOBF   EOBIE   Write 1 in EOBCF   No Wake-up from low-power mode   WUF   WUFIE   Write 1 in WUC   Yes SPI slave underrun error   UDR   EIE   Write 1 in UDRCF   No 1.   The USART can wake up the device from Stop mode only if the peripheral instance supports the wake-up from Stop mode feature. Refer to   Section 26.4: USART implementation   for the list of supported Stop modes.

Universal synchronous receiver transmitter (USART)   RM0490  794/1027   RM0490 Rev 5  26.8   USART registers  Refer to   Section 1.2 on page 41   for a list of abbreviations used in register descriptions. The peripheral registers have to be accessed by words (32 bits).  26.8.1   USART control register 1 (USART_CR1)  Address offset: 0x00 Reset value: 0x0000 0000 The same register can be used in FIFO mode enabled (this section) and FIFO mode disabled (next section).  FIFO mode enabled  2.   RXFF flag is asserted if the USART receives n+1 data (n being the RXFIFO size): n data in the RXFIFO and 1 data in USART_RDR. In Stop mode, USART_RDR is not clocked. As a result, this register is not written and once n data are received and written in the RXFIFO, the RXFF interrupt is asserted (RXFF flag is not set). 3.   When OVRDIS = 0. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 RXF FIE   TXFEIE   FIFO EN   M1   EOBIE   RTOIE   DEAT[4:0]   DEDT[4:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 OVER8   CMIE   MME   M0   WAKE   PCE   PS   PEIE   TXFNFI E   TCIE   RXFNE IE   IDLEIE   TE   RE   UESM   UE rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 31   RXFFIE : RXFIFO full interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated when RXFF = 1 in the USART_ISR register Bit 30   TXFEIE : TXFIFO empty interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated when TXFE = 1 in the USART_ISR register Bit 29   FIFOEN : FIFO mode enable This bit is set and cleared by software. 0: FIFO mode is disabled. 1: FIFO mode is enabled. This bitfield can only be written when the USART is disabled (UE = 0).  Note:   FIFO mode can be used on standard UART communication, in SPI master/slave mode and in smartcard modes only. It must not be enabled in IrDA and LIN modes.

RM0490 Rev 5   795/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Bit 28   M1 : Word length This bit must be used in conjunction with bit 12 (M0) to determine the word length. It is set or cleared by software. M[1:0] = ‘00’: 1 start bit, 8 Data bits, n Stop bit M[1:0] = ‘01’: 1 start bit, 9 Data bits, n Stop bit M[1:0] = ‘10’: 1 start bit, 7 Data bits, n Stop bit This bit can only be written when the USART is disabled (UE = 0).  Note:   In 7-bits data length mode, the smartcard mode, LIN master mode and auto baud rate (0x7F and 0x55 frames detection) are not supported.  Bit 27   EOBIE : End-of-block interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated when the EOBF flag is set in the USART_ISR register  Note:   If the USART does not support smartcard mode, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 26   RTOIE : Receiver timeout interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated when the RTOF bit is set in the USART_ISR register.  Note:   If the USART does not support the Receiver timeout feature, this bit is reserved and must be kept at reset value. Section 26.4: USART implementation on page 744.  Bits 25:21   DEAT[4:0] : Driver enable assertion time This 5-bit value defines the time between the activation of the DE (Driver Enable) signal and the beginning of the start bit. It is expressed in sample time units (1/8 or 1/16 bit time, depending on the oversampling rate). This bitfield can only be written when the USART is disabled (UE = 0).  Note:   If the Driver Enable feature is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bits 20:16   DEDT[4:0] : Driver enable deassertion time This 5-bit value defines the time between the end of the last stop bit, in a transmitted message, and the de-activation of the DE (Driver Enable) signal. It is expressed in sample time units (1/8 or 1/16 bit time, depending on the oversampling rate). If the USART_TDR register is written during the DEDT time, the new data is transmitted only when the DEDT and DEAT times have both elapsed. This bitfield can only be written when the USART is disabled (UE = 0).  Note:   If the Driver Enable feature is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 15   OVER8 : Oversampling mode 0: Oversampling by 16 1: Oversampling by 8 This bit can only be written when the USART is disabled (UE = 0).  Note:   In LIN, IrDA and smartcard modes, this bit must be kept cleared.  Bit 14   CMIE : Character match interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated when the CMF bit is set in the USART_ISR register.

Universal synchronous receiver transmitter (USART)   RM0490  796/1027   RM0490 Rev 5  Bit 13   MME : Mute mode enable This bit enables the USART mute mode function. When set, the USART can switch between active and mute mode, as defined by the WAKE bit. It is set and cleared by software. 0: Receiver in active mode permanently 1: Receiver can switch between mute mode and active mode. Bit 12   M0 : Word length This bit is used in conjunction with bit 28 (M1) to determine the word length. It is set or cleared by software (refer to bit 28 (M1)description). This bit can only be written when the USART is disabled (UE = 0). Bit 11   WAKE : Receiver wake-up method This bit determines the USART wake-up method from mute mode. It is set or cleared by software. 0: Idle line 1: Address mark This bitfield can only be written when the USART is disabled (UE = 0). Bit 10   PCE : Parity control enable This bit selects the hardware parity control (generation and detection). When the parity control is enabled, the computed parity is inserted at the MSB position (9th bit if M = 1; 8th bit if M = 0) and the parity is checked on the received data. This bit is set and cleared by software. Once it is set, PCE is active after the current byte (in reception and in transmission). 0: Parity control disabled 1: Parity control enabled This bitfield can only be written when the USART is disabled (UE = 0). Bit 9   PS : Parity selection This bit selects the odd or even parity when the parity generation/detection is enabled (PCE bit set). It is set and cleared by software. The parity is selected after the current byte. 0: Even parity 1: Odd parity This bitfield can only be written when the USART is disabled (UE = 0). Bit 8   PEIE : PE interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated whenever PE = 1 in the USART_ISR register Bit 7   TXFNFIE : TXFIFO not-full interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated whenever TXFNF =1 in the USART_ISR register Bit 6   TCIE : Transmission complete interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated whenever TC = 1 in the USART_ISR register Bit 5   RXFNEIE : RXFIFO not empty interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated whenever ORE = 1 or RXFNE = 1 in the USART_ISR register

RM0490 Rev 5   797/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  26.8.2   USART control register 1 [alternate] (USART_CR1)  Address offset: 0x00 Reset value: 0x0000 0000 The same register can be used in FIFO mode enabled (previous section) and FIFO mode disabled (this section). Bit 4   IDLEIE : IDLE interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated whenever IDLE = 1 in the USART_ISR register Bit 3   TE : Transmitter enable This bit enables the transmitter. It is set and cleared by software. 0: Transmitter is disabled 1: Transmitter is enabled  Note:   During transmission, a low pulse on the TE bit (‘0’ followed by ‘1’) sends a preamble (idle line) after the current word, except in smartcard mode. In order to generate an idle character, the TE must not be immediately written to ‘1’. To ensure the required duration, the software can poll the TEACK bit in the USART_ISR register. In smartcard mode, when TE is set, there is a 1 bit-time delay before the transmission starts.  Bit 2   RE : Receiver enable This bit enables the receiver. It is set and cleared by software. 0: Receiver is disabled 1: Receiver is enabled and begins searching for a start bit Bit 1   UESM : USART enable in low-power mode When this bit is cleared, the USART cannot wake up the MCU from low-power mode. When this bit is set, the USART can wake up the MCU from low-power mode. This bit is set and cleared by software. 0: USART not able to wake up the MCU from low-power mode. 1: USART able to wake up the MCU from low-power mode.  Note:   It is recommended to set the UESM bit just before entering low-power mode and clear it when exit from low-power mode. If the USART does not support the wake-up from Stop feature, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 0   UE : USART enable When this bit is cleared, the USART prescalers and outputs are stopped immediately, and all current operations are discarded. The USART configuration is kept, but all the USART_ISR status flags are reset. This bit is set and cleared by software. 0: USART prescaler and outputs disabled, low-power mode 1: USART enabled  Note:   To enter low-power mode without generating errors on the line, the TE bit must be previously reset and the software must wait for the TC bit in the USART_ISR to be set before resetting the UE bit. The DMA requests are also reset when UE = 0 so the DMA channel must be disabled before resetting the UE bit. In smartcard mode, (SCEN = 1), the CK is always available when CLKEN = 1, regardless of the UE bit value.

Universal synchronous receiver transmitter (USART)   RM0490  798/1027   RM0490 Rev 5  FIFO mode disabled  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   FIFO EN   M1   EOBIE   RTOIE   DEAT[4:0]   DEDT[4:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 OVER8   CMIE   MME   M0   WAKE   PCE   PS   PEIE   TXEIE   TCIE   RXNEI E   IDLEIE   TE   RE   UESM   UE rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:30   Reserved, must be kept at reset value. Bit 29   FIFOEN : FIFO mode enable This bit is set and cleared by software. 0: FIFO mode is disabled. 1: FIFO mode is enabled. This bitfield can only be written when the USART is disabled (UE = 0).  Note:   FIFO mode can be used on standard UART communication, in SPI master/slave mode and in smartcard modes only. It must not be enabled in IrDA and LIN modes.  Bit 28   M1 : Word length This bit must be used in conjunction with bit 12 (M0) to determine the word length. It is set or cleared by software. M[1:0] = ‘00’: 1 start bit, 8 Data bits, n Stop bit M[1:0] = ‘01’: 1 start bit, 9 Data bits, n Stop bit M[1:0] = ‘10’: 1 start bit, 7 Data bits, n Stop bit This bit can only be written when the USART is disabled (UE = 0).  Note:   In 7-bits data length mode, the smartcard mode, LIN master mode and auto baud rate (0x7F and 0x55 frames detection) are not supported.  Bit 27   EOBIE : End of Bbock interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated when the EOBF flag is set in the USART_ISR register  Note:   If the USART does not support smartcard mode, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 26   RTOIE : Receiver timeout interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated when the RTOF bit is set in the USART_ISR register.  Note:   If the USART does not support the Receiver timeout feature, this bit is reserved and must be kept at reset value. Section 26.4: USART implementation on page 744.  Bits 25:21   DEAT[4:0] : Driver enable assertion time This 5-bit value defines the time between the activation of the DE (Driver Enable) signal and the beginning of the start bit. It is expressed in sample time units (1/8 or 1/16 bit time, depending on the oversampling rate). This bitfield can only be written when the USART is disabled (UE = 0).  Note:   If the Driver Enable feature is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.

RM0490 Rev 5   799/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Bits 20:16   DEDT[4:0] : Driver enable deassertion time This 5-bit value defines the time between the end of the last stop bit, in a transmitted message, and the de-activation of the DE (Driver Enable) signal. It is expressed in sample time units (1/8 or 1/16 bit time, depending on the oversampling rate). If the USART_TDR register is written during the DEDT time, the new data is transmitted only when the DEDT and DEAT times have both elapsed. This bitfield can only be written when the USART is disabled (UE = 0).  Note:   If the Driver Enable feature is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 15   OVER8 : Oversampling mode 0: Oversampling by 16 1: Oversampling by 8 This bit can only be written when the USART is disabled (UE = 0).  Note:   In LIN, IrDA and smartcard modes, this bit must be kept cleared.  Bit 14   CMIE : Character match interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated when the CMF bit is set in the USART_ISR register. Bit 13   MME : Mute mode enable This bit enables the USART mute mode function. When set, the USART can switch between active and mute mode, as defined by the WAKE bit. It is set and cleared by software. 0: Receiver in active mode permanently 1: Receiver can switch between mute mode and active mode. Bit 12   M0 : Word length This bit is used in conjunction with bit 28 (M1) to determine the word length. It is set or cleared by software (refer to bit 28 (M1)description). This bit can only be written when the USART is disabled (UE = 0). Bit 11   WAKE : Receiver wake-up method This bit determines the USART wake-up method from mute mode. It is set or cleared by software. 0: Idle line 1: Address mark This bitfield can only be written when the USART is disabled (UE = 0). Bit 10   PCE : Parity control enable This bit selects the hardware parity control (generation and detection). When the parity control is enabled, the computed parity is inserted at the MSB position (9th bit if M = 1; 8th bit if M = 0) and the parity is checked on the received data. This bit is set and cleared by software. Once it is set, PCE is active after the current byte (in reception and in transmission). 0: Parity control disabled 1: Parity control enabled This bitfield can only be written when the USART is disabled (UE = 0). Bit 9   PS : Parity selection This bit selects the odd or even parity when the parity generation/detection is enabled (PCE bit set). It is set and cleared by software. The parity is selected after the current byte. 0: Even parity 1: Odd parity This bitfield can only be written when the USART is disabled (UE = 0).

Universal synchronous receiver transmitter (USART)   RM0490  800/1027   RM0490 Rev 5  Bit 8   PEIE : PE interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated whenever PE = 1 in the USART_ISR register Bit 7   TXEIE : Transmit data register empty This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated whenever TXE =1 in the USART_ISR register Bit 6   TCIE : Transmission complete interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated whenever TC = 1 in the USART_ISR register Bit 5   RXNEIE : Receive data register not empty This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated whenever ORE = 1 or RXNE = 1 in the USART_ISR register Bit 4   IDLEIE : IDLE interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated whenever IDLE = 1 in the USART_ISR register Bit 3   TE : Transmitter enable This bit enables the transmitter. It is set and cleared by software. 0: Transmitter is disabled 1: Transmitter is enabled  Note:   During transmission, a low pulse on the TE bit (‘0’ followed by ‘1’) sends a preamble (idle line) after the current word, except in smartcard mode. In order to generate an idle character, the TE must not be immediately written to ‘1’. To ensure the required duration, the software can poll the TEACK bit in the USART_ISR register. In smartcard mode, when TE is set, there is a 1 bit-time delay before the transmission starts.  Bit 2   RE : Receiver enable This bit enables the receiver. It is set and cleared by software. 0: Receiver is disabled 1: Receiver is enabled and begins searching for a start bit Bit 1   UESM : USART enable in low-power mode When this bit is cleared, the USART cannot wake up the MCU from low-power mode. When this bit is set, the USART can wake up the MCU from low-power mode. This bit is set and cleared by software. 0: USART not able to wake up the MCU from low-power mode. 1: USART able to wake up the MCU from low-power mode.  Note:   It is recommended to set the UESM bit just before entering low-power mode and clear it when exit from low-power mode. If the USART does not support the wake-up from Stop feature, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.

RM0490 Rev 5   801/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  26.8.3   USART control register 2 (USART_CR2)  Address offset: 0x04 Reset value: 0x0000 0000 Bit 0   UE : USART enable When this bit is cleared, the USART prescalers and outputs are stopped immediately, and all current operations are discarded. The USART configuration is kept, but all the USART_ISR status flags are reset. This bit is set and cleared by software. 0: USART prescaler and outputs disabled, low-power mode 1: USART enabled  Note:   To enter low-power mode without generating errors on the line, the TE bit must be previously reset and the software must wait for the TC bit in the USART_ISR to be set before resetting the UE bit. The DMA requests are also reset when UE = 0 so the DMA channel must be disabled before resetting the UE bit. In smartcard mode, (SCEN = 1), the CK pin is always available when CLKEN = 1, regardless of the UE bit value.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 ADD[7:0]   RTOEN   ABRMOD[1:0]   ABREN   MSBFI RST DATAIN V   TXINV   RXINV rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 SWAP   LINEN   STOP[1:0]   CLKEN   CPOL   CPHA   LBCL   Res.   LBDIE   LBDL   ADDM7   DIS_ NSS   Res.   Res.   SLVEN rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:24   ADD[7:0] : Address of the USART node These bits give the address of the USART node in mute mode or a character code to be recognized in low-power or Run mode: –   In mute mode: they are used in multiprocessor communication to wake up from mute mode with 4-bit/7-bit address mark detection. The MSB of the character sent by the transmitter should be equal to 1. In 4-bit address mark detection, only ADD[3:0] bits are used. –   In low-power mode: they are used for wake up from low-power mode on character match. When WUS[1:0] is programmed to 0b00 (WUF active on address match), the wake-up from low-power mode is performed when the received character corresponds to the character programmed through ADD[6:0] or ADD[3:0] bitfield (depending on ADDM7 bit), and WUF interrupt is enabled by setting WUFIE bit. The MSB of the character sent by transmitter should be equal to 1. –   In Run mode with mute mode inactive (for example, end-of-block detection in ModBus protocol): the whole received character (8 bits) is compared to ADD[7:0] value and CMF flag is set on match. An interrupt is generated if the CMIE bit is set. These bits can only be written when the reception is disabled (RE = 0) or when the USART is disabled (UE = 0).

Universal synchronous receiver transmitter (USART)   RM0490  802/1027   RM0490 Rev 5  Bit 23   RTOEN : Receiver timeout enable This bit is set and cleared by software. 0: Receiver timeout feature disabled. 1: Receiver timeout feature enabled. When this feature is enabled, the RTOF flag in the USART_ISR register is set if the RX line is idle (no reception) for the duration programmed in the RTOR (receiver timeout register).  Note:   If the USART does not support the Receiver timeout feature, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bits 22:21   ABRMOD[1:0] : Auto baud rate mode These bits are set and cleared by software. 00: Measurement of the start bit is used to detect the baud rate. 01: Falling edge to falling edge measurement (the received frame must start with a single bit = 1 and Frame = Start10xxxxxx) 10: 0x7F frame detection. 11: 0x55 frame detection This bitfield can only be written when ABREN = 0 or the USART is disabled (UE = 0).  Note:   If DATAINV   =   1 and/or MSBFIRST   =   1 the patterns must be the same on the line, for example 0xAA for MSBFIRST) If the USART does not support the auto baud rate feature, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 20   ABREN : Auto baud rate enable This bit is set and cleared by software. 0: Auto baud rate detection is disabled. 1: Auto baud rate detection is enabled.  Note:   If the USART does not support the auto baud rate feature, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 19   MSBFIRST : Most significant bit first This bit is set and cleared by software. 0: data is transmitted/received with data bit 0 first, following the start bit. 1: data is transmitted/received with the MSB (bit 7/8) first, following the start bit. This bitfield can only be written when the USART is disabled (UE = 0). Bit 18   DATAINV:   Binary data inversion This bit is set and cleared by software. 0: Logical data from the data register are send/received in positive/direct logic. (1 = H, 0 = L) 1: Logical data from the data register are send/received in negative/inverse logic. (1 = L, 0 = H). The parity bit is also inverted. This bitfield can only be written when the USART is disabled (UE = 0). Bit 17   TXINV:   TX pin active level inversion This bit is set and cleared by software. 0: TX pin signal works using the standard logic levels (V DD   =1/idle, Gnd = 0/mark) 1: TX pin signal values are inverted (V DD   =0/mark, Gnd = 1/idle). This enables the use of an external inverter on the TX line. This bitfield can only be written when the USART is disabled (UE = 0). Bit 16   RXINV:   RX pin active level inversion This bit is set and cleared by software. 0: RX pin signal works using the standard logic levels (V   DD   =1/idle, Gnd = 0/mark) 1: RX pin signal values are inverted (V   DD   =0/mark, Gnd = 1/idle). This enables the use of an external inverter on the RX line. This bitfield can only be written when the USART is disabled (UE = 0).

RM0490 Rev 5   803/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Bit 15   SWAP:   Swap TX/RX pins This bit is set and cleared by software. 0: TX/RX pins are used as defined in standard pinout 1: The TX and RX pins functions are swapped. This enables to work in the case of a cross-wired connection to another UART. This bitfield can only be written when the USART is disabled (UE = 0). Bit 14   LINEN : LIN mode enable This bit is set and cleared by software. 0: LIN mode disabled 1: LIN mode enabled The LIN mode enables the capability to send LIN synchronous breaks (13 low bits) using the SBKRQ bit in the USART_CR1 register, and to detect LIN Sync breaks. This bitfield can only be written when the USART is disabled (UE = 0).  Note:   If the USART does not support LIN mode, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bits 13:12   STOP[1:0] : Stop bits These bits are used for programming the stop bits. 00: 1 stop bit 01: 0.5 stop bit. 10: 2 stop bits 11: 1.5 stop bits This bitfield can only be written when the USART is disabled (UE = 0). Bit 11   CLKEN : Clock enable This bit enables the user to enable the CK pin. 0: CK pin disabled 1: CK pin enabled This bit can only be written when the USART is disabled (UE = 0).  Note:   If neither synchronous mode nor smartcard mode is supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744. In smartcard mode, in order to provide correctly the CK clock to the smartcard, the steps below must be respected: UE = 0 SCEN = 1 GTPR configuration CLKEN= 1 UE = 1  Bit 10   CPOL : Clock polarity This bit enables the user to select the polarity of the clock output on the CK pin in synchronous mode. It works in conjunction with the CPHA bit to produce the desired clock/data relationship 0: Steady low value on CK pin outside transmission window 1: Steady high value on CK pin outside transmission window This bit can only be written when the USART is disabled (UE = 0).  Note:   If synchronous mode is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.

Universal synchronous receiver transmitter (USART)   RM0490  804/1027   RM0490 Rev 5  Bit 9   CPHA : Clock phase This bit is used to select the phase of the clock output on the CK pin in synchronous mode. It works in conjunction with the CPOL bit to produce the desired clock/data relationship (see   Figure 258   and  Figure 259 ) 0: The first clock transition is the first data capture edge 1: The second clock transition is the first data capture edge This bit can only be written when the USART is disabled (UE = 0).  Note:   If synchronous mode is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 8   LBCL : Last bit clock pulse This bit is used to select whether the clock pulse associated with the last data bit transmitted (MSB) has to be output on the CK pin in synchronous mode. 0: The clock pulse of the last data bit is not output to the CK pin 1: The clock pulse of the last data bit is output to the CK pin  Caution:   The last bit is the 7th or 8th or 9th data bit transmitted depending on the 7 or 8 or 9 bit format selected by the M bit in the USART_CR1 register. This bit can only be written when the USART is disabled (UE = 0).  Note:   If synchronous mode is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 7   Reserved, must be kept at reset value. Bit 6   LBDIE : LIN break detection interrupt enable Break interrupt mask (break detection using break delimiter). 0: Interrupt is inhibited 1: An interrupt is generated whenever LBDF = 1 in the USART_ISR register  Note:   If LIN mode is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 5   LBDL : LIN   break detection length This bit is for selection between 11 bit or 10 bit break detection. 0: 10-bit break detection 1: 11-bit break detection This bit can only be written when the USART is disabled (UE = 0).  Note:   If LIN mode is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 4   ADDM7 : 7-bit address detection/4-bit address detection This bit is for selection between 4-bit address detection or 7-bit address detection. 0: 4-bit address detection 1: 7-bit address detection (in 8-bit data mode) This bit can only be written when the USART is disabled (UE = 0)  Note:   In 7-bit and 9-bit data modes, the address detection is done on 6-bit and 8-bit address (ADD[5:0] and ADD[7:0]) respectively.  Bit 3   DIS_NSS : NSS pin enable When the DIS_NSS bit is set, the NSS pin input is ignored. 0: SPI slave selection depends on NSS input pin. 1: SPI slave is always selected and NSS input pin is ignored.  Note:   When SPI slave mode is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bits 2:1   Reserved, must be kept at reset value.

RM0490 Rev 5   805/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Note:   The CPOL, CPHA and LBCL bits should not be written while the transmitter is enabled.  26.8.4   USART control register 3 (USART_CR3)  Address offset: 0x08 Reset value: 0x0000 0000 Bit 0   SLVEN : Synchronous slave mode enable When the SLVEN bit is set, the synchronous slave mode is enabled. 0: Slave mode disabled. 1: Slave mode enabled.  Note:   When SPI slave mode is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 TXFTCFG[2:0]   RXF TIE   RXFTCFG[2:0]   TCBG TIE   TXFTIE   WUFIE   WUS[1:0]   SCARCNT[2:0]   Res. rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 DEP   DEM   DDRE   OVR DIS ONE BIT   CTSIE   CTSE   RTSE   DMAT   DMAR   SCEN   NACK   HD SEL   IRLP   IREN   EIE rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:29   TXFTCFG[2:0]:   TXFIFO threshold configuration 000:TXFIFO reaches 1/8 of its depth 001:TXFIFO reaches 1/4 of its depth 010:TXFIFO reaches 1/2 of its depth 011:TXFIFO reaches 3/4 of its depth 100:TXFIFO reaches 7/8 of its depth 101:TXFIFO becomes empty Remaining combinations: Reserved Bit 28   RXFTIE : RXFIFO threshold interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated when Receive FIFO reaches the threshold programmed in RXFTCFG. Bits 27:25   RXFTCFG[2:0]:   Receive FIFO threshold configuration 000:Receive FIFO reaches 1/8 of its depth 001:Receive FIFO reaches 1/4 of its depth 010:Receive FIFO reaches 1/2 of its depth 011:Receive FIFO reaches 3/4 of its depth 100:Receive FIFO reaches 7/8 of its depth 101:Receive FIFO becomes full Remaining combinations: Reserved Bit 24   TCBGTIE : Transmission complete before guard time, interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated whenever TCBGT=1 in the USART_ISR register  Note:   If the USART does not support the smartcard mode, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.

Universal synchronous receiver transmitter (USART)   RM0490  806/1027   RM0490 Rev 5  Bit 23   TXFTIE : TXFIFO threshold interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated when TXFIFO reaches the threshold programmed in TXFTCFG. Bit 22   WUFIE : Wake-up from low-power mode interrupt enable This bit is set and cleared by software. 0: Interrupt inhibited 1: USART interrupt generated whenever WUF = 1 in the USART_ISR register  Note:   WUFIE must be set before entering in low-power mode. If the USART does not support the wake-up from Stop feature, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bits 21:20   WUS[1:0] : Wake-up from low-power mode interrupt flag selection This bitfield specifies the event which activates the WUF (wake-up from low-power mode flag). 00: WUF active on address match (as defined by ADD[7:0] and ADDM7) 01: Reserved. 10: WUF active on start bit detection 11: WUF active on RXNE/RXFNE. This bitfield can only be written when the USART is disabled (UE = 0).  Note:   If the USART does not support the wake-up from Stop feature, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bits 19:17   SCARCNT[2:0] : Smartcard auto-retry count This bitfield specifies the number of retries for transmission and reception in smartcard mode. In transmission mode, it specifies the number of automatic retransmission retries, before generating a transmission error (FE bit set). In reception mode, it specifies the number or erroneous reception trials, before generating a reception error (RXNE/RXFNE and PE bits set). This bitfield must be programmed only when the USART is disabled (UE = 0). When the USART is enabled (UE = 1), this bitfield may only be written to 0x0, in order to stop retransmission. 0x0: retransmission disabled - No automatic retransmission in transmit mode. 0x1 to 0x7: number of automatic retransmission attempts (before signaling error)  Note:   If smartcard mode is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 16   Reserved, must be kept at reset value. Bit 15   DEP : Driver enable polarity selection 0: DE signal is active high. 1: DE signal is active low. This bit can only be written when the USART is disabled (UE = 0).  Note:   If the Driver Enable feature is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.

RM0490 Rev 5   807/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Bit 14   DEM : Driver enable mode This bit enables the user to activate the external transceiver control, through the DE signal. 0: DE function is disabled. 1: DE function is enabled. The DE signal is output on the RTS pin. This bit can only be written when the USART is disabled (UE = 0).  Note:   If the Driver Enable feature is not supported, this bit is reserved and must be kept at reset value. Section 26.4: USART implementation on page 744.  Bit 13   DDRE : DMA Disable on reception error 0: DMA is not disabled in case of reception error. The corresponding error flag is set but RXNE is kept 0 preventing from overrun. As a consequence, the DMA request is not asserted, so the erroneous data is not transferred (no DMA request), but next correct received data is transferred (used for smartcard mode). 1: DMA is disabled following a reception error. The corresponding error flag is set, as well as RXNE. The DMA request is masked until the error flag is cleared. This means that the software must first disable the DMA request (DMAR = 0) or clear RXNE/RXFNE is case FIFO mode is enabled) before clearing the error flag. This bit can only be written when the USART is disabled (UE=0).  Note:   The reception errors are: parity error, framing error or noise error.  Bit 12   OVRDIS : Overrun disable This bit is used to disable the receive overrun detection. 0: Overrun Error Flag, ORE, is set when received data is not read before receiving new data. 1: Overrun functionality is disabled. If new data is received while the RXNE flag is still set the ORE flag is not set and the new received data overwrites the previous content of the USART_RDR register. When FIFO mode is enabled, the RXFIFO is bypassed and data is written directly in USART_RDR register. Even when FIFO management is enabled, the RXNE flag is to be used. This bit can only be written when the USART is disabled (UE = 0).  Note:   This control bit enables checking the communication flow w/o reading the data  Bit 11   ONEBIT : One sample bit method enable This bit enables the user to select the sample method. When the one sample bit method is selected the noise detection flag (NE) is disabled. 0: Three sample bit method 1: One sample bit method This bit can only be written when the USART is disabled (UE = 0). Bit 10   CTSIE : CTS interrupt enable 0: Interrupt is inhibited 1: An interrupt is generated whenever CTSIF = 1 in the USART_ISR register  Note:   If the hardware flow control feature is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 9   CTSE : CTS enable 0: CTS hardware flow control disabled 1: CTS mode enabled, data is only transmitted when the CTS input is deasserted (tied to 0). If the CTS input is asserted while data is being transmitted, then the transmission is completed before stopping. If data is written into the data register while CTS is asserted, the transmission is postponed until CTS is deasserted. This bit can only be written when the USART is disabled (UE = 0)  Note:   If the hardware flow control feature is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.

Universal synchronous receiver transmitter (USART)   RM0490  808/1027   RM0490 Rev 5  Bit 8   RTSE : RTS enable 0: RTS hardware flow control disabled 1: RTS output enabled, data is only requested when there is space in the receive buffer. The transmission of data is expected to cease after the current character has been transmitted. The RTS output is deasserted (pulled to 0) when data can be received. This bit can only be written when the USART is disabled (UE = 0).  Note:   If the hardware flow control feature is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 7   DMAT : DMA enable transmitter This bit is set/reset by software 1: DMA mode is enabled for transmission 0: DMA mode is disabled for transmission Bit 6   DMAR : DMA enable receiver This bit is set/reset by software 1: DMA mode is enabled for reception 0: DMA mode is disabled for reception Bit 5   SCEN : Smartcard mode enable This bit is used for enabling smartcard mode. 0: Smartcard mode disabled 1: Smartcard mode enabled This bitfield can only be written when the USART is disabled (UE = 0).  Note:   If the USART does not support smartcard mode, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 4   NACK : Smartcard NACK enable 0: NACK transmission in case of parity error is disabled 1: NACK transmission during parity error is enabled This bitfield can only be written when the USART is disabled (UE = 0).  Note:   If the USART does not support smartcard mode, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 3   HDSEL : Half-duplex selection Selection of single-wire half-duplex mode 0: Half duplex mode is not selected 1: Half duplex mode is selected This bit can only be written when the USART is disabled (UE = 0). Bit 2   IRLP : IrDA low-power This bit is used for selecting between normal and low-power IrDA modes 0: Normal mode 1: Low-power mode This bit can only be written when the USART is disabled (UE = 0).  Note:   If IrDA mode is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 1   IREN : IrDA mode enable This bit is set and cleared by software. 0: IrDA disabled 1: IrDA enabled This bit can only be written when the USART is disabled (UE = 0).  Note:   If IrDA mode is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.

RM0490 Rev 5   809/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  26.8.5   USART baud rate register (USART_BRR)  This register can only be written when the USART is disabled (UE = 0). It may be automatically updated by hardware in auto baud rate detection mode. Address offset: 0x0C Reset value: 0x0000 0000  26.8.6   USART guard time and prescaler register (USART_GTPR)  Address offset: 0x10 Reset value: 0x0000 0000 Bit 0   EIE : Error interrupt enable Error Interrupt Enable Bit is required to enable interrupt generation in case of a framing error, overrun error noise flag or SPI slave underrun error (FE = 1 or ORE = 1 or NE = 1 or UDR = 1 in the USART_ISR register). 0: Interrupt inhibited 1: interrupt generated when FE = 1 or ORE = 1 or NE = 1 or UDR = 1 (in SPI slave mode) in the USART_ISR register. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 BRR[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   BRR[15:0] : USART baud rate  BRR[15:4]  BRR[15:4] = USARTDIV[15:4]  BRR[3:0]  When OVER8 = 0, BRR[3:0] = USARTDIV[3:0]. When OVER8 = 1: BRR[2:0] = USARTDIV[3:0] shifted 1 bit to the right. BRR[3] must be kept cleared. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 GT[7:0]   PSC[7:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value.

Universal synchronous receiver transmitter (USART)   RM0490  810/1027   RM0490 Rev 5  26.8.7   USART receiver timeout register (USART_RTOR)  Address offset: 0x14 Reset value: 0x0000 0000 Bits 15:8   GT[7:0] : Guard time value This bitfield is used to program the Guard time value in terms of number of baud clock periods. This is used in smartcard mode. The Transmission Complete flag is set after this guard time value. This bitfield can only be written when the USART is disabled (UE = 0).  Note:   If smartcard mode is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bits 7:0   PSC[7:0] : Prescaler value  In IrDA low-power and normal IrDA mode:  PSC[7:0] = IrDA normal and low-power baud rate PSC[7:0] is used to program the prescaler for dividing the USART source clock to achieve the low-power frequency: the source clock is divided by the value given in the register (8 significant bits):  In smartcard mode:  PSC[4:0] = Prescaler value PSC[4:0] is used to program the prescaler for dividing the USART source clock to provide the smartcard clock. The value given in the register (5 significant bits) is multiplied by 2 to give the division factor of the source clock frequency: 00000: Reserved - do not program this value 00001: Divides the source clock by 1 (IrDA mode) / by 2 (smartcard mode) 00010: Divides the source clock by 2 (IrDA mode) / by 4 (smartcard mode) 00011: Divides the source clock by 3 (IrDA mode) / by 6 (smartcard mode) ... 11111: Divides the source clock by 31 (IrDA mode) / by 62 (smartcard mode) 0010 0000: Divides the source clock by 32 (IrDA mode) ... 1111 1111: Divides the source clock by 255 (IrDA mode) This bitfield can only be written when the USART is disabled (UE = 0).  Note:   Bits [7:5] must be kept cleared if smartcard mode is used. This bitfield is reserved and forced by hardware to ‘0’ when the smartcard and IrDA modes are not supported. Refer to Section 26.4: USART implementation on page 744.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 BLEN[7:0]   RTO[23:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 RTO[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

RM0490 Rev 5   811/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Note:   RTOR can be written on-the-fly. If the new value is lower than or equal to the counter, the RTOF flag is set. This register is reserved and forced by hardware to “0x00000000” when the Receiver timeout feature is not supported. Refer to   Section 26.4: USART implementation on page 744   .  26.8.8   USART request register (USART_RQR)  Address offset: 0x18 Reset value: 0x0000 0000 Bits 31:24   BLEN[7:0] : Block length This bitfield gives the Block length in smartcard T = 1 Reception. Its value equals the number of information characters + the length of the Epilogue Field (1-LEC/2-CRC) - 1. Examples: BLEN = 0: 0 information characters + LEC BLEN = 1: 0 information characters + CRC BLEN = 255: 254 information characters + CRC (total 256 characters)) In smartcard mode, the Block length counter is reset when TXE = 0 (TXFE = 0 in case FIFO mode is enabled). This bitfield can be used also in other modes. In this case, the Block length counter is reset when RE = 0 (receiver disabled) and/or when the EOBCF bit is written to 1.  Note:   This value can be programmed after the start of the block reception (using the data from the LEN character in the Prologue Field). It must be programmed only once per received block.  Bits 23:0   RTO[23:0] : Receiver timeout value This bitfield gives the Receiver timeout value in terms of number of bits during which there is no activity on the RX line. In standard mode, the RTOF flag is set if, after the last received character, no new start bit is detected for more than the RTO value. In smartcard mode, this value is used to implement the CWT and BWT. See smartcard chapter for more details. In the standard, the CWT/BWT measurement is done starting from the start bit of the last received character.  Note:   This value must only be programmed once per received character.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TXFRQ   RXFRQ   MMRQ   SBKRQ   ABRR Q w   w   w   w   w Bits 31:5   Reserved, must be kept at reset value.

Universal synchronous receiver transmitter (USART)   RM0490  812/1027   RM0490 Rev 5  26.8.9   USART interrupt and status register (USART_ISR)  Address offset: 0x1C Reset value: 0x0X80 00C0 X = 2 if FIFO/smartcard mode is enabled X = 0 if FIFO is enabled and smartcard mode is disabled The same register can be used in FIFO mode enabled (this section) and FIFO mode disabled (next section).  FIFO mode enabled  Bit 4   TXFRQ : Transmit data flush request When FIFO mode is disabled, writing ‘1’ to this bit sets the TXE flag. This enables to discard the transmit data. This bit must be used only in smartcard mode, when data have not been sent due to errors (NACK) and the FE flag is active in the USART_ISR register. If the USART does not support smartcard mode, this bit is reserved and must be kept at reset value. When FIFO is enabled, TXFRQ bit is set to flush the whole FIFO. This sets the TXFE flag (Transmit FIFO empty, bit 23 in the USART_ISR register). Flushing the Transmit FIFO is supported in both UART and smartcard modes.  Note:   In FIFO mode, the TXFNF flag is reset during the flush request until TxFIFO is empty in order to ensure that no data are written in the data register.  Bit 3   RXFRQ : Receive data flush request Writing 1 to this bit empties the entire receive FIFO i.e. clears the bit RXFNE. This enables to discard the received data without reading them, and avoid an overrun condition. Bit 2   MMRQ :   Mute mode request Writing 1 to this bit puts the USART in mute mode and resets the RWU flag. Bit 1   SBKRQ : Send break request Writing 1 to this bit sets the SBKF flag and request to send a BREAK on the line, as soon as the transmit machine is available.  Note:   When the application needs to send the break character following all previously inserted data, including the ones not yet transmitted, the software should wait for the TXE flag assertion before setting the SBKRQ bit.  Bit 0   ABRRQ : Auto baud rate request Writing 1 to this bit resets the ABRF and ABRE flags in the USART_ISR and requests an automatic baud rate measurement on the next received data frame.  Note:   If the USART does not support the auto baud rate feature, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   TXFT   RXFT   TCBGT   RXFF   TXFE   RE ACK TE ACK   WUF   RWU   SBKF   CMF   BUSY r   r   r   r   r   r   r   r   r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ABRF   ABRE   UDR   EOBF   RTOF   CTS   CTSIF   LBDF   TXFNF   TC   RXFNE   IDLE   ORE   NE   FE   PE r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r

RM0490 Rev 5   813/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Bits 31:28   Reserved, must be kept at reset value. Bit 27   TXFT : TXFIFO threshold flag This bit is set by hardware when the TXFIFO reaches the threshold programmed in TXFTCFG of USART_CR3 register i.e. the TXFIFO contains TXFTCFG empty locations. An interrupt is generated if the TXFTIE bit = 1 (bit 31) in the USART_CR3 register. 0: TXFIFO does not reach the programmed threshold. 1: TXFIFO reached the programmed threshold. Bit 26   RXFT : RXFIFO threshold flag This bit is set by hardware when the threshold programmed in RXFTCFG in USART_CR3 register is reached. This means that there are (RXFTCFG - 1) data in the Receive FIFO and one data in the USART_RDR register. An interrupt is generated if the RXFTIE bit = 1 (bit 27) in the USART_CR3 register. 0: Receive FIFO does not reach the programmed threshold. 1: Receive FIFO reached the programmed threshold.  Note:   When the RXFTCFG threshold is configured to ‘101’, RXFT flag is set if 16 data are available i.e. 15 data in the RXFIFO and 1 data in the USART_RDR. Consequently, the 17th received data does not cause an overrun error. The overrun error occurs after receiving the 18th data.  Bit 25   TCBGT:   Transmission complete before guard time flag This bit is set when the last data written in the USART_TDR has been transmitted correctly out of the shift register. It is set by hardware in smartcard mode, if the transmission of a frame containing data is complete and if the smartcard did not send back any NACK. An interrupt is generated if TCBGTIE = 1 in the USART_CR3 register. This bit is cleared by software, by writing 1 to the TCBGTCF in the USART_ICR register or by a write to the USART_TDR register. 0: Transmission is not complete or transmission is complete unsuccessfully (i.e. a NACK is received from the card) 1: Transmission is complete successfully (before Guard time completion and there is no NACK from the smart card).  Note:   If the USART does not support the smartcard mode, this bit is reserved and kept at reset value. If the USART supports the smartcard mode and the smartcard mode is enabled, the TCBGT reset value is ‘1’. Refer to Section 26.4: USART implementation on page 744.  Bit 24   RXFF : RXFIFO full This bit is set by hardware when the number of received data corresponds to RXFIFO size + 1 (RXFIFO full + 1 data in the USART_RDR register. An interrupt is generated if the RXFFIE bit = 1 in the USART_CR1 register. 0: RXFIFO not full. 1: RXFIFO Full. Bit 23   TXFE : TXFIFO empty This bit is set by hardware when TXFIFO is empty. When the TXFIFO contains at least one data, this flag is cleared. The TXFE flag can also be set by writing 1 to the bit TXFRQ (bit 4) in the USART_RQR register. An interrupt is generated if the TXFEIE bit = 1 (bit 30) in the USART_CR1 register. 0: TXFIFO not empty. 1: TXFIFO empty.

Universal synchronous receiver transmitter (USART)   RM0490  814/1027   RM0490 Rev 5  Bit 22   REACK : Receive enable acknowledge flag This bit is set/reset by hardware, when the Receive Enable value is taken into account by the USART. It can be used to verify that the USART is ready for reception before entering low-power mode.  Note:   If the USART does not support the wake-up from Stop feature, this bit is reserved and kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 21   TEACK : Transmit enable acknowledge flag This bit is set/reset by hardware, when the Transmit Enable value is taken into account by the USART. It can be used when an idle frame request is generated by writing TE = 0, followed by TE = 1 in the USART_CR1 register, in order to respect the TE = 0 minimum period. Bit 20   WUF : Wake-up from low-power mode flag This bit is set by hardware, when a wake-up event is detected. The event is defined by the WUS bitfield. It is cleared by software, writing a 1 to the WUCF in the USART_ICR register. An interrupt is generated if WUFIE = 1 in the USART_CR3 register.  Note:   When UESM is cleared, WUF flag is also cleared. If the USART does not support the wake-up from Stop feature, this bit is reserved and kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 19   RWU : Receiver wake-up from mute mode This bit indicates if the USART is in mute mode. It is cleared/set by hardware when a wake- up/mute sequence is recognized. The mute mode control sequence (address or IDLE) is selected by the WAKE bit in the USART_CR1 register. When wake-up on IDLE mode is selected, this bit can only be set by software, writing 1 to the MMRQ bit in the USART_RQR register. 0: Receiver in active mode 1: Receiver in mute mode  Note:   If the USART does not support the wake-up from Stop feature, this bit is reserved and kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 18   SBKF : Send break flag This bit indicates that a send break character was requested. It is set by software, by writing 1 to the SBKRQ bit in the USART_CR3 register. It is automatically reset by hardware during the stop bit of break transmission. 0: Break character transmitted 1: Break character requested by setting SBKRQ bit in USART_RQR register Bit 17   CMF : Character match flag This bit is set by hardware, when a the character defined by ADD[7:0] is received. It is cleared by software, writing 1 to the CMCF in the USART_ICR register. An interrupt is generated if CMIE = 1in the USART_CR1 register. 0: No Character match detected 1: Character Match detected Bit 16   BUSY : Busy flag This bit is set and reset by hardware. It is active when a communication is ongoing on the RX line (successful start bit detected). It is reset at the end of the reception (successful or not). 0: USART is idle (no reception) 1: Reception on going

RM0490 Rev 5   815/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Bit 15   ABRF:   Auto baud rate flag This bit is set by hardware when the automatic baud rate has been set (RXFNE is also set, generating an interrupt if RXFNEIE = 1) or when the auto baud rate operation was completed without success (ABRE = 1) (ABRE, RXFNE and FE are also set in this case) It is cleared by software, in order to request a new auto baud rate detection, by writing 1 to the ABRRQ in the USART_RQR register.  Note:   If the USART does not support the auto baud rate feature, this bit is reserved and kept at reset value.  Bit 14   ABRE : Auto baud rate error This bit is set by hardware if the baud rate measurement failed (baud rate out of range or character comparison failed) It is cleared by software, by writing 1 to the ABRRQ bit in the USART_RQR register.  Note:   If the USART does not support the auto baud rate feature, this bit is reserved and kept at reset value.  Bit 13   UDR : SPI slave underrun error flag In slave transmission mode, this flag is set when the first clock pulse for data transmission appears while the software has not yet loaded any value into USART_TDR. This flag is reset by setting UDRCF bit in the USART_ICR register. 0: No underrun error 1: underrun error  Note:   If the USART does not support the SPI slave mode, this bit is reserved and kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 12   EOBF : End of block flag This bit is set by hardware when a complete block has been received (for example T = 1 smartcard mode). The detection is done when the number of received bytes (from the start of the block, including the prologue) is equal or greater than BLEN + 4. An interrupt is generated if the EOBIE = 1 in the USART_CR1 register. It is cleared by software, writing 1 to the EOBCF in the USART_ICR register. 0: End of Block not reached 1: End of Block (number of characters) reached  Note:   If smartcard mode is not supported, this bit is reserved and kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 11   RTOF : Receiver timeout This bit is set by hardware when the timeout value, programmed in the RTOR register has lapsed, without any communication. It is cleared by software, writing 1 to the RTOCF bit in the USART_ICR register. An interrupt is generated if RTOIE = 1 in the USART_CR2 register. In smartcard mode, the timeout corresponds to the CWT or BWT timings. 0: Timeout value not reached 1: Timeout value reached without any data reception  Note:   If a time equal to the value programmed in RTOR register separates 2 characters, RTOF is not set. If this time exceeds this value + 2 sample times (2/16 or 2/8, depending on the oversampling method), RTOF flag is set. The counter counts even if RE = 0 but RTOF is set only when RE = 1. If the timeout has already elapsed when RE is set, then RTOF is set. If the USART does not support the Receiver timeout feature, this bit is reserved and kept at reset value.

Universal synchronous receiver transmitter (USART)   RM0490  816/1027   RM0490 Rev 5  Bit 10   CTS : CTS flag This bit is set/reset by hardware. It is an inverted copy of the status of the CTS input pin. 0: CTS line set 1: CTS line reset  Note:   If the hardware flow control feature is not supported, this bit is reserved and kept at reset value.  Bit 9   CTSIF : CTS interrupt flag This bit is set by hardware when the CTS input toggles, if the CTSE bit is set. It is cleared by software, by writing 1 to the CTSCF bit in the USART_ICR register. An interrupt is generated if CTSIE = 1 in the USART_CR3 register. 0: No change occurred on the CTS status line 1: A change occurred on the CTS status line  Note:   If the hardware flow control feature is not supported, this bit is reserved and kept at reset value.  Bit 8   LBDF : LIN break detection flag This bit is set by hardware when the LIN break is detected. It is cleared by software, by writing 1 to the LBDCF in the USART_ICR. An interrupt is generated if LBDIE = 1 in the USART_CR2 register. 0: LIN Break not detected 1: LIN break detected  Note:   If the USART does not support LIN mode, this bit is reserved and kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 7   TXFNF:   TXFIFO not full TXFNF is set by hardware when TXFIFO is not full meaning that data can be written in the USART_TDR. Every write operation to the USART_TDR places the data in the TXFIFO. This flag remains set until the TXFIFO is full. When the TXFIFO is full, this flag is cleared indicating that data can not be written into the USART_TDR. An interrupt is generated if the TXFNFIE bit =1 in the USART_CR1 register. 0: Transmit FIFO is full 1: Transmit FIFO is not full  Note:   The TXFNF is kept reset during the flush request until TXFIFO is empty. After sending the flush request (by setting TXFRQ bit), the flag TXFNF should be checked prior to writing in TXFIFO (TXFNF and TXFE are set at the same time). This bit is used during single buffer transmission.  Bit 6   TC : Transmission complete This bit indicates that the last data written in the USART_TDR has been transmitted out of the shift register. It is set by hardware when the transmission of a frame containing data is complete and when TXFE is set. An interrupt is generated if TCIE = 1 in the USART_CR1 register. TC bit is is cleared by software, by writing 1 to the TCCF in the USART_ICR register or by a write to the USART_TDR register. 0: Transmission is not complete 1: Transmission is complete  Note:   If TE bit is reset and no transmission is on going, the TC bit is immediately set.

RM0490 Rev 5   817/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Bit 5   RXFNE : RXFIFO not empty RXFNE bit is set by hardware when the RXFIFO is not empty, meaning that data can be read from the USART_RDR register. Every read operation from the USART_RDR frees a location in the RXFIFO. RXFNE is cleared when the RXFIFO is empty. The RXFNE flag can also be cleared by writing 1 to the RXFRQ in the USART_RQR register. An interrupt is generated if RXFNEIE = 1 in the USART_CR1 register. 0: Data is not received 1: Received data is ready to be read. Bit 4   IDLE : Idle line detected This bit is set by hardware when an Idle Line is detected. An interrupt is generated if IDLEIE = 1 in the USART_CR1 register. It is cleared by software, writing 1 to the IDLECF in the USART_ICR register. 0: No Idle line is detected 1: Idle line is detected  Note:   The IDLE bit is not set again until the RXFNE bit has been set (i.e. a new idle line occurs). If mute mode is enabled (MME   =   1), IDLE is set if the USART is not mute (RWU   =   0), whatever the mute mode selected by the WAKE bit. If RWU   =   1, IDLE is not set.  Bit 3   ORE : Overrun error This bit is set by hardware when the data currently being received in the shift register is ready to be transferred into the USART_RDR register while RXFF = 1. It is cleared by a software, writing 1 to the ORECF, in the USART_ICR register. An interrupt is generated if RXFNEIE = 1 in the USART_CR1 register, or EIE = 1 in the USART_CR3 register. 0: No overrun error 1: Overrun error is detected  Note:   When this bit is set, the USART_RDR register content is not lost but the shift register is overwritten. An interrupt is generated if the ORE flag is set during multi buffer communication if the EIE bit is set. This bit is permanently forced to 0 (no overrun detection) when the bit OVRDIS is set in the USART_CR3 register.  Bit 2   NE : Noise detection flag This bit is set by hardware when noise is detected on a received frame. It is cleared by software, writing 1 to the NECF bit in the USART_ICR register. 0: No noise is detected 1: Noise is detected  Note:   This bit does not generate an interrupt as it appears at the same time as the RXFNE bit which itself generates an interrupt. An interrupt is generated when the NE flag is set during multi buffer communication if the EIE bit is set. When the line is noise-free, the NE flag can be disabled by programming the ONEBIT bit to 1 to increase the USART tolerance to deviations (Refer to Section 26.5.8: Tolerance of the USART receiver to clock deviation on page 762). This error is associated with the character in the USART_RDR.

Universal synchronous receiver transmitter (USART)   RM0490  818/1027   RM0490 Rev 5  26.8.10   USART interrupt and status register [alternate] (USART_ISR)  Address offset: 0x1C Reset value: 0x0000 00C0 The same register can be used in FIFO mode enabled (previous section) and FIFO mode disabled (this section).  FIFO mode disabled  Bit 1   FE : Framing error This bit is set by hardware when a de-synchronization, excessive noise or a break character is detected. It is cleared by software, writing 1 to the FECF bit in the USART_ICR register. When transmitting data in smartcard mode, this bit is set when the maximum number of transmit attempts is reached without success (the card NACKs the data frame). An interrupt is generated if EIE = 1 in the USART_CR3 register. 0: No Framing error is detected 1: Framing error or break character is detected  Note:   This error is associated with the character in the USART_RDR.  Bit 0   PE : Parity error This bit is set by hardware when a parity error occurs in receiver mode. It is cleared by software, writing 1 to the PECF in the USART_ICR register. An interrupt is generated if PEIE = 1 in the USART_CR1 register. 0: No parity error 1: Parity error  Note:   This error is associated with the character in the USART_RDR.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   TCBGT   Res.   Res.   RE ACK TE ACK   WUF   RWU   SBKF   CMF   BUSY r   r   r   r   r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ABRF   ABRE   UDR   EOBF   RTOF   CTS   CTSIF   LBDF   TXE   TC   RXNE   IDLE   ORE   NE   FE   PE r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r

RM0490 Rev 5   819/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Bits 31:26   Reserved, must be kept at reset value. Bit 25   TCBGT:   Transmission complete before guard time flag This bit is set when the last data written in the USART_TDR has been transmitted correctly out of the shift register. It is set by hardware in smartcard mode, if the transmission of a frame containing data is complete and if the smartcard did not send back any NACK. An interrupt is generated if TCBGTIE = 1 in the USART_CR3 register. This bit is cleared by software, by writing 1 to the TCBGTCF in the USART_ICR register or by a write to the USART_TDR register. 0: Transmission is not complete or transmission is complete unsuccessfully (i.e. a NACK is received from the card) 1: Transmission is complete successfully (before Guard time completion and there is no NACK from the smart card).  Note:   If the USART does not support the smartcard mode, this bit is reserved and kept at reset value. If the USART supports the smartcard mode and the smartcard mode is enabled, the TCBGT reset value is ‘1’. Refer to Section 26.4: USART implementation on page 744.  Bits 24:23   Reserved, must be kept at reset value. Bit 22   REACK : Receive enable acknowledge flag This bit is set/reset by hardware, when the Receive Enable value is taken into account by the USART. It can be used to verify that the USART is ready for reception before entering low-power mode.  Note:   If the USART does not support the wake-up from Stop feature, this bit is reserved and kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 21   TEACK : Transmit enable acknowledge flag This bit is set/reset by hardware, when the Transmit Enable value is taken into account by the USART. It can be used when an idle frame request is generated by writing TE = 0, followed by TE = 1 in the USART_CR1 register, in order to respect the TE = 0 minimum period. Bit 20   WUF : Wake-up from low-power mode flag This bit is set by hardware, when a wake-up event is detected. The event is defined by the WUS bitfield. It is cleared by software, writing a 1 to the WUCF in the USART_ICR register. An interrupt is generated if WUFIE = 1 in the USART_CR3 register.  Note:   When UESM is cleared, WUF flag is also cleared. If the USART does not support the wake-up from Stop feature, this bit is reserved and kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 19   RWU :   Receiver wake-up from mute mode  This bit indicates if the USART is in mute mode. It is cleared/set by hardware when a wake- up/mute sequence is recognized. The mute mode control sequence (address or IDLE) is selected by the WAKE bit in the USART_CR1 register. When wake-up on IDLE mode is selected, this bit can only be set by software, writing 1 to the MMRQ bit in the USART_RQR register. 0: Receiver in active mode 1: Receiver in mute mode  Note:   If the USART does not support the wake-up from Stop feature, this bit is reserved and kept at reset value. Refer to Section 26.4: USART implementation on page 744.

Universal synchronous receiver transmitter (USART)   RM0490  820/1027   RM0490 Rev 5  Bit 18   SBKF : Send break flag This bit indicates that a send break character was requested. It is set by software, by writing 1 to the SBKRQ bit in the USART_CR3 register. It is automatically reset by hardware during the stop bit of break transmission. 0: Break character transmitted 1: Break character requested by setting SBKRQ bit in USART_RQR register Bit 17   CMF : Character match flag This bit is set by hardware, when a the character defined by ADD[7:0] is received. It is cleared by software, writing 1 to the CMCF in the USART_ICR register. An interrupt is generated if CMIE = 1in the USART_CR1 register. 0: No Character match detected 1: Character Match detected Bit 16   BUSY : Busy flag This bit is set and reset by hardware. It is active when a communication is ongoing on the RX line (successful start bit detected). It is reset at the end of the reception (successful or not). 0: USART is idle (no reception) 1: Reception on going Bit 15   ABRF:   Auto baud rate flag This bit is set by hardware when the automatic baud rate has been set (RXNE is also set, generating an interrupt if RXNEIE = 1) or when the auto baud rate operation was completed without success (ABRE = 1) (ABRE, RXNE and FE are also set in this case) It is cleared by software, in order to request a new auto baud rate detection, by writing 1 to the ABRRQ in the USART_RQR register.  Note:   If the USART does not support the auto baud rate feature, this bit is reserved and kept at reset value.  Bit 14   ABRE : Auto baud rate error This bit is set by hardware if the baud rate measurement failed (baud rate out of range or character comparison failed) It is cleared by software, by writing 1 to the ABRRQ bit in the USART_RQR register.  Note:   If the USART does not support the auto baud rate feature, this bit is reserved and kept at reset value.  Bit 13   UDR : SPI slave underrun error flag In slave transmission mode, this flag is set when the first clock pulse for data transmission appears while the software has not yet loaded any value into USART_TDR. This flag is reset by setting UDRCF bit in the USART_ICR register. 0: No underrun error 1: underrun error  Note:   If the USART does not support the SPI slave mode, this bit is reserved and kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 12   EOBF : End of block flag This bit is set by hardware when a complete block has been received (for example T = 1 smartcard mode). The detection is done when the number of received bytes (from the start of the block, including the prologue) is equal or greater than BLEN + 4. An interrupt is generated if the EOBIE = 1 in the USART_CR1 register. It is cleared by software, writing 1 to the EOBCF in the USART_ICR register. 0: End of Block not reached 1: End of Block (number of characters) reached  Note:   If smartcard mode is not supported, this bit is reserved and kept at reset value. Refer to Section 26.4: USART implementation on page 744.

RM0490 Rev 5   821/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  Bit 11   RTOF : Receiver timeout This bit is set by hardware when the timeout value, programmed in the RTOR register has lapsed, without any communication. It is cleared by software, writing 1 to the RTOCF bit in the USART_ICR register. An interrupt is generated if RTOIE = 1 in the USART_CR2 register. In smartcard mode, the timeout corresponds to the CWT or BWT timings. 0: Timeout value not reached 1: Timeout value reached without any data reception  Note:   If a time equal to the value programmed in RTOR register separates 2 characters, RTOF is not set. If this time exceeds this value + 2 sample times (2/16 or 2/8, depending on the oversampling method), RTOF flag is set. The counter counts even if RE = 0 but RTOF is set only when RE = 1. If the timeout has already elapsed when RE is set, then RTOF is set. If the USART does not support the Receiver timeout feature, this bit is reserved and kept at reset value.  Bit 10   CTS : CTS flag This bit is set/reset by hardware. It is an inverted copy of the status of the CTS input pin. 0: CTS line set 1: CTS line reset  Note:   If the hardware flow control feature is not supported, this bit is reserved and kept at reset value.  Bit 9   CTSIF : CTS interrupt flag This bit is set by hardware when the CTS input toggles, if the CTSE bit is set. It is cleared by software, by writing 1 to the CTSCF bit in the USART_ICR register. An interrupt is generated if CTSIE = 1 in the USART_CR3 register. 0: No change occurred on the CTS status line 1: A change occurred on the CTS status line  Note:   If the hardware flow control feature is not supported, this bit is reserved and kept at reset value.  Bit 8   LBDF : LIN break detection flag This bit is set by hardware when the LIN break is detected. It is cleared by software, by writing 1 to the LBDCF in the USART_ICR. An interrupt is generated if LBDIE = 1 in the USART_CR2 register. 0: LIN Break not detected 1: LIN break detected  Note:   If the USART does not support LIN mode, this bit is reserved and kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 7   TXE:   Transmit data register empty TXE is set by hardware when the content of the USART_TDR register has been transferred into the shift register. It is cleared by writing to the USART_TDR register. The TXE flag can also be set by writing 1 to the TXFRQ in the USART_RQR register, in order to discard the data (only in smartcard T = 0 mode, in case of transmission failure). An interrupt is generated if the TXEIE bit = 1 in the USART_CR1 register. 0: Data register full 1: Data register not full

Universal synchronous receiver transmitter (USART)   RM0490  822/1027   RM0490 Rev 5  Bit 6   TC : Transmission complete This bit indicates that the last data written in the USART_TDR has been transmitted out of the shift register. It is set by hardware when the transmission of a frame containing data is complete and when TXE is set. An interrupt is generated if TCIE = 1 in the USART_CR1 register. TC bit is is cleared by software, by writing 1 to the TCCF in the USART_ICR register or by a write to the USART_TDR register. 0: Transmission is not complete 1: Transmission is complete  Note:   If TE bit is reset and no transmission is on going, the TC bit is set immediately.  Bit 5   RXNE : Read data register not empty RXNE bit is set by hardware when the content of the USART_RDR shift register has been transferred to the USART_RDR register. It is cleared by reading from the USART_RDR register. The RXNE flag can also be cleared by writing 1 to the RXFRQ in the USART_RQR register. An interrupt is generated if RXNEIE = 1 in the USART_CR1 register. 0: Data is not received 1: Received data is ready to be read. Bit 4   IDLE : Idle line detected This bit is set by hardware when an Idle Line is detected. An interrupt is generated if IDLEIE = 1 in the USART_CR1 register. It is cleared by software, writing 1 to the IDLECF in the USART_ICR register. 0: No Idle line is detected 1: Idle line is detected  Note:   The IDLE bit is not set again until the RXNE bit has been set (i.e. a new idle line occurs). If mute mode is enabled (MME   =   1), IDLE is set if the USART is not mute (RWU   =   0), whatever the mute mode selected by the WAKE bit. If RWU   =   1, IDLE is not set.  Bit 3   ORE : Overrun error This bit is set by hardware when the data currently being received in the shift register is ready to be transferred into the USART_RDR register while RXNE = 1. It is cleared by a software, writing 1 to the ORECF, in the USART_ICR register. An interrupt is generated if RXNEIE = 1 or EIE = 1 in the LPUART_CR1 register, or EIE = 1 in the USART_CR3 register. 0: No overrun error 1: Overrun error is detected  Note:   When this bit is set, the USART_RDR register content is not lost but the shift register is overwritten. An interrupt is generated if the ORE flag is set during multi buffer communication if the EIE bit is set. This bit is permanently forced to 0 (no overrun detection) when the bit OVRDIS is set in the USART_CR3 register.

RM0490 Rev 5   823/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  26.8.11   USART interrupt flag clear register (USART_ICR)  Address offset: 0x20 Reset value: 0x0000 0000 Bit 2   NE : Noise detection flag This bit is set by hardware when noise is detected on a received frame. It is cleared by software, writing 1 to the NECF bit in the USART_ICR register. 0: No noise is detected 1: Noise is detected  Note:   This bit does not generate an interrupt as it appears at the same time as the RXNE bit which itself generates an interrupt. An interrupt is generated when the NE flag is set during multi buffer communication if the EIE bit is set. When the line is noise-free, the NE flag can be disabled by programming the ONEBIT bit to 1 to increase the USART tolerance to deviations (Refer to Section 26.5.8: Tolerance of the USART receiver to clock deviation on page 762).  Bit 1   FE : Framing error This bit is set by hardware when a de-synchronization, excessive noise or a break character is detected. It is cleared by software, writing 1 to the FECF bit in the USART_ICR register. When transmitting data in smartcard mode, this bit is set when the maximum number of transmit attempts is reached without success (the card NACKs the data frame). An interrupt is generated if EIE = 1 in the USART_CR3 register. 0: No Framing error is detected 1: Framing error or break character is detected Bit 0   PE : Parity error This bit is set by hardware when a parity error occurs in receiver mode. It is cleared by software, writing 1 to the PECF in the USART_ICR register. An interrupt is generated if PEIE = 1 in the USART_CR1 register. 0: No parity error 1: Parity error 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   WUCF   Res.   Res.   CMCF   Res. w   w 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   UDRCF   EOBCF   RTOCF   Res.   CTSCF   LBDCF   TCBGT CF   TCCF   TXFEC F IDLEC F   ORECF   NECF   FECF   PECF w   w   w   w   w   w   w   w   w   w   w   w   w Bits 31:21   Reserved, must be kept at reset value. Bit 20   WUCF : Wake-up from low-power mode clear flag Writing 1 to this bit clears the WUF flag in the USART_ISR register.  Note:   If the USART does not support the wake-up from Stop feature, this bit is reserved and must be kept at reset value.   Refer to Section 26.4: USART implementation on page 744.  Bits 19:18   Reserved, must be kept at reset value. Bit 17   CMCF : Character match clear flag Writing 1 to this bit clears the CMF flag in the USART_ISR register.

Universal synchronous receiver transmitter (USART)   RM0490  824/1027   RM0490 Rev 5  Bits 16:14   Reserved, must be kept at reset value. Bit 13   UDRCF :SPI slave underrun clear flag Writing 1 to this bit clears the UDRF flag in the USART_ISR register.  Note:   If the USART does not support SPI slave mode, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744  Bit 12   EOBCF : End of block clear flag Writing 1 to this bit clears the EOBF flag in the USART_ISR register.  Note:   If the USART does not support smartcard mode, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 11   RTOCF : Receiver timeout clear flag Writing 1 to this bit clears the RTOF flag in the USART_ISR register.  Note:   If the USART does not support the Receiver timeout feature, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 10   Reserved, must be kept at reset value. Bit 9   CTSCF : CTS clear flag Writing 1 to this bit clears the CTSIF flag in the USART_ISR register.  Note:   If the hardware flow control feature is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 8   LBDCF : LIN break detection clear flag Writing 1 to this bit clears the LBDF flag in the USART_ISR register.  Note:   If LIN mode is not supported, this bit is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.  Bit 7   TCBGTCF : Transmission complete before Guard time clear flag Writing 1 to this bit clears the TCBGT flag in the USART_ISR register. Bit 6   TCCF : Transmission complete clear flag Writing 1 to this bit clears the TC flag in the USART_ISR register. Bit 5   TXFECF : TXFIFO empty clear flag Writing 1 to this bit clears the TXFE flag in the USART_ISR register. Bit 4   IDLECF : Idle line detected clear flag Writing 1 to this bit clears the IDLE flag in the USART_ISR register. Bit 3   ORECF : Overrun error clear flag Writing 1 to this bit clears the ORE flag in the USART_ISR register. Bit 2   NECF :   Noise detected clear flag Writing 1 to this bit clears the NE flag in the USART_ISR register. Bit 1   FECF : Framing error clear flag Writing 1 to this bit clears the FE flag in the USART_ISR register. Bit 0   PECF : Parity error clear flag Writing 1 to this bit clears the PE flag in the USART_ISR register.

RM0490 Rev 5   825/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  26.8.12   USART receive data register (USART_RDR)  Address offset: 0x24 Reset value: 0x0000 0000  26.8.13   USART transmit data register (USART_TDR)  Address offset: 0x28 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   RDR[8:0] r   r   r   r   r   r   r   r   r Bits 31:9   Reserved, must be kept at reset value. Bits 8:0   RDR[8:0] : Receive data value Contains the received data character. The RDR register provides the parallel interface between the input shift register and the internal bus (see   Figure 252 ). When receiving with the parity enabled, the value read in the MSB bit is the received parity bit. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   TDR[8:0] rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:9   Reserved, must be kept at reset value. Bits 8:0   TDR[8:0] : Transmit data value Contains the data character to be transmitted. The USART_TDR register provides the parallel interface between the internal bus and the output shift register (see   Figure 252 ). When transmitting with the parity enabled (PCE bit set to 1 in the USART_CR1 register), the value written in the MSB (bit 7 or bit 8 depending on the data length) has no effect because it is replaced by the parity.  Note:   This register must be written only when TXE/TXFNF   =   1.

Universal synchronous receiver transmitter (USART)   RM0490  826/1027   RM0490 Rev 5  26.8.14   USART prescaler register (USART_PRESC)  This register can only be written when the USART is disabled (UE = 0). Address offset: 0x2C Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   PRESCALER[3:0] rw   rw   rw   rw Bits 31:4   Reserved, must be kept at reset value. Bits 3:0   PRESCALER[3:0] : Clock prescaler The USART input clock can be divided by a prescaler factor: 0000: input clock not divided 0001: input clock divided by 2 0010: input clock divided by 4 0011: input clock divided by 6 0100: input clock divided by 8 0101: input clock divided by 10 0110: input clock divided by 12 0111: input clock divided by 16 1000: input clock divided by 32 1001: input clock divided by 64 1010: input clock divided by 128 1011: input clock divided by 256 Remaining combinations: Reserved  Note:   When PRESCALER is programmed with a value different of the allowed ones, programmed prescaler value is 1011 i.e. input clock divided by 256. If the prescaler is not supported, this bitfield is reserved and must be kept at reset value. Refer to Section 26.4: USART implementation on page 744.

RM0490 Rev 5   827/1027  RM0490   Universal synchronous receiver transmitter (USART)  828  26.8.15   USART register map  The table below gives the USART register map and reset values.  Table 133. USART register map and reset values Offset Register name reset value 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00 USART_CR1 FIFO enabled RXFFIE TXFEIE FIFOEN M1 EOBIE RTOIE DEAT[4:0]   DEDT[4:0] OVER8 CMIE MME M0 WAKE PCE PS PEIE TXFNFIE TCIE RXFNEIE IDLEIE TE RE UESM UE Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x00 USART_CR1 FIFO disabled Res. Res. FIFOEN M1 EOBIE RTOIE DEAT[4:0]   DEDT[4:0] OVER8 CMIE MME M0 WAKE PCE PS PEIE TXEIE TCIE RXNEIE IDLEIE TE RE UESM UE Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x04   USART_CR2   ADD[7:0] RTOEN ABRMOD[1:0] ABREN MSBFIRST DATAINV TXINV RXINV SWAP LINEN STOP [1:0] CLKEN CPOL CPHA LBCL Res. LBDIE LBDL ADDM7 DIS_NSS Res. Res. SLVEN Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x08   USART_CR3 TXFTCFG[2:0] RXFTIE RXFTCFG[2:0] TCBGTIE TXFTIE WUFIE WUS [1:0] SCAR CNT2:0] Res. DEP DEM DDRE OVRDIS ONEBIT CTSIE CTSE RTSE DMAT DMAR SCEN NACK HDSEL IRLP IREN EIE Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x0C   USART_BRR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. BRR[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x10   USART_GTPR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. GT[7:0]   PSC[7:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x14   USART_RTOR   BLEN[7:0]   RTO[23:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x18   USART_RQR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TXFRQ RXFRQ MMRQ SBKRQ ABRRQ Reset value   0   0   0   0   0 0x1C USART_ISR FIFO mode enabled Res. Res. Res. Res. TXFT RXFT TCBGT RXFF TXFE REACK TEACK WUF RWU SBKF CMF BUSY ABRF ABRE UDR EOBF RTOF CTS CTSIF LBDF TXFNF TC RXFNE IDLE ORE NE FE PE Reset value   X   X   X   X   1   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   1   1   0   0   0   0   0   0 0x1C USART_ISR FIFO mode disabled Res. Res. Res. Res. Res. Res. TCBGT Res. Res. REACK TEACK WUF RWU SBKF CMF BUSY ABRF ABRE UDR EOBF RTOF CTS CTSIF LBDF TXE TC RXNE IDLE ORE NE FE PE Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   1   1   0   0   0   0   0   0 0x20   USART_ICR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. WUCF Res. Res. CMCF Res. Res. Res. UDRCF EOBCF RTOCF Res. CTSCF LBDCF TCBGTCF TCCF TXFECF IDLECF ORECF NECF FECF PECF Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x24   USART_RDR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. RDR[8:0] Reset value   0   0   0   0   0   0   0   0   0

Universal synchronous receiver transmitter (USART)   RM0490  828/1027   RM0490 Rev 5  Refer to   Section 2.2: Memory organization   for the register boundary addresses. 0x28   USART_TDR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TDR[8:0] Reset value   0   0   0   0   0   0   0   0   0 0x2C USART_ PRESC Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res.   PRESCALE R[3:0] Reset value   0   0   0   0  Table 133. USART register map and reset values (continued) Offset Register name reset value 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

RM0490 Rev 5   829/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  27   Serial peripheral interface / integrated interchip sound (SPI/I2S) 27.1   Introduction  The SPI/I²S interface can be used to communicate with external devices using the SPI protocol or the I 2   S audio protocol. SPI or I   2   S mode is selectable by software. SPI Motorola mode is selected by default after a device reset. The serial peripheral interface (SPI) protocol supports half-duplex, full-duplex and simplex synchronous, serial communication with external devices. The interface can be configured as master and in this case it provides the communication clock (SCK) to the external slave device. The interface is also capable of operating in multimaster configuration. The integrated interchip sound (I 2   S) protocol is also a synchronous serial communication interface. It can operate in slave or master mode with half-duplex communication. It can address four different audio standards including the Philips I   2   S standard, the MSB- and LSB-justified standards and the PCM standard.  27.2   SPI main features  •   Master or slave operation  •   Full-duplex synchronous transfers on three lines  •   Half-duplex synchronous transfer on two lines (with bidirectional data line)  •   Simplex synchronous transfers on two lines (with unidirectional data line)  •   4 to 16-bit data size selection  •   Multimaster mode capability  •   8 master mode baud rate prescalers up to f   PCLK   /2  •   Slave mode frequency up to f PCLK   /2  •   NSS management by hardware or software for both master and slave: dynamic change of master/slave operations  •   Programmable clock polarity and phase  •   Programmable data order with MSB-first or LSB-first shifting  •   Dedicated transmission and reception flags with interrupt capability  •   SPI bus busy status flag  •   SPI Motorola support  •   Hardware CRC feature for reliable communication: –   CRC value can be transmitted as last byte in Tx mode –   Automatic CRC error checking for last received byte  •   Master mode fault, overrun flags with interrupt capability  •   CRC Error flag  •   Two 32-bit embedded Rx and Tx FIFOs with DMA capability  •   Enhanced TI and NSS pulse modes support

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  830/1027   RM0490 Rev 5  27.3   I2S main features  •   Half-duplex communication (only transmitter or receiver)  •   Master or slave operations  •   8-bit programmable linear prescaler to reach accurate audio sample frequencies (from 8 kHz to 192 kHz)  •   Data format may be 16-bit, 24-bit, or 32-bit  •   Packet frame is fixed to 16-bit (16-bit data frame) or 32-bit (16-bit, 24-bit, 32-bit data frame) by audio channel  •   Programmable clock polarity (steady state)  •   Underrun flag in slave transmission mode, overrun flag in reception mode (master and slave) and Frame Error Flag in reception and transmitter mode (slave only)  •   16-bit register for transmission and reception with one data register for both channel sides  •   Supported I 2   S protocols: –   I 2   S Philips standard –   MSB-justified standard (left-justified) –   LSB-justified standard (right-justified) –   PCM standard (with short and long frame synchronization on 16-bit channel frame or 16-bit data frame extended to 32-bit channel frame)  •   Data direction is always MSB first  •   DMA capability for transmission and reception (16-bit wide)  •   Master clock can be output to drive an external audio component. The ratio is fixed at 256 × f   s   for all I2S modes, and to 128 x f   s   for all PCM modes (where f s   is the audio sampling frequency).  27.4   SPI/I2S implementation  The following table describes all the SPI instances and their features embedded in the devices.  Table 134. STM32C0 series SPI/I2S implementation SPI   Features   SPI1   SPI2   (1)  1.   Applies to STM32C051/71/91/92xx devices only. Enhanced NSSP & TI modes   Yes Hardware CRC calculation   Yes I2S support   Yes   No Data size configuration   from 4 to 16 bits Rx/Tx FIFO size   32 bits

RM0490 Rev 5   831/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  27.5   SPI functional description 27.5.1   General description  The SPI allows synchronous, serial communication between the MCU and external devices. Application software can manage the communication by polling the status flag or using dedicated SPI interrupt. The main elements of SPI and their interactions are shown in the following block diagram   Figure 279 .  Figure 279. SPI block diagram  Four I/O pins are dedicated to SPI communication with external devices.  •   MISO:   Master In / Slave Out data. In the general case, this pin is used to transmit data in slave mode and receive data in master mode.  •   MOSI:   Master Out / Slave In data. In the general case, this pin is used to transmit data in master mode and receive data in slave mode.  •   SCK:   Serial Clock output pin for SPI masters and input pin for SPI slaves.  •   NSS:   Slave select pin. Depending on the SPI and NSS settings, this pin can be used to either: –   select an individual slave device for communication –   synchronize the data frame or –   detect a conflict between multiple masters See   Section 27.5.5: Slave select (NSS) pin management   for details. The SPI bus allows the communication between one master device and one or more slave devices. The bus consists of at least two wires - one for the clock signal and the other for synchronous data transfer. Other signals can be added depending on the data exchange between SPI nodes and their slave select signal management.  Shift register Write Read Address and data bus CRC controller Internal NSS CRCEN CRCNEXT CRCL RXONLY CPOL CPHA MOSI MISO SCK NSS Rx FIFO Tx FIFO BR[2:0] MS30117V1 DS[0:3] BIDIOE Communication controller NSS logic Baud rate generator

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  832/1027   RM0490 Rev 5  27.5.2   Communications between one master and one slave  The SPI allows the MCU to communicate using different configurations, depending on the device targeted and the application requirements. These configurations use 2 or 3 wires (with software NSS management) or 3 or 4 wires (with hardware NSS management). Communication is always initiated by the master.  Full-duplex communication  By default, the SPI is configured for full-duplex communication. In this configuration, the shift registers of the master and slave are linked using two unidirectional lines between the MOSI and the MISO pins. During SPI communication, data is shifted synchronously on the SCK clock edges provided by the master. The master transmits the data to be sent to the slave via the MOSI line and receives data from the slave via the MISO line. When the data frame transfer is complete (all the bits are shifted) the information between the master and slave is exchanged.  Figure 280. Full-duplex single master/ single slave application  1.   The NSS pins can be used to provide a hardware control flow between master and slave. Optionally, the pins can be left unused by the peripheral. Then the flow has to be handled internally for both master and slave. For more details see   Section 27.5.5: Slave select (NSS) pin management .  Half-duplex communication  The SPI can communicate in half-duplex mode by setting the BIDIMODE bit in the SPIx_CR1 register. In this configuration, one single cross connection line is used to link the shift registers of the master and slave together. During this communication, the data is synchronously shifted between the shift registers on the SCK clock edge in the transfer direction selected reciprocally by both master and slave with the BDIOE bit in their SPIx_CR1 registers. In this configuration, the master’s MISO pin and the slave’s MOSI pin are free for other application uses and act as GPIOs.  Rx shift register Tx shift register   Rx shift register Tx shift register SPI clock generator  Master   Slave  MISO MOSI SCK NSS MISO MOSI SCK NSS (1)   (1)  MSv39623V1

RM0490 Rev 5   833/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Figure 281. Half-duplex single master/ single slave application  1.   The NSS pins can be used to provide a hardware control flow between master and slave. Optionally, the pins can be left unused by the peripheral. Then the flow has to be handled internally for both master and slave. For more details see   Section 27.5.5: Slave select (NSS) pin management . 2.   In this configuration, the master’s MISO pin and the slave’s MOSI pin can be used as GPIOs. 3.   A critical situation can happen when communication direction is changed not synchronously between two nodes working at bidirectionnal mode and new transmitter accesses the common data line while former transmitter still keeps an opposite value on the line (the value depends on SPI configuration and communication data). Both nodes then fight while providing opposite output levels on the common line temporary till next node changes its direction settings correspondingly, too. It is suggested to insert a serial resistance between MISO and MOSI pins at this mode to protect the outputs and limit the current blowing between them at this situation.  Simplex communications  The SPI can communicate in simplex mode by setting the SPI in transmit-only or in receive- only using the RXONLY bit in the SPIx_CR1 register. In this configuration, only one line is used for the transfer between the shift registers of the master and slave. The remaining MISO and MOSI pins pair is not used for communication and can be used as standard GPIOs.  •   Transmit-only mode (RXONLY=0):   The configuration settings are the same as for full- duplex. The application has to ignore the information captured on the unused input pin. This pin can be used as a standard GPIO.  •   Receive-only mode (RXONLY=1) : The application can disable the SPI output function by setting the RXONLY bit. In slave configuration, the MISO output is disabled and the pin can be used as a GPIO. The slave continues to receive data from the MOSI pin while its slave select signal is active (see   27.5.5: Slave select (NSS) pin management ). Received data events appear depending on the data buffer configuration. In the master configuration, the MOSI output is disabled and the pin can be used as a GPIO. The clock signal is generated continuously as long as the SPI is enabled. The only way to stop the clock is to clear the RXONLY bit or the SPE bit and wait until the incoming pattern from the MISO pin is finished and fills the data buffer structure, depending on its configuration.  Rx shift register Tx shift register   Rx shift register Tx shift register SPI clock generator  Master   Slave  MISO MOSI SCK NSS MISO MOSI SCK NSS (1)   (1) (2) (2) Nȍ (3) MSv39624V1

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  834/1027   RM0490 Rev 5  Figure 282. Simplex single master/single slave application (master in transmit-only/ slave in receive-only mode)  1.   The NSS pins can be used to provide a hardware control flow between master and slave. Optionally, the pins can be left unused by the peripheral. Then the flow has to be handled internally for both master and slave. For more details see   Section 27.5.5: Slave select (NSS) pin management . 2.   An accidental input information is captured at the input of transmitter Rx shift register. All the events associated with the transmitter receive flow must be ignored in standard transmit only mode (e.g. OVR flag). 3.   In this configuration, both the MISO pins can be used as GPIOs.  Note:   Any simplex communication can be alternatively replaced by a variant of the half-duplex communication with a constant setting of the transaction direction (bidirectional mode is enabled while BDIO bit is not changed).  27.5.3   Standard multislave communication  In a configuration with two or more independent slaves, the master uses GPIO pins to manage the chip select lines for each slave (see   Figure 283 ). The master must select one of the slaves individually by pulling low the GPIO connected to the slave NSS input. When this is done, a standard master and dedicated slave communication is established.  Rx shift register Tx shift register   Rx shift register Tx shift register SPI clock generator  Master   Slave  MISO MOSI SCK NSS MISO MOSI SCK NSS (1)   (1) (2)  MSv39625V1

RM0490 Rev 5   835/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Figure 283. Master and three independent slaves  1.   NSS pin is not used on master side at this configuration. It has to be managed internally (SSM=1, SSI=1) to prevent any MODF error. 2.   As MISO pins of the slaves are connected together, all slaves must have the GPIO configuration of their MISO pin set as alternate function open-drain (see I/O alternate function input/output section (GPIO)).  27.5.4   Multimaster communication  Unless SPI bus is not designed for a multimaster capability primarily, the user can use build in feature which detects a potential conflict between two nodes trying to master the bus at the same time. For this detection, NSS pin is used configured at hardware input mode. The connection of more than two SPI nodes working at this mode is impossible as only one node can apply its output on a common data line at time. When nodes are non active, both stay at slave mode by default. Once one node wants to overtake control on the bus, it switches itself into master mode and applies active level on the slave select input of the other node via dedicated GPIO pin. After the session is completed, the active slave select signal is released and the node mastering the bus temporary returns back to passive slave mode waiting for next session start.  Rx shift register Tx shift register   Rx shift register Tx shift register SPI clock generator  Master   Slave 1  MISO MOSI SCK NSS MISO MOSI SCK NSS (1)  Rx shift register Tx shift register  Slave 2  Rx shift register Tx shift register  Slave 3  IO1 IO2 IO3 MISO MOSI SCK NSS MISO MOSI SCK NSS  MSv39626V1

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  836/1027   RM0490 Rev 5  If potentially both nodes raised their mastering request at the same time a bus conflict event appears (see mode fault MODF event). Then the user can apply some simple arbitration process (e.g. to postpone next attempt by predefined different time-outs applied at both nodes).  Figure 284. Multimaster application  1.   The NSS pin is configured at hardware input mode at both nodes. Its active level enables the MISO line output control as the passive node is configured as a slave.  27.5.5   Slave select (NSS) pin management  In slave mode, the NSS works as a standard “chip select” input and lets the slave communicate with the master. In master mode, NSS can be used either as output or input. As an input it can prevent multimaster bus collision, and as an output it can drive a slave select signal of a single slave. Hardware or software slave select management can be set using the SSM bit in the SPIx_CR1 register:  •   Software NSS management (SSM = 1) : in this configuration, slave select information is driven internally by the SSI bit value in register SPIx_CR1. The external NSS pin is free for other application uses.  •   Hardware NSS management (SSM = 0) : in this case, there are two possible configurations. The configuration used depends on the NSS output configuration (SSOE bit in register SPIx_CR1). –   NSS output enable (SSM=0,SSOE = 1) : this configuration is only used when the MCU is set as master. The NSS pin is managed by the hardware. The NSS signal is driven low as soon as the SPI is enabled in master mode (SPE=1), and is kept low until the SPI is disabled (SPE =0). A pulse can be generated between continuous communications if NSS pulse mode is activated (NSSP=1). The SPI cannot work in multimaster configuration with this NSS setting. –   NSS output disable (SSM=0, SSOE = 0) : if the microcontroller is acting as the master on the bus, this configuration allows multimaster capability. If the NSS pin is pulled low in this mode, the SPI enters master mode fault state and the device is automatically reconfigured in slave mode. In slave mode, the NSS pin works as a standard “chip select” input and the slave is selected while NSS line is at low level.  Rx (Tx) shift register Tx (Rx) shift register   Tx (Rx) shift register Rx (Tx) shift register SPI clock generator  Master (Slave)  Master (Slave)  MISO MOSI SCK NSS MISO MOSI SCK NSS (1) (1)  MSv39628V1 SPI clock generator GPIO GPIO

RM0490 Rev 5   837/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Figure 285. Hardware/software slave select management 27.5.6   Communication formats  During SPI communication, receive and transmit operations are performed simultaneously. The serial clock (SCK) synchronizes the shifting and sampling of the information on the data lines. The communication format depends on the clock phase, the clock polarity and the data frame format. To be able to communicate together, the master and slaves devices must follow the same communication format.  Clock phase and polarity controls  Four possible timing relationships may be chosen by software, using the CPOL and CPHA bits in the SPIx_CR1 register. The CPOL (clock polarity) bit controls the idle state value of the clock when no data is being transferred. This bit affects both master and slave modes. If CPOL is reset, the SCK pin has a low-level idle state. If CPOL is set, the SCK pin has a high-level idle state. If the CPHA bit is set, the second edge on the SCK pin captures the first data bit transacted (falling edge if the CPOL bit is reset, rising edge if the CPOL bit is set). Data are latched on each occurrence of this clock transition type. If the CPHA bit is reset, the first edge on the SCK pin captures the first data bit transacted (falling edge if the CPOL bit is set, rising edge if the CPOL bit is reset). Data are latched on each occurrence of this clock transition type. The combination of CPOL (clock polarity) and CPHA (clock phase) bits selects the data capture clock edge.  1 0 NSS Input SSM control bit SSI control bit SSOE control bit NSS Output NSS pin  (used in Master mode and NSS HW management only)  NSS Output Control  Master mode   Slave mode  Non active OK Vdd  NSS Inp.  Active Conflict Vss NSS external logic   NSS internal logic  GPIO logic MSv35526V6

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  838/1027   RM0490 Rev 5  Figure 286 , shows an SPI full-duplex transfer with the four combinations of the CPHA and CPOL bits.  Note:   Prior to changing the CPOL/CPHA bits the SPI must be disabled by resetting the SPE bit. The idle state of SCK must correspond to the polarity selected in the SPIx_CR1 register (by pulling up SCK if CPOL=1 or pulling down SCK if CPOL=0).  Figure 286. Data clock timing diagram  1.   The order of data bits depends on LSBFIRST bit setting.  Data frame format  The SPI shift register can be set up to shift out MSB-first or LSB-first, depending on the value of the LSBFIRST bit. The data frame size is chosen by using the DS bits. It can be set from 4-bit up to 16-bit length and the setting applies for both transmission and reception. Whatever the selected data frame size, read access to the FIFO must be aligned with the FRXTH level. When the SPIx_DR register is accessed, data frames are always right-aligned into either a byte (if the data fits into a byte) or a half-word (see   Figure 287 ). During communication, only bits within the data frame are clocked and transferred.  ai17154e CPHA =1 CPHA =0 CPOL = 1 CPOL = 0 MOSI (1) MISO (1) NSS (to slave) Capture strobe MSBit MSBit LSBit LSBit CPOL = 1 CPOL = 0 MOSI (1) MISO (1) NSS (to slave) Capture strobe MSBit MSBit LSBit LSBit

RM0490 Rev 5   839/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Figure 287. Data alignment when data length is not equal to 8-bit or 16-bit  Note:   The minimum data length is 4 bits. If a data length of less than 4 bits is selected, it is forced to an 8-bit data frame size.  27.5.7   Configuration of SPI  The configuration procedure is almost the same for master and slave. For specific mode setups, follow the dedicated sections. When a standard communication is to be initialized, perform these steps: 1.   Write proper GPIO registers: Configure GPIO for MOSI, MISO and SCK pins. 2.   Write to the SPI_CR1 register: a)   Configure the serial clock baud rate using the BR[2:0] bits (Note: 4). b)   Configure the CPOL and CPHA bits combination to define one of the four relationships between the data transfer and the serial clock (CPHA must be cleared in NSSP mode). (Note: 2 - except the case when CRC is enabled at TI mode). c)   Select simplex or half-duplex mode by configuring RXONLY or BIDIMODE and BIDIOE (RXONLY and BIDIMODE cannot be set at the same time). d)   Configure the LSBFIRST bit to define the frame format (Note: 2). e)   Configure the CRCL and CRCEN bits if CRC is needed (while SCK clock signal is at idle state). f)   Configure SSM and SSI (Notes: 2 & 3). g)   Configure the MSTR bit (in multimaster NSS configuration, avoid conflict state on NSS if master is configured to prevent MODF error). 3.   Write to SPI_CR2 register: a)   Configure the DS[3:0] bits to select the data length for the transfer. b)   Configure SSOE (Notes: 1 & 2 & 3). c)   Set the FRF bit if the TI protocol is required (keep NSSP bit cleared in TI mode). d)   Set the NSSP bit if the NSS pulse mode between two data units is required (keep CHPA and TI bits cleared in NSSP mode). e)   Configure the FRXTH bit. The RXFIFO threshold must be aligned to the read access size for the SPIx_DR register. f)   Initialize LDMA_TX and LDMA_RX bits if DMA is used in packed mode. 4.   Write to SPI_CRCPR register: Configure the CRC polynomial if needed. 5.   Write proper DMA registers: Configure DMA streams dedicated for SPI Tx and Rx in DMA registers if the DMA streams are used.  MS19589V2 XXX 000 Data frame Data frame XX 00 Data frame Data frame TX RX TX RX 7 7 5 4   0 0 15   13   0 14 15   13   0 14 DS <= 8 bits: data is right-aligned on byte Example: DS = 5 bit DS > 8 bits: data is right-aligned on 16 bit Example: DS = 14 bit 5 4

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  840/1027   RM0490 Rev 5  Note:   (1) Step is not required in slave mode. (2) Step is not required in TI mode. (3) Step is not required in NSSP mode. (4) The step is not required in slave mode except slave working at TI mode  27.5.8   Procedure for enabling SPI  It is recommended to enable the SPI slave before the master sends the clock. If not, undesired data transmission might occur. The data register of the slave must already contain data to be sent before starting communication with the master (either on the first edge of the communication clock, or before the end of the ongoing communication if the clock signal is continuous). The SCK signal must be settled at an idle state level corresponding to the selected polarity before the SPI slave is enabled. The master at full-duplex (or in any transmit-only mode) starts to communicate when the SPI is enabled and TXFIFO is not empty, or with the next write to TXFIFO. In any master receive only mode (RXONLY = 1 or BIDIMODE = 1 & BIDIOE = 0), master starts to communicate and the clock starts running immediately after SPI is enabled. For handling DMA, follow the dedicated section.  27.5.9   Data transmission and reception procedures RXFIFO and TXFIFO  All SPI data transactions pass through the 32-bit embedded FIFOs. This enables the SPI to work in a continuous flow, and prevents overruns when the data frame size is short. Each direction has its own FIFO called TXFIFO and RXFIFO. These FIFOs are used in all SPI modes except for receiver-only mode (slave or master) with CRC calculation enabled (see  Section 27.5.14: CRC calculation ). The handling of FIFOs depends on the data exchange mode (duplex, simplex), data frame format (number of bits in the frame), access size performed on the FIFO data registers (8-bit or 16-bit), and whether or not data packing is used when accessing the FIFOs (see  Section 27.5.13: TI mode ). A read access to the SPIx_DR register returns the oldest value stored in RXFIFO that has not been read yet. A write access to the SPIx_DR stores the written data in the TXFIFO at the end of a send queue. The read access must be always aligned with the RXFIFO threshold configured by the FRXTH bit in SPIx_CR2 register. FTLVL[1:0] and FRLVL[1:0] bits indicate the current occupancy level of both FIFOs. A read access to the SPIx_DR register must be managed by the RXNE event. This event is triggered when data is stored in RXFIFO and the threshold (defined by FRXTH bit) is reached. When RXNE is cleared, RXFIFO is considered to be empty. In a similar way, write access of a data frame to be transmitted is managed by the TXE event. This event is triggered when the TXFIFO level is less than or equal to half of its capacity. Otherwise TXE is cleared and the TXFIFO is considered as full. In this way, RXFIFO can store up to four data frames, whereas TXFIFO can only store up to three when the data frame format is not greater than 8 bits. This difference prevents possible corruption of 3x 8-bit data frames already stored in the TXFIFO when software tries to write more data in 16-bit mode into TXFIFO. Both TXE and RXNE events can be polled or handled by interrupts. See  Figure 289   through   Figure 292 .

RM0490 Rev 5   841/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Another way to manage the data exchange is to use DMA (see   Communication using DMA (direct memory addressing) ). If the next data is received when the RXFIFO is full, an overrun event occurs (see description of OVR flag at   Section 27.5.10: SPI status flags ). An overrun event can be polled or handled by an interrupt. The BSY bit being set indicates ongoing transaction of a current data frame. When the clock signal runs continuously, the BSY flag stays set between data frames at master but becomes low for a minimum duration of one SPI clock at slave between each data frame transfer.  Sequence handling  A few data frames can be passed at single sequence to complete a message. When transmission is enabled, a sequence begins and continues while any data is present in the TXFIFO of the master. The clock signal is provided continuously by the master until TXFIFO becomes empty, then it stops waiting for additional data. In receive-only modes, half-duplex (BIDIMODE=1, BIDIOE=0) or simplex (BIDIMODE=0, RXONLY=1) the master starts the sequence immediately when both SPI is enabled and receive-only mode is activated. The clock signal is provided by the master and it does not stop until either SPI or receive-only mode is disabled by the master. The master receives data frames continuously up to this moment. While the master can provide all the transactions in continuous mode (SCK signal is continuous) it has to respect slave capability to handle data flow and its content at anytime. When necessary, the master must slow down the communication and provide either a slower clock or separate frames or data sessions with sufficient delays. Be aware there is no underflow error signal for master or slave in SPI mode, and data from the slave is always transacted and processed by the master even if the slave could not prepare it correctly in time. It is preferable for the slave to use DMA, especially when data frames are shorter and bus rate is high. Each sequence must be encased by the NSS pulse in parallel with the multislave system to select just one of the slaves for communication. In a single slave system it is not necessary to control the slave with NSS, but it is often better to provide the pulse here too, to synchronize the slave with the beginning of each data sequence. NSS can be managed by both software and hardware (see   Section 27.5.5: Slave select (NSS) pin management ). When the BSY bit is set it signifies an ongoing data frame transaction. When the dedicated frame transaction is finished, the RXNE flag is raised. The last bit is just sampled and the complete data frame is stored in the RXFIFO.  Procedure for disabling the SPI  When SPI is disabled, it is mandatory to follow the disable procedures described in this paragraph. It is important to do this before the system enters a low-power mode when the peripheral clock is stopped. Ongoing transactions can be corrupted in this case. In some modes the disable procedure is the only way to stop continuous communication running. Master in full-duplex or transmit only mode can finish any transaction when it stops providing data for transmission. In this case, the clock stops after the last data transaction. Special care must be taken in packing mode when an odd number of data frames are transacted to prevent some dummy byte exchange (refer to   Data packing   section). Before the SPI is disabled in these modes, the user must follow standard disable procedure. When

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  842/1027   RM0490 Rev 5  the SPI is disabled at the master transmitter while a frame transaction is ongoing or next data frame is stored in TXFIFO, the SPI behavior is not guaranteed. When the master is in any receive only mode, the only way to stop the continuous clock is to disable the peripheral by SPE=0. This must occur in specific time window within last data frame transaction just between the sampling time of its first bit and before its last bit transfer starts (in order to receive a complete number of expected data frames and to prevent any additional “dummy” data reading after the last valid data frame). Specific procedure must be followed when disabling SPI in this mode. Data received but not read remains stored in RXFIFO when the SPI is disabled, and must be processed the next time the SPI is enabled, before starting a new sequence. To prevent having unread data, ensure that RXFIFO is empty when disabling the SPI, by using the correct disabling procedure, or by initializing all the SPI registers with a software reset via the control of a specific register dedicated to peripheral reset (see the SPIiRST bits in the RCC_APBiRSTR registers). Standard disable procedure is based on pulling BSY status together with FTLVL[1:0] to check if a transmission session is fully completed. This check can be done in specific cases, too, when it is necessary to identify the end of ongoing transactions, for example:  •   When NSS signal is managed by software and master has to provide proper end of NSS pulse for slave, or  •   When transactions’ streams from DMA or FIFO are completed while the last data frame or CRC frame transaction is still ongoing in the peripheral bus. The correct disable procedure is (except when receive only mode is used): 1.   Wait until FTLVL[1:0] = 00 (no more data to transmit). 2.   Wait until BSY=0 (the last data frame is processed). 3.   Disable the SPI (SPE=0). 4.   Read data until FRLVL[1:0] = 00 (read all the received data). The correct disable procedure for certain receive only modes is: 1.   Interrupt the receive flow by disabling SPI (SPE=0) in the specific time window while the last data frame is ongoing. 2.   Wait until BSY=0 (the last data frame is processed). 3.   Read data until FRLVL[1:0] = 00 (read all the received data).  Note:   If packing mode is used and an odd number of data frames with a format less than or equal to 8 bits (fitting into one byte) has to be received, FRXTH must be set when FRLVL[1:0] = 01, in order to generate the RXNE event to read the last odd data frame and to keep good FIFO pointer alignment.  Data packing  When the data frame size fits into one byte (less than or equal to 8 bits), data packing is used automatically when any read or write 16-bit access is performed on the SPIx_DR register. The double data frame pattern is handled in parallel in this case. At first, the SPI operates using the pattern stored in the LSB of the accessed word, then with the other half stored in the MSB.   Figure 288   provides an example of data packing mode sequence handling. Two data frames are sent after the single 16-bit access the SPIx_DR register of the transmitter. This sequence can generate just one RXNE event in the receiver if the RXFIFO threshold is set to 16 bits (FRXTH=0). The receiver then has to access both data frames by a single 16-bit read of SPIx_DR as a response to this single RXNE event. The

RM0490 Rev 5   843/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  RxFIFO threshold setting and the following read access must be always kept aligned at the receiver side, as data can be lost if it is not in line. A specific problem appears if an odd number of such “fit into one byte” data frames must be handled. On the transmitter side, writing the last data frame of any odd sequence with an 8- bit access to SPIx_DR is enough. The receiver has to change the Rx_FIFO threshold level for the last data frame received in the odd sequence of frames in order to generate the RXNE event.  Figure 288. Packing data in FIFO for transmission and reception  1.   In this example: Data size DS[3:0] is 4-bit configured, CPOL=0, CPHA=1 and LSBFIRST =0. The Data storage is always right aligned while the valid bits are performed on the bus only, the content of LSB byte goes first on the bus, the unused bits are not taken into account on the transmitter side and padded by zeros at the receiver side.  Communication using DMA (direct memory addressing)  To operate at its maximum speed and to facilitate the data register read/write process required to avoid overrun, the SPI features a DMA capability, which implements a simple request/acknowledge protocol. A DMA access is requested when the TXDMAEN or RXDMAEN enable bit in the SPIx_CR2 register is set. Separate requests must be issued to the Tx and Rx buffers.  •   In transmission, a DMA request is issued each time TXE is set to 1. The DMA then writes to the SPIx_DR register.  •   In reception, a DMA request is issued each time RXNE is set to 1. The DMA then reads the SPIx_DR register. See   Figure 289   through   Figure 292 . When the SPI is used only to transmit data, it is possible to enable only the SPI Tx DMA channel. In this case, the OVR flag is set because the data received is not read. When the SPI is used only to receive data, it is possible to enable only the SPI Rx DMA channel. In transmission mode, when the DMA has written all the data to be transmitted (the TCIF flag is set in the DMA_ISR register), the BSY flag can be monitored to ensure that the SPI communication is complete. This is required to avoid corrupting the last transmission before disabling the SPI or entering the Stop mode. The software must first wait until FTLVL[1:0]=00 and then until BSY=0.  0x04   0x0A   SPI fsm & shift TXFIFO SPIx_DR   0x0A 0x04 0x0A   0x04 SPI fsm & shift 0x0A 0x04 0x04   0x0A SPIx_DR 16-bit access when write to data register   16-bit access when read from data register NSS SCK MOSI   RXFIFO MS19590V1 SPI_DR= 0x040A when TxE=1   SPI_DR= 0x040A when RxNE=1

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  844/1027   RM0490 Rev 5  When starting communication using DMA, to prevent DMA channel management raising error events, these steps must be followed in order: 1.   Enable DMA Rx buffer in the RXDMAEN bit in the SPI_CR2 register, if DMA Rx is used. 2.   Enable DMA streams for Tx and Rx in DMA registers, if the streams are used. 3.   Enable DMA Tx buffer in the TXDMAEN bit in the SPI_CR2 register, if DMA Tx is used. 4.   Enable the SPI by setting the SPE bit. To close communication it is mandatory to follow these steps in order: 1.   Disable DMA streams for Tx and Rx in the DMA registers, if the streams are used. 2.   Disable the SPI by following the SPI disable procedure. 3.   Disable DMA Tx and Rx buffers by clearing the TXDMAEN and RXDMAEN bits in the SPI_CR2 register, if DMA Tx and/or DMA Rx are used.  Packing with DMA  If the transfers are managed by DMA (TXDMAEN and RXDMAEN set in the SPIx_CR2 register) packing mode is enabled/disabled automatically depending on the PSIZE value configured for SPI TX and the SPI RX DMA channel. If the DMA channel PSIZE value is equal to 16-bit and SPI data size is less than or equal to 8-bit, then packing mode is enabled. The DMA then automatically manages the write operations to the SPIx_DR register. If data packing mode is used and the number of data to transfer is not a multiple of two, the LDMA_TX/LDMA_RX bits must be set. The SPI then considers only one data for the transmission or reception to serve the last DMA transfer (for more details refer to   Data packing on page 842 .)

RM0490 Rev 5   845/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Communication diagrams  Some typical timing schemes are explained in this section. These schemes are valid no matter if the SPI events are handled by polling, interrupts or DMA. For simplicity, the LSBFIRST=0, CPOL=0 and CPHA=1 setting is used as a common assumption here. No complete configuration of DMA streams is provided. The following numbered notes are common for   Figure 289 on page 846   through   Figure 292 on page 849 : 1.   The slave starts to control MISO line as NSS is active and SPI is enabled, and is disconnected from the line when one of them is released. Sufficient time must be provided for the slave to prepare data dedicated to the master in advance before its transaction starts. At the master, the SPI peripheral takes control at MOSI and SCK signals (occasionally at NSS signal as well) only if SPI is enabled. If SPI is disabled the SPI peripheral is disconnected from GPIO logic, so the levels at these lines depends on GPIO setting exclusively. 2.   At the master, BSY stays active between frames if the communication (clock signal) is continuous. At the slave, BSY signal always goes down for at least one clock cycle between data frames. 3.   The TXE signal is cleared only if TXFIFO is full. 4.   The DMA arbitration process starts just after the TXDMAEN bit is set. The TXE interrupt is generated just after the TXEIE is set. As the TXE signal is at an active level, data transfers to TxFIFO start, until TxFIFO becomes full or the DMA transfer completes. 5.   If all the data to be sent can fit into TxFIFO, the DMA Tx TCIF flag can be raised even before communication on the SPI bus starts. This flag always rises before the SPI transaction is completed. 6.   The CRC value for a package is calculated continuously frame by frame in the SPIx_TXCRCR and SPIx_RXCRCR registers. The CRC information is processed after the entire data package has completed, either automatically by DMA (Tx channel must be set to the number of data frames to be processed) or by SW (the user must handle CRCNEXT bit during the last data frame processing). While the CRC value calculated in SPIx_TXCRCR is simply sent out by transmitter, received CRC information is loaded into RxFIFO and then compared with the SPIx_RXCRCR register content (CRC error flag can be raised here if any difference). This is why the user must take care to flush this information from the FIFO, either by software reading out all the stored content of RxFIFO, or by DMA when the proper number of data frames is preset for Rx channel (number of data frames + number of CRC frames) (see the settings at the example assumption). 7.   In data packed mode, TxE and RxNE events are paired and each read/write access to the FIFO is 16 bits wide until the number of data frames are even. If the TxFIFO is ¾ full FTLVL status stays at FIFO full level. That is why the last odd data frame cannot be stored before the TxFIFO becomes ½ full. This frame is stored into TxFIFO with an 8- bit access either by software or automatically by DMA when LDMA_TX control is set. 8.   To receive the last odd data frame in packed mode, the Rx threshold must be changed to 8-bit when the last data frame is processed, either by software setting FRXTH=1 or automatically by a DMA internal signal when LDMA_RX is set.

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  846/1027   RM0490 Rev 5  Figure 289. Master full-duplex communication  Assumptions for master full-duplex communication example:  •   Data size > 8 bit If DMA is used:  •   Number of Tx frames transacted by DMA is set to 3  •   Number of Rx frames transacted by DMA is set to 3 See also   : Communication diagrams on page 845   for details about common assumptions and notes.  DTx1  10  DRx1  NSS SCK BSY MOSI   MSB   MSB   MSB DTx2   DTx3  SPE TXE 00   11   11   00 FTLVL DTx1   DTx2  LSB   DRx2   LSB   DRx3   LSB  10 10   00 10   00 00   00 RXNE DRx1   DRx2   DRx3 FRLVL DMA Tx TICF   DMA Rx TICF 1 1 2   2 3  4  5  Enable Tx/Rx DMA or interrupts DMA or software control at Tx events DMA or software control at Rx events  10 DTx3 10 3 MISO MSv19266V2

RM0490 Rev 5   847/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Figure 290. Slave full-duplex communication  Assumptions for slave full-duplex communication example:  •   Data size > 8 bit If DMA is used:  •   Number of Tx frames transacted by DMA is set to 3  •   Number of Rx frames transacted by DMA is set to 3 See also   Communication diagrams on page 845   for details about common assumptions and notes.  DTx1  10  DRx1  NSS SCK BSY MISO   MSB   MSB   MSB DTx2   DTx3  SPE TXE 00   11   11   00 FTLVL DTx1   DTx2  LSB   DRx2   LSB   DRx3   LSB  10 10   00 10   00 00   00 RXNE DRx1   DRx2   DRx3 FRLVL DMA Tx TICF   DMA Rx TICF 1 1 2 3 4 5  Enable Tx/Rx DMA or interrupts DMA or software control at Tx events DMA or software control at Rx events  10 DTx3 10 3 MOSI MSv32123V2

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  848/1027   RM0490 Rev 5  Figure 291. Master full-duplex communication with CRC  Assumptions for master full-duplex communication with CRC example:  •   Data size = 16 bit  •   CRC enabled If DMA is used:  •   Number of Tx frames transacted by DMA is set to 2  •   Number of Rx frames transacted by DMA is set to 3 See also   : Communication diagrams on page 845   for details about common assumptions and notes.  DTx1  10  DRx1  NSS SCK BSY MOSI   MSB   MSB   MSB DTx2   CRC  SPE TXE 00   11   10   00 FTLVL DTx1   DTx2  LSB   DRx2   LSB   CRC   LSB  10 10   00 10   00 00   00 RXNE DRx1   DRx2   DRx3 FRLVL DMA Tx TICF   DMA Rx TICF 1 1 2 3 4 5   6  Enable Tx/Rx DMA or interrupts DMA or software control at Tx events DMA or software control at Rx events  MISO MSv32124V2

RM0490 Rev 5   849/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Figure 292. Master full-duplex communication in packed mode  Assumptions for master full-duplex communication in packed mode example:  •   Data size = 5 bit  •   Read/write FIFO is performed mostly by 16-bit access  •   FRXTH=0 If DMA is used:  •   Number of Tx frames to be transacted by DMA is set to 3  •   Number of Rx frames to be transacted by DMA is set to 3  •   PSIZE for both Tx and Rx DMA channel is set to 16-bit  •   LDMA_TX=1 and LDMA_RX=1 See also   : Communication diagrams on page 845   for details about common assumptions and notes.  4 3 2 1  10 NSS SCK BSY MOSI   5  SPE TXE 00   11   11   00 FTLVL DTx1-2   DTx3-4 01 10   00 10 00   00 RXNE DRx1-2   DRx3-4   DRx5 FRLVL DMA Tx TICF   DMA Rx TICF 1 1 2 3 4 5  Enable Tx/Rx DMA or interrupts DMA or software control at Tx events DMA or software control at Rx events  10 DTx5 10 7  4 3 2 1 5   4 3 2 1 5   4 3 2 1 5   4 3 2 1 5 DTx1-2   DTx3-4   DTx5 5 4 3 2   1 5 4 3 2 1   5 4 3 2   1 5 4 3 2 1   1 5 4 3 2 MISO  DRx1-2   DRx3-4   DRx5  01 FRTHX=1 01   00   01 8 3 MSv32125V2

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  850/1027   RM0490 Rev 5  27.5.10   SPI status flags  Three status flags are provided for the application to completely monitor the state of the SPI bus.  Tx buffer empty flag (TXE)  The TXE flag is set when transmission TXFIFO has enough space to store data to send. TXE flag is linked to the TXFIFO level. The flag goes high and stays high until the TXFIFO level is lower or equal to 1/2 of the FIFO depth. An interrupt can be generated if the TXEIE bit in the SPIx_CR2 register is set. The bit is cleared automatically when the TXFIFO level becomes greater than 1/2.  Rx buffer not empty (RXNE)  The RXNE flag is set depending on the FRXTH bit value in the SPIx_CR2 register:  •   If FRXTH is set, RXNE goes high and stays high until the RXFIFO level is greater or equal to 1/4 (8-bit).  •   If FRXTH is cleared, RXNE goes high and stays high until the RXFIFO level is greater than or equal to 1/2 (16-bit). An interrupt can be generated if the RXNEIE bit in the SPIx_CR2 register is set. The RXNE is cleared by hardware automatically when the above conditions are no longer true.  Busy flag (BSY)  The BSY flag is set and cleared by hardware (writing to this flag has no effect). When BSY is set, it indicates that a data transfer is in progress on the SPI (the SPI bus is busy). The BSY flag can be used in certain modes to detect the end of a transfer so that the software can disable the SPI or its peripheral clock before entering a low-power mode which does not provide a clock for the peripheral. This avoids corrupting the last transfer. The BSY flag is also useful for preventing write collisions in a multimaster system. The BSY flag is cleared under any one of the following conditions:  •   When the SPI is correctly disabled  •   When a fault is detected in Master mode (MODF bit set to 1)  •   In Master mode, when it finishes a data transmission and no new data is ready to be sent  •   In Slave mode, when the BSY flag is set to '0' for at least one SPI clock cycle between each data transfer.  Note:   When the next transmission can be handled immediately by the master (e.g. if the master is in Receive-only mode or its Transmit FIFO is not empty), communication is continuous and the BSY flag remains set to '1' between transfers on the master side. Although this is not the case with a slave, it is recommended to use always the TXE and RXNE flags (instead of the BSY flags) to handle data transmission or reception operations.

RM0490 Rev 5   851/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  27.5.11   SPI error flags  An SPI interrupt is generated if one of the following error flags is set and interrupt is enabled by setting the ERRIE bit.  Overrun flag (OVR)  An overrun condition occurs when data is received by a master or slave and the RXFIFO has not enough space to store this received data. This can happen if the software or the DMA did not have enough time to read the previously received data (stored in the RXFIFO) or when space for data storage is limited e.g. the RXFIFO is not available when CRC is enabled in receive only mode so in this case the reception buffer is limited into a single data frame buffer (see   Section 27.5.14: CRC calculation ). When an overrun condition occurs, the newly received value does not overwrite the previous one in the RXFIFO. The newly received value is discarded and all data transmitted subsequently is lost. Clearing the OVR bit is done by a read access to the SPI_DR register followed by a read access to the SPI_SR register.  Mode fault (MODF)  Mode fault occurs when the master device has its internal NSS signal (NSS pin in NSS hardware mode, or SSI bit in NSS software mode) pulled low. This automatically sets the MODF bit. Master mode fault affects the SPI interface in the following ways:  •   The MODF bit is set and an SPI interrupt is generated if the ERRIE bit is set.  •   The SPE bit is cleared. This blocks all output from the device and disables the SPI interface.  •   The MSTR bit is cleared, thus forcing the device into slave mode. Use the following software sequence to clear the MODF bit: 1.   Make a read or write access to the SPIx_SR register while the MODF bit is set. 2.   Then write to the SPIx_CR1 register. To avoid any multiple slave conflicts in a system comprising several MCUs, the NSS pin must be pulled high during the MODF bit clearing sequence. The SPE and MSTR bits can be restored to their original state after this clearing sequence. As a security, hardware does not allow the SPE and MSTR bits to be set while the MODF bit is set. In a slave device the MODF bit cannot be set except as the result of a previous multimaster conflict.  CRC error (CRCERR)  This flag is used to verify the validity of the value received when the CRCEN bit in the SPIx_CR1 register is set. The CRCERR flag in the SPIx_SR register is set if the value received in the shift register does not match the receiver SPIx_RXCRCR value. The flag is cleared by the software.  TI mode frame format error (FRE)  A TI mode frame format error is detected when an NSS pulse occurs during an ongoing communication when the SPI is operating in slave mode and configured to conform to the TI mode protocol. When this error occurs, the FRE flag is set in the SPIx_SR register. The SPI is not disabled when an error occurs, the NSS pulse is ignored, and the SPI waits for the next NSS pulse before starting a new transfer. The data may be corrupted since the error detection may result in the loss of two data bytes.

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  852/1027   RM0490 Rev 5  The FRE flag is cleared when SPIx_SR register is read. If the ERRIE bit is set, an interrupt is generated on the NSS error detection. In this case, the SPI should be disabled because data consistency is no longer guaranteed and communications should be reinitiated by the master when the slave SPI is enabled again.  27.5.12   NSS pulse mode  This mode is activated by the NSSP bit in the SPIx_CR2 register and it takes effect only if the SPI interface is configured as Motorola SPI master (FRF=0) with capture on the first edge (SPIx_CR1 CPHA = 0, CPOL setting is ignored). When activated, an NSS pulse is generated between two consecutive data frame transfers when NSS stays at high level for the duration of one clock period at least. This mode allows the slave to latch data. NSSP pulse mode is designed for applications with a single master-slave pair.  Figure 293   illustrates NSS pin management when NSSP pulse mode is enabled.  Figure 293. NSSP pulse generation in Motorola SPI master mode  Note:   Similar behavior is encountered when CPOL = 0. In this case the sampling edge is the   rising  edge of SCK, and NSS assertion and deassertion refer to this sampling edge.  27.5.13   TI mode TI protocol in master mode  The SPI interface is compatible with the TI protocol. The FRF bit of the SPIx_CR2 register can be used to configure the SPI to be compliant with this protocol. The clock polarity and phase are forced to conform to the TI protocol requirements whatever the values set in the SPIx_CR1 register. NSS management is also specific to the TI protocol which makes the configuration of NSS management through the SPIx_CR1 and SPIx_CR2 registers (SSM, SSI, SSOE) impossible in this case. In slave mode, the SPI baud rate prescaler is used to control the moment when the MISO pin state changes to HiZ when the current transaction finishes (see   Figure 294 ). Any baud rate can be used, making it possible to determine this moment with optimal flexibility. However, the baud rate is generally set to the external master clock baud rate. The delay for the MISO signal to become HiZ (t   release   ) depends on internal resynchronization and on the  MS19838V1 MOSI output NSS output SCK output sampling MISO input Do not care MSB MSB 4-bits to 16-bits Do not care LSB LSB MSB MSB LSB LSB 4-bits to 16-bits Do not care Master continuous transfer (CPOL = 1; CPHA = 0; NSSP= 1) sampling   sampling   sampling   sampling   sampling t SCK   t SCK   t SCK   t SCK   t SCK

RM0490 Rev 5   853/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  baud rate value set in through the BR[2:0] bits in the SPIx_CR1 register. It is given by the formula: If the slave detects a misplaced NSS pulse during a data frame transaction the TIFRE flag is set. If the data size is equal to 4-bits or 5-bits, the master in full-duplex mode or transmit-only mode uses a protocol with one more dummy data bit added after LSB. TI NSS pulse is generated above this dummy bit clock cycle instead of the LSB in each period. This feature is not available for Motorola SPI communications (FRF bit set to 0).  Figure 294: TI mode transfer   shows the SPI communication waveforms when TI mode is selected.  Figure 294. TI mode transfer 27.5.14   CRC calculation  Two separate CRC calculators are implemented in order to check the reliability of transmitted and received data. The SPI offers CRC8 or CRC16 calculation independently of the frame data length, which can be fixed to 8-bit or 16-bit. For all the other data frame lengths, no CRC is available.  CRC principle  CRC calculation is enabled by setting the CRCEN bit in the SPIx_CR1 register before the SPI is enabled (SPE = 1). The CRC value is calculated using an odd programmable polynomial on each bit. The calculation is processed on the sampling clock edge defined by the CPHA and CPOL bits in the SPIx_CR1 register. The calculated CRC value is checked automatically at the end of the data block as well as for transfer managed by CPU or by the DMA. When a mismatch is detected between the CRC calculated internally on the received data and the CRC sent by the transmitter, a CRCERR flag is set to indicate a data corruption error. The right procedure for handling the CRC calculation depends on the SPI configuration and the chosen transfer management. t   baud_rate 2  --------------------- -   4   t   pclk × +   t   release t   baud_rate 2  --------------------- -   6   t   pclk × + <   <  MS19835V2 MSB MISO NSS SCK trigger sampling trigger sampling trigger sampling Do not care   LSB MOSI 1 or 0   MSB   LSB MSB   LSB MSB   LSB FRAME 1   FRAME 2 t   RELEASE

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  854/1027   RM0490 Rev 5  Note:   The polynomial value should only be odd. No even values are supported.  CRC transfer managed by CPU  Communication starts and continues normally until the last data frame has to be sent or received in the SPIx_DR register. Then CRCNEXT bit has to be set in the SPIx_CR1 register to indicate that the CRC frame transaction follows after the transaction of the currently processed data frame. The CRCNEXT bit must be set before the end of the last data frame transaction. CRC calculation is frozen during CRC transaction. The received CRC is stored in the RXFIFO like a data byte or word. That is why in CRC mode only, the reception buffer has to be considered as a single 16-bit buffer used to receive only one data frame at a time. A CRC-format transaction usually takes one more data frame to communicate at the end of data sequence. However, when setting an 8-bit data frame checked by 16-bit CRC, two more frames are necessary to send the complete CRC. When the last CRC data is received, an automatic check is performed comparing the received value and the value in the SPIx_RXCRC register. Software has to check the CRCERR flag in the SPIx_SR register to determine if the data transfers were corrupted or not. Software clears the CRCERR flag by writing '0' to it. After the CRC reception, the CRC value is stored in the RXFIFO and must be read in the SPIx_DR register in order to clear the RXNE flag.  CRC transfer managed by DMA  When SPI communication is enabled with CRC communication and DMA mode, the transmission and reception of the CRC at the end of communication is automatic (with the exception of reading CRC data in receive only mode). The CRCNEXT bit does not have to be handled by the software. The counter for the SPI transmission DMA channel has to be set to the number of data frames to transmit excluding the CRC frame. On the receiver side, the received CRC value is handled automatically by DMA at the end of the transaction but user must take care to flush out received CRC information from RXFIFO as it is always loaded into it. In full-duplex mode, the counter of the reception DMA channel can be set to the number of data frames to receive including the CRC, which means, for example, in the specific case of an 8-bit data frame checked by 16-bit CRC: DMA_RX = Numb_of_data + 2 In receive only mode, the DMA reception channel counter should contain only the amount of data transferred, excluding the CRC calculation. Then based on the complete transfer from DMA, all the CRC values must be read back by software from FIFO as it works as a single buffer in this mode. At the end of the data and CRC transfers, the CRCERR flag in the SPIx_SR register is set if corruption occurred during the transfer. If packing mode is used, the LDMA_RX bit needs managing if the number of data is odd.  Resetting the SPIx_TXCRC and SPIx_RXCRC values  The SPIx_TXCRC and SPIx_RXCRC values are cleared automatically when new data is sampled after a CRC phase. This allows the use of DMA circular mode (not available in receive-only mode) in order to transfer data without any interruption, (several data blocks covered by intermediate CRC checking phases).

RM0490 Rev 5   855/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  If the SPI is disabled during a communication the following sequence must be followed: 1.   Disable the SPI 2.   Clear the CRCEN bit 3.   Enable the CRCEN bit 4.   Enable the SPI  Note:   When the SPI interface is configured as a slave, the NSS internal signal needs to be kept low during transaction of the CRC phase once the CRCNEXT signal is released. That is why the CRC calculation cannot be used at NSS Pulse mode when NSS hardware mode should be applied at slave normally. At TI mode, despite the fact that clock phase and clock polarity setting is fixed and independent on SPIx_CR1 register, the corresponding setting CPOL=0 CPHA=1 has to be kept at the SPIx_CR1 register anyway if CRC is applied. In addition, the CRC calculation has to be reset between sessions by SPI disable sequence with re-enable the CRCEN bit described above at both master and slave side, else CRC calculation can be corrupted at this specific mode.  27.6   SPI interrupts  During SPI communication an interrupt can be generated by the following events:  •   Transmit TXFIFO ready to be loaded  •   Data received in Receive RXFIFO  •   Master mode fault  •   Overrun error  •   TI frame format error  •   CRC protocol error Interrupts can be enabled and disabled separately.  Table 135. SPI interrupt requests Interrupt event   Event flag   Enable Control bit  Transmit TXFIFO ready to be loaded   TXE   TXEIE Data received in RXFIFO   RXNE   RXNEIE Master Mode fault event   MODF ERRIE Overrun error   OVR TI frame format error   FRE CRC protocol error   CRCERR

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  856/1027   RM0490 Rev 5  27.7   I2S functional description 27.7.1   I2S general description  The block diagram of the I2S is shown in   Figure 295 .  Figure 295. I2S block diagram  1.   MCK is mapped on the MISO pin. The SPI can function as an audio I2S interface when the I2S capability is enabled (by setting the I2SMOD bit in the SPIx_I2SCFGR register). This interface mainly uses the same pins, flags and interrupts as the SPI.  Tx buffer Shift register 16-bit Communication Rx buffer 16-bit MOSI/SD Master control logic MISO SPI baud rate generator I2SMOD LSB first LSB First   SPE   BR2   BR1   BR0   MSTR   CPOL CPHA Bidi mode Bidi OE CRC EN CRC Next   DFF   Rx only   SSM   SSI Address and data bus control NSS/WS BSY   OVR MODF  CRC ERR CH SIDE  TxE   RxNE I   2   S clock generator MCK I2S_ CK I2S MOD  I2SE CH DATLEN   LEN CK POL I2SCFG   I2SSTD MCKOE   ODD   I2SDIV[7:0] [1:0]   [1:0]   [1:0] UDR I2SxCLK MS32126V1 FRE CK

RM0490 Rev 5   857/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  The I2S shares three common pins with the SPI:  •   SD: Serial Data (mapped on the MOSI pin) to transmit or receive the two time- multiplexed data channels (in half-duplex mode only).  •   WS: Word Select (mapped on the NSS pin) is the data control signal output in master mode and input in slave mode.  •   CK: Serial Clock (mapped on the SCK pin) is the serial clock output in master mode and serial clock input in slave mode. An additional pin can be used when a master clock output is needed for some external audio devices:  •   MCK: Master Clock (mapped separately) is used, when the I2S is configured in master mode (and when the MCKOE bit in the SPIx_I2SPR register is set), to output this additional clock generated at a preconfigured frequency rate equal to 256 × f S   for all I2S modes, and to 128 x f   S   for all PCM modes, where f S   is the audio sampling frequency. The I2S uses its own clock generator to produce the communication clock when it is set in master mode. This clock generator is also the source of the master clock output. Two additional registers are available in I 2   S mode. One is linked to the clock generator configuration SPIx_I2SPR and the other one is a generic I2S configuration register SPIx_I2SCFGR (audio standard, slave/master mode, data format, packet frame, clock polarity, etc.). The SPIx_CR1 register and all CRC registers are not used in the I   2   S mode. Likewise, the SSOE bit in the SPIx_CR2 register and the MODF and CRCERR bits in the SPIx_SR are not used. The I2S uses the same SPI register for data transfer (SPIx_DR) in 16-bit wide mode.  27.7.2   Supported audio protocols  The three-line bus has to handle only audio data generally time-multiplexed on two channels: the right channel and the left channel. However there is only one 16-bit register for transmission or reception. So, it is up to the software to write into the data register the appropriate value corresponding to each channel side, or to read the data from the data register and to identify the corresponding channel by checking the CHSIDE bit in the SPIx_SR register. Channel left is always sent first followed by the channel right (CHSIDE has no meaning for the PCM protocol). Four data and packet frames are available. Data may be sent with a format of:  •   16-bit data packed in a 16-bit frame  •   16-bit data packed in a 32-bit frame  •   24-bit data packed in a 32-bit frame  •   32-bit data packed in a 32-bit frame When using 16-bit data extended on 32-bit packet, the first 16 bits (MSB) are the significant bits, the 16-bit LSB is forced to 0 without any need for software action or DMA request (only one read/write operation). The 24-bit and 32-bit data frames need two CPU read or write operations to/from the SPIx_DR register or two DMA operations if the DMA is preferred for the application. For 24- bit data frame specifically, the 8 non-significant bits are extended to 32 bits with 0-bits (by hardware).

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  858/1027   RM0490 Rev 5  For all data formats and communication standards, the most significant bit is always sent first (MSB first). The I   2   S interface supports four audio standards, configurable using the I2SSTD[1:0] and PCMSYNC bits in the SPIx_I2SCFGR register.  I   2   S Philips standard  For this standard, the WS signal is used to indicate which channel is being transmitted. It is activated one CK clock cycle before the first bit (MSB) is available.  Figure 296. I 2   S Philips protocol waveforms (16/32-bit full accuracy)  Data are latched on the falling edge of CK (for the transmitter) and are read on the rising edge (for the receiver). The WS signal is also latched on the falling edge of CK.  Figure 297. I   2   S Philips standard waveforms (24-bit frame)  This mode needs two write or read operations to/from the SPIx_DR register.  •   In transmission mode: If 0x8EAA33 has to be sent (24-bit):  MS19591V1 CK WS SD Can be 16-bit or 32-bit MSB   MSB LSB Channel left Channel right transmission   reception  MS19592V1 CK WS SD Transmission   Reception 24-bit data MSB   LSB Channel left 32-bit Channel right 8-bit remaining 0 forced

RM0490 Rev 5   859/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Figure 298. Transmitting 0x8EAA33  •   In reception mode: If data 0x8EAA33 is received:  Figure 299. Receiving 0x8EAA33 Figure 300. I 2   S Philips standard (16-bit extended to 32-bit packet frame)  When 16-bit data frame extended to 32-bit channel frame is selected during the I2S configuration phase, only one access to the SPIx_DR register is required. The 16 remaining bits are forced by hardware to 0x0000 to extend the data to 32-bit format. If the data to transmit or the received data are 0x76A3 (0x76A30000 extended to 32-bit), the operation shown in   Figure 301   is required.  Figure 301. Example of 16-bit data frame extended to 32-bit channel frame  MS19593V2 0x8EAA   0x33XX First write to Data register   Second write to Data register Only the 8 MSBs are sent to compare the 24 bits. 8 LSBs have no meaning and can be anything  MS19594V1 0x8EAA   0x33XX First read to Data register   Second read to Data register Only the 8 MSB are sent to compare the 24 bits 8 LSBs have no meaning and can be anything  MS19599V1 CK WS SD Transmission   Reception 16-bit data MSB   LSB Channel left 32-bit   Channel right 16-bit remaining 0 forced  MS19595V1 0x76A3 Only one access to SPIx_DR

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  860/1027   RM0490 Rev 5  For transmission, each time an MSB is written to SPIx_DR, the TXE flag is set and its interrupt, if allowed, is generated to load the SPIx_DR register with the new value to send. This takes place even if 0x0000 have not yet been sent because it is done by hardware. For reception, the RXNE flag is set and its interrupt, if allowed, is generated when the first 16 MSB half-word is received. In this way, more time is provided between two write or read operations, which prevents underrun or overrun conditions (depending on the direction of the data transfer).  MSB justified standard  For this standard, the WS signal is generated at the same time as the first data bit, which is the MSBit.  Figure 302. MSB Justified 16-bit or 32-bit full-accuracy length  Data are latched on the falling edge of CK (for transmitter) and are read on the rising edge (for the receiver).  Figure 303. MSB justified 24-bit frame length  MS30100 V1 CK WS SD Transmission   Reception 16- or 32 bit data MSB   LSB Channel left   Channel right MSB  MS30101V1 CK WS SD Transmission   Reception 24 bit data MSB   LSB Channel left 32-bit Channel right 8-bit remaining 0 forced

RM0490 Rev 5   861/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Figure 304. MSB justified 16-bit extended to 32-bit packet frame LSB justified standard  This standard is similar to the MSB justified standard (no difference for the 16-bit and 32-bit full-accuracy frame formats). The sampling of the input and output signals is the same as for the I 2   S Philips standard.  Figure 305. LSB justified 16-bit or 32-bit full-accuracy Figure 306. LSB justified 24-bit frame length  •   In transmission mode: If data 0x3478AE have to be transmitted, two write operations to the SPIx_DR register are required by software or by DMA. The operations are shown below.  MS30102V1 CK WS SD Transmission   Reception 16-bit data MSB   LSB Channel left 32-bit Channel right 16-bit remaining 0 forced  MS30103V1 CK WS SD Transmission   Reception 16- or 32-bit data MSB   LSB Channel left Channel right MSB  MS30104V1 CK WS SD Transmission Reception 8-bit data 0 forced MSB   LSB Channel left 32-bit Channel right 24-bit remaining

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  862/1027   RM0490 Rev 5  Figure 307. Operations required to transmit 0x3478AE  •   In reception mode: If data 0x3478AE are received, two successive read operations from the SPIx_DR register are required on each RXNE event.  Figure 308. Operations required to receive 0x3478AE Figure 309. LSB justified 16-bit extended to 32-bit packet frame  When 16-bit data frame extended to 32-bit channel frame is selected during the I2S configuration phase, Only one access to the SPIx_DR register is required. The 16 remaining bits are forced by hardware to 0x0000 to extend the data to 32-bit format. In this case it corresponds to the half-word MSB. If the data to transmit or the received data are 0x76A3 (0x0000 76A3 extended to 32-bit), the operation shown in   Figure 310   is required.  0xXX34   0x78AE First write to Data register conditioned by TXE=1 Second write to Data register conditioned by TXE=1 Only the 8 LSB of the half-word are significant. A field of 0x00 is forced instead of the 8 MSBs.   MS19596V1  0xXX34   0x78AE First read from Data register conditioned by RXNE=1 Second read from Data register conditioned by RXNE=1 Only the 8 LSB of the half-word are significant. A field of 0x00 is forced instead of the 8 MSBs. MS19597V1  MS30105V1 CK WS SD Transmission Reception 16-bit data 0 forced MSB   LSB Channel left 32-bit   Channel right 16-bit remaining

RM0490 Rev 5   863/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Figure 310. Example of 16-bit data frame extended to 32-bit channel frame  In transmission mode, when a TXE event occurs, the application has to write the data to be transmitted (in this case 0x76A3). The 0x000 field is transmitted first (extension on 32-bit). The TXE flag is set again as soon as the effective data (0x76A3) is sent on SD. In reception mode, RXNE is asserted as soon as the significant half-word is received (and not the 0x0000 field). In this way, more time is provided between two write or read operations to prevent underrun or overrun conditions.  PCM standard  For the PCM standard, there is no need to use channel-side information. The two PCM modes (short and long frame) are available and configurable using the PCMSYNC bit in SPIx_I2SCFGR register. In PCM mode, the output signals (WS, SD) are sampled on the rising edge of CK signal. The input signals (WS, SD) are captured on the falling edge of CK. Note that CK and WS are configured as output in MASTER mode.  Figure 311. PCM standard waveforms (16-bit)  For long frame synchronization, the WS signal assertion time is fixed to 13 bits in master mode. For short frame synchronization, the WS synchronization signal is only one cycle long.  0x76A3 Only one access to the SPIx-DR register MS19598V1  MS30106V1 CK WS short frame SD WS long frame 13-bits MSB   LSB MSB

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  864/1027   RM0490 Rev 5  Figure 312. PCM standard waveforms (16-bit extended to 32-bit packet frame)  Note:   For both modes (master and slave) and for both synchronizations (short and long), the number of bits between two consecutive pieces of data (and so two synchronization signals) needs to be specified (DATLEN and CHLEN bits in the SPIx_I2SCFGR register) even in slave mode.  27.7.3   Start-up description  The Figure 313   shows how the serial interface is handled in MASTER mode, when the SPI/I2S is enabled (via I2SE bit). It shows as well the effect of CKPOL on the generated signals.  MS30107V1 CK WS short frame SD WS long frame Up to 13-bits MSB   LSB 16 bits

RM0490 Rev 5   865/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Figure 313. Start sequence in master mode  In slave mode, the way the frame synchronization is detected, depends on the value of ASTRTEN bit. If ASTRTEN = 0, when the audio interface is enabled (I2SE = 1), then the hardware waits for the appropriate transition on the incoming WS signal, using the CK signal.  MSv37520V2 dum: not significant data WS (O) SD (O) CK (O),   CKPOL = 0  Left sample   Right sample  I2SE WS (O) CK (O),   CKPOL = 1  SD (O)   Left sample   Right sample  WS (O) SD (O)   Sample1   Sample 2 Master I2S Philips Standard Master I2S MSB or LSB justified Master PCM short frame  I2SE I2SE CK (O),   CKPOL = 0  CK (O),   CKPOL = 1  CK (O),   CKPOL = 0  CK (O),   CKPOL = 1  dum dum dum  I2SE WS (O) SD (O)   Sample1   Sample 2 Master PCM long frame  CK (O),   CKPOL = 0  CK (O),   CKPOL = 1  dum

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  866/1027   RM0490 Rev 5  The appropriate transition is a falling edge on WS signal when I 2   S Philips Standard is used, or a rising edge for other standards. The falling edge is detected by sampling first WS to 1 and then to 0, and vice-versa for the rising edge detection. If ASTRTEN = 1, the user has to enable the audio interface before the WS becomes active. This means that the I2SE bit must be set to 1 when WS = 1 for I   2   S Philips standard, or when WS = 0 for other standards.  27.7.4   Clock generator  The I   2   S bit rate determines the data flow on the I   2   S data line and the I 2   S clock signal frequency. I 2   S bit rate = number of bits per channel × number of channels × sampling audio frequency For a 16-bit audio, left and right channel, the I 2   S bit rate is calculated as follows: I 2   S bit rate = 16 × 2 × f S It is: I 2   S bit rate = 32 x 2 x f   S   if the packet length is 32-bit wide.  Figure 314. Audio sampling frequency definition  When the master mode is configured, a specific action needs to be taken to properly program the linear divider in order to communicate with the desired audio frequency.  Figure 315. I   2   S clock generator architecture  1.   Where x can be 2 or 3.  MS30108V1 16-or 32-bit left channel 16-or 32-bit right channel 32- or 64-bits sampling point   sampling point F S F S   : audio sampling frequency  MS30109V1 MCKOE ODD 8-bit linear divider + reshaping stage Divider by 4   Div2 I²SDIV[7:0] I²SMOD CHLEN 0 1 0 1 MCKOE CK MCK I²SxCLK

RM0490 Rev 5   867/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Figure 315   presents the communication clock architecture. The I2SxCLK clock is provided by the reset and clock controller (RCC) of the product. The I2SxCLK clock can be asynchronous with respect to the SPI/I2S APB clock.  Warning:   In addition, it is mandatory to keep the I2SxCLK frequency higher or equal to the APB clock used by the SPI/I2S block. If this condition is not respected the SPI/I2S does not work properly.  The audio sampling frequency may be 192 kHz, 96 kHz, 48 kHz, 44.1 kHz, 32 kHz, 22.05 kHz, 16 kHz, 11.025 kHz or 8 kHz (or any other value within this range). In order to reach the desired frequency, the linear divider needs to be programmed according to the formulas below:  For I 2 S modes:  When the master clock is generated (MCKOE in the SPIx_I2SPR register is set): When the master clock is disabled (MCKOE bit cleared): CHLEN = 0 when the channel frame is 16-bit wide and, CHLEN = 1 when the channel frame is 32-bit wide.  For PCM modes:  When the master clock is generated (MCKOE in the SPIx_I2SPR register is set): When the master clock is disabled (MCKOE bit cleared): CHLEN = 0 when the channel frame is 16-bit wide and, CHLEN = 1 when the channel frame is 32-bit wide. Where F   S   is the audio sampling frequency, and F I2SxCLK   is the frequency of the kernel clock provided to the SPI/I2S block. Fs   F   I2SxCLK 256   2 ( (   I2SDIV   ) ×   ODD   ) + ×  ---------------------------------------------------------------------------------------------------------- - =  Fs   F   I2SxCLK 32   CHLEN   1   ) + ( ×   2 ( (   I2SDIV   ) ×   ODD   ) + ×  ----------------------------------------------------------------------------------------------------------------------------------------------------------------- - =  Fs   F   I2SxCLK 128   2 ( (   I2SDIV   ) ×   ODD   ) + ×  ---------------------------------------------------------------------------------------------------------- - =  Fs   F   I2SxCLK 16   CHLEN   1   ) + ( ×   2 ( (   I2SDIV   ) ×   ODD   ) + ×  ----------------------------------------------------------------------------------------------------------------------------------------------------------------- - =

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  868/1027   RM0490 Rev 5  Note:   I2SDIV must be strictly higher than 1.  The following table provides example precision values for different clock configurations.  Note:   Other configurations are possible that allow optimum clock precision.  Table 136. Audio-frequency precision using 48 MHz clock derived from HSE (1) SYSCLK (MHz) Data length   I2SDIV   I2SODD   MCLK   Target fs (Hz)   Real fs (kHz)   Error  48   16   8   0   No   96000   93750   2.3438% 48   32   4   0   No   96000   93750   2.3438% 48   16   15   1   No   48000   48387.0968   0.8065% 48   32   8   0   No   48000   46875   2.3438% 48   16   17   0   No   44100   44117.647   0.0400% 48   32   8   1   No   44100   44117.647   0.0400% 48   16   23   1   No   32000   31914.8936   0.2660% 48   32   11   1   No   32000   32608.696   1.9022% 48   16   34   0   No   22050   22058.8235   0.0400% 48   32   17   0   No   22050   22058.8235   0.0400% 48   16   47   0   No   16000   15957.4468   0.2660% 48   32   23   1   No   16000   15957.447   0.2660% 48   16   68   0   No   11025   11029.4118   0.0400% 48   32   34   0   No   11025   11029.412   0.0400% 48   16   94   0   No   8000   7978.7234   0.2660% 48   32   47   0   No   8000   7978.7234   0.2660% 48   16   2   0   Yes   48000   46875   2.3430% 48   32   2   0   Yes   48000   46875   2.3430% 48   16   2   0   Yes   44100   46875   6.2925% 48   32   2   0   Yes   44100   46875   6.2925% 48   16   3   0   Yes   32000   31250   2.3438% 48   32   3   0   Yes   32000   31250   2.3438% 48   16   4   1   Yes   22050   20833.333   5.5178% 48   32   4   1   Yes   22050   20833.333   5.5178% 48   16   6   0   Yes   16000   15625   2.3438% 48   32   6   0   Yes   16000   15625   2.3438% 48   16   8   1   Yes   11025   11029.4118   0.0400% 48   32   8   1   Yes   11025   11029.4118   0.0400% 48   16   11   1   Yes   8000   8152.17391   1.9022% 48   32   11   1   Yes   8000   8152.17391   1.9022%

RM0490 Rev 5   869/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  27.7.5   I 2   S master mode  The I2S can be configured in master mode. This means that the serial clock is generated on the CK pin as well as the Word Select signal WS. Master clock (MCK) may be output or not, controlled by the MCKOE bit in the SPIx_I2SPR register.  Procedure  1.   Select the I2SDIV[7:0] bits in the SPIx_I2SPR register to define the serial clock baud rate to reach the proper audio sample frequency. The ODD bit in the SPIx_I2SPR register also has to be defined. 2.   Select the CKPOL bit to define the steady level for the communication clock. Set the MCKOE bit in the SPIx_I2SPR register if the master clock MCK needs to be provided to the external DAC/ADC audio component (the I2SDIV and ODD values should be computed depending on the state of the MCK output, for more details refer to  Section 27.7.4: Clock generator ). 3.   Set the I2SMOD bit in the SPIx_I2SCFGR register to activate the I2S functions and choose the I 2   S standard through the I2SSTD[1:0] and PCMSYNC bits, the data length through the DATLEN[1:0] bits and the number of bits per channel by configuring the CHLEN bit. Select also the I 2   S master mode and direction (Transmitter or Receiver) through the I2SCFG[1:0] bits in the SPIx_I2SCFGR register. 4.   If needed, select all the potential interrupt sources and the DMA capabilities by writing the SPIx_CR2 register. 5.   The I2SE bit in SPIx_I2SCFGR register must be set. WS and CK are configured in output mode. MCK is also an output, if the MCKOE bit in SPIx_I2SPR is set.  Transmission sequence  The transmission sequence begins when a half-word is written into the Tx buffer. Lets assume the first data written into the Tx buffer corresponds to the left channel data. When data are transferred from the Tx buffer to the shift register, TXE is set and data corresponding to the right channel have to be written into the Tx buffer. The CHSIDE flag indicates which channel is to be transmitted. It has a meaning when the TXE flag is set because the CHSIDE flag is updated when TXE goes high. A full frame has to be considered as a left channel data transmission followed by a right channel data transmission. It is not possible to have a partial frame where only the left channel is sent. The data half-word is parallel loaded into the 16-bit shift register during the first bit transmission, and then shifted out, serially, to the MOSI/SD pin, MSB first. The TXE flag is set after each transfer from the Tx buffer to the shift register and an interrupt is generated if the TXEIE bit in the SPIx_CR2 register is set. For more details about the write operations depending on the I   2   S standard mode selected, refer to   Section 27.7.2: Supported audio protocols ). To ensure a continuous audio data transmission, it is mandatory to write the SPIx_DR register with the next data to transmit before the end of the current transmission. 1.   This table gives only example values for different clock configurations. Other configurations allowing optimum clock precision are possible.

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  870/1027   RM0490 Rev 5  To switch off the I2S, by clearing I2SE, it is mandatory to wait for TXE = 1 and BSY = 0.  Reception sequence  The operating mode is the same as for transmission mode except for the point 3 (refer to the procedure described in   Section 27.7.5: I   2   S master mode ), where the configuration should set the master reception mode through the I2SCFG[1:0] bits. Whatever the data or channel length, the audio data are received by 16-bit packets. This means that each time the Rx buffer is full, the RXNE flag is set and an interrupt is generated if the RXNEIE bit is set in SPIx_CR2 register. Depending on the data and channel length configuration, the audio value received for a right or left channel may result from one or two receptions into the Rx buffer. Clearing the RXNE bit is performed by reading the SPIx_DR register. CHSIDE is updated after each reception. It is sensitive to the WS signal generated by the I2S cell. For more details about the read operations depending on the I   2   S standard mode selected, refer to   Section 27.7.2: Supported audio protocols . If data are received while the previously received data have not been read yet, an overrun is generated and the OVR flag is set. If the ERRIE bit is set in the SPIx_CR2 register, an interrupt is generated to indicate the error. To switch off the I2S, specific actions are required to ensure that the I2S completes the transfer cycle properly without initiating a new data transfer. The sequence depends on the configuration of the data and channel lengths, and on the audio protocol mode selected. In the case of:  •   16-bit data length extended on 32-bit channel length (DATLEN = 00 and CHLEN = 1) using the LSB justified mode (I2SSTD = 10) a)   Wait for the second to last RXNE = 1 (n – 1) b)   Then wait 17 I2S clock cycles (using a software loop) c)   Disable the I2S (I2SE = 0)  •   16-bit data length extended on 32-bit channel length (DATLEN = 00 and CHLEN = 1) in MSB justified, I 2   S or PCM modes (I2SSTD = 00, I2SSTD = 01 or I2SSTD = 11, respectively) a)   Wait for the last RXNE b)   Then wait 1 I2S clock cycle (using a software loop) c)   Disable the I2S (I2SE = 0)  •   For all other combinations of DATLEN and CHLEN, whatever the audio mode selected through the I2SSTD bits, carry out the following sequence to switch off the I2S: a)   Wait for the second to last RXNE = 1 (n – 1) b)   Then wait one I2S clock cycle (using a software loop) c)   Disable the I2S (I2SE = 0)  Note:   The BSY flag is kept low during transfers.  27.7.6   I 2   S slave mode  For the slave configuration, the I2S can be configured in transmission or reception mode. The operating mode is following mainly the same rules as described for the I   2   S master

RM0490 Rev 5   871/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  configuration. In slave mode, there is no clock to be generated by the I2S interface. The clock and WS signals are input from the external master connected to the I2S interface. There is then no need, for the user, to configure the clock. The configuration steps to follow are listed below: 1.   Set the I2SMOD bit in the SPIx_I2SCFGR register to select I   2   S mode and choose the I 2   S standard through the I2SSTD[1:0] bits, the data length through the DATLEN[1:0] bits and the number of bits per channel for the frame configuring the CHLEN bit. Select also the mode (transmission or reception) for the slave through the I2SCFG[1:0] bits in SPIx_I2SCFGR register. 2.   If needed, select all the potential interrupt sources and the DMA capabilities by writing the SPIx_CR2 register. 3.   The I2SE bit in SPIx_I2SCFGR register must be set.  Transmission sequence  The transmission sequence begins when the external master device sends the clock and when the NSS_WS signal requests the transfer of data. The slave has to be enabled before the external master starts the communication. The I2S data register has to be loaded before the master initiates the communication. For the I2S, MSB justified and LSB justified modes, the first data item to be written into the data register corresponds to the data for the left channel. When the communication starts, the data are transferred from the Tx buffer to the shift register. The TXE flag is then set in order to request the right channel data to be written into the I2S data register. The CHSIDE flag indicates which channel is to be transmitted. Compared to the master transmission mode, in slave mode, CHSIDE is sensitive to the WS signal coming from the external master. This means that the slave needs to be ready to transmit the first data before the clock is generated by the master. WS assertion corresponds to left channel transmitted first.  Note:   The I2SE has to be written at least two PCLK cycles before the first clock of the master comes on the CK line.  The data half-word is parallel-loaded into the 16-bit shift register (from the internal bus) during the first bit transmission, and then shifted out serially to the MOSI/SD pin MSB first. The TXE flag is set after each transfer from the Tx buffer to the shift register and an interrupt is generated if the TXEIE bit in the SPIx_CR2 register is set. Note that the TXE flag should be checked to be at 1 before attempting to write the Tx buffer. For more details about the write operations depending on the I   2   S standard mode selected, refer to   Section 27.7.2: Supported audio protocols . To secure a continuous audio data transmission, it is mandatory to write the SPIx_DR register with the next data to transmit before the end of the current transmission. An underrun flag is set and an interrupt may be generated if the data are not written into the SPIx_DR register before the first clock edge of the next data communication. This indicates to the software that the transferred data are wrong. If the ERRIE bit is set into the SPIx_CR2 register, an interrupt is generated when the UDR flag in the SPIx_SR register goes high. In this case, it is mandatory to switch off the I2S and to restart a data transfer starting from the left channel. To switch off the I2S, by clearing the I2SE bit, it is mandatory to wait for TXE = 1 and BSY = 0.

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  872/1027   RM0490 Rev 5  Reception sequence  The operating mode is the same as for the transmission mode except for the point 1 (refer to the procedure described in   Section 27.7.6: I   2   S slave mode ), where the configuration should set the master reception mode using the I2SCFG[1:0] bits in the SPIx_I2SCFGR register. Whatever the data length or the channel length, the audio data are received by 16-bit packets. This means that each time the RX buffer is full, the RXNE flag in the SPIx_SR register is set and an interrupt is generated if the RXNEIE bit is set in the SPIx_CR2 register. Depending on the data length and channel length configuration, the audio value received for a right or left channel may result from one or two receptions into the RX buffer. The CHSIDE flag is updated each time data are received to be read from the SPIx_DR register. It is sensitive to the external WS line managed by the external master component. Clearing the RXNE bit is performed by reading the SPIx_DR register. For more details about the read operations depending the I 2   S standard mode selected, refer to   Section 27.7.2: Supported audio protocols . If data are received while the preceding received data have not yet been read, an overrun is generated and the OVR flag is set. If the bit ERRIE is set in the SPIx_CR2 register, an interrupt is generated to indicate the error. To switch off the I2S in reception mode, I2SE has to be cleared immediately after receiving the last RXNE = 1.  Note:   The external master components should have the capability of sending/receiving data in 16- bit or 32-bit packets via an audio channel.  27.7.7   I2S status flags  Three status flags are provided for the application to fully monitor the state of the I2S bus.  Busy flag (BSY)  The BSY flag is set and cleared by hardware (writing to this flag has no effect). It indicates the state of the communication layer of the I2S. When BSY is set, it indicates that the I2S is busy communicating. There is one exception in master receive mode (I2SCFG = 11) where the BSY flag is kept low during reception. The BSY flag is useful to detect the end of a transfer if the software needs to disable the I2S. This avoids corrupting the last transfer. For this, the procedure described below must be strictly respected. The BSY flag is set when a transfer starts, except when the I2S is in master receiver mode. The BSY flag is cleared:  •   When a transfer completes (except in master transmit mode, in which the communication is supposed to be continuous)  •   When the I2S is disabled When communication is continuous:  •   In master transmit mode, the BSY flag is kept high during all the transfers  •   In slave mode, the BSY flag goes low for one I2S clock cycle between each transfer  Note:   Do not use the BSY flag to handle each data transmission or reception. It is better to use the TXE and RXNE flags instead.

RM0490 Rev 5   873/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Tx buffer empty flag (TXE)  When set, this flag indicates that the Tx buffer is empty and the next data to be transmitted can then be loaded into it. The TXE flag is reset when the Tx buffer already contains data to be transmitted. It is also reset when the I2S is disabled (I2SE bit is reset).  RX buffer not empty (RXNE)  When set, this flag indicates that there are valid received data in the RX Buffer. It is reset when SPIx_DR register is read.  Channel Side flag (CHSIDE)  In transmission mode, this flag is refreshed when TXE goes high. It indicates the channel side to which the data to transfer on SD has to belong. In case of an underrun error event in slave transmission mode, this flag is not reliable and I2S needs to be switched off and switched on before resuming the communication. In reception mode, this flag is refreshed when data are received into SPIx_DR. It indicates from which channel side data have been received. Note that in case of error (like OVR) this flag becomes meaningless and the I2S should be reset by disabling and then enabling it (with configuration if it needs changing). This flag has no meaning in the PCM standard (for both Short and Long frame modes). When the OVR or UDR flag in the SPIx_SR is set and the ERRIE bit in SPIx_CR2 is also set, an interrupt is generated. This interrupt can be cleared by reading the SPIx_SR status register (once the interrupt source has been cleared).  27.7.8   I2S error flags  There are three error flags for the I2S cell.  Underrun flag (UDR)  In slave transmission mode this flag is set when the first clock for data transmission appears while the software has not yet loaded any value into SPIx_DR. It is available when the I2SMOD bit in the SPIx_I2SCFGR register is set. An interrupt may be generated if the ERRIE bit in the SPIx_CR2 register is set. The UDR bit is cleared by a read operation on the SPIx_SR register.  Overrun flag (OVR)  This flag is set when data are received and the previous data have not yet been read from the SPIx_DR register. As a result, the incoming data are lost. An interrupt may be generated if the ERRIE bit is set in the SPIx_CR2 register. In this case, the receive buffer contents are not updated with the newly received data from the transmitter device. A read operation to the SPIx_DR register returns the previous correctly received data. All other subsequently transmitted half-words are lost. Clearing the OVR bit is done by a read operation on the SPIx_DR register followed by a read access to the SPIx_SR register.  Frame error flag (FRE)  This flag can be set by hardware only if the I2S is configured in Slave mode. It is set if the external master is changing the WS line while the slave is not expecting this change. If the

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  874/1027   RM0490 Rev 5  synchronization is lost, the following steps are required to recover from this state and resynchronize the external master device with the I2S slave device: 1.   Disable the I2S. 2.   Enable it again when the correct level is detected on the WS line (WS line is high in I 2   S mode or low for MSB- or LSB-justified or PCM modes. Desynchronization between master and slave devices may be due to noisy environment on the CK communication clock or on the WS frame synchronization line. An error interrupt can be generated if the ERRIE bit is set. The desynchronization flag (FRE) is cleared by software when the status register is read.  27.7.9   DMA features  In I   2   S mode, the DMA works in exactly the same way as it does in SPI mode. There is no difference except that the CRC feature is not available in I   2   S mode since there is no data transfer protection system.  27.8   I2S interrupts  Table 137   provides the list of I2S interrupts.  Table 137. I2S interrupt requests Interrupt event   Event flag   Enable control bit  Transmit buffer empty flag   TXE   TXEIE Receive buffer not empty flag   RXNE   RXNEIE Overrun error   OVR ERRIE Underrun error   UDR Frame error flag   FRE

RM0490 Rev 5   875/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  27.9   SPI and I2S registers  The peripheral registers can be accessed by half-words (16-bit) or words (32-bit). SPI_DR in addition can be accessed by 8-bit access.  27.9.1   SPI control register 1 (SPIx_CR1)  Address offset: 0x00 Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 BIDI MODE   BIDIOE   CRC EN CRCN EXT   CRCL   RX ONLY   SSM   SSI   LSB FIRST   SPE   BR[2:0]   MSTR   CPOL   CPHA rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 15   BIDIMODE:   Bidirectional data mode enable. This bit enables half-duplex communication using common single bidirectional data line. Keep RXONLY bit clear when bidirectional mode is active.  0: 2-line unidirectional data mode selected  1: 1-line bidirectional data mode selected  Note:   This bit is not used in I   2   S mode.  Bit 14   BIDIOE:   Output enable in bidirectional mode This bit combined with the BIDIMODE bit selects the direction of transfer in bidirectional mode. 0: Output disabled (receive-only mode) 1: Output enabled (transmit-only mode)  Note:   In master mode, the MOSI pin is used and in slave mode, the MISO pin is used. This bit is not used in I   2   S mode.  Bit 13   CRCEN:   Hardware CRC calculation enable 0: CRC calculation disabled 1: CRC calculation enabled  Note:   This bit should be written only when SPI is disabled (SPE = ‘0’) for correct operation. This bit is not used in I   2   S mode.  Bit 12   CRCNEXT:   Transmit CRC next 0: Next transmit value is from Tx buffer. 1: Next transmit value is from Tx CRC register.  Note:   This bit has to be written as soon as the last data is written in the SPIx_DR register. This bit is not used in I   2   S mode.  Bit 11   CRCL:   CRC length This bit is set and cleared by software to select the CRC length. 0: 8-bit CRC length 1: 16-bit CRC length  Note:   This bit should be written only when SPI is disabled (SPE = ‘0’) for correct operation. This bit is not used in I   2   S mode.

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  876/1027   RM0490 Rev 5  Bit 10   RXONLY:   Receive only mode enabled. This bit enables simplex communication using a single unidirectional line to receive data exclusively. Keep BIDIMODE bit clear when receive only mode is active.This bit is also useful in a multislave system in which this particular slave is not accessed, the output from the accessed slave is not corrupted. 0: Full-duplex (Transmit and receive) 1: Output disabled (Receive-only mode)  Note:   This bit is not used in I   2   S mode.  Bit 9   SSM:   Software slave management When the SSM bit is set, the NSS pin input is replaced with the value from the SSI bit. 0: Software slave management disabled 1: Software slave management enabled  Note:   This bit is not used in I 2   S mode   and SPI TI mode.  Bit 8   SSI:   Internal slave select This bit has an effect only when the SSM bit is set. The value of this bit is forced onto the NSS pin and the I/O value of the NSS pin is ignored.  Note:   This bit is not used in I 2   S mode   and SPI TI mode.  Bit 7   LSBFIRST :   Frame format 0: data is transmitted / received with the MSB first 1: data is transmitted / received with the LSB first  Note:   1. This bit should not be changed when communication is ongoing. 2. This bit is not used in I 2   S mode   and SPI TI mode.  Bit 6   SPE:   SPI enable 0: Peripheral disabled 1: Peripheral enabled  Note:   When disabling the SPI, follow the procedure described in Procedure for disabling the SPI on page 841. This bit is not used in I   2   S mode.  Bits 5:3   BR[2:0]:   Baud rate control 000: f   PCLK /2 001: f   PCLK /4 010: f   PCLK /8 011: f   PCLK   /16 100: f   PCLK /32 101: f   PCLK /64 110: f   PCLK   /128 111: f   PCLK   /256  Note:   These bits should not be changed when communication is ongoing. These bits are not used in I   2 S mode.  Bit 2   MSTR:   Master selection  0: Slave configuration 1: Master configuration  Note:   This bit should not be changed when communication is ongoing. This bit is not used in I   2   S mode.

RM0490 Rev 5   877/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  27.9.2   SPI control register 2 (SPIx_CR2)  Address offset: 0x04 Reset value: 0x0700 Bit 1   CPOL:   Clock polarity  0: CK to 0 when idle 1: CK to 1 when idle  Note:   This bit should not be changed when communication is ongoing. This bit is not used in I 2   S mode   and SPI TI mode except the case when CRC is applied at TI mode.  Bit 0   CPHA:   Clock phase  0: The first clock transition is the first data capture edge 1: The second clock transition is the first data capture edge  Note:   This bit should not be changed when communication is ongoing. This bit is not used in I 2   S mode   and SPI TI mode except the case when CRC is applied at TI mode.  15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   LDMA _TX LDMA _RX FRXT H   DS[3:0]   TXEIE   RXNEIE   ERRIE   FRF   NSSP   SSOE   TXDMAEN   RXDMAEN rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bit 15   Reserved, must be kept at reset value. Bit 14   LDMA_TX:   Last DMA transfer for transmission This bit is used in data packing mode, to define if the total number of data to transmit by DMA is odd or even. It has significance only if the TXDMAEN bit in the SPIx_CR2 register is set and if packing mode is used (data length =< 8-bit and write access to SPIx_DR is 16-bit wide). It has to be written when the SPI is disabled (SPE = 0 in the SPIx_CR1 register). 0: Number of data to transfer is even 1: Number of data to transfer is odd  Note:   Refer to Procedure for disabling the SPI on page 841 if the CRCEN bit is set. This bit is not used in I²S mode.  Bit 13   LDMA_RX : Last DMA transfer for reception Th is bit is used in data packing mode, to define if the total number of data to receive by DMA is odd or even. It has significance only if the RXDMAEN bit in the SPIx_CR2 register is set and if packing mode is used (data length =< 8-bit and write access to SPIx_DR is 16-bit wide). It has to be written when the SPI is disabled (SPE = 0 in the SPIx_CR1 register). 0: Number of data to transfer is even 1: Number of data to transfer is odd  Note:   Refer to Procedure for disabling the SPI on page 841 if the CRCEN bit is set. This bit is not used in I²S mode.  Bit 12   FRXTH : FIFO reception threshold This bit is used to set the threshold of the RXFIFO that triggers an RXNE event 0: RXNE event is generated if the FIFO level is greater than or equal to 1/2 (16-bit) 1: RXNE event is generated if the FIFO level is greater than or equal to 1/4 (8-bit)  Note:   This bit is not used in I 2 S mode.

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  878/1027   RM0490 Rev 5  Bits 11:8   DS[3:0] : Data size These bits configure the data length for SPI transfers. 0000: Not used 0001: Not used 0010: Not used 0011: 4-bit 0100: 5-bit 0101: 6-bit 0110: 7-bit 0111: 8-bit 1000: 9-bit 1001: 10-bit 1010: 11-bit 1011: 12-bit 1100: 13-bit 1101: 14-bit 1110: 15-bit 1111: 16-bit If software attempts to write one of the “Not used” values, they are forced to the value “0111” (8-bit)  Note:   These bits are not used in I 2   S mode.  Bit 7   TXEIE:   Tx buffer empty interrupt enable 0: TXE interrupt masked 1: TXE interrupt not masked. Used to generate an interrupt request when the TXE flag is set. Bit 6   RXNEIE:   RX buffer not empty interrupt enable 0: RXNE interrupt masked 1: RXNE interrupt not masked. Used to generate an interrupt request when the RXNE flag is set. Bit 5   ERRIE:   Error interrupt enable This bit controls the generation of an interrupt when an error condition occurs (CRCERR, OVR, MODF in SPI mode, FRE at TI mode and UDR, OVR, and FRE in I   2 S mode). 0: Error interrupt is masked 1: Error interrupt is enabled Bit 4   FRF : Frame format 0: SPI Motorola mode 1 SPI TI mode  Note:   This bit must be written only when the SPI is disabled (SPE=0). This bit is not used in I 2 S mode.  Bit 3   NSSP :   NSS pulse management This bit is used in master mode only. it allows the SPI to generate an NSS pulse between two consecutive data when doing continuous transfers. In the case of a single data transfer, it forces the NSS pin high level after the transfer. It has no meaning if CPHA = ’1’, or FRF = ’1’. 0: No NSS pulse 1: NSS pulse generated  Note:   1. This bit must be written only when the SPI is disabled (SPE=0). 2. This bit is not used in I 2   S mode and SPI TI mode.

RM0490 Rev 5   879/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  27.9.3   SPI status register (SPIx_SR)  Address offset: 0x08 Reset value: 0x0002 Bit 2   SSOE:   SS output enable 0: SS output is disabled in master mode and the SPI interface can work in multimaster configuration 1: SS output is enabled in master mode and when the SPI interface is enabled. The SPI interface cannot work in a multimaster environment.  Note:   This bit is not used in I 2 S mode   and SPI TI mode.  Bit 1   TXDMAEN:   Tx buffer DMA enable When this bit is set, a DMA request is generated whenever the TXE flag is set. 0: Tx buffer DMA disabled 1: Tx buffer DMA enabled Bit 0   RXDMAEN:   Rx buffer DMA enable When this bit is set, a DMA request is generated whenever the RXNE flag is set. 0: Rx buffer DMA disabled 1: Rx buffer DMA enabled 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   FTLVL[1:0]   FRLVL[1:0]   FRE   BSY   OVR   MODF   CRCE RR   UDR   CHSIDE   TXE   RXNE r   r   r   r   r   r   r   r   rc_w0   r   r   r   r Bits 15:13   Reserved, must be kept at reset value. Bits 12:11   FTLVL[1:0]:   FIFO transmission level These bits are set and cleared by hardware. 00: FIFO empty 01: 1/4 FIFO 10: 1/2 FIFO 11: FIFO full (considered as FULL when the FIFO threshold is greater than 1/2)  Note:   This bit is not used in I   2 S mode.  Bits 10:9   FRLVL[1:0] : FIFO reception level These bits are set and cleared by hardware. 00: FIFO empty 01: 1/4 FIFO 10: 1/2 FIFO 11: FIFO full  Note:   These bits are not used in I²S mode and in SPI receive-only mode while CRC calculation is enabled.  Bit 8   FRE : Frame format error This flag is used for SPI in TI slave mode and I   2   S slave mode. Refer to   Section 27.5.11: SPI error flags   and   Section 27.7.8: I2S error flags . This flag is set by hardware and reset when SPIx_SR is read by software. 0: No frame format error 1: A frame format error occurred

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  880/1027   RM0490 Rev 5  Bit 7   BSY:   Busy flag 0:   SPI (or I2S) not busy 1: SPI (or I2S) is busy in communication or Tx buffer is not empty This flag is set and cleared by hardware.  Note:   The BSY flag must be used with caution: refer to Section 27.5.10: SPI status flags and Procedure for disabling the SPI on page 841.  Bit 6   OVR:   Overrun flag 0: No overrun occurred 1: Overrun occurred This flag is set by hardware and reset by a software sequence. Refer to   I2S error flags on page 873   for the software sequence. Bit 5   MODF:   Mode fault 0: No mode fault occurred 1: Mode fault occurred This flag is set by hardware and reset by a software sequence. Refer to   Section : Mode fault (MODF) on page 851   for the software sequence.  Note:   This bit is not used in I   2 S mode.  Bit 4   CRCERR:   CRC error flag 0: CRC value received matches the SPIx_RXCRCR value 1: CRC value received does not match the SPIx_RXCRCR value Note:   This flag is set by hardware and cleared by software writing 0.  This bit is not used in I   2 S mode.  Bit 3   UDR:   Underrun flag 0: No underrun occurred 1: Underrun occurred This flag is set by hardware and reset by a software sequence. Refer to   I2S error flags on page 873   for the software sequence.  Note:   This bit is not used in SPI mode.  Bit 2   CHSIDE : Channel side 0: Channel Left has to be transmitted or has been received 1: Channel Right has to be transmitted or has been received  Note:   This bit is not used in SPI mode. It has no significance in PCM mode.  Bit 1   TXE:   Transmit buffer empty 0: Tx buffer not empty 1: Tx buffer empty Bit 0   RXNE:   Receive buffer not empty 0: Rx buffer empty 1: Rx buffer not empty

RM0490 Rev 5   881/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  27.9.4   SPI data register (SPIx_DR)  Address offset: 0x0C Reset value: 0x0000  27.9.5   SPI CRC polynomial register (SPIx_CRCPR)  Address offset: 0x10 Reset value: 0x0007  Note:   The polynomial value should be odd only. No even value is supported.  27.9.6   SPI Rx CRC register (SPIx_RXCRCR)  Address offset: 0x14 Reset value: 0x0000 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 DR[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   DR[15:0]:   Data register Data received or to be transmitted The data register serves as an interface between the Rx and Tx FIFOs. When the data register is read, RxFIFO is accessed while the write to data register accesses TxFIFO (See  Section 27.5.9: Data transmission and reception procedures ).  Note:   Data is always right-aligned. Unused bits are ignored when writing to the register, and read as zero when the register is read. The Rx threshold setting must always correspond with the read access currently used.  15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CRCPOLY[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:0   CRCPOLY[15:0]:   CRC polynomial register This register contains the polynomial for the CRC calculation. The CRC polynomial (0x0007) is the reset value of this register. Another polynomial can be configured as required. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 RXCRC[15:0] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  882/1027   RM0490 Rev 5  27.9.7   SPI Tx CRC register (SPIx_TXCRCR)  Address offset: 0x18 Reset value: 0x0000  27.9.8   SPIx_I2S configuration register (SPIx_I2SCFGR)  Address offset: 0x1C Reset value: 0x0000 Bits 15:0   RXCRC[15:0]:   Rx CRC register When CRC calculation is enabled, the RXCRC[15:0] bits contain the computed CRC value of the subsequently received bytes. This register is reset when the CRCEN bit in SPIx_CR1 register is written to 1. The CRC is calculated serially using the polynomial programmed in the SPIx_CRCPR register. Only the 8 LSB bits are considered when the CRC frame format is set to be 8-bit length (CRCL bit in the SPIx_CR1 is cleared). CRC calculation is done based on any CRC8 standard. The entire 16-bits of this register are considered when a 16-bit CRC frame format is selected (CRCL bit in the SPIx_CR1 register is set). CRC calculation is done based on any CRC16 standard.  Note:   A read to this register when the BSY Flag is set could return an incorrect value. These bits are not used in I 2 S mode.  15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 TXCRC[15:0] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r Bits 15:0   TXCRC[15:0]:   Tx CRC register When CRC calculation is enabled, the TXCRC[7:0] bits contain the computed CRC value of the subsequently transmitted bytes. This register is reset when the CRCEN bit of SPIx_CR1 is written to 1. The CRC is calculated serially using the polynomial programmed in the SPIx_CRCPR register. Only the 8 LSB bits are considered when the CRC frame format is set to be 8-bit length (CRCL bit in the SPIx_CR1 is cleared). CRC calculation is done based on any CRC8 standard. The entire 16-bits of this register are considered when a 16-bit CRC frame format is selected (CRCL bit in the SPIx_CR1 register is set). CRC calculation is done based on any CRC16 standard.  Note:   A read to this register when the BSY flag is set could return an incorrect value. These bits are not used in I   2 S mode.  15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   ASTR TEN   I2SMOD   I2SE   I2SCFG[1:0]   PCMSYNC   Res.   I2SSTD[1:0]   CKPOL   DATLEN[1:0]   CHLEN rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:13   Reserved, must be kept at reset value.

RM0490 Rev 5   883/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Bit 12   ASTRTEN : Asynchronous start enable. 0: The Asynchronous start is disabled. When the I2S is enabled in slave mode, the hardware starts the transfer when the I2S clock is received and an appropriate transition is detected on the WS signal. 1: The Asynchronous start is enabled. When the I2S is enabled in slave mode, the hardware starts the transfer when the I2S clock is received and the appropriate level is detected on the WS signal.  Note:   The appropriate   transition   is a falling edge on WS signal when I 2   S Philips Standard is used, or a rising edge for other standards. The appropriate   level   is a low level on WS signal when I 2   S Philips Standard is used, or a high level for other standards. Please refer to Section 27.7.3: Start-up description for additional information.  Bit 11   I2SMOD : I2S mode selection 0: SPI mode is selected 1: I2S mode is selected  Note:   This bit should be configured when the SPI is disabled.  Bit 10   I2SE : I2S enable 0: I2S peripheral is disabled 1: I2S peripheral is enabled  Note:   This bit is not used in SPI mode.  Bits 9:8   I2SCFG[1:0] :   I2S configuration mode 00: Slave - transmit 01: Slave - receive 10: Master - transmit 11: Master - receive  Note:   These bits should be configured when the I2S is disabled. They are not used in SPI mode.  Bit 7   PCMSYNC : PCM frame synchronization 0: Short frame synchronization 1: Long frame synchronization  Note:   This bit has a meaning only if I2SSTD = 11 (PCM standard is used). It is not used in SPI mode.  Bit 6   Reserved, must be kept at reset value. Bits 5:4   I2SSTD[1:0] : I2S standard selection 00: I   2 S Philips standard 01: MSB justified standard (left justified) 10: LSB justified standard (right justified) 11: PCM standard For more details on I   2   S standards, refer to   Section 27.7.2 on page 857 Note:   For correct operation, these bits should be configured when the I2S is disabled. They are not used in SPI mode.

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  884/1027   RM0490 Rev 5  27.9.9   SPIx_I2S prescaler register (SPIx_I2SPR)  Address offset: 0x20 Reset value: 0x0002 Bit 3   CKPOL : Inactive state clock polarity 0: I2S clock inactive state is low level 1: I2S clock inactive state is high level  Note:   For correct operation, this bit should be configured when the I2S is disabled. It is not used in SPI mode. The bit CKPOL does not affect the CK edge sensitivity used to receive or transmit the SD and WS signals.  Bits 2:1   DATLEN[1:0] : Data length to be transferred 00: 16-bit data length 01: 24-bit data length 10: 32-bit data length 11: Not allowed  Note:   For correct operation, these bits should be configured when the I2S is disabled. They are not used in SPI mode.  Bit 0   CHLEN : Channel length (number of bits per audio channel) 0: 16-bit wide 1: 32-bit wide The bit write operation has a meaning only if DATLEN = 00 otherwise the channel length is fixed to 32-bit by hardware whatever the value filled in.  Note:   For correct operation, this bit should be configured when the I2S is disabled. It is not used in SPI mode.  15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   MCKOE   ODD   I2SDIV[7:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 15:10   Reserved, must be kept at reset value. Bit 9   MCKOE : Master clock output enable 0: Master clock output is disabled 1: Master clock output is enabled  Note:   This bit should be configured when the I2S is disabled. It is used only when the I2S is in master mode. It is not used in SPI mode.  Bit 8   ODD : Odd factor for the prescaler 0: Real divider value is = I2SDIV *2 1: Real divider value is = (I2SDIV * 2) + 1 Refer to   Section 27.7.3 on page 864 .  Note:   This bit should be configured when the I2S is disabled. It is used only when the I2S is in master mode. It is not used in SPI mode.

RM0490 Rev 5   885/1027  RM0490   Serial peripheral interface / integrated interchip sound (SPI/I2S)  886  Bits 7:0   I2SDIV[7:0] : I2S linear prescaler I2SDIV [7:0] = 0 or I2SDIV [7:0] = 1 are forbidden values. Refer to   Section 27.7.3 on page 864 .  Note:   These bits should be configured when the I2S is disabled. They are used only when the I2S is in master mode. They are not used in SPI mode.

Serial peripheral interface / integrated interchip sound (SPI/I2S)   RM0490  886/1027   RM0490 Rev 5  27.9.10   SPI/I2S register map  Table 138   shows the SPI/I2S register map and reset values. Refer to   Section 2.2 on page 45   for the register boundary addresses.  Table 138. SPI/I2S register map and reset values Offset   Register name reset value 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00 SPIx_CR1 BIDIMODE BIDIOE CRCEN CRCNEXT CRCL RXONLY SSM SSI LSBFIRST SPE BR [2:0] MSTR CPOL CPHA Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x04 SPIx_CR2 Res. LDMA_TX LDMA_RX FRXTH DS[3:0] TXEIE RXNEIE ERRIE FRF NSSP SSOE TXDMAEN RXDMAEN Reset value   0   0   0   0   1   1   1   0   0   0   0   0   0   0   0 0x08 SPIx_SR Res. Res. Res. FTLVL[1:0] FRLVL[1:0] FRE BSY OVR MODF CRCERR UDR CHSIDE TXE RXNE Reset value   0   0   0   0   0   0   0   0   0   0   0   1   0 0x0C SPIx_DR   DR[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x10 SPIx_CRCPR   CRCPOLY[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   1   1   1 0x14 SPIx_RXCRCR   RXCRC[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x18 SPIx_TXCRCR   TXCRC[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x1C SPIx_I2SCFGR Res. Res. Res. ASTRTEN I2SMOD I2SE I2SCFG[1:0] PCMSYNC Res. I2SSTD CKPOL DATLEN[1:0] CHLEN Reset value   0   0   0   0   0   0   0   0   0   0   0   0 0x20 SPIx_I2SPR Res. Res. Res. Res. Res. Res. MCKOE ODD I2SDIV[7:0] Reset value   0   0   0   0   0   0   0   0   1   0

RM0490 Rev 5   887/1027  RM0490   FD controller area network (FDCAN)  952  28   FD controller area network (FDCAN)  This section applies to STM32C092xx devices only.  28.1   Introduction  The controller area network (CAN) subsystem (see   Figure 316 ) consists of one CAN module, a shared message RAM, and a configuration block. Refer to the memory map for the base address of each of these parts. The modules (FDCAN) are compliant with ISO 11898-1: 2015 (CAN protocol specification version 2.0 part A, B) and CAN FD protocol specification version 1.0. A 0.8-Kbyte message RAM per FDCAN instance is used for filtering, transmitting event FIFOs, and receiving and transmitting FIFOs.

FD controller area network (FDCAN)   RM0490  888/1027   RM0490 Rev 5  Figure 316. CAN subsystem.  MSv51817V4 FDCAN1_TX FDCAN1_RX  Interrupts interface CANFDL RAM Controller / Arbitrer Message RAM interface  CAN core fdcan1_intr0_it fdcan1_intr1_it  TX Handler  TX prioritization Frame synchronization Tx Req   Tx State Rx State Sync Sync fdcan_pclk  Control and Configuration registers RX Handler  Acceptance filter fdcan_ts[0:15] CFG_APB RAM_APB Ctrl_APB  / 1..30  CKDIV Subsystem Configuration register   fdcan_tq_ck 32-bit APB bus fdcan_ker_ck  Message RAM  Buffers FIFOs Filters  Configuration  Kernel clock domain APB clock domain PDIV[3:0]

RM0490 Rev 5   889/1027  RM0490   FD controller area network (FDCAN)  952  28.2   FDCAN main features  •   Conform with CAN protocol version 2.0 part A, B, and ISO 11898-1: 2015  •   CAN FD with maximum 64 data bytes supported  •   CAN error logging  •   AUTOSAR and J1939 support  •   Improved acceptance filtering  •   Two receive FIFOs of three payloads each (up to 64 bytes per payload)  •   Separate signaling on reception of high priority messages  •   Configurable transmit FIFO/queue of three payloads (up to 64 bytes per payload)  •   Transmit event FIFO  •   Programmable loop-back test mode  •   Maskable module interrupts  •   Two clock domains: APB bus interface and CAN core kernel clock  •   Power-down support

FD controller area network (FDCAN)   RM0490  890/1027   RM0490 Rev 5  28.3   FDCAN functional description 28.3.1   FDCAN block diagram Figure 317. FDCAN block diagram Dual interrupt lines  The FDCAN peripheral provides two interrupt lines, fdcan_intr0_it and fdcan_intr1_it. By programming the EINT0 and EINT1 bits of the FDCAN_ILE register, the interrupt lines can be independently enabled or disabled.  CAN core  The CAN core contains the protocol controller and receive/transmit shift registers. It handles all ISO 11898-1: 2015 protocol functions and supports both 11-bit and 29-bit identifiers.  Sync  This block synchronizes signals from the APB clock domain to the CAN kernel clock domain and vice versa.  MSv51819V2 FDCAN_TX FDCAN_RX  Interrupts interface  CANFDL  Message RAM interface  CAN core fdcan_intr0_it fdcan_intr1_it  TX Handler  TX prioritization Frame Synchro Tx Req   Tx State Rx State Sync Sync fdcan_pclk  Control and Configuration registers RX Handler  Acceptance filter fdcan_ts[0:15] Ctrl_APB fdcan_tq_ck Kernel clock domain   APB clock domain

RM0490 Rev 5   891/1027  RM0490   FD controller area network (FDCAN)  952  Tx handler  The Tx handler controls the message transfer from the message RAM to the CAN core. A maximum of three Tx buffers is available for transmission. The Tx buffer can be used as Tx FIFO or as a Tx queue. Tx event FIFO stores Tx timestamps together with the corresponding message ID. Transmit cancellation is also supported.  Rx handler  The Rx handler controls the transfer of received messages from the CAN core to the external message RAM. The Rx handler supports two receive FIFOs, for storage of all messages that have passed acceptance filtering. An Rx timestamp is stored together with each message. Up to 28 filters can be defined for 11-bit IDs; up to eight filters for 29-bit IDs.  APB interface  The APB interface connects the FDCAN to the APB bus for configuration registers, controller configuration, and RAM access.  Message RAM interface  The message RAM interface connects the FDCAN access to an external 1-Kbyte message RAM through a RAM controller/arbiter.  28.3.2   FDCAN pins and internal signals  The CAN subsystem I/O signals and pins are detailed, respectively, in   Table 139 ,   Table 140 , and   Figure 316 .  Table 139. CAN subsystem I/O signals Name   Type   Description  fdcan_ker_ck   Digital input   CAN subsystem kernel clock input fdcan_pclk   CAN subsystem APB interface clock input fdcan_intr0_it   Digital output   FDCAN interrupt0 fdcan_intr1_it   FDCAN interrupt1 fdcan_ts[0:15]   -   External timestamp vector APB interface   Digital input/output   Single APP with multiple psel for configuration, control and RAM access  Table 140. CAN subsystem I/O pins Name   Type   Description  FDCAN_RX   Digital input   FDCAN receive pin FDCAN_TX   Digital output   FDCAN transmit pin

FD controller area network (FDCAN)   RM0490  892/1027   RM0490 Rev 5  28.3.3   Bit timing  The bit timing logic monitors the serial bus-line and performs sampling and adjustment of the sample point by synchronizing on the start-bit edge and resynchronizing on the following edges. As shown in   Figure 318 , this operation can be explained simply by splitting the bit time in three segments, as follows:  •   Synchronization segment (SYNC_SEG): a bit change is expected to occur within this time segment, having a fixed length of one time quantum (1 × t q   ).  •   Bit segment 1 (BS1): defines the location of the sample point. It includes the PROP_SEG and PHASE_SEG1 of the CAN standard. Its duration is programmable from 1 to 16 time quanta, but can be automatically lengthened to compensate for positive phase drifts due to differences in the frequency of various nodes of the network.  •   Bit segment 2 (BS2): defines the location of the transmit point. It represents the PHASE_SEG2 of the CAN standard, its duration is programmable between one and eight time quanta, but can also be automatically shortened to compensate for negative phase drifts.  Figure 318. Bit timing  The baud rate is the inverse of the bit time (baud rate = 1 / bit time), which, in turn, is the sum of three components (see   Figure 318 ): bit time = t   SyncSeg   + t BS1   + t BS2 Where: –   For the nominal bit time t q   = (NBRP[8:0] + 1) × t   fdcan_tq_clk t SyncSeg   = 1 × t q t BS1   = t q   × (NTSEG1[7:0] + 1) t BS2   = t q   × (NTSEG2[6:0] + 1) Where NBRP[8:0], NTSEG1[7:0], and NTSEG2[6:0] bitfields belong to the FDCAN_NBTP register. –   For the data bit time t q   = (DBRP[4:0] + 1) × t   fdcan_tq_clk t SyncSeg   = 1 × t q t BS1   = t q   × (DTSEG1[4:0] + 1) t BS2   = t q   × (DTSEG2[3:0] + 1)  MS47283V1 SyncSeg   Bit segment 1 (BS1)   Bit segment 2 (BS2) t SyncSeg   t BS2 t BS1 Sample point Transmit point

RM0490 Rev 5   893/1027  RM0490   FD controller area network (FDCAN)  952  Where DBRP[4:0], DTSEG1[4:0], and DTSEG2[3:0] belong to the FDCAN_DBTP register. The (re)synchronization jump width (SJW) defines an upper bound for the amount of lengthening or shortening of the bit segments. It is programmable between one and four time quanta. A valid edge is defined as the first transition in a bit time from dominant to recessive bus level, provided the controller itself does not send a recessive bit. If a valid edge is detected in BS1 instead of SYNC_SEG, BS1 is extended by up to SJW, so that the sample point is delayed. Conversely, if a valid edge is detected in BS2 instead of SYNC_SEG, BS2 is shortened by up to SJW, so that the transmit point is moved earlier. As a safeguard against programming errors, the configuration of the bit timing register is only possible while the device is in Standby mode. The FDCAN_DBTP and FDCAN_NBTP registers (dedicated, respectively, to data and nominal bit timing) are only accessible when the CCE and INIT of the FDCA_CCCR register are set. The FDCAN requires that the CAN time quanta clock is always below or equal to the APB clock (f   dcan_tq_ck   < f dcan_pclk   ).  Note:   For a detailed description of the CAN bit timing and resynchronization mechanism, refer to the ISO 11898-1 standard.  28.3.4   Operating modes Configuration  Access to peripheral version, hardware, and input clock divider configuration. When the clock divider is set to 0, the primary input clock is used as it is.  Software initialization  Software initialization is started by setting the INIT bit of the FDCAN_CCCR register, by software, by a hardware reset, or by entering bus-off state. While the INIT bit is set, message transfers from and to the CAN bus are stopped, and the status of the CAN bus output FDCAN_TX is recessive (high). The EML (error management logic) counters are unchanged. Setting the INIT bit does not change any configuration register. Clearing INIT bit of FDCAN_CCCR finishes the software initialization. Afterwards the bit stream processor (BSP) synchronizes itself to the data transfer on the CAN bus by waiting for the occurrence of a sequence of 11 consecutive recessive bits (bus-idle) before it can take part in bus activities and start the message transfer. Access to the FDCAN configuration registers is only enabled when the INIT bit and the CCE bit of the FDCAN_CCCR register are both set. The CCE bit of the FDCAN_CCCR register can only be set/cleared while the INIT bit of FDCAN_CCCR is set. The CCE bit is automatically cleared when the INIT bit is cleared.

FD controller area network (FDCAN)   RM0490  894/1027   RM0490 Rev 5  The following registers are reset when the CCE bit of the FDCAN_CCCR register is set:  •   FDCAN_HPMS: High priority message status  •   FDCAN_RXF0S: Rx FIFO 0 status  •   FDCAN_RXF1S: Rx FIFO 1 status  •   FDCAN_TXFQS: Tx FIFO/queue status  •   FDCAN_TXBRP: Tx buffer request pending  •   FDCAN_TXBTO: Tx buffer transmission occurred  •   FDCAN_TXBCF: Tx buffer cancellation finished  •   FDCAN_TXEFS: Tx event FIFO status The timeout counter value (TOC[15:0] bit of the FDCAN_TOCV register) is preset to the value configured by the TOP[15:0] of the FDCAN_TOCC register when the CCE bit of the FDCAN_CCCR is set. In addition, the state machines of the Tx handler and Rx handler are held in idle state while the CCE bit is set. The following registers can be written only when the CCE bit is cleared:  •   FDCAN_TXBAR: Tx buffer add request  •   FDCAN_TXBCR: Tx buffer cancellation request The TEST and the MON bits of the FDCAN_CCCR register can be set only by software while the INIT and the CCE bits of the FDCAN_CCCR register are both set. Both bits can be reset at any time. The DAR bit of FDCAN_CCCR can only be set/cleared while the INIT and CCE bits are both set.  Normal operation  The FDCAN default operating mode after hardware reset is event-driven CAN communication. TT operation mode is not supported. Once the FDCAN is initialized and the INIT bit of the FDCAN_CCCR register is cleared, the FDCAN synchronizes itself to the CAN bus and is ready for communication. After passing the acceptance filtering, received messages including message ID and DLC are stored into the Rx FIFO 0 or Rx FIFO 1. For messages to be transmitted, the Tx FIFO or the Tx queue can be initialized or updated. Automated transmission on reception of remote frames is not supported.  CAN FD operation  There are two variants in the FDCAN protocol:  •   Long frame mode (LFM), where the data field of a CAN frame may be longer than eight bytes.  •   Fast frame mode (FFM), where the control field, data field, and CRC field of a CAN frame are transmitted with a higher bit rate compared to the beginning and to the end of the frame. The fast frame mode can be used in combination with the long frame mode. The previously reserved bit in CAN frames with 11-bit identifiers and the first previously reserved bit in CAN frames with 29-bit identifiers are decoded as FDF bit: FDF recessive signifies a CAN FD frame, while FDF dominant signifies a classic CAN frame.

RM0490 Rev 5   895/1027  RM0490   FD controller area network (FDCAN)  952  In a CAN FD frame, the two bits following FDF (res and BRS) decide whether the bit rate inside this CAN FD frame is switched. A CAN FD bit rate switch is signified by res dominant and BRS recessive. The coding of res recessive is reserved for future expansion of the protocol. In case the FDCAN receives a frame with FDF recessive and res recessive, it signals a protocol exception event by setting the PXE bit of the FDCAN_PSR register. When protocol exception handling is enabled (PXHD = 0 in FDCAN_CCCR), this causes the operation state to change from receiver (ACT[1:0] = 10 in FDCAN_PSR) to integrating (ACT[1:0] = 00 in FDCAN_PSR) at the next sample point. If protocol exception handling is disabled (PXHD = 1 in FDCAN_CCCR), the FDCAN treats a recessive res bit as a form error and responds with an error frame. CAN FD operation is enabled by programming the FDOE bit of the FDCAN_CCCR register. In case FDOE = 1, transmission and reception of CAN FD frames are enabled. Transmission and reception of classic CAN frames are always possible. Whether a CAN FD frame or a classic CAN frame is transmitted can be configured via the FDF bit in the respective Tx buffer element. With FDOE = 0, received frames are interpreted as classic CAN frames, which leads to the transmission of an error frame when receiving a CAN FD frame. When CAN FD operation is disabled, no CAN FD frames are transmitted even if the FDF bit of a Tx buffer element is set. The FDOE and BRSE bits of the FDCAN_CCCR register can only be changed while the INIT and CCE bits are both set. With FDOE = 0, the setting of the FDF and BRS bits is ignored, and frames are transmitted in classic CAN format. With FDOE = 1 and BRSE = 0, only the FDF bit of a Tx buffer element is evaluated. With FDOE = 1 and BRSE = 1, transmission of CAN FD frames with bit rate switching is enabled. All Tx buffer elements with FDF and BRS bits set are transmitted in CAN FD format with bit rate switching. A mode change during CAN operation is recommended only under the following conditions:  •   The failure rate in the CAN FD data phase is significant higher than in the CAN FD arbitration phase. In this case, disable the CAN FD bit rate switching option for transmissions.  •   During system startup, all nodes transmit classic CAN messages until it is verified that they are able to communicate in CAN FD format. If this is true, all nodes switch to CAN FD operation.  •   Wake-up messages in CAN partial networking have to be transmitted in classic CAN format.  •   End-of-line programming in case not all nodes are CAN FD capable. Non-CAN FD nodes are held in silent mode until programming is complete. Then all nodes switch back to classic CAN communication. In the FDCAN format, the coding of the DLC differs from that of the standard CAN format. The DLC codes 0 to 8 have the same coding as in standard CAN, the codes 9 to 15 (that in standard CAN all code a data field of 8 bytes) are coded according to   Table 141 . : In CAN FD fast frames, the bit timing is switched inside the frame, after the BRS (bit rate switch) bit, if this bit is recessive. Before the BRS bit, in the FDCAN arbitration phase, the standard CAN bit timing is used as defined by the FDCAN_DBTP register. In the following  Table 141. DLC coding in FDCAN DLC   9   10   11   12   13   14   15  Number of data bytes   12   16   20   24   32   48   64

FD controller area network (FDCAN)   RM0490  896/1027   RM0490 Rev 5  FDCAN data phase, the fast CAN bit timing is used as defined by the FDCAN_DBTP register. The bit timing is switched back from the fast timing at the CRC delimiter or when an error is detected, whichever occurs first. The maximum configurable bit rate in the CAN FD data phase depends on the FDCAN kernel clock frequency. For example, with an FDCAN kernel clock frequency of 20 MHz and the shortest configurable bit time of four time quanta (t   q   ), the bit rate in the data phase is 5 Mbit/s. In both data frame formats (CAN FD long frames and CAN FD fast frames), the value of bit ESI (error status indicator) is determined by the transmitter error state at the start of the transmission. If the transmitter is error passive, ESI is transmitted recessive, else it is transmitted dominant. In CAN FD remote frames, the ESI bit is always transmitted dominant, independent of the transmitter error state. The data length code of CAN FD remote frames is transmitted as 0. In case an FDCAN Tx buffer is configured for FDCAN transmission with DLC > 8, the first eight bytes are transmitted as configured in the Tx buffer while the remaining part of the data field is padded with 0xCC. When the FDCAN receives a FDCAN frame with DLC > 8, the first eight bytes of that frame are stored into the matching Rx FIFO. The remaining bytes are discarded.  Transceiver delay compensation  During the data phase of an FDCAN transmission, only one node is transmitting, all others are receivers. The length of the bus line has no impact. When transmitting via pin FDCAN_TX, the protocol controller receives the transmitted data from its local CAN transceiver via pin FDCAN_RX. The received data is delayed by the CAN transceiver loop delay. If this delay is greater than TSEG1 (time segment before sample point), and a bit error is detected. Without transceiver delay compensation, the bit rate in the data phase of an FDCAN frame is limited by the transceiver loop delay. The FDCAN implements a delay compensation mechanism to compensate the CAN transceiver loop delay, thereby enabling transmission with higher bit rates during the FDCAN data phase independent of the delay of a specific CAN transceiver. To check for bit errors during the data phase of transmitting nodes, the delayed transmit data is compared against the received data at the secondary sample point (SSP). If a bit error is detected, the transmitter reacts on this bit error at the next following regular sample point. During the arbitration phase, the delay compensation is always disabled. The transmitter delay compensation enables configurations where the data bit time is shorter than the transmitter delay. This is enabled by setting the TDC bit of the FDCAN_DBTP register, and described in detail in the ISO11898-1 specification. The received bit is compared against the transmitted bit at the SSP. The SSP position is defined as the sum of the measured delay from the FDCAN transmit output pin FDCAN_TX through the transceiver to the receive input pin FDCAN_RX plus the transmitter delay compensation offset as configured by TDCO[6:0] of FDCAN_TDCR. The transmitter delay compensation offset is used to adjust the position of the SSP inside the received bit (for example, half of the bit time in the data phase). The position of the secondary sample point is rounded down to the next integer number of mt   q   (minimum time quantum, one period of fdcan_tq_ck clock). The TDCV[6:0] bitfield of the FDCAN_PSR register shows the actual transmitter delay compensation value. TDCV[6:0] is cleared when the INIT is set in the FDCAN_CCCR. It is

RM0490 Rev 5   897/1027  RM0490   FD controller area network (FDCAN)  952  updated at each transmission of an FD frame while the TDC bit of the FDCAN_DBTP register is set. The following boundary conditions have to be considered for the transmitter delay compensation implemented in the FDCAN:  •   The sum of the measured delay from FDCAN_Tx to FDCAN_Rx and the configured transmitter delay compensation offset TDCO[6:0] has to be lower than 6-bit times in the data phase.  •   The sum of the measured delay from FDCAN_TX to FDCAN_RX and the configured transmitter delay compensation offset TDCO[6:0] has to be lower than or equal to 127 × mt   q   . If the sum exceeds this value, the maximum value (127 × mt q   ) is used for transmitter delay compensation.  •   The data phase ends at the sample point of the CRC delimiter, which stops checking received bits at the SSPs. If transmitter delay compensation is enabled by setting the TDC bit of the FDCAN_DBTP; the measurement is started within each transmitted CAN FD frame at the falling edge of bit FDF to bit res. The measurement is stopped when this edge is seen at the receive input pin FDCAN_TX of the transmitter. The resolution of this measurement is one mt   q   .  Figure 319. Transceiver delay measurement  To avoid that a dominant glitch inside the received FDF bit ends the delay compensation measurement before the falling edge of the received res bit (resulting in a too early SSP position), the use of a transmitter delay compensation filter window can be enabled by programming the TDCF[6:0] bitfield of the FDCAN_TDCR register. This defines a minimum value for the SSP position. Dominant edges on FDCAN_RX that would result in an earlier SSP position are ignored for transmitter delay measurement. The measurement is stopped when the SSP position is at least TDCF[6:0] and FDCAN_RX is low.  MSv41483V2  Arbitration phase Arbitration phase Data phase Data phase FDCAN_TX FDCAN_RX fdcan_tq_ck   Delay counter   + TDCR.TDCO Transmitter delay Res. ESI BRS   DLC Delay Delay compensation offset SSP position Start   Stop FDF

FD controller area network (FDCAN)   RM0490  898/1027   RM0490 Rev 5  Restricted operation mode  In restricted operation mode, the node is able to receive data and remote frames, and to give acknowledge to valid frames, but it does not send data frames, remote frames, active error frames, or overload frames. In case of an error condition or overload condition, it does not send dominant bits. Instead, it waits for the occurrence of a bus-idle condition to resynchronize itself to the CAN communication. The error counters (REC[6:0] and TEC[7:0] in FDCAN_ECR) are frozen while the error logging (CEL[7:0]) is active. The software can set the FDCAN into restricted operation mode by setting the ASM bit of FDCAN_CCCR. The bit can only be set by software when both CCE and INIT bits are set in FDCAN_CCCR. The bit can be cleared by software at any time. Restricted operation mode is automatically entered when the Tx handler is not able to read data from the message RAM in time. To leave restricted operation mode, the software has to clear the ASM bit of FDCAN_CCCR. The restricted operation mode can be used in applications that adapt themselves to different CAN bit rates. In this case, the application tests different bit rates and leaves the restricted operation mode after it has received a valid frame.  Note:   The restricted operation mode must not be combined with the loop-back mode (internal or external).  Bus monitoring mode  The FDCAN is set in bus monitoring mode by setting the MON bit of the FDCAN_CCCR register. In bus monitoring mode (for more details refer to ISO11898-1, 10.12 bus monitoring), the FDCAN is able to receive valid data frames and valid remote frames, but cannot start a transmission. In this mode, it sends only recessive bits on the CAN bus. If the FDCAN is required to send a dominant bit (ACK bit, overload flag, active error flag), the bit is rerouted internally so that the FDCAN can monitor it, even if the CAN bus remains in recessive state. In bus monitoring mode, the FDCAN_TXBRP register is held in reset state. The bus monitoring mode can be used to analyze the traffic on a CAN bus without affecting it by the transmission of dominant bits.   Figure 320   shows the connection of FDCAN_TX and FDCAN_RX signals to the FDCAN in bus monitoring mode.  Figure 320. Pin control in bus monitoring mode  FDCAN MS41462V1 =1 FDCAN_TX   FDCAN_RX Tx   Rx

RM0490 Rev 5   899/1027  RM0490   FD controller area network (FDCAN)  952  Disabled automatic retransmission mode (DAR)  According to the CAN specification (see ISO11898-1, 6.3.3 Recovery Management), the FDCAN provides means for automatic retransmission of frames that have lost arbitration or have been disturbed by errors during transmission. By default, automatic retransmission is enabled. The DAR mode can be disabled through the DAR bit of the FDCAN_CCCR register.  Frame transmission in DAR mode  In DAR mode, all transmissions are automatically canceled after they have been started on the CAN bus. A Tx buffer Tx request pending bit (TRPx in FDCAN_TXBRP) is reset after successful transmission, when a transmission has not yet been started at the point of cancellation, when it has been aborted due to lost arbitration, or when an error has occurred during frame transmission.  •   Successful transmission –   The corresponding Tx buffer transmission occurred bit TOx is set in FDCAN_TXBTO register. –   The corresponding Tx buffer cancellation finished bit CFx is cleared in the FDCAN_TXBCF register.  •   Successful transmission in spite of cancellation –   The corresponding Tx buffer transmission occurred bit TOx is set in the FDCAN_TXBTO register. –   The corresponding Tx buffer cancellation finished bit CFx is set in the FDCAN_TXBCF register.  •   Arbitration loss or frame transmission disturbed –   The corresponding Tx buffer transmission occurred bit TOx is cleared in the FDCAN_TXBTO register. –   The corresponding Tx buffer cancellation finished bit CFx is set in the FDCAN_TXBCF register. In case of a successful frame transmission, and if the storage of Tx events is enabled, a Tx event FIFO element is written with event type ET = 10 (transmission in spite of cancellation).  Power-down (Sleep mode) Power-down entry  The FDCAN can be set into power-down mode controlled by setting the CSR bit of the FDCAN_CCCR register. As long as the clock stop request is active, CSR is read as 1. When all pending transmission requests have completed, the FDCAN waits until the bus- idle state is detected. The FDCAN then sets the INIT bit of the FDCAN_CCCR register to prevent any further CAN transfers. Now, the FDCAN acknowledges that it is ready for power-down by setting the CSA bit of the FDCAN_CCCR register. In this state, before the clocks are switched off, further register accesses can be made. A write access to the INIT bit has no effect. Now, the module clock inputs can be switched off.  Power-down exit  To leave power-down mode, the application has to turn on the module clocks before clearing the CSR bit. The FDCAN acknowledges this by clearing the CSA bit. Afterwards, the application can restart CAN communication by clearing the INIT bit.

FD controller area network (FDCAN)   RM0490  900/1027   RM0490 Rev 5  Test modes  To enable write access to   FDCAN test register (FDCAN_TEST) , the TEST bit of the FDCAN_CCCR register must be set, thus enabling the configuration of test modes and functions. Four output functions are available for the CAN transmit pin FDCAN_TX by programming the TX[1:0] bitfield of the FDCAN_TEST register. In addition to its default function (the serial data output), it can drive the CAN sample point signal to monitor the FDCAN bit timing as well as drive constant dominant or recessive values. The actual value at pin FDCAN_RX can be read from the RX bit of FDCAN_TEST. Both functions can be used to check the CAN bus physical layer. Due to the synchronization mechanism between CAN kernel clock and APB clock domain, there can be a delay of several APB clock periods between writing to TX[1:0] until the new configuration is visible at FDCAN_TX output pin. This applies also when reading FDCAN_RX input pin via RX.  Note:   Test modes must be used for production tests or self-test only. The software control for FDCAN_TX pin interferes with all CAN protocol functions. It is not recommended to use test modes for application.  External loop-back mode  The FDCAN can be set in external loop-back mode by setting the LBCK bit of the FDCAN_TEST register. In loop-back mode, the FDCAN treats its own transmitted messages as received messages and stores them (if they pass acceptance filtering) into Rx FIFOs.   Figure 321   shows the connection of transmit and receive signals FDCAN_TX and FDCAN_RX to the FDCAN in external loop-back mode. This mode is provided for hardware self-test. To be independent from external stimulation, the FDCAN ignores acknowledge errors (recessive bit sampled in the acknowledge slot of a data/remote frame) in loop-back mode. In this mode, the FDCAN performs an internal feedback from its transmit output to its receive input. The actual value of the FDCAN_RX input pin is disregarded by the FDCAN. The transmitted messages can be monitored at the FDCAN_TX transmit pin.  Internal loop-back mode  Internal loop-back mode is entered by setting both the LBCK bit of FDCAN_TEST and the MON bit of FDCAN_CCR. This mode can be used for a “hot self-test”, meaning the FDCAN can be tested without affecting a running CAN system connected to the FDCAN_TX and FDCAN_RX pins. In this mode, FDCAN_RX pin is disconnected from the FDCAN and FDCAN_TX pin is held recessive.   Figure 321   shows the connection of FDCAN_TX and FDCAN_RX pins to the FDCAN in case of internal loop-back mode.

RM0490 Rev 5   901/1027  RM0490   FD controller area network (FDCAN)  952  Figure 321. Pin control in loop-back mode Timestamp generation  For timestamp generation, the FDCAN supplies a 16-bit wrap-around counter. A prescaler (TCP[3:0] of FDCAN_TSCC) can be configured to clock the counter in multiples of CAN bit times (1 to 16). The counter is readable via the TCV[15:0] bitfield of the FDCAN_TSCV register. A write access to TSCV15:0] resets the counter to 0. When the timestamp counter wraps around, the interrupt flag (TSW bit of FDCAN_ISR) is set. On start of frame reception/transmission, the counter value is captured and stored into the timestamp section of an Rx FIFO (RXTS[15:0]) or Tx event FIFO (TXTS[15:0]) element. By programming TSS[1:0] of FDCAN_TSCC, a 16-bit timestamp can be used.  Debug mode behavior  In debug mode, the set/reset on read feature is automatically disabled during the debugger register access, and enabled during normal MCU operation  Timeout counter  To signal timeout conditions for Rx FIFO 0, Rx FIFO 1, and the Tx event FIFO the FDCAN supplies a 16-bit timeout counter. It operates as a down-counter and uses the same prescaler controlled by TCP[3:0] of FDCAN_TSCC as the timestamp counter. The timeout counter is configured via the FDCAN_TOCC register. The actual counter value can be read from the TOC[15:0] bitfield of FDCAN_TOCV. The timeout counter can only be started while the INIT bit of FDCAN_CCCR is cleared. It is stopped when INIT is set, for example, when the FDCAN enters bus-off state. The operation mode is selected by TOS[1:0] of FDCAN_TOCC. When operating in continuous mode, the counter starts when INIT is cleared. A write to FDCAN_TOCV presets the counter to the value configured by TOP[15:0] in FDCAN_TOCC and continues down- counting. When the timeout counter is controlled by one of the FIFOs, an empty FIFO presets the counter to the value configured by TOP[15:0]. Down-counting is started when the first FIFO element is stored. Writing to FDCAN_TOCV has no effect.  FDCAN MS41463V2 = 1 FDCANx_Tx   FDCAN_Rx Tx   Rx Internal loop-back mode FDCAN FDCANx_Tx   FDCAN_Rx Tx   Rx External loop-back mode

FD controller area network (FDCAN)   RM0490  902/1027   RM0490 Rev 5  When the counter reaches 0, the TOO interrupt flag is set in the FDCAN_IR register. In continuous mode, the counter is immediately restarted at TOP[15:0].  Note:   The clock signal for the timeout counter is derived from the CAN core sample point signal. Therefore, the point in time where the timeout counter is decremented may vary due to the synchronization/resynchronization mechanism of the CAN core. If the baud rate switch feature in FDCAN is used, the timeout counter is clocked differently in the arbitration and data fields.  28.3.5   Error management  As described in the CAN protocol, the error management is handled entirely by hardware using the transmit error counter (the TEC[7:0] bitfield of the   FDCAN error counter register (FDCAN_ECR) ) and the receive error counter (the REC[6:0] bitfield of the   FDCAN error counter register (FDCAN_ECR) ). These values are incremented or decremented according to the error condition. For detailed information on TEC[7:0] and REC[6:0] management, refer to the CAN standard. Both values can be read by software to determine the stability of the network. The bus-off state is reached when TEC[7:0] is greater than 255. This state is also indicated by the BO flag of the   FDCAN protocol status register (FDCAN_PSR) . In bus-off state, the CAN is no longer able to transmit and receive messages. It has to wait at least for the duration of the recovery sequence specified in the CAN standard (128 occurrences of 11 consecutive recessive bits monitored on FDCAN_RX input).  Figure 322. CAN error state diagram  Note:   In initialization mode, the CAN does not monitor the   FDCAN_RX   signal, and therefore cannot complete the recovery sequence. To recover from an error state, the CAN must operate in normal mode.  ai15903 ERROR ACTIVE   ERROR PASSIVE BUS OFF When TEC and REC < 128 When TEC or REC > 127 When TEC > 255 When 128x11 recessive bits occur:

RM0490 Rev 5   903/1027  RM0490   FD controller area network (FDCAN)  952  28.3.6   Message RAM  The message RAM is 32-bit wide, and the FDCAN module is configured to allocate up to 212 words in it. It is not necessary to configure each of the sections shown in   Figure 323 .  Figure 323. Message RAM configuration  When the FDCAN addresses the message RAM, it addresses 32-bit words (aligned), not a single byte. The RAM addresses are 32-bit words, that is, only bits 15 to 2 are evaluated, the two least significant bits are ignored. In case of multiple instances, the RAM start address for the FDCANn is computed by end address + 4 of FDCANn - 1, and the FDCANn end address is computed by FDCANn start address + 0x0350 - 4. As an example, for two instances:  •   FDCAN1: –   Start address 0x0000 –   End address 0x034C (as in   Figure 323 )  •   FDCAN2: –   Start address = 0x034C (FDCAN1 end address) + 4 = 0x0350 –   End address = 0x0350 (FDCAN2 start address) + 0x0350 - 4 = 0x069C.  Rx handling  The Rx handler controls the acceptance filtering, the transfer of received messages to one of the two Rx FIFOs, as well as the Rx FIFO put and get indices.  Acceptance filter  The FDCAN offers the possibility to configure two sets of acceptance filters, one for standard identifiers and another for extended identifiers. These filters can be assigned to Rx FIFO 0 or Rx FIFO 1. For acceptance filtering, each list of filters is executed from element #0 until the first matching element. Acceptance filtering stops at the first matching element, and the following filter elements are not evaluated for this message.  MS47278V5 32 bits Tx buffers Tx event FIFO Rx FIFO 1 Rx FIFO 0 29-bit filter 11-bit filter TBSA EFSA FLESA FLSSA 3 elements / 54 words 3 elements / 6 words 3 elements / 54 words 3 elements / 54 words 8 elements / 16 words 28 elements / 28 words 0x0000 0x0070 0x00B0 0x0188 0x0260 0x0278

FD controller area network (FDCAN)   RM0490  904/1027   RM0490 Rev 5  The main features are:  •   Each filter element can be configured as –   Range filter (from - to) –   Filter for one or two dedicated IDs –   Classic bit mask filter  •   Each filter element is configurable for acceptance or rejection filtering.  •   Each filter element can be enabled/disabled individually.  •   Filters are checked sequentially, execution stops with the first matching filter element Related configuration registers are:  •   Global filter configuration (RXGFC)  •   Extended ID AND mask (XIDAM) Depending on the configuration of the filter element (SFEC[2:0]/EFEC[2:0]), a match triggers one of the following actions:  •   Store received frame in FIFO 0 or FIFO 1  •   Reject received frame  •   Set the high priority message interrupt flag HPM in FDCAN_IR  •   Set the high priority message interrupt flag HPM in FDCAN_IR, and store the received frame in FIFO 0 or FIFO 1. Acceptance filtering is started after the complete identifier has been received. After acceptance filtering has completed, and if a matching Rx FIFO has been found, the message handler starts writing the received message data in 32-bit portions to the matching Rx FIFO. If the CAN protocol controller has detected an error condition (for example, CRC error), this message is discarded with the following impact:  •   Rx FIFO  The put index of the matching Rx FIFO is not updated, but the related Rx FIFO element is partly overwritten with the received data. For error type, see LEC[2:0] and DLEC[2:0] bitfields of the FDCAN_PSR register. In case the matching Rx FIFO is operated in overwrite mode, the boundary conditions described in   Rx FIFO overwrite mode   have to be considered.  Note:   When an accepted message is written to one of the two Rx FIFOs, the unmodified received identifier is stored independently from the used filters. The result of the acceptance filter process strongly depends on the sequence of configured filter elements.  Range filter  The filter matches for all received frames with message IDs in the range defined by SF1ID/SF2ID and EF1ID/EF2ID. There are two possibilities when range filtering is used together with extended frames:  •   EFT[1:0] = 00: the message ID of received frames is AND-ed with the extended ID AND mask (XIDAM) before the range filter is applied.  •   EFT[1:0] = 11: the extended ID AND mask (XIDAM) is not used for range filtering.

RM0490 Rev 5   905/1027  RM0490   FD controller area network (FDCAN)  952  Filter for dedicated IDs  A filter element can be configured to filter for one or two specific message IDs. To filter for one specific message ID, the filter element has to be configured with SF1ID = SF2ID and EF1ID = EF2ID.  Classic bit mask filter  The classic bit mask filtering is intended to filter groups of message IDs by masking single bits of a received message ID. With classic bit mask filtering SF1ID/EF1ID is used as message ID filter, while SF2ID/EF2ID is used as filter mask. 0 bit at the filter mask masks out the corresponding bit position of the configured ID filter. For example, the value of the received message ID at that bit position is not relevant for acceptance filtering. Only the bits of the received message ID where the corresponding mask bits are 1 are relevant for acceptance filtering. In case all mask bits are 1, a match occurs only when the received message ID and the message ID filter are identical. If all mask bits are 0, all message IDs match.  Standard message ID filtering  Figure 324   shows the flow for standard message ID (11-bit identifier) filtering. The standard message ID filter element is described in   Section 28.3.11 . The standard message filtering is controlled by the FDCAN_RXGFC register. The standard message ID, the remote transmission request bit (RTR), and the identifier extension bit (IDE) of the received frames are compared against the list of configured filter elements.

FD controller area network (FDCAN)   RM0490  906/1027   RM0490 Rev 5  Figure 324. Standard message ID filter path  MS47279V1 Valid frame received Bit identifier Remote frame Receive filter list enabled Match filter element #0 Accept non-matching frames Acceptance or Rejection Target FIFO full Append to target FIFO Match filter element #RXGFC.LSS Reject remote frame Discard frame 11-bit   29-bit Yes Yes Yes Yes No No No No RXGFC[LSS[7:0]] > 0 RXGFC[LSS[7:0]] = 0 RXGFC[RRFS] = 0 RXGFC[RRFS] = 1 RXGFC[ANFS[1]] = 1 RXGFC[ANFS[1]] = 0 No Yes Reject Accept

RM0490 Rev 5   907/1027  RM0490   FD controller area network (FDCAN)  952  Extended message ID filtering  Figure 325   shows the flow for extended message ID (29-bit identifier) filtering. The extended message ID filter element is described in   Section 28.3.12 . The extended message filtering is controlled by the FDCAN_RXGFC register. The extended message ID, the remote transmission request bit (RTR), and the identifier extension bit (IDE) of the received frames are compared against the list of configured filter elements.  Figure 325. Extended message ID filter path  The extended ID AND mask (XIDAM) is AND-ed with the received identifier before the filter list is executed.  MS47280V1 Valid frame received Bit identifier Remote frame Receive filter list enabled Match filter element #0 Accept non-matching frames Acceptance or Rejection Target FIFO full Append to target FIFO Match filter element #RXGFC.LSE Reject remote frame Discard frame 29-bit   11-bit Yes Yes Yes Yes No No No No RXGFC[LSE[3:0]] > 0 RXGFC[LSE[3:0]] = 0 RXGFC[RRFE] = 0 RXGFC[RRFE] = 1 RXGFC[ANFE[1]] = 1 RXGFC[ANFE[1]] = 0 No Yes Reject Accept

FD controller area network (FDCAN)   RM0490  908/1027   RM0490 Rev 5  Rx FIFOs  Rx FIFO 0 and Rx FIFO 1 can hold up to three elements each. Received messages that passed acceptance filtering are transferred to the Rx FIFO as configured by the matching filter element. For a description of the filter mechanisms available for Rx FIFO 0 and Rx FIFO 1, see   Acceptance filter . The Rx FIFO element is described in   Section 28.3.8 . When an Rx FIFO full condition is signaled by RFnF in FDCAN_IR (where n is the FIFO number), no further messages are written to the corresponding Rx FIFO until at least one message has been read out, and the Rx FIFO get index has been incremented. In case a message is received while the corresponding Rx FIFO is full, this message is discarded, and the interrupt flag RFnL is set in the FDCAN_IR register. When reading from an Rx FIFO, the Rx FIFO get index (FnGI of FDCAN_RXFnS) + FIFO element size has to be added to the corresponding Rx FIFO start address (FnSA).  Rx FIFO blocking mode  The Rx FIFO blocking mode is configured by clearing the FnOM bit in the FDCAN_RXGFC register. This is the default operation mode for the Rx FIFOs. When an Rx FIFO full condition is reached (FnPI = FnGI in FDCAN_RXFnS), no further messages are written to the corresponding Rx FIFO until at least one message has been read out and the Rx FIFO get index has been incremented. An Rx FIFO full condition is signaled by FnF = 1 in FDCAN_RXFnS. In addition, the RFnF interrupt flag is set in FDCAN_IR. In case a message is received while the corresponding Rx FIFO is full, this message is discarded, and the message lost condition is signaled by setting RFnL bit in FDCAN_RXFnS. In addition, the RFnL interrupt flag is set in FDCAN_IR.  Rx FIFO overwrite mode  The Rx FIFO overwrite mode is configured by setting the FnOM bit of the FDCAN_RXGFC register. When an Rx FIFO full condition (FnPI = FnGI of FDCAN_RXFnS) is signaled by FnF = 1 in FDCAN_RXFnS, the next message accepted for the FIFO overwrites the oldest FIFO message. Put and get indices are both incremented by one. When an Rx FIFO is operated in overwrite mode and an Rx FIFO full condition is signaled, reading from the Rx FIFO elements must start at least at get index + 1. This is because it may happen that a received message is written to the message RAM (put index) while the CPU is reading from the message RAM (get index). In this case, inconsistent data can be read from the respective Rx FIFO element. Adding an offset to the get index when reading from the Rx FIFO avoids this problem. The offset depends on how fast the CPU accesses the Rx FIFO. After reading from the Rx FIFO, the number of the last element read has to be written to the Rx FIFO acknowledge index (FnA of FDCAN_RXFnA). This increments the get index to that element number. In case the put index has not been incremented to this Rx FIFO element, the Rx FIFO full condition is reset (FnF = 0 in FDCAN_RXFnS).

RM0490 Rev 5   909/1027  RM0490   FD controller area network (FDCAN)  952  Tx handling  The Tx handler handles transmission requests for the Tx FIFO and the Tx queue. It controls the transfer of transmit messages to the CAN core, the put and get indices, and the Tx event FIFO. Up to three Tx buffers can be set up for message transmission. The CAN message data field is configured to 64 bytes. the Tx FIFO allocates eighteen 32-bit words for storage of a Tx element.  Note:   AUTOSAR requires at least three Tx queue buffers and support of transmit cancellation.  The Tx handler starts a Tx scan to check for the highest priority pending Tx request (Tx buffer with lowest message ID) when the Tx buffer request pending register (FDCAN_TXBRP) is updated, or when a transmission has been started.  Transmit pause  The transmit pause feature is intended for use in CAN systems where the CAN message identifiers are permanently specified to specific values and cannot easily be changed. These message identifiers can have a higher CAN arbitration priority than other defined messages, while in a specific application their relative arbitration priority must be inverse. This may lead to a case where one ECU sends a burst of CAN messages that cause another ECU CAN messages to be delayed because that other messages have a lower CAN arbitration priority. As an example, if CAN ECU-1 has the feature enabled and is requested by its application software to transmit four messages, it waits, after the first successful message transmission, for two CAN bit times of bus-idle before it is allowed to start the next requested message. If there are other ECUs with pending messages, these messages are started in the idle time, and they would not need to arbitrate with the next message of ECU-1. After having received a message, ECU-1 is allowed to start its next transmission as soon as the received message releases the CAN bus. The feature is controlled by the TXP bit of the CCCR register. If the bit is set, the FDCAN, each time it has successfully transmitted a message, pauses for two CAN bit times before starting the next transmission. This enables other CAN nodes in the network to transmit messages even if their messages have lower prior identifiers. By default, this feature is disabled (TXP = 0 in FDCAN_CCCR).  Table 142. Possible configurations for frame transmission CCCR   Tx buffer element Frame transmission BRSE   FDOE   FDF   BRS  Ignored   0   Ignored   Ignored   Classic CAN 0   1   0   Ignored   Classic CAN 0   1   1   Ignored   FD without bit rate switching 1   1   0   Ignored   Classic CAN 1   1   1   0   FD without bit rate switching 1   1   1   1   FD with bit rate switching

FD controller area network (FDCAN)   RM0490  910/1027   RM0490 Rev 5  This feature looses up burst transmissions coming from a single node and it protects against "babbling idiot" scenarios where the application program erroneously requests too many transmissions.  Tx FIFO  Tx FIFO operation is configured by clearing the TFQM bit of the FDCAN_TXBC register. Messages stored in the Tx FIFO are transmitted starting with the message referenced by the get index (TFGI[1:0] bitfield of FDCAN_TXFQS). After each transmission, the get index is incremented cyclically until the Tx FIFO is empty. The Tx FIFO enables transmission of messages with the same message ID from different Tx buffers in the order that these messages have been written to the Tx FIFO. The FDCAN calculates the Tx FIFO free level (TFFL[2:0] bitfield of FDCAN_TXFQS) as the difference between the get and put index. It indicates the number of available (free) Tx FIFO elements. New transmit messages have to be written to the Tx FIFO starting with the Tx buffer referenced by the put index (TFQPI[1:0] bitfield of FDCAN_TXFQS). An add request increments the put index to the next free Tx FIFO element. When the put index reaches the get index, Tx FIFO full (TFQF = 1 in FDCAN_TXFQS) is signaled. In this case, no further messages must be written to the Tx FIFO until the next message has been transmitted and the get index has been incremented. When a single message is added to the Tx FIFO, the transmission is requested by setting the FDCAN_TXBAR bit related to the Tx buffer referenced by the Tx FIFO put index. When multiple (n) messages are added to the Tx FIFO, they are written to n consecutive Tx buffers starting with the put index. The transmissions are then requested via the FDCA_TXBAR register. The put index is then cyclically incremented by n. The number of requested Tx buffers must not exceed the number of free Tx buffers as indicated by the Tx FIFO free level. When a transmission request for the Tx buffer referenced by the get index is canceled, the get index is incremented to the next Tx buffer with a transmission request is pending and the Tx FIFO free level is recalculated. When transmission cancellation is applied to any other Tx buffer, the get index and the FIFO Free Level remain unchanged. A Tx FIFO element allocates eighteen 32-bit words in the message RAM. The Therefore, the start address of the next available (free) Tx FIFO buffer, is calculated by adding 18 times the put index TFQPI[1:0] (0 … 2) to the Tx buffer start address TBSA.  Tx queue  Tx queue operation is configured by setting the TFQM of the FDCAN_TXBC register. Messages stored in the Tx queue are transmitted starting with the message with the lowest message ID (highest priority). In case of mixing of standard and extended message IDs, the standard message IDs are compared to bits [28:18] of extended message IDs. In case multiple queue buffers are configured with the same message ID, the queue buffer with the lowest buffer number is transmitted first. New messages have to be written to the Tx buffer referenced by the put index (TFQPI[1:0] in FDCAN_TXFQS). An add request cyclically increments the put index to the next free Tx buffer. In case the Tx queue is full (TFQF = 1 in FDCAN_TXFQS), the put index is not valid and no further message must be written to the Tx queue until at least one of the requested messages has been sent out or a pending transmission request has been canceled.

RM0490 Rev 5   911/1027  RM0490   FD controller area network (FDCAN)  952  The application can use the FDCAN_TXBRP register instead of the put index and can place messages to any Tx buffer without pending transmission request. A Tx queue buffer allocates eighteen 32-bit words in the message RAM. The start address of Therefore, the next available (free) Tx queue buffer is calculated by adding 18 times the Tx queue put index TFQPI[1:0] (0 ... 2) to the Tx buffer start address TBSA.  Transmit cancellation  The FDCAN supports transmit cancellation. To cancel a requested transmission from a Tx queue buffer, the host has to write 1 to the corresponding bit position (= number of Tx buffer) of the FDCAN_TXBCR register. Transmit cancellation is not intended for Tx FIFO operation. Successful cancellation is signaled by setting the corresponding bit of the FDCAN_TXBCF register. In case a transmit cancellation is requested while a transmission from a Tx buffer is already ongoing, the corresponding FDCAN _TXBRP bit remains set as long as the transmission is in progress. If the transmission is successful, the corresponding FDCAN_TXBTO and FDCAN_TXBCF bits are set. If the transmission is not successful, it is not repeated and only the corresponding FDCAN_TXBCF bit is set.  Note:   In case a pending transmission is canceled immediately before it has been started, there is a short time window where no transmission is started even if another message is pending in the node. This can enable another node to transmit a message that can have a priority lower than that of the second message in the node.  Tx event handling  To support Tx event handling the FDCAN has implemented a Tx event FIFO. After the FDCAN has transmitted a message on the CAN bus, message ID and timestamp are stored in a Tx event FIFO element. To link a Tx event to a Tx event FIFO element, the message marker from the transmitted Tx buffer is copied into the Tx event FIFO element. The Tx event FIFO is configured to three elements. The Tx event FIFO element is described in   Tx FIFO . The purpose of the Tx event FIFO is to decouple handling transmit status information from transmit message handling that is, a Tx buffer holds only the message to be transmitted, while the transmit status is stored separately in the Tx event FIFO. This has the advantage, especially when operating a dynamically managed transmit queue, that a Tx buffer can be used for a new message immediately after successful transmission. There is no need to save transmit status information from a Tx buffer before overwriting that Tx buffer. When a Tx event FIFO full condition is signaled by the TEFF bit of the FDCAN_IR, no further elements are written to the Tx event FIFO until at least one element has been read out and the Tx event FIFO get index has been incremented. In case a Tx event occurs while the Tx event FIFO is full, this event is discarded and the TEFL interrupt flag is set in the FDCAN_IR register. When reading from the Tx event FIFO, the Tx event FIFO get index (EFGI[1:0] of FDCAN_TXEFS) has to be added twice to the Tx event FIFO start address EFSA.

FD controller area network (FDCAN)   RM0490  912/1027   RM0490 Rev 5  28.3.7   FIFO acknowledge handling  The get indices of Rx FIFO 0, Rx FIFO 1, and the Tx event FIFO are controlled by writing to the corresponding FIFO acknowledge index (see   Section 28.4.23   and   Section 28.4.25 ). Writing to the FIFO acknowledge index sets the FIFO get index to the FIFO acknowledge index plus one and thereby updates the FIFO fill level. There are two use cases:  •   When only a single element has been read from the FIFO (the one being pointed to by the get index), this get index value is written to the FIFO acknowledge index.  •   When a sequence of elements has been read from the FIFO, it is sufficient to write the FIFO acknowledge index only once at the end of that read sequence (value = index of the last element read), to update the FIFO get index. Because the CPU has free access to the FDCAN message RAM, special care has to be taken when reading FIFO elements in an arbitrary order (get index not considered). This might be useful when reading a high priority message from one of the two Rx FIFOs. In this case, the FIFO acknowledge index must not be written because this would set the get index to a wrong position and alter the FIFO fill level. In this case, some of the older FIFO elements would be lost.  Note:   The application has to ensure that a valid value is written to the FIFO acknowledge index. The FDCAN does not check for erroneous values.  28.3.8   FDCAN Rx FIFO element  Two Rx FIFOs are configured in the message RAM. Each Rx FIFO section can be configured to store up to three received messages. The structure of an Rx FIFO element is described in   Table 143 . The description is provided in   Table 144 . The element size configured for storage of CAN FD messages is set to 64-byte data field.  Table 143. Rx FIFO element Bit   31   24   23   16   15   8   7   0  R0   ESI   XTD   RTR   ID[28:0] R1   ANMF   FIDX[6:0]   Res.   FDF   BRS   DLC[3:0]   RXTS[15:0] R2   DB3[7:0]   DB2[7:0]   DB1[7:0]   D[7:0] R3   DB7[7:0]   DB6[7:0]   DB5[7:0]   DB4[7:0] ... ... ... ... Rn   DBm[7:0]   DBm-1[7:0]   DBm-2[7:0]   DBm-3[7:0]  Table 144. Rx FIFO element description Field   Description  R0 Bit 31 ESI Error state indicator – 0: Transmitting node is error active – 1: Transmitting node is error passive R0 Bit 30 XTD Extended identifier Signals to the host whether the received frame has a standard or extended identifier. – 0: 11-bit standard identifier – 1: 29-bit extended identifier

RM0490 Rev 5   913/1027  RM0490   FD controller area network (FDCAN)  952  R0 Bit 29 RTR Remote transmission request Signals to the host whether the received frame is a data frame or a remote frame. – 0: Received frame is a data frame – 1: Received frame is a remote frame R0 Bits 28:0 ID[28:0] Identifier Standard or extended identifier depending on bit XTD. A standard identifier is stored into ID[28:18]. R1 Bit 31 ANMF Accepted non-matching frame Acceptance of non-matching frames can be enabled via ANFS[1:0] and ANFE[1:0] bitfield of FDCAN_RXGFC. – 0: Received frame matching filter index FIDX – 1: Received frame did not match any Rx filter element R1 Bits 30:24 FIDX[6:0] Filter index 0-27=Index of matching Rx acceptance filter element (invalid if ANMF = 1). Range: 0 to LSS[4:0] - 1 or LSE[3:0] - 1 in FDCAN_RXGFC. R1 Bit 21 FDF FD format – 0: Standard frame format – 1: FDCAN frame format (new DLC-coding and CRC) R1 Bit 20 BRS Bit rate switch – 0: Frame received without bit rate switching – 1: Frame received with bit rate switching R1 Bits 19:16 DLC[3:0] Data length code – 0-8: Classic CAN + CAN FD: received frame has 0-8 data bytes – 9-15: Classic CAN: received frame has 8 data bytes – 9-15: CAN FD: received frame has 12/16/20/24/32/48/64 data bytes R1 Bits 15:0 RXTS[15:0] Rx timestamp Timestamp Counter value captured on start of frame reception. Resolution depending on configuration of the timestamp counter prescaler TCP[3:0] of FDCAN_TSCC. R2 Bits 31:24 DB3[7:0]   Data byte 3 R2 Bits 23:16 DB2[7:0]   Data byte 2 R2 Bits 15:8 DB1[7:0]   Data byte 1 R2 Bits 7:0 D[7:0]   Data byte 0 R3 Bits 31:24 DB7[7:0]   Data byte 7 R3 Bits 23:16 DB6[7:0]   Data byte 6  Table 144. Rx FIFO element description (continued) Field   Description

FD controller area network (FDCAN)   RM0490  914/1027   RM0490 Rev 5  28.3.9   FDCAN Tx buffer element  The Tx buffers section (three elements) can be configured to hold Tx FIFO or Tx queue. The Tx handler distinguishes between Tx FIFO and Tx queue using the Tx buffer configuration TFQM bit of the FDCAN_TXBC register. The element size is configured for storage of CAN FD messages with up to 64-byte data. R3 Bits 15:8 DB5[7:0]   Data byte 5 R3 Bits 7:0 DB4[7:0]   Data byte 4 ... ... Rn Bits 31:24 DBm[7:0]   Data byte m Rn Bits 23:16 DBm-1[7:0]   Data byte m-1 Rn Bits 15:8 DBm-2[7:0]   Data byte m-2 Rn Bits 7:0 DBm-3[7:0]   Data byte m-3  Table 144. Rx FIFO element description (continued) Field   Description Table 145. Tx buffer and FIFO element Bit   31   24   23   16   15   8   7   0  T0   ESI   XTD   RTR   ID[28:0] T1   MM[7:0]   EFC   Res.   FDF   BRS   DLC[3:0]   Res. T2   DB3[7:0]   DB2[7:0]   DB1[7:0]   D[7:0] T3   DB7[7:0]   DB6[7:0]   DB5[7:0]   DB4[7:0] ... ... ... ... Tn   DBm[7:0]   DBm-1[7:0]   DBm-2[7:0]   DBm-3[7:0]  Table 146. Tx buffer element description Field   Description  T0 Bit 31 ESI   (1) Error state indicator – 0: ESI bit in CAN FD format depends only on error passive flag – 1: ESI bit in CAN FD format transmitted recessive T0 Bit 30 XTD Extended identifier – 0: 11-bit standard identifier – 1: 29-bit extended identifier

RM0490 Rev 5   915/1027  RM0490   FD controller area network (FDCAN)  952  T0 Bit 29 RTR (2) Remote transmission request – 0: Transmit data frame – 1: Transmit remote frame T0 Bits 28:0 ID[28:0] Identifier Standard or extended identifier depending on bit XTD. A standard identifier has to be written to ID[28:18]. T1 Bits 31:24 MM[7:0] Message marker Written by CPU during Tx buffer configuration. Copied into Tx event FIFO element for identification of Tx message status. T1 Bit 23 EFC Event FIFO control – 0: Do not store Tx events – 1: Store Tx events T1 Bit 21 FDF FD format – 0: Frame transmitted in classic CAN format – 1: Frame transmitted in CAN FD format T1 Bit 20 BRS (3) Bit rate switching – 0: CAN FD frames transmitted without bit rate switching – 1: CAN FD frames transmitted with bit rate switching T1 Bits 19:16 DLC[3:0] Data length code – 0 - 8: Classic CAN + CAN FD: received frame has 0-8 data bytes – 9 - 15: Classic CAN: received frame has 8 data bytes – 9 - 15: CAN FD: received frame has 12/16/20/24/32/48/64 data bytes T2 Bits 31:24 DB3[7:0]   Data byte 3 T2 Bits 23:16 DB2[7:0]   Data byte 2 T2 Bits 15:8 DB1[7:0]   Data byte 1 T2 Bits 7:0 D[7:0]   Data byte 0 T3 Bits 31:24 DB7[7:0]   Data byte 7 T3 Bits 23:16 DB6[7:0]   Data byte 6 T3 Bits 15:8 DB5[7:0]   Data byte 5 T3 Bits 7:0 DB4[7:0]   Data byte 4 ... ...  Table 146. Tx buffer element description (continued) Field   Description

FD controller area network (FDCAN)   RM0490  916/1027   RM0490 Rev 5  28.3.10   FDCAN Tx event FIFO element  Each element stores information about transmitted messages. By reading the Tx event, FIFO the host CPU gets this information in the order that the messages were transmitted. Status information about the Tx event FIFO can be obtained from FDCAN_TXEFS register. Tn Bits 31:24 DBm[7:0]   Data byte m Tn Bits 23:16 DBm-1[7:0]   Data byte m-1 Tn Bits 15:8 DBm-2[7:0]   Data byte m-2 Tn Bits 7:0 DBm-3[7:0]   Data byte m-3 1.   The ESI bit of the transmit buffer is OR-ed with the error passive flag to decide the value of the ESI bit in the transmitted FD frame. As required by the CAN FD protocol specification, an error active node can optionally transmit the ESI bit recessive, but an error passive node always transmits the ESI bit recessive. 2.   When RTR = 1, the FDCAN transmits a remote frame according to ISO11898-1, even if the transmission in CAN FD format is enabled by the FDOE bit of the FDCAN_CCCR. 3.   Bits ESI, FDF, and BRS are only evaluated when CAN FD operation is enabled by setting the FDOE bit of the FDCAN_CCCR. Bit BRS is only evaluated when in addition BRSE bit is set in FDCAN_CCCR.  Table 146. Tx buffer element description (continued) Field   Description Table 147. Tx event FIFO element Bit   31   24   23   16   15   8   7   0  E0   ESI   XTD   RTR   ID[28:0] E1   MM[7:0]   ET[1:0]   EDL   BRS   DLC[3:0]   TXTS[15:0]  Table 148. Tx event FIFO element description Field   Description  E0 Bit 31 ESI Error state indicator – 0: Transmitting node is error active – 1: Transmitting node is error passive E0 Bit 30 XTD Extended identifier – 0: 11-bit standard identifier – 1: 29-bit extended identifier E0 Bit 29 RTR Remote transmission request – 0: Transmit data frame – 1: Transmit remote frame E0 Bits 28:0 ID[28:0] Identifier Standard or extended identifier depending on bit XTD. A standard identifier has to be written to ID[28:18].

RM0490 Rev 5   917/1027  RM0490   FD controller area network (FDCAN)  952  28.3.11   FDCAN standard message ID filter element  Up to 28 filter elements can be configured for 11-bit standard IDs. When accessing a standard message ID filter element, its address is the filter list standard start address FLSSA plus the index of the filter element (0 … 27). E1 Bits 31:24 MM[7:0] Message marker Copied from Tx buffer into Tx event FIFO element for identification of Tx message status. E1 Bits 23:22 EFC Event type – 00: Reserved – 01: Tx event – 10: Transmission in spite of cancellation (always set for transmissions in DAR mode) – 11: Reserved E1 Bit 21 EDL Extended data length – 0: Standard frame format – 1: FDCAN frame format (new DLC-coding and CRC) E1 Bit 20 BRS Bit rate switching – 0: Frame transmitted without bit rate switching – 1: Frame transmitted with bit rate switching T1 Bits 19:16 DLC[3:0] Data length code 0 - 8: Frame with 0-8 data bytes transmitted 9 - 15: Frame with 8 data bytes transmitted E1 Bits 15:0 TXTS[15:0] Tx Timestamp Timestamp counter value captured on start of frame transmission. Resolution depending on configuration of the timestamp counter prescaler TCP[3:0] of FDCAN_TSCC.  Table 148. Tx event FIFO element description (continued) Field   Description Table 149. Standard message ID filter element Bit   31   24   23   16   15   8   7   0  S0   SFT[1:0]   SFEC[2:0]   SFID1[10:0]   Res.   SFID2[10:0]

FD controller area network (FDCAN)   RM0490  918/1027   RM0490 Rev 5  Note:   In case a reserved value is configured, the filter element is considered disabled.  28.3.12   FDCAN extended message ID filter element  Up to eight filter elements can be configured for 29-bit extended IDs. When accessing an extended message ID filter element, its address is the filter list extended start address FLESA plus twice the index of the filter element (0 … 7).  Table 150. Standard message ID filter element field description Field   Description  Bit 31:30 SFT[1:0]   (1) 1.   With SFT[1:0] = 11 the filter element is disabled and the acceptance filtering continues (same behavior as with SFEC[2:0] = 000). Standard filter type – 00: Range filter from SFID1 to SFID2 – 01: Dual ID filter for SFID1 or SFID2 – 10: Classic filter: SFID1 = filter, SFID2 = mask – 11: Filter element disabled Bit 29:27 SFEC[2:0] Standard filter element configuration All enabled filter elements are used for acceptance filtering of standard frames. Acceptance filtering stops at the first matching enabled filter element or when the end of the filter list is reached. If SFEC[2:0] = 100, 101 or 110 a match sets interrupt flag IR.HPM and, if enabled, an interrupt is generated. In this case register HPMS is updated with the status of the priority match. – 000: Disable filter element – 001: Store in Rx FIFO 0 if filter matches – 010: Store in Rx FIFO 1 if filter matches – 011: Reject ID if filter matches – 100: Set priority if filter matches – 101: Set priority and store in FIFO 0 if filter matches – 110: Set priority and store in FIFO 1 if filter matches – 111: Not used Bits 26:16 SFID1[10:0] Standard filter ID 1 First ID of standard ID filter element. Bits 10:0 SFID2[10:0] Standard filter ID 2 Second ID of standard ID filter element.  Table 151. Extended message ID filter element Bit   31   24   23   16   15   8   7   0  F0   EFEC[2:0]   EFID1[28:0] F1   EFT[1:0]   Res.   EFID2[28:0]

RM0490 Rev 5   919/1027  RM0490   FD controller area network (FDCAN)  952  Table 152. Extended message ID filter element field description Field   Description  F0 Bits 31:29 EFEC[2:0] Extended filter element configuration All enabled filter elements are used for acceptance filtering of extended frames. Acceptance filtering stops at the first matching enabled filter element or when the end of the filter list is reached. If EFEC[2:0] = 100, 101 or 110 a match sets interrupt flag IR[HPM] and, if enabled, an interrupt is generated. In this case register HPMS is updated with the status of the priority match. – 000: Disable filter element – 001: Store in Rx FIFO 0 if filter matches – 010: Store in Rx FIFO 1 if filter matches – 011: Reject ID if filter matches – 100: Set priority if filter matches – 101: Set priority and store in FIFO 0 if filter matches – 110: Set priority and store in FIFO 1 if filter matches – 111: Not used F0 Bits 28:0 EFID1[28:0] Extended filter ID 1 First ID of extended ID filter element. When filtering for Rx FIFO, this field defines the ID of an extended message to be stored. The received identifiers must match exactly, only XIDAM masking mechanism. F1 Bits 31:30 EFT[1:0] Extended filter type – 00: Range filter from EF1ID to EF2ID (EF2ID   ≥   EF1ID) – 01: Dual ID filter for EF1ID or EF2ID – 10: Classic filter: EF1ID = filter, EF2ID = mask – 11: Range filter from EF1ID to EF2ID (EF2ID   ≥   EF1ID), XIDAM mask not applied F1 Bit 29   Not used F1 Bits 28:0 EFID2[28:0] Extended filter ID 2 Second ID of extended ID filter element.

FD controller area network (FDCAN)   RM0490  920/1027   RM0490 Rev 5  28.4   FDCAN registers 28.4.1   FDCAN core release register (FDCAN_CREL)  Address offset: 0x0000 Reset value: 0x3214 1218  28.4.2   FDCAN endian register (FDCAN_ENDN)  Address offset: 0x0004 Reset value: 0x8765 4321  Note:   The register read must give the reset value to ensure no endianness issue.  28.4.3   FDCAN data bit timing and prescaler register (FDCAN_DBTP)  Address offset: 0x000C Reset value: 0x0000 0A33 This register is only writable if the CCE and INIT bits of the FDCAN_CCCR are set. The CAN time quantum can be programmed in the range of 1 to 32 FDCAN clock periods: t q   = (DBRP[4:0] + 1) FDCAN clock periods. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 REL[3:0]   STEP[3:0]   SUBSTEP[3:0]   YEAR[3:0] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 MON[7:0]   DAY[7:0] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r Bits 31:28   REL[3:0] : 3 Bits 27:24   STEP[3:0] : 2 Bits 23:20   SUBSTEP[3:0] : 1 Bits 19:16   YEAR[3:0] : 4 Bits 15:8   MON[7:0] : 12 Bits 7:0   DAY[7:0] : 18 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 ETV[31:16] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ETV[15:0] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r Bits 31:0   ETV[31:0] : Endianness test value The endianness test value is 0x8765 4321.

RM0490 Rev 5   921/1027  RM0490   FD controller area network (FDCAN)  952  DTSEG1[4:0] is the sum of PROP_SEG and PHASE_SEG1. DTSEG2[3:0] is PHASE_SEG2. Therefore, the length of the bit time is (programmed values) × [DTSEG1[4:0] + DTSEG2[3:0] + 3] × t   q   or (functional values) × [SYNC_SEG + PROP_SEG + PHASE_SEG1 + PHASE_SEG2] × t   q   . The information processing time (IPT) is 0, meaning the data for the next bit is available at the first clock edge after the sample point.  Note:   With an FDCAN clock of 8 MHz, the reset value 0x0000 0A33 configures the FDCAN for a fast bit rate of 500 kbit/s. The data phase bit rate must be higher than or equal to the nominal bit rate.  28.4.4   FDCAN test register (FDCAN_TEST)  Write access to this register is enabled by setting the TEST bit of the FDCAN_CCCR register. All register functions are set to their reset values when this bit is cleared. Loop-back mode and software control of Tx pin FDCANx_TX are hardware test modes. Programming TX[1:0] differently from 00 can disturb the message transfer on the CAN bus. Address offset: 0x0010 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TDC   Res.   Res.   DBRP[4:0] rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   DTSEG1[4:0]   DTSEG2[3:0]   DSJW[3:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:24   Reserved, must be kept at reset value. Bit 23   TDC : Transceiver delay compensation 0: Transceiver delay compensation disabled 1: Transceiver delay compensation enabled Bits 22:21   Reserved, must be kept at reset value. Bits 20:16   DBRP[4:0] : Data bit rate prescaler The value by which the oscillator frequency is divided to generate the bit time quanta. The bit time is built up from a multiple of this quantum. Valid values for the baud rate prescaler are 0 to 31. The hardware interpreters this value as the value programmed plus 1. Bits 15:13   Reserved, must be kept at reset value. Bits 12:8   DTSEG1[4:0] : Data time segment before sample point Valid values are 0 to 31. The value used by the hardware is the one programmed, incremented by 1, that is t   BS1   = (DTSEG1[4:0] + 1) ×   t q   . Bits 7:4   DTSEG2[3:0] : Data time segment after sample point Valid values are 0 to 15. The value used by the hardware is the one programmed, incremented by 1, i.e. t   BS2   = (DTSEG2[3:0] + 1) ×   t   q   . Bits 3:0   DSJW[3:0] : Synchronization jump width Valid values are 0 to 15. The value used by the hardware is the one programmed, incremented by 1: t   SJW   = (DSJW[3:0] + 1) ×   t   q   .

FD controller area network (FDCAN)   RM0490  922/1027   RM0490 Rev 5  28.4.5   FDCAN RAM watchdog register (FDCAN_RWD)  The RAM watchdog monitors the READY output of the message RAM. A message RAM access starts the message RAM watchdog counter with the value configured through the WDC[7:0] bitfield of the FDCAN_RWD register. The counter is reloaded with WDC[7:0] when the message RAM signals successful completion by activating its READY output. In case there is no response from the message RAM until the counter has counted down to 0, the counter stops, and the interrupt flag WDI is set in the FDCAN_IR register. The RAM watchdog counter is clocked by the fdcan_pclk clock. Address offset: 0x0014 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   RX   TX[1:0]   LBCK   Res.   Res.   Res.   Res. r   rw   rw   rw Bits 31:8   Reserved, must be kept at reset value. Bit 7   RX : Receive pin This bit is used to monitor the actual value of FDCANx_RX. It is synchronized with the FDCANx_RX pin, so it is set after reset if the FDCAN is connected to a network. 0: The CAN bus is dominant (FDCANx_RX = 0) 1: The CAN bus is recessive (FDCANx_RX = 1) Bits 6:5   TX[1:0] : Control of transmit pin 00: Reset value, FDCANx_TX TX is controlled by the CAN core, updated at the end of the CAN bit time 01: Sample point can be monitored at pin FDCANx_TX 10: Dominant (0) level at pin FDCANx_TX 11: Recessive (1) at pin FDCANx_TX Bit 4   LBCK : Loop-back mode 0: Reset value, loop-back mode is disabled 1: Loop-back mode is enabled (see   Power-down (Sleep mode) ) Bits 3:0   Reserved, must be kept at reset value. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 WDV[7:0]   WDC[7:0] r   r   r   r   r   r   r   r   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value.

RM0490 Rev 5   923/1027  RM0490   FD controller area network (FDCAN)  952  28.4.6   FDCAN CC control register (FDCAN_CCCR)  Address offset: 0x0018 Reset value: 0x0000 0001 For details about setting and clearing single bits, see   Software initialization . Bits 15:8   WDV[7:0] : Watchdog value Actual message RAM watchdog counter value. Bits 7:0   WDC[7:0] : Watchdog configuration Start value of the message RAM watchdog counter. With the reset value of 00, the counter is disabled. This bitfield is write-protected (P): write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 NISO   TXP   EFBI   PXHD   Res.   Res.   BRSE   FDOE   TEST   DAR   MON   CSR   CSA   ASM   CCE   INIT rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   r   rw   rw   rw Bits 31:16   Reserved, must be kept at reset value. Bit 15   NISO : Non-ISO operation If this bit is set, the FDCAN uses the CAN FD frame format as specified by the Bosch CAN FD Specification V1.0. 0: CAN FD frame format according to ISO11898-1 1: CAN FD frame format according to Bosch CAN FD Specification V1.0 Bit 14   TXP:   Transmit pause enable If this bit is set, the FDCAN pauses for two CAN bit times before starting the next transmission after successfully transmitting a frame. 0: Disabled 1: Enabled Bit 13   EFBI : Edge filtering during bus integration 0: Edge filtering disabled 1: Two consecutive dominant   t q   required to detect an edge for hard synchronization Bit 12   PXHD : Protocol exception handling disable 0: Protocol exception handling enabled 1: Protocol exception handling disabled Bits 11:10   Reserved, must be kept at reset value. Bit 9   BRSE : FDCAN bit rate switching 0: Bit rate switching for transmissions disabled 1: Bit rate switching for transmissions enabled Bit 8   FDOE : FD operation enable 0: FD operation disabled 1: FD operation enabled

FD controller area network (FDCAN)   RM0490  924/1027   RM0490 Rev 5  Note:   Due to the synchronization mechanism between the two clock domains, there can be a delay until the value written to INIT can be read back. Therefore, the programmer has to assure that the previous value written to INIT has been accepted by reading INIT before setting INIT to a new value.  28.4.7   FDCAN nominal bit timing and prescaler register (FDCAN_NBTP)  Address offset: 0x001C Reset value: 0x0600 0A03 Bit 7   TEST : Test mode enable 0: Normal operation, FDCAN_TEST holds reset values 1: Test mode, write access to FDCAN_TEST enabled Bit 6   DAR : Disable automatic retransmission 0: Automatic retransmission of messages not transmitted successfully enabled 1: Automatic retransmission disabled Bit 5   MON : Bus monitoring mode This bit can only be set by software when both CCE and INIT are set. The bit can be cleared by the host at any time. 0: Bus monitoring mode disabled 1: Bus monitoring mode enabled Bit 4   CSR : Clock stop request 0: No clock stop requested 1: Clock stop requested. When clock stop is requested, first INIT and then CSA is set after all pending transfer requests have been completed and the CAN bus is idle. Bit 3   CSA : Clock stop acknowledge 0: No clock stop acknowledged 1: FDCAN can be set in power-down by stopping APB clock and kernel clock. Bit 2   ASM : ASM restricted operation mode The restricted operation mode is intended for applications that adapt themselves to different CAN bit rates. The application tests different bit rates and leaves the restricted operation mode after it has received a valid frame. In the optional restricted operation mode the node is able to transmit and receive data and remote frames and it gives acknowledge to valid frames, but it does not send active error frames or over.load frames. In case of an error condition or overload condition, it does not send dominant bits, instead it waits for the occurrence of bus-idle condition to resynchronize itself to the CAN communication. The error counters are not incremented. Bit ASM can only be set by software when both CCE and INIT are set. The bit can be cleared by the software at any time. 0: Normal CAN operation 1: Restricted operation mode active Bit 1   CCE : Configuration change enable 0: The CPU has no write access to the protected configuration registers. 1: The CPU has write access to the protected configuration registers (while INIT set in FDCAN_CCCR). Bit 0   INIT : Initialization 0: Normal operation 1: Initialization started

RM0490 Rev 5   925/1027  RM0490   FD controller area network (FDCAN)  952  This register is only writable if the CCE and INIT bits of the FDCAN_CCCR register are both set. The CAN bit time can be programed in the range of 4 to 81 × t   q   . The CAN time quantum can be programmed in the range of 1 to 1024 FDCAN kernel clock periods: t q   = (BRP + 1) × FDCAN clock period fdcan_ker_ck. NTSEG1[7:0] is the sum of PROP_SEG and PHASE_SEG1. NTSEG2[6:0] is PHASE_SEG2. Therefore, the length of the bit time is (programmed values) × [NTSEG1[7:0] + NTSEG2[6:0] + 3] × t   q   or (functional values) × [SYNC_SEG + PROP_SEG + PHASE_SEG1 + PHASE_SEG2] × t   q   . The information processing time (IPT) is 0, meaning the data for the next bit is available at the first clock edge after the sample point.  Note:   With a CAN kernel clock of 48 MHz, the reset value of 0x0600 0A03 configures the FDCAN for a bit rate of 3 Mbit/s.  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 NSJW[6:0]   NBRP[8:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 NTSEG1[7:0]   Res.   NTSEG2[6:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:25   NSJW[6:0] : Nominal (re)synchronization jump width Valid values are 0 to 127. The actual interpretation by the hardware of this value is such that the used value is the one programmed incremented by one. This bitfield is write-protected (P): write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. Bits 24:16   NBRP[8:0] : Bit rate prescaler Value by which the oscillator frequency is divided for generating the bit time quanta. The bit time is built up from a multiple of this quantum. Valid values are 0 to 511. The actual interpretation by the hardware of this value is such that one more than the value programmed here is used. This bitfield is write-protected (P): write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. Bits 15:8   NTSEG1[7:0] : Nominal time segment before sample point Valid values are 0 to 255. The actual interpretation by the hardware of this value is such that one more than the programmed value is used. This bitfield is write-protected write (P): write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. Bit 7   Reserved, must be kept at reset value. Bits 6:0   NTSEG2[6:0] : Nominal time segment after sample point Valid values are 0 to 127. The actual interpretation by the hardware of this value is such that one more than the programmed value is used.

FD controller area network (FDCAN)   RM0490  926/1027   RM0490 Rev 5  28.4.8   FDCAN timestamp counter configuration register (FDCAN_TSCC)  Address offset: 0x0020 Reset value: 0x0000 0000  28.4.9   FDCAN timestamp counter value register (FDCAN_TSCV)  Address offset: 0x0024 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TCP[3:0] rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TSS[1:0] rw   rw Bits 31:20   Reserved, must be kept at reset value. Bits 19:16   TCP[3:0] : Timestamp counter prescaler Configures the timestamp and timeout counters time unit in multiples of CAN bit times [1…16]. The actual interpretation by the hardware of this value is such that one more than the value programmed here is used. In CAN FD mode, the internal timestamp counter TCP does not provide a constant time base due to the different CAN bit times between arbitration phase and data phase. Thus CAN FD requires an external counter for timestamp generation (TSS[1:0] = 10). This bitfield is write-protected (P): write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. Bits 15:2   Reserved, must be kept at reset value. Bits 1:0   TSS[1:0] : Timestamp select 00: Timestamp counter value always 0x0000 01: Timestamp counter value incremented according to TCP 10: External timestamp counter from TIM3 value (tim3_cnt[0:15]) 11: Same as 00. These bits are write-protected write (P): write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 TSC[15:0] rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w Bits 31:16   Reserved, must be kept at reset value.

RM0490 Rev 5   927/1027  RM0490   FD controller area network (FDCAN)  952  Note:   A “wrap around” is a change of the timestamp counter value from non-0 to 0 that is not caused by write access to FDCAN_TSCV.  28.4.10   FDCAN timeout counter configuration register (FDCAN_TOCC)  Address offset: 0x0028 Reset value: 0xFFFF 0000 For more details, see   Timeout counter . Bits 15:0   TSC[15:0] : Timestamp counter The internal/external timestamp counter value is captured on start of frame (both Rx and Tx). When TSS[1:0] = 01 in FDCAN_TSCC, the timestamp counter is incremented in multiples of CAN bit times [1 … 16] depending on the configuration of TCP[3:0] in FDCAN_TSCC. A wrap around sets the TSW interrupt flag in FDCAN_IR. Write access resets the counter to 0. When TSS[1:0] = 10, TSC[15:0] reflects the external timestamp counter value. A write access has no impact. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 TOP[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TOS[1:0]   ETOC rw   rw   rw Bits 31:16   TOP[15:0] : Timeout period Start value of the timeout counter (down-counter). Configures the timeout period. This bitfield is write-protected (P), write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. Bits 15:3   Reserved, must be kept at reset value. Bits 2:1   TOS[1:0] : Timeout select When operating in continuous mode, a write to FDCAN_TOCV presets the counter to the value configured by TOP[15:0] in FDCAN_TOCC and continues down-counting. When the timeout counter is controlled by one of the FIFOs, an empty FIFO presets the counter to the value configured by TOP[15:0]. Down-counting is started when the first FIFO element is stored. 00: Continuous operation 01: Timeout controlled by Tx event FIFO 10: Timeout controlled by Rx FIFO 0 11: Timeout controlled by Rx FIFO 1 This bitfield is write-protected (P), write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. Bit 0   ETOC : Timeout counter enable 0: Timeout counter disabled 1: Timeout counter enabled This bit is write-protected (P), write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set.

FD controller area network (FDCAN)   RM0490  928/1027   RM0490 Rev 5  28.4.11   FDCAN timeout counter value register (FDCAN_TOCV)  Address offset: 0x002C Reset value: 0x0000 FFFF  28.4.12   FDCAN error counter register (FDCAN_ECR)  Address offset: 0x0040 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 TOC[15:0] rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w   rc_w Bits 31:16   Reserved, must be kept at reset value. Bits 15:0   TOC[15:0] : Timeout counter The timeout counter is decremented in multiples of CAN bit times [1 … 16] depending on the configuration of the TCP[3:0] bitfield of the FDCAN_TSCC register. When decremented to 0, the TOO interrupt flag is set in FDCAN_IR and the timeout counter is stopped. Start and reset/restart conditions are configured via TOS[1:0] in FDCAN_TOCC. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CEL[7:0] rc_r   rc_r   rc_r   rc_r   rc_r   rc_r   rc_r   rc_r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 RP   REC[6:0]   TEC[7:0] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r Bits 31:24   Reserved, must be kept at reset value. Bits 23:16   CEL[7:0] : CAN error logging The counter is incremented each time when a CAN protocol error causes the transmit error counter or the receive error counter to be incremented. It is reset by read access to CEL[7:0]. The counter stops at 0xFF; the next increment of TEC[7:0] or REC[6:0] sets the ELO interrupt flag in FDCAN_IR. Access type is rc_r: cleared on read. Bit 15   RP : Receive error passive 0: The receive error counter is below the error passive level of 128. 1: The receive error counter has reached the error passive level of 128. Bits 14:8   REC[6:0]:   Receive error counter Actual state of the receive error counter, values between 0 and 127. Bits 7:0   TEC[7:0] : Transmit error counter Actual state of the transmit error counter, values between 0 and 255. When the ASM bit of the FDCAN_CCCR is set, the CAN protocol controller does not increment TEC and REC when a CAN protocol error is detected, but CEL[7:0] is still incremented.

RM0490 Rev 5   929/1027  RM0490   FD controller area network (FDCAN)  952  28.4.13   FDCAN protocol status register (FDCAN_PSR)  Address offset: 0x0044 Reset value: 0x0000 0707 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TDCV[6:0] r   r   r   r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   PXE   REDL   RBRS   RESI   DLEC[2:0]   BO   EW   EP   ACT[1:0]   LEC[2:0] rc_r   rc_r   rc_r   rc_r   rs   rs   rs   r   r   r   r   r   rs   rs   rs Bits 31:23   Reserved, must be kept at reset value. Bits 22:16   TDCV[6:0] : Transmitter delay compensation value Position of the secondary sample point, defined by the sum of the measured delay from FDCAN_TX to FDCAN_RX and TDCO[6:0] in FDCAN_TDCR. The SSP position is, in the data phase, the number of minimum time quanta (m   t q   ) between the start of the transmitted bit and the secondary sample point. Valid values are 0 to 127 × m   t q   . Bit 15   Reserved, must be kept at reset value. Bit 14   PXE : Protocol exception event 0: No protocol exception event occurred since last read access 1: Protocol exception event occurred Bit 13   REDL : Received FDCAN message This bit is set independent of acceptance filtering. 0: Since this bit was cleared by the CPU, no FDCAN message has been received. 1: Message in FDCAN format with EDL flag set has been received. Access type is rc_r: cleared on read. Bit 12   RBRS:   BRS flag of last received FDCAN message This bit is set together with REDL, independent of acceptance filtering. 0: Last received FDCAN message did not have its BRS flag set. 1: Last received FDCAN message had its BRS flag set. Access type is rc_r: cleared on read. Bit 11   RESI : ESI flag of last received FDCAN message This bit is set together with REDL, independent of acceptance filtering. 0: Last received FDCAN message did not have its ESI flag set. 1: Last received FDCAN message had its ESI flag set. Access type is rc_r: cleared on read. Bits 10:8   DLEC[2:0] : Data last error code Type of last error that occurred in the data phase of a FDCAN format frame with its BRS flag set. Coding is the same as for LEC[2:0]. This field is cleared when a FDCAN format frame with its BRS flag set has been transferred (reception or transmission) without error. Access type is rs: set on read. Bit 7   BO : Bus-off status 0: The FDCAN is not in bus-off state. 1: The FDCAN is in bus-off state.

FD controller area network (FDCAN)   RM0490  930/1027   RM0490 Rev 5  Note:   When a frame in FDCAN format has reached the data phase with the BRS flag set, the next CAN event (error or valid frame) is shown in DLEC[2:0] instead of LEC[2:0]. An error in a fixed stuff bit of an FDCAN CRC sequence is shown as a form error, not as a stuff error. The bus-off recovery sequence (see CAN Specification Rev. 2.0 or ISO11898-1) cannot be shortened by setting or clearing the INIT bit of the FDCAN_CCCR register. If the device enters bus-off, it sets the INIT bit of its own, stopping all bus activities. Once INIT has been cleared by the CPU, the device waits for 129 occurrences of bus-idle (129 × 11 consecutive recessive bits) before resuming normal operation. At the end of the bus-off recovery sequence, the error management counters are reset. During the waiting time after clearing INIT, each time a sequence of 11 recessive bits has been monitored, a bit0 error code is written to LEC[2:0] of FDCAN_PSR, enabling the CPU to check up whether the CAN bus is  Bit 6   EW : Warning status 0: Both error counters are below the error-warning limit of 96. 1: At least one of error counter has reached the error-warning limit of 96. Bit 5   EP : Error passive 0: The FDCAN is in the error-active state. It normally takes part in bus communication and sends an active error flag when an error has been detected. 1: The FDCAN is in the error-passive state. Bits 4:3   ACT[1:0] : Activity Monitors the module’s CAN communication state. 00: Synchronizing: node is synchronizing on CAN communication. 01: Idle: node is neither receiver nor transmitter. 10: Receiver: node is operating as receiver. 11: Transmitter: node is operating as transmitter. Bits 2:0   LEC[2:0]:   Last error code LEC[2:0] indicates the type of the last error to occur on the CAN bus. This bitfield is cleared when a message has been transferred (reception or transmission) without error. 000: No error occurred since LEC[2:0] has been cleared by successful reception or transmission. 001: Stuff error. More than five equal bits in a sequence have occurred in a part of a received message where this is not allowed. 010: Form error. A fixed format part of a received frame has the wrong format. 011: Ack error. The message transmitted by the FDCAN was not acknowledged by another node. 100: Bit1 error. During the transmission of a message (with the exception of the arbitration field), the device wanted to send a recessive level (bit of logical value 1), but the monitored bus value was dominant. 101: Bit0 error. During the transmission of a message (or acknowledge bit, or active error flag, or overload flag), the device wanted to send a dominant level (data or identifier bit logical value 0), but the monitored bus value was recessive. During bus-off recovery this status is set each time a sequence of 11 recessive bits has been monitored. This enables the CPU to monitor the proceeding of the bus-off recovery sequence (indicating the bus is not stuck at dominant or continuously disturbed). 110: CRC error. The CRC check sum of a received message was incorrect. The CRC of an incoming message does not match with the CRC calculated from the received data. 111: No change. Any read access to the protocol status register reinitializes LEC[2:0] to 7. When the LEC[2:0] shows the value 7, no CAN bus event was detected since the last CPU read access to the protocol status register. Access type is rs: set on read.

RM0490 Rev 5   931/1027  RM0490   FD controller area network (FDCAN)  952  stuck at dominant or continuously disturbed, and to monitor the bus-off recovery sequence. The REC[6:0] bitfield of the FDCAN_ECR register is used to count these sequences.  28.4.14   FDCAN transmitter delay compensation register (FDCAN_TDCR)  Address offset: 0x0048 Reset value: 0x0000 0000  28.4.15   FDCAN interrupt register (FDCAN_IR)  The flags are set when one of the listed conditions is detected (edge-sensitive). The flags remain set until the host clears them. A flag is cleared by writing 1 to the corresponding bit position. Writing 0 has no effect. A hard reset clears the register. The configuration of FDCAN_IE controls whether an interrupt is generated. The configuration of FDCAN_ILS controls on which interrupt line an interrupt is signaled. Address offset: 0x0050 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   TDCO[6:0]   Res.   TDCF[6:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:15   Reserved, must be kept at reset value. Bits 14:8   TDCO[6:0] : Transmitter delay compensation offset Offset value defining the distance between the measured delay from FDCAN_TX to FDCAN_RX and the secondary sample point. Valid values are 0 to 127 × m   t q   . This bitfield is write-protected (P), which means that write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. Bit 7   Reserved, must be kept at reset value. Bits 6:0   TDCF[6:0] : Transmitter delay compensation filter window length Defines the minimum value for the SSP position, dominant edges on FDCAN_RX that would result in an earlier SSP position are ignored for transmitter delay measurements. This bitfield is write-protected (P), which means that write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   ARA   PED   PEA   WDI   BO   EW   EP   ELO rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 TOO   MRAF   TSW   TEFL   TEFF   TEFN   TFE   TCF   TC   HPM   RF1L   RF1F   RF1N   RF0L   RF0F   RF0N rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1   rc_w1 Bits 31:24   Reserved, must be kept at reset value.

FD controller area network (FDCAN)   RM0490  932/1027   RM0490 Rev 5  Bit 23   ARA : Access to reserved address 0: No access to reserved address occurred 1: Access to reserved address occurred Bit 22   PED : Protocol error in data phase (data bit time is used) 0: No protocol error in data phase 1: Protocol error in data phase detected (DLEC[2:0] different from 0 and 7 in FDCAN_PSR) Bit 21   PEA : Protocol error in arbitration phase (nominal bit time is used) 0: No protocol error in arbitration phase 1: Protocol error in arbitration phase detected (LEC[2:0] different from 0 and 7 in FDCAN_PSR) Bit 20   WDI : Watchdog interrupt 0: No message RAM watchdog event occurred 1: Message RAM watchdog event due to missing READY Bit 19   BO : Bus-off status 0: Bus-off status unchanged 1: Bus-off status changed Bit 18   EW : Warning status 0: Error-warning status unchanged 1: Error-warning status changed Bit 17   EP : Error passive 0: Error-passive status unchanged 1: Error-passive status changed Bit 16   ELO : Error logging overflow 0: CAN error logging counter did not overflow. 1: Overflow of CAN error logging counter occurred. Bit 15   TOO : Timeout occurred 0: No timeout 1: Timeout reached Bit 14   MRAF : Message RAM access failure The flag is set when the Rx handler: -   has not completed acceptance filtering or storage of an accepted message until the arbitration field of the following message has been received. In this case acceptance filtering or message storage is aborted and the Rx handler starts processing of the following message. -   was unable to write a message to the message RAM. In this case message storage is aborted. In both cases the FIFO put index is not updated. The partly stored message is overwritten when the next message is stored to this location. The flag is also set when the Tx handler was not able to read a message from the message RAM in time. In this case message transmission is aborted. In case of a Tx handler access failure, the FDCAN is switched into restricted operation mode (see   Restricted operation mode ). To leave restricted operation mode, the host CPU has to clear the ASM of the FDCAN_CCCR register. 0: No message RAM access failure occurred 1: Message RAM access failure occurred

RM0490 Rev 5   933/1027  RM0490   FD controller area network (FDCAN)  952  Bit 13   TSW : Timestamp wraparound 0: No timestamp counter wrap-around 1: Timestamp counter wrapped around Bit 12   TEFL : Tx event FIFO element lost 0: No Tx event FIFO element lost 1: Tx event FIFO element lost Bit 11   TEFF : Tx event FIFO full 0: Tx event FIFO Not full 1: Tx event FIFO full Bit 10   TEFN : Tx event FIFO new entry 0: Tx event FIFO unchanged 1: Tx handler wrote Tx event FIFO element. Bit 9   TFE : Tx FIFO empty 0: Tx FIFO non-empty 1: Tx FIFO empty Bit 8   TCF : Transmission cancellation finished 0: No transmission cancellation finished 1: Transmission cancellation finished Bit 7   TC : Transmission completed 0: No transmission completed 1: Transmission completed Bit 6   HPM : High-priority message 0: No high-priority message received 1: High-priority message received Bit 5   RF1L : Rx FIFO 1 message lost 0: No Rx FIFO 1 message lost 1: Rx FIFO 1 message lost Bit 4   RF1F : Rx FIFO 1 full 0: Rx FIFO 1 not full 1: Rx FIFO 1 full Bit 3   RF1N : Rx FIFO 1 new message 0: No new message written to Rx FIFO 1 1: New message written to Rx FIFO 1 Bit 2   RF0L : Rx FIFO 0 message lost 0: No Rx FIFO 0 message lost 1: Rx FIFO 0 message lost Bit 1   RF0F : Rx FIFO 0 full 0: Rx FIFO 0 not full 1: Rx FIFO 0 full Bit 0   RF0N : Rx FIFO 0 new message 0: No new message written to Rx FIFO 0 1: New message written to Rx FIFO 0

FD controller area network (FDCAN)   RM0490  934/1027   RM0490 Rev 5  28.4.16   FDCAN interrupt enable register (FDCAN_IE)  The settings in the interrupt enable register determine which status changes in the interrupt register are signaled on an interrupt line. Address offset: 0x0054 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   ARAE   PEDE   PEAE   WDIE   BOE   EWE   EPE   ELOE rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 TOOE   MRAFE   TSWE   TEFLE   TEFFE   TEFNE   TFEE   TCFE   TCE   HPME   RF1LE   RF1FE   RF1NE   RF0LE   RF0FE   RF0NE rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:24   Reserved, must be kept at reset value. Bit 23   ARAE : Access to reserved address enable Bit 22   PEDE : Protocol error in data phase enable Bit 21   PEAE : Protocol error in arbitration phase enable Bit 20   WDIE : Watchdog interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 19   BOE : Bus-off status 0: Interrupt disabled 1: Interrupt enabled Bit 18   EWE : Warning status interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 17   EPE : Error passive interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 16   ELOE : Error logging overflow interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 15   TOOE : Timeout occurred interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 14   MRAFE:   Message RAM access failure interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 13   TSWE : Timestamp wraparound interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 12   TEFLE : Tx event FIFO element lost interrupt enable 0: Interrupt disabled 1: Interrupt enabled

RM0490 Rev 5   935/1027  RM0490   FD controller area network (FDCAN)  952  Bit 11   TEFFE : Tx event FIFO full interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 10   TEFNE : Tx event FIFO new entry interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 9   TFEE : Tx FIFO empty interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 8   TCFE : Transmission cancellation finished interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 7   TCE : Transmission completed interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 6   HPME : High-priority message interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 5   RF1LE : Rx FIFO 1 message lost interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 4   RF1FE : Rx FIFO 1 full interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 3   RF1NE : Rx FIFO 1 new message interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 2   RF0LE : Rx FIFO 0 message lost interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 1   RF0FE : Rx FIFO 0 full interrupt enable 0: Interrupt disabled 1: Interrupt enabled Bit 0   RF0NE : Rx FIFO 0 new message interrupt enable 0: Interrupt disabled 1: Interrupt enabled

FD controller area network (FDCAN)   RM0490  936/1027   RM0490 Rev 5  28.4.17   FDCAN interrupt line select register (FDCAN_ILS)  This register assigns an interrupt generated by a specific group of interrupt flags from the interrupt register to one of the two module interrupt lines. For interrupt generation, the respective interrupt line has to be enabled via the EINT0 and EINT1 bit of the FDCAN_ILE register. Address offset: 0x0058 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   PERR   BERR   MISC   TFERR   SMSG   RXFIF O1 RXFIF O0 rw   rw   rw   rw   rw   rw   rw Bits 31:7   Reserved, must be kept at reset value. Bit 6   PERR:   Protocol error grouping the following interruption ARAL: Access to reserved address line PEDL: Protocol error in data phase line PEAL: Protocol error in arbitration phase line WDIL: Watchdog interrupt line BOL: Bus-off status EWL: Warning status interrupt line Bit 5   BERR:   Bit and line error grouping the following interruption EPL Error passive interrupt line ELOL: Error logging overflow interrupt line Bit 4   MISC:   Interrupt regrouping the following interruption TOOL: Timeout occurred interrupt line MRAFL: Message RAM access failure interrupt line TSWL: Timestamp wraparound interrupt line Bit 3   TFERR:   Tx FIFO ERROR grouping the following interruption TEFLL: Tx event FIFO element lost interrupt line TEFFL: Tx event FIFO full interrupt line TEFNL: Tx event FIFO new entry interrupt line TFEL: Tx FIFO empty interrupt line Bit 2   SMSG:   Status message bit grouping the following interruption TCFL: Transmission cancellation finished interrupt line TCL: Transmission completed interrupt line HPML: High-priority message interrupt line Bit 1   RXFIFO1:   RX FIFO bit grouping the following interruption RF1LL: Rx FIFO 1 message lost interrupt line RF1FL: Rx FIFO 1 full interrupt line RF1NL: Rx FIFO 1 new message interrupt line

RM0490 Rev 5   937/1027  RM0490   FD controller area network (FDCAN)  952  28.4.18   FDCAN interrupt line enable register (FDCAN_ILE)  Each of the two interrupt lines to the CPU can be enabled/disabled separately by programming the EINT0 and EINT1 bits. Address offset: 0x005C Reset value: 0x0000 0000  28.4.19   FDCAN global filter configuration register (FDCAN_RXGFC)  Global settings for message ID filtering. The global filter configuration controls the filter path for standard and extended messages as described in   Figure 324   and   Figure 325 . Address offset: 0x0080 Reset value: 0x0000 0000 Bit 0   RXFIFO0:   RX FIFO bit grouping the following interruption RF0LL: Rx FIFO 0 message lost interrupt line RF0FL: Rx FIFO 0 full interrupt line RF0NL: Rx FIFO 0 new message interrupt line 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   EINT1   EINT0 rw   rw Bits 31:2   Reserved, must be kept at reset value. Bit 1   EINT1 : Enable interrupt line 1 0: Interrupt line fdcan_intr0_it disabled 1: Interrupt line fdcan_intr0_it enabled Bit 0   EINT0 : Enable interrupt line 0 0: Interrupt line fdcan_intr1_it disabled 1: Interrupt line fdcan_intr1_it enabled 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   LSE[3:0]   Res.   Res.   Res.   LSS[4:0] rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   F0OM   F1OM   Res.   Res.   ANFS[1:0]   ANFE[1:0]   RRFS   RRFE rw   rw   rw   rw   rw   rw   rw   rw Bits 31:28   Reserved, must be kept at reset value.

FD controller area network (FDCAN)   RM0490  938/1027   RM0490 Rev 5  Bits 27:24   LSE[3:0] : Number of extended filter elements in the list 0: No extended message ID filter 1 to 8: Number of extended message ID filter elements > 8: Values greater than 8 are interpreted as 8. This bitfield is write-protected (P), which means that write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. Bits 23:21   Reserved, must be kept at reset value. Bits 20:16   LSS[4:0] : Number of standard filter elements in the list 0: No standard message ID filter 1 to 28: Number of standard message ID filter elements > 28: Values greater than 28 are interpreted as 28. This bitfield is write protected (P), which means that write access by the bits is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. Bits 15:10   Reserved, must be kept at reset value. Bit 9   F0OM : FIFO 0 operation mode (overwrite or blocking) This bit is write-protected (P), which means that write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. Bit 8   F1OM : FIFO 1 operation mode (overwrite or blocking) This bit is write-protected (P), which means that write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. Bits 7:6   Reserved, must be kept at reset value. Bits 5:4   ANFS[1:0] : Accept Non-matching frames standard Defines how received messages with 11-bit IDs that do not match any element of the filter list are treated. 00: Accept in Rx FIFO 0 01: Accept in Rx FIFO 1 10: Reject 11: Reject This bitfield is write-protected (P), which means write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. Bits 3:2   ANFE[1:0] : Accept non-matching frames extended Defines how received messages with 29-bit IDs that do not match any element of the filter list are treated. 00: Accept in Rx FIFO 0 01: Accept in Rx FIFO 1 10: Reject 11: Reject This bitfield is write-protected (P), which means that write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. Bit 1   RRFS : Reject remote frames standard 0: Filter remote frames with 11-bit standard IDs 1: Reject all remote frames with 11-bit standard IDs This bit is write-protected (P), which means that write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set.

RM0490 Rev 5   939/1027  RM0490   FD controller area network (FDCAN)  952  28.4.20   FDCAN extended ID and mask register (FDCAN_XIDAM)  Address offset: 0x0084 Reset value: 0x1FFF FFFF  28.4.21   FDCAN high-priority message status register (FDCAN_HPMS)  This register is updated every time a message ID filter element configured to generate a priority event match. This can be used to monitor the status of incoming high priority messages and to enable fast access to these messages. Address offset: 0x0088 Reset value: 0x0000 0000 Bit 0   RRFE : Reject remote frames extended 0: Filter remote frames with 29-bit standard IDs 1: Reject all remote frames with 29-bit standard IDs This bit is write-protected (P), which means that write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   EIDM[28:16] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 EIDM[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw Bits 31:29   Reserved, must be kept at reset value. Bits 28:0   EIDM[28:0] : Extended ID mask For acceptance filtering of extended frames the extended ID AND mask is AND-ed with the message ID of a received frame. Intended for masking of 29-bit IDs in SAE J1939. With the reset value of all bits set, the mask is not active. This bitfield is write-protected (P), which means that write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 FLST   Res.   Res.   FIDX[4:0]   MSI[1:0]   Res.   Res.   Res.   BIDX[2:0] r   r   r   r   r   r   r   r   r   r   r Bits 31:16   Reserved, must be kept at reset value. Bit 15   FLST : Filter list Indicates the filter list of the matching filter element: 0: Standard filter list 1: Extended filter list Bits 14:13   Reserved, must be kept at reset value.

FD controller area network (FDCAN)   RM0490  940/1027   RM0490 Rev 5  28.4.22   FDCAN Rx FIFO 0 status register (FDCAN_RXF0S)  Address offset: 0x0090 Reset value: 0x0000 0000 Bits 12:8   FIDX[4:0] : Filter index Index of matching filter element. Range: 0 to LSS[4:0] - 1 or LSE[3:0] - 1 in FDCAN_RXGFC. Bits 7:6   MSI[1:0] : Message storage indicator 00: No FIFO selected 01: FIFO overrun 10: Message stored in FIFO 0 11: Message stored in FIFO 1 Bits 5:3   Reserved, must be kept at reset value. Bits 2:0   BIDX[2:0] : Buffer index Index of Rx FIFO element to which the message was stored. Only valid when MSI[1] = 1. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   RF0L   F0F   Res.   Res.   Res.   Res.   Res.   Res.   F0PI[1:0] r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   F0GI[1:0]   Res.   Res.   Res.   Res.   F0FL[3:0] r   r   r   r   r   r Bits 31:26   Reserved, must be kept at reset value. Bit 25   RF0L : Rx FIFO 0 message lost This bit is a copy of the RF0L interrupt flag of the FDCAN_IR register. When RF0L is cleared, this bit is also cleared. 0: No Rx FIFO 0 message lost 1: Rx FIFO 0 message lost, also set after write attempt to Rx FIFO 0 of size 0 Bit 24   F0F : Rx FIFO 0 full 0: Rx FIFO 0 not full 1: Rx FIFO 0 full Bits 23:18   Reserved, must be kept at reset value. Bits 17:16   F0PI[1:0] : Rx FIFO 0 put index Rx FIFO 0 write index pointer. Range: 0 to 2. Bits 15:10   Reserved, must be kept at reset value. Bits 9:8   F0GI[1:0] : Rx FIFO 0 get index Rx FIFO 0 read index pointer. Range: 0 to 2. Bits 7:4   Reserved, must be kept at reset value. Bits 3:0   F0FL[3:0] : Rx FIFO 0 fill level Number of elements stored in Rx FIFO 0. Range: 0 to 3.

RM0490 Rev 5   941/1027  RM0490   FD controller area network (FDCAN)  952  28.4.23   CAN Rx FIFO 0 acknowledge register (FDCAN_RXF0A)  Address offset: 0x0094 Reset value: 0x0000 0000  28.4.24   FDCAN Rx FIFO 1 status register (FDCAN_RXF1S)  Address offset: 0x0098 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   F0AI[2:0] rw   rw   rw Bits 31:3   Reserved, must be kept at reset value. Bits 2:0   F0AI[2:0] : Rx FIFO 0 acknowledge index After the host has read a message or a sequence of messages from Rx FIFO 0, it has to write the buffer index of the last element read from Rx FIFO 0 to F0AI[2:0]. This sets the Rx FIFO 0 get index (F0GI[1:0] of FDCAN_RXF0S) to F0AI[2:0] + 1 and updates the FIFO 0 fill level (F0FL[3:0] FDCAN_RXF0S). 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   RF1L   F1F   Res.   Res.   Res.   Res.   Res.   Res.   F1PI[1:0] r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   F1GI[1:0]   Res.   Res.   Res.   Res.   F1FL[3:0] r   r   r   r   r   r Bits 31:26   Reserved, must be kept at reset value. Bit 25   RF1L : Rx FIFO 1 message lost This bit is a copy of the RF1L interrupt flag of the FDCAN_IR register. When RF1L is cleared, this bit is also cleared. 0: No Rx FIFO 1 message lost 1: Rx FIFO 1 message lost, also set after write attempt to Rx FIFO 1 of size 0 Bit 24   F1F : Rx FIFO 1 full 0: Rx FIFO 1 not full 1: Rx FIFO 1 full Bits 23:18   Reserved, must be kept at reset value. Bits 17:16   F1PI[1:0] : Rx FIFO 1 put index Rx FIFO 1 write index pointer. Range: 0 to 2. Bits 15:10   Reserved, must be kept at reset value.

FD controller area network (FDCAN)   RM0490  942/1027   RM0490 Rev 5  28.4.25   FDCAN Rx FIFO 1 acknowledge register (FDCAN_RXF1A)  Address offset: 0x009C Reset value: 0x0000 0000  28.4.26   FDCAN Tx buffer configuration register (FDCAN_TXBC)  Address offset: 0x00C0 Reset value: 0x0000 0000 Bits 9:8   F1GI[1:0] : Rx FIFO 1 get index Rx FIFO 1 read index pointer. Range: 0 to 2. Bits 7:4   Reserved, must be kept at reset value. Bits 3:0   F1FL[3:0] : Rx FIFO 1 fill level Number of elements stored in Rx FIFO 1. Range: 0 to 3. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   F1AI[2:0] rw   rw   rw Bits 31:3   Reserved, must be kept at reset value. Bits 2:0   F1AI[2:0] : Rx FIFO 1 acknowledge index After the host has read a message or a sequence of messages from Rx FIFO 1, it has to write the buffer index of the last element read from Rx FIFO 1 to F1AI[2:0]. This sets the Rx FIFO 1 get index (F1GI[1:0] of FDCAN_RXF1S) to F1AI[2:0] + 1 and updates the FIFO 1 fill level (F1FL[3:0] FDCAN_RXF1S). 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   TFQM   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. Bits 31:25   Reserved, must be kept at reset value. Bit 24   TFQM : Tx FIFO/queue mode 0: Tx FIFO operation 1: Tx queue operation. This bit is write-protected (P), which means that write access is possible only when the CCE and INIT bits of the FDCAN_CCCR register are both set. Bits 23:0   Reserved, must be kept at reset value.

RM0490 Rev 5   943/1027  RM0490   FD controller area network (FDCAN)  952  28.4.27   FDCAN Tx FIFO/queue status register (FDCAN_TXFQS)  The Tx FIFO/queue status is related to the pending Tx requests listed in the FDCAN_TXBRP register. Therefore, the effect of add/cancellation requests can be delayed due to a running Tx scan (FDCAN_TXBRP not yet updated). Address offset: 0x00C4 Reset value: 0x0000 0003  28.4.28   FDCAN Tx buffer request pending register (FDCAN_TXBRP)  Address offset: 0x00C8 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TFQF   Res.   Res.   Res.   TFQPI[1:0] r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   TFGI[1:0]   Res.   Res.   Res.   Res.   Res.   TFFL[2:0] r   r   r   r   r Bits 31:22   Reserved, must be kept at reset value. Bit 21   TFQF : Tx FIFO/queue full 0: Tx FIFO/queue not full 1: Tx FIFO/queue full Bits 20:18   Reserved, must be kept at reset value. Bits 17:16   TFQPI[1:0] : Tx FIFO/queue put index Tx FIFO/queue write index pointer, range 0 to 3 Bits 15:10   Reserved, must be kept at reset value. Bits 9:8   TFGI[1:0] : Tx FIFO get index Tx FIFO read index pointer, range 0 to 3. Read as 0 when Tx queue operation is configured (TFQM = 1 in FDCAN_TXBC) Bits 7:3   Reserved, must be kept at reset value. Bits 2:0   TFFL[2:0] : Tx FIFO free level Number of consecutive free Tx FIFO elements starting from TFGI, range 0 to 3. Read as 0 when Tx queue operation is configured (TFQM = 1 in FDCAN_TXBC). 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TRP[2:0] r   r   r Bits 31:3   Reserved, must be kept at reset value.

FD controller area network (FDCAN)   RM0490  944/1027   RM0490 Rev 5  Note:   FDCAN_TXBRP bits set while a Tx scan is in progress are not considered during this particular Tx scan. In case a cancellation is requested for such a Tx buffer, this add request is canceled immediately. The corresponding FDCAN_TXBRP bit is cleared.  28.4.29   FDCAN Tx buffer add request register (FDCAN_TXBAR)  Address offset: 0x00CC Reset value: 0x0000 0000  Note:   If an add request is applied for a Tx buffer with pending transmission request (corresponding FDCAN_TXBRP bit already set), the request is ignored.  Bits 2:0   TRP[2:0] : Transmission request pending Each Tx buffer has its own transmission request pending bit. The bits are set via the FDCAN_TXBAR register. The bits are cleared after a requested transmission has completed or has been canceled via the FDCAN_TXBCR register. After the FDCAN_TXBRP bit has been set, a Tx scan is started to check for the pending Tx request with the highest priority (Tx buffer with lowest message ID). A cancellation request resets the corresponding transmission request pending bit of the FDCAN_TXBRP register. In case a transmission has already been started when a cancellation is requested, this is done at the end of the transmission, regardless whether the transmission was successful or not. The cancellation request bits are directly cleared after the corresponding FDCAN_TXBRP bit has been cleared. After a cancellation has been requested, a finished cancellation is signaled via the FDCAN_TXBCF in the following cases: –   after successful transmission together with the corresponding TXBTO bit –   when the transmission has not yet been started at the point of cancellation –   when the transmission has been aborted due to lost arbitration –   when an error occurred during frame transmission In DAR mode, all transmissions are automatically canceled if they are not successful. The corresponding FDCAN_TXBCF bit is set for all unsuccessful transmissions. 0: No transmission request pending 1: Transmission request pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   AR[2:0] rw   rw   rw Bits 31:3   Reserved, must be kept at reset value. Bits 2:0   AR[2:0] : Add request Each Tx buffer has its own add request bit. Writing a 1 sets the corresponding add request bit; writing a 0 has no impact. This enables the host to set transmission requests for multiple Tx buffers with one write to FDCAN_TXBAR. When no Tx scan is running, the bits are cleared immediately, else the bits remain set until the Tx scan process has completed. 0: No transmission request added 1: Transmission requested added.

RM0490 Rev 5   945/1027  RM0490   FD controller area network (FDCAN)  952  28.4.30   FDCAN Tx buffer cancellation request register (FDCAN_TXBCR)  Address offset: 0x00D0 Reset value: 0x0000 0000  28.4.31   FDCAN Tx buffer transmission occurred register (FDCAN_TXBTO)  Address offset: 0x00D4 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CR[2:0] rw   rw   rw Bits 31:3   Reserved, must be kept at reset value. Bits 2:0   CR[2:0] : Cancellation request Each Tx buffer has its own cancellation request bit. Writing a 1 sets the corresponding CR bit; writing a 0 has no impact. This enables the host to set cancellation requests for multiple Tx buffers with one write to FDCAN_TXBCR. The bits remain set until the corresponding FDCAN_TXBRP bit is cleared. 0: No cancellation pending 1: Cancellation pending 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TO[2:0] r   r   r Bits 31:3   Reserved, must be kept at reset value. Bits 2:0   TO[2:0] : Transmission occurred. Each Tx buffer has its own TO bit. The bits are set when the corresponding FDCAN_TXBRP bit is cleared after a successful transmission. The bits are cleared when a new transmission is requested by writing a 1 to the corresponding bit of register FDCAN_TXBAR. 0: No transmission occurred 1: Transmission occurred

FD controller area network (FDCAN)   RM0490  946/1027   RM0490 Rev 5  28.4.32   FDCAN Tx buffer cancellation finished register (FDCAN_TXBCF)  Address offset: 0x00D8 Reset value: 0x0000 0000  28.4.33   FDCAN Tx buffer transmission interrupt enable register (FDCAN_TXBTIE)  Address offset: 0x00DC Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CF[2:0] r   r   r Bits 31:3   Reserved, must be kept at reset value. Bits 2:0   CF[2:0] : Cancellation finished Each Tx buffer has its own CF bit. The bits are set when the corresponding FDCAN_TXBRP bit is cleared after a cancellation was requested via FDCAN_TXBCR. In case the corresponding FDCAN_TXBRP bit was not set at the point of cancellation, CF is set immediately. The bits are cleared when a new transmission is requested by writing a 1 to the corresponding bit of the FDCAN_TXBAR register. 0: No transmit buffer cancellation 1: Transmit buffer cancellation finished 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   TIE[2:0] rw   rw   rw Bits 31:3   Reserved, must be kept at reset value. Bits 2:0   TIE[2:0] : Transmission interrupt enable Each Tx buffer has its own TIE bit. 0: Transmission interrupt disabled 1: Transmission interrupt enable

RM0490 Rev 5   947/1027  RM0490   FD controller area network (FDCAN)  952  28.4.34   FDCAN Tx buffer cancellation finished interrupt enable register (FDCAN_TXBCIE)  Address offset: 0x00E0 Reset value: 0x0000 0000  28.4.35   FDCAN Tx event FIFO status register (FDCAN_TXEFS)  Address offset: 0x00E4 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   CFIE[2:0] rw   rw   rw Bits 31:3   Reserved, must be kept at reset value. Bits 2:0   CFIE[2:0] : Cancellation finished interrupt enable. Each Tx buffer has its own CFIE bit. 0: Cancellation finished interrupt disabled 1: Cancellation finished interrupt enabled 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   TEFL   EFF   Res.   Res.   Res.   Res.   Res.   Res.   EFPI[1:0] r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   EFGI[1:0]   Res.   Res.   Res.   Res.   Res.   EFFL[2:0] r   r   r   r   r Bits 31:26   Reserved, must be kept at reset value. Bit 25   TEFL : Tx event FIFO element lost This bit is a copy of the TEFL interrupt flag of the FDCAN_IR. When TEFL is cleared, this bit is also cleared. 0 No Tx event FIFO element lost 1 Tx event FIFO element lost, also set after write attempt to Tx event FIFO of size 0. Bit 24   EFF : Event FIFO full 0: Tx event FIFO not full 1: Tx event FIFO full Bits 23:18   Reserved, must be kept at reset value. Bits 17:16   EFPI[1:0] : Event FIFO put index Tx event FIFO write index pointer. Range: 0 to 3. Bits 15:10   Reserved, must be kept at reset value.

FD controller area network (FDCAN)   RM0490  948/1027   RM0490 Rev 5  28.4.36   FDCAN Tx event FIFO acknowledge register (FDCAN_TXEFA)  Address offset: 0x00E8 Reset value: 0x0000 0000  28.4.37   FDCAN CFG clock divider register (FDCAN_CKDIV)  Address offset: 0x0100 Reset value: 0x0000 0000 Bits 9:8   EFGI[1:0] : Event FIFO get index Tx event FIFO read index pointer. Range: 0 to 3. Bits 7:3   Reserved, must be kept at reset value. Bits 2:0   EFFL[2:0] : Event FIFO fill level Number of elements stored in Tx event FIFO. Range: 0 to 3. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   EFAI[1:0] rw   rw Bits 31:2   Reserved, must be kept at reset value. Bits 1:0   EFAI[1:0] : Event FIFO acknowledge index After the host has read an element or a sequence of elements from the Tx event FIFO, it has to write the index of the last element read from Tx event FIFO to EFAI[1:0]. This sets the Tx event FIFO get index (EFGI[1:0] of FDCAN_TXEFS) to EFAI[1:0] + 1 and updates the FIFO 0 fill level (EFFL[2:0] of FDCAN_TXEFS). 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   PDIV[3:0] rw   rw   rw   rw Bits 31:4   Reserved, must be kept at reset value.

RM0490 Rev 5   949/1027  RM0490   FD controller area network (FDCAN)  952  28.4.38   FDCAN register map  Bits 3:0   PDIV[3:0] : input clock divider The CAN kernel clock can be divided prior to be used by the CAN subsystem. The rate must be computed using the divider output clock. 0000: Divide by 1 0001: Divide by 2 0010: Divide by 4 0011: Divide by 6 0100: Divide by 8 0101: Divide by 10 0110: Divide by 12 0111: Divide by 14 1000: Divide by 16 1001: Divide by 18 1010: Divide by 20 1011: Divide by 22 1100: Divide by 24 1101: Divide by 26 1110: Divide by 28 1111: Divide by 30 This bitfield is write-protected (P): which means that write access is possible only when the CCE bit of the FDCAN_CCCR register is set.  Note:   The clock divider is common to all FDCAN instances. Only FDCAN1 instance has FDCAN_CKDIV register, which changes clock divider for all instances.  Table 153. FDCAN register map and reset values Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x0000 FDCAN_CREL REL[3:0] STEP[3:0] SUBSTEP [3:0] YEAR[3:0] MON[7:0] DAY[7:0] Reset value   0   0   0   0   0   0   0   1   1   1   1   0   1   0   1   0   0   1   1   0   1   1   1   1   1   0   1   0   0   0   1   0 0x0004 FDCAN_ENDN   ETV[31:0] Reset value   1   0   0   0   0   1   1   1   0   1   1   0   0   1   0   1   0   1   0   0   0   0   1   1   0   0   1   0   0   0   0   1 0x0008   Reserved   Reserved 0x000C FDCAN_DBTP Res. Res. Res. Res. Res. Res. Res. Res. TDC Res. Res. DBRP[4:0] Res. Res Res. DTSEG1[4:0] DTSEG2[3:0] DSJW[3:0] Reset value   0   0   0   0   0   0   0   0   0   1   0   1   0   0   0   1   1   0   0   1   1 0x0010 FDCAN_TEST Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. RX TX[1:0] LBCK Res. Res. Res. Res. Reset value   0   0   0   0 0x0014 FDCAN_RWD Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. WDV[7:0]   WDC[7:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0

FD controller area network (FDCAN)   RM0490  950/1027   RM0490 Rev 5  0x0018 FDCAN_CCCR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. NISO TXP EFBI PXHD Res. Res. BRSE FDOE TEST DAR MON CSR CSA ASM CCE INT Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   1 0x001C FDCAN_NBTP   NSJW[6:0]   NBRP[8:0]   NTSEG1[7:0] Res. NTSEG2[6:0] Reset value   0   0   0   0   0   1   1   0   0   0   0   0   0   0   0   0   0   0   0   0   1   0   1   0   0   0   0   0   0   0   1   1 0x0020 FDCAN_TSCC Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TCP[3:0] Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TSS[1:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x0024 FDCAN_TSCV Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TSC[15:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x0028 FDCAN_TOCC TOP[15:0] Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TOS[1:0] ETOC Reset value   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x002C FDCAN_TOCV Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TOC[15:0] Reset value   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 0x0030- 0x003C   Reserved   Reserved 0x0040 FDCAN_ECR Res. Res. Res. Res. Res. Res. Res. Res. CEL[7:0] RP   REC[6:0]   TEC[7:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x0044 FDCAN_PSR Res. Res. Res. Res. Res. Res. Res. Res. Res. TDCV[6:0] Res. PXE REDL RBRSRESI1 RESI DLEC[2:0] BO EW EP ACT[1:0] LEC[2;0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   1   1   1 0x0048 FDCAN_TDCR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TDCO[6:0] Res. TDCF[6:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x004C   Reserved   Reserved 0x0050 FDCAN_IR Res. Res. Res. Res. Res. Res. Res. Res. ARA PED PEA WDI BO EW EP ELO TOO MRAF TSW TEFL TEFF TEFN TFE TCF TC HPM RF1L RF1F RF1N RF0L RF0F RF0N Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x0054 FDCAN_IE Res. Res. Res. Res. Res. Res. Res. Res. ARAE PEDE PEAE WDIE BOE EWE EPE ELOE TOOE MRAFE TSWE TEFLE TEFFE TEFNE TFEE TCFE TCE HPME RF1LE RF1FE RF1NE RF0LE RF0FE RF0NE Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x0058 FDCAN_ILS Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PERR BERR MISC TFERR SMSG RXFIFO1 RXFIFO0 Reset value   0   0   0   0   0   0   0   0  Table 153. FDCAN register map and reset values (continued) Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

RM0490 Rev 5   951/1027  RM0490   FD controller area network (FDCAN)  952  0x005C FDCAN_ILE Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. EINT1 EINT0 Reset value   0   0 0x0060- 0x007C   Reserved   Reserved 0x0080 FDCAN _RXGFC Res. Res. Res. Res. LSE[3:0]. Res. Res. Res. LSS[4:0] Res. Res. Res. Res. Res. Res. F0OM F1OM Res. Res. ANFS[1:0] ANFE[1:0] RRFS RRFE Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x0084 FDCAN _XIDAM Res. Res. Res. EIDM[28:0] Reset value   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 0x0088 FDCAN_HPMS Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. FLST Res. Res. FIDX[4:0] MSI[1:0] Res. Res. Res. BIDX[2:0] Reset value   0   0   0   0   0   0   0   0   0   0   0 0x0090 FDCAN _RXF0S Res. Res. Res. Res. Res. Res. RF0L F0F Res. Res. Res. Res. Res. Res. F0PI[1:0] Res. Res. Res. Res. Res. Res. F0GI[1:0] Res. Res. Res. Res. F0FL[3:0] Reset value   0   0   0   0   0   0   0   0   0   0 0x0094 FDCAN _RXF0A Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. F0AI[2:0] Reset value   0   0   0 0x0098 FDCAN _RXF1S Res. Res. Res. Res. Res. Res. RF1L F1F Res. Res. Res. Res. Res. Res. F1PI[1:0] Res. Res. Res. Res. Res. Res. F1GI[1:0] Res. Res. Res. Res. F1FL[3:0] Reset value   0   0   0   0   0   0   0   0   0   0 0x009C FDCAN _RXF1A Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. F1AI[2:0] Reset value   0   0   0 0x00A0- 0x00BC   Reserved   Reserved 0x00C0 FDCAN _TXBC Res. Res. Res. Res. Res. Res. Res. TFQM Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Reset value   0   0 0x00C4 FDCAN _TXFQS Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TFQF Res. Res. Res. TFQPI[1:0] Res. Res. Res. Res. Res. Res. TFGI[1:0] Res. Res. Res. Res. Res. TFFL[2:0] Reset value   0   0   0   0   0   0   1   1 0x00C8 FDCAN _TXBRP Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TRP2 TRP1 TRP0 Reset value   0   0   0  Table 153. FDCAN register map and reset values (continued) Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

FD controller area network (FDCAN)   RM0490  952/1027   RM0490 Rev 5  Refer to   Section 2.2   for the register boundary addresses. 0x00CC FDCAN _TXBAR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. AR2 AR1 AR0 Reset value   0   0   0 0x00D0 FDCAN _TXBCR Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CR2 CR1 CR0 Reset value   0   0   0 0x00D4 FDCAN _TXBTO Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TO2 TO1 TO0 Reset value   0   0   0 0x00D8 FDCAN _TXBCF Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CF2 CF1 CF0 Reset value   0   0   0 0x00DC FDCAN _TXBTIE Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. TIE2 TIE1 TIE0 Reset value   0   0   0 0x00E0 FDCAN _TXBCIE Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. CFIE2 CFIE1 CFIE0 Reset value   0   0   0 0x00E4 FDCAN _TXEFS Res. Res. Res. Res. Res. Res. TEFL EFF Res. Res. Res. Res. Res. Res. EFPI[1:0] Res. Res. Res. Res. Res. Res. EFG[1:0] Res. Res. Res. Res. Res. EFFL[2:0] Reset value   0   0   0   0   0   0   0   0   0 0x00E8 FDCAN _TXEFA Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. EFAI[1:0] Reset value   0   0 0x0100 FDCAN _CKDIV Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. PDIV[3:0] Reset value   0   0   0   0  Table 153. FDCAN register map and reset values (continued) Offset   Register name 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

RM0490 Rev 5   953/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  29   Universal serial bus full-speed host/device interface (USB)  This section applies to STM32C071 devices only.  29.1   Introduction  The USB peripheral implements an interface between a full-speed USB 2.0 bus and the APB bus. USB suspend/resume are supported, which permits to stop the device clocks for low-power consumption.  29.2   USB main features  •   USB specification version 2.0 full-speed compliant  •   Supports both Host and Device modes  •   Configurable number of endpoints from 1 to 8  •   Dedicated packet buffer memory (SRAM) of 2048 bytes  •   Cyclic redundancy check (CRC) generation/checking, Non-return-to-zero Inverted (NRZI) encoding/decoding and bit-stuffing  •   Isochronous transfers support  •   Double-buffered bulk/isochronous endpoint/channel support  •   USB Suspend/Resume operations  •   Frame locked clock pulse generation  •   USB 2.0 Link Power Management support (Device mode only)  •   Battery Charging Specification Revision 1.2 support (Device mode only)  •   USB connect / disconnect capability (controllable embedded pull-up resistor on USB_DP line)  29.3   USB implementation  Table 154   describes the USB implementation in the devices.  Table 154. STM32C0 series USB implementation USB features (1)   USB  Host mode   X Number of endpoints   8 Size of dedicated packet buffer memory SRAM   2048 bytes Dedicated packet buffer memory SRAM access scheme   32 bits USB 2.0 Link Power Management (LPM) support in device   X

Universal serial bus full-speed host/device interface (USB)   RM0490  954/1027   RM0490 Rev 5  29.4   USB functional description 29.4.1   USB block diagram  Figure 326   shows the block diagram of the USB peripheral.  Figure 326. USB peripheral block diagram  Battery Charging Detection (BCD) support for device   X Embedded pull-up resistor on USB_DP line   X 1.   X= supported  Table 154. STM32C0 series USB implementation (continued) USB features (1)   USB  MSv74110V2 USB_DP USB PHY Register mapper APB interface PCLK   APB bus   IRQs to NVIC Arbiter   Packet buffer memory Register mapper Control registers and logic Interrupt registers and logic Endpoint/channel registers Endpoint/channel registers Suspend timer Packet buffer interface Analog transceiver USB_DM Interrupt mapper APB wrapper BCD Embedded pull-up USB_ker_ck (48 MHz) PCLK Host frame scheduler USB_ker_ck Serial interface engine (SIE) Control   Endpoint/ channel selection Clock recovery RX-TX

RM0490 Rev 5   955/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  29.4.2   USB pins and internal signals  29.4.3   USB reset and clocks  A single reset is present on USB. The RCC allows a reset to be forced by software. There are two clocks:  •   PCLK for the APB bus interface and registers.  •   USB_ker_ck (48 MHz) for the main protocol logic including notably the serial interface engine (SIE), see USB_ker_ck clock domain in block diagram.  29.4.4   General description and Device mode functionality  The USB peripheral provides a USB-compliant connection between the function implemented by the microcontroller and an external USB function which can be a host PC but also a USB Device. Data transfer between the external USB host or device and the system memory occurs through a dedicated packet buffer memory accessed directly by the USB peripheral. This dedicated memory size is 2048 bytes, and up to 16 mono-directional or 8 bidirectional endpoints can be used. The USB peripheral interfaces with the external USB Host or Device, detecting token packets, handling data transmission/reception, and processing handshake packets as required by the USB standard. Transaction formatting is performed by the hardware, including CRC generation and checking. Each endpoint/channel is associated with a buffer description block indicating where the endpoint/channel-related memory area is located, how large it is or how many bytes must be transmitted. When a token for a valid function/endpoint pair is recognized by the USB peripheral, the related data transfer (if required and if the endpoint/channel is configured) takes place. The data buffered by the USB peripheral are loaded in an internal 16-bit register and memory access to the dedicated buffer is performed. When all the data have been transferred, if needed, the proper handshake packet over the USB is generated or expected according to the direction of the transfer. At the end of the transaction, an endpoint/channel-specific interrupt is generated, reading status registers and/or using different interrupt response routines. The microcontroller can determine:  •   which endpoint/channel has to be served,  •   which type of transaction took place, if errors occurred (bit stuffing, format, CRC, protocol, missing ACK, over/underrun, etc.). Special support is offered to isochronous transfers and high throughput bulk transfers, implementing a double buffer usage, which permits to always have an available buffer for the USB peripheral while the microcontroller uses the other one. A special bit THR512 in register USB_ISTR allows notification of 512 bytes being received in (or transmitted from) the buffer. This bit must be used for long ISO packets (from 512 to 1023 bytes) as it facilitates early start or read/write of data. In this way, the first 512 bytes  Table 155. USB input/output pins Pin name   Pin type   Description  USB_DP   Digital input/output   D+ line USB_DM   Digital input/output   D- line

Universal serial bus full-speed host/device interface (USB)   RM0490  956/1027   RM0490 Rev 5  can be handled by software while avoiding use of double buffer mode. This bit works when only one ISO endpoint is configured. The unit can be placed in low-power mode (SUSPEND mode), by writing in the control register, whenever required. At this time, all static power dissipation is avoided, and the USB clock can be slowed down or stopped. The detection of activity at the USB inputs, while in low-power mode, wakes the device up asynchronously. A special interrupt source can be connected directly to a wake-up line to permit the system to immediately restart the normal clock generation and/or support direct clock start/stop.  Host mode and specific functionality  A single bit, HOST, in register USB_CNTR permits Host mode to be activated. Host mode functionality permits the USB to talk to a remote peripheral. Supported functionality is aligned to Device mode and uses the same register structures to manage the buffers. The same number of endpoints can be supported in Host mode, however in Host mode the terminology “channel” is preferred, as each channel is in reality a combination of the connected device and the endpoint on that device. The basic mechanisms for packet transmission and reception are the same as those supported in Device mode. When operating in Host mode, the USB is in charge of the bus and in order to do this must issue transaction requests corresponding to active periodic and non-periodic endpoints. A host frame scheduler assures efficient use of the frame. Connection to hubs is supported. Connection to low speed devices is supported, both with a direct connection and through a hub. Double-buffered mode, as previously described in Device mode, is also supported in Host mode, in both bulk and isochronous channels. The THR512 functionality is also supported (but as in Device mode) only for ISO traffic.  Note:   Unlike in Device mode, where there is a detection of battery charging capability (in order to facilitate fast charging), there is no integrated support in Host mode to present battery charging capability (CDP or DCP cases in the standard), the host port is always presented as a default standard data port (SDP). For LPM (link power management) this feature is not supported in Host mode.  29.4.5   Description of USB blocks used in both Device and Host modes  The USB peripheral implements all the features related to USB interfacing, which include the following blocks:  •   USB physical interface (USB PHY): this block is maintaining the electrical interface to an external USB host. It contains the differential analog transceiver itself, controllable embedded pull-up resistor (connected to USB_DP line) and support for battery charging detection (BCD), multiplexed on same USB_DP and USB_DM lines.  •   Serial interface engine (SIE): the functions of this block include: synchronization pattern recognition, bit-stuffing, CRC generation and checking, PID verification/generation, and handshake evaluation. It must interface with the USB transceivers and uses the virtual buffers provided by the packet buffer interface for local data storage. This unit also generates signals according to USB peripheral events, such as start of frame (SOF), USB_Reset, data errors etc. and to endpoint

RM0490 Rev 5   957/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  related events like end of transmission or correct reception of a packet; these signals are then used to generate interrupts.  •   Timer: this block generates a start-of-frame locked clock pulse and detects a global suspend (from the host) when no traffic has been received for 3 ms.  •   Packet buffer interface: this block manages the local memory implementing a set of buffers in a flexible way, both for transmission and reception. It can choose the proper buffer according to requests coming from the SIE and locate them in the memory addresses pointed by the endpoint/channel registers. It increments the address after each exchanged byte until the end of packet, keeping track of the number of exchanged bytes and preventing the buffer to overrun the maximum capacity.  •   Endpoint/channel-related registers: each endpoint/channel has an associated register containing the endpoint/channel type and its current status. For mono- directional/single-buffer endpoints, a single register can be used to implement two distinct endpoints. The number of registers is 8, allowing up to 16 mono- directional/single-buffer or up to 7 double-buffer endpoints in any combination. For example the USB peripheral can be programmed to have 4 double buffer endpoints and 8 single-buffer/mono-directional endpoints.  •   Control registers: these are the registers containing information about the status of the whole USB peripheral and used to force some USB events, such as resume and power-down.  •   Interrupt registers: these contain the interrupt masks and a record of the events. They can be used to inquire an interrupt reason, the interrupt status or to clear the status of a pending interrupt.  Note:   * Endpoint/channel 0 is always used for control transfer in single-buffer mode.  The USB peripheral is connected to the APB bus through an APB interface, containing the following blocks:  •   Packet memory: this is the local memory that physically contains the packet buffers. It can be used by the packet buffer interface, which creates the data structure and can be accessed directly by the application software. The size of the packet memory is 2048 bytes, structured as 512 words of 32 bits.  •   Arbiter: this block accepts memory requests coming from the APB bus and from the USB interface. It resolves the conflicts by giving priority to APB accesses, while always reserving half of the memory bandwidth to complete all USB transfers. This time-duplex scheme implements a virtual dual-port SRAM that allows memory access, while an USB transaction is happening. Multiword APB transfers of any length are also allowed by this scheme.  •   Register mapper: this block collects the various byte-wide and bit-wide registers of the USB peripheral in a structured 32-bit wide word set addressed by the APB.  •   APB wrapper: this provides an interface to the APB for the memory and register. It also maps the whole USB peripheral in the APB address space.  •   Interrupt mapper: this block is used to select how the possible USB events can generate interrupts and map them to the NVIC.  29.4.6   Description of host frame scheduler (HFS) specific to Host mode  The host frame scheduler is the hardware machine in charge to submit host channel requests on the bus according to the USB priority order and bandwidth access rules.

Universal serial bus full-speed host/device interface (USB)   RM0490  958/1027   RM0490 Rev 5  Host channels are divided in two categories: –   Periodic channels: isochronous and interrupt traffic types. With guaranteed bandwith access. –   Non-periodic channels: bulk and control traffic types. With best effort service. The host frame scheduler organizes the full-speed frame in 3 sequential windows –   Periodic service window –   Non-periodic service window –   Black security window At the start of a new frame, the host scheduler: 1.   First considers all periodic channels which were active (STAT bits VALID) at the start of frame 2.   Executes single round of service of periodic channels, the periodic service window, in hardware priority order from CH#1 to CH#8. For bidirectional channels it executes the OUT direction first 3.   When the periodic round is finished, HFS closes the periodic service window and stops servicing periodic traffic even if some periodic channel was re-enabled or some new channel was enabled after the SOF. 4.   Starts servicing all non-periodic channels which are currently active (STAT bits VALID) in hardware priority order from CH#1 to CH#8. For bidirectional channels it executes the OUT direction first. 5.   Executes multiple round-robin service cycles of non-periodic channels until almost the end of frame 6.   Non-periodic traffic can be requested at any time and is serviced by HFS with best effort latency, with the exception of a black security window at the end of the frame where new injected requests are directly postponed to the next frame to avoid babbles. This is also true for pending transactions which have not been serviced ahead of the security window.  29.5   Programming considerations for Device and Host modes  In the following sections, the expected interactions between the USB peripheral and the application program are described, in order to ease application software development.  29.5.1   Generic USB Device programming  This part describes the main tasks required of the application software in order to obtain USB compliant behavior. The actions related to the most general USB events are taken into account and paragraphs are dedicated to the special cases of double-buffered endpoints and isochronous transfers. Apart from system reset, an action is always initiated by the USB peripheral, driven by one of the USB events described below.

RM0490 Rev 5   959/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  29.5.2   System and power-on reset  Upon system and power-on reset, the first operation the application software must perform is to provide all required clock signals to the USB peripheral and subsequently de-assert its reset signal so to be able to access its registers. The whole initialization sequence is hereafter described. As a first step application software needs to activate register macrocell clock and de-assert macrocell specific reset signal using related control bits provided by device clock management logic. After that, the analog part of the device related to the USB transceiver must be switched on using the PDWN bit in CNTR register, which requires a special handling. This bit is intended to switch on the internal voltage references that supply the port transceiver. This circuit has a defined startup time (t   STARTUP   specified in the datasheet) during which the behavior of the USB transceiver is not defined. It is thus necessary to wait this time, after setting the PDWN bit in the CNTR register, before removing the reset condition on the USB part (by clearing the USBRST bit in the CNTR register). Clearing the ISTR register removes any spurious pending interrupt before any other macrocell operation is enabled. At system reset, the microcontroller must initialize all required registers and the packet buffer description table, to make the USB peripheral able to properly generate interrupts and data transfers. All registers not specific to any endpoint/channel must be initialized according to the needs of application software (choice of enabled interrupts, chosen address of packet buffers, etc.). Then the process continues as for the USB reset case (see further paragraph).  USB bus reset (RST_DCON interrupt) in Device mode  When this event occurs, the USB peripheral is put in the same conditions it is left by the system reset after the initialization described in the previous paragraph: communication is disabled in all endpoint registers (the USB peripheral does not respond to any packet). As a response to the USB reset event, the USB function must be enabled, having as USB address 0, implementing only the default control endpoint (endpoint address is 0 too). This is accomplished by setting the enable function (EF) bit of the USB_DADDR register and initializing the CHEP0R register and its related packet buffers accordingly. During USB enumeration process, the host assigns a unique address to this device, which must be written in the ADD[6:0] bits of the USB_DADDR register, and configures any other necessary endpoint. When a RST_DCON interrupt is received, the application software is responsible to enable again the default endpoint of USB function 0 within 10 ms from the end of the reset sequence which triggered the interrupt.  USB bus reset in Host mode  In Host mode a bus reset is activated by setting the USBRST bit of the USB_CNTR register. It must subsequently be cleared by software once the minimum active reset time from the standard has been respected.  Structure and usage of packet buffers  Each bidirectional endpoint can receive or transmit data over the bus. The received data is stored in a dedicated memory buffer reserved for that endpoint, while another memory buffer contains the data to be transmitted by the endpoint. Access to this memory is performed by the packet buffer interface block, which delivers a memory access request

Universal serial bus full-speed host/device interface (USB)   RM0490  960/1027   RM0490 Rev 5  and waits for its acknowledgment. Since the packet buffer memory has also to be accessed by the microcontroller, an arbitration logic takes care of the access conflicts, using half APB cycle for microcontroller access and the remaining half for the USB peripheral access. In this way, both agents can operate as if the packet memory would be a dual-port SRAM, without being aware of any conflict even when the microcontroller is performing back-to- back accesses. The USB peripheral logic uses a dedicated clock. The frequency of this dedicated clock is fixed by the requirements of the USB standard at 48 MHz, and this can be different from the clock used for the interface to the APB bus. Different clock configurations are possible where the APB clock frequency can be higher or lower than the USB peripheral one.  Note:   Due to USB data rate and packet memory interface requirements, the APB clock must have a minimum frequency of 12 MHz to avoid data overrun/underrun problems.  Each endpoint is associated with two packet buffers (usually one for transmission and the other one for reception). Buffers can be placed anywhere inside the packet memory because their location and size is specified in a buffer description table, which is also located in the packet memory. Each table entry is associated to an endpoint register and it is composed of two 32-bit words so that table start address must always be aligned to an 8- byte boundary. Buffer descriptor table entries are described in   Section 29.7: USBSRAM registers . If an endpoint is unidirectional and it is neither an isochronous nor a double- buffered bulk, only one packet buffer is required (the one related to the supported transfer direction). Other table locations related to unsupported transfer directions or unused endpoints, are available to the user. Isochronous and double-buffered bulk endpoints have special handling of packet buffers (Refer to   Section 29.5.5: Isochronous transfers in Device mode   and   Section 29.5.3: Double-buffered endpoints and usage in Device mode  respectively). The relationship between buffer description table entries and packet buffer areas is depicted in   Figure 327 . For Host mode different sections explain the buffer usage model, notably   Section 29.5.6: Isochronous transfers in Host mode   and   Section 29.5.4: Double buffered channels: usage in Host mode .

RM0490 Rev 5   961/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  Figure 327. Packet buffer areas with examples of buffer description table locations  Each packet buffer is used either during reception or transmission starting from the bottom. The USB peripheral never changes the contents of memory locations adjacent to the allocated memory buffers; if a packet bigger than the allocated buffer length is received (buffer overrun condition) the data is copied to the memory only up to the last available location.  Endpoint initialization  The first step to initialize an endpoint is to write appropriate values to the ADDRn_TX/ADDRn_RX fields in the CHEP_TXBD_n and CHEP_RXBD_n registers (in SRAM) so that the USB peripheral finds the data to be transmitted already available and the data to be received can be buffered. The UTYPE bits in the USB_CHEPnR register must be set according to the endpoint type, eventually using the EPKIND bit to enable any special required feature. On the transmit side, the endpoint must be enabled using the STATTX bits in the USB_CHEPnR register and COUNTn_TX must be initialized. For reception, STATRX bits must be set to enable reception and COUNTn_RX must be written with the allocated buffer size using the BLSIZE and NUM_BLOCK fields. Unidirectional endpoints, except isochronous and double-buffered bulk endpoints, need to initialize only bits and registers related to the supported direction. Once the transmission and/or reception are enabled, register USB_CHEPnR and locations ADDRn_TX/ADDRn_RX, COUNTn_TX/COUNTn_RX (respectively), must not be modified by the application software, as the hardware can  MSv74147V1 (*) indicates alternate mode.   Packet buffers USB_CHEP_RXTXBD_3* [TX] 0x1C Buffer for double-buffered IN endpoint 3 Buffer for double-buffered OUT endpoint 2 . . . Transmission buffer for single-buffered endpoint 1 Reception buffer for endpoint 0 Transmission buffer for endpoint 0 . . . . . . USB_CHEP_TXRXBD_3 [TX] 0x18 USB_CHEP_RXTXBD_2 [RX] 0x14 USB_CHEP_TXRXBD_2* [RX] 0x10 USB_CHEP_RXTXBD_1 [RX] 0x0C USB_CHEP_TXRXBD_1 [TX] 0x08 USB_CHEP_RXTXBD_0 [RX] 0x04 USB_CHEP_TXRXBD_0 [TX] 0x00 Not used Available buffer address range starting from offset 0x40 Available buffer descriptor address range starting from offset 0x00

Universal serial bus full-speed host/device interface (USB)   RM0490  962/1027   RM0490 Rev 5  change their value on the fly. When the data transfer operation is completed, notified by a CTR interrupt event, they can be accessed again to re-enable a new operation.  Data transmission in Device mode (IN packets)  When receiving an IN token packet, if the received address matches a configured and valid endpoint, the USB peripheral accesses the contents of CHEP_TXBD_n (fields ADDRn_TX and COUNTn_TX) inside the buffer descriptor table entry related to the addressed endpoint. The content of these locations is stored in its internal 16-bit registers ADDR and COUNT (not accessible by software). The packet memory is accessed again to read the first byte to be transmitted (refer to   Structure and usage of packet buffers on page 959 ) and the USB peripheral starts sending a DATA0 or DATA1 PID according to USB_CHEPnR bit DTOGTX. When the PID is completed, the first byte, read from buffer memory, is loaded into the output shift register to be transmitted on the USB bus. After the last data byte is transmitted, the computed CRC is sent. If the addressed endpoint is not valid, a NAK or STALL handshake packet is sent instead of the data packet, according to STATTX bits in the USB_CHEPnR register. The ADDRn_TX field in the internal register CHEP_TXBD_n is used as a pointer to the current buffer memory location while COUNT is used to count the number of remaining bytes to be transmitted. Each half-word read from the packet buffer memory is transmitted over the USB bus starting from the least significant byte. Transmission buffer memory is read starting from the address pointed by ADDRn_TX for COUNTn_TX/4 words. If a transmitted packet is composed of an odd number of bytes, only the lower half of the last half-word accessed is used. On receiving the ACK receipt by the host, the USB_CHEPnR register is updated in the following way: DTOGTX bit is toggled, the endpoint is made invalid by setting STATTX = 10 (NAK) and bit VTTX is set. The application software must first identify the endpoint, which is requesting microcontroller attention by examining the IDN and DIR bits in the USB_ISTR register. Servicing of the VTTX event starts, clearing the interrupt bit; the application software then prepares another buffer full of data to be sent, updates the COUNTn_TX table location with the number of byte to be transmitted during the next transfer, and finally sets STATTX to 11 (VALID) to re-enable transmission. While the STATTX bits are equal to 10 (NAK), any IN request addressed to that endpoint is NAKed, indicating a flow control condition: the USB host retries the transaction until it succeeds. It is mandatory to execute the sequence of operations in the above mentioned order to avoid losing the notification of a second IN transaction addressed to the same endpoint immediately following the one which triggered the CTR interrupt.  Data transmission in Host mode (OUT packets)  Data transmission in Host mode follows the same general principles as Device mode. The main differences are due to the protocol. For example the host initiates the transmission whereas the device responds to the incoming token. ADDRn_TX must be set to the location in the packet memory reserved for the packet for transmission. The contents of an OUT packet are then written to that address in the packet memory and COUNTn_TX must be updated (when necessary) to indicate the number of bytes in the packet. DEVADDR must be written for the correct endpoint and then STATTX must be set to 11 (VALID) in order to trigger the transmit. The transmission is then scheduled by the HFS. After a successful transmission the CTR interrupt (correct transfer) is triggered. By examining IDN and DIR bits, the corresponding channel and direction is understood. On the

RM0490 Rev 5   963/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  indicated channel, the STATTX field now has transitioned to DISABLE. In the case of a NAK being received (when the peripheral is not ready) STATTX is now in NAK. In the case of a STALL response, STATTX is in STALL. In this last case, the bus must be reset. On receiving the ACK receipt by the device, the USB_CHEPnR register is updated in the following way: DTOGTX bit is toggled. An error condition is signaled via the bits VTTX and ERR_TX if one of the following conditions occurs:  •   No handshake being received in time  •   False EOP  •   Bit stuffing error  •   Invalid handshake PID  Data reception in Device mode (OUT and SETUP packets)  These two tokens are handled by the USB peripheral more or less in the same way; the differences in the handling of SETUP packets are detailed in the following paragraph about control transfers. When receiving an OUT/SETUP PID, if the address matches a valid endpoint, the USB peripheral accesses the contents of the ADDRn_RX and COUNTn_RX fields inside the buffer descriptor table entry related to the addressed endpoint. The content of the ADDRn_RX field is stored directly in its internal register ADDR. Internal register COUNT is now reset and the values of BLSIZE and NUM_BLOCK bit fields, which are read within USB_CHEP_RXBD_n content, are used to initialize BUF_COUNT, an internal 16-bit counter, which is used to check the buffer overrun condition (all these internal registers are not accessible by software). Data bytes subsequently received by the USB peripheral are packed in half-words (the first byte received is stored as least significant byte) and then transferred to the packet buffer starting from the address contained in the internal ADDR register while BUF_COUNT is decremented and COUNT is incremented at each byte transfer. When the end of DATA packet is detected, the correctness of the received CRC is tested and only if no errors occurred during the reception, an ACK handshake packet is sent back to the transmitting host. In case of wrong CRC or other kinds of errors (bit-stuff violations, frame errors, etc.), data bytes are still copied in the packet memory buffer, at least until the error detection point, but the ACK packet is not sent and the ERR bit in USB_ISTR register is set. However, there is usually no software action required in this case: the USB peripheral recovers from reception errors and remains ready for the next transaction to come. If the addressed endpoint is not valid, a NAK or STALL handshake packet is sent instead of the ACK, according to bits STATRX in the USB_CHEPnR register, and no data is written in the reception memory buffers. Reception memory buffer locations are written starting from the address contained in the ADDRn_RX for a number of bytes corresponding to the received data packet length, or up to the last allocated memory location, as defined by BLSIZE and NUM_BLOCK, whichever comes first. In this way, the USB peripheral never writes beyond the end of the allocated reception memory buffer area. If the length of the data packet payload (actual number of bytes used by the application) is greater than the allocated buffer, the USB peripheral detects a buffer overrun condition. In this case, a STALL handshake is sent instead of the usual ACK to notify the problem to the host, no interrupt is generated and the transaction is considered failed. When the transaction is completed correctly, by sending the ACK handshake packet, the internal COUNT register is copied back in the COUNTn_RX location inside the buffer

Universal serial bus full-speed host/device interface (USB)   RM0490  964/1027   RM0490 Rev 5  description table entry, leaving unaffected BLSIZE and NUM_BLOCK fields, which normally do not require to be re-written, and the USB_CHEPnR register is updated in the following way: DTOGRX bit is toggled, the endpoint is made invalid by setting STATRX = 10 (NAK) and bit VTRX is set. If the transaction has failed due to errors or buffer overrun condition, none of the previously listed actions take place. The application software must first identify the endpoint, which is requesting microcontroller attention by examining the IDN and DIR bits in the USB_ISTR register. The VTRX event is serviced by first determining the transaction type (SETUP bit in the USB_CHEPnR register); the application software must clear the interrupt flag bit and get the number of received bytes reading the COUNTn_RX location inside the buffer description table entry related to the endpoint being processed. After the received data is processed, the application software must set the STATRX bits to 11 (VALID) in the USB_CHEPnR, enabling further transactions. While the STATRX bits are equal to 10 (NAK), any OUT request addressed to that endpoint is NAKed, indicating a flow control condition: the USB host retries the transaction until it succeeds. It is mandatory to execute the sequence of operations in the above mentioned order to avoid losing the notification of a second OUT transaction addressed to the same endpoint following immediately the one which triggered the CTR interrupt.  Data reception in Host mode (IN packets)  Data reception in Host mode follows the same general principles as Device mode. The main differences are again due to the protocol. In the device, data can be received or not, depending on readiness after previous operations, whereas the host only requests receive data when it is ready and able to store them. ADDRn_TX must be set to the location in the packet memory reserved for the packet for transmission. The contents received in the data phase response to the IN token packet are then written to that address in the packet memory and COUNTn_TX gets updated by hardware during this process to indicate the number of bytes in the packet. DEVADDR must be written for the correct endpoint and then STATRX must be set to VALID in order to trigger the reception. The reception is then scheduled by the HFS. After a successful reception the interrupt CTR (correct transfer) is triggered. By examining IDN and DIR bits, the corresponding channel and direction is understood. On the indicated channel, the STATRX field now has transitioned to DISABLE. In the case of a NAK being received (when the peripheral is not ready) STATRX now is in NAK. In the case of a STALL response, STATRX is in STALL. In this last case, the bus must be reset. During an IN packet an error condition is signaled via the bits VTRX and ERR_RX if one of the following conditions occurs:  •   False EOP  •   Bit stuffing error  •   Wrong CRC  Control transfers in Device mode  Control transfers are made of a SETUP transaction, followed by zero or more data stages, all of the same direction, followed by a status stage (a zero-byte transfer in the opposite direction). SETUP transactions are handled by control endpoints only and are very similar to OUT ones (data reception) except that the values of DTOGTX and DTOGRX bits of the addressed endpoint registers are set to 1 and 0 respectively, to initialize the control transfer, and both STATTX and STATRX are set to 10 (NAK) to let software decide if subsequent transactions must be IN or OUT depending on the SETUP contents. A control endpoint must check SETUP bit in the USB_CHEPnR register at each VTRX event to distinguish normal

RM0490 Rev 5   965/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  OUT transactions from SETUP ones. A USB Device can determine the number and direction of data stages by interpreting the data transferred in the SETUP stage, and is required to STALL the transaction in the case of errors. To do so, at all data stages before the last, the unused direction must be set to STALL, so that, if the host reverses the transfer direction too soon, it gets a STALL as a status stage. While enabling the last data stage, the opposite direction must be set to NAK, so that, if the host reverses the transfer direction (to perform the status stage) immediately, it is kept waiting for the completion of the control operation. If the control operation completes successfully, the software changes NAK to VALID, otherwise to STALL. At the same time, if the status stage is an OUT, the STATUS_OUT (EPKIND in the USB_CHEPnR register) bit must be set, so that an error is generated if a status transaction is performed with non-zero data. When the status transaction is serviced, the application clears the STATUS_OUT bit and sets STATRX to VALID (to accept a new command) and STATTX to NAK (to delay a possible status stage immediately following the next setup). Since the USB specification states that a SETUP packet cannot be answered with a handshake different from ACK, eventually aborting a previously issued command to start the new one, the USB logic does not permit a control endpoint to answer with a NAK or STALL packet to a SETUP token received from the host. When the STATRX bits are set to 01 (STALL) or 10 (NAK) and a SETUP token is received, the USB accepts the data, performing the required data transfers and sends back an ACK handshake. If that endpoint has a previously issued VTRX request not yet acknowledged by the application (for example VTRX bit is still set from a previously completed reception), the USB discards the SETUP transaction and does not answer with any handshake packet regardless of its state, simulating a reception error and forcing the host to send the SETUP token again. This is done to avoid losing the notification of a SETUP transaction addressed to the same endpoint immediately following the transaction, which triggered the VTRX interrupt.  Control transfers in Host mode  Control transfers are made of a SETUP transaction, followed by zero or more data stages, all of the same direction, followed by a status stage (a zero-byte transfer in the opposite direction). SETUP transactions are handled by control endpoints only. A control endpoint must set the SETUP bit in the USB_CHEPnR register. The values of DTOGTX and DTOGRX bits of the addressed endpoint registers are set to 0. Depending on whether it is a control write or control read then STATTX or STATRX are set to 11 (ACTIVE) in order to trigger the control transfer via the host frame scheduler. On receiving a CTR interrupt the channel (device address and endpoint) can be determined by examining IDN and DIR bits. Devices are expected to NAK every control unless the packet is corrupted in which case they do not acknowledge. The situation is reflected in the value of STATTX. In the case of an error condition the ERR bit gets set. One possible case is where a CRC error is seen at the device, in this case no ACK is returned to the host. The host sees no ACK and after an appropriate delay this generates a timeout error with ERR_TX set (which can generate an interrupt).

Universal serial bus full-speed host/device interface (USB)   RM0490  966/1027   RM0490 Rev 5  29.5.3   Double-buffered endpoints and usage in Device mode  All different endpoint types defined by the USB standard represent different traffic models, and describe the typical requirements of different kind of data transfer operations. When large portions of data are to be transferred between the host PC and the USB function, the bulk endpoint type is the most suited model. This is because the host schedules bulk transactions so as to fill all the available bandwidth in the frame, maximizing the actual transfer rate as long as the USB function is ready to handle a bulk transaction addressed to it. If the USB function is still busy with the previous transaction when the next one arrives, it answers with a NAK handshake and the host PC issues the same transaction again until the USB function is ready to handle it, reducing the actual transfer rate due to the bandwidth occupied by re-transmissions. For this reason, a dedicated feature called ‘double-buffering’ can be used with bulk endpoints. When ‘double-buffering’ is activated, data toggle sequencing is used to select, which buffer is to be used by the USB peripheral to perform the required data transfers, using both ‘transmission’ and ‘reception’ packet memory areas to manage buffer swapping on each successful transaction in order to always have a complete buffer to be used by the application, while the USB peripheral fills the other one. For example, during an OUT transaction directed to a ‘reception’ double-buffered bulk endpoint, while one buffer is being filled with new data coming from the USB host, the other one is available for the microcontroller software usage (the same would happen with a ‘transmission’ double- buffered bulk endpoint and an IN transaction). Since the swapped buffer management requires the usage of all 4 buffer description table locations hosting the address pointer and the length of the allocated memory buffers, the USB_CHEPnR registers used to implement double-buffered bulk endpoints are forced to be used as unidirectional ones. Therefore, only one STAT bit pair must be set at a value different from 00 (DISABLED): STATRX if the double-buffered bulk endpoint is enabled for reception, STATTX if the double-buffered bulk endpoint is enabled for transmission. In case it is required to have double-buffered bulk endpoints enabled both for reception and transmission, two USB_CHEPnR registers must be used. To exploit the double-buffering feature and reach the highest possible transfer rate, the endpoint flow control structure, described in previous chapters, has to be modified, in order to switch the endpoint status to NAK only when a buffer conflict occurs between the USB peripheral and application software, instead of doing it at the end of each successful transaction. The memory buffer which is currently being used by the USB peripheral is defined by the DTOG bit related to the endpoint direction: DTOGRX (bit 14 of USB_CHEPnR register) for ‘reception’ double-buffered bulk endpoints or DTOGTX (bit 6 of USB_CHEPnR register) for ‘transmission’ double-buffered bulk endpoints. To implement the new flow control scheme, the USB peripheral must know which packet buffer is currently in use by the application software, so to be aware of any conflict. Since in the USB_CHEPnR register, there are two DTOG bits but only one is used by USB peripheral for data and buffer sequencing (due to the unidirectional constraint required by double-buffering feature) the other one can be used by the application software to show which buffer it is currently using. This new buffer flag is called SW_BUF. In the following table the correspondence between USB_CHEPnR register bits and DTOG/SW_BUF definition is explained, for the cases of ‘transmission’ and ‘reception’ double-buffered bulk endpoints.

RM0490 Rev 5   967/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  The memory buffer which is currently being used by the USB peripheral is defined by DTOG buffer flag, while the buffer currently in use by application software is identified by SW_BUF buffer flag. The relationship between the buffer flag value and the used packet buffer is the same in both cases, and it is listed in the following table. Double-buffering feature for a bulk endpoint is activated by performing the two following actions:  •   Writing UTYPE bit field at 00 in its USB_CHEPnR register, to define the endpoint as a bulk  •   Setting EPKIND bit at 1 (DBL_BUF), in the same register.  Table 156. Double-buffering buffer flag definition Buffer flag   ‘Transmission’ endpoint   ‘Reception’ endpoint  DTOG   DTOGTX (USB_CHEPnR bit 6)   DTOGRX (USB_CHEPnR bit 14) SW_BUF   USB_CHEPnR bit 14   USB_CHEPnR bit 6  Table 157. Bulk double-buffering memory buffers usage (Device mode) Endpoint type   DTOG   SW_BUF   Packet buffer used by USB peripheral Packet buffer used by Application Software  Transmit (IN) 0   1 USB_CHEP_TXRXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations. USB_CHEP_RXTXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations 1   0 USB_CHEP_RXTXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations USB_CHEP_TXRXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations. 0   0   None   (1) 1.   Endpoint in NAK Status. USB_CHEP_TXRXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations. 1   1   None   (1) USB_CHEP_RXTXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations. Receive (OUT) 0   1 USB_CHEP_RXTXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations. USB_CHEP_TXRXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations. 1   0 USB_CHEP_TXRXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations USB_CHEP_RXTXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations. 0   0   None   (1) USB_CHEP_RXTXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations. 1   1   None   (1) USB_CHEP_TXRXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations.

Universal serial bus full-speed host/device interface (USB)   RM0490  968/1027   RM0490 Rev 5  The application software is responsible for DTOG and SW_BUF bits initialization according to the first buffer to be used; this has to be done considering the special toggle-only property that these two bits have. The end of the first transaction occurring after having set DBL_BUF, triggers the special flow control of double-buffered bulk endpoints, which is used for all other transactions addressed to this endpoint until DBL_BUF remain set. At the end of each transaction the VTRX or VTTX bit of the addressed endpoint USB_CHEPnR register is set, depending on the enabled direction. At the same time, the affected DTOG bit in the USB_CHEPnR register is hardware toggled making the USB peripheral buffer swapping completely software independent. Unlike common transactions, and the first one after DBL_BUF setting, STAT bit pair is not affected by the transaction termination and its value remains 11 (VALID). However, as the token packet of a new transaction is received, the actual endpoint status is masked as 10 (NAK) when a buffer conflict between the USB peripheral and the application software is detected (this condition is identified by DTOG and SW_BUF having the same value, see   Table 157 ). The application software responds to the CTR event notification by clearing the interrupt flag and starting any required handling of the completed transaction. When the application packet buffer usage is over, the software toggles the SW_BUF bit, writing 1 to it, to notify the USB peripheral about the availability of that buffer. In this way, the number of NAKed transactions is limited only by the application elaboration time of a transaction data: if the elaboration time is shorter than the time required to complete a transaction on the USB bus, no re-transmissions due to flow control takes place and the actual transfer rate is limited only by the host PC. The application software can always override the special flow control implemented for double-buffered bulk endpoints, writing an explicit status different from 11 (VALID) into the STAT bit pair of the related USB_CHEPnR register. In this case, the USB peripheral always uses the programmed endpoint status, regardless of the buffer usage condition.  29.5.4   Double buffered channels: usage in Host mode  In Host mode the underlying transmit and receive methods for double buffered channels are the same as those described for Device mode. Similar to the Device mode table, a new table below   Table 158: Bulk double-buffering memory buffers usage (Host mode)   shows the programming settings for OUT and IN tokens.

RM0490 Rev 5   969/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  29.5.5   Isochronous transfers in Device mode  The USB standard supports full speed peripherals requiring a fixed and accurate data production/consume frequency, defining this kind of traffic as ‘isochronous’. Typical examples of this data are: audio samples, compressed video streams, and in general any sort of sampled data having strict requirements for the accuracy of delivered frequency. When an endpoint is defined to be ‘isochronous’ during the enumeration phase, the host allocates in the frame the required bandwidth and delivers exactly one IN or OUT packet each frame, depending on endpoint direction. To limit the bandwidth requirements, no re- transmission of failed transactions is possible for isochronous traffic; this leads to the fact that an isochronous transaction does not have a handshake phase and no ACK packet is expected or sent after the data packet. For the same reason, isochronous transfers do not support data toggle sequencing and always use DATA0 PID to start any data packet. The isochronous behavior for an endpoint is selected by setting the UTYPE bits at 10 in its USB_CHEPnR register; since there is no handshake phase the only legal values for the STATRX/STATTX bit pairs are 00 (DISABLED) and 11 (VALID), any other value produces results not compliant to USB standard. Isochronous endpoints implement double-buffering  Table 158. Bulk double-buffering memory buffers usage (Host mode) Endpoint type   DTOG   SW_BUF   Packet buffer used by USB peripheral Packet buffer used by Application Software  Transmit (OUT) 0   1 USB_CHEP_TXRXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations. USB_CHEP_RXTXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations 1   0 USB_CHEP_RXTXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations USB_CHEP_TXRXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations. 0   0   None   (1) 1.   Endpoint in NAK Status. USB_CHEP_TXRXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations. 1   1   None   (1) USB_CHEP_RXTXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations. Receive (IN) 0   1 USB_CHEP_RXTXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations. USB_CHEP_TXRXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations. 1   0 USB_CHEP_TXRXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations USB_CHEP_RXTXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations. 0   0   None   (1) USB_CHEP_RXTXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations. 1   1   None   (1) USB_CHEP_TXRXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations.

Universal serial bus full-speed host/device interface (USB)   RM0490  970/1027   RM0490 Rev 5  to ease application software development, using both ‘transmission’ and ‘reception’ packet memory areas to manage buffer swapping on each successful transaction in order to have always a complete buffer to be used by the application, while the USB peripheral fills the other. The memory buffer which is currently used by the USB peripheral is defined by the DTOG bit related to the endpoint direction (DTOGRX for ‘reception’ isochronous endpoints, DTOGTX for ‘transmission’ isochronous endpoints, both in the related USB_CHEPnR register) according to   Table 159 . As it happens with double-buffered bulk endpoints, the USB_CHEPnR registers used to implement isochronous endpoints are forced to be used as unidirectional ones. In case it is required to have isochronous endpoints enabled both for reception and transmission, two USB_CHEPnR registers must be used. The application software is responsible for the DTOG bit initialization according to the first buffer to be used; this has to be done considering the special toggle-only property that these two bits have. At the end of each transaction, the VTRX or VTTX bit of the addressed endpoint USB_CHEPnR register is set, depending on the enabled direction. At the same time, the affected DTOG bit in the USB_CHEPnR register is hardware toggled making buffer swapping completely software independent. STAT bit pair is not affected by transaction completion; since no flow control is possible for isochronous transfers due to the lack of handshake phase, the endpoint remains always 11 (VALID). CRC errors or buffer-overrun conditions occurring during isochronous OUT transfers are anyway considered as correct transactions and they always trigger a VTRX event. However, CRC errors set the ERR bit in the USB_ISTR register anyway, in order to notify the software of the possible data corruption.  29.5.6   Isochronous transfers in Host mode  From the host point of view isochronous packets are issued or requested one by frame by the host frame scheduler. There is no NAK/ACK protocol and no resend of data or token.  Table 159. Isochronous memory buffers usage Endpoint Type DTOG bit value Packet buffer used by the USB peripheral Packet buffer used by the application software  Transmit (IN) 0 USB_CHEP_TXRXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations. USB_CHEP_RXTXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations 1 USB_CHEP_RXTXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations USB_CHEP_TXRXBD_0 (ADDR_TX / COUNT_TX) Buffer description table locations. Receive (OUT) 0 USB_CHEP_RXTXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations. USB_CHEP_TXRXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations. 1 USB_CHEP_TXRXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations USB_CHEP_RXTXBD_0 (ADDR_RX / COUNT_RX) Buffer description table locations.

RM0490 Rev 5   971/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  The mechanism is based on a table very similar to that for Device mode. See   Table 160   to understand the relationship between the DTOG bit buffers and the buffer usage. The isochronous behavior for an endpoint is selected by setting the UTYPE bits at 10 in its USB_CHEPnR register; since there is no handshake phase the only legal values for the STATRX/STATTX bit pairs are 00 (DISABLED) and 11 (VALID), Just as in Device mode, the mechanism allows automatic toggle of the DTOG bit. Note that in Host mode, at the same time as this toggle, the STATTX or STATRX of the completed buffer is automatically set to DISABLED, permitting the future buffer to be accessed before re-enabling it by setting it to 11 (VALID).  29.5.7   Suspend/resume events  The USB standard defines a special peripheral state, called SUSPEND, in which the average current drawn from the USB bus must not be greater than 2.5 mA. This requirement is of fundamental importance for bus-powered devices, while self-powered devices are not required to comply to this strict power consumption constraint. In suspend mode, the host PC sends the notification by not sending any traffic on the USB bus for more than 3 ms: since a SOF packet must be sent every 1 ms during normal operations, the USB peripheral detects the lack of 3 consecutive SOF packets as a suspend request from the host PC and set the SUSP bit to 1 in USB_ISTR register, causing an interrupt if enabled. Once the device is suspended, its normal operation can be restored by a so called RESUME sequence, which can be started from the host PC or directly from the peripheral itself, but it is always terminated by the host PC. The suspended USB peripheral must be anyway able to detect a RESET sequence, reacting to this event as a normal USB reset event. The actual procedure used to suspend the USB peripheral is device dependent since according to the device composition, different actions may be required to reduce the total consumption.  Table 160. Isochronous memory buffers usage Endpoint Type DTOG bit value Packet buffer used by the USB peripheral Packet buffer used by the application software  Transmit (OUT) 0 USB_CHEP_TXRXBD_0 (ADDRn_TX / COUNTn_TX) Buffer description table locations. USB_CHEP_RXTXBD_0 (ADDRn_TX / COUNTn_TX) Buffer description table locations 1 USB_CHEP_RXTXBD_0 (ADDRn_TX / COUNTn_TX) Buffer description table locations USB_CHEP_TXRXBD_0 (ADDRn_TX / COUNTn_TX) Buffer description table locations. Receive (IN) 0 USB_CHEP_RXTXBD_0 (ADDRn_RX / COUNTn_RX) Buffer description table locations. USB_CHEP_TXRXBD_0 (ADDRn_RX / COUNTn_RX) Buffer description table locations. 1 USB_CHEP_TXRXBD_0 (ADDRn_RX / COUNTn_RX) Buffer description table locations USB_CHEP_RXTXBD_0 (ADDRn_RX / COUNTn_RX) Buffer description table locations.

Universal serial bus full-speed host/device interface (USB)   RM0490  972/1027   RM0490 Rev 5  A brief description of a typical suspend procedure is provided below, focused on the USB- related aspects of the application software routine responding to the SUSP notification of the USB peripheral: 1.   Set the SUSPEN bit in the USB_CNTR register to 1. This action activates the suspend mode within the USB peripheral. As soon as the suspend mode is activated, the check on SOF reception is disabled to avoid any further SUSP interrupts being issued while the USB is suspended. 2.   Remove or reduce any static power consumption in blocks different from the USB peripheral. 3.   Set SUSPRDY bit in USB_CNTR register to 1 to remove static power consumption in the analog USB transceivers but keeping them able to detect resume activity. 4.   Optionally turn off external oscillator and device PLL to stop any activity inside the device. When an USB event occurs while the device is in SUSPEND mode, the RESUME procedure must be invoked to restore nominal clocks and regain normal USB behavior. Particular care must be taken to ensure that this process does not take more than 10 ms when the wakening event is an USB reset sequence (see “Universal Serial Bus Specification” for more details). The start of a resume or reset sequence, while the USB peripheral is suspended, clears the SUSPRDY bit in USB_CNTR register asynchronously. Even if this event can trigger a WKUP interrupt if enabled, the use of an interrupt response routine must be carefully evaluated because of the long latency due to system clock restart; to have the shorter latency before re-activating the nominal clock it is suggested to put the resume procedure just after the end of the suspend one, so its code is immediately executed as soon as the system clock restarts. To prevent ESD discharges or any other kind of noise from waking-up the system (the exit from suspend mode is an asynchronous event), a suitable analog filter on data line status is activated during suspend; the filter width is about 70 ns. The following is a list of actions a resume procedure must address: 1.   Optionally turn on external oscillator and/or device PLL. 2.   Clear SUSPEN bit of USB_CNTR register. 3.   If the resume triggering event has to be identified, bits RXDP and RXDM in the USB_FNR register can be used according to   Table 161 , which also lists the intended software action in all the cases. If required, the end of resume or reset sequence can be detected monitoring the status of the above mentioned bits by checking when they reach the “10” configuration, which represent the idle bus state; moreover at the end of a reset sequence the RST_DCON bit in USB_ISTR register is set to 1, issuing an interrupt if enabled, which must be handled as usual.

RM0490 Rev 5   973/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  A device may require to exit from suspend mode as an answer to particular events not directly related to the USB protocol (for example a mouse movement wakes up the whole system). In this case, the resume sequence can be started by setting the L2RES bit in the USB_CNTR register to 1 and resetting it to 0 after an interval between 1 ms and 15 ms (this interval can be timed using ESOF interrupts, occurring with a 1 ms period when the system clock is running at nominal frequency). Once the L2RES bit is clear, the resume sequence is completed by the host PC and its end can be monitored again using the RXDP and RXDM bits in the USB_FNR register.  Note:   The L2RES bit must be anyway used only after the USB peripheral has been put in suspend mode, setting the SUSPEN bit in USB_CNTR register to 1.  Suspend and resume in Host mode  The basics of the suspend and resume mechanism has been described in the previous section. From the host stand-point, suspend is entered by writing the SUSPEN bit in USB_CNTR. When suspend entry is confirmed, SUSPRDY (also in USB_CNTR) is set. Once in suspend, and when the application want to resume the bus, this can be done by setting the L2RES bit in USB_CNTR to 1. Below in   Table 162 , the different actions recommended after a wake-up event are indicated. According to the different line states after a wake-up event, the interpretation of the event and the suggested behavior are shown. Note that, this table here is somewhat expanded when compared to the previously shown device table, as the host may encounter both full speed and low speed devices which use different line states for both suspend and resume.  Table 161. Resume event detection [RXDP,RXDM] status   Wake-up event   Required resume software action  “00”   Root reset   None “10”   None (noise on bus)   Go back in Suspend mode “01”   Root resume   None “11”   Not allowed (noise on bus)   Go back in Suspend mode

Universal serial bus full-speed host/device interface (USB)   RM0490  974/1027   RM0490 Rev 5  Table 162. Resume event detection for host [RXDP,RXDM] status   Wake-up event   Required resume software action  “00”   Not allowed (noise on bus)   Go back in Suspend mode “10” Full speed capable device: Not allowed (noise on bus) Low speed device: Device remote wake-up resume None “01” Full speed capable device: Device remote wake-up resume Low speed device: Not allowed (noise on bus) None “11”   Not allowed (noise on bus)   Go back in Suspend mode

RM0490 Rev 5   975/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  29.6   USB registers  The USB peripheral registers can be divided into the following groups:  •   Common registers: interrupt and control registers. These registers affect the general behavior of the USB peripheral defining operating mode, interrupt handling, device address and giving access to the current frame number updated by the host PC. –   USB_CNTR –   USB_ISTR –   USB_FNR –   USB_DADDR –   USB_LPMCSR –   USB_BCDR  •   Endpoint/channel registers: endpoint/channel configuration and status –   USB_CHEPnR Refer to   Section 1.2   for a list of abbreviations used in register descriptions. The peripheral registers can be accessed by words (32-bit).  29.6.1   USB control register (USB_CNTR)  Address offset: 0x40 Reset value: 0x0000 0003 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 HOST   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   DDISC M THR 512M rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CTRM   PMA OVRM   ERRM   WKUP M SUSP M RST_D CONM   SOFM   ESOF M L1REQ M   Res.   L1RE S L2RE S SUS PEN SUSP RDY   PDWN   USB RST rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   r   rw   rw  Bit 31   HOST:   HOST mode HOST bit selects betweens host or device USB mode of operation. It must be set before enabling the USB peripheral by the function enable bit. 0: USB Device function 1: USB host function Bits 30:18   Reserved, must be kept at reset value. Bit 17   DDISCM : Device disconnection mask – Host mode 0: Device disconnection interrupt disabled 1: Device disconnection interrupt enabled Bit 16   THR512M : 512 byte threshold interrupt mask 0: 512 byte threshold interrupt disabled 1: 512 byte threshold interrupt enabled

Universal serial bus full-speed host/device interface (USB)   RM0490  976/1027   RM0490 Rev 5  Bit 15   CTRM:   Correct transfer interrupt mask 0: Correct transfer (CTR) interrupt disabled. 1: CTR interrupt enabled, an interrupt request is generated when the corresponding bit in the USB_ISTR register is set. Bit 14   PMAOVRM:   Packet memory area over / underrun interrupt mask 0: PMAOVR interrupt disabled. 1: PMAOVR interrupt enabled, an interrupt request is generated when the corresponding bit in the USB_ISTR register is set. Bit 13   ERRM:   Error interrupt mask 0: ERR interrupt disabled. 1: ERR interrupt enabled, an interrupt request is generated when the corresponding bit in the USB_ISTR register is set. Bit 12   WKUPM:   Wake-up interrupt mask 0: WKUP interrupt disabled. 1: WKUP interrupt enabled, an interrupt request is generated when the corresponding bit in the USB_ISTR register is set. Bit 11   SUSPM:   Suspend mode interrupt mask 0: Suspend mode request (SUSP) interrupt disabled. 1: SUSP interrupt enabled, an interrupt request is generated when the corresponding bit in the USB_ISTR register is set. Bit 10   RST_DCONM:   USB reset request (Device mode) or device connect/disconnect (Host mode) interrupt mask 0: RESET interrupt disabled. 1: RESET interrupt enabled, an interrupt request is generated when the corresponding bit in the USB_ISTR register is set. Bit 9   SOFM:   Start of frame interrupt mask 0: SOF interrupt disabled. 1: SOF interrupt enabled, an interrupt request is generated when the corresponding bit in the USB_ISTR register is set. Bit 8   ESOFM:   Expected start of frame interrupt mask 0: Expected start of frame (ESOF) interrupt disabled. 1: ESOF interrupt enabled, an interrupt request is generated when the corresponding bit in the USB_ISTR register is set. Bit 7   L1REQM:   LPM L1 state request interrupt mask 0: LPM L1 state request (L1REQ) interrupt disabled. 1: L1REQ interrupt enabled, an interrupt request is generated when the corresponding bit in the USB_ISTR register is set. Bit 6   Reserved, must be kept at reset value. Bit 5   L1RES:   L1 remote wake-up / resume driver – Device mode Software sets this bit to send a LPM L1 50   μ s remote wake-up signaling to the host. After the signaling ends, this bit is cleared by hardware. 0: No effect  1: Send 50   μ s remote-wake-up signaling to host

RM0490 Rev 5   977/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  Bit 4   L2RES:   L2 remote wake-up / resume driver – Device mode The microcontroller can set this bit to send remote wake-up signaling to the host. It must be activated, according to USB specifications, for no less than 1 ms and no more than 15 ms after which the host PC is ready to drive the resume sequence up to its end. – Host mode Software sets this bit to send resume signaling to the device. Software clears this bit to send end of resume to device and restart SOF generation. In the context of remote wake up, this bit is to be set following the WAKEUP interrupt. 0: No effect  1: Send L2 resume signaling to device Bit 3   SUSPEN:   Suspend state enable – Condition: Device mode Software can set this bit when the SUSP interrupt is received, which is issued when no traffic is received by the USB peripheral for 3 ms. Software can also set this bit when the L1REQ interrupt is received with positive acknowledge sent. As soon as the suspend state is propagated internally all device activity is stopped, USB clock is gated, USB transceiver is set into low power mode and the SUSPRDY bit is set by hardware. In the case that device application wants to pursue more aggressive power saving by stopping the USB clock source and by moving the microcontroller to stop mode, as in the case of bus powered device application, it must first wait few cycles to see the SUSPRDY = 1 acknowledge the suspend request. This bit is cleared by hardware simultaneous with the WAKEUP flag set.  0: No effect  1: Enter L1/L2 suspend – Condition: Host mode Software can set this bit when host application has nothing scheduled for the next frames and wants to enter long term power saving. When set, it stops immediately SOF generation and any other host activity, gates the USB clock and sets the transceiver in low power mode. If any USB transaction is on-going at the time SUSPEN is set, suspend is entered at the end of the current transaction. As soon as suspend state is propagated internally and gets effective the SUSPRDY bit is set. In the case that host application wants to pursue more aggressive power saving by stopping the USB clock source and by moving the micro-controller to STOP mode, it must first wait few cycles to see SUSPRDY=1 acknowledge to the suspend request. This bit is cleared by hardware simultaneous with the WAKEUP flag set. 0: No effect  1: Enter L1/L2 suspend Bit 2   SUSPRDY:   Suspend state effective This bit is set by hardware as soon as the suspend state entered through the SUSPEN control gets internally effective. In this state USB activity is suspended, USB clock is gated, transceiver is set in low power mode by disabling the differential receiver. Only asynchronous wake-up logic and single ended receiver is kept alive to detect remote wake- up or resume events. Software must poll this bit to confirm it to be set before any STOP mode entry. This bit is cleared by hardware simultaneously to the WAKEUP flag being set. 0: Normal operation  1: Suspend state

Universal serial bus full-speed host/device interface (USB)   RM0490  978/1027   RM0490 Rev 5  29.6.2   USB interrupt status register (USB_ISTR)  Address offset: 0x44 Reset value: 0x0000 0000 This register contains the status of all the interrupt sources permitting application software to determine which events caused an interrupt request. The upper part of this register contains single bits, each of them representing a specific event. These bits are set by the hardware when the related event occurs; if the corresponding bit in the USB_CNTR register is set, a generic interrupt request is generated. The interrupt routine, examining each bit, performs all necessary actions, and finally it clears the serviced bits. If any of them is not cleared, the interrupt is considered to be still pending, and the interrupt line is kept high again. If several bits are set simultaneously, only a single interrupt is generated. Endpoint/channel transaction completion can be handled in a different way to reduce interrupt response latency. The CTR bit is set by the hardware as soon as an endpoint/channel successfully completes a transaction, generating a generic interrupt request if the corresponding bit in USB_CNTR is set. An endpoint/channel dedicated interrupt condition is activated independently from the CTRM bit in the USB_CNTR register. Both interrupt conditions remain active until software clears the pending bit in the corresponding USB_CHEPnR register (the CTR bit is actually a read only bit). For endpoint- /channel-related interrupts, the software can use the direction of transaction (DIR) and IDN read-only bits to identify which endpoint/channel made the last interrupt request and called the corresponding interrupt service routine. The user can choose the relative priority of simultaneously pending USB_ISTR events by specifying the order in which software checks USB_ISTR bits in an interrupt service routine. Only the bits related to events, which are serviced, are cleared. At the end of the service routine, another interrupt is requested, to service the remaining conditions. Bit 1   PDWN:   Power down This bit is used to completely switch off all USB-related analog parts if it is required to completely disable the USB peripheral for any reason. When this bit is set, the USB peripheral is disconnected from the transceivers and it cannot be used.  0: Exit power down  1: Enter power down mode Bit 0   USBRST:   USB Reset – Condition: Device mode Software can set this bit to reset the USB core, exactly as it happens when receiving a RESET signaling on the USB.The USB peripheral, in response to a RESET, resets its internal protocol state machine. Reception and transmission are disabled until the RST_DCON bit is cleared. All configuration registers do not reset: the microcontroller must explicitly clear these registers (this is to ensure that the RST_DCON interrupt can be safely delivered, and any transaction immediately followed by a RESET can be completed). The function address and endpoint registers are reset by an USB reset event. 0: No effect  1: USB core is under reset – Condition: Host mode Software sets this bit to drive USB reset state on the bus and initialize the device. USB reset terminates as soon as this bit is cleared by software. 0: No effect  1: USB reset driven

RM0490 Rev 5   979/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  To avoid spurious clearing of some bits, it is recommended to clear them with a load instruction where all bits which must not be altered are written with 1, and all bits to be cleared are written with 0 (these bits can only be cleared by software). Read-modify-write cycles must be avoided because between the read and the write operations another bit can be set by the hardware and the next write clears it before the device has the time to service the event. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   LS_ DCON DCON_ STAT   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   DDISC   THR 512 r   r   rc_w0   rc_w0 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 CTR   PMA OVR   ERR   WKUP   SUSP   RST_ DCON   SOF   ESOF   L1REQ   Res.   Res.   DIR   IDN[3:0] r   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   r   r   r   r   r  Bit 31   Reserved, must be kept at reset value. Bit 30   LS_DCON : Low speed device connected – Host mode: This bit is set by hardware when an LS device connection is detected. Device connection is signaled after LS J-state is sampled for 22 consecutive cycles of the USB clock (48 MHz) from the unconnected state. Bit 29   DCON_STAT : Device connection status – Host mode: This bit contains information about device connection status. It is set by hardware when a LS/FS device is attached to the host while it is reset when the device is disconnected. 0: No device connected 1: FS or LS device connected to the host Bits 28:18   Reserved, must be kept at reset value. Bit 17   DDISC : Device connection – Host mode This bit is set when a device connection is detected. This bit is read/write but only 0 can be written and writing 1 has no effect. Bit 16   THR512 : 512 byte threshold interrupt This bit is set to 1 by the hardware when 512 bytes have been transmitted or received during isochronous transfers. This bit is read/write but only 0 can be written and writing 1 has no effect. Note that no information is available to indicate the associated channel/endpoint, however in practice only one ISO endpoint/channel with such large packets can be supported, so that channel. Bit 15   CTR : Completed transfer in host mode This bit is set by the hardware to indicate that an endpoint/channel has successfully completed a transaction; using DIR and IDN bits software can determine which endpoint/channel requested the interrupt. This bit is read-only.

Universal serial bus full-speed host/device interface (USB)   RM0490  980/1027   RM0490 Rev 5  Bit 14   PMAOVR:   Packet memory area over / underrun This bit is set if the microcontroller has not been able to respond in time to an USB memory request. The USB peripheral handles this event in the following way: During reception an ACK handshake packet is not sent, during transmission a bit-stuff error is forced on the transmitted stream; in both cases the host retries the transaction. The PMAOVR interrupt must never occur during normal operations. Since the failed transaction is retried by the host, the application software has the chance to speed-up device operations during this interrupt handling, to be ready for the next transaction retry; however this does not happen during isochronous transfers (no isochronous transaction is anyway retried) leading to a loss of data in this case. This bit is read/write but only 0 can be written and writing 1 has no effect. Bit 13   ERR:   Error This flag is set whenever one of the errors listed below has occurred: NANS:   No ANSwer. The timeout for a host response has expired. CRC:   Cyclic redundancy check error. One of the received CRCs, either in the token or in the data, was wrong. BST:   Bit stuffing error. A bit stuffing error was detected anywhere in the PID, data, and/or CRC. FVIO:   Framing format violation. A non-standard frame was received (EOP not in the right place, wrong token sequence, etc.). The USB software can usually ignore errors, since the USB peripheral and the PC host manage retransmission in case of errors in a fully transparent way. This interrupt can be useful during the software development phase, or to monitor the quality of transmission over the USB bus, to flag possible problems to the user (for example loose connector, too noisy environment, broken conductor in the USB cable and so on). This bit is read/write but only 0 can be written and writing 1 has no effect. Bit 12   WKUP:   Wake-up This bit is set to 1 by the hardware when, during suspend mode, activity is detected that wakes up the USB peripheral. This event asynchronously clears the SUSPRDY bit in the CTLR register and activates the USB_WAKEUP line, which can be used to notify the rest of the device (for example wake-up unit) about the start of the resume process. This bit is read/write but only 0 can be written and writing 1 has no effect. Bit 11   SUSP:   Suspend mode request – Device mode This bit is set by the hardware when no traffic has been received for 3 ms, indicating a suspend mode request from the USB bus. The suspend condition check is enabled immediately after any USB reset and it is disabled by the hardware when the suspend mode is active (SUSPEN=1) until the end of resume sequence. This bit is read/write but only 0 can be written and writing 1 has no effect. Bit 10   RST_DCON:   USB reset request (Device mode) or device connect/disconnect (Host mode) – Device mode This bit is set by hardware when an USB reset is released by the host and the bus returns to idle. USB reset state is internally detected after the sampling of 60 consecutive SE0 cycles. – Host mode  This bit is set by hardware when device connection or device disconnection is detected. Device connection is signaled after J state is sampled for 22 cycles consecutively from unconnected state. Device disconnection is signaled after SE0 state is seen for 22 bit times consecutively from connected state.

RM0490 Rev 5   981/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  Bit 9   SOF:   Start of frame This bit signals the beginning of a new USB frame and it is set when a SOF packet arrives through the USB bus. The interrupt service routine can monitor the SOF events to have a 1 ms synchronization event to the USB host and to safely read the USB_FNR register which is updated at the SOF packet reception (this can be useful for isochronous applications). This bit is read/write but only 0 can be written and writing 1 has no effect. Bit 8   ESOF:   Expected start of frame – Device mode This bit is set by the hardware when an SOF packet is expected but not received. The host sends an SOF packet each 1 ms, but if the device does not receive it properly, the   suspend timer issues this interrupt. If three consecutive ESOF interrupts are generated (for example three SOF packets are lost) without any traffic occurring in between, a SUSP interrupt is generated. This bit is set even when the missing SOF packets occur while the   suspend timer is not yet locked. This bit is read/write but only 0 can be written and writing 1 has no effect. Bit 7   L1REQ:   LPM L1 state request – Device mode This bit is set by the hardware when LPM command to enter the L1 state is successfully received and acknowledged. This bit is read/write but only 0 can be written and writing 1 has no effect. Bits 6:5   Reserved, must be kept at reset value. Bit 4   DIR:   Direction of transaction This bit is written by the hardware according to the direction of the successful transaction, which generated the interrupt request.  If DIR bit = 0, VTTX bit is set in the USB_CHEPnR register related to the interrupting endpoint. The interrupting transaction is of IN type (data transmitted by the USB peripheral to the host PC).  If DIR bit = 1, VTRX bit or both VTTX/VTRX are set in the USB_CHEPnR register related to the interrupting endpoint. The interrupting transaction is of OUT type (data received by the USB peripheral from the host PC) or two pending transactions are waiting to be processed.  This information can be used by the application software to access the USB_CHEPnR bits related to the triggering transaction since it represents the direction having the interrupt pending. This bit is read-only. Bits 3:0   IDN[3:0]:   Device Endpoint / host channel identification number These bits are written by the hardware according to the host channel or device endpoint number, which generated the interrupt request. If several endpoint/channel transactions are pending, the hardware writes the identification number related to the endpoint/channel having the highest priority defined in the following way: two levels are defined, in order of priority: isochronous and double-buffered bulk channels/endpoints are considered first and then the others are examined. If more than one endpoint/channel from the same set is requesting an interrupt, the IDN bits in USB_ISTR register are assigned according to the lowest requesting register, CHEP0R having the highest priority followed by CHEP1R and so on. The application software can assign a register to each endpoint/channel according to this priority scheme, so as to order the concurring endpoint/channel requests in a suitable way. These bits are read only.

Universal serial bus full-speed host/device interface (USB)   RM0490  982/1027   RM0490 Rev 5  29.6.3   USB frame number register (USB_FNR)  Address offset: 0x48 Reset value: 0x0000 0XXX (where X is undefined)  29.6.4   USB Device address (USB_DADDR)  Address offset: 0x4C Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 RXDP   RXDM   LCK   LSOF[1:0]   FN[10:0] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r  Bits 31:16   Reserved, must be kept at reset value. Bit 15   RXDP:   Receive data + line status This bit can be used to observe the status of received data plus upstream port data line. It can be used during end-of-suspend routines to help determining the wake-up event. Bit 14   RXDM:   Receive data - line status This bit can be used to observe the status of received data minus upstream port data line. It can be used during end-of-suspend routines to help determining the wake-up event. Bit 13   LCK:   Locked – Device mode This bit is set by the hardware when at least two consecutive SOF packets have been received after the end of an USB reset condition or after the end of an USB resume sequence. Once locked, the frame timer remains in this state until an USB reset or USB suspend event occurs. Bits 12:11   LSOF[1:0]:   Lost SOF – Device mode These bits are written by the hardware when an ESOF interrupt is generated, counting the number of consecutive SOF packets lost. At the reception of an SOF packet, these bits are cleared. Bits 10:0   FN[10:0]:   Frame number This bit field contains the 11-bits frame number contained in the last received SOF packet. The frame number is incremented for every frame sent by the host and it is useful for isochronous transfers. This bit field is updated on the generation of an SOF interrupt. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   EF   ADD[6:0] rw   rw   rw   rw   rw   rw   rw   rw

RM0490 Rev 5   983/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  29.6.5   USB LPM control and status register (USB_LPMCSR)  Address offset: 0x54 Reset value: 0x0000 0000 Bits 31:8   Reserved, must be kept at reset value. Bit 7   EF:   Enable function This bit is set by the software to enable the USB Device. The address of this device is contained in the following ADD[6:0] bits. If this bit is at 0 no transactions are handled, irrespective of the settings of USB_CHEPnR registers. Bits 6:0   ADD[6:0]:   Device address – Device mode These bits contain the USB function address assigned by the host PC during the enumeration process. Both this field and the endpoint/channel address (EA) field in the associated USB_CHEPnR register must match with the information contained in a USB token in order to handle a transaction to the required endpoint. – Host mode These bits contain the address transmitted with the LPM transaction 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   BESL[3:0]   REM WAKE   Res.   LPM ACK LPM EN r   r   r   r   r   rw   rw  Bits 31:8   Reserved, must be kept at reset value. Bits 7:4   BESL[3:0]:   BESL value – Device mode These bits contain the BESL value received with last ACKed LPM Token Bit 3   REMWAKE:   bRemoteWake value – Device mode This bit contains the bRemoteWake value received with last ACKed LPM Token Bit 2   Reserved, must be kept at reset value. Bit 1   LPMACK:   LPM token acknowledge enable – Device mode: 0: the valid LPM token is NYET.  1: the valid LPM token is ACK. The NYET/ACK is returned only on a successful LPM transaction: No errors in both the EXT token and the LPM token (else ERROR) A valid bLinkState = 0001B (L1) is received (else STALL) Bit 0   LPMEN:   LPM support enable – Device mode This bit is set by the software to enable the LPM support within the USB Device. If this bit is at 0 no LPM transactions are handled.

Universal serial bus full-speed host/device interface (USB)   RM0490  984/1027   RM0490 Rev 5  29.6.6   USB battery charging detector (USB_BCDR)  Address offset: 0x58 Reset value: 0x0000 0000 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 DPPU_ DPD   Res.   Res.   Res.   Res.   Res.   Res.   Res.   PS2 DET   SDET   PDET   Res.   SDEN   PDEN   Res.   BCD EN rw   r   r   r   rw   rw   rw  Bits 31:16   Reserved, must be kept at reset value. Bit 15   DPPU_DPD:   DP pull-up / DPDM pull-down – Device mode This bit is set by software to enable the embedded pull-up on DP line. Clearing it to 0 can be used to signal disconnect to the host when needed by the user software. – Host mode This bit is set by software to enable the embedded pull-down on DP and DM lines. Bits 14:8   Reserved, must be kept at reset value. Bit 7   PS2DET:   DM pull-up detection status – Device mode This bit is active only during PD and gives the result of comparison between DM voltage level and V LGC   threshold. In normal situation, the DM level must be below this threshold. If it is above, it means that the DM is externally pulled high. This can be caused by connection to a PS2 port (which pulls-up both DP and DM lines) or to some proprietary charger not following the BCD specification. 0: Normal port detected (connected to SDP, ACA, CDP or DCP).  1: PS2 port or proprietary charger detected. Bit 6   SDET:   Secondary detection (SD) status – Device mode This bit gives the result of SD. 0: CDP detected.  1: DCP detected. Bit 5   PDET:   Primary detection (PD) status – Device mode This bit gives the result of PD. 0: no BCD support detected (connected to SDP or proprietary device).  1: BCD support detected (connected to ACA, CDP or DCP). Bit 4   Reserved, must be kept at reset value. Bit 3   SDEN:   Secondary detection (SD) mode enable – Device mode This bit is set by the software to put the BCD into SD mode. Only one detection mode (PD, SD or OFF) must be selected to work correctly.

RM0490 Rev 5   985/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  29.6.7   USB endpoint/channel n register (USB_CHEPnR)  Address offset: 0x00 + 0x4 * n, (n = 0 to 7) Reset value: 0x0000 0000 The USB peripheral supports up to 8 bidirectional endpoints or host channels. Each USB Device must support a control endpoint/channel whose address (EA bits) must be set to 0. The USB peripheral behaves in an undefined way if multiple endpoints are enabled having the same endpoint/channel number value. For each endpoint, an USB_CHEPnR register is available to store the endpoint/channel specific information. They are also reset when an USB reset is received from the USB bus or forced through bit USBRST in the CTLR register, except the VTRX and VTTX bits, which are kept unchanged to avoid missing a correct packet notification immediately followed by an USB reset event. Each endpoint/channel has its USB_CHEPnR register where   n   is the endpoint/channel identifier. Read-modify-write cycles on these registers must be avoided because between the read and the write operations some bits can be set by the hardware and the next write would modify them before the CPU has the time to detect the change. For this purpose, all bits affected by this problem have an ‘invariant’ value that must be used whenever their modification is not required. It is recommended to modify these registers with a load instruction where all the bits, which can be modified only by the hardware, are written with their ‘invariant’ value. Bit 2   PDEN:   Primary detection (PD) mode enable – Device mode This bit is set by the software to put the BCD into PD mode. Only one detection mode (PD, SD or OFF) must be selected to work correctly. Bit 1   Reserved, must be kept at reset value. Bit 0   BCDEN:   Battery charging detector (BCD) enable – Device mode This bit is set by the software to enable the BCD support within the USB Device. When enabled, the USB PHY is fully controlled by BCD and cannot be used for normal communication. Once the BCD discovery is finished, the BCD must be placed in OFF mode by clearing this bit to 0 in order to allow the normal USB operation. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   THREE_ERR_ RX[1:0] THREE_ERR_ TX[1:0] ERR_ RX ERR_ TX   LS_EP   NAK   DEVADDR[6:0] rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rc_w0   rw   rc_w0   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 VTRX   DTOG RX   STATRX[1:0]   SETUP   UTYPE[1:0]   EP KIND   VTTX   DTOG TX   STATTX[1:0]   EA[3:0] rc_w0   t   t   t   r   rw   rw   rw   rc_w0   t   t   t   rw   rw   rw   rw

Universal serial bus full-speed host/device interface (USB)   RM0490  986/1027   RM0490 Rev 5  Bit 31   Reserved, must be kept at reset value. Bits 30:29   THREE_ERR_RX[1:0]:   Three errors for an IN transaction – Host mode This bit is set by the hardware when 3 consecutive transaction errors occurred on the USB bus for an IN transaction. THREE_ERR_RX is not generated for isochronous transactions. The software can only clear this bit. Coding of the received error: 00: Less than 3 errors received. 01: More than 3 errors received, last error is timeout error. 10: More than 3 errors received, last error is data error (CRC error). 11: More than 3 errors received, last error is protocol error (invalid PID, false EOP, bitstuffing error, SYNC error). Bits 28:27   THREE_ERR_TX[1:0]:   Three errors for an OUT or SETUP transaction – Host mode This bit is set by the hardware when 3 consecutive transaction errors occurred on the USB bus for an OUT transaction. THREE_ERR_TX is not generated for isochronous transactions. The software can only clear this bit. Coding of the received error: 00: Less than 3 errors received. 01: More than 3 errors received, last error is timeout error. 10: More than 3 errors received, last error is data error (CRC error). 11: More than 3 errors received, last error is protocol error (invalid PID, false EOP, bitstuffing error, SYNC error). Bit 26   ERR_RX:   Received error for an IN transaction – Host mode This bit is set by the hardware when an error (for example no answer by the device, CRC error, bit stuffing error, framing format violation, etc.) has occurred during an IN transaction on this channel. The software can only clear this bit. If the ERRM bit in USB_CNTR register is set, a generic interrupt condition is generated together with the channel related flag, which is always activated. Bit 25   ERR_TX:   Received error for an OUT/SETUP transaction – Host mode This bit is set by the hardware when an error (for example no answer by the device, CRC error, bit stuffing error, framing format violation, etc.) has occurred during an OUT or SETUP transaction on this channel. The software can only clear this bit. If the ERRM bit in USB_CNTR register is set, a generic interrupt condition is generated together with the channel related flag, which is always activated. Bit 24   LS_EP:   Low speed endpoint – host with HUB only – Host mode This bit is set by the software to send an LS transaction to the corresponding endpoint. 0: Full speed endpoint 1: Low speed endpoint Bit 23   NAK:  – Host mode This bit is set by the hardware when a device responds with a NAK. Software can use this bit to monitor the number of NAKs received from a device. Bits 22:16   DEVADDR[6:0]:  – Host mode Device address assigned to the endpoint during the enumeration process.

RM0490 Rev 5   987/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  Bit 15   VTRX:   USB valid transaction received – Device mode This bit is set by the hardware when an OUT/SETUP transaction is successfully completed on this endpoint; the software can only clear this bit. If the CTRM bit in USB_CNTR register is set accordingly, a generic interrupt condition is generated together with the endpoint related interrupt condition, which is always activated. The type of occurred transaction, OUT or SETUP, can be determined from the SETUP bit described below. A transaction ended with a NAK or STALL handshake does not set this bit, since no data is actually transferred, as in the case of protocol errors or data toggle mismatches. This bit is read/write but only 0 can be written, writing 1 has no effect. – Host mode This bit is set by the hardware when an IN transaction is successfully completed on this channel. The software can only clear this bit. If the CTRM bit in USB_CNTR register is set a generic interrupt condition is generated together with the channel related flag, which is always activated. - A transaction ended with a NAK sets this bit and NAK answer is reported to application reading the NAK state from the STATRX field of this register. One NAKed transaction keeps pending and is automatically retried by the host at the next frame, or the host can immediately retry by resetting STATRX state to VALID. - A transaction ended by STALL handshake sets this bit and the STALL answer is reported to application reading the STALL state from the STATRX field of this register. Host application must consequently disable the channel and re-enumerate. - A transaction ended with ACK handshake sets this bit If double buffering is disabled, ACK answer is reported by application reading the DISABLE state from the STATRX field of this register. Host application must read received data from USBRAM and re-arm the channel by writing VALID to the STATRX field of this register. If double buffering is enabled, ACK answer is reported by application reading VALID state from the STATRX field of this register. Host application must read received data from USBRAM and toggle the DTOGTX bit of this register. - A transaction ended with error sets this bit. Errors can be seen via the bits ERR_RX (host mode only). This bit is read/write but only 0 can be written, writing 1 has no effect.

Universal serial bus full-speed host/device interface (USB)   RM0490  988/1027   RM0490 Rev 5  Bit 14   DTOGRX:   Data Toggle, for reception transfers If the endpoint/channel is not isochronous, this bit contains the expected value of the data toggle bit (0 = DATA0, 1 = DATA1) for the next data packet to be received. Hardware toggles this bit, when the ACK handshake is sent following a data packet reception having a matching data PID value; if the endpoint is defined as a control one, hardware clears this bit at the reception of a SETUP PID received from host (in device mode), while it sets this bit to 1 when SETUP transaction is acknowledged by device (in host mode).  If the endpoint/channel is using the double-buffering feature this bit is used to support packet buffer swapping too (Refer to   Section 29.5.3: Double-buffered endpoints and usage in Device mode ).  If the endpoint/channel is isochronous, this bit is used only to support packet buffer swapping for data transmission since no data toggling is used for this kind of channels/endpoints and only DATA0 packet are transmitted (Refer to   Section 29.5.5: Isochronous transfers in Device mode ). Hardware toggles this bit just after the end of data packet reception, since no handshake is used for isochronous transfers.  This bit can also be toggled by the software to initialize its value (mandatory when the endpoint is not a control one) or to force specific data toggle/packet buffer usage. When the application software writes 0, the value of DTOGRX remains unchanged, while writing 1 makes the bit value toggle. This bit is read/write but it can be only toggled by writing 1.

RM0490 Rev 5   989/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  Bits 13:12   STATRX[1:0]:   Status bits, for reception transfers – Device mode These bits contain information about the endpoint status, which are listed in   Table 163: Reception status encoding on page 992 . These bits can be toggled by software to initialize their value. When the application software writes 0, the value remains unchanged, while writing 1 makes the bit value to toggle. Hardware sets the STATRX bits to NAK when a correct transfer has occurred (VTRX = 1) corresponding to a OUT or SETUP (control only) transaction addressed to this endpoint, so the software has the time to elaborate the received data before it acknowledges a new transaction.  Double-buffered bulk endpoints implement a special transaction flow control, which control the status based upon buffer availability condition (Refer to   Section 29.5.3: Double-buffered endpoints and usage in Device mode ).  If the endpoint is defined as isochronous, its status can be only “VALID” or “DISABLED”, so that the hardware cannot change the status of the endpoint after a successful transaction. If the software sets the STATRX bits to ‘STALL’ or ‘NAK’ for an isochronous endpoint, the USB peripheral behavior is not defined. These bits are read/write but they can be only toggled by writing 1. – Host mode These bits are the host application controls to start, retry, or abort host transactions driven by the channel. These bits also contain information about the device answer to the last IN channel transaction and report the current status of the channel according to the following STATRX table of states: - DISABLE  DISABLE value is reported in case of ACK acknowledge is received on a single-buffer channel. When in DISABLE state the channel is unused or not active waiting for application to restart it by writing VALID. Application can reset a VALID channel to DISABLE to abort a transaction. In this case the transaction is immediately removed from the host execution list. If the aborted transaction was already under execution it is regularly terminated on the USB but the relative VTRX interrupt is not generated. - VALID  A host channel is actively trying to submit USB transaction to device only when in VALID state.VALID state can be set by software or automatically by hardware on a NAKED channel at the start of a new frame. When set to VALID, an host channel enters the host execution queue and waits permission from the host frame scheduler to submit its configured transaction.  VALID value is also reported in case of ACK acknowledge is received on a double-buffered channel. In this case the channel remains active on the alternate buffer while application needs to read the current buffer and toggle DTOGTX. In case software is late in reading and the alternate buffer is not ready, the host channel is automatically suspended transparently to the application. The suspended double buffered channel is re-activated as soon as delay is recovered and DTOGTX is toggled. - NAK  NAK value is reported in case of NAK acknowledge received. When in NAK state the channel is suspended and does not try to transmit. NAK state is moved to VALID by hardware at the start of the next frame, or software can change it to immediately retry transmission by writing it to VALID, or can disable it and abort the transaction by writing DISABLE - STALL  STALL value is reported in case of STALL acknowledge received. When in STALL state the channel behaves as disabled. Application must not retry transmission but reset the USB and re-enumerate.

Universal serial bus full-speed host/device interface (USB)   RM0490  990/1027   RM0490 Rev 5  Bit 11   SETUP:   Setup transaction completed – Device mode This bit is read-only and it is set by the hardware when the last completed transaction is a SETUP. This bit changes its value only for control endpoints. It must be examined, in the case of a successful receive transaction (VTRX event), to determine the type of transaction occurred. To protect the interrupt service routine from the changes in SETUP bits due to next incoming tokens, this bit is kept frozen while VTRX bit is at 1; its state changes when VTRX is at 0. This bit is read-only. – Host mode This bit is set by the software to send a SETUP transaction on a control endpoint. This bit changes its value only for control endpoints. It is cleared by hardware when the SETUP transaction is acknowledged and VTTX interrupt generated. Bits 10:9   UTYPE[1:0]:   USB type of transaction These bits configure the behavior of this endpoint/channel as described in   Table 164: Endpoint/channel type encoding . Channel0/Endpoint0 must always be a control endpoint/channel and each USB function must have at least one control endpoint/channel which has address 0, but there can be other control channels/endpoints if required. Only control channels/endpoints handle SETUP transactions, which are ignored by endpoints of other kinds. SETUP transactions cannot be answered with NAK or STALL. If a control endpoint/channel is defined as NAK, the USB peripheral does not answer, simulating a receive error, in the receive direction when a SETUP transaction is received. If the control endpoint/channel is defined as STALL in the receive direction, then the SETUP packet is accepted anyway, transferring data and issuing the CTR interrupt. The reception of OUT transactions is handled in the normal way, even if the endpoint/channel is a control one.  Bulk and interrupt endpoints have very similar behavior and they differ only in the special feature available using the EPKIND configuration bit.  The usage of isochronous channels/endpoints is explained in   Section 29.5.5: Isochronous transfers in Device mode  Bit 8   EPKIND:   endpoint/channel kind The meaning of this bit depends on the endpoint/channel type configured by the UTYPE bits.   Table 165   summarizes the different meanings. DBL_BUF: This bit is set by the software to enable the double-buffering feature for this bulk endpoint. The usage of double-buffered bulk endpoints is explained in   Section 29.5.3: Double-buffered endpoints and usage in Device mode .  STATUS_OUT: This bit is set by the software to indicate that a status out transaction is expected: in this case all OUT transactions containing more than zero data bytes are answered ‘STALL’ instead of ‘ACK’. This bit can be used to improve the robustness of the application to protocol errors during control transfers and its usage is intended for control endpoints only. When STATUS_OUT is reset, OUT transactions can have any number of bytes, as required. Bit 7   VTTX:   Valid USB transaction transmitted – Device mode This bit is set by the hardware when an IN transaction is successfully completed on this endpoint; the software can only clear this bit. If the CTRM bit in the USB_CNTR register is set accordingly, a generic interrupt condition is generated together with the endpoint related interrupt condition, which is always activated. A transaction ended with a NAK or STALL handshake does not set this bit, since no data is actually transferred, as in the case of protocol errors or data toggle mismatches. This bit is read/write but only 0 can be written. – Host mode Same as VTRX behavior but for USB OUT and SETUP transactions.

RM0490 Rev 5   991/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  Bit 6   DTOGTX:   Data toggle, for transmission transfers If the endpoint/channel is non-isochronous, this bit contains the required value of the data toggle bit (0 = DATA0, 1 = DATA1) for the next data packet to be transmitted. Hardware toggles this bit when the ACK handshake is received from the USB host, following a data packet transmission. If the endpoint/channel is defined as a control one, hardware sets this bit to 1 at the reception of a SETUP PID addressed to this endpoint (in device mode) or when a SETUP transaction is acknowledged by the device (in host mode).  If the endpoint/channel is using the double buffer feature, this bit is used to support packet buffer swapping too (Refer to   Section 29.5.3: Double-buffered endpoints and usage in Device mode ).  If the endpoint/channel is isochronous, this bit is used to support packet buffer swapping since no data toggling is used for this sort of endpoints and only DATA0 packet are transmitted (refer to   Section 29.5.5: Isochronous transfers in Device mode ). Hardware toggles this bit just after the end of data packet transmission, since no handshake is used for isochronous transfers.  This bit can also be toggled by the software to initialize its value (mandatory when the endpoint/channel is not a control one) or to force a specific data toggle/packet buffer usage. When the application software writes 0, the value of DTOGTX remains unchanged, while writing 1 makes the bit value to toggle. This bit is read/write but it can only be toggled by writing 1. Bits 5:4   STATTX[1:0]:   Status bits, for transmission transfers – Device mode These bits contain the information about the endpoint status, listed in   Table 166 . These bits can be toggled by the software to initialize their value. When the application software writes 0, the value remains unchanged, while writing 1 makes the bit value to toggle. Hardware sets the STATTX bits to NAK, when a correct transfer has occurred (VTTX = 1) corresponding to a IN or SETUP (control only) transaction addressed to this channel/endpoint. It then waits for the software to prepare the next set of data to be transmitted.  Double-buffered bulk endpoints implement a special transaction flow control, which controls the status based on buffer availability condition (Refer to   Section 29.5.3: Double-buffered endpoints and usage in Device mode ).  If the endpoint is defined as isochronous, its status can only be “VALID” or “DISABLED”. Therefore, the hardware cannot change the status of the channel/endpoint/channel after a successful transaction. If the software sets the STATTX bits to ‘STALL’ or ‘NAK’ for an isochronous channel/endpoint, the USB peripheral behavior is not defined. These bits are read/write but they can be only toggled by writing 1. – Host mode The STATTX bits contain the information about the channel status. Refer to   Table 166   for the full descriptions (“Host mode” descriptions). Whereas in Device mode, these bits contain the status that are given out on the following transaction, in Host mode they capture the status last received from the device. If a NAK is received, STATTX contains the value indicating NAK. Bits 3:0   EA[3:0]:   endpoint/channel address – Device mode Software must write in this field the 4-bit address used to identify the transactions directed to this endpoint. A value must be written before enabling the corresponding endpoint. – Host mode Software must write in this field the 4-bit address used to identify the channel addressed by the host transaction.

Universal serial bus full-speed host/device interface (USB)   RM0490  992/1027   RM0490 Rev 5  Table 163. Reception status encoding STATRX[1:0]   Meaning  00   DISABLED:   all reception requests addressed to this endpoint/channel are ignored. 01  STALL : Device mode: the endpoint is stalled and all reception requests result in a STALL handshake. Host mode: this indicates that the device has STALLed the channel. 10  NAK : Device mode: the endpoint is NAKed and all reception requests result in a NAK handshake. Host mode: this indicates that the device has NAKed the reception request. 11   VALID : this endpoint/channel is enabled for reception.  Table 164. Endpoint/channel type encoding UTYPE[1:0]   Meaning  00   BULK 01   CONTROL 10   ISO 11   INTERRUPT  Table 165. Endpoint/channel kind meaning UTYPE[1:0]   EPKIND meaning  00   BULK   DBL_BUF 01   CONTROL   STATUS_OUT 10   ISO   SBUF_ISO: This bit is set by the software to enable the single-buffering feature for isochronous endpoint 11   INTERRUPT   Not used  Table 166. Transmission status encoding STATTX[1:0]   Meaning  00   DISABLED:   all transmission requests addressed to this endpoint/channel are ignored. 01  STALL : Device mode: the endpoint is stalled and all transmission requests result in a STALL handshake. Host mode: this indicates that the device has STALLed the channel.

RM0490 Rev 5   993/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  10  NAK : Device mode: the endpoint is NAKed and all transmission requests result in a NAK handshake. Host mode: this indicates that the device has NAKed the transmission request. 11   VALID : this endpoint/channel is enabled for transmission.  Table 166. Transmission status encoding (continued) STATTX[1:0]   Meaning

Universal serial bus full-speed host/device interface (USB)   RM0490  994/1027   RM0490 Rev 5  29.6.8   USB register map  The table below provides the USB register map and reset values.  Table 167. USB register map and reset values Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00   USB_CHEP0R  Res. THREE_ERR_RX [1:0] THREE_ERR_TX [1:0] ERR_RX ERR_TX LS_EP NAK DEVADDR[6:0] VTRX DTOGRX STATRX [1:0] SETUP UTYPE [1:0] EPKIND VTTX DTOGTX STATTX [1:0] EA[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x04   USB_CHEP1R  Res. THREE_ERR_RX [1:0] THREE_ERR_TX [1:0] ERR_RX ERR_TX LS_EP NAK DEVADDR[6:0] VTRX DTOGRX STATRX [1:0] SETUP UTYPE [1:0] EPKIND VTTX DTOGTX STATTX [1:0] EA[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x08   USB_CHEP2R  Res. THREE_ERR_RX [1:0] THREE_ERR_TX [1:0] ERR_RX ERR_TX LS_EP NAK DEVADDR[6:0] VTRX DTOGRX STATRX [1:0] SETUP UTYPE [1:0] EPKIND VTTX DTOGTX STATTX [1:0] EA[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x0C   USB_CHEP3R  Res. THREE_ERR_RX [1:0] THREE_ERR_TX [1:0] ERR_RX ERR_TX LS_EP NAK DEVADDR[6:0] VTRX DTOGRX STATRX [1:0] SETUP UTYPE [1:0] EPKIND VTTX DTOGTX STATTX [1:0] EA[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x10   USB_CHEP4R  Res. THREE_ERR_RX [1:0] THREE_ERR_TX [1:0] ERR_RX ERR_TX LS_EP NAK DEVADDR[6:0] VTRX DTOGRX STATRX [1:0] SETUP UTYPE [1:0] EPKIND VTTX DTOGTX STATTX [1:0] EA[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x14   USB_CHEP5R  Res. THREE_ERR_RX [1:0] THREE_ERR_TX [1:0] ERR_RX ERR_TX LS_EP NAK DEVADDR[6:0] VTRX DTOGRX STATRX [1:0] SETUP UTYPE [1:0] EPKIND VTTX DTOGTX STATTX [1:0] EA[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x18   USB_CHEP6R  Res. THREE_ERR_RX [1:0] THREE_ERR_TX [1:0] ERR_RX ERR_TX LS_EP NAK DEVADDR[6:0] VTRX DTOGRX STATRX [1:0] SETUP UTYPE [1:0] EPKIND VTTX DTOGTX STATTX [1:0] EA[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x1C   USB_CHEP7R  Res. THREE_ERR_RX [1:0] THREE_ERR_TX [1:0] ERR_RX ERR_TX LS_EP NAK DEVADDR[6:0] VTRX DTOGRX STATRX [1:0] SETUP UTYPE [1:0] EPKIND VTTX DTOGTX STATTX [1:0] EA[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0

RM0490 Rev 5   995/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  Refer to   Section 2.2   for the register boundary addresses.  29.7   USBSRAM registers  Note:   The buffer descriptor table is located inside the packet buffer memory in the separate "USBSRAM" address space.  Although the buffer descriptor table is located inside the packet buffer memory ("USBSRAM" area), its entries can be considered as additional registers used to configure the location and size of the packet buffers used to exchange data between the USB macro cell and the device. The first packet memory location is located at USBSRAM base address. The buffer descriptor table entry associated with the USB_CHEPnR registers is described below. The memory must be addressed using Word (32-bit) accesses. A thorough explanation of packet buffers and the buffer descriptor table usage can be found in   Structure and usage of packet buffers on page 959 . 0x20- 0x3F   Reserved 0x40   USB_CNTR  HOST Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DDISCM THR512M CTRM PMAOVRM ERRM WKUPM SUSPM RST_DCONM SOFM ESOFM L1REQM Res. L1RES L2RES SUSPEN SUSPRDY PDWN USBRST Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   1   1 0x44   USB_ISTR  Res. LS_DCON DCON_STAT Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DDISC THR512 CTR PMAOVR ERR WKUP SUSP RST_DCON SOF ESOF L1REQ Res. Res. DIR IDN[3:0] Reset value   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0 0x48   USB_FNR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. RXDP RXDM LCK   LSOF [1:0]   FN[10:0] Reset value   0   0   0   0   0   x   x   x   x   x   x   x   x   x   x   x 0x4C   USB_DADDR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. EF   ADD[6:0] Reset value   0   0   0   0   0   0   0   0 0x54   USB_LPMCSR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. BESL[3:0] REMWAKE Res. LPMACK LPMEN Reset value   0   0   0   0   0   0   0 0x58   USB_BCDR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DPPU_DPD Res. Res. Res. Res. Res. Res. Res. PS2DET SDET PDET Res. SDEN PDEN Res. BCDEN Reset value   0   0   0   0   0   0   0  Table 167. USB register map and reset values (continued) Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0

Universal serial bus full-speed host/device interface (USB)   RM0490  996/1027   RM0490 Rev 5  29.7.1   Channel/endpoint transmit buffer descriptor n  (USB_CHEP_TXRXBD_n)  Address offset: 0x0 + 0x8 * n, (n = 0 to 7) Reset value: 0xXXXX XXXX This register description applies when corresponding CHEPnR register does not program the use of double buffering working in receive mode (otherwise refer to following register description)  29.7.2   Channel/endpoint receive buffer descriptor n [alternate]  (USB_CHEP_TXRXBD_n)  Address offset: 0x0 + 0x8 * n, (n = 0 to 7) Reset value: 0xXXXX XXXX This register description applies when corresponding CHEPnR register programs the use of double buffering and activates receive buffers (otherwise refer to previous register description). This table location is used to store two different values, both required during packet reception. The most significant bits contains the definition of allocated buffer size, to allow buffer overflow detection, while the least significant part of this location is written back by the USB peripheral at the end of reception to give the actual number of received bytes. Due to the restrictions on the number of available bits, buffer size is represented using the number of allocated memory blocks, where block size can be selected to choose the trade-off between fine-granularity/small-buffer and coarse-granularity/large-buffer. The size of allocated buffer is a part of the endpoint/channel descriptor and it is normally defined during the enumeration process according to its maxPacketSize parameter value   (see “Universal Serial Bus Specification”). 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   COUNT_TX[9:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ADDR_TX[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bits 31:26   Reserved, must be kept at reset value. Bits 25:16   COUNT_TX[9:0]:   Transmission byte count These bits contain the number of bytes to be transmitted by the endpoint/channel associated with the USB_CHEPnR register at the next IN token addressed to it. Bits 15:0   ADDR_TX[15:0]:   Transmission buffer address These bits point to the starting address of the packet buffer containing data to be transmitted by the endpoint/channel associated with the USB_CHEPnR register at the next IN token addressed to it. Bits 1 and 0 must always be written as “00” since packet memory is word wide and all packet buffers must be word aligned. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 BLSIZE   NUM_BLOCK[4:0]   COUNT_RX[9:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw

RM0490 Rev 5   997/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ADDR_RX[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bit 31   BLSIZE:   Block size This bit selects the size of memory block used to define the allocated buffer area. –   If BLSIZE = 0, the memory block is 2-byte large, which is the minimum block allowed in a half-word wide memory. With this block size the allocated buffer size ranges from 2 to 62 bytes. –   If BLSIZE = 1, the memory block is 32-byte large, which permits to reach the maximum packet length defined by USB specifications. With this block size the allocated buffer size theoretically ranges from 32 to 1024 bytes, which is the longest packet size allowed by USB standard specifications. However, the applicable size is limited by the available buffer memory. Bits 30:26   NUM_BLOCK[4:0]:   Number of blocks These bits define the number of memory blocks allocated to this packet buffer. The actual amount of allocated memory depends on the BLSIZE value as illustrated in   Table 168 . Bits 25:16   COUNT_RX[9:0]:   Reception byte count These bits contain the number of bytes received by the endpoint/channel associated with the USB_CHEPnR register during the last OUT/SETUP transaction addressed to it.  Note:   Although the application only needs to read this value, it is writable.  Bits 15:0   ADDR_RX[15:0]:   Reception buffer address These bits point to the starting address of the packet buffer, which contains the data received by the endpoint/channel associated with the USB_CHEPnR register at the next OUT/SETUP token addressed to it. Bits 1 and 0 must always be written as “00” since packet memory is word wide and all packet buffers must be word aligned.  Table 168. Definition of allocated buffer memory Value of NUM_BLOCK[4:0] Memory allocated when BLSIZE=0 Memory allocated when BLSIZE=1  0 (00000)   Not allowed   32 bytes 1 (00001)   2 bytes   64 bytes 2 (00010)   4 bytes   96 bytes 3 (00011)   6 bytes   128 bytes ...   ...   ... 14 (01110)   28 bytes   480 bytes 15 (01111)   30 bytes 16 (10000)   32 bytes ...   ...   ... 29 (11101)   58 bytes   ... 30 (11110)   60 bytes   992 bytes 31 (11111)   62 bytes   1023 bytes

Universal serial bus full-speed host/device interface (USB)   RM0490  998/1027   RM0490 Rev 5  29.7.3   Channel/endpoint receive buffer descriptor n  (USB_CHEP_RXTXBD_n)  Address offset: 0x4 + 0x8 * n, (n = 0 to 7) Reset value: 0xXXXX XXXX This register description applies when corresponding CHEPnR register does not program use of double buffering in the transmit mode (otherwise refer to following register description). This table location is used to store two different values, both required during packet reception. The most significant bits contains the definition of allocated buffer size, to allow buffer overflow detection, while the least significant part of this location is written back by the USB peripheral at the end of reception to give the actual number of received bytes. Due to the restrictions on the number of available bits, buffer size is represented using the number of allocated memory blocks, where block size can be selected to choose the trade-off between fine-granularity/small-buffer and coarse-granularity/large-buffer. The size of allocated buffer is a part of the endpoint/channel descriptor and it is normally defined during the enumeration process according to its maxPacketSize parameter value   (see “Universal Serial Bus Specification”). 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 BLSIZE   NUM_BLOCK[4:0]   COUNT_RX[9:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ADDR_RX[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bit 31   BLSIZE:   Block size This bit selects the size of memory block used to define the allocated buffer area. –   If BLSIZE = 0, the memory block is 2-byte large, which is the minimum block allowed in a half-word wide memory. With this block size the allocated buffer size ranges from 2 to 62 bytes. –   If BLSIZE = 1, the memory block is 32-byte large, which permits to reach the maximum packet length defined by USB specifications. With this block size the allocated buffer size theoretically ranges from 32 to 1024 bytes, which is the longest packet size allowed by USB standard specifications. However, the applicable size is limited by the available buffer memory. Bits 30:26   NUM_BLOCK[4:0]:   Number of blocks These bits define the number of memory blocks allocated to this packet buffer. The actual amount of allocated memory depends on the BLSIZE value as illustrated in   Table 168 . Bits 25:16   COUNT_RX[9:0]:   Reception byte count These bits contain the number of bytes received by the endpoint/channel associated with the USB_CHEPnR register during the last OUT/SETUP transaction addressed to it.  Note:   Although the application only needs to read this value, it is writable.  Bits 15:0   ADDR_RX[15:0]:   Reception buffer address These bits point to the starting address of the packet buffer, which contains the data received by the endpoint/channel associated with the USB_CHEPnR register at the next OUT/SETUP token addressed to it. Bits 1 and 0 must always be written as “00” since packet memory is word wide and all packet buffers must be word aligned.

RM0490 Rev 5   999/1027  RM0490   Universal serial bus full-speed host/device interface (USB)  1000  29.7.4   Channel/endpoint transmit buffer descriptor n [alternate]  (USB_CHEP_RXTXBD_n)  Address offset: 0x4 + 0x8 * n, (n = 0 to 7) Reset value: 0xXXXX XXXX This register description applies when corresponding CHEPnR register programs use of double buffering and activates transmit buffers (otherwise refer to previous register description). 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   COUNT_TX[9:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 ADDR_TX[15:0] rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw   rw  Bits 31:26   Reserved, must be kept at reset value. Bits 25:16   COUNT_TX[9:0]:   Transmission byte count These bits contain the number of bytes to be transmitted by the endpoint/channel associated with the USB_CHEPnR register at the next IN token addressed to it. Bits 15:0   ADDR_TX[15:0]:   Transmission buffer address These bits point to the starting address of the packet buffer containing data to be transmitted by the endpoint/channel associated with the USB_CHEPnR register at the next IN token addressed to it. Bits 1 and 0 must always be written as “00” since packet memory is word wide and all packet buffers must be word aligned.

Universal serial bus full-speed host/device interface (USB)   RM0490  1000/1027   RM0490 Rev 5  29.7.5   USBSRAM register map  The table below provides the USB register map and reset values.  Table 169. USBSRAM register map and reset values Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00  USB_ CHEP_ TXRXBD_0  Res. Res. Res. Res. Res. Res. COUNT_TX[9:0]   ADDR_TX[15:0] Reset value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X 0x00  USB_ CHEP_ TXRXBD_0 [alternate]  BLSIZE NUM_ BLOCK[4:0]   COUNT_RX[9:0]   ADDR_RX[15:0] Reset value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X 0x04  USB_ CHEP_ RXTXBD_0  BLSIZE NUM_ BLOCK[4:0]   COUNT_RX[9:0]   ADDR_RX[15:0] Reset value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X 0x04  USB_ CHEP_ RXTXBD_0 [alternate]  Res. Res. Res. Res. Res. Res. COUNT_TX[9:0]   ADDR_TX[15:0] Reset value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X 0x08  USB_ CHEP_ TXRXBD_1  Res. Res. Res. Res. Res. Res. COUNT_TX[9:0]   ADDR_TX[15:0] Reset value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X 0x08  USB_ CHEP_ TXRXBD_1 [alternate]  BLSIZE NUM_ BLOCK[4:0]   COUNT_RX[9:0]   ADDR_RX[15:0] Reset value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X 0x0C  USB_ CHEP_ RXTXBD_1  BLSIZE NUM_ BLOCK[4:0]   COUNT_RX[9:0]   ADDR_RX[15:0] Reset value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X 0x0C  USB_ CHEP_ RXTXBD_1 [alternate]  Res. Res. Res. Res. Res. Res. COUNT_TX[9:0]   ADDR_TX[15:0] Reset value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X . . . . . . . . . . . . 0x38  USB_ CHEP_ TXRXBD_7  Res. Res. Res. Res. Res. Res. COUNT_TX[9:0]   ADDR_TX[15:0] Reset value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X 0x38  USB_ CHEP_ TXRXBD_7 [alternate]  BLSIZE NUM_ BLOCK[4:0]   COUNT_RX[9:0]   ADDR_RX[15:0] Reset value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X 0x3C  USB_ CHEP_ RXTXBD_7  BLSIZE NUM_ BLOCK[4:0]   COUNT_RX[9:0]   ADDR_RX[15:0] Reset value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X 0x3C  USB_ CHEP_ RXTXBD_7 [alternate]  Res. Res. Res. Res. Res. Res. COUNT_TX[9:0]   ADDR_TX[15:0] Reset value   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X   X

RM0490 Rev 5   1001/1027  RM0490   Debug support (DBG)  1014  30   Debug support (DBG) 30.1   Overview  The STM32C0 series devices are built around a Cortex ®   -M0+ core which contains hardware extensions for advanced debugging features. The debug extensions allow the core to be stopped either on a given instruction fetch (breakpoint) or data access (watchpoint). When stopped, the core’s internal state and the system’s external state may be examined. Once examination is complete, the core and the system may be restored and program execution resumed. The debug features are used by the debugger host when connecting to and debugging the STM32C0 series MCUs. One interface for debug is available:  •   Serial wire  Figure 328. Block diagram of STM32C0 series MCU and Cortex   ® -M0+-level debug support  1.   The debug features embedded in the Cortex   ®   -M0+ core are a subset of the Arm CoreSight Design Kit. The Arm Cortex   ® -M0+ core provides integrated on-chip debug support. It is comprised of:  •   SW-DP: Serial wire  •   BPU: Break point unit  •   DWT: Data watchpoint trigger  Cortex-M0 Core SW-DP System interface Debug AP Bus matrix DBGMCU STM32 MCU debug support Cortex-M0 debug support MS19240V2 Debug AP SWDIO SWCLK Bridge NVIC DWT BPU

Debug support (DBG)   RM0490  1002/1027   RM0490 Rev 5  It also includes debug features dedicated to the STM32C0 series:  •   Flexible debug pinout assignment  •   MCU debug box (support for low-power modes, control over peripheral clocks, etc.)  Note:   For further information on debug functionality supported by the Arm Cortex   ® -M0+ core, refer to the Cortex   ® -M0+ Technical Reference Manual (see Section 30.2: Reference Arm documentation).  30.2   Reference Arm documentation  •   Cortex   ® -M0+ Technical Reference Manual (TRM), available from http://infocenter.arm.com  •   Arm Debug Interface V5  •   Arm CoreSight Design Kit revision r1p1 Technical Reference Manual  30.3   Pinout and debug port pins  The STM32C0 series MCUs are available in various packages with different numbers of available pins.  30.3.1   SWD port pins  Two pins are used as outputs for the SW-DP as alternate functions of general purpose I/Os. These pins are available on all packages.  30.3.2   SW-DP pin assignment  After reset (SYSRESETn or PORESETn), the pins used for the SW-DP are assigned as dedicated pins which are immediately usable by the debugger host. However, the MCU offers the possibility to disable the SWD port and can then release the associated pins for general-purpose I/O (GPIO) usage. For more details on how to disable SW-DP port pins, refer to   Section 8.3.2: I/O pin alternate function multiplexer and mapping on page 180 .  Table 170. SW debug port pins SW-DP pin name SW debug port   Pin assignment Type   Debug assignment  SWDIO   I/O   Serial Wire Data Input/Output   PA13 SWCLK   I   Serial Wire Clock   PA14

RM0490 Rev 5   1003/1027  RM0490   Debug support (DBG)  1014  30.3.3   Internal pull-up & pull-down on SWD pins  Once the SW I/O is released by the user software, the GPIO controller takes control of these pins. The reset states of the GPIO control registers put the I/Os in the equivalent states:  •   SWDIO: input pull-up  •   SWCLK: input pull-down  Having embedded pull-up and pull-down resistors removes the need to add external resistors.  30.4   ID codes and locking mechanism  There are several ID codes inside the MCU. ST strongly recommends the tool manufacturers (for example Keil, IAR, Raisonance) to lock their debugger using the MCU device ID located at address 0x40015800. Only the DEV_ID[15:0] should be used for identification by the debugger/programmer tools (the revision ID must not be taken into account).  30.5   SWD port 30.5.1   SWD protocol introduction  This synchronous serial protocol uses two pins:  •   SWCLK: clock from host to target  •   SWDIO: bidirectional The protocol allows two banks of registers (DPACC registers and APACC registers) to be read and written to. Bits are transferred LSB-first on the wire. For SWDIO bidirectional management, the line must be pulled-up on the board (100 k Ω  recommended by Arm). Each time the direction of SWDIO changes in the protocol, a turnaround time is inserted where the line is not driven by the host nor the target. By default, this turnaround time is one bit time, however this can be adjusted by configuring the SWCLK frequency.  30.5.2   SWD protocol sequence  Each sequence consist of three phases: 1.   Packet request (8 bits) transmitted by the host 2.   Acknowledge response (3 bits) transmitted by the target 3.   Data transfer phase (33 bits) transmitted by the host or the target

Debug support (DBG)   RM0490  1004/1027   RM0490 Rev 5  Refer to the Cortex ®   -M0+   TRM   for a detailed description of DPACC and APACC registers. The packet request is always followed by the turnaround time (default 1 bit) where neither the host nor target drive the line. The ACK Response must be followed by a turnaround time only if it is a READ transaction or if a WAIT or FAULT acknowledge has been received. The DATA transfer must be followed by a turnaround time only if it is a READ transaction.  30.5.3   SW-DP state machine (reset, idle states, ID code)  The State Machine of the SW-DP has an internal ID code which identifies the SW-DP. It follows the JEP-106 standard. This ID code is the default Arm one and is set to  0x0BC1 1477   (corresponding to Cortex ®   -M0+).  Table 171. Packet request (8-bits) Bit   Name   Description  0   Start   Must be “1” 1   APnDP   0: DP Access 1: AP Access 2   RnW   0: Write Request 1: Read Request 4:3   A[3:2]   Address field of the DP or AP registers (refer to   Table 175 on page 1006 ) 5   Parity   Single bit parity of preceding bits 6   Stop   0 7   Park   Not driven by the host. Must be read as “1” by the target because of the pull-up  Table 172. ACK response (3 bits) Bit   Name   Description  0..2   ACK 001: FAULT 010: WAIT 100: OK  Table 173. DATA transfer (33 bits) Bit   Name   Description  0..31   WDATA or RDATA   Write or Read data 32   Parity   Single parity of the 32 data bits

RM0490 Rev 5   1005/1027  RM0490   Debug support (DBG)  1014  Note:   Note that the SW-DP state machine is inactive until the target reads this ID code.  •   The SW-DP state machine is in RESET STATE either after power-on reset, or after the line is high for more than 50 cycles  •   The SW-DP state machine is in IDLE STATE if the line is low for at least two cycles after RESET state.  •   After RESET state, it is   mandatory   to first enter into an IDLE state AND to perform a READ access of the DP-SW ID CODE register. Otherwise, the target issues a FAULT acknowledge response on another transactions. Further details of the SW-DP state machine can be found in the   Cortex   ® -M0+   TRM   and the  CoreSight Design Kit r1p0 TRM .  30.5.4   DP and AP read/write accesses  •   Read accesses to the DP are not posted: the target response can be immediate (if ACK=OK) or can be delayed (if ACK=WAIT).  •   Read accesses to the AP are posted. This means that the result of the access is returned on the next transfer. If the next access to be done is NOT an AP access, then the DP-RDBUFF register must be read to obtain the result.  The READOK flag of the DP-CTRL/STAT register is updated on every AP read access or RDBUFF read request to know if the AP read access was successful.  •   The SW-DP implements a write buffer (for both DP or AP writes), that enables it to accept a write operation even when other transactions are still outstanding. If the write buffer is full, the target acknowledge response is “WAIT”. With the exception of IDCODE read or CTRL/STAT read or ABORT write which are accepted even if the write buffer is full.  •   Because of the asynchronous clock domains SWCLK and HCLK, two extra SWCLK cycles are needed after a write transaction (after the parity bit) to make the write effective internally. These cycles should be applied while driving the line low (IDLE state)  This is particularly important when writing the CTRL/STAT for a power-on request. If the next transaction (requiring a power-on) occurs immediately, it fails.  30.5.5   SW-DP registers  Access to these registers are initiated when APnDP=0  Table 174. SW-DP registers A[3:2]   R/W CTRLSEL bit of SELECT register Register   Notes  00   Read   IDCODE The manufacturer code is set to the default Arm code for Cortex ® -M0+:  0x0BC11477   (identifies the SW-DP) 00   Write   ABORT

Debug support (DBG)   RM0490  1006/1027   RM0490 Rev 5  30.5.6   SW-AP registers  Access to these registers are initiated when APnDP=1 There are many AP Registers addressed as the combination of:  •   The shifted value A[3:2]  •   The current value of the DP SELECT register. 01   Read/Write   0   DP-CTRL/STAT Purpose is to: – request a system or debug power-on – configure the transfer operation for AP accesses – control the pushed compare and pushed verify operations. – read some status flags (overrun, power-on acknowledges) 01   Read/Write   1   WIRE CONTROL Purpose is to configure the physical serial port protocol (like the duration of the turnaround time) 10   Read   READ RESEND Enables recovery of the read data from a corrupted debugger transfer, without repeating the original AP transfer. 10   Write   SELECT   The purpose is to select the current access port and the active 4-words register window 11   Read/Write   READ BUFFER This read buffer is useful because AP accesses are posted (the result of a read AP request is available on the next AP transaction). This read buffer captures data from the AP, presented as the result of a previous read, without initiating a new transaction  Table 174. SW-DP registers (continued) A[3:2]   R/W CTRLSEL bit of SELECT register Register   Notes  Table 175. 32-bit debug port registers addressed through the shifted value A[3:2] Address   A[3:2] value   Description  0x0   00   Reserved, must be kept at reset value. 0x4   01 DP CTRL/STAT register. Used to: – Request a system or debug power-on – Configure the transfer operation for AP accesses – Control the pushed compare and pushed verify operations. – Read some status flags (overrun, power-on acknowledges)

RM0490 Rev 5   1007/1027  RM0490   Debug support (DBG)  1014  30.6   Core debug  Core debug is accessed through the core debug registers. Debug access to these registers is by means of the debug access port. It consists of four registers: These registers are not reset by a system reset. They are only reset by a power-on reset. Refer to the Cortex ®   -M0+ TRM for further details. To Halt on reset, it is necessary to:  •   enable the bit0 (VC_CORRESET) of the Debug and Exception Monitor Control Register  •   enable the bit0 (C_DEBUGEN) of the Debug Halting Control and Status Register  30.7   BPU (break point unit)  The Cortex ® -M0+ BPU implementation provides four breakpoint registers. The BPU is a subset of the Flash Patch and Breakpoint (FPB) block available in Armv7-M (Cortex-M3 & Cortex-M4). 0x8   10 DP SELECT register: Used to select the current access port and the active 4-words register window. – Bits 31:24: APSEL: select the current AP – Bits 23:8: reserved – Bits 7:4: APBANKSEL: select the active 4-words register window on the current AP – Bits 3:0: reserved 0xC   11 DP RDBUFF register: Used to allow the debugger to get the final result after a sequence of operations (without requesting new JTAG-DP operation)  Table 175. 32-bit debug port registers addressed through the shifted value A[3:2] Address   A[3:2] value   Description  Table 176. Core debug registers Register   Description  DHCSR  The 32-bit Debug Halting Control and Status Register  This provides status information about the state of the processor enable core debug halt and step the processor DCRSR   The 17-bit Debug Core Register Selector Register:  This selects the processor register to transfer data to or from. DCRDR  The 32-bit Debug Core Register Data Register:  This holds data for reading and writing registers to and from the processor selected by the DCRSR (Selector) register. DEMCR   The 32-bit Debug Exception and Monitor Control Register:  This provides Vector Catching and Debug Monitor Control.

Debug support (DBG)   RM0490  1008/1027   RM0490 Rev 5  30.7.1   BPU functionality  The processor breakpoints implement PC based breakpoint functionality. Refer the Armv6-M Arm and the Arm CoreSight Components Technical Reference Manual for more information about the BPU CoreSight identification registers, and their addresses and access types.  30.8   DWT (data watchpoint)  The Cortex ® -M0+ DWT implementation provides two watchpoint register sets.  30.8.1   DWT functionality  The processor watchpoints implement both data address and PC based watchpoint functionality, a PC sampling register, and support comparator address masking, as described in the   Armv6-M Arm .  30.8.2   DWT Program counter sample register  A processor that implements the data watchpoint unit also implements the Armv6-M optional   DWT Program Counter Sample Register   (DWT_PCSR). This register permits a debugger to periodically sample the PC without halting the processor. This provides coarse grained profiling. See the   Armv6-M Arm   for more information. The Cortex ® -M0+ DWT_PCSR records both instructions that pass their condition codes and those that fail.  30.9   MCU debug component (DBG)  The MCU debug component helps the debugger provide support for:  •   low-power modes  •   clock control for timers, watchdog and I2C during a breakpoint  30.9.1   Debug support for low-power modes  The CPU requires active FCLK or HCLK clocks to allow any debug. By default, Stop, Standby, and Shutdown low-power modes deactivate FCLK and HCLK, which prevents debug capability. In Sleep mode however, the device keeps FCLK and HCLK always active. To keep FCLK or HCLK clocks active and so preserve debug capability in Stop, Standby, and Shutdown modes, the debugger host must set, before entering one of these low-power modes, the DBG_STOP bit (for Stop) or DBG_STANDBY bit (for Standby and Shutdown) of the DBG_CR register.

RM0490 Rev 5   1009/1027  RM0490   Debug support (DBG)  1014  30.9.2   Debug support for timers, watchdog, and I2C  During a breakpoint, it is necessary to choose how the counter of timers and watchdog should behave:  •   They can continue to count inside a breakpoint. This is usually required when a PWM is controlling a motor, for example.  •   They can stop to count inside a breakpoint. This is required for watchdog purposes. For the I2Cperipheral, the user can choose to block the SMBUS timeout during a breakpoint.  30.10   DBG registers  The devices integrate an ID code identifying the device and its die revision. This code is accessible by the software debug port (two pins) or by the user software.  30.10.1   DBG device ID code register (DBG_IDCODE)  Address offset: 0x00 Reset value: 0xUUUU UUUU (refer to   Table 177 ) Only 32-bit access supported. This read-only register allows identifying the device and its die revision. It is accessible through the software debug port (two pins) or the user software. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 REV_ID[15:0] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   DEV_ID[11:0] r   r   r   r   r   r   r   r   r   r   r   r  Bits 31:16   REV_ID[15:0]:   Device revision This field indicates the revision of the device. Refer to the device errata sheets ES0569 (STM32C011xx), ES0568 (STM32C031xx), ES0624 (STM32C051xx), ES0618 (STM32C071xx), and ES0625 (STM32C09xxx). Bits 15:12   Reserved, must be kept at reset value. Upon read, these reserved bits return 0b0110. Bits 11:0   DEV_ID[11:0] : Device identifier This field indicates the device ID. Refer to   Table 177 .  Table 177. DEV_ID bitfield values Device   DEV_ID  STM32C011xx   0x443 STM32C031xx   0x453 STM32C051xx   0x44C

Debug support (DBG)   RM0490  1010/1027   RM0490 Rev 5  30.10.2   DBG configuration register (DBG_CR   )  Address offset: 0x0000 0004 Reset value: 0x0000 0000 (power-on reset) Only 32-bit access supported. This register configures the low-power modes of the MCU under debug.  It is asynchronously reset by the POR, but not affected by the system reset. It can be written by the debugger under system reset.  If the debugger host does not support this feature, it is still possible for the user software to write this register.  30.10.3   DBG APB freeze register 1 (DBG_APB_FZ1)  Address offset: 0x08 STM32C071xx   0x493 STM32C091xx/92xx   0x44D  Table 177. DEV_ID bitfield values Device   DEV_ID  31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. DBG_ STAND BY DBG_ STOP   Res. rw   rw  Bits 31:3   Reserved, must be kept at reset value. Bit 2   DBG_STANDBY:   Debug Standby and Shutdown modes Debug options in Standby or Shutdown mode. 0: Digital part powered. From software point of view, exiting Standby and Shutdown modes is identical as fetching reset vector (except for status bits indicating that the MCU exits Standby)  1: Digital part powered and FCLK and HCLK running, derived from the internal RC oscillator remaining active. The MCU generates a system reset so that exiting Standby and Shutdown has the same effect as starting from reset. Bit 1   DBG_STOP:   Debug Stop mode Debug options in Stop mode. 0: All clocks disabled, including FCLK and HCLK. Upon Stop mode exit, the CPU is clocked by the HSI internal RC oscillator.  1: FCLK and HCLK running, derived from the internal RC oscillator remaining active. If Systick is enabled, it may generate periodic interrupt and wake up events.  Upon Stop mode exit, the software must re-establish the desired clock configuration. Bit 0   Reserved, must be kept at reset value.

RM0490 Rev 5   1011/1027  RM0490   Debug support (DBG)  1014  Reset value: 0x0000 0000 (power-on reset) Only 32-bit access are supported. This register configures the clocking of timers, RTC, IWDG, WWDG, and I2C SMBUS peripherals of the MCU under debug:  The register is asynchronously reset by the POR but not affected by the system reset). It can be written by the debugger under system reset. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. DBG_I2C1_SMBUS_TIMEOUT Res.   Res.   Res.   Res.   Res. rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res. DBG_IWDG_STOP DBG_WWDG_STOP DBG_RTC_STOP Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. DBG_TIM3_STOP DBG_TIM2_STOP rw   rw   rw   rw   rw  Bits 31:22   Reserved, must be kept at reset value. Bit 21   DBG_I2C1_SMBUS_TIMEOUT:   SMBUS timeout when core is halted 0: Same behavior as in normal mode  1: The SMBUS timeout is frozen Bits 20:13   Reserved, must be kept at reset value. Bit 12   DBG_IWDG_STOP:   Clocking of IWDG counter when the core is halted This bit enables/disables the clock to the counter of IWDG when the core is halted: 0: Enable 1: Disable Bit 11   DBG_WWDG_STOP:   Clocking of WWDG counter when the core is halted This bit enables/disables the clock to the counter of WWDG when the core is halted: 0: Enable 1: Disable Bit 10   DBG_RTC_STOP : Clocking of RTC counter when the core is halted This bit enables/disables the clock to the counter of RTC when the core is halted: 0: Enable 1: Disable

Debug support (DBG)   RM0490  1012/1027   RM0490 Rev 5  30.10.4   DBG APB freeze register 2 (DBG_APB_FZ2)  Address offset: 0x0C Reset value: 0x0000 0000 (power-on reset) Only 32-bit access is supported. This register configures the clocking of timer counters when the MCU is under debug.  It is asynchronously reset by the POR but not affected by the system reset. It can be written by the debugger under system reset. Bits 9:2   Reserved, must be kept at reset value. Bit 1   DBG_TIM3_STOP : Clocking of TIM3 counter when the core is halted This bit enables/disables the clock to the counter of TIM3 when the core is halted: 0: Enable 1: Disable Bit 0   DBG_TIM2_STOP : Clocking of TIM2 counter when the core is halted This bit enables/disables the clock to the counter of TIM2 when the core is halted: 0: Enable 1: Disable This bit is only available on STM32C051xx, STM32C071xx, and STM32C091xx/92xx. On the other devices, it is reserved. 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. DBG_TIM17_STOP DBG_TIM16_STOP DBG_TIM15_STOP rw   rw   rw 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 DBG_TIM14_STOP Res.   Res.   Res. DBG_TIM1_STOP Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res. rw   rw  Bits 31:19   Reserved, must be kept at reset value. Bit 18   DBG_TIM17_STOP : Clocking of TIM17 counter when the core is halted This bit enables/disables the clock to the counter of TIM17 when the core is halted: 0: Enable 1: Disable Bit 17   DBG_TIM16_STOP : Clocking of TIM16 counter when the core is halted This bit enables/disables the clock to the counter of TIM16 when the core is halted: 0: Enable 1: Disable

RM0490 Rev 5   1013/1027  RM0490   Debug support (DBG)  1014  Bit 16   DBG_TIM15_STOP : Clocking of TIM15 counter when the core is halted This bit enables/disables the clock to the counter of TIM15 when the core is halted: 0: Enable 1: Disable This bit is only available on STM32C091xx/92xx. On the other devices, it is reserved. Bit 15   DBG_TIM14_STOP : Clocking of TIM14 counter when the core is halted This bit enables/disables the clock to the counter of TIM14 when the core is halted: 0: Enable 1: Disable Bits 14:12   Reserved, must be kept at reset value. Bit 11   DBG_TIM1_STOP:   Clocking of TIM1 counter when the core is halted This bit enables/disables the clock to the counter of TIM1 when the core is halted: 0: Enable 1: Disable Bits 10:0   Reserved, must be kept at reset value.

Debug support (DBG)   RM0490  1014/1027   RM0490 Rev 5  30.10.5   DBG register map  The following table summarizes the DBG registers. . Refer to   Section 2.2 on page 45   for the register boundary addresses.  Table 178. DBG register map and reset values Offset   Register 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0  0x00  DBG_ IDCODE   REV_ID Res. Res. Res. Res. DEV_ID Reset value (1)   U   U   U   U   U   U   U   U   U   U   U   U   U   U   U   U   0   1   1   0   U   U   U   U   U   U   U   U   U   U   U   U 0x04   DBG_CR  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DBG_STANDBY DBG_STOP Res. Reset value   0   0 0x08  DBG_ APB_FZ1  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DBG_I2C1_SMBUS_TIMEOUT Res. Res. Res. Res. Res. Res. Res. Res. DBG_IWDG_STOP DBG_WWDG_STOP DBG_RTC_STOP Res. Res. Res. Res. Res. Res. Res. Res. DBG_TIM3_STOP DBG_TIM2_STOP Reset value   0   0   0   0   0   0 0x0C  DBG_ APB_FZ2  Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. DBG_TIM17_STOP DBG_TIM16_STOP DBG_TIM15_STOP DBG_TIM14_STOP Res. Res. Res. DBG_TIM1_STOP Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Res. Reset value   0   0   0   0   0 1.   The reset value is product dependent. For more information, refer to   Section 30.10.1: DBG device ID code register (DBG_IDCODE) .

RM0490 Rev 5   1015/1027  RM0490   Device electronic signature  1017  31   Device electronic signature  The device electronic signature is stored in the system memory area of the flash memory module, and can be read using the debug inter face or by the CPU. It contains factory- programmed identification and calibration data that allow the user firmware or other external devices to automatically match to the characteristics of the STM32C0 series microcontroller.  31.1   Unique device ID register (96 bits) (UID)  Base address: 0x1FFF 7550 Address offset: 0x00 Reset value: 0xXXXX XXXX (where X is factory-programmed) The unique device identifier is ideally suited:  •   for use as serial numbers (for example USB string serial numbers or other end applications)  •   for use as part of the security keys in order to increase the security of code in flash memory while using and combining this unique ID with software cryptographic primitives and protocols before programming the internal flash memory  •   to activate secure boot processes, and so on. The 96-bit unique device identifier provides a reference number which is unique for any device and in any context. These bits cannot be altered by the user. Address offset: 0x04 Reset value: 0xXXXX XXXX where X is factory-programmed 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 UID[31:16] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 UID[15:0] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r Bits 31:0   UID[31:0]:   X and Y coordinates on the wafer expressed in BCD format 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 UID[63:48] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 UID[47:32] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r

Device electronic signature   RM0490  1016/1027   RM0490 Rev 5  Address offset: 0x08 Reset value: 0xXXXX XXXX where X is factory-programmed  31.2   Flash memory size data register (FSIZER)  Base address: 0x1FFF 75A0 Address offset: 0x00 Reset value: 0xXXXX where X is factory-programmed  31.3   Package data register (PCKR)  Base address: 0x1FFF 7500 Address offset: 0x00 Reset value: 0xXXXX where X is factory-programmed Bits 31:8   UID[63:40]:   LOT_NUM[23:0] Lot number (ASCII encoded) Bits 7:0   UID[39:32]:   WAF_NUM[7:0] Wafer number (8-bit unsigned number) 31   30   29   28   27   26   25   24   23   22   21   20   19   18   17   16 UID[95:80] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 UID[79:64] r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r Bits 31:0   UID[95:64]:   LOT_NUM[55:24] Lot number (ASCII encoded) 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 FLASH_SIZE r   r   r   r   r   r   r   r   r   r   r   r   r   r   r   r Bits 15:0   FLASH_SIZE[15:0] : Flash memory size This bitfield indicates the size of the device flash memory expressed in Kbytes. As an example, 0x040 corresponds to 64 Kbytes. 15   14   13   12   11   10   9   8   7   6   5   4   3   2   1   0 Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   Res.   PKG[3:0] r   r   r   r

RM0490 Rev 5   1017/1027  RM0490   Device electronic signature  1017  Bits 15:4   Reserved Bits 3:0   PKG[3:0]:   Package type  Condition: STM32C011xx  0001: SO8 0010: WLCSP12 0011: UFQFPN20 0100: TSSOP20 Other: Reserved  Condition: STM32C031xx  0010: TSSOP20 0011: UFQFPN28 0100: UFQFPN32 / LQFP32 0101: UFQFPN48 / LQFP48 Other: Reserved  Condition: STM32C051xx  0001: WLCSP15 0010: TSSOP20 0011: UFQFPN28 0100: UFQFPN32 / LQFP32 0101: UFQFPN48 / LQFP48 Other: Reserved  Condition: STM32C071xx  0001: WLCSP19_GP 0010: WLCSP19_N 0011: TSSOP20_GP 0100: TSSOP20_N 0101: UFQFPN28_GP 0110: UFQFPN28_N 0111: UFQFPN32_GP / LQFP32_GP 1000: UFQFPN32_N / LQFP32_N 1001: UFQFPN48_GP / LQFP48_GP 1010: UFQFPN48_N / LQFP48_N 1011: LQFP64_GP 1000: LQFP64_N 1101: UFBGA64_GP 1110: UFBGA64_N Other: Reserved  Condition: STM32C091xx/92xx  0001: TSSOP20 0010: WLCSP24 0011: UFQFPN28 0100: UFQFPN32 / LQFP32 0101: UFQFPN48 / LQFP48 0110: UFBGA64 / LQFP64 Other: Reserved

Important security notice   RM0490  1018/1027   RM0490 Rev 5  32   Important security notice  The STMicroelectronics group of companies (ST) places a high value on product security, which is why the ST product(s) identified in this documentation may be certified by various security certification bodies and/or may implement our own security measures as set forth herein. However, no level of security certification and/or built-in security measures can guarantee that ST products are resistant to all forms of attacks. As such, it is the responsibility of each of ST's customers to determine if the level of security provided in an ST product meets the customer needs both in relation to the ST product alone, as well as when combined with other components and/or software for the customer end product or application. In particular, take note that:  •   ST products may have been certified by one or more security certification bodies, such as Platform Security Architecture (www.psacertified.org) and/or Security Evaluation standard for IoT Platforms (www.trustcb.com). For details concerning whether the ST product(s) referenced herein have received security certification along with the level and current status of such certification, either visit the relevant certification standards website or go to the relevant product page on   www.st.com   for the most up to date information. As the status and/or level of security certification for an ST product can change from time to time, customers should re-check security certification status/level as needed. If an ST product is not shown to be certified under a particular security standard, customers should not assume it is certified.  •   Certification bodies have the right to evaluate, grant and revoke security certification in relation to ST products. These certification bodies are therefore independently responsible for granting or revoking security certification for an ST product, and ST does not take any responsibility for mistakes, evaluations, assessments, testing, or other activity carried out by the certification body with respect to any ST product.  •   Industry-based cryptographic algorithms (such as AES, DES, or MD5) and other open standard technologies which may be used in conjunction with an ST product are based on standards which were not developed by ST. ST does not take responsibility for any flaws in such cryptographic algorithms or open technologies or for any methods which have been or may be developed to bypass, decrypt or crack such algorithms or technologies.  •   While robust security testing may be done, no level of certification can absolutely guarantee protections against all attacks, including, for example, against advanced attacks which have not been tested for, against new or unidentified forms of attack, or against any form of attack when using an ST product outside of its specification or intended use, or in conjunction with other components or software which are used by customer to create their end product or application. ST is not responsible for resistance against such attacks. As such, regardless of the incorporated security features and/or any information or support that may be provided by ST, each customer is solely responsible for determining if the level of attacks tested for meets their needs, both in relation to the ST product alone and when incorporated into a customer end product or application.  •   All security features of ST products (inclusive of any hardware, software, documentation, and the like), including but not limited to any enhanced security features added by ST, are provided on an "AS IS" BASIS. AS SUCH, TO THE EXTENT PERMITTED BY APPLICABLE LAW, ST DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, unless the applicable written and signed contract terms specifically provide otherwise.

RM0490 Rev 5   1019/1027  RM0490   Revision history  1022  33   Revision history  Table 179. Document revision history Date   Revision   Changes  12-Apr-2022   1   Initial release. 21-Jul-2022   2 Section   Fast programming   - row size corrected.  Table 18: Organization of option bytes   now contains links to option registers and the duplicated description is removed. Format of reset values of option registers updated and/or corrected. Note in bit 16 of   FLASH security register (FLASH_SECR)   updated. Updated   Section 17.3.18: Clearing the OCxREF signal on an external event . OC1M[3:0] bitfield description updated in   Section 17.4.8: TIM1 capture/compare mode register 1 [alternate] (TIM1_CCMR1) ,   Section 18.4.8: TIMx capture/compare mode register 1 [alternate] (TIMx_CCMR1) (x = 2 to 3) ,  Section 19.4.6: TIM14 capture/compare mode register 1 [alternate] (TIM14_CCMR1) , and   Section 20.6.7: TIMx capture/compare mode register 1 [alternate] (TIMx_CCMR1)(x = 16 to 17) . USART2 information in   Table 27: Device resources enabled in different operating modes   corrected. Spurious “TIM15” removed from   Section 6.2.7: Clock security system (CSS) . Cross-reference to DBG added in WWDG   Section 23.3.5: Debug mode .  Section 24.2: RTC main features   corrected (spurious “or by a tamper event” removed). 03-Dec-2022   3 First public release.  Section 5.3.2: Low-power modes , bulleted point Standby mode.  Section 6.2: Clocks , bulleted point TIMx.  Figure 9: Clock tree .  Section 6.3: Low-power modes , removal of “USART2”. Section   Converting a supply-relative ADC measurement to an absolute voltage value .  Figure 100: Break and Break2 circuitry overview   - note under the figure corrected.  Section 17.3.25: Interfacing with Hall sensors   - removal of “TIM4”.  Figure 207: Break circuitry overview   - note under the figure corrected. 10-Jul-2024   4 Document device reference from “STM32C0x1” to “STM32C0 series”; Integration of the information relative to STM32C071xx. Cover page: added reference to the errata sheets. Added   Section 7: Clock recovery system (CRS)   and   Section 29: Universal serial bus full-speed host/device interface (USB) .  Memory mapping:   Added   Table 1: Peripherals or functions versus products . Updated   Figure 2: Memory map ,   Table 2: STM32C011xx and STM32C031xx boundary addresses , and   Table 7: STM32C0 series peripheral register boundary addresses ; added   Table 4: STM32C071xx boundary addresses .  Promoted   Section 3: Boot modes   to the first level and updated. Demoted  Section 3.1: Boot configuration   as a subsection. Reworked   Section 3.1.4: Empty check . In the table of boundary addresses, “Code” replaced with “FLASH” and “FLASH or SRAM”;

Revision history   RM0490  1020/1027   RM0490 Rev 5  10-Jul-2024   4  Boot modes:   updated   Section 3.1: Boot configuration ;  FLASH:   Section 4.2: FLASH main features ,   Section 4.3.1: Flash memory organization   (added   Section Table 12.: Flash memory organization for STM32C071xx ), sections   Flash memory page erase ,   Flash memory bank or mass erase ,   Standard programming , and   Fast programming ; adapted sizes of PCROP1A_STRT, PCROP1A_END, PCROP1B_STRT, PCROP1B_END, WRP1A_STRT, WRP1A_END, WRP1B_STRT, WRP1B_END, SEC_SIZE and PNB bitfields; updated   Section 4.5.1: FLASH read protection (RDP) ,  Section 4.5.6: Forcing boot from main flash memory , and   Table 22: PCROP protection , sections   Changing the read protection level ,   Fast programming , and   Option byte loading , registers FLASH_ACR, FLASH_SR, FLASH_CR; option bytes FLASH_OPTR factory value, BOR_EN reset value; HSI48 division corrected from four to three; BOOT_LOCK bit note modified; all nBOOTx and nRSTx bits renamed to NBOOTx and NRSTx; Removed section  FLASH empty check ;  PWR:   updated   Section 5.1: Power supplies and voltage references   ( Figure 5: Power supply overview ),   Table 27: Device resources enabled in different operating modes , and registers PWR_CR3, PWR_CR4, PWR_SR1, PWR_SR2, PWR_SCR, PWR_PUCRC, PWR_PDCRC, PWR_PUCRD, PWR_PDCRD, PWR_PUCRF, and PWR_PDCRF; Added register PWR_CR2; corrected PVM_VDDIO2_OUT description;  RCC:   Added HSIUSB48 RC oscillator in multiple sections, tables, and figures; updated   Figure 9: Clock tree , added   Section 6.2.3: HSIUSB48 clock , updated registers RCC_CR, RCC_CFGR, RCC_CIER, RCC_CIFR, RCC_CICR, RCC_APBRSTR1, RCC_APBENR1, RCC_APBSMENR1, RCC_APBSMENR2, and RCC_CCIPR1 (to RCC_CCIPR); added registers RCC_CCIPR2 and RCC_CRRCR; Corrected RCC_CFGR bitmap, LSERDYIE bit name, LSIRDYF bit description, HSIDIV[2:0] and HSIKERDIV[2:0] reset values in the register map, and missing bits added; updated   Section 6.2.15: Peripheral clock enable registers ; RCC_RC register access specified; HSIUSB48 added to SW[2:0] and SWS[2:0] bitfields; LSIRDYF description corrected; updated section   NRST (external reset) ; pin name PF2 or NRST corrected to PF2-NRST; bitfield PINRSTF of RCC_CSR2 register updated; corrected reference in section   External crystal/ceramic resonator (HSE crystal) ; updated section   External source (HSE bypass)   and   TIM17 ;  CRS:   added   Section 7.4.2: CRS internal signals ; updated   Table 34: CRS interconnection   title;  GPIO:   Updated register GPIOx_PUPDR,   Section 8.3.14: Low pin count package adjustment , and   Section 8.3.15: Reset pin (PF2-NRST) in GPIO mode ; removed section   Boot0 pin (PA14) in GPIO mode;  SYSCFG:   Updated registers SYSCFG_CFGR1, SYSCFG_CFGR3, SYSCFG_ITLINE11, added registers SYSCFG_ITLINE9, SYSCFG_ITLINE15, SYSCFG_ITLINE24, and SYSCFG_ITLINE25; added register SYSCFG_ITLINE1; corrected “system reset value” to “reset value” for all registers; updated register SYSCFG_CFGR3 description; updated   Table 41: SYSCFG register map and reset values ;  DMAMUX:   Updated   Table 49: DMAMUX: assignment of multiplexer inputs to resources ,   Table 50: DMAMUX: assignment of trigger inputs to resources , and  Table 51: DMAMUX: assignment of synchronization inputs to resources ;  Interconnect matrix:   Updated   Table 42: Interconnect matrix   and sections  Section 10.3.1   and   Section 10.3.2 ; Added TIM2;  NVIC:   Updated   Table 55: Vector table ; added VDDIO2 monitor interrupt;  Table 179. Document revision history (continued) Date   Revision   Changes

RM0490 Rev 5   1021/1027  RM0490   Revision history  1022  10-Jul-2024   4  EXTI:   Updated   Table 59: EXTI line connections ; added registers EXTI_RTSR2, EXTI_FTSR2, EXTI_SWIER2, EXTI_RPR2, EXTI_FPR2, EXTI_IMR2, and EXTI_EMR2; updated EXTI_EXTICRx register description by replacing the “ m ” substitution of the repeating part of the formula in all bitfield names and enumerated value descriptions; updated   Table 59: EXTI line connections ,   Section 14.5.14: EXTI CPU wake-up with interrupt mask register 2 (EXTI_IMR2) ,   Section 14.5.15: EXTI CPU wake-up with event mask register 2 (EXTI_EMR2) , and   Section 14.5.16: EXTI register map  TIMERS:   updated   Table 20.6.20: TIM17 input selection register (TIM17_TISEL) ;  I2C:   general update;  DBG:   Updated   Section 30.5.3: SW-DP state machine (reset, idle states, ID code)   (ID code),   Table 177: DEV_ID bitfield values   and the DBG_APB_FZ1 register; added reset value to the DBG_IDCODE register; REV_ID bitfield definition reported to the errata sheets; Device electronic signature: Updated   Section 31.3: Package data register (PCKR)  IDWG:   Corrected descriptions of the IWDG_SR register bitfields WVU and RVU;  USART:   Extended note in the description of the PRESCALER[3:0] bitfield of the USART_PRESC register;  USB:   updated   Table 29.4.2: USB pins and internal signals   and   Section 29.4.5: Description of USB blocks used in both Device and Host modes ; register description split to USB registers and USB SRAM registers;  Device electronic signature : Corrected all LQPF occurrences to LQFP.  Multiple sections:   SPI1/I2S or SPI1 used as instance name of the peripheral corrected to SPI2S1.  Table 179. Document revision history (continued) Date   Revision   Changes

Revision history   RM0490  1022/1027   RM0490 Rev 5  17-Dec-2024   5 Added information specific to STM32C051xx and STM32C09xxx devices;  Document conventions:   Added   Section 1.3: Register reset value ;  Memory and bus architecture:   Added   Section 2.4: FDCAN RAM ,   Table 3 ,  Table 5 , and   Table 6 ; updated   Table 7 ,  FLASH:   Added   Table 11   and   Table 13 ; updated   Table 21 ,   Section 4.7.6: FLASH option register (FLASH_OPTR) ; updates for integrating STM32C051xx and STM32C09xxx, and FDCAN;  PWR:   Updated   Table 27: Device resources enabled in different operating modes ,   Section : Peripheral clock gating ; updates for integrating STM32C051xx and STM32C09xxx;  RCC:   Updates for integrating STM32C051xx and STM32C09xxx, and FDCAN; updated   Figure 9: Clock tree ,   Section 6.2.6: System clock (SYSCLK) selection ;  CRS:   Added   Table 33: CRS internal input/output signals ; general update;  GPIO:   Added   Section 8.4: GPIO in low-power modes ; updates for integrating STM32C051xx and STM32C09xxx;  SYSCFG:   Added sections   Section 9.1.22 ,   Section 9.1.31 ,   Section 9.1.32 , and  Section 9.1.33 ;  DMAMUX:   Updates for integrating STM32C051xx and STM32C09xxx;  EXTI:   Updates for introducing TIM15, USART3, USART4, and FDCAN;  Interconnect matrix:   Updated   Section 10.3.1 ,   Section 10.3.2 , and  Section 10.3.6 ;  ADC:   Updated software calibration procedure, ADC clock symbol, TSEN and VREFEN bitfields;  Timers:   Update of advanced timer and general-purpose timer sections, with the addition of TIM15;  I2C:   General update, with the deprecated terms   master   and   slave   replaced with   controller   and   target , respectively; Added   Section 28: FD controller area network (FDCAN) ; Added   Section 32: Important security notice  Table 179. Document revision history (continued) Date   Revision   Changes

Index  RM0490 Rev 5   1023/1027  Index A  ADC_AWD1TR   . . . . . . . . . . . . . . . . . . . . . . .335 ADC_AWD2CR   . . . . . . . . . . . . . . . . . . . . . . .339 ADC_AWD2TR   . . . . . . . . . . . . . . . . . . . . . . .335 ADC_AWD3CR   . . . . . . . . . . . . . . . . . . . . . . .340 ADC_AWD3TR   . . . . . . . . . . . . . . . . . . . . . . .338 ADC_CALFACT   . . . . . . . . . . . . . . . . . . . . . . .340 ADC_CCR   . . . . . . . . . . . . . . . . . . . . . . . . . . .341 ADC_CFGR1   . . . . . . . . . . . . . . . . . . . . . . . . .329 ADC_CFGR2   . . . . . . . . . . . . . . . . . . . . . . . . .332 ADC_CHSELR   . . . . . . . . . . . . . . . . . . . . 335 -   336 ADC_CR   . . . . . . . . . . . . . . . . . . . . . . . . . . . .327 ADC_DR   . . . . . . . . . . . . . . . . . . . . . . . . . . . .339 ADC_IER   . . . . . . . . . . . . . . . . . . . . . . . . . . . .325 ADC_ISR   . . . . . . . . . . . . . . . . . . . . . . . . . . . .324 ADC_SMPR   . . . . . . . . . . . . . . . . . . . . . . . . . .334  C  CRC_CR   . . . . . . . . . . . . . . . . . . . . . . . . . . . .282 CRC_DR   . . . . . . . . . . . . . . . . . . . . . . . . . . . .281 CRC_IDR   . . . . . . . . . . . . . . . . . . . . . . . . . . . .281 CRC_INIT   . . . . . . . . . . . . . . . . . . . . . . . . . . . .283 CRC_POL   . . . . . . . . . . . . . . . . . . . . . . . . . . .283 CRS_CFGR   . . . . . . . . . . . . . . . . . . . . . . . . . .172 CRS_CR   . . . . . . . . . . . . . . . . . . . . . . . . . . . .171 CRS_ICR   . . . . . . . . . . . . . . . . . . . . . . . . . . . .175 CRS_ISR   . . . . . . . . . . . . . . . . . . . . . . . . . . . .173  D  DBG_APB_FZ1   . . . . . . . . . . . . . . . . . . . . . .1010 DBG_APB_FZ2   . . . . . . . . . . . . . . . . . . . . . .1012 DBG_CR   . . . . . . . . . . . . . . . . . . . . . . . . . . .1010 DBG_IDCODE   . . . . . . . . . . . . . . . . . . . . . . .1009 DMA_CCRx   . . . . . . . . . . . . . . . . . . . . . . . . . .235 DMA_CMARx   . . . . . . . . . . . . . . . . . . . . . . . . .239 DMA_CNDTRx   . . . . . . . . . . . . . . . . . . . . . . . .237 DMA_CPARx   . . . . . . . . . . . . . . . . . . . . . . . . .238 DMA_IFCR   . . . . . . . . . . . . . . . . . . . . . . . . . . .233 DMA_ISR   . . . . . . . . . . . . . . . . . . . . . . . . . . . .231 DMAMUX_CFR   . . . . . . . . . . . . . . . . . . . . . . .253 DMAMUX_CSR   . . . . . . . . . . . . . . . . . . . . . . .253 DMAMUX_CxCR   . . . . . . . . . . . . . . . . . . . . . .252 DMAMUX_RGCFR   . . . . . . . . . . . . . . . . . . . .255 DMAMUX_RGSR   . . . . . . . . . . . . . . . . . . . . . .255 DMAMUX_RGxCR   . . . . . . . . . . . . . . . . . . . . .254  E  EXTI_EMR1   . . . . . . . . . . . . . . . . . . . . . . . . . 274 EXTI_EMR2   . . . . . . . . . . . . . . . . . . . . . . . . . 275 EXTI_EXTICRx   . . . . . . . . . . . . . . . . . . . . . . . 271 EXTI_FPR1   . . . . . . . . . . . . . . . . . . . . . . . . . . 268 EXTI_FPR2   . . . . . . . . . . . . . . . . . . . . . . . . . . 271 EXTI_FTSR1   . . . . . . . . . . . . . . . . . . . . . . . . . 267 EXTI_FTSR2   . . . . . . . . . . . . . . . . . . . . . . . . . 269 EXTI_IMR1   . . . . . . . . . . . . . . . . . . . . . . . . . . 273 EXTI_IMR2   . . . . . . . . . . . . . . . . . . . . . . . . . . 274 EXTI_RPR1   . . . . . . . . . . . . . . . . . . . . . . . . . . 268 EXTI_RPR2   . . . . . . . . . . . . . . . . . . . . . . . . . . 270 EXTI_RTSR1   . . . . . . . . . . . . . . . . . . . . . . . . . 266 EXTI_RTSR2   . . . . . . . . . . . . . . . . . . . . . . . . . 269 EXTI_SWIER1   . . . . . . . . . . . . . . . . . . . . . . . . 267 EXTI_SWIER2   . . . . . . . . . . . . . . . . . . . . . . . . 270  F  FDCAN_CCCR   . . . . . . . . . . . . . . . . . . . . . . . 923 FDCAN_CKDIV   . . . . . . . . . . . . . . . . . . . . . . . 948 FDCAN_CREL   . . . . . . . . . . . . . . . . . . . . . . . 920 FDCAN_DBTP   . . . . . . . . . . . . . . . . . . . . . . . 920 FDCAN_ECR   . . . . . . . . . . . . . . . . . . . . . . . . 928 FDCAN_ENDN   . . . . . . . . . . . . . . . . . . . . . . . 920 FDCAN_HPMS   . . . . . . . . . . . . . . . . . . . . . . . 939 FDCAN_IE   . . . . . . . . . . . . . . . . . . . . . . . . . . . 934 FDCAN_ILE   . . . . . . . . . . . . . . . . . . . . . . . . . . 937 FDCAN_ILS   . . . . . . . . . . . . . . . . . . . . . . . . . . 936 FDCAN_IR   . . . . . . . . . . . . . . . . . . . . . . . . . . 931 FDCAN_NBTP   . . . . . . . . . . . . . . . . . . . . . . . 924 FDCAN_PSR   . . . . . . . . . . . . . . . . . . . . . . . . . 929 FDCAN_RWD   . . . . . . . . . . . . . . . . . . . . . . . . 922 FDCAN_RXF0A   . . . . . . . . . . . . . . . . . . . . . . 941 FDCAN_RXF0S   . . . . . . . . . . . . . . . . . . . . . . 940 FDCAN_RXF1A   . . . . . . . . . . . . . . . . . . . . . . 942 FDCAN_RXF1S   . . . . . . . . . . . . . . . . . . . . . . 941 FDCAN_RXGFC   . . . . . . . . . . . . . . . . . . . . . . 937 FDCAN_TDCR   . . . . . . . . . . . . . . . . . . . . . . . 931 FDCAN_TEST   . . . . . . . . . . . . . . . . . . . . . . . . 921 FDCAN_TOCC   . . . . . . . . . . . . . . . . . . . . . . . 927 FDCAN_TOCV   . . . . . . . . . . . . . . . . . . . . . . . 928 FDCAN_TSCC   . . . . . . . . . . . . . . . . . . . . . . . 926 FDCAN_TSCV   . . . . . . . . . . . . . . . . . . . . . . . 926 FDCAN_TXBAR   . . . . . . . . . . . . . . . . . . . . . . 944 FDCAN_TXBC   . . . . . . . . . . . . . . . . . . . . . . . 942 FDCAN_TXBCF   . . . . . . . . . . . . . . . . . . . . . . 946 FDCAN_TXBCIE   . . . . . . . . . . . . . . . . . . . . . . 947

Index  1024/1027   RM0490 Rev 5  FDCAN_TXBCR   . . . . . . . . . . . . . . . . . . . . . . .945 FDCAN_TXBRP   . . . . . . . . . . . . . . . . . . . . . . .943 FDCAN_TXBTIE   . . . . . . . . . . . . . . . . . . . . . .946 FDCAN_TXBTO   . . . . . . . . . . . . . . . . . . . . . . .945 FDCAN_TXEFA   . . . . . . . . . . . . . . . . . . . . . . .948 FDCAN_TXEFS   . . . . . . . . . . . . . . . . . . . . . . .947 FDCAN_TXFQS   . . . . . . . . . . . . . . . . . . . . . . .943 FDCAN_XIDAM   . . . . . . . . . . . . . . . . . . . . . . .939 FLASH_ACR   . . . . . . . . . . . . . . . . . . . . . . . . . .77 FLASH_CR   . . . . . . . . . . . . . . . . . . . . . . . . . . .81 FLASH_KEYR   . . . . . . . . . . . . . . . . . . . . . . . . .78 FLASH_OPTKEYR   . . . . . . . . . . . . . . . . . . . . .78 FLASH_OPTR   . . . . . . . . . . . . . . . . . . . . . . . . .83 FLASH_PCROP1AER   . . . . . . . . . . . . . . . . . . .86 FLASH_PCROP1ASR   . . . . . . . . . . . . . . . . . . .85 FLASH_PCROP1BER   . . . . . . . . . . . . . . . . . . .88 FLASH_PCROP1BSR   . . . . . . . . . . . . . . . . . . .88 FLASH_SECR   . . . . . . . . . . . . . . . . . . . . . . . . .89 FLASH_SR   . . . . . . . . . . . . . . . . . . . . . . . . . . . .79 FLASH_WRP1AR   . . . . . . . . . . . . . . . . . . . . . .86 FLASH_WRP1BR   . . . . . . . . . . . . . . . . . . . . . .87 FSIZER   . . . . . . . . . . . . . . . . . . . . . . . . . . . .1016  G  GPIOx_AFRH   . . . . . . . . . . . . . . . . . . . . . . . . .192 GPIOx_AFRL   . . . . . . . . . . . . . . . . . . . . . . . . .191 GPIOx_BRR   . . . . . . . . . . . . . . . . . . . . . . . . . .193 GPIOx_BSRR   . . . . . . . . . . . . . . . . . . . . . . . .190 GPIOx_IDR   . . . . . . . . . . . . . . . . . . . . . . . . . .189 GPIOx_LCKR   . . . . . . . . . . . . . . . . . . . . . . . . .190 GPIOx_MODER   . . . . . . . . . . . . . . . . . . . . . . .187 GPIOx_ODR   . . . . . . . . . . . . . . . . . . . . . . . . .189 GPIOx_OSPEEDR   . . . . . . . . . . . . . . . . . . . . .188 GPIOx_OTYPER   . . . . . . . . . . . . . . . . . . . . . .188 GPIOx_PUPDR   . . . . . . . . . . . . . . . . . . . . . . .188  I  I2C_CR1   . . . . . . . . . . . . . . . . . . . . . . . . . . . .727 I2C_CR2   . . . . . . . . . . . . . . . . . . . . . . . . . . . .730 I2C_ICR   . . . . . . . . . . . . . . . . . . . . . . . . . . . . .738 I2C_ISR   . . . . . . . . . . . . . . . . . . . . . . . . . . . . .736 I2C_OAR1   . . . . . . . . . . . . . . . . . . . . . . . . . . .732 I2C_OAR2   . . . . . . . . . . . . . . . . . . . . . . . . . . .733 I2C_PECR   . . . . . . . . . . . . . . . . . . . . . . . . . . .739 I2C_RXDR   . . . . . . . . . . . . . . . . . . . . . . . . . . .739 I2C_TIMEOUTR   . . . . . . . . . . . . . . . . . . . . . . .735 I2C_TIMINGR   . . . . . . . . . . . . . . . . . . . . . . . .734 I2C_TXDR   . . . . . . . . . . . . . . . . . . . . . . . . . . .740 IWDG_KR   . . . . . . . . . . . . . . . . . . . . . . . . . . .634 IWDG_PR   . . . . . . . . . . . . . . . . . . . . . . . . . . .635 IWDG_RLR   . . . . . . . . . . . . . . . . . . . . . . . . . .636 IWDG_SR   . . . . . . . . . . . . . . . . . . . . . . . . . . . 637 IWDG_WINR   . . . . . . . . . . . . . . . . . . . . . . . . . 638  P  PCKR   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1016 PWR_BKPxR   . . . . . . . . . . . . . . . . . . . . . . . . 115 PWR_CR1   . . . . . . . . . . . . . . . . . . . . . . . . . . . 102 PWR_CR2   . . . . . . . . . . . . . . . . . . . . . . . . . . . 103 PWR_CR3   . . . . . . . . . . . . . . . . . . . . . . . . . . . 104 PWR_CR4   . . . . . . . . . . . . . . . . . . . . . . . . . . . 105 PWR_PDCRA   . . . . . . . . . . . . . . . . . . . . . . . . 109 PWR_PDCRB   . . . . . . . . . . . . . . . . . . . . . . . . 110 PWR_PDCRC   . . . . . . . . . . . . . . . . . . . . . . . . 111 PWR_PDCRD   . . . . . . . . . . . . . . . . . . . . . . . . 113 PWR_PDCRF   . . . . . . . . . . . . . . . . . . . . . . . . 114 PWR_PUCRA   . . . . . . . . . . . . . . . . . . . . . . . . 109 PWR_PUCRB   . . . . . . . . . . . . . . . . . . . . . . . . 110 PWR_PUCRC   . . . . . . . . . . . . . . . . . . . . . . . . 111 PWR_PUCRD   . . . . . . . . . . . . . . . . . . . . . . . . 112 PWR_PUCRF   . . . . . . . . . . . . . . . . . . . . . . . . 114 PWR_SCR   . . . . . . . . . . . . . . . . . . . . . . . . . . 108 PWR_SR1   . . . . . . . . . . . . . . . . . . . . . . . . . . . 106 PWR_SR2   . . . . . . . . . . . . . . . . . . . . . . . . . . . 107  R  RCC_AHBENR   . . . . . . . . . . . . . . . . . . . . . . . 148 RCC_AHBRSTR   . . . . . . . . . . . . . . . . . . . . . . 144 RCC_AHBSMENR   . . . . . . . . . . . . . . . . . . . . 154 RCC_APBENR1   . . . . . . . . . . . . . . . . . . . . . . 149 RCC_APBENR2   . . . . . . . . . . . . . . . . . . . . . . 151 RCC_APBRSTR1   . . . . . . . . . . . . . . . . . . . . . 144 RCC_APBRSTR2   . . . . . . . . . . . . . . . . . . . . . 146 RCC_APBSMENR1   . . . . . . . . . . . . . . . . . . . 154 RCC_APBSMENR2   . . . . . . . . . . . . . . . . . . . 157 RCC_CCIPR   . . . . . . . . . . . . . . . . . . . . . . . . . 158 RCC_CCIPR2   . . . . . . . . . . . . . . . . . . . . . . . . 159 RCC_CFGR   . . . . . . . . . . . . . . . . . . . . . . . . . 136 RCC_CICR   . . . . . . . . . . . . . . . . . . . . . . . . . . 142 RCC_CIER   . . . . . . . . . . . . . . . . . . . . . . . . . . 139 RCC_CIFR   . . . . . . . . . . . . . . . . . . . . . . . . . . 140 RCC_CR   . . . . . . . . . . . . . . . . . . . . . . . . . . . . 133 RCC_CRRCR   . . . . . . . . . . . . . . . . . . . . . . . . 139 RCC_CSR1   . . . . . . . . . . . . . . . . . . . . . . . . . . 159 RCC_CSR2   . . . . . . . . . . . . . . . . . . . . . . . . . . 161 RCC_ICSCR   . . . . . . . . . . . . . . . . . . . . . . . . . 135 RCC_IOPENR   . . . . . . . . . . . . . . . . . . . . . . . . 147 RCC_IOPRSTR   . . . . . . . . . . . . . . . . . . . . . . . 143 RCC_IOPSMENR   . . . . . . . . . . . . . . . . . . . . . 153 RTC_ALRMAR   . . . . . . . . . . . . . . . . . . . . . . . 671 RTC_ALRMASSR   . . . . . . . . . . . . . . . . . . . . . 672 RTC_CALR   . . . . . . . . . . . . . . . . . . . . . . . . . . 667

Index  RM0490 Rev 5   1025/1027  RTC_CR   . . . . . . . . . . . . . . . . . . . . . . . . . . . . .664 RTC_DR   . . . . . . . . . . . . . . . . . . . . . . . . . . . . .661 RTC_ICSR   . . . . . . . . . . . . . . . . . . . . . . . . . . .662 RTC_MISR   . . . . . . . . . . . . . . . . . . . . . . . . . . .673 RTC_PRER   . . . . . . . . . . . . . . . . . . . . . . . . . .664 RTC_SCR   . . . . . . . . . . . . . . . . . . . . . . . . . . .674 RTC_SHIFTR   . . . . . . . . . . . . . . . . . . . . . . . . .668 RTC_SR   . . . . . . . . . . . . . . . . . . . . . . . . . . . . .672 RTC_SSR   . . . . . . . . . . . . . . . . . . . . . . . . . . .662 RTC_TR   . . . . . . . . . . . . . . . . . . . . . . . . . . . . .660 RTC_TSDR   . . . . . . . . . . . . . . . . . . . . . . . . . .670 RTC_TSSSR   . . . . . . . . . . . . . . . . . . . . . . . . .670 RTC_TSTR   . . . . . . . . . . . . . . . . . . . . . . . . . .669 RTC_WPR   . . . . . . . . . . . . . . . . . . . . . . . . . . .667  S  SPIx_CR1   . . . . . . . . . . . . . . . . . . . . . . . . . . .875 SPIx_CR2   . . . . . . . . . . . . . . . . . . . . . . . . . . .877 SPIx_CRCPR   . . . . . . . . . . . . . . . . . . . . . . . . .881 SPIx_DR   . . . . . . . . . . . . . . . . . . . . . . . . . . . .881 SPIx_I2SCFGR   . . . . . . . . . . . . . . . . . . . . . . .882 SPIx_I2SPR   . . . . . . . . . . . . . . . . . . . . . . . . . .884 SPIx_RXCRCR   . . . . . . . . . . . . . . . . . . . . . . .881 SPIx_SR   . . . . . . . . . . . . . . . . . . . . . . . . . . . . .879 SPIx_TXCRCR   . . . . . . . . . . . . . . . . . . . . . . . .882 SYSCFG_CFGR1   . . . . . . . . . . . . . . . . . . . . .195 SYSCFG_CFGR2   . . . . . . . . . . . . . . . . . . . . .197 SYSCFG_CFGR3   . . . . . . . . . . . . . . . . . . . . .198 SYSCFG_ITLINE0   . . . . . . . . . . . . . . . . . . . . .201 SYSCFG_ITLINE1   . . . . . . . . . . . . . . . . . . . . .202 SYSCFG_ITLINE10   . . . . . . . . . . . . . . . . . . . .206 SYSCFG_ITLINE11   . . . . . . . . . . . . . . . . . . . .206 SYSCFG_ITLINE12   . . . . . . . . . . . . . . . . . . . .207 SYSCFG_ITLINE13   . . . . . . . . . . . . . . . . . . . .207 SYSCFG_ITLINE14   . . . . . . . . . . . . . . . . . . . .207 SYSCFG_ITLINE15   . . . . . . . . . . . . . . . . . . . .208 SYSCFG_ITLINE16   . . . . . . . . . . . . . . . . . . . .208 SYSCFG_ITLINE19   . . . . . . . . . . . . . . . . . . . .208 SYSCFG_ITLINE2   . . . . . . . . . . . . . . . . . . . . .202 SYSCFG_ITLINE20   . . . . . . . . . . . . . . . . . . . .209 SYSCFG_ITLINE21   . . . . . . . . . . . . . . . . . . . .209 SYSCFG_ITLINE22   . . . . . . . . . . . . . . . . . . . .209 SYSCFG_ITLINE23   . . . . . . . . . . . . . . . . . . . .210 SYSCFG_ITLINE24   . . . . . . . . . . . . . . . . . . . .210 SYSCFG_ITLINE25   . . . . . . . . . . . . . . . . . . . .210 SYSCFG_ITLINE26   . . . . . . . . . . . . . . . . . . . .211 SYSCFG_ITLINE27   . . . . . . . . . . . . . . . . . . . .211 SYSCFG_ITLINE28   . . . . . . . . . . . . . . . . . . . .211 SYSCFG_ITLINE29   . . . . . . . . . . . . . . . . . . . .212 SYSCFG_ITLINE3   . . . . . . . . . . . . . . . . . . . . .203 SYSCFG_ITLINE30   . . . . . . . . . . . . . . . . . . . .212 SYSCFG_ITLINE31   . . . . . . . . . . . . . . . . . . . 213 SYSCFG_ITLINE4   . . . . . . . . . . . . . . . . . . . . 203 SYSCFG_ITLINE5   . . . . . . . . . . . . . . . . . . . . 204 SYSCFG_ITLINE6   . . . . . . . . . . . . . . . . . . . . 204 SYSCFG_ITLINE7   . . . . . . . . . . . . . . . . . . . . 204 SYSCFG_ITLINE8   . . . . . . . . . . . . . . . . . . . . 205 SYSCFG_ITLINE9   . . . . . . . . . . . . . . . . . . . . 205  T  TIM1_AF1   . . . . . . . . . . . . . . . . . . . . . . . . . . . 437 TIM1_AF2   . . . . . . . . . . . . . . . . . . . . . . . . . . . 438 TIM1_ARR   . . . . . . . . . . . . . . . . . . . . . . . . . . . 426 TIM1_BDTR   . . . . . . . . . . . . . . . . . . . . . . . . . 429 TIM1_CCER   . . . . . . . . . . . . . . . . . . . . . . . . . 423 TIM1_CCMR1   . . . . . . . . . . . . . . . . . . . . 416 -   417 TIM1_CCMR2   . . . . . . . . . . . . . . . . . . . . 420 -   421 TIM1_CCMR3   . . . . . . . . . . . . . . . . . . . . . . . . 435 TIM1_CCR1   . . . . . . . . . . . . . . . . . . . . . . . . . 427 TIM1_CCR2   . . . . . . . . . . . . . . . . . . . . . . . . . 428 TIM1_CCR3   . . . . . . . . . . . . . . . . . . . . . . . . . 428 TIM1_CCR4   . . . . . . . . . . . . . . . . . . . . . . . . . 429 TIM1_CCR5   . . . . . . . . . . . . . . . . . . . . . . . . . 436 TIM1_CCR6   . . . . . . . . . . . . . . . . . . . . . . . . . 437 TIM1_CNT   . . . . . . . . . . . . . . . . . . . . . . . . . . . 426 TIM1_CR1   . . . . . . . . . . . . . . . . . . . . . . . . . . . 405 TIM1_CR2   . . . . . . . . . . . . . . . . . . . . . . . . . . . 406 TIM1_DCR   . . . . . . . . . . . . . . . . . . . . . . . . . . 433 TIM1_DIER   . . . . . . . . . . . . . . . . . . . . . . . . . . 411 TIM1_DMAR   . . . . . . . . . . . . . . . . . . . . . . . . . 434 TIM1_EGR   . . . . . . . . . . . . . . . . . . . . . . . . . . 415 TIM1_PSC   . . . . . . . . . . . . . . . . . . . . . . . . . . . 426 TIM1_RCR   . . . . . . . . . . . . . . . . . . . . . . . . . . 427 TIM1_SMCR   . . . . . . . . . . . . . . . . . . . . . . . . . 409 TIM1_SR   . . . . . . . . . . . . . . . . . . . . . . . . . . . . 413 TIM1_TISEL   . . . . . . . . . . . . . . . . . . . . . . . . . 439 TIM14_ARR   . . . . . . . . . . . . . . . . . . . . . . . . . . 540 TIM14_CCER   . . . . . . . . . . . . . . . . . . . . . . . . 538 TIM14_CCMR1   . . . . . . . . . . . . . . . . . . . 535 -   536 TIM14_CCR1   . . . . . . . . . . . . . . . . . . . . . . . . 540 TIM14_CNT   . . . . . . . . . . . . . . . . . . . . . . . . . . 539 TIM14_CR1   . . . . . . . . . . . . . . . . . . . . . . . . . . 532 TIM14_DIER   . . . . . . . . . . . . . . . . . . . . . . . . . 533 TIM14_EGR   . . . . . . . . . . . . . . . . . . . . . . . . . 534 TIM14_PSC   . . . . . . . . . . . . . . . . . . . . . . . . . . 540 TIM14_SR   . . . . . . . . . . . . . . . . . . . . . . . . . . . 533 TIM14_TISEL   . . . . . . . . . . . . . . . . . . . . . . . . 541 TIM15_AF1   . . . . . . . . . . . . . . . . . . . . . . . . . . 604 TIM15_ARR   . . . . . . . . . . . . . . . . . . . . . . . . . . 598 TIM15_BDTR   . . . . . . . . . . . . . . . . . . . . . . . . 600 TIM15_CCER   . . . . . . . . . . . . . . . . . . . . . . . . 595 TIM15_CCMR1   . . . . . . . . . . . . . . . . . . . 591 -   592

Index  1026/1027   RM0490 Rev 5  TIM15_CCR1   . . . . . . . . . . . . . . . . . . . . . . . . .599 TIM15_CCR2   . . . . . . . . . . . . . . . . . . . . . . . . .600 TIM15_CNT   . . . . . . . . . . . . . . . . . . . . . . . . . .598 TIM15_CR1   . . . . . . . . . . . . . . . . . . . . . . . . . .583 TIM15_CR2   . . . . . . . . . . . . . . . . . . . . . . . . . .584 TIM15_DCR   . . . . . . . . . . . . . . . . . . . . . . . . . .603 TIM15_DIER   . . . . . . . . . . . . . . . . . . . . . . . . .587 TIM15_DMAR   . . . . . . . . . . . . . . . . . . . . . . . .603 TIM15_EGR   . . . . . . . . . . . . . . . . . . . . . . . . . .590 TIM15_PSC   . . . . . . . . . . . . . . . . . . . . . . . . . .598 TIM15_RCR   . . . . . . . . . . . . . . . . . . . . . . . . . .599 TIM15_SMCR   . . . . . . . . . . . . . . . . . . . . . . . .586 TIM15_SR   . . . . . . . . . . . . . . . . . . . . . . . . . . .588 TIM15_TISEL   . . . . . . . . . . . . . . . . . . . . . . . . .604 TIM16_AF1   . . . . . . . . . . . . . . . . . . . . . . . . . .625 TIM16_TISEL   . . . . . . . . . . . . . . . . . . . . . . . . .625 TIM17_AF1   . . . . . . . . . . . . . . . . . . . . . . . . . .626 TIM17_TISEL   . . . . . . . . . . . . . . . . . . . . . . . . .626 TIM2_AF1   . . . . . . . . . . . . . . . . . . . . . . . . . . .511 TIM2_TISEL   . . . . . . . . . . . . . . . . . . . . . . . . . .512 TIM3_AF1   . . . . . . . . . . . . . . . . . . . . . . . . . . .511 TIM3_TISEL   . . . . . . . . . . . . . . . . . . . . . . . . . .512 TIMx_ARR   . . . . . . . . . . . . . . . . . . . . . . .507 ,   619 TIMx_BDTR   . . . . . . . . . . . . . . . . . . . . . . . . . .621 TIMx_CCER   . . . . . . . . . . . . . . . . . . . . . .504 ,   616 TIMx_CCMR1   . . . . . . . . . . . . 498 ,   500   ,   613   -   614 TIMx_CCMR2   . . . . . . . . . . . . . . . . . . . . 502 -   503 TIMx_CCR1   . . . . . . . . . . . . . . . . . . . . . .507 ,   620 TIMx_CCR2   . . . . . . . . . . . . . . . . . . . . . . . . . .508 TIMx_CCR3   . . . . . . . . . . . . . . . . . . . . . . . . . .508 TIMx_CCR4   . . . . . . . . . . . . . . . . . . . . . . . . . .509 TIMx_CNT   . . . . . . . . . . . . . . . . . . . 505 -   506   ,   618 TIMx_CR1   . . . . . . . . . . . . . . . . . . . . . . .488 ,   608 TIMx_CR2   . . . . . . . . . . . . . . . . . . . . . . .489 ,   609 TIMx_DCR   . . . . . . . . . . . . . . . . . . . . . . .510 ,   624 TIMx_DIER   . . . . . . . . . . . . . . . . . . . . . . .494 ,   610 TIMx_DMAR   . . . . . . . . . . . . . . . . . . . . . .510 ,   624 TIMx_EGR   . . . . . . . . . . . . . . . . . . . . . . .497 ,   612 TIMx_PSC   . . . . . . . . . . . . . . . . . . . . . . .506 ,   619 TIMx_RCR   . . . . . . . . . . . . . . . . . . . . . . . . . . .620 TIMx_SMCR   . . . . . . . . . . . . . . . . . . . . . . . . . .491 TIMx_SR   . . . . . . . . . . . . . . . . . . . . . . . .496 ,   611  U  UID   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .1015 USART_BRR   . . . . . . . . . . . . . . . . . . . . . . . . .809 USART_CR1   . . . . . . . . . . . . . . . . . . . . .794 ,   797 USART_CR2   . . . . . . . . . . . . . . . . . . . . . . . . .801 USART_CR3   . . . . . . . . . . . . . . . . . . . . . . . . .805 USART_GTPR   . . . . . . . . . . . . . . . . . . . . . . . .809 USART_ICR   . . . . . . . . . . . . . . . . . . . . . . . . . .823 USART_ISR   . . . . . . . . . . . . . . . . . . . . . 812 ,   818 USART_PRESC   . . . . . . . . . . . . . . . . . . . . . . 826 USART_RDR   . . . . . . . . . . . . . . . . . . . . . . . . 825 USART_RQR   . . . . . . . . . . . . . . . . . . . . . . . . 811 USART_RTOR   . . . . . . . . . . . . . . . . . . . . . . . 810 USART_TDR   . . . . . . . . . . . . . . . . . . . . . . . . . 825 USB_BCDR   . . . . . . . . . . . . . . . . . . . . . . . . . . 984 USB_CHEP_RXTXBD_n   . . . . . . . . . . . 998   -   999 USB_CHEP_TXRXBD_n   . . . . . . . . . . . . . . . 996 USB_CHEPnR   . . . . . . . . . . . . . . . . . . . . . . . 985 USB_CNTR   . . . . . . . . . . . . . . . . . . . . . . . . . . 975 USB_DADDR   . . . . . . . . . . . . . . . . . . . . . . . . 982 USB_FNR   . . . . . . . . . . . . . . . . . . . . . . . . . . . 982 USB_ISTR   . . . . . . . . . . . . . . . . . . . . . . . . . . . 978 USB_LPMCSR   . . . . . . . . . . . . . . . . . . . . . . . 983  W  WWDG_CFR   . . . . . . . . . . . . . . . . . . . . . . . . . 644 WWDG_CR   . . . . . . . . . . . . . . . . . . . . . . . . . . 643 WWDG_SR   . . . . . . . . . . . . . . . . . . . . . . . . . . 645

RM0490 Rev 5   1027/1027  RM0490  1027  IMPORTANT NOTICE – READ CAREFULLY  STMicroelectronics NV and its subsidiaries (“ST”) reserve the right to make changes, corrections, enhancements, modifications, and improvements to ST products and/or to this document at any time without notice. Purchasers should obtain the latest relevant information on ST products before placing orders. ST products are sold pursuant to ST’s terms and conditions of sale in place at the time of order acknowledgment. Purchasers are solely responsible for the choice, selection, and use of ST products and ST assumes no liability for application assistance or the design of purchasers’ products. No license, express or implied, to any intellectual property right is granted by ST herein. Resale of ST products with provisions different from the information set forth herein shall void any warranty granted by ST for such product. ST and the ST logo are trademarks of ST. For additional information about ST trademarks, refer to   www.st.com/trademarks . All other product or service names are the property of their respective owners. Information in this document supersedes and replaces information previously supplied in any prior versions of this document. © 2024 STMicroelectronics – All rights reserved